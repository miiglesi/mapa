//! moment.js
//! version : 2.24.0 - 2.10.3
//! authors : Tim Wood, Iskren Chernev, Moment.js contributors
//! license : MIT
//! momentjs.com
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.moment=t()}(this,function(){"use strict";var e,i;function c(){return e.apply(null,arguments)}function o(e){return e instanceof Array||"[object Array]"===Object.prototype.toString.call(e)}function u(e){return null!=e&&"[object Object]"===Object.prototype.toString.call(e)}function l(e){return void 0===e}function h(e){return"number"==typeof e||"[object Number]"===Object.prototype.toString.call(e)}function d(e){return e instanceof Date||"[object Date]"===Object.prototype.toString.call(e)}function f(e,t){var n,s=[];for(n=0;n<e.length;++n)s.push(t(e[n],n));return s}function m(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function _(e,t){for(var n in t)m(t,n)&&(e[n]=t[n]);return m(t,"toString")&&(e.toString=t.toString),m(t,"valueOf")&&(e.valueOf=t.valueOf),e}function y(e,t,n,s){return Tt(e,t,n,s,!0).utc()}function g(e){return null==e._pf&&(e._pf={empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1,parsedDateParts:[],meridiem:null,rfc2822:!1,weekdayMismatch:!1}),e._pf}function v(e){if(null==e._isValid){var t=g(e),n=i.call(t.parsedDateParts,function(e){return null!=e}),s=!isNaN(e._d.getTime())&&t.overflow<0&&!t.empty&&!t.invalidMonth&&!t.invalidWeekday&&!t.weekdayMismatch&&!t.nullInput&&!t.invalidFormat&&!t.userInvalidated&&(!t.meridiem||t.meridiem&&n);if(e._strict&&(s=s&&0===t.charsLeftOver&&0===t.unusedTokens.length&&void 0===t.bigHour),null!=Object.isFrozen&&Object.isFrozen(e))return s;e._isValid=s}return e._isValid}function p(e){var t=y(NaN);return null!=e?_(g(t),e):g(t).userInvalidated=!0,t}i=Array.prototype.some?Array.prototype.some:function(e){for(var t=Object(this),n=t.length>>>0,s=0;s<n;s++)if(s in t&&e.call(this,t[s],s,t))return!0;return!1};var r=c.momentProperties=[];function w(e,t){var n,s,i;if(l(t._isAMomentObject)||(e._isAMomentObject=t._isAMomentObject),l(t._i)||(e._i=t._i),l(t._f)||(e._f=t._f),l(t._l)||(e._l=t._l),l(t._strict)||(e._strict=t._strict),l(t._tzm)||(e._tzm=t._tzm),l(t._isUTC)||(e._isUTC=t._isUTC),l(t._offset)||(e._offset=t._offset),l(t._pf)||(e._pf=g(t)),l(t._locale)||(e._locale=t._locale),0<r.length)for(n=0;n<r.length;n++)l(i=t[s=r[n]])||(e[s]=i);return e}var t=!1;function M(e){w(this,e),this._d=new Date(null!=e._d?e._d.getTime():NaN),this.isValid()||(this._d=new Date(NaN)),!1===t&&(t=!0,c.updateOffset(this),t=!1)}function k(e){return e instanceof M||null!=e&&null!=e._isAMomentObject}function S(e){return e<0?Math.ceil(e)||0:Math.floor(e)}function D(e){var t=+e,n=0;return 0!==t&&isFinite(t)&&(n=S(t)),n}function a(e,t,n){var s,i=Math.min(e.length,t.length),r=Math.abs(e.length-t.length),a=0;for(s=0;s<i;s++)(n&&e[s]!==t[s]||!n&&D(e[s])!==D(t[s]))&&a++;return a+r}function Y(e){!1===c.suppressDeprecationWarnings&&"undefined"!=typeof console&&console.warn&&console.warn("Deprecation warning: "+e)}function n(i,r){var a=!0;return _(function(){if(null!=c.deprecationHandler&&c.deprecationHandler(null,i),a){for(var e,t=[],n=0;n<arguments.length;n++){if(e="","object"==typeof arguments[n]){for(var s in e+="\n["+n+"] ",arguments[0])e+=s+": "+arguments[0][s]+", ";e=e.slice(0,-2)}else e=arguments[n];t.push(e)}Y(i+"\nArguments: "+Array.prototype.slice.call(t).join("")+"\n"+(new Error).stack),a=!1}return r.apply(this,arguments)},r)}var s,O={};function T(e,t){null!=c.deprecationHandler&&c.deprecationHandler(e,t),O[e]||(Y(t),O[e]=!0)}function b(e){return e instanceof Function||"[object Function]"===Object.prototype.toString.call(e)}function x(e,t){var n,s=_({},e);for(n in t)m(t,n)&&(u(e[n])&&u(t[n])?(s[n]={},_(s[n],e[n]),_(s[n],t[n])):null!=t[n]?s[n]=t[n]:delete s[n]);for(n in e)m(e,n)&&!m(t,n)&&u(e[n])&&(s[n]=_({},s[n]));return s}function P(e){null!=e&&this.set(e)}c.suppressDeprecationWarnings=!1,c.deprecationHandler=null,s=Object.keys?Object.keys:function(e){var t,n=[];for(t in e)m(e,t)&&n.push(t);return n};var W={};function C(e,t){var n=e.toLowerCase();W[n]=W[n+"s"]=W[t]=e}function H(e){return"string"==typeof e?W[e]||W[e.toLowerCase()]:void 0}function R(e){var t,n,s={};for(n in e)m(e,n)&&(t=H(n))&&(s[t]=e[n]);return s}var U={};function F(e,t){U[e]=t}function L(e,t,n){var s=""+Math.abs(e),i=t-s.length;return(0<=e?n?"+":"":"-")+Math.pow(10,Math.max(0,i)).toString().substr(1)+s}var N=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g,G=/(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g,V={},E={};function I(e,t,n,s){var i=s;"string"==typeof s&&(i=function(){return this[s]()}),e&&(E[e]=i),t&&(E[t[0]]=function(){return L(i.apply(this,arguments),t[1],t[2])}),n&&(E[n]=function(){return this.localeData().ordinal(i.apply(this,arguments),e)})}function A(e,t){return e.isValid()?(t=j(t,e.localeData()),V[t]=V[t]||function(s){var e,i,t,r=s.match(N);for(e=0,i=r.length;e<i;e++)E[r[e]]?r[e]=E[r[e]]:r[e]=(t=r[e]).match(/\[[\s\S]/)?t.replace(/^\[|\]$/g,""):t.replace(/\\/g,"");return function(e){var t,n="";for(t=0;t<i;t++)n+=b(r[t])?r[t].call(e,s):r[t];return n}}(t),V[t](e)):e.localeData().invalidDate()}function j(e,t){var n=5;function s(e){return t.longDateFormat(e)||e}for(G.lastIndex=0;0<=n&&G.test(e);)e=e.replace(G,s),G.lastIndex=0,n-=1;return e}var Z=/\d/,z=/\d\d/,$=/\d{3}/,q=/\d{4}/,J=/[+-]?\d{6}/,B=/\d\d?/,Q=/\d\d\d\d?/,X=/\d\d\d\d\d\d?/,K=/\d{1,3}/,ee=/\d{1,4}/,te=/[+-]?\d{1,6}/,ne=/\d+/,se=/[+-]?\d+/,ie=/Z|[+-]\d\d:?\d\d/gi,re=/Z|[+-]\d\d(?::?\d\d)?/gi,ae=/[0-9]{0,256}['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFF07\uFF10-\uFFEF]{1,256}|[\u0600-\u06FF\/]{1,256}(\s*?[\u0600-\u06FF]{1,256}){1,2}/i,oe={};function ue(e,n,s){oe[e]=b(n)?n:function(e,t){return e&&s?s:n}}function le(e,t){return m(oe,e)?oe[e](t._strict,t._locale):new RegExp(he(e.replace("\\","").replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(e,t,n,s,i){return t||n||s||i})))}function he(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}var de={};function ce(e,n){var t,s=n;for("string"==typeof e&&(e=[e]),h(n)&&(s=function(e,t){t[n]=D(e)}),t=0;t<e.length;t++)de[e[t]]=s}function fe(e,i){ce(e,function(e,t,n,s){n._w=n._w||{},i(e,n._w,n,s)})}var me=0,_e=1,ye=2,ge=3,ve=4,pe=5,we=6,Me=7,ke=8;function Se(e){return De(e)?366:365}function De(e){return e%4==0&&e%100!=0||e%400==0}I("Y",0,0,function(){var e=this.year();return e<=9999?""+e:"+"+e}),I(0,["YY",2],0,function(){return this.year()%100}),I(0,["YYYY",4],0,"year"),I(0,["YYYYY",5],0,"year"),I(0,["YYYYYY",6,!0],0,"year"),C("year","y"),F("year",1),ue("Y",se),ue("YY",B,z),ue("YYYY",ee,q),ue("YYYYY",te,J),ue("YYYYYY",te,J),ce(["YYYYY","YYYYYY"],me),ce("YYYY",function(e,t){t[me]=2===e.length?c.parseTwoDigitYear(e):D(e)}),ce("YY",function(e,t){t[me]=c.parseTwoDigitYear(e)}),ce("Y",function(e,t){t[me]=parseInt(e,10)}),c.parseTwoDigitYear=function(e){return D(e)+(68<D(e)?1900:2e3)};var Ye,Oe=Te("FullYear",!0);function Te(t,n){return function(e){return null!=e?(xe(this,t,e),c.updateOffset(this,n),this):be(this,t)}}function be(e,t){return e.isValid()?e._d["get"+(e._isUTC?"UTC":"")+t]():NaN}function xe(e,t,n){e.isValid()&&!isNaN(n)&&("FullYear"===t&&De(e.year())&&1===e.month()&&29===e.date()?e._d["set"+(e._isUTC?"UTC":"")+t](n,e.month(),Pe(n,e.month())):e._d["set"+(e._isUTC?"UTC":"")+t](n))}function Pe(e,t){if(isNaN(e)||isNaN(t))return NaN;var n,s=(t%(n=12)+n)%n;return e+=(t-s)/12,1===s?De(e)?29:28:31-s%7%2}Ye=Array.prototype.indexOf?Array.prototype.indexOf:function(e){var t;for(t=0;t<this.length;++t)if(this[t]===e)return t;return-1},I("M",["MM",2],"Mo",function(){return this.month()+1}),I("MMM",0,0,function(e){return this.localeData().monthsShort(this,e)}),I("MMMM",0,0,function(e){return this.localeData().months(this,e)}),C("month","M"),F("month",8),ue("M",B),ue("MM",B,z),ue("MMM",function(e,t){return t.monthsShortRegex(e)}),ue("MMMM",function(e,t){return t.monthsRegex(e)}),ce(["M","MM"],function(e,t){t[_e]=D(e)-1}),ce(["MMM","MMMM"],function(e,t,n,s){var i=n._locale.monthsParse(e,s,n._strict);null!=i?t[_e]=i:g(n).invalidMonth=e});var We=/D[oD]?(\[[^\[\]]*\]|\s)+MMMM?/,Ce="January_February_March_April_May_June_July_August_September_October_November_December".split("_");var He="Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_");function Re(e,t){var n;if(!e.isValid())return e;if("string"==typeof t)if(/^\d+$/.test(t))t=D(t);else if(!h(t=e.localeData().monthsParse(t)))return e;return n=Math.min(e.date(),Pe(e.year(),t)),e._d["set"+(e._isUTC?"UTC":"")+"Month"](t,n),e}function Ue(e){return null!=e?(Re(this,e),c.updateOffset(this,!0),this):be(this,"Month")}var Fe=ae;var Le=ae;function Ne(){function e(e,t){return t.length-e.length}var t,n,s=[],i=[],r=[];for(t=0;t<12;t++)n=y([2e3,t]),s.push(this.monthsShort(n,"")),i.push(this.months(n,"")),r.push(this.months(n,"")),r.push(this.monthsShort(n,""));for(s.sort(e),i.sort(e),r.sort(e),t=0;t<12;t++)s[t]=he(s[t]),i[t]=he(i[t]);for(t=0;t<24;t++)r[t]=he(r[t]);this._monthsRegex=new RegExp("^("+r.join("|")+")","i"),this._monthsShortRegex=this._monthsRegex,this._monthsStrictRegex=new RegExp("^("+i.join("|")+")","i"),this._monthsShortStrictRegex=new RegExp("^("+s.join("|")+")","i")}function Ge(e){var t;if(e<100&&0<=e){var n=Array.prototype.slice.call(arguments);n[0]=e+400,t=new Date(Date.UTC.apply(null,n)),isFinite(t.getUTCFullYear())&&t.setUTCFullYear(e)}else t=new Date(Date.UTC.apply(null,arguments));return t}function Ve(e,t,n){var s=7+t-n;return-((7+Ge(e,0,s).getUTCDay()-t)%7)+s-1}function Ee(e,t,n,s,i){var r,a,o=1+7*(t-1)+(7+n-s)%7+Ve(e,s,i);return a=o<=0?Se(r=e-1)+o:o>Se(e)?(r=e+1,o-Se(e)):(r=e,o),{year:r,dayOfYear:a}}function Ie(e,t,n){var s,i,r=Ve(e.year(),t,n),a=Math.floor((e.dayOfYear()-r-1)/7)+1;return a<1?s=a+Ae(i=e.year()-1,t,n):a>Ae(e.year(),t,n)?(s=a-Ae(e.year(),t,n),i=e.year()+1):(i=e.year(),s=a),{week:s,year:i}}function Ae(e,t,n){var s=Ve(e,t,n),i=Ve(e+1,t,n);return(Se(e)-s+i)/7}I("w",["ww",2],"wo","week"),I("W",["WW",2],"Wo","isoWeek"),C("week","w"),C("isoWeek","W"),F("week",5),F("isoWeek",5),ue("w",B),ue("ww",B,z),ue("W",B),ue("WW",B,z),fe(["w","ww","W","WW"],function(e,t,n,s){t[s.substr(0,1)]=D(e)});function je(e,t){return e.slice(t,7).concat(e.slice(0,t))}I("d",0,"do","day"),I("dd",0,0,function(e){return this.localeData().weekdaysMin(this,e)}),I("ddd",0,0,function(e){return this.localeData().weekdaysShort(this,e)}),I("dddd",0,0,function(e){return this.localeData().weekdays(this,e)}),I("e",0,0,"weekday"),I("E",0,0,"isoWeekday"),C("day","d"),C("weekday","e"),C("isoWeekday","E"),F("day",11),F("weekday",11),F("isoWeekday",11),ue("d",B),ue("e",B),ue("E",B),ue("dd",function(e,t){return t.weekdaysMinRegex(e)}),ue("ddd",function(e,t){return t.weekdaysShortRegex(e)}),ue("dddd",function(e,t){return t.weekdaysRegex(e)}),fe(["dd","ddd","dddd"],function(e,t,n,s){var i=n._locale.weekdaysParse(e,s,n._strict);null!=i?t.d=i:g(n).invalidWeekday=e}),fe(["d","e","E"],function(e,t,n,s){t[s]=D(e)});var Ze="Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_");var ze="Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_");var $e="Su_Mo_Tu_We_Th_Fr_Sa".split("_");var qe=ae;var Je=ae;var Be=ae;function Qe(){function e(e,t){return t.length-e.length}var t,n,s,i,r,a=[],o=[],u=[],l=[];for(t=0;t<7;t++)n=y([2e3,1]).day(t),s=this.weekdaysMin(n,""),i=this.weekdaysShort(n,""),r=this.weekdays(n,""),a.push(s),o.push(i),u.push(r),l.push(s),l.push(i),l.push(r);for(a.sort(e),o.sort(e),u.sort(e),l.sort(e),t=0;t<7;t++)o[t]=he(o[t]),u[t]=he(u[t]),l[t]=he(l[t]);this._weekdaysRegex=new RegExp("^("+l.join("|")+")","i"),this._weekdaysShortRegex=this._weekdaysRegex,this._weekdaysMinRegex=this._weekdaysRegex,this._weekdaysStrictRegex=new RegExp("^("+u.join("|")+")","i"),this._weekdaysShortStrictRegex=new RegExp("^("+o.join("|")+")","i"),this._weekdaysMinStrictRegex=new RegExp("^("+a.join("|")+")","i")}function Xe(){return this.hours()%12||12}function Ke(e,t){I(e,0,0,function(){return this.localeData().meridiem(this.hours(),this.minutes(),t)})}function et(e,t){return t._meridiemParse}I("H",["HH",2],0,"hour"),I("h",["hh",2],0,Xe),I("k",["kk",2],0,function(){return this.hours()||24}),I("hmm",0,0,function(){return""+Xe.apply(this)+L(this.minutes(),2)}),I("hmmss",0,0,function(){return""+Xe.apply(this)+L(this.minutes(),2)+L(this.seconds(),2)}),I("Hmm",0,0,function(){return""+this.hours()+L(this.minutes(),2)}),I("Hmmss",0,0,function(){return""+this.hours()+L(this.minutes(),2)+L(this.seconds(),2)}),Ke("a",!0),Ke("A",!1),C("hour","h"),F("hour",13),ue("a",et),ue("A",et),ue("H",B),ue("h",B),ue("k",B),ue("HH",B,z),ue("hh",B,z),ue("kk",B,z),ue("hmm",Q),ue("hmmss",X),ue("Hmm",Q),ue("Hmmss",X),ce(["H","HH"],ge),ce(["k","kk"],function(e,t,n){var s=D(e);t[ge]=24===s?0:s}),ce(["a","A"],function(e,t,n){n._isPm=n._locale.isPM(e),n._meridiem=e}),ce(["h","hh"],function(e,t,n){t[ge]=D(e),g(n).bigHour=!0}),ce("hmm",function(e,t,n){var s=e.length-2;t[ge]=D(e.substr(0,s)),t[ve]=D(e.substr(s)),g(n).bigHour=!0}),ce("hmmss",function(e,t,n){var s=e.length-4,i=e.length-2;t[ge]=D(e.substr(0,s)),t[ve]=D(e.substr(s,2)),t[pe]=D(e.substr(i)),g(n).bigHour=!0}),ce("Hmm",function(e,t,n){var s=e.length-2;t[ge]=D(e.substr(0,s)),t[ve]=D(e.substr(s))}),ce("Hmmss",function(e,t,n){var s=e.length-4,i=e.length-2;t[ge]=D(e.substr(0,s)),t[ve]=D(e.substr(s,2)),t[pe]=D(e.substr(i))});var tt,nt=Te("Hours",!0),st={calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},longDateFormat:{LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},invalidDate:"Invalid date",ordinal:"%d",dayOfMonthOrdinalParse:/\d{1,2}/,relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",ss:"%d seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},months:Ce,monthsShort:He,week:{dow:0,doy:6},weekdays:Ze,weekdaysMin:$e,weekdaysShort:ze,meridiemParse:/[ap]\.?m?\.?/i},it={},rt={};function at(e){return e?e.toLowerCase().replace("_","-"):e}function ot(e){var t=null;if(!it[e]&&"undefined"!=typeof module&&module&&module.exports)try{t=tt._abbr,require("./locale/"+e),ut(t)}catch(e){}return it[e]}function ut(e,t){var n;return e&&((n=l(t)?ht(e):lt(e,t))?tt=n:"undefined"!=typeof console&&console.warn&&console.warn("Locale "+e+" not found. Did you forget to load it?")),tt._abbr}function lt(e,t){if(null===t)return delete it[e],null;var n,s=st;if(t.abbr=e,null!=it[e])T("defineLocaleOverride","use moment.updateLocale(localeName, config) to change an existing locale. moment.defineLocale(localeName, config) should only be used for creating a new locale See http://momentjs.com/guides/#/warnings/define-locale/ for more info."),s=it[e]._config;else if(null!=t.parentLocale)if(null!=it[t.parentLocale])s=it[t.parentLocale]._config;else{if(null==(n=ot(t.parentLocale)))return rt[t.parentLocale]||(rt[t.parentLocale]=[]),rt[t.parentLocale].push({name:e,config:t}),null;s=n._config}return it[e]=new P(x(s,t)),rt[e]&&rt[e].forEach(function(e){lt(e.name,e.config)}),ut(e),it[e]}function ht(e){var t;if(e&&e._locale&&e._locale._abbr&&(e=e._locale._abbr),!e)return tt;if(!o(e)){if(t=ot(e))return t;e=[e]}return function(e){for(var t,n,s,i,r=0;r<e.length;){for(t=(i=at(e[r]).split("-")).length,n=(n=at(e[r+1]))?n.split("-"):null;0<t;){if(s=ot(i.slice(0,t).join("-")))return s;if(n&&n.length>=t&&a(i,n,!0)>=t-1)break;t--}r++}return tt}(e)}function dt(e){var t,n=e._a;return n&&-2===g(e).overflow&&(t=n[_e]<0||11<n[_e]?_e:n[ye]<1||n[ye]>Pe(n[me],n[_e])?ye:n[ge]<0||24<n[ge]||24===n[ge]&&(0!==n[ve]||0!==n[pe]||0!==n[we])?ge:n[ve]<0||59<n[ve]?ve:n[pe]<0||59<n[pe]?pe:n[we]<0||999<n[we]?we:-1,g(e)._overflowDayOfYear&&(t<me||ye<t)&&(t=ye),g(e)._overflowWeeks&&-1===t&&(t=Me),g(e)._overflowWeekday&&-1===t&&(t=ke),g(e).overflow=t),e}function ct(e,t,n){return null!=e?e:null!=t?t:n}function ft(e){var t,n,s,i,r,a=[];if(!e._d){var o,u;for(o=e,u=new Date(c.now()),s=o._useUTC?[u.getUTCFullYear(),u.getUTCMonth(),u.getUTCDate()]:[u.getFullYear(),u.getMonth(),u.getDate()],e._w&&null==e._a[ye]&&null==e._a[_e]&&function(e){var t,n,s,i,r,a,o,u;if(null!=(t=e._w).GG||null!=t.W||null!=t.E)r=1,a=4,n=ct(t.GG,e._a[me],Ie(bt(),1,4).year),s=ct(t.W,1),((i=ct(t.E,1))<1||7<i)&&(u=!0);else{r=e._locale._week.dow,a=e._locale._week.doy;var l=Ie(bt(),r,a);n=ct(t.gg,e._a[me],l.year),s=ct(t.w,l.week),null!=t.d?((i=t.d)<0||6<i)&&(u=!0):null!=t.e?(i=t.e+r,(t.e<0||6<t.e)&&(u=!0)):i=r}s<1||s>Ae(n,r,a)?g(e)._overflowWeeks=!0:null!=u?g(e)._overflowWeekday=!0:(o=Ee(n,s,i,r,a),e._a[me]=o.year,e._dayOfYear=o.dayOfYear)}(e),null!=e._dayOfYear&&(r=ct(e._a[me],s[me]),(e._dayOfYear>Se(r)||0===e._dayOfYear)&&(g(e)._overflowDayOfYear=!0),n=Ge(r,0,e._dayOfYear),e._a[_e]=n.getUTCMonth(),e._a[ye]=n.getUTCDate()),t=0;t<3&&null==e._a[t];++t)e._a[t]=a[t]=s[t];for(;t<7;t++)e._a[t]=a[t]=null==e._a[t]?2===t?1:0:e._a[t];24===e._a[ge]&&0===e._a[ve]&&0===e._a[pe]&&0===e._a[we]&&(e._nextDay=!0,e._a[ge]=0),e._d=(e._useUTC?Ge:function(e,t,n,s,i,r,a){var o;return e<100&&0<=e?(o=new Date(e+400,t,n,s,i,r,a),isFinite(o.getFullYear())&&o.setFullYear(e)):o=new Date(e,t,n,s,i,r,a),o}).apply(null,a),i=e._useUTC?e._d.getUTCDay():e._d.getDay(),null!=e._tzm&&e._d.setUTCMinutes(e._d.getUTCMinutes()-e._tzm),e._nextDay&&(e._a[ge]=24),e._w&&void 0!==e._w.d&&e._w.d!==i&&(g(e).weekdayMismatch=!0)}}var mt=/^\s*((?:[+-]\d{6}|\d{4})-(?:\d\d-\d\d|W\d\d-\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?::\d\d(?::\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,_t=/^\s*((?:[+-]\d{6}|\d{4})(?:\d\d\d\d|W\d\d\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?:\d\d(?:\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,yt=/Z|[+-]\d\d(?::?\d\d)?/,gt=[["YYYYYY-MM-DD",/[+-]\d{6}-\d\d-\d\d/],["YYYY-MM-DD",/\d{4}-\d\d-\d\d/],["GGGG-[W]WW-E",/\d{4}-W\d\d-\d/],["GGGG-[W]WW",/\d{4}-W\d\d/,!1],["YYYY-DDD",/\d{4}-\d{3}/],["YYYY-MM",/\d{4}-\d\d/,!1],["YYYYYYMMDD",/[+-]\d{10}/],["YYYYMMDD",/\d{8}/],["GGGG[W]WWE",/\d{4}W\d{3}/],["GGGG[W]WW",/\d{4}W\d{2}/,!1],["YYYYDDD",/\d{7}/]],vt=[["HH:mm:ss.SSSS",/\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss,SSSS",/\d\d:\d\d:\d\d,\d+/],["HH:mm:ss",/\d\d:\d\d:\d\d/],["HH:mm",/\d\d:\d\d/],["HHmmss.SSSS",/\d\d\d\d\d\d\.\d+/],["HHmmss,SSSS",/\d\d\d\d\d\d,\d+/],["HHmmss",/\d\d\d\d\d\d/],["HHmm",/\d\d\d\d/],["HH",/\d\d/]],pt=/^\/?Date\((\-?\d+)/i;function wt(e){var t,n,s,i,r,a,o=e._i,u=mt.exec(o)||_t.exec(o);if(u){for(g(e).iso=!0,t=0,n=gt.length;t<n;t++)if(gt[t][1].exec(u[1])){i=gt[t][0],s=!1!==gt[t][2];break}if(null==i)return void(e._isValid=!1);if(u[3]){for(t=0,n=vt.length;t<n;t++)if(vt[t][1].exec(u[3])){r=(u[2]||" ")+vt[t][0];break}if(null==r)return void(e._isValid=!1)}if(!s&&null!=r)return void(e._isValid=!1);if(u[4]){if(!yt.exec(u[4]))return void(e._isValid=!1);a="Z"}e._f=i+(r||"")+(a||""),Yt(e)}else e._isValid=!1}var Mt=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),?\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|([+-]\d{4}))$/;function kt(e,t,n,s,i,r){var a=[function(e){var t=parseInt(e,10);{if(t<=49)return 2e3+t;if(t<=999)return 1900+t}return t}(e),He.indexOf(t),parseInt(n,10),parseInt(s,10),parseInt(i,10)];return r&&a.push(parseInt(r,10)),a}var St={UT:0,GMT:0,EDT:-240,EST:-300,CDT:-300,CST:-360,MDT:-360,MST:-420,PDT:-420,PST:-480};function Dt(e){var t,n,s,i=Mt.exec(e._i.replace(/\([^)]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").replace(/^\s\s*/,"").replace(/\s\s*$/,""));if(i){var r=kt(i[4],i[3],i[2],i[5],i[6],i[7]);if(t=i[1],n=r,s=e,t&&ze.indexOf(t)!==new Date(n[0],n[1],n[2]).getDay()&&(g(s).weekdayMismatch=!0,!(s._isValid=!1)))return;e._a=r,e._tzm=function(e,t,n){if(e)return St[e];if(t)return 0;var s=parseInt(n,10),i=s%100;return(s-i)/100*60+i}(i[8],i[9],i[10]),e._d=Ge.apply(null,e._a),e._d.setUTCMinutes(e._d.getUTCMinutes()-e._tzm),g(e).rfc2822=!0}else e._isValid=!1}function Yt(e){if(e._f!==c.ISO_8601)if(e._f!==c.RFC_2822){e._a=[],g(e).empty=!0;var t,n,s,i,r,a,o,u,l=""+e._i,h=l.length,d=0;for(s=j(e._f,e._locale).match(N)||[],t=0;t<s.length;t++)i=s[t],(n=(l.match(le(i,e))||[])[0])&&(0<(r=l.substr(0,l.indexOf(n))).length&&g(e).unusedInput.push(r),l=l.slice(l.indexOf(n)+n.length),d+=n.length),E[i]?(n?g(e).empty=!1:g(e).unusedTokens.push(i),a=i,u=e,null!=(o=n)&&m(de,a)&&de[a](o,u._a,u,a)):e._strict&&!n&&g(e).unusedTokens.push(i);g(e).charsLeftOver=h-d,0<l.length&&g(e).unusedInput.push(l),e._a[ge]<=12&&!0===g(e).bigHour&&0<e._a[ge]&&(g(e).bigHour=void 0),g(e).parsedDateParts=e._a.slice(0),g(e).meridiem=e._meridiem,e._a[ge]=function(e,t,n){var s;if(null==n)return t;return null!=e.meridiemHour?e.meridiemHour(t,n):(null!=e.isPM&&((s=e.isPM(n))&&t<12&&(t+=12),s||12!==t||(t=0)),t)}(e._locale,e._a[ge],e._meridiem),ft(e),dt(e)}else Dt(e);else wt(e)}function Ot(e){var t,n,s,i,r=e._i,a=e._f;return e._locale=e._locale||ht(e._l),null===r||void 0===a&&""===r?p({nullInput:!0}):("string"==typeof r&&(e._i=r=e._locale.preparse(r)),k(r)?new M(dt(r)):(d(r)?e._d=r:o(a)?function(e){var t,n,s,i,r;if(0===e._f.length)return g(e).invalidFormat=!0,e._d=new Date(NaN);for(i=0;i<e._f.length;i++)r=0,t=w({},e),null!=e._useUTC&&(t._useUTC=e._useUTC),t._f=e._f[i],Yt(t),v(t)&&(r+=g(t).charsLeftOver,r+=10*g(t).unusedTokens.length,g(t).score=r,(null==s||r<s)&&(s=r,n=t));_(e,n||t)}(e):a?Yt(e):l(n=(t=e)._i)?t._d=new Date(c.now()):d(n)?t._d=new Date(n.valueOf()):"string"==typeof n?(s=t,null===(i=pt.exec(s._i))?(wt(s),!1===s._isValid&&(delete s._isValid,Dt(s),!1===s._isValid&&(delete s._isValid,c.createFromInputFallback(s)))):s._d=new Date(+i[1])):o(n)?(t._a=f(n.slice(0),function(e){return parseInt(e,10)}),ft(t)):u(n)?function(e){if(!e._d){var t=R(e._i);e._a=f([t.year,t.month,t.day||t.date,t.hour,t.minute,t.second,t.millisecond],function(e){return e&&parseInt(e,10)}),ft(e)}}(t):h(n)?t._d=new Date(n):c.createFromInputFallback(t),v(e)||(e._d=null),e))}function Tt(e,t,n,s,i){var r,a={};return!0!==n&&!1!==n||(s=n,n=void 0),(u(e)&&function(e){if(Object.getOwnPropertyNames)return 0===Object.getOwnPropertyNames(e).length;var t;for(t in e)if(e.hasOwnProperty(t))return!1;return!0}(e)||o(e)&&0===e.length)&&(e=void 0),a._isAMomentObject=!0,a._useUTC=a._isUTC=i,a._l=n,a._i=e,a._f=t,a._strict=s,(r=new M(dt(Ot(a))))._nextDay&&(r.add(1,"d"),r._nextDay=void 0),r}function bt(e,t,n,s){return Tt(e,t,n,s,!1)}c.createFromInputFallback=n("value provided is not in a recognized RFC2822 or ISO format. moment construction falls back to js Date(), which is not reliable across all browsers and versions. Non RFC2822/ISO date formats are discouraged and will be removed in an upcoming major release. Please refer to http://momentjs.com/guides/#/warnings/js-date/ for more info.",function(e){e._d=new Date(e._i+(e._useUTC?" UTC":""))}),c.ISO_8601=function(){},c.RFC_2822=function(){};var xt=n("moment().min is deprecated, use moment.max instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var e=bt.apply(null,arguments);return this.isValid()&&e.isValid()?e<this?this:e:p()}),Pt=n("moment().max is deprecated, use moment.min instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var e=bt.apply(null,arguments);return this.isValid()&&e.isValid()?this<e?this:e:p()});function Wt(e,t){var n,s;if(1===t.length&&o(t[0])&&(t=t[0]),!t.length)return bt();for(n=t[0],s=1;s<t.length;++s)t[s].isValid()&&!t[s][e](n)||(n=t[s]);return n}var Ct=["year","quarter","month","week","day","hour","minute","second","millisecond"];function Ht(e){var t=R(e),n=t.year||0,s=t.quarter||0,i=t.month||0,r=t.week||t.isoWeek||0,a=t.day||0,o=t.hour||0,u=t.minute||0,l=t.second||0,h=t.millisecond||0;this._isValid=function(e){for(var t in e)if(-1===Ye.call(Ct,t)||null!=e[t]&&isNaN(e[t]))return!1;for(var n=!1,s=0;s<Ct.length;++s)if(e[Ct[s]]){if(n)return!1;parseFloat(e[Ct[s]])!==D(e[Ct[s]])&&(n=!0)}return!0}(t),this._milliseconds=+h+1e3*l+6e4*u+1e3*o*60*60,this._days=+a+7*r,this._months=+i+3*s+12*n,this._data={},this._locale=ht(),this._bubble()}function Rt(e){return e instanceof Ht}function Ut(e){return e<0?-1*Math.round(-1*e):Math.round(e)}function Ft(e,n){I(e,0,0,function(){var e=this.utcOffset(),t="+";return e<0&&(e=-e,t="-"),t+L(~~(e/60),2)+n+L(~~e%60,2)})}Ft("Z",":"),Ft("ZZ",""),ue("Z",re),ue("ZZ",re),ce(["Z","ZZ"],function(e,t,n){n._useUTC=!0,n._tzm=Nt(re,e)});var Lt=/([\+\-]|\d\d)/gi;function Nt(e,t){var n=(t||"").match(e);if(null===n)return null;var s=((n[n.length-1]||[])+"").match(Lt)||["-",0,0],i=60*s[1]+D(s[2]);return 0===i?0:"+"===s[0]?i:-i}function Gt(e,t){var n,s;return t._isUTC?(n=t.clone(),s=(k(e)||d(e)?e.valueOf():bt(e).valueOf())-n.valueOf(),n._d.setTime(n._d.valueOf()+s),c.updateOffset(n,!1),n):bt(e).local()}function Vt(e){return 15*-Math.round(e._d.getTimezoneOffset()/15)}function Et(){return!!this.isValid()&&(this._isUTC&&0===this._offset)}c.updateOffset=function(){};var It=/^(\-|\+)?(?:(\d*)[. ])?(\d+)\:(\d+)(?:\:(\d+)(\.\d*)?)?$/,At=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/;function jt(e,t){var n,s,i,r=e,a=null;return Rt(e)?r={ms:e._milliseconds,d:e._days,M:e._months}:h(e)?(r={},t?r[t]=e:r.milliseconds=e):(a=It.exec(e))?(n="-"===a[1]?-1:1,r={y:0,d:D(a[ye])*n,h:D(a[ge])*n,m:D(a[ve])*n,s:D(a[pe])*n,ms:D(Ut(1e3*a[we]))*n}):(a=At.exec(e))?(n="-"===a[1]?-1:1,r={y:Zt(a[2],n),M:Zt(a[3],n),w:Zt(a[4],n),d:Zt(a[5],n),h:Zt(a[6],n),m:Zt(a[7],n),s:Zt(a[8],n)}):null==r?r={}:"object"==typeof r&&("from"in r||"to"in r)&&(i=function(e,t){var n;if(!e.isValid()||!t.isValid())return{milliseconds:0,months:0};t=Gt(t,e),e.isBefore(t)?n=zt(e,t):((n=zt(t,e)).milliseconds=-n.milliseconds,n.months=-n.months);return n}(bt(r.from),bt(r.to)),(r={}).ms=i.milliseconds,r.M=i.months),s=new Ht(r),Rt(e)&&m(e,"_locale")&&(s._locale=e._locale),s}function Zt(e,t){var n=e&&parseFloat(e.replace(",","."));return(isNaN(n)?0:n)*t}function zt(e,t){var n={};return n.months=t.month()-e.month()+12*(t.year()-e.year()),e.clone().add(n.months,"M").isAfter(t)&&--n.months,n.milliseconds=+t-+e.clone().add(n.months,"M"),n}function $t(s,i){return function(e,t){var n;return null===t||isNaN(+t)||(T(i,"moment()."+i+"(period, number) is deprecated. Please use moment()."+i+"(number, period). See http://momentjs.com/guides/#/warnings/add-inverted-param/ for more info."),n=e,e=t,t=n),qt(this,jt(e="string"==typeof e?+e:e,t),s),this}}function qt(e,t,n,s){var i=t._milliseconds,r=Ut(t._days),a=Ut(t._months);e.isValid()&&(s=null==s||s,a&&Re(e,be(e,"Month")+a*n),r&&xe(e,"Date",be(e,"Date")+r*n),i&&e._d.setTime(e._d.valueOf()+i*n),s&&c.updateOffset(e,r||a))}jt.fn=Ht.prototype,jt.invalid=function(){return jt(NaN)};var Jt=$t(1,"add"),Bt=$t(-1,"subtract");function Qt(e,t){var n=12*(t.year()-e.year())+(t.month()-e.month()),s=e.clone().add(n,"months");return-(n+(t-s<0?(t-s)/(s-e.clone().add(n-1,"months")):(t-s)/(e.clone().add(n+1,"months")-s)))||0}function Xt(e){var t;return void 0===e?this._locale._abbr:(null!=(t=ht(e))&&(this._locale=t),this)}c.defaultFormat="YYYY-MM-DDTHH:mm:ssZ",c.defaultFormatUtc="YYYY-MM-DDTHH:mm:ss[Z]";var Kt=n("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.",function(e){return void 0===e?this.localeData():this.locale(e)});function en(){return this._locale}var tn=126227808e5;function nn(e,t){return(e%t+t)%t}function sn(e,t,n){return e<100&&0<=e?new Date(e+400,t,n)-tn:new Date(e,t,n).valueOf()}function rn(e,t,n){return e<100&&0<=e?Date.UTC(e+400,t,n)-tn:Date.UTC(e,t,n)}function an(e,t){I(0,[e,e.length],0,t)}function on(e,t,n,s,i){var r;return null==e?Ie(this,s,i).year:((r=Ae(e,s,i))<t&&(t=r),function(e,t,n,s,i){var r=Ee(e,t,n,s,i),a=Ge(r.year,0,r.dayOfYear);return this.year(a.getUTCFullYear()),this.month(a.getUTCMonth()),this.date(a.getUTCDate()),this}.call(this,e,t,n,s,i))}I(0,["gg",2],0,function(){return this.weekYear()%100}),I(0,["GG",2],0,function(){return this.isoWeekYear()%100}),an("gggg","weekYear"),an("ggggg","weekYear"),an("GGGG","isoWeekYear"),an("GGGGG","isoWeekYear"),C("weekYear","gg"),C("isoWeekYear","GG"),F("weekYear",1),F("isoWeekYear",1),ue("G",se),ue("g",se),ue("GG",B,z),ue("gg",B,z),ue("GGGG",ee,q),ue("gggg",ee,q),ue("GGGGG",te,J),ue("ggggg",te,J),fe(["gggg","ggggg","GGGG","GGGGG"],function(e,t,n,s){t[s.substr(0,2)]=D(e)}),fe(["gg","GG"],function(e,t,n,s){t[s]=c.parseTwoDigitYear(e)}),I("Q",0,"Qo","quarter"),C("quarter","Q"),F("quarter",7),ue("Q",Z),ce("Q",function(e,t){t[_e]=3*(D(e)-1)}),I("D",["DD",2],"Do","date"),C("date","D"),F("date",9),ue("D",B),ue("DD",B,z),ue("Do",function(e,t){return e?t._dayOfMonthOrdinalParse||t._ordinalParse:t._dayOfMonthOrdinalParseLenient}),ce(["D","DD"],ye),ce("Do",function(e,t){t[ye]=D(e.match(B)[0])});var un=Te("Date",!0);I("DDD",["DDDD",3],"DDDo","dayOfYear"),C("dayOfYear","DDD"),F("dayOfYear",4),ue("DDD",K),ue("DDDD",$),ce(["DDD","DDDD"],function(e,t,n){n._dayOfYear=D(e)}),I("m",["mm",2],0,"minute"),C("minute","m"),F("minute",14),ue("m",B),ue("mm",B,z),ce(["m","mm"],ve);var ln=Te("Minutes",!1);I("s",["ss",2],0,"second"),C("second","s"),F("second",15),ue("s",B),ue("ss",B,z),ce(["s","ss"],pe);var hn,dn=Te("Seconds",!1);for(I("S",0,0,function(){return~~(this.millisecond()/100)}),I(0,["SS",2],0,function(){return~~(this.millisecond()/10)}),I(0,["SSS",3],0,"millisecond"),I(0,["SSSS",4],0,function(){return 10*this.millisecond()}),I(0,["SSSSS",5],0,function(){return 100*this.millisecond()}),I(0,["SSSSSS",6],0,function(){return 1e3*this.millisecond()}),I(0,["SSSSSSS",7],0,function(){return 1e4*this.millisecond()}),I(0,["SSSSSSSS",8],0,function(){return 1e5*this.millisecond()}),I(0,["SSSSSSSSS",9],0,function(){return 1e6*this.millisecond()}),C("millisecond","ms"),F("millisecond",16),ue("S",K,Z),ue("SS",K,z),ue("SSS",K,$),hn="SSSS";hn.length<=9;hn+="S")ue(hn,ne);function cn(e,t){t[we]=D(1e3*("0."+e))}for(hn="S";hn.length<=9;hn+="S")ce(hn,cn);var fn=Te("Milliseconds",!1);I("z",0,0,"zoneAbbr"),I("zz",0,0,"zoneName");var mn=M.prototype;function _n(e){return e}mn.add=Jt,mn.calendar=function(e,t){var n=e||bt(),s=Gt(n,this).startOf("day"),i=c.calendarFormat(this,s)||"sameElse",r=t&&(b(t[i])?t[i].call(this,n):t[i]);return this.format(r||this.localeData().calendar(i,this,bt(n)))},mn.clone=function(){return new M(this)},mn.diff=function(e,t,n){var s,i,r;if(!this.isValid())return NaN;if(!(s=Gt(e,this)).isValid())return NaN;switch(i=6e4*(s.utcOffset()-this.utcOffset()),t=H(t)){case"year":r=Qt(this,s)/12;break;case"month":r=Qt(this,s);break;case"quarter":r=Qt(this,s)/3;break;case"second":r=(this-s)/1e3;break;case"minute":r=(this-s)/6e4;break;case"hour":r=(this-s)/36e5;break;case"day":r=(this-s-i)/864e5;break;case"week":r=(this-s-i)/6048e5;break;default:r=this-s}return n?r:S(r)},mn.endOf=function(e){var t;if(void 0===(e=H(e))||"millisecond"===e||!this.isValid())return this;var n=this._isUTC?rn:sn;switch(e){case"year":t=n(this.year()+1,0,1)-1;break;case"quarter":t=n(this.year(),this.month()-this.month()%3+3,1)-1;break;case"month":t=n(this.year(),this.month()+1,1)-1;break;case"week":t=n(this.year(),this.month(),this.date()-this.weekday()+7)-1;break;case"isoWeek":t=n(this.year(),this.month(),this.date()-(this.isoWeekday()-1)+7)-1;break;case"day":case"date":t=n(this.year(),this.month(),this.date()+1)-1;break;case"hour":t=this._d.valueOf(),t+=36e5-nn(t+(this._isUTC?0:6e4*this.utcOffset()),36e5)-1;break;case"minute":t=this._d.valueOf(),t+=6e4-nn(t,6e4)-1;break;case"second":t=this._d.valueOf(),t+=1e3-nn(t,1e3)-1;break}return this._d.setTime(t),c.updateOffset(this,!0),this},mn.format=function(e){e||(e=this.isUtc()?c.defaultFormatUtc:c.defaultFormat);var t=A(this,e);return this.localeData().postformat(t)},mn.from=function(e,t){return this.isValid()&&(k(e)&&e.isValid()||bt(e).isValid())?jt({to:this,from:e}).locale(this.locale()).humanize(!t):this.localeData().invalidDate()},mn.fromNow=function(e){return this.from(bt(),e)},mn.to=function(e,t){return this.isValid()&&(k(e)&&e.isValid()||bt(e).isValid())?jt({from:this,to:e}).locale(this.locale()).humanize(!t):this.localeData().invalidDate()},mn.toNow=function(e){return this.to(bt(),e)},mn.get=function(e){return b(this[e=H(e)])?this[e]():this},mn.invalidAt=function(){return g(this).overflow},mn.isAfter=function(e,t){var n=k(e)?e:bt(e);return!(!this.isValid()||!n.isValid())&&("millisecond"===(t=H(t)||"millisecond")?this.valueOf()>n.valueOf():n.valueOf()<this.clone().startOf(t).valueOf())},mn.isBefore=function(e,t){var n=k(e)?e:bt(e);return!(!this.isValid()||!n.isValid())&&("millisecond"===(t=H(t)||"millisecond")?this.valueOf()<n.valueOf():this.clone().endOf(t).valueOf()<n.valueOf())},mn.isBetween=function(e,t,n,s){var i=k(e)?e:bt(e),r=k(t)?t:bt(t);return!!(this.isValid()&&i.isValid()&&r.isValid())&&("("===(s=s||"()")[0]?this.isAfter(i,n):!this.isBefore(i,n))&&(")"===s[1]?this.isBefore(r,n):!this.isAfter(r,n))},mn.isSame=function(e,t){var n,s=k(e)?e:bt(e);return!(!this.isValid()||!s.isValid())&&("millisecond"===(t=H(t)||"millisecond")?this.valueOf()===s.valueOf():(n=s.valueOf(),this.clone().startOf(t).valueOf()<=n&&n<=this.clone().endOf(t).valueOf()))},mn.isSameOrAfter=function(e,t){return this.isSame(e,t)||this.isAfter(e,t)},mn.isSameOrBefore=function(e,t){return this.isSame(e,t)||this.isBefore(e,t)},mn.isValid=function(){return v(this)},mn.lang=Kt,mn.locale=Xt,mn.localeData=en,mn.max=Pt,mn.min=xt,mn.parsingFlags=function(){return _({},g(this))},mn.set=function(e,t){if("object"==typeof e)for(var n=function(e){var t=[];for(var n in e)t.push({unit:n,priority:U[n]});return t.sort(function(e,t){return e.priority-t.priority}),t}(e=R(e)),s=0;s<n.length;s++)this[n[s].unit](e[n[s].unit]);else if(b(this[e=H(e)]))return this[e](t);return this},mn.startOf=function(e){var t;if(void 0===(e=H(e))||"millisecond"===e||!this.isValid())return this;var n=this._isUTC?rn:sn;switch(e){case"year":t=n(this.year(),0,1);break;case"quarter":t=n(this.year(),this.month()-this.month()%3,1);break;case"month":t=n(this.year(),this.month(),1);break;case"week":t=n(this.year(),this.month(),this.date()-this.weekday());break;case"isoWeek":t=n(this.year(),this.month(),this.date()-(this.isoWeekday()-1));break;case"day":case"date":t=n(this.year(),this.month(),this.date());break;case"hour":t=this._d.valueOf(),t-=nn(t+(this._isUTC?0:6e4*this.utcOffset()),36e5);break;case"minute":t=this._d.valueOf(),t-=nn(t,6e4);break;case"second":t=this._d.valueOf(),t-=nn(t,1e3);break}return this._d.setTime(t),c.updateOffset(this,!0),this},mn.subtract=Bt,mn.toArray=function(){var e=this;return[e.year(),e.month(),e.date(),e.hour(),e.minute(),e.second(),e.millisecond()]},mn.toObject=function(){var e=this;return{years:e.year(),months:e.month(),date:e.date(),hours:e.hours(),minutes:e.minutes(),seconds:e.seconds(),milliseconds:e.milliseconds()}},mn.toDate=function(){return new Date(this.valueOf())},mn.toISOString=function(e){if(!this.isValid())return null;var t=!0!==e,n=t?this.clone().utc():this;return n.year()<0||9999<n.year()?A(n,t?"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]":"YYYYYY-MM-DD[T]HH:mm:ss.SSSZ"):b(Date.prototype.toISOString)?t?this.toDate().toISOString():new Date(this.valueOf()+60*this.utcOffset()*1e3).toISOString().replace("Z",A(n,"Z")):A(n,t?"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]":"YYYY-MM-DD[T]HH:mm:ss.SSSZ")},mn.inspect=function(){if(!this.isValid())return"moment.invalid(/* "+this._i+" */)";var e="moment",t="";this.isLocal()||(e=0===this.utcOffset()?"moment.utc":"moment.parseZone",t="Z");var n="["+e+'("]',s=0<=this.year()&&this.year()<=9999?"YYYY":"YYYYYY",i=t+'[")]';return this.format(n+s+"-MM-DD[T]HH:mm:ss.SSS"+i)},mn.toJSON=function(){return this.isValid()?this.toISOString():null},mn.toString=function(){return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},mn.unix=function(){return Math.floor(this.valueOf()/1e3)},mn.valueOf=function(){return this._d.valueOf()-6e4*(this._offset||0)},mn.creationData=function(){return{input:this._i,format:this._f,locale:this._locale,isUTC:this._isUTC,strict:this._strict}},mn.year=Oe,mn.isLeapYear=function(){return De(this.year())},mn.weekYear=function(e){return on.call(this,e,this.week(),this.weekday(),this.localeData()._week.dow,this.localeData()._week.doy)},mn.isoWeekYear=function(e){return on.call(this,e,this.isoWeek(),this.isoWeekday(),1,4)},mn.quarter=mn.quarters=function(e){return null==e?Math.ceil((this.month()+1)/3):this.month(3*(e-1)+this.month()%3)},mn.month=Ue,mn.daysInMonth=function(){return Pe(this.year(),this.month())},mn.week=mn.weeks=function(e){var t=this.localeData().week(this);return null==e?t:this.add(7*(e-t),"d")},mn.isoWeek=mn.isoWeeks=function(e){var t=Ie(this,1,4).week;return null==e?t:this.add(7*(e-t),"d")},mn.weeksInYear=function(){var e=this.localeData()._week;return Ae(this.year(),e.dow,e.doy)},mn.isoWeeksInYear=function(){return Ae(this.year(),1,4)},mn.date=un,mn.day=mn.days=function(e){if(!this.isValid())return null!=e?this:NaN;var t,n,s=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=e?(t=e,n=this.localeData(),e="string"!=typeof t?t:isNaN(t)?"number"==typeof(t=n.weekdaysParse(t))?t:null:parseInt(t,10),this.add(e-s,"d")):s},mn.weekday=function(e){if(!this.isValid())return null!=e?this:NaN;var t=(this.day()+7-this.localeData()._week.dow)%7;return null==e?t:this.add(e-t,"d")},mn.isoWeekday=function(e){if(!this.isValid())return null!=e?this:NaN;if(null==e)return this.day()||7;var t,n,s=(t=e,n=this.localeData(),"string"==typeof t?n.weekdaysParse(t)%7||7:isNaN(t)?null:t);return this.day(this.day()%7?s:s-7)},mn.dayOfYear=function(e){var t=Math.round((this.clone().startOf("day")-this.clone().startOf("year"))/864e5)+1;return null==e?t:this.add(e-t,"d")},mn.hour=mn.hours=nt,mn.minute=mn.minutes=ln,mn.second=mn.seconds=dn,mn.millisecond=mn.milliseconds=fn,mn.utcOffset=function(e,t,n){var s,i=this._offset||0;if(!this.isValid())return null!=e?this:NaN;if(null==e)return this._isUTC?i:Vt(this);if("string"==typeof e){if(null===(e=Nt(re,e)))return this}else Math.abs(e)<16&&!n&&(e*=60);return!this._isUTC&&t&&(s=Vt(this)),this._offset=e,this._isUTC=!0,null!=s&&this.add(s,"m"),i!==e&&(!t||this._changeInProgress?qt(this,jt(e-i,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,c.updateOffset(this,!0),this._changeInProgress=null)),this},mn.utc=function(e){return this.utcOffset(0,e)},mn.local=function(e){return this._isUTC&&(this.utcOffset(0,e),this._isUTC=!1,e&&this.subtract(Vt(this),"m")),this},mn.parseZone=function(){if(null!=this._tzm)this.utcOffset(this._tzm,!1,!0);else if("string"==typeof this._i){var e=Nt(ie,this._i);null!=e?this.utcOffset(e):this.utcOffset(0,!0)}return this},mn.hasAlignedHourOffset=function(e){return!!this.isValid()&&(e=e?bt(e).utcOffset():0,(this.utcOffset()-e)%60==0)},mn.isDST=function(){return this.utcOffset()>this.clone().month(0).utcOffset()||this.utcOffset()>this.clone().month(5).utcOffset()},mn.isLocal=function(){return!!this.isValid()&&!this._isUTC},mn.isUtcOffset=function(){return!!this.isValid()&&this._isUTC},mn.isUtc=Et,mn.isUTC=Et,mn.zoneAbbr=function(){return this._isUTC?"UTC":""},mn.zoneName=function(){return this._isUTC?"Coordinated Universal Time":""},mn.dates=n("dates accessor is deprecated. Use date instead.",un),mn.months=n("months accessor is deprecated. Use month instead",Ue),mn.years=n("years accessor is deprecated. Use year instead",Oe),mn.zone=n("moment().zone is deprecated, use moment().utcOffset instead. http://momentjs.com/guides/#/warnings/zone/",function(e,t){return null!=e?("string"!=typeof e&&(e=-e),this.utcOffset(e,t),this):-this.utcOffset()}),mn.isDSTShifted=n("isDSTShifted is deprecated. See http://momentjs.com/guides/#/warnings/dst-shifted/ for more information",function(){if(!l(this._isDSTShifted))return this._isDSTShifted;var e={};if(w(e,this),(e=Ot(e))._a){var t=e._isUTC?y(e._a):bt(e._a);this._isDSTShifted=this.isValid()&&0<a(e._a,t.toArray())}else this._isDSTShifted=!1;return this._isDSTShifted});var yn=P.prototype;function gn(e,t,n,s){var i=ht(),r=y().set(s,t);return i[n](r,e)}function vn(e,t,n){if(h(e)&&(t=e,e=void 0),e=e||"",null!=t)return gn(e,t,n,"month");var s,i=[];for(s=0;s<12;s++)i[s]=gn(e,s,n,"month");return i}function pn(e,t,n,s){t=("boolean"==typeof e?h(t)&&(n=t,t=void 0):(t=e,e=!1,h(n=t)&&(n=t,t=void 0)),t||"");var i,r=ht(),a=e?r._week.dow:0;if(null!=n)return gn(t,(n+a)%7,s,"day");var o=[];for(i=0;i<7;i++)o[i]=gn(t,(i+a)%7,s,"day");return o}yn.calendar=function(e,t,n){var s=this._calendar[e]||this._calendar.sameElse;return b(s)?s.call(t,n):s},yn.longDateFormat=function(e){var t=this._longDateFormat[e],n=this._longDateFormat[e.toUpperCase()];return t||!n?t:(this._longDateFormat[e]=n.replace(/MMMM|MM|DD|dddd/g,function(e){return e.slice(1)}),this._longDateFormat[e])},yn.invalidDate=function(){return this._invalidDate},yn.ordinal=function(e){return this._ordinal.replace("%d",e)},yn.preparse=_n,yn.postformat=_n,yn.relativeTime=function(e,t,n,s){var i=this._relativeTime[n];return b(i)?i(e,t,n,s):i.replace(/%d/i,e)},yn.pastFuture=function(e,t){var n=this._relativeTime[0<e?"future":"past"];return b(n)?n(t):n.replace(/%s/i,t)},yn.set=function(e){var t,n;for(n in e)b(t=e[n])?this[n]=t:this["_"+n]=t;this._config=e,this._dayOfMonthOrdinalParseLenient=new RegExp((this._dayOfMonthOrdinalParse.source||this._ordinalParse.source)+"|"+/\d{1,2}/.source)},yn.months=function(e,t){return e?o(this._months)?this._months[e.month()]:this._months[(this._months.isFormat||We).test(t)?"format":"standalone"][e.month()]:o(this._months)?this._months:this._months.standalone},yn.monthsShort=function(e,t){return e?o(this._monthsShort)?this._monthsShort[e.month()]:this._monthsShort[We.test(t)?"format":"standalone"][e.month()]:o(this._monthsShort)?this._monthsShort:this._monthsShort.standalone},yn.monthsParse=function(e,t,n){var s,i,r;if(this._monthsParseExact)return function(e,t,n){var s,i,r,a=e.toLocaleLowerCase();if(!this._monthsParse)for(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[],s=0;s<12;++s)r=y([2e3,s]),this._shortMonthsParse[s]=this.monthsShort(r,"").toLocaleLowerCase(),this._longMonthsParse[s]=this.months(r,"").toLocaleLowerCase();return n?"MMM"===t?-1!==(i=Ye.call(this._shortMonthsParse,a))?i:null:-1!==(i=Ye.call(this._longMonthsParse,a))?i:null:"MMM"===t?-1!==(i=Ye.call(this._shortMonthsParse,a))?i:-1!==(i=Ye.call(this._longMonthsParse,a))?i:null:-1!==(i=Ye.call(this._longMonthsParse,a))?i:-1!==(i=Ye.call(this._shortMonthsParse,a))?i:null}.call(this,e,t,n);for(this._monthsParse||(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[]),s=0;s<12;s++){if(i=y([2e3,s]),n&&!this._longMonthsParse[s]&&(this._longMonthsParse[s]=new RegExp("^"+this.months(i,"").replace(".","")+"$","i"),this._shortMonthsParse[s]=new RegExp("^"+this.monthsShort(i,"").replace(".","")+"$","i")),n||this._monthsParse[s]||(r="^"+this.months(i,"")+"|^"+this.monthsShort(i,""),this._monthsParse[s]=new RegExp(r.replace(".",""),"i")),n&&"MMMM"===t&&this._longMonthsParse[s].test(e))return s;if(n&&"MMM"===t&&this._shortMonthsParse[s].test(e))return s;if(!n&&this._monthsParse[s].test(e))return s}},yn.monthsRegex=function(e){return this._monthsParseExact?(m(this,"_monthsRegex")||Ne.call(this),e?this._monthsStrictRegex:this._monthsRegex):(m(this,"_monthsRegex")||(this._monthsRegex=Le),this._monthsStrictRegex&&e?this._monthsStrictRegex:this._monthsRegex)},yn.monthsShortRegex=function(e){return this._monthsParseExact?(m(this,"_monthsRegex")||Ne.call(this),e?this._monthsShortStrictRegex:this._monthsShortRegex):(m(this,"_monthsShortRegex")||(this._monthsShortRegex=Fe),this._monthsShortStrictRegex&&e?this._monthsShortStrictRegex:this._monthsShortRegex)},yn.week=function(e){return Ie(e,this._week.dow,this._week.doy).week},yn.firstDayOfYear=function(){return this._week.doy},yn.firstDayOfWeek=function(){return this._week.dow},yn.weekdays=function(e,t){var n=o(this._weekdays)?this._weekdays:this._weekdays[e&&!0!==e&&this._weekdays.isFormat.test(t)?"format":"standalone"];return!0===e?je(n,this._week.dow):e?n[e.day()]:n},yn.weekdaysMin=function(e){return!0===e?je(this._weekdaysMin,this._week.dow):e?this._weekdaysMin[e.day()]:this._weekdaysMin},yn.weekdaysShort=function(e){return!0===e?je(this._weekdaysShort,this._week.dow):e?this._weekdaysShort[e.day()]:this._weekdaysShort},yn.weekdaysParse=function(e,t,n){var s,i,r;if(this._weekdaysParseExact)return function(e,t,n){var s,i,r,a=e.toLocaleLowerCase();if(!this._weekdaysParse)for(this._weekdaysParse=[],this._shortWeekdaysParse=[],this._minWeekdaysParse=[],s=0;s<7;++s)r=y([2e3,1]).day(s),this._minWeekdaysParse[s]=this.weekdaysMin(r,"").toLocaleLowerCase(),this._shortWeekdaysParse[s]=this.weekdaysShort(r,"").toLocaleLowerCase(),this._weekdaysParse[s]=this.weekdays(r,"").toLocaleLowerCase();return n?"dddd"===t?-1!==(i=Ye.call(this._weekdaysParse,a))?i:null:"ddd"===t?-1!==(i=Ye.call(this._shortWeekdaysParse,a))?i:null:-1!==(i=Ye.call(this._minWeekdaysParse,a))?i:null:"dddd"===t?-1!==(i=Ye.call(this._weekdaysParse,a))?i:-1!==(i=Ye.call(this._shortWeekdaysParse,a))?i:-1!==(i=Ye.call(this._minWeekdaysParse,a))?i:null:"ddd"===t?-1!==(i=Ye.call(this._shortWeekdaysParse,a))?i:-1!==(i=Ye.call(this._weekdaysParse,a))?i:-1!==(i=Ye.call(this._minWeekdaysParse,a))?i:null:-1!==(i=Ye.call(this._minWeekdaysParse,a))?i:-1!==(i=Ye.call(this._weekdaysParse,a))?i:-1!==(i=Ye.call(this._shortWeekdaysParse,a))?i:null}.call(this,e,t,n);for(this._weekdaysParse||(this._weekdaysParse=[],this._minWeekdaysParse=[],this._shortWeekdaysParse=[],this._fullWeekdaysParse=[]),s=0;s<7;s++){if(i=y([2e3,1]).day(s),n&&!this._fullWeekdaysParse[s]&&(this._fullWeekdaysParse[s]=new RegExp("^"+this.weekdays(i,"").replace(".","\\.?")+"$","i"),this._shortWeekdaysParse[s]=new RegExp("^"+this.weekdaysShort(i,"").replace(".","\\.?")+"$","i"),this._minWeekdaysParse[s]=new RegExp("^"+this.weekdaysMin(i,"").replace(".","\\.?")+"$","i")),this._weekdaysParse[s]||(r="^"+this.weekdays(i,"")+"|^"+this.weekdaysShort(i,"")+"|^"+this.weekdaysMin(i,""),this._weekdaysParse[s]=new RegExp(r.replace(".",""),"i")),n&&"dddd"===t&&this._fullWeekdaysParse[s].test(e))return s;if(n&&"ddd"===t&&this._shortWeekdaysParse[s].test(e))return s;if(n&&"dd"===t&&this._minWeekdaysParse[s].test(e))return s;if(!n&&this._weekdaysParse[s].test(e))return s}},yn.weekdaysRegex=function(e){return this._weekdaysParseExact?(m(this,"_weekdaysRegex")||Qe.call(this),e?this._weekdaysStrictRegex:this._weekdaysRegex):(m(this,"_weekdaysRegex")||(this._weekdaysRegex=qe),this._weekdaysStrictRegex&&e?this._weekdaysStrictRegex:this._weekdaysRegex)},yn.weekdaysShortRegex=function(e){return this._weekdaysParseExact?(m(this,"_weekdaysRegex")||Qe.call(this),e?this._weekdaysShortStrictRegex:this._weekdaysShortRegex):(m(this,"_weekdaysShortRegex")||(this._weekdaysShortRegex=Je),this._weekdaysShortStrictRegex&&e?this._weekdaysShortStrictRegex:this._weekdaysShortRegex)},yn.weekdaysMinRegex=function(e){return this._weekdaysParseExact?(m(this,"_weekdaysRegex")||Qe.call(this),e?this._weekdaysMinStrictRegex:this._weekdaysMinRegex):(m(this,"_weekdaysMinRegex")||(this._weekdaysMinRegex=Be),this._weekdaysMinStrictRegex&&e?this._weekdaysMinStrictRegex:this._weekdaysMinRegex)},yn.isPM=function(e){return"p"===(e+"").toLowerCase().charAt(0)},yn.meridiem=function(e,t,n){return 11<e?n?"pm":"PM":n?"am":"AM"},ut("en",{dayOfMonthOrdinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(e){var t=e%10;return e+(1===D(e%100/10)?"th":1===t?"st":2===t?"nd":3===t?"rd":"th")}}),c.lang=n("moment.lang is deprecated. Use moment.locale instead.",ut),c.langData=n("moment.langData is deprecated. Use moment.localeData instead.",ht);var wn=Math.abs;function Mn(e,t,n,s){var i=jt(t,n);return e._milliseconds+=s*i._milliseconds,e._days+=s*i._days,e._months+=s*i._months,e._bubble()}function kn(e){return e<0?Math.floor(e):Math.ceil(e)}function Sn(e){return 4800*e/146097}function Dn(e){return 146097*e/4800}function Yn(e){return function(){return this.as(e)}}var On=Yn("ms"),Tn=Yn("s"),bn=Yn("m"),xn=Yn("h"),Pn=Yn("d"),Wn=Yn("w"),Cn=Yn("M"),Hn=Yn("Q"),Rn=Yn("y");function Un(e){return function(){return this.isValid()?this._data[e]:NaN}}var Fn=Un("milliseconds"),Ln=Un("seconds"),Nn=Un("minutes"),Gn=Un("hours"),Vn=Un("days"),En=Un("months"),In=Un("years");var An=Math.round,jn={ss:44,s:45,m:45,h:22,d:26,M:11};var Zn=Math.abs;function zn(e){return(0<e)-(e<0)||+e}function $n(){if(!this.isValid())return this.localeData().invalidDate();var e,t,n=Zn(this._milliseconds)/1e3,s=Zn(this._days),i=Zn(this._months);t=S((e=S(n/60))/60),n%=60,e%=60;var r=S(i/12),a=i%=12,o=s,u=t,l=e,h=n?n.toFixed(3).replace(/\.?0+$/,""):"",d=this.asSeconds();if(!d)return"P0D";var c=d<0?"-":"",f=zn(this._months)!==zn(d)?"-":"",m=zn(this._days)!==zn(d)?"-":"",_=zn(this._milliseconds)!==zn(d)?"-":"";return c+"P"+(r?f+r+"Y":"")+(a?f+a+"M":"")+(o?m+o+"D":"")+(u||l||h?"T":"")+(u?_+u+"H":"")+(l?_+l+"M":"")+(h?_+h+"S":"")}var qn=Ht.prototype;return qn.isValid=function(){return this._isValid},qn.abs=function(){var e=this._data;return this._milliseconds=wn(this._milliseconds),this._days=wn(this._days),this._months=wn(this._months),e.milliseconds=wn(e.milliseconds),e.seconds=wn(e.seconds),e.minutes=wn(e.minutes),e.hours=wn(e.hours),e.months=wn(e.months),e.years=wn(e.years),this},qn.add=function(e,t){return Mn(this,e,t,1)},qn.subtract=function(e,t){return Mn(this,e,t,-1)},qn.as=function(e){if(!this.isValid())return NaN;var t,n,s=this._milliseconds;if("month"===(e=H(e))||"quarter"===e||"year"===e)switch(t=this._days+s/864e5,n=this._months+Sn(t),e){case"month":return n;case"quarter":return n/3;case"year":return n/12}else switch(t=this._days+Math.round(Dn(this._months)),e){case"week":return t/7+s/6048e5;case"day":return t+s/864e5;case"hour":return 24*t+s/36e5;case"minute":return 1440*t+s/6e4;case"second":return 86400*t+s/1e3;case"millisecond":return Math.floor(864e5*t)+s;default:throw new Error("Unknown unit "+e)}},qn.asMilliseconds=On,qn.asSeconds=Tn,qn.asMinutes=bn,qn.asHours=xn,qn.asDays=Pn,qn.asWeeks=Wn,qn.asMonths=Cn,qn.asQuarters=Hn,qn.asYears=Rn,qn.valueOf=function(){return this.isValid()?this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*D(this._months/12):NaN},qn._bubble=function(){var e,t,n,s,i,r=this._milliseconds,a=this._days,o=this._months,u=this._data;return 0<=r&&0<=a&&0<=o||r<=0&&a<=0&&o<=0||(r+=864e5*kn(Dn(o)+a),o=a=0),u.milliseconds=r%1e3,e=S(r/1e3),u.seconds=e%60,t=S(e/60),u.minutes=t%60,n=S(t/60),u.hours=n%24,o+=i=S(Sn(a+=S(n/24))),a-=kn(Dn(i)),s=S(o/12),o%=12,u.days=a,u.months=o,u.years=s,this},qn.clone=function(){return jt(this)},qn.get=function(e){return e=H(e),this.isValid()?this[e+"s"]():NaN},qn.milliseconds=Fn,qn.seconds=Ln,qn.minutes=Nn,qn.hours=Gn,qn.days=Vn,qn.weeks=function(){return S(this.days()/7)},qn.months=En,qn.years=In,qn.humanize=function(e){if(!this.isValid())return this.localeData().invalidDate();var t,n,s,i,r,a,o,u,l,h,d,c=this.localeData(),f=(n=!e,s=c,i=jt(t=this).abs(),r=An(i.as("s")),a=An(i.as("m")),o=An(i.as("h")),u=An(i.as("d")),l=An(i.as("M")),h=An(i.as("y")),(d=r<=jn.ss&&["s",r]||r<jn.s&&["ss",r]||a<=1&&["m"]||a<jn.m&&["mm",a]||o<=1&&["h"]||o<jn.h&&["hh",o]||u<=1&&["d"]||u<jn.d&&["dd",u]||l<=1&&["M"]||l<jn.M&&["MM",l]||h<=1&&["y"]||["yy",h])[2]=n,d[3]=0<+t,d[4]=s,function(e,t,n,s,i){return i.relativeTime(t||1,!!n,e,s)}.apply(null,d));return e&&(f=c.pastFuture(+this,f)),c.postformat(f)},qn.toISOString=$n,qn.toString=$n,qn.toJSON=$n,qn.locale=Xt,qn.localeData=en,qn.toIsoString=n("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)",$n),qn.lang=Kt,I("X",0,0,"unix"),I("x",0,0,"valueOf"),ue("x",se),ue("X",/[+-]?\d+(\.\d{1,3})?/),ce("X",function(e,t,n){n._d=new Date(1e3*parseFloat(e,10))}),ce("x",function(e,t,n){n._d=new Date(D(e))}),c.version="2.24.0",e=bt,c.fn=mn,c.min=function(){return Wt("isBefore",[].slice.call(arguments,0))},c.max=function(){return Wt("isAfter",[].slice.call(arguments,0))},c.now=function(){return Date.now?Date.now():+new Date},c.utc=y,c.unix=function(e){return bt(1e3*e)},c.months=function(e,t){return vn(e,t,"months")},c.isDate=d,c.locale=ut,c.invalid=p,c.duration=jt,c.isMoment=k,c.weekdays=function(e,t,n){return pn(e,t,n,"weekdays")},c.parseZone=function(){return bt.apply(null,arguments).parseZone()},c.localeData=ht,c.isDuration=Rt,c.monthsShort=function(e,t){return vn(e,t,"monthsShort")},c.weekdaysMin=function(e,t,n){return pn(e,t,n,"weekdaysMin")},c.defineLocale=lt,c.updateLocale=function(e,t){if(null!=t){var n,s,i=st;null!=(s=ot(e))&&(i=s._config),(n=new P(t=x(i,t))).parentLocale=it[e],it[e]=n,ut(e)}else null!=it[e]&&(null!=it[e].parentLocale?it[e]=it[e].parentLocale:null!=it[e]&&delete it[e]);return it[e]},c.locales=function(){return s(it)},c.weekdaysShort=function(e,t,n){return pn(e,t,n,"weekdaysShort")},c.normalizeUnits=H,c.relativeTimeRounding=function(e){return void 0===e?An:"function"==typeof e&&(An=e,!0)},c.relativeTimeThreshold=function(e,t){return void 0!==jn[e]&&(void 0===t?jn[e]:(jn[e]=t,"s"===e&&(jn.ss=t-1),!0))},c.calendarFormat=function(e,t){var n=e.diff(t,"days",!0);return n<-6?"sameElse":n<-1?"lastWeek":n<0?"lastDay":n<1?"sameDay":n<2?"nextDay":n<7?"nextWeek":"sameElse"},c.prototype=mn,c.HTML5_FMT={DATETIME_LOCAL:"YYYY-MM-DDTHH:mm",DATETIME_LOCAL_SECONDS:"YYYY-MM-DDTHH:mm:ss",DATETIME_LOCAL_MS:"YYYY-MM-DDTHH:mm:ss.SSS",DATE:"YYYY-MM-DD",TIME:"HH:mm",TIME_SECONDS:"HH:mm:ss",TIME_MS:"HH:mm:ss.SSS",WEEK:"GGGG-[W]WW",MONTH:"YYYY-MM"},c});
/*!
 * Masonry PACKAGED v4.2.2
 * Cascading grid layout library
 * https://masonry.desandro.com
 * MIT License
 * by David DeSandro
 */

!function(t,e){"function"==typeof define&&define.amd?define("jquery-bridget/jquery-bridget",["jquery"],function(i){return e(t,i)}):"object"==typeof module&&module.exports?module.exports=e(t,require("jquery")):t.jQueryBridget=e(t,t.jQuery)}(window,function(t,e){"use strict";function i(i,r,a){function h(t,e,n){var o,r="$()."+i+'("'+e+'")';return t.each(function(t,h){var u=a.data(h,i);if(!u)return void s(i+" not initialized. Cannot call methods, i.e. "+r);var d=u[e];if(!d||"_"==e.charAt(0))return void s(r+" is not a valid method");var l=d.apply(u,n);o=void 0===o?l:o}),void 0!==o?o:t}function u(t,e){t.each(function(t,n){var o=a.data(n,i);o?(o.option(e),o._init()):(o=new r(n,e),a.data(n,i,o))})}a=a||e||t.jQuery,a&&(r.prototype.option||(r.prototype.option=function(t){a.isPlainObject(t)&&(this.options=a.extend(!0,this.options,t))}),a.fn[i]=function(t){if("string"==typeof t){var e=o.call(arguments,1);return h(this,t,e)}return u(this,t),this},n(a))}function n(t){!t||t&&t.bridget||(t.bridget=i)}var o=Array.prototype.slice,r=t.console,s="undefined"==typeof r?function(){}:function(t){r.error(t)};return n(e||t.jQuery),i}),function(t,e){"function"==typeof define&&define.amd?define("ev-emitter/ev-emitter",e):"object"==typeof module&&module.exports?module.exports=e():t.EvEmitter=e()}("undefined"!=typeof window?window:this,function(){function t(){}var e=t.prototype;return e.on=function(t,e){if(t&&e){var i=this._events=this._events||{},n=i[t]=i[t]||[];return-1==n.indexOf(e)&&n.push(e),this}},e.once=function(t,e){if(t&&e){this.on(t,e);var i=this._onceEvents=this._onceEvents||{},n=i[t]=i[t]||{};return n[e]=!0,this}},e.off=function(t,e){var i=this._events&&this._events[t];if(i&&i.length){var n=i.indexOf(e);return-1!=n&&i.splice(n,1),this}},e.emitEvent=function(t,e){var i=this._events&&this._events[t];if(i&&i.length){i=i.slice(0),e=e||[];for(var n=this._onceEvents&&this._onceEvents[t],o=0;o<i.length;o++){var r=i[o],s=n&&n[r];s&&(this.off(t,r),delete n[r]),r.apply(this,e)}return this}},e.allOff=function(){delete this._events,delete this._onceEvents},t}),function(t,e){"function"==typeof define&&define.amd?define("get-size/get-size",e):"object"==typeof module&&module.exports?module.exports=e():t.getSize=e()}(window,function(){"use strict";function t(t){var e=parseFloat(t),i=-1==t.indexOf("%")&&!isNaN(e);return i&&e}function e(){}function i(){for(var t={width:0,height:0,innerWidth:0,innerHeight:0,outerWidth:0,outerHeight:0},e=0;u>e;e++){var i=h[e];t[i]=0}return t}function n(t){var e=getComputedStyle(t);return e||a("Style returned "+e+". Are you running this code in a hidden iframe on Firefox? See https://bit.ly/getsizebug1"),e}function o(){if(!d){d=!0;var e=document.createElement("div");e.style.width="200px",e.style.padding="1px 2px 3px 4px",e.style.borderStyle="solid",e.style.borderWidth="1px 2px 3px 4px",e.style.boxSizing="border-box";var i=document.body||document.documentElement;i.appendChild(e);var o=n(e);s=200==Math.round(t(o.width)),r.isBoxSizeOuter=s,i.removeChild(e)}}function r(e){if(o(),"string"==typeof e&&(e=document.querySelector(e)),e&&"object"==typeof e&&e.nodeType){var r=n(e);if("none"==r.display)return i();var a={};a.width=e.offsetWidth,a.height=e.offsetHeight;for(var d=a.isBorderBox="border-box"==r.boxSizing,l=0;u>l;l++){var c=h[l],f=r[c],m=parseFloat(f);a[c]=isNaN(m)?0:m}var p=a.paddingLeft+a.paddingRight,g=a.paddingTop+a.paddingBottom,y=a.marginLeft+a.marginRight,v=a.marginTop+a.marginBottom,_=a.borderLeftWidth+a.borderRightWidth,z=a.borderTopWidth+a.borderBottomWidth,E=d&&s,b=t(r.width);b!==!1&&(a.width=b+(E?0:p+_));var x=t(r.height);return x!==!1&&(a.height=x+(E?0:g+z)),a.innerWidth=a.width-(p+_),a.innerHeight=a.height-(g+z),a.outerWidth=a.width+y,a.outerHeight=a.height+v,a}}var s,a="undefined"==typeof console?e:function(t){console.error(t)},h=["paddingLeft","paddingRight","paddingTop","paddingBottom","marginLeft","marginRight","marginTop","marginBottom","borderLeftWidth","borderRightWidth","borderTopWidth","borderBottomWidth"],u=h.length,d=!1;return r}),function(t,e){"use strict";"function"==typeof define&&define.amd?define("desandro-matches-selector/matches-selector",e):"object"==typeof module&&module.exports?module.exports=e():t.matchesSelector=e()}(window,function(){"use strict";var t=function(){var t=window.Element.prototype;if(t.matches)return"matches";if(t.matchesSelector)return"matchesSelector";for(var e=["webkit","moz","ms","o"],i=0;i<e.length;i++){var n=e[i],o=n+"MatchesSelector";if(t[o])return o}}();return function(e,i){return e[t](i)}}),function(t,e){"function"==typeof define&&define.amd?define("fizzy-ui-utils/utils",["desandro-matches-selector/matches-selector"],function(i){return e(t,i)}):"object"==typeof module&&module.exports?module.exports=e(t,require("desandro-matches-selector")):t.fizzyUIUtils=e(t,t.matchesSelector)}(window,function(t,e){var i={};i.extend=function(t,e){for(var i in e)t[i]=e[i];return t},i.modulo=function(t,e){return(t%e+e)%e};var n=Array.prototype.slice;i.makeArray=function(t){if(Array.isArray(t))return t;if(null===t||void 0===t)return[];var e="object"==typeof t&&"number"==typeof t.length;return e?n.call(t):[t]},i.removeFrom=function(t,e){var i=t.indexOf(e);-1!=i&&t.splice(i,1)},i.getParent=function(t,i){for(;t.parentNode&&t!=document.body;)if(t=t.parentNode,e(t,i))return t},i.getQueryElement=function(t){return"string"==typeof t?document.querySelector(t):t},i.handleEvent=function(t){var e="on"+t.type;this[e]&&this[e](t)},i.filterFindElements=function(t,n){t=i.makeArray(t);var o=[];return t.forEach(function(t){if(t instanceof HTMLElement){if(!n)return void o.push(t);e(t,n)&&o.push(t);for(var i=t.querySelectorAll(n),r=0;r<i.length;r++)o.push(i[r])}}),o},i.debounceMethod=function(t,e,i){i=i||100;var n=t.prototype[e],o=e+"Timeout";t.prototype[e]=function(){var t=this[o];clearTimeout(t);var e=arguments,r=this;this[o]=setTimeout(function(){n.apply(r,e),delete r[o]},i)}},i.docReady=function(t){var e=document.readyState;"complete"==e||"interactive"==e?setTimeout(t):document.addEventListener("DOMContentLoaded",t)},i.toDashed=function(t){return t.replace(/(.)([A-Z])/g,function(t,e,i){return e+"-"+i}).toLowerCase()};var o=t.console;return i.htmlInit=function(e,n){i.docReady(function(){var r=i.toDashed(n),s="data-"+r,a=document.querySelectorAll("["+s+"]"),h=document.querySelectorAll(".js-"+r),u=i.makeArray(a).concat(i.makeArray(h)),d=s+"-options",l=t.jQuery;u.forEach(function(t){var i,r=t.getAttribute(s)||t.getAttribute(d);try{i=r&&JSON.parse(r)}catch(a){return void(o&&o.error("Error parsing "+s+" on "+t.className+": "+a))}var h=new e(t,i);l&&l.data(t,n,h)})})},i}),function(t,e){"function"==typeof define&&define.amd?define("outlayer/item",["ev-emitter/ev-emitter","get-size/get-size"],e):"object"==typeof module&&module.exports?module.exports=e(require("ev-emitter"),require("get-size")):(t.Outlayer={},t.Outlayer.Item=e(t.EvEmitter,t.getSize))}(window,function(t,e){"use strict";function i(t){for(var e in t)return!1;return e=null,!0}function n(t,e){t&&(this.element=t,this.layout=e,this.position={x:0,y:0},this._create())}function o(t){return t.replace(/([A-Z])/g,function(t){return"-"+t.toLowerCase()})}var r=document.documentElement.style,s="string"==typeof r.transition?"transition":"WebkitTransition",a="string"==typeof r.transform?"transform":"WebkitTransform",h={WebkitTransition:"webkitTransitionEnd",transition:"transitionend"}[s],u={transform:a,transition:s,transitionDuration:s+"Duration",transitionProperty:s+"Property",transitionDelay:s+"Delay"},d=n.prototype=Object.create(t.prototype);d.constructor=n,d._create=function(){this._transn={ingProperties:{},clean:{},onEnd:{}},this.css({position:"absolute"})},d.handleEvent=function(t){var e="on"+t.type;this[e]&&this[e](t)},d.getSize=function(){this.size=e(this.element)},d.css=function(t){var e=this.element.style;for(var i in t){var n=u[i]||i;e[n]=t[i]}},d.getPosition=function(){var t=getComputedStyle(this.element),e=this.layout._getOption("originLeft"),i=this.layout._getOption("originTop"),n=t[e?"left":"right"],o=t[i?"top":"bottom"],r=parseFloat(n),s=parseFloat(o),a=this.layout.size;-1!=n.indexOf("%")&&(r=r/100*a.width),-1!=o.indexOf("%")&&(s=s/100*a.height),r=isNaN(r)?0:r,s=isNaN(s)?0:s,r-=e?a.paddingLeft:a.paddingRight,s-=i?a.paddingTop:a.paddingBottom,this.position.x=r,this.position.y=s},d.layoutPosition=function(){var t=this.layout.size,e={},i=this.layout._getOption("originLeft"),n=this.layout._getOption("originTop"),o=i?"paddingLeft":"paddingRight",r=i?"left":"right",s=i?"right":"left",a=this.position.x+t[o];e[r]=this.getXValue(a),e[s]="";var h=n?"paddingTop":"paddingBottom",u=n?"top":"bottom",d=n?"bottom":"top",l=this.position.y+t[h];e[u]=this.getYValue(l),e[d]="",this.css(e),this.emitEvent("layout",[this])},d.getXValue=function(t){var e=this.layout._getOption("horizontal");return this.layout.options.percentPosition&&!e?t/this.layout.size.width*100+"%":t+"px"},d.getYValue=function(t){var e=this.layout._getOption("horizontal");return this.layout.options.percentPosition&&e?t/this.layout.size.height*100+"%":t+"px"},d._transitionTo=function(t,e){this.getPosition();var i=this.position.x,n=this.position.y,o=t==this.position.x&&e==this.position.y;if(this.setPosition(t,e),o&&!this.isTransitioning)return void this.layoutPosition();var r=t-i,s=e-n,a={};a.transform=this.getTranslate(r,s),this.transition({to:a,onTransitionEnd:{transform:this.layoutPosition},isCleaning:!0})},d.getTranslate=function(t,e){var i=this.layout._getOption("originLeft"),n=this.layout._getOption("originTop");return t=i?t:-t,e=n?e:-e,"translate3d("+t+"px, "+e+"px, 0)"},d.goTo=function(t,e){this.setPosition(t,e),this.layoutPosition()},d.moveTo=d._transitionTo,d.setPosition=function(t,e){this.position.x=parseFloat(t),this.position.y=parseFloat(e)},d._nonTransition=function(t){this.css(t.to),t.isCleaning&&this._removeStyles(t.to);for(var e in t.onTransitionEnd)t.onTransitionEnd[e].call(this)},d.transition=function(t){if(!parseFloat(this.layout.options.transitionDuration))return void this._nonTransition(t);var e=this._transn;for(var i in t.onTransitionEnd)e.onEnd[i]=t.onTransitionEnd[i];for(i in t.to)e.ingProperties[i]=!0,t.isCleaning&&(e.clean[i]=!0);if(t.from){this.css(t.from);var n=this.element.offsetHeight;n=null}this.enableTransition(t.to),this.css(t.to),this.isTransitioning=!0};var l="opacity,"+o(a);d.enableTransition=function(){if(!this.isTransitioning){var t=this.layout.options.transitionDuration;t="number"==typeof t?t+"ms":t,this.css({transitionProperty:l,transitionDuration:t,transitionDelay:this.staggerDelay||0}),this.element.addEventListener(h,this,!1)}},d.onwebkitTransitionEnd=function(t){this.ontransitionend(t)},d.onotransitionend=function(t){this.ontransitionend(t)};var c={"-webkit-transform":"transform"};d.ontransitionend=function(t){if(t.target===this.element){var e=this._transn,n=c[t.propertyName]||t.propertyName;if(delete e.ingProperties[n],i(e.ingProperties)&&this.disableTransition(),n in e.clean&&(this.element.style[t.propertyName]="",delete e.clean[n]),n in e.onEnd){var o=e.onEnd[n];o.call(this),delete e.onEnd[n]}this.emitEvent("transitionEnd",[this])}},d.disableTransition=function(){this.removeTransitionStyles(),this.element.removeEventListener(h,this,!1),this.isTransitioning=!1},d._removeStyles=function(t){var e={};for(var i in t)e[i]="";this.css(e)};var f={transitionProperty:"",transitionDuration:"",transitionDelay:""};return d.removeTransitionStyles=function(){this.css(f)},d.stagger=function(t){t=isNaN(t)?0:t,this.staggerDelay=t+"ms"},d.removeElem=function(){this.element.parentNode.removeChild(this.element),this.css({display:""}),this.emitEvent("remove",[this])},d.remove=function(){return s&&parseFloat(this.layout.options.transitionDuration)?(this.once("transitionEnd",function(){this.removeElem()}),void this.hide()):void this.removeElem()},d.reveal=function(){delete this.isHidden,this.css({display:""});var t=this.layout.options,e={},i=this.getHideRevealTransitionEndProperty("visibleStyle");e[i]=this.onRevealTransitionEnd,this.transition({from:t.hiddenStyle,to:t.visibleStyle,isCleaning:!0,onTransitionEnd:e})},d.onRevealTransitionEnd=function(){this.isHidden||this.emitEvent("reveal")},d.getHideRevealTransitionEndProperty=function(t){var e=this.layout.options[t];if(e.opacity)return"opacity";for(var i in e)return i},d.hide=function(){this.isHidden=!0,this.css({display:""});var t=this.layout.options,e={},i=this.getHideRevealTransitionEndProperty("hiddenStyle");e[i]=this.onHideTransitionEnd,this.transition({from:t.visibleStyle,to:t.hiddenStyle,isCleaning:!0,onTransitionEnd:e})},d.onHideTransitionEnd=function(){this.isHidden&&(this.css({display:"none"}),this.emitEvent("hide"))},d.destroy=function(){this.css({position:"",left:"",right:"",top:"",bottom:"",transition:"",transform:""})},n}),function(t,e){"use strict";"function"==typeof define&&define.amd?define("outlayer/outlayer",["ev-emitter/ev-emitter","get-size/get-size","fizzy-ui-utils/utils","./item"],function(i,n,o,r){return e(t,i,n,o,r)}):"object"==typeof module&&module.exports?module.exports=e(t,require("ev-emitter"),require("get-size"),require("fizzy-ui-utils"),require("./item")):t.Outlayer=e(t,t.EvEmitter,t.getSize,t.fizzyUIUtils,t.Outlayer.Item)}(window,function(t,e,i,n,o){"use strict";function r(t,e){var i=n.getQueryElement(t);if(!i)return void(h&&h.error("Bad element for "+this.constructor.namespace+": "+(i||t)));this.element=i,u&&(this.$element=u(this.element)),this.options=n.extend({},this.constructor.defaults),this.option(e);var o=++l;this.element.outlayerGUID=o,c[o]=this,this._create();var r=this._getOption("initLayout");r&&this.layout()}function s(t){function e(){t.apply(this,arguments)}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e}function a(t){if("number"==typeof t)return t;var e=t.match(/(^\d*\.?\d*)(\w*)/),i=e&&e[1],n=e&&e[2];if(!i.length)return 0;i=parseFloat(i);var o=m[n]||1;return i*o}var h=t.console,u=t.jQuery,d=function(){},l=0,c={};r.namespace="outlayer",r.Item=o,r.defaults={containerStyle:{position:"relative"},initLayout:!0,originLeft:!0,originTop:!0,resize:!0,resizeContainer:!0,transitionDuration:"0.4s",hiddenStyle:{opacity:0,transform:"scale(0.001)"},visibleStyle:{opacity:1,transform:"scale(1)"}};var f=r.prototype;n.extend(f,e.prototype),f.option=function(t){n.extend(this.options,t)},f._getOption=function(t){var e=this.constructor.compatOptions[t];return e&&void 0!==this.options[e]?this.options[e]:this.options[t]},r.compatOptions={initLayout:"isInitLayout",horizontal:"isHorizontal",layoutInstant:"isLayoutInstant",originLeft:"isOriginLeft",originTop:"isOriginTop",resize:"isResizeBound",resizeContainer:"isResizingContainer"},f._create=function(){this.reloadItems(),this.stamps=[],this.stamp(this.options.stamp),n.extend(this.element.style,this.options.containerStyle);var t=this._getOption("resize");t&&this.bindResize()},f.reloadItems=function(){this.items=this._itemize(this.element.children)},f._itemize=function(t){for(var e=this._filterFindItemElements(t),i=this.constructor.Item,n=[],o=0;o<e.length;o++){var r=e[o],s=new i(r,this);n.push(s)}return n},f._filterFindItemElements=function(t){return n.filterFindElements(t,this.options.itemSelector)},f.getItemElements=function(){return this.items.map(function(t){return t.element})},f.layout=function(){this._resetLayout(),this._manageStamps();var t=this._getOption("layoutInstant"),e=void 0!==t?t:!this._isLayoutInited;this.layoutItems(this.items,e),this._isLayoutInited=!0},f._init=f.layout,f._resetLayout=function(){this.getSize()},f.getSize=function(){this.size=i(this.element)},f._getMeasurement=function(t,e){var n,o=this.options[t];o?("string"==typeof o?n=this.element.querySelector(o):o instanceof HTMLElement&&(n=o),this[t]=n?i(n)[e]:o):this[t]=0},f.layoutItems=function(t,e){t=this._getItemsForLayout(t),this._layoutItems(t,e),this._postLayout()},f._getItemsForLayout=function(t){return t.filter(function(t){return!t.isIgnored})},f._layoutItems=function(t,e){if(this._emitCompleteOnItems("layout",t),t&&t.length){var i=[];t.forEach(function(t){var n=this._getItemLayoutPosition(t);n.item=t,n.isInstant=e||t.isLayoutInstant,i.push(n)},this),this._processLayoutQueue(i)}},f._getItemLayoutPosition=function(){return{x:0,y:0}},f._processLayoutQueue=function(t){this.updateStagger(),t.forEach(function(t,e){this._positionItem(t.item,t.x,t.y,t.isInstant,e)},this)},f.updateStagger=function(){var t=this.options.stagger;return null===t||void 0===t?void(this.stagger=0):(this.stagger=a(t),this.stagger)},f._positionItem=function(t,e,i,n,o){n?t.goTo(e,i):(t.stagger(o*this.stagger),t.moveTo(e,i))},f._postLayout=function(){this.resizeContainer()},f.resizeContainer=function(){var t=this._getOption("resizeContainer");if(t){var e=this._getContainerSize();e&&(this._setContainerMeasure(e.width,!0),this._setContainerMeasure(e.height,!1))}},f._getContainerSize=d,f._setContainerMeasure=function(t,e){if(void 0!==t){var i=this.size;i.isBorderBox&&(t+=e?i.paddingLeft+i.paddingRight+i.borderLeftWidth+i.borderRightWidth:i.paddingBottom+i.paddingTop+i.borderTopWidth+i.borderBottomWidth),t=Math.max(t,0),this.element.style[e?"width":"height"]=t+"px"}},f._emitCompleteOnItems=function(t,e){function i(){o.dispatchEvent(t+"Complete",null,[e])}function n(){s++,s==r&&i()}var o=this,r=e.length;if(!e||!r)return void i();var s=0;e.forEach(function(e){e.once(t,n)})},f.dispatchEvent=function(t,e,i){var n=e?[e].concat(i):i;if(this.emitEvent(t,n),u)if(this.$element=this.$element||u(this.element),e){var o=u.Event(e);o.type=t,this.$element.trigger(o,i)}else this.$element.trigger(t,i)},f.ignore=function(t){var e=this.getItem(t);e&&(e.isIgnored=!0)},f.unignore=function(t){var e=this.getItem(t);e&&delete e.isIgnored},f.stamp=function(t){t=this._find(t),t&&(this.stamps=this.stamps.concat(t),t.forEach(this.ignore,this))},f.unstamp=function(t){t=this._find(t),t&&t.forEach(function(t){n.removeFrom(this.stamps,t),this.unignore(t)},this)},f._find=function(t){return t?("string"==typeof t&&(t=this.element.querySelectorAll(t)),t=n.makeArray(t)):void 0},f._manageStamps=function(){this.stamps&&this.stamps.length&&(this._getBoundingRect(),this.stamps.forEach(this._manageStamp,this))},f._getBoundingRect=function(){var t=this.element.getBoundingClientRect(),e=this.size;this._boundingRect={left:t.left+e.paddingLeft+e.borderLeftWidth,top:t.top+e.paddingTop+e.borderTopWidth,right:t.right-(e.paddingRight+e.borderRightWidth),bottom:t.bottom-(e.paddingBottom+e.borderBottomWidth)}},f._manageStamp=d,f._getElementOffset=function(t){var e=t.getBoundingClientRect(),n=this._boundingRect,o=i(t),r={left:e.left-n.left-o.marginLeft,top:e.top-n.top-o.marginTop,right:n.right-e.right-o.marginRight,bottom:n.bottom-e.bottom-o.marginBottom};return r},f.handleEvent=n.handleEvent,f.bindResize=function(){t.addEventListener("resize",this),this.isResizeBound=!0},f.unbindResize=function(){t.removeEventListener("resize",this),this.isResizeBound=!1},f.onresize=function(){this.resize()},n.debounceMethod(r,"onresize",100),f.resize=function(){this.isResizeBound&&this.needsResizeLayout()&&this.layout()},f.needsResizeLayout=function(){var t=i(this.element),e=this.size&&t;return e&&t.innerWidth!==this.size.innerWidth},f.addItems=function(t){var e=this._itemize(t);return e.length&&(this.items=this.items.concat(e)),e},f.appended=function(t){var e=this.addItems(t);e.length&&(this.layoutItems(e,!0),this.reveal(e))},f.prepended=function(t){var e=this._itemize(t);if(e.length){var i=this.items.slice(0);this.items=e.concat(i),this._resetLayout(),this._manageStamps(),this.layoutItems(e,!0),this.reveal(e),this.layoutItems(i)}},f.reveal=function(t){if(this._emitCompleteOnItems("reveal",t),t&&t.length){var e=this.updateStagger();t.forEach(function(t,i){t.stagger(i*e),t.reveal()})}},f.hide=function(t){if(this._emitCompleteOnItems("hide",t),t&&t.length){var e=this.updateStagger();t.forEach(function(t,i){t.stagger(i*e),t.hide()})}},f.revealItemElements=function(t){var e=this.getItems(t);this.reveal(e)},f.hideItemElements=function(t){var e=this.getItems(t);this.hide(e)},f.getItem=function(t){for(var e=0;e<this.items.length;e++){var i=this.items[e];if(i.element==t)return i}},f.getItems=function(t){t=n.makeArray(t);var e=[];return t.forEach(function(t){var i=this.getItem(t);i&&e.push(i)},this),e},f.remove=function(t){var e=this.getItems(t);this._emitCompleteOnItems("remove",e),e&&e.length&&e.forEach(function(t){t.remove(),n.removeFrom(this.items,t)},this)},f.destroy=function(){var t=this.element.style;t.height="",t.position="",t.width="",this.items.forEach(function(t){t.destroy()}),this.unbindResize();var e=this.element.outlayerGUID;delete c[e],delete this.element.outlayerGUID,u&&u.removeData(this.element,this.constructor.namespace)},r.data=function(t){t=n.getQueryElement(t);var e=t&&t.outlayerGUID;return e&&c[e]},r.create=function(t,e){var i=s(r);return i.defaults=n.extend({},r.defaults),n.extend(i.defaults,e),i.compatOptions=n.extend({},r.compatOptions),i.namespace=t,i.data=r.data,i.Item=s(o),n.htmlInit(i,t),u&&u.bridget&&u.bridget(t,i),i};var m={ms:1,s:1e3};return r.Item=o,r}),function(t,e){"function"==typeof define&&define.amd?define(["outlayer/outlayer","get-size/get-size"],e):"object"==typeof module&&module.exports?module.exports=e(require("outlayer"),require("get-size")):t.Masonry=e(t.Outlayer,t.getSize)}(window,function(t,e){var i=t.create("masonry");i.compatOptions.fitWidth="isFitWidth";var n=i.prototype;return n._resetLayout=function(){this.getSize(),this._getMeasurement("columnWidth","outerWidth"),this._getMeasurement("gutter","outerWidth"),this.measureColumns(),this.colYs=[];for(var t=0;t<this.cols;t++)this.colYs.push(0);this.maxY=0,this.horizontalColIndex=0},n.measureColumns=function(){if(this.getContainerWidth(),!this.columnWidth){var t=this.items[0],i=t&&t.element;this.columnWidth=i&&e(i).outerWidth||this.containerWidth}var n=this.columnWidth+=this.gutter,o=this.containerWidth+this.gutter,r=o/n,s=n-o%n,a=s&&1>s?"round":"floor";r=Math[a](r),this.cols=Math.max(r,1)},n.getContainerWidth=function(){var t=this._getOption("fitWidth"),i=t?this.element.parentNode:this.element,n=e(i);this.containerWidth=n&&n.innerWidth},n._getItemLayoutPosition=function(t){t.getSize();var e=t.size.outerWidth%this.columnWidth,i=e&&1>e?"round":"ceil",n=Math[i](t.size.outerWidth/this.columnWidth);n=Math.min(n,this.cols);for(var o=this.options.horizontalOrder?"_getHorizontalColPosition":"_getTopColPosition",r=this[o](n,t),s={x:this.columnWidth*r.col,y:r.y},a=r.y+t.size.outerHeight,h=n+r.col,u=r.col;h>u;u++)this.colYs[u]=a;return s},n._getTopColPosition=function(t){var e=this._getTopColGroup(t),i=Math.min.apply(Math,e);return{col:e.indexOf(i),y:i}},n._getTopColGroup=function(t){if(2>t)return this.colYs;for(var e=[],i=this.cols+1-t,n=0;i>n;n++)e[n]=this._getColGroupY(n,t);return e},n._getColGroupY=function(t,e){if(2>e)return this.colYs[t];var i=this.colYs.slice(t,t+e);return Math.max.apply(Math,i)},n._getHorizontalColPosition=function(t,e){var i=this.horizontalColIndex%this.cols,n=t>1&&i+t>this.cols;i=n?0:i;var o=e.size.outerWidth&&e.size.outerHeight;return this.horizontalColIndex=o?i+t:this.horizontalColIndex,{col:i,y:this._getColGroupY(i,t)}},n._manageStamp=function(t){var i=e(t),n=this._getElementOffset(t),o=this._getOption("originLeft"),r=o?n.left:n.right,s=r+i.outerWidth,a=Math.floor(r/this.columnWidth);a=Math.max(0,a);var h=Math.floor(s/this.columnWidth);h-=s%this.columnWidth?0:1,h=Math.min(this.cols-1,h);for(var u=this._getOption("originTop"),d=(u?n.top:n.bottom)+i.outerHeight,l=a;h>=l;l++)this.colYs[l]=Math.max(d,this.colYs[l])},n._getContainerSize=function(){this.maxY=Math.max.apply(Math,this.colYs);var t={height:this.maxY};return this._getOption("fitWidth")&&(t.width=this._getContainerFitWidth()),t},n._getContainerFitWidth=function(){for(var t=0,e=this.cols;--e&&0===this.colYs[e];)t++;return(this.cols-t)*this.columnWidth-this.gutter},n.needsResizeLayout=function(){var t=this.containerWidth;return this.getContainerWidth(),t!=this.containerWidth},i});
/**
 * Owl Carousel v2.3.0
 * Copyright 2013-2017 David Deutsch
 * Licensed under  ()
 */
!function(a,b,c,d){function e(b,c){this.settings=null,this.options=a.extend({},e.Defaults,c),this.$element=a(b),this._handlers={},this._plugins={},this._supress={},this._current=null,this._speed=null,this._coordinates=[],this._breakpoint=null,this._width=null,this._items=[],this._clones=[],this._mergers=[],this._widths=[],this._invalidated={},this._pipe=[],this._drag={time:null,target:null,pointer:null,stage:{start:null,current:null},direction:null},this._states={current:{},tags:{initializing:["busy"],animating:["busy"],dragging:["interacting"]}},a.each(["onResize","onThrottledResize"],a.proxy(function(b,c){this._handlers[c]=a.proxy(this[c],this)},this)),a.each(e.Plugins,a.proxy(function(a,b){this._plugins[a.charAt(0).toLowerCase()+a.slice(1)]=new b(this)},this)),a.each(e.Workers,a.proxy(function(b,c){this._pipe.push({filter:c.filter,run:a.proxy(c.run,this)})},this)),this.setup(),this.initialize()}e.Defaults={items:3,loop:!1,center:!1,rewind:!1,mouseDrag:!0,touchDrag:!0,pullDrag:!0,freeDrag:!1,margin:0,stagePadding:0,merge:!1,mergeFit:!0,autoWidth:!1,startPosition:0,rtl:!1,smartSpeed:250,fluidSpeed:!1,dragEndSpeed:!1,responsive:{},responsiveRefreshRate:200,responsiveBaseElement:b,fallbackEasing:"swing",info:!1,nestedItemSelector:!1,itemElement:"div",stageElement:"div",refreshClass:"owl-refresh",loadedClass:"owl-loaded",loadingClass:"owl-loading",rtlClass:"owl-rtl",responsiveClass:"owl-responsive",dragClass:"owl-drag",itemClass:"owl-item",stageClass:"owl-stage",stageOuterClass:"owl-stage-outer",grabClass:"owl-grab"},e.Width={Default:"default",Inner:"inner",Outer:"outer"},e.Type={Event:"event",State:"state"},e.Plugins={},e.Workers=[{filter:["width","settings"],run:function(){this._width=this.$element.width()}},{filter:["width","items","settings"],run:function(a){a.current=this._items&&this._items[this.relative(this._current)]}},{filter:["items","settings"],run:function(){this.$stage.children(".cloned").remove()}},{filter:["width","items","settings"],run:function(a){var b=this.settings.margin||"",c=!this.settings.autoWidth,d=this.settings.rtl,e={width:"auto","margin-left":d?b:"","margin-right":d?"":b};!c&&this.$stage.children().css(e),a.css=e}},{filter:["width","items","settings"],run:function(a){var b=(this.width()/this.settings.items).toFixed(3)-this.settings.margin,c=null,d=this._items.length,e=!this.settings.autoWidth,f=[];for(a.items={merge:!1,width:b};d--;)c=this._mergers[d],c=this.settings.mergeFit&&Math.min(c,this.settings.items)||c,a.items.merge=c>1||a.items.merge,f[d]=e?b*c:this._items[d].width();this._widths=f}},{filter:["items","settings"],run:function(){var b=[],c=this._items,d=this.settings,e=Math.max(2*d.items,4),f=2*Math.ceil(c.length/2),g=d.loop&&c.length?d.rewind?e:Math.max(e,f):0,h="",i="";for(g/=2;g>0;)b.push(this.normalize(b.length/2,!0)),h+=c[b[b.length-1]][0].outerHTML,b.push(this.normalize(c.length-1-(b.length-1)/2,!0)),i=c[b[b.length-1]][0].outerHTML+i,g-=1;this._clones=b,a(h).addClass("cloned").appendTo(this.$stage),a(i).addClass("cloned").prependTo(this.$stage)}},{filter:["width","items","settings"],run:function(){for(var a=this.settings.rtl?1:-1,b=this._clones.length+this._items.length,c=-1,d=0,e=0,f=[];++c<b;)d=f[c-1]||0,e=this._widths[this.relative(c)]+this.settings.margin,f.push(d+e*a);this._coordinates=f}},{filter:["width","items","settings"],run:function(){var a=this.settings.stagePadding,b=this._coordinates,c={width:Math.ceil(Math.abs(b[b.length-1]))+2*a,"padding-left":a||"","padding-right":a||""};this.$stage.css(c)}},{filter:["width","items","settings"],run:function(a){var b=this._coordinates.length,c=!this.settings.autoWidth,d=this.$stage.children();if(c&&a.items.merge)for(;b--;)a.css.width=this._widths[this.relative(b)],d.eq(b).css(a.css);else c&&(a.css.width=a.items.width,d.css(a.css))}},{filter:["items"],run:function(){this._coordinates.length<1&&this.$stage.removeAttr("style")}},{filter:["width","items","settings"],run:function(a){a.current=a.current?this.$stage.children().index(a.current):0,a.current=Math.max(this.minimum(),Math.min(this.maximum(),a.current)),this.reset(a.current)}},{filter:["position"],run:function(){this.animate(this.coordinates(this._current))}},{filter:["width","position","items","settings"],run:function(){var a,b,c,d,e=this.settings.rtl?1:-1,f=2*this.settings.stagePadding,g=this.coordinates(this.current())+f,h=g+this.width()*e,i=[];for(c=0,d=this._coordinates.length;c<d;c++)a=this._coordinates[c-1]||0,b=Math.abs(this._coordinates[c])+f*e,(this.op(a,"<=",g)&&this.op(a,">",h)||this.op(b,"<",g)&&this.op(b,">",h))&&i.push(c);this.$stage.children(".active").removeClass("active"),this.$stage.children(":eq("+i.join("), :eq(")+")").addClass("active"),this.$stage.children(".center").removeClass("center"),this.settings.center&&this.$stage.children().eq(this.current()).addClass("center")}}],e.prototype.initialize=function(){if(this.enter("initializing"),this.trigger("initialize"),this.$element.toggleClass(this.settings.rtlClass,this.settings.rtl),this.settings.autoWidth&&!this.is("pre-loading")){var b,c,e;b=this.$element.find("img"),c=this.settings.nestedItemSelector?"."+this.settings.nestedItemSelector:d,e=this.$element.children(c).width(),b.length&&e<=0&&this.preloadAutoWidthImages(b)}this.$element.addClass(this.options.loadingClass),this.$stage=a("<"+this.settings.stageElement+' class="'+this.settings.stageClass+'"/>').wrap('<div class="'+this.settings.stageOuterClass+'"/>'),this.$element.append(this.$stage.parent()),this.replace(this.$element.children().not(this.$stage.parent())),this.$element.is(":visible")?this.refresh():this.invalidate("width"),this.$element.removeClass(this.options.loadingClass).addClass(this.options.loadedClass),this.registerEventHandlers(),this.leave("initializing"),this.trigger("initialized")},e.prototype.setup=function(){var b=this.viewport(),c=this.options.responsive,d=-1,e=null;c?(a.each(c,function(a){a<=b&&a>d&&(d=Number(a))}),e=a.extend({},this.options,c[d]),"function"==typeof e.stagePadding&&(e.stagePadding=e.stagePadding()),delete e.responsive,e.responsiveClass&&this.$element.attr("class",this.$element.attr("class").replace(new RegExp("("+this.options.responsiveClass+"-)\\S+\\s","g"),"$1"+d))):e=a.extend({},this.options),this.trigger("change",{property:{name:"settings",value:e}}),this._breakpoint=d,this.settings=e,this.invalidate("settings"),this.trigger("changed",{property:{name:"settings",value:this.settings}})},e.prototype.optionsLogic=function(){this.settings.autoWidth&&(this.settings.stagePadding=!1,this.settings.merge=!1)},e.prototype.prepare=function(b){var c=this.trigger("prepare",{content:b});return c.data||(c.data=a("<"+this.settings.itemElement+"/>").addClass(this.options.itemClass).append(b)),this.trigger("prepared",{content:c.data}),c.data},e.prototype.update=function(){for(var b=0,c=this._pipe.length,d=a.proxy(function(a){return this[a]},this._invalidated),e={};b<c;)(this._invalidated.all||a.grep(this._pipe[b].filter,d).length>0)&&this._pipe[b].run(e),b++;this._invalidated={},!this.is("valid")&&this.enter("valid")},e.prototype.width=function(a){switch(a=a||e.Width.Default){case e.Width.Inner:case e.Width.Outer:return this._width;default:return this._width-2*this.settings.stagePadding+this.settings.margin}},e.prototype.refresh=function(){this.enter("refreshing"),this.trigger("refresh"),this.setup(),this.optionsLogic(),this.$element.addClass(this.options.refreshClass),this.update(),this.$element.removeClass(this.options.refreshClass),this.leave("refreshing"),this.trigger("refreshed")},e.prototype.onThrottledResize=function(){b.clearTimeout(this.resizeTimer),this.resizeTimer=b.setTimeout(this._handlers.onResize,this.settings.responsiveRefreshRate)},e.prototype.onResize=function(){return!!this._items.length&&(this._width!==this.$element.width()&&(!!this.$element.is(":visible")&&(this.enter("resizing"),this.trigger("resize").isDefaultPrevented()?(this.leave("resizing"),!1):(this.invalidate("width"),this.refresh(),this.leave("resizing"),void this.trigger("resized")))))},e.prototype.registerEventHandlers=function(){a.support.transition&&this.$stage.on(a.support.transition.end+".owl.core",a.proxy(this.onTransitionEnd,this)),!1!==this.settings.responsive&&this.on(b,"resize",this._handlers.onThrottledResize),this.settings.mouseDrag&&(this.$element.addClass(this.options.dragClass),this.$stage.on("mousedown.owl.core",a.proxy(this.onDragStart,this)),this.$stage.on("dragstart.owl.core selectstart.owl.core",function(){return!1})),this.settings.touchDrag&&(this.$stage.on("touchstart.owl.core",a.proxy(this.onDragStart,this)),this.$stage.on("touchcancel.owl.core",a.proxy(this.onDragEnd,this)))},e.prototype.onDragStart=function(b){var d=null;3!==b.which&&(a.support.transform?(d=this.$stage.css("transform").replace(/.*\(|\)| /g,"").split(","),d={x:d[16===d.length?12:4],y:d[16===d.length?13:5]}):(d=this.$stage.position(),d={x:this.settings.rtl?d.left+this.$stage.width()-this.width()+this.settings.margin:d.left,y:d.top}),this.is("animating")&&(a.support.transform?this.animate(d.x):this.$stage.stop(),this.invalidate("position")),this.$element.toggleClass(this.options.grabClass,"mousedown"===b.type),this.speed(0),this._drag.time=(new Date).getTime(),this._drag.target=a(b.target),this._drag.stage.start=d,this._drag.stage.current=d,this._drag.pointer=this.pointer(b),a(c).on("mouseup.owl.core touchend.owl.core",a.proxy(this.onDragEnd,this)),a(c).one("mousemove.owl.core touchmove.owl.core",a.proxy(function(b){var d=this.difference(this._drag.pointer,this.pointer(b));a(c).on("mousemove.owl.core touchmove.owl.core",a.proxy(this.onDragMove,this)),Math.abs(d.x)<Math.abs(d.y)&&this.is("valid")||(b.preventDefault(),this.enter("dragging"),this.trigger("drag"))},this)))},e.prototype.onDragMove=function(a){var b=null,c=null,d=null,e=this.difference(this._drag.pointer,this.pointer(a)),f=this.difference(this._drag.stage.start,e);this.is("dragging")&&(a.preventDefault(),this.settings.loop?(b=this.coordinates(this.minimum()),c=this.coordinates(this.maximum()+1)-b,f.x=((f.x-b)%c+c)%c+b):(b=this.settings.rtl?this.coordinates(this.maximum()):this.coordinates(this.minimum()),c=this.settings.rtl?this.coordinates(this.minimum()):this.coordinates(this.maximum()),d=this.settings.pullDrag?-1*e.x/5:0,f.x=Math.max(Math.min(f.x,b+d),c+d)),this._drag.stage.current=f,this.animate(f.x))},e.prototype.onDragEnd=function(b){var d=this.difference(this._drag.pointer,this.pointer(b)),e=this._drag.stage.current,f=d.x>0^this.settings.rtl?"left":"right";a(c).off(".owl.core"),this.$element.removeClass(this.options.grabClass),(0!==d.x&&this.is("dragging")||!this.is("valid"))&&(this.speed(this.settings.dragEndSpeed||this.settings.smartSpeed),this.current(this.closest(e.x,0!==d.x?f:this._drag.direction)),this.invalidate("position"),this.update(),this._drag.direction=f,(Math.abs(d.x)>3||(new Date).getTime()-this._drag.time>300)&&this._drag.target.one("click.owl.core",function(){return!1})),this.is("dragging")&&(this.leave("dragging"),this.trigger("dragged"))},e.prototype.closest=function(b,c){var d=-1,e=30,f=this.width(),g=this.coordinates();return this.settings.freeDrag||a.each(g,a.proxy(function(a,h){return"left"===c&&b>h-e&&b<h+e?d=a:"right"===c&&b>h-f-e&&b<h-f+e?d=a+1:this.op(b,"<",h)&&this.op(b,">",g[a+1]||h-f)&&(d="left"===c?a+1:a),-1===d},this)),this.settings.loop||(this.op(b,">",g[this.minimum()])?d=b=this.minimum():this.op(b,"<",g[this.maximum()])&&(d=b=this.maximum())),d},e.prototype.animate=function(b){var c=this.speed()>0;this.is("animating")&&this.onTransitionEnd(),c&&(this.enter("animating"),this.trigger("translate")),a.support.transform3d&&a.support.transition?this.$stage.css({transform:"translate3d("+b+"px,0px,0px)",transition:this.speed()/1e3+"s"}):c?this.$stage.animate({left:b+"px"},this.speed(),this.settings.fallbackEasing,a.proxy(this.onTransitionEnd,this)):this.$stage.css({left:b+"px"})},e.prototype.is=function(a){return this._states.current[a]&&this._states.current[a]>0},e.prototype.current=function(a){if(a===d)return this._current;if(0===this._items.length)return d;if(a=this.normalize(a),this._current!==a){var b=this.trigger("change",{property:{name:"position",value:a}});b.data!==d&&(a=this.normalize(b.data)),this._current=a,this.invalidate("position"),this.trigger("changed",{property:{name:"position",value:this._current}})}return this._current},e.prototype.invalidate=function(b){return"string"===a.type(b)&&(this._invalidated[b]=!0,this.is("valid")&&this.leave("valid")),a.map(this._invalidated,function(a,b){return b})},e.prototype.reset=function(a){(a=this.normalize(a))!==d&&(this._speed=0,this._current=a,this.suppress(["translate","translated"]),this.animate(this.coordinates(a)),this.release(["translate","translated"]))},e.prototype.normalize=function(a,b){var c=this._items.length,e=b?0:this._clones.length;return!this.isNumeric(a)||c<1?a=d:(a<0||a>=c+e)&&(a=((a-e/2)%c+c)%c+e/2),a},e.prototype.relative=function(a){return a-=this._clones.length/2,this.normalize(a,!0)},e.prototype.maximum=function(a){var b,c,d,e=this.settings,f=this._coordinates.length;if(e.loop)f=this._clones.length/2+this._items.length-1;else if(e.autoWidth||e.merge){if(b=this._items.length)for(c=this._items[--b].width(),d=this.$element.width();b--&&!((c+=this._items[b].width()+this.settings.margin)>d););f=b+1}else f=e.center?this._items.length-1:this._items.length-e.items;return a&&(f-=this._clones.length/2),Math.max(f,0)},e.prototype.minimum=function(a){return a?0:this._clones.length/2},e.prototype.items=function(a){return a===d?this._items.slice():(a=this.normalize(a,!0),this._items[a])},e.prototype.mergers=function(a){return a===d?this._mergers.slice():(a=this.normalize(a,!0),this._mergers[a])},e.prototype.clones=function(b){var c=this._clones.length/2,e=c+this._items.length,f=function(a){return a%2==0?e+a/2:c-(a+1)/2};return b===d?a.map(this._clones,function(a,b){return f(b)}):a.map(this._clones,function(a,c){return a===b?f(c):null})},e.prototype.speed=function(a){return a!==d&&(this._speed=a),this._speed},e.prototype.coordinates=function(b){var c,e=1,f=b-1;return b===d?a.map(this._coordinates,a.proxy(function(a,b){return this.coordinates(b)},this)):(this.settings.center?(this.settings.rtl&&(e=-1,f=b+1),c=this._coordinates[b],c+=(this.width()-c+(this._coordinates[f]||0))/2*e):c=this._coordinates[f]||0,c=Math.ceil(c))},e.prototype.duration=function(a,b,c){return 0===c?0:Math.min(Math.max(Math.abs(b-a),1),6)*Math.abs(c||this.settings.smartSpeed)},e.prototype.to=function(a,b){var c=this.current(),d=null,e=a-this.relative(c),f=(e>0)-(e<0),g=this._items.length,h=this.minimum(),i=this.maximum();this.settings.loop?(!this.settings.rewind&&Math.abs(e)>g/2&&(e+=-1*f*g),a=c+e,(d=((a-h)%g+g)%g+h)!==a&&d-e<=i&&d-e>0&&(c=d-e,a=d,this.reset(c))):this.settings.rewind?(i+=1,a=(a%i+i)%i):a=Math.max(h,Math.min(i,a)),this.speed(this.duration(c,a,b)),this.current(a),this.$element.is(":visible")&&this.update()},e.prototype.next=function(a){a=a||!1,this.to(this.relative(this.current())+1,a)},e.prototype.prev=function(a){a=a||!1,this.to(this.relative(this.current())-1,a)},e.prototype.onTransitionEnd=function(a){if(a!==d&&(a.stopPropagation(),(a.target||a.srcElement||a.originalTarget)!==this.$stage.get(0)))return!1;this.leave("animating"),this.trigger("translated")},e.prototype.viewport=function(){var d;return this.options.responsiveBaseElement!==b?d=a(this.options.responsiveBaseElement).width():b.innerWidth?d=b.innerWidth:c.documentElement&&c.documentElement.clientWidth?d=c.documentElement.clientWidth:console.warn("Can not detect viewport width."),d},e.prototype.replace=function(b){this.$stage.empty(),this._items=[],b&&(b=b instanceof jQuery?b:a(b)),this.settings.nestedItemSelector&&(b=b.find("."+this.settings.nestedItemSelector)),b.filter(function(){return 1===this.nodeType}).each(a.proxy(function(a,b){b=this.prepare(b),this.$stage.append(b),this._items.push(b),this._mergers.push(1*b.find("[data-merge]").addBack("[data-merge]").attr("data-merge")||1)},this)),this.reset(this.isNumeric(this.settings.startPosition)?this.settings.startPosition:0),this.invalidate("items")},e.prototype.add=function(b,c){var e=this.relative(this._current);c=c===d?this._items.length:this.normalize(c,!0),b=b instanceof jQuery?b:a(b),this.trigger("add",{content:b,position:c}),b=this.prepare(b),0===this._items.length||c===this._items.length?(0===this._items.length&&this.$stage.append(b),0!==this._items.length&&this._items[c-1].after(b),this._items.push(b),this._mergers.push(1*b.find("[data-merge]").addBack("[data-merge]").attr("data-merge")||1)):(this._items[c].before(b),this._items.splice(c,0,b),this._mergers.splice(c,0,1*b.find("[data-merge]").addBack("[data-merge]").attr("data-merge")||1)),this._items[e]&&this.reset(this._items[e].index()),this.invalidate("items"),this.trigger("added",{content:b,position:c})},e.prototype.remove=function(a){(a=this.normalize(a,!0))!==d&&(this.trigger("remove",{content:this._items[a],position:a}),this._items[a].remove(),this._items.splice(a,1),this._mergers.splice(a,1),this.invalidate("items"),this.trigger("removed",{content:null,position:a}))},e.prototype.preloadAutoWidthImages=function(b){b.each(a.proxy(function(b,c){this.enter("pre-loading"),c=a(c),a(new Image).one("load",a.proxy(function(a){c.attr("src",a.target.src),c.css("opacity",1),this.leave("pre-loading"),!this.is("pre-loading")&&!this.is("initializing")&&this.refresh()},this)).attr("src",c.attr("src")||c.attr("data-src")||c.attr("data-src-retina"))},this))},e.prototype.destroy=function(){this.$element.off(".owl.core"),this.$stage.off(".owl.core"),a(c).off(".owl.core"),!1!==this.settings.responsive&&(b.clearTimeout(this.resizeTimer),this.off(b,"resize",this._handlers.onThrottledResize));for(var d in this._plugins)this._plugins[d].destroy();this.$stage.children(".cloned").remove(),this.$stage.unwrap(),this.$stage.children().contents().unwrap(),this.$stage.children().unwrap(),this.$stage.remove(),this.$element.removeClass(this.options.refreshClass).removeClass(this.options.loadingClass).removeClass(this.options.loadedClass).removeClass(this.options.rtlClass).removeClass(this.options.dragClass).removeClass(this.options.grabClass).attr("class",this.$element.attr("class").replace(new RegExp(this.options.responsiveClass+"-\\S+\\s","g"),"")).removeData("owl.carousel")},e.prototype.op=function(a,b,c){var d=this.settings.rtl;switch(b){case"<":return d?a>c:a<c;case">":return d?a<c:a>c;case">=":return d?a<=c:a>=c;case"<=":return d?a>=c:a<=c}},e.prototype.on=function(a,b,c,d){a.addEventListener?a.addEventListener(b,c,d):a.attachEvent&&a.attachEvent("on"+b,c)},e.prototype.off=function(a,b,c,d){a.removeEventListener?a.removeEventListener(b,c,d):a.detachEvent&&a.detachEvent("on"+b,c)},e.prototype.trigger=function(b,c,d,f,g){var h={item:{count:this._items.length,index:this.current()}},i=a.camelCase(a.grep(["on",b,d],function(a){return a}).join("-").toLowerCase()),j=a.Event([b,"owl",d||"carousel"].join(".").toLowerCase(),a.extend({relatedTarget:this},h,c));return this._supress[b]||(a.each(this._plugins,function(a,b){b.onTrigger&&b.onTrigger(j)}),this.register({type:e.Type.Event,name:b}),this.$element.trigger(j),this.settings&&"function"==typeof this.settings[i]&&this.settings[i].call(this,j)),j},e.prototype.enter=function(b){a.each([b].concat(this._states.tags[b]||[]),a.proxy(function(a,b){this._states.current[b]===d&&(this._states.current[b]=0),this._states.current[b]++},this))},e.prototype.leave=function(b){a.each([b].concat(this._states.tags[b]||[]),a.proxy(function(a,b){this._states.current[b]--},this))},e.prototype.register=function(b){if(b.type===e.Type.Event){if(a.event.special[b.name]||(a.event.special[b.name]={}),!a.event.special[b.name].owl){var c=a.event.special[b.name]._default;a.event.special[b.name]._default=function(a){return!c||!c.apply||a.namespace&&-1!==a.namespace.indexOf("owl")?a.namespace&&a.namespace.indexOf("owl")>-1:c.apply(this,arguments)},a.event.special[b.name].owl=!0}}else b.type===e.Type.State&&(this._states.tags[b.name]?this._states.tags[b.name]=this._states.tags[b.name].concat(b.tags):this._states.tags[b.name]=b.tags,this._states.tags[b.name]=a.grep(this._states.tags[b.name],a.proxy(function(c,d){return a.inArray(c,this._states.tags[b.name])===d},this)))},e.prototype.suppress=function(b){a.each(b,a.proxy(function(a,b){this._supress[b]=!0},this))},e.prototype.release=function(b){a.each(b,a.proxy(function(a,b){delete this._supress[b]},this))},e.prototype.pointer=function(a){var c={x:null,y:null};return a=a.originalEvent||a||b.event,a=a.touches&&a.touches.length?a.touches[0]:a.changedTouches&&a.changedTouches.length?a.changedTouches[0]:a,a.pageX?(c.x=a.pageX,c.y=a.pageY):(c.x=a.clientX,c.y=a.clientY),c},e.prototype.isNumeric=function(a){return!isNaN(parseFloat(a))},e.prototype.difference=function(a,b){return{x:a.x-b.x,y:a.y-b.y}},a.fn.owlCarousel=function(b){var c=Array.prototype.slice.call(arguments,1);return this.each(function(){var d=a(this),f=d.data("owl.carousel");f||(f=new e(this,"object"==typeof b&&b),d.data("owl.carousel",f),a.each(["next","prev","to","destroy","refresh","replace","add","remove"],function(b,c){f.register({type:e.Type.Event,name:c}),f.$element.on(c+".owl.carousel.core",a.proxy(function(a){a.namespace&&a.relatedTarget!==this&&(this.suppress([c]),f[c].apply(this,[].slice.call(arguments,1)),this.release([c]))},f))})),"string"==typeof b&&"_"!==b.charAt(0)&&f[b].apply(f,c)})},a.fn.owlCarousel.Constructor=e}(window.Zepto||window.jQuery,window,document),function(a,b,c,d){var e=function(b){this._core=b,this._interval=null,this._visible=null,this._handlers={"initialized.owl.carousel":a.proxy(function(a){a.namespace&&this._core.settings.autoRefresh&&this.watch()},this)},this._core.options=a.extend({},e.Defaults,this._core.options),this._core.$element.on(this._handlers)};e.Defaults={autoRefresh:!0,autoRefreshInterval:500},e.prototype.watch=function(){this._interval||(this._visible=this._core.$element.is(":visible"),this._interval=b.setInterval(a.proxy(this.refresh,this),this._core.settings.autoRefreshInterval))},e.prototype.refresh=function(){this._core.$element.is(":visible")!==this._visible&&(this._visible=!this._visible,this._core.$element.toggleClass("owl-hidden",!this._visible),this._visible&&this._core.invalidate("width")&&this._core.refresh())},e.prototype.destroy=function(){var a,c;b.clearInterval(this._interval);for(a in this._handlers)this._core.$element.off(a,this._handlers[a]);for(c in Object.getOwnPropertyNames(this))"function"!=typeof this[c]&&(this[c]=null)},a.fn.owlCarousel.Constructor.Plugins.AutoRefresh=e}(window.Zepto||window.jQuery,window,document),function(a,b,c,d){var e=function(b){this._core=b,this._loaded=[],this._handlers={"initialized.owl.carousel change.owl.carousel resized.owl.carousel":a.proxy(function(b){if(b.namespace&&this._core.settings&&this._core.settings.lazyLoad&&(b.property&&"position"==b.property.name||"initialized"==b.type))for(var c=this._core.settings,e=c.center&&Math.ceil(c.items/2)||c.items,f=c.center&&-1*e||0,g=(b.property&&b.property.value!==d?b.property.value:this._core.current())+f,h=this._core.clones().length,i=a.proxy(function(a,b){this.load(b)},this);f++<e;)this.load(h/2+this._core.relative(g)),h&&a.each(this._core.clones(this._core.relative(g)),i),g++},this)},this._core.options=a.extend({},e.Defaults,this._core.options),this._core.$element.on(this._handlers)};e.Defaults={lazyLoad:!1},e.prototype.load=function(c){var d=this._core.$stage.children().eq(c),e=d&&d.find(".owl-lazy");!e||a.inArray(d.get(0),this._loaded)>-1||(e.each(a.proxy(function(c,d){var e,f=a(d),g=b.devicePixelRatio>1&&f.attr("data-src-retina")||f.attr("data-src");this._core.trigger("load",{element:f,url:g},"lazy"),f.is("img")?f.one("load.owl.lazy",a.proxy(function(){f.css("opacity",1),this._core.trigger("loaded",{element:f,url:g},"lazy")},this)).attr("src",g):(e=new Image,e.onload=a.proxy(function(){f.css({"background-image":'url("'+g+'")',opacity:"1"}),this._core.trigger("loaded",{element:f,url:g},"lazy")},this),e.src=g)},this)),this._loaded.push(d.get(0)))},e.prototype.destroy=function(){var a,b;for(a in this.handlers)this._core.$element.off(a,this.handlers[a]);for(b in Object.getOwnPropertyNames(this))"function"!=typeof this[b]&&(this[b]=null)},a.fn.owlCarousel.Constructor.Plugins.Lazy=e}(window.Zepto||window.jQuery,window,document),function(a,b,c,d){var e=function(b){this._core=b,this._handlers={"initialized.owl.carousel refreshed.owl.carousel":a.proxy(function(a){a.namespace&&this._core.settings.autoHeight&&this.update()},this),"changed.owl.carousel":a.proxy(function(a){a.namespace&&this._core.settings.autoHeight&&"position"==a.property.name&&this.update()},this),"loaded.owl.lazy":a.proxy(function(a){a.namespace&&this._core.settings.autoHeight&&a.element.closest("."+this._core.settings.itemClass).index()===this._core.current()&&this.update()},this)},this._core.options=a.extend({},e.Defaults,this._core.options),this._core.$element.on(this._handlers)};e.Defaults={autoHeight:!1,autoHeightClass:"owl-height"},e.prototype.update=function(){var b=this._core._current,c=b+this._core.settings.items,d=this._core.$stage.children().toArray().slice(b,c),e=[],f=0;a.each(d,function(b,c){e.push(a(c).height())}),f=Math.max.apply(null,e),this._core.$stage.parent().height(f).addClass(this._core.settings.autoHeightClass)},e.prototype.destroy=function(){var a,b;for(a in this._handlers)this._core.$element.off(a,this._handlers[a]);for(b in Object.getOwnPropertyNames(this))"function"!=typeof this[b]&&(this[b]=null)},a.fn.owlCarousel.Constructor.Plugins.AutoHeight=e}(window.Zepto||window.jQuery,window,document),function(a,b,c,d){var e=function(b){this._core=b,this._videos={},this._playing=null,this._handlers={"initialized.owl.carousel":a.proxy(function(a){a.namespace&&this._core.register({type:"state",name:"playing",tags:["interacting"]})},this),"resize.owl.carousel":a.proxy(function(a){a.namespace&&this._core.settings.video&&this.isInFullScreen()&&a.preventDefault()},this),"refreshed.owl.carousel":a.proxy(function(a){a.namespace&&this._core.is("resizing")&&this._core.$stage.find(".cloned .owl-video-frame").remove()},this),"changed.owl.carousel":a.proxy(function(a){a.namespace&&"position"===a.property.name&&this._playing&&this.stop()},this),"prepared.owl.carousel":a.proxy(function(b){if(b.namespace){var c=a(b.content).find(".owl-video");c.length&&(c.css("display","none"),this.fetch(c,a(b.content)))}},this)},this._core.options=a.extend({},e.Defaults,this._core.options),this._core.$element.on(this._handlers),this._core.$element.on("click.owl.video",".owl-video-play-icon",a.proxy(function(a){this.play(a)},this))};e.Defaults={video:!1,videoHeight:!1,videoWidth:!1},e.prototype.fetch=function(a,b){var c=function(){return a.attr("data-vimeo-id")?"vimeo":a.attr("data-vzaar-id")?"vzaar":"youtube"}(),d=a.attr("data-vimeo-id")||a.attr("data-youtube-id")||a.attr("data-vzaar-id"),e=a.attr("data-width")||this._core.settings.videoWidth,f=a.attr("data-height")||this._core.settings.videoHeight,g=a.attr("href");if(!g)throw new Error("Missing video URL.");if(d=g.match(/(http:|https:|)\/\/(player.|www.|app.)?(vimeo\.com|youtu(be\.com|\.be|be\.googleapis\.com)|vzaar\.com)\/(video\/|videos\/|embed\/|channels\/.+\/|groups\/.+\/|watch\?v=|v\/)?([A-Za-z0-9._%-]*)(\&\S+)?/),d[3].indexOf("youtu")>-1)c="youtube";else if(d[3].indexOf("vimeo")>-1)c="vimeo";else{if(!(d[3].indexOf("vzaar")>-1))throw new Error("Video URL not supported.");c="vzaar"}d=d[6],this._videos[g]={type:c,id:d,width:e,height:f},b.attr("data-video",g),this.thumbnail(a,this._videos[g])},e.prototype.thumbnail=function(b,c){var d,e,f,g=c.width&&c.height?'style="width:'+c.width+"px;height:"+c.height+'px;"':"",h=b.find("img"),i="src",j="",k=this._core.settings,l=function(a){e='<div class="owl-video-play-icon"></div>',d=k.lazyLoad?'<div class="owl-video-tn '+j+'" '+i+'="'+a+'"></div>':'<div class="owl-video-tn" style="opacity:1;background-image:url('+a+')"></div>',b.after(d),b.after(e)};if(b.wrap('<div class="owl-video-wrapper"'+g+"></div>"),this._core.settings.lazyLoad&&(i="data-src",j="owl-lazy"),h.length)return l(h.attr(i)),h.remove(),!1;"youtube"===c.type?(f="//img.youtube.com/vi/"+c.id+"/hqdefault.jpg",l(f)):"vimeo"===c.type?a.ajax({type:"GET",url:"//vimeo.com/api/v2/video/"+c.id+".json",jsonp:"callback",dataType:"jsonp",success:function(a){f=a[0].thumbnail_large,l(f)}}):"vzaar"===c.type&&a.ajax({type:"GET",url:"//vzaar.com/api/videos/"+c.id+".json",jsonp:"callback",dataType:"jsonp",success:function(a){f=a.framegrab_url,l(f)}})},e.prototype.stop=function(){this._core.trigger("stop",null,"video"),this._playing.find(".owl-video-frame").remove(),this._playing.removeClass("owl-video-playing"),this._playing=null,this._core.leave("playing"),this._core.trigger("stopped",null,"video")},e.prototype.play=function(b){var c,d=a(b.target),e=d.closest("."+this._core.settings.itemClass),f=this._videos[e.attr("data-video")],g=f.width||"100%",h=f.height||this._core.$stage.height();this._playing||(this._core.enter("playing"),this._core.trigger("play",null,"video"),e=this._core.items(this._core.relative(e.index())),this._core.reset(e.index()),"youtube"===f.type?c='<iframe width="'+g+'" height="'+h+'" src="//www.youtube.com/embed/'+f.id+"?autoplay=1&rel=0&v="+f.id+'" frameborder="0" allowfullscreen></iframe>':"vimeo"===f.type?c='<iframe src="//player.vimeo.com/video/'+f.id+'?autoplay=1" width="'+g+'" height="'+h+'" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>':"vzaar"===f.type&&(c='<iframe frameborder="0"height="'+h+'"width="'+g+'" allowfullscreen mozallowfullscreen webkitAllowFullScreen src="//view.vzaar.com/'+f.id+'/player?autoplay=true"></iframe>'),a('<div class="owl-video-frame">'+c+"</div>").insertAfter(e.find(".owl-video")),this._playing=e.addClass("owl-video-playing"))},e.prototype.isInFullScreen=function(){var b=c.fullscreenElement||c.mozFullScreenElement||c.webkitFullscreenElement;return b&&a(b).parent().hasClass("owl-video-frame")},e.prototype.destroy=function(){var a,b;this._core.$element.off("click.owl.video");for(a in this._handlers)this._core.$element.off(a,this._handlers[a]);for(b in Object.getOwnPropertyNames(this))"function"!=typeof this[b]&&(this[b]=null)},a.fn.owlCarousel.Constructor.Plugins.Video=e}(window.Zepto||window.jQuery,window,document),function(a,b,c,d){var e=function(b){this.core=b,this.core.options=a.extend({},e.Defaults,this.core.options),this.swapping=!0,this.previous=d,this.next=d,this.handlers={"change.owl.carousel":a.proxy(function(a){a.namespace&&"position"==a.property.name&&(this.previous=this.core.current(),this.next=a.property.value)},this),"drag.owl.carousel dragged.owl.carousel translated.owl.carousel":a.proxy(function(a){a.namespace&&(this.swapping="translated"==a.type)},this),"translate.owl.carousel":a.proxy(function(a){a.namespace&&this.swapping&&(this.core.options.animateOut||this.core.options.animateIn)&&this.swap()},this)},this.core.$element.on(this.handlers)};e.Defaults={animateOut:!1,animateIn:!1},e.prototype.swap=function(){if(1===this.core.settings.items&&a.support.animation&&a.support.transition){this.core.speed(0);var b,c=a.proxy(this.clear,this),d=this.core.$stage.children().eq(this.previous),e=this.core.$stage.children().eq(this.next),f=this.core.settings.animateIn,g=this.core.settings.animateOut;this.core.current()!==this.previous&&(g&&(b=this.core.coordinates(this.previous)-this.core.coordinates(this.next),d.one(a.support.animation.end,c).css({left:b+"px"}).addClass("animated owl-animated-out").addClass(g)),f&&e.one(a.support.animation.end,c).addClass("animated owl-animated-in").addClass(f))}},e.prototype.clear=function(b){a(b.target).css({left:""}).removeClass("animated owl-animated-out owl-animated-in").removeClass(this.core.settings.animateIn).removeClass(this.core.settings.animateOut),this.core.onTransitionEnd()},e.prototype.destroy=function(){var a,b;for(a in this.handlers)this.core.$element.off(a,this.handlers[a])
;for(b in Object.getOwnPropertyNames(this))"function"!=typeof this[b]&&(this[b]=null)},a.fn.owlCarousel.Constructor.Plugins.Animate=e}(window.Zepto||window.jQuery,window,document),function(a,b,c,d){var e=function(b){this._core=b,this._call=null,this._time=0,this._timeout=0,this._paused=!0,this._handlers={"changed.owl.carousel":a.proxy(function(a){a.namespace&&"settings"===a.property.name?this._core.settings.autoplay?this.play():this.stop():a.namespace&&"position"===a.property.name&&this._paused&&(this._time=0)},this),"initialized.owl.carousel":a.proxy(function(a){a.namespace&&this._core.settings.autoplay&&this.play()},this),"play.owl.autoplay":a.proxy(function(a,b,c){a.namespace&&this.play(b,c)},this),"stop.owl.autoplay":a.proxy(function(a){a.namespace&&this.stop()},this),"mouseover.owl.autoplay":a.proxy(function(){this._core.settings.autoplayHoverPause&&this._core.is("rotating")&&this.pause()},this),"mouseleave.owl.autoplay":a.proxy(function(){this._core.settings.autoplayHoverPause&&this._core.is("rotating")&&this.play()},this),"touchstart.owl.core":a.proxy(function(){this._core.settings.autoplayHoverPause&&this._core.is("rotating")&&this.pause()},this),"touchend.owl.core":a.proxy(function(){this._core.settings.autoplayHoverPause&&this.play()},this)},this._core.$element.on(this._handlers),this._core.options=a.extend({},e.Defaults,this._core.options)};e.Defaults={autoplay:!1,autoplayTimeout:5e3,autoplayHoverPause:!1,autoplaySpeed:!1},e.prototype._next=function(d){this._call=b.setTimeout(a.proxy(this._next,this,d),this._timeout*(Math.round(this.read()/this._timeout)+1)-this.read()),this._core.is("busy")||this._core.is("interacting")||c.hidden||this._core.next(d||this._core.settings.autoplaySpeed)},e.prototype.read=function(){return(new Date).getTime()-this._time},e.prototype.play=function(c,d){var e;this._core.is("rotating")||this._core.enter("rotating"),c=c||this._core.settings.autoplayTimeout,e=Math.min(this._time%(this._timeout||c),c),this._paused?(this._time=this.read(),this._paused=!1):b.clearTimeout(this._call),this._time+=this.read()%c-e,this._timeout=c,this._call=b.setTimeout(a.proxy(this._next,this,d),c-e)},e.prototype.stop=function(){this._core.is("rotating")&&(this._time=0,this._paused=!0,b.clearTimeout(this._call),this._core.leave("rotating"))},e.prototype.pause=function(){this._core.is("rotating")&&!this._paused&&(this._time=this.read(),this._paused=!0,b.clearTimeout(this._call))},e.prototype.destroy=function(){var a,b;this.stop();for(a in this._handlers)this._core.$element.off(a,this._handlers[a]);for(b in Object.getOwnPropertyNames(this))"function"!=typeof this[b]&&(this[b]=null)},a.fn.owlCarousel.Constructor.Plugins.autoplay=e}(window.Zepto||window.jQuery,window,document),function(a,b,c,d){"use strict";var e=function(b){this._core=b,this._initialized=!1,this._pages=[],this._controls={},this._templates=[],this.$element=this._core.$element,this._overrides={next:this._core.next,prev:this._core.prev,to:this._core.to},this._handlers={"prepared.owl.carousel":a.proxy(function(b){b.namespace&&this._core.settings.dotsData&&this._templates.push('<div class="'+this._core.settings.dotClass+'">'+a(b.content).find("[data-dot]").addBack("[data-dot]").attr("data-dot")+"</div>")},this),"added.owl.carousel":a.proxy(function(a){a.namespace&&this._core.settings.dotsData&&this._templates.splice(a.position,0,this._templates.pop())},this),"remove.owl.carousel":a.proxy(function(a){a.namespace&&this._core.settings.dotsData&&this._templates.splice(a.position,1)},this),"changed.owl.carousel":a.proxy(function(a){a.namespace&&"position"==a.property.name&&this.draw()},this),"initialized.owl.carousel":a.proxy(function(a){a.namespace&&!this._initialized&&(this._core.trigger("initialize",null,"navigation"),this.initialize(),this.update(),this.draw(),this._initialized=!0,this._core.trigger("initialized",null,"navigation"))},this),"refreshed.owl.carousel":a.proxy(function(a){a.namespace&&this._initialized&&(this._core.trigger("refresh",null,"navigation"),this.update(),this.draw(),this._core.trigger("refreshed",null,"navigation"))},this)},this._core.options=a.extend({},e.Defaults,this._core.options),this.$element.on(this._handlers)};e.Defaults={nav:!1,navText:['<span aria-label="prev">&#x2039;</span>','<span aria-label="next">&#x203a;</span>'],navSpeed:!1,navElement:'button role="presentation"',navContainer:!1,navContainerClass:"owl-nav",navClass:["owl-prev","owl-next"],slideBy:1,dotClass:"owl-dot",dotsClass:"owl-dots",dots:!0,dotsEach:!1,dotsData:!1,dotsSpeed:!1,dotsContainer:!1},e.prototype.initialize=function(){var b,c=this._core.settings;this._controls.$relative=(c.navContainer?a(c.navContainer):a("<div>").addClass(c.navContainerClass).appendTo(this.$element)).addClass("disabled"),this._controls.$previous=a("<"+c.navElement+">").addClass(c.navClass[0]).html(c.navText[0]).prependTo(this._controls.$relative).on("click",a.proxy(function(a){this.prev(c.navSpeed)},this)),this._controls.$next=a("<"+c.navElement+">").addClass(c.navClass[1]).html(c.navText[1]).appendTo(this._controls.$relative).on("click",a.proxy(function(a){this.next(c.navSpeed)},this)),c.dotsData||(this._templates=[a("<button>").addClass(c.dotClass).append(a("<span>")).prop("outerHTML")]),this._controls.$absolute=(c.dotsContainer?a(c.dotsContainer):a("<div>").addClass(c.dotsClass).appendTo(this.$element)).addClass("disabled"),this._controls.$absolute.on("click","button",a.proxy(function(b){var d=a(b.target).parent().is(this._controls.$absolute)?a(b.target).index():a(b.target).parent().index();b.preventDefault(),this.to(d,c.dotsSpeed)},this));for(b in this._overrides)this._core[b]=a.proxy(this[b],this)},e.prototype.destroy=function(){var a,b,c,d,e;e=this._core.settings;for(a in this._handlers)this.$element.off(a,this._handlers[a]);for(b in this._controls)"$relative"===b&&e.navContainer?this._controls[b].html(""):this._controls[b].remove();for(d in this.overides)this._core[d]=this._overrides[d];for(c in Object.getOwnPropertyNames(this))"function"!=typeof this[c]&&(this[c]=null)},e.prototype.update=function(){var a,b,c,d=this._core.clones().length/2,e=d+this._core.items().length,f=this._core.maximum(!0),g=this._core.settings,h=g.center||g.autoWidth||g.dotsData?1:g.dotsEach||g.items;if("page"!==g.slideBy&&(g.slideBy=Math.min(g.slideBy,g.items)),g.dots||"page"==g.slideBy)for(this._pages=[],a=d,b=0,c=0;a<e;a++){if(b>=h||0===b){if(this._pages.push({start:Math.min(f,a-d),end:a-d+h-1}),Math.min(f,a-d)===f)break;b=0,++c}b+=this._core.mergers(this._core.relative(a))}},e.prototype.draw=function(){var b,c=this._core.settings,d=this._core.items().length<=c.items,e=this._core.relative(this._core.current()),f=c.loop||c.rewind;this._controls.$relative.toggleClass("disabled",!c.nav||d),c.nav&&(this._controls.$previous.toggleClass("disabled",!f&&e<=this._core.minimum(!0)),this._controls.$next.toggleClass("disabled",!f&&e>=this._core.maximum(!0))),this._controls.$absolute.toggleClass("disabled",!c.dots||d),c.dots&&(b=this._pages.length-this._controls.$absolute.children().length,c.dotsData&&0!==b?this._controls.$absolute.html(this._templates.join("")):b>0?this._controls.$absolute.append(new Array(b+1).join(this._templates[0])):b<0&&this._controls.$absolute.children().slice(b).remove(),this._controls.$absolute.find(".active").removeClass("active"),this._controls.$absolute.children().eq(a.inArray(this.current(),this._pages)).addClass("active"))},e.prototype.onTrigger=function(b){var c=this._core.settings;b.page={index:a.inArray(this.current(),this._pages),count:this._pages.length,size:c&&(c.center||c.autoWidth||c.dotsData?1:c.dotsEach||c.items)}},e.prototype.current=function(){var b=this._core.relative(this._core.current());return a.grep(this._pages,a.proxy(function(a,c){return a.start<=b&&a.end>=b},this)).pop()},e.prototype.getPosition=function(b){var c,d,e=this._core.settings;return"page"==e.slideBy?(c=a.inArray(this.current(),this._pages),d=this._pages.length,b?++c:--c,c=this._pages[(c%d+d)%d].start):(c=this._core.relative(this._core.current()),d=this._core.items().length,b?c+=e.slideBy:c-=e.slideBy),c},e.prototype.next=function(b){a.proxy(this._overrides.to,this._core)(this.getPosition(!0),b)},e.prototype.prev=function(b){a.proxy(this._overrides.to,this._core)(this.getPosition(!1),b)},e.prototype.to=function(b,c,d){var e;!d&&this._pages.length?(e=this._pages.length,a.proxy(this._overrides.to,this._core)(this._pages[(b%e+e)%e].start,c)):a.proxy(this._overrides.to,this._core)(b,c)},a.fn.owlCarousel.Constructor.Plugins.Navigation=e}(window.Zepto||window.jQuery,window,document),function(a,b,c,d){"use strict";var e=function(c){this._core=c,this._hashes={},this.$element=this._core.$element,this._handlers={"initialized.owl.carousel":a.proxy(function(c){c.namespace&&"URLHash"===this._core.settings.startPosition&&a(b).trigger("hashchange.owl.navigation")},this),"prepared.owl.carousel":a.proxy(function(b){if(b.namespace){var c=a(b.content).find("[data-hash]").addBack("[data-hash]").attr("data-hash");if(!c)return;this._hashes[c]=b.content}},this),"changed.owl.carousel":a.proxy(function(c){if(c.namespace&&"position"===c.property.name){var d=this._core.items(this._core.relative(this._core.current())),e=a.map(this._hashes,function(a,b){return a===d?b:null}).join();if(!e||b.location.hash.slice(1)===e)return;b.location.hash=e}},this)},this._core.options=a.extend({},e.Defaults,this._core.options),this.$element.on(this._handlers),a(b).on("hashchange.owl.navigation",a.proxy(function(a){var c=b.location.hash.substring(1),e=this._core.$stage.children(),f=this._hashes[c]&&e.index(this._hashes[c]);f!==d&&f!==this._core.current()&&this._core.to(this._core.relative(f),!1,!0)},this))};e.Defaults={URLhashListener:!1},e.prototype.destroy=function(){var c,d;a(b).off("hashchange.owl.navigation");for(c in this._handlers)this._core.$element.off(c,this._handlers[c]);for(d in Object.getOwnPropertyNames(this))"function"!=typeof this[d]&&(this[d]=null)},a.fn.owlCarousel.Constructor.Plugins.Hash=e}(window.Zepto||window.jQuery,window,document),function(a,b,c,d){function e(b,c){var e=!1,f=b.charAt(0).toUpperCase()+b.slice(1);return a.each((b+" "+h.join(f+" ")+f).split(" "),function(a,b){if(g[b]!==d)return e=!c||b,!1}),e}function f(a){return e(a,!0)}var g=a("<support>").get(0).style,h="Webkit Moz O ms".split(" "),i={transition:{end:{WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",transition:"transitionend"}},animation:{end:{WebkitAnimation:"webkitAnimationEnd",MozAnimation:"animationend",OAnimation:"oAnimationEnd",animation:"animationend"}}},j={csstransforms:function(){return!!e("transform")},csstransforms3d:function(){return!!e("perspective")},csstransitions:function(){return!!e("transition")},cssanimations:function(){return!!e("animation")}};j.csstransitions()&&(a.support.transition=a.support.transition||{},a.support.transition.end||(a.support.transition.end=i.transition.end[new String(f("transition"))])),j.cssanimations()&&(a.support.animation=a.support.animation||{},a.support.animation.end||(a.support.animation.end=i.animation.end[new String(f("animation"))])),j.csstransforms()&&(a.support.transform3d=j.csstransforms3d())}(window.Zepto||window.jQuery,window,document);
/**
* @license Input Mask plugin for jquery
* http://github.com/RobinHerbots/jquery.inputmask
* Copyright (c) 2010 - 2012 Robin Herbots
* Licensed under the MIT license (http://www.opensource.org/licenses/mit-license.php)
* Version: 1.2.4
*/

(function ($) {
    if ($.fn.inputmask == undefined) {
        $.inputmask = {
            //options default
            defaults: {
                placeholder: "_",
                optionalmarker: {
                    start: "[",
                    end: "]"
                },
                escapeChar: "\\",
                mask: null,
                oncomplete: $.noop, //executes when the mask is complete
                onincomplete: $.noop, //executes when the mask is incomplete and focus is lost
                oncleared: $.noop, //executes when the mask is cleared
                overrideFocus: false, // override the default behavior for the focus event. Allows better interactions with native HTML placeholders
                repeat: 0, //repetitions of the mask
                greedy: true, //true: allocated buffer for the mask and repetitions - false: allocate only if needed
                autoUnmask: false, //automatically unmask when retrieving the value with $.fn.val or value if the browser supports __lookupGetter__ or getOwnPropertyDescriptor
                clearMaskOnLostFocus: true,
                insertMode: true, //insert the input or overwrite the input
                clearIncomplete: false, //clear the incomplete input on blur
                aliases: {}, //aliases definitions => see jquery.inputmask.extensions.js
                onKeyUp: $.noop, //override to implement autocomplete on certain keys for example
                onKeyDown: $.noop, //override to implement autocomplete on certain keys for example
                showMaskOnHover: true, //show the mask-placeholder when hovering the empty input
                onKeyValidation: $.noop, //executes on every key-press with the result of isValid
                //numeric basic properties
                numericInput: false, //numericInput input direction style (input shifts to the left while holding the caret position)
                radixPoint: ".", // | ","
                //numeric basic properties
                definitions: {
                    '9': {
                        validator: "[0-9]",
                        cardinality: 1
                    },
                    'a': {
                        validator: "[A-Za-z\u0410-\u044F\u0401\u0451]",
                        cardinality: 1
                    },
                    '*': {
                        validator: "[A-Za-z\u0410-\u044F\u0401\u04510-9]",
                        cardinality: 1
                    }
                },
                keyCode: { ALT: 18, BACKSPACE: 8, CAPS_LOCK: 20, COMMA: 188, COMMAND: 91, COMMAND_LEFT: 91, COMMAND_RIGHT: 93, CONTROL: 17, DELETE: 46, DOWN: 40, END: 35, ENTER: 13, ESCAPE: 27, HOME: 36, INSERT: 45, LEFT: 37, MENU: 93, NUMPAD_ADD: 107, NUMPAD_DECIMAL: 110, NUMPAD_DIVIDE: 111, NUMPAD_ENTER: 108,
                    NUMPAD_MULTIPLY: 106, NUMPAD_SUBTRACT: 109, PAGE_DOWN: 34, PAGE_UP: 33, PERIOD: 190, RIGHT: 39, SHIFT: 16, SPACE: 32, TAB: 9, UP: 38, WINDOWS: 91
                },
                ignorables: [8, 9, 13, 16, 17, 18, 20, 27, 33, 34, 35, 36, 37, 38, 39, 40, 46, 91, 93, 108]
            },
            val: $.fn.val //store the original jquery val function
        };

        $.fn.inputmask = function (fn, options) {
            var opts = $.extend(true, {}, $.inputmask.defaults, options);
            var pasteEvent = isInputEventSupported('paste') ? 'paste' : 'input';

            var iphone = navigator.userAgent.match(/iphone/i) != null;
            var android = navigator.userAgent.match(/android.*mobile safari.*/i) != null;
            if (android) {
                var browser = navigator.userAgent.match(/mobile safari.*/i);
                var version = parseInt(new RegExp(/[0-9]+/).exec(browser));
                android = version <= 533;
            }
            var caretposCorrection = null;

            if (typeof fn == "string") {
                switch (fn) {
                    case "mask":
                        //init buffer
                        var _buffer = getMaskTemplate();
                        var tests = getTestingChain();

                        return this.each(function () {
                            mask(this);
                        });
                        break;
                    case "unmaskedvalue":
                        var tests = this.data('inputmask')['tests'];
                        var _buffer = this.data('inputmask')['_buffer'];
                        opts.greedy = this.data('inputmask')['greedy'];
                        opts.repeat = this.data('inputmask')['repeat'];
                        opts.definitions = this.data('inputmask')['definitions'];
                        return unmaskedvalue(this);
                        break;
                    case "remove":
                        var tests, _buffer;
                        return this.each(function () {
                            var $input = $(this), input = this;
                            setTimeout(function () {
                                if ($input.data('inputmask')) {
                                    tests = $input.data('inputmask')['tests'];
                                    _buffer = $input.data('inputmask')['_buffer'];
                                    opts.greedy = $input.data('inputmask')['greedy'];
                                    opts.repeat = $input.data('inputmask')['repeat'];
                                    opts.definitions = $input.data('inputmask')['definitions'];
                                    //writeout the unmaskedvalue
                                    input._valueSet(unmaskedvalue($input, true));
                                    //clear data
                                    $input.removeData('inputmask');
                                    //unbind all events
                                    $input.unbind(".inputmask");
                                    $input.removeClass('focus.inputmask');
                                    //restore the value property
                                    var valueProperty;
                                    if (Object.getOwnPropertyDescriptor)
                                        valueProperty = Object.getOwnPropertyDescriptor(input, "value");
                                    if (valueProperty && valueProperty.get) {
                                        if (input._valueGet) {
                                            Object.defineProperty(input, "value", {
                                                get: input._valueGet,
                                                set: input._valueSet
                                            });
                                        }
                                    } else if (document.__lookupGetter__ && input.__lookupGetter__("value")) {
                                        if (input._valueGet) {
                                            input.__defineGetter__("value", input._valueGet);
                                            input.__defineSetter__("value", input._valueSet);
                                        }
                                    }
                                    delete input._valueGet;
                                    delete input._valueSet;
                                }
                            }, 0);
                        });
                        break;
                    case "getemptymask": //return the default (empty) mask value, usefull for setting the default value in validation
                        if (this.data('inputmask'))
                            return this.data('inputmask')['_buffer'].join('');
                        else return "";
                    case "hasMaskedValue": //check wheter the returned value is masked or not; currently only works reliable when using jquery.val fn to retrieve the value
                        return this.data('inputmask') ? !this.data('inputmask')['autoUnmask'] : false;
                    default:
                        //check if the fn is an alias
                        if (!resolveAlias(fn)) {
                            //maybe fn is a mask so we try
                            //set mask
                            opts.mask = fn;
                        }
                        //init buffer
                        var _buffer = getMaskTemplate();
                        var tests = getTestingChain();

                        return this.each(function () {
                            mask(this);
                        });

                        break;
                }
            } if (typeof fn == "object") {
                opts = $.extend(true, {}, $.inputmask.defaults, fn);
                resolveAlias(opts.alias); //resolve aliases
                //init buffer
                var _buffer = getMaskTemplate();
                var tests = getTestingChain();

                return this.each(function () {
                    mask(this);
                });
            }

            //helper     functions
            function isInputEventSupported(eventName) {
                var el = document.createElement('input'),
                eventName = 'on' + eventName,
                isSupported = (eventName in el);
                if (!isSupported) {
                    el.setAttribute(eventName, 'return;');
                    isSupported = typeof el[eventName] == 'function';
                }
                el = null;
                return isSupported;
            }

            function resolveAlias(aliasStr) {
                var aliasDefinition = opts.aliases[aliasStr];
                if (aliasDefinition) {
                    if (aliasDefinition.alias) resolveAlias(aliasDefinition.alias); //alias is another alias
                    $.extend(true, opts, aliasDefinition);  //merge alias definition in the options
                    $.extend(true, opts, options);  //reapply extra given options
                    return true;
                }
                return false;
            }

            function getMaskTemplate() {
                var escaped = false, outCount = 0;
                if (opts.mask.length == 1 && opts.greedy == false) { opts.placeholder = ""; } //hide placeholder with single non-greedy mask
                var singleMask = $.map(opts.mask.split(""), function (element, index) {
                    var outElem = [];
                    if (element == opts.escapeChar) {
                        escaped = true;
                    }
                    else if ((element != opts.optionalmarker.start && element != opts.optionalmarker.end) || escaped) {
                        var maskdef = opts.definitions[element];
                        if (maskdef && !escaped) {
                            for (var i = 0; i < maskdef.cardinality; i++) {
                                outElem.push(getPlaceHolder(outCount + i));
                            }
                        } else {
                            outElem.push(element);
                            escaped = false;
                        }
                        outCount += outElem.length;
                        return outElem;
                    }
                });

                //allocate repetitions
                var repeatedMask = singleMask.slice();
                for (var i = 1; i < opts.repeat && opts.greedy; i++) {
                    repeatedMask = repeatedMask.concat(singleMask.slice());
                }

                return repeatedMask;
            }

            //test definition => {fn: RegExp/function, cardinality: int, optionality: bool, newBlockMarker: bool, offset: int, casing: null/upper/lower, def: definitionSymbol}
            function getTestingChain() {
                var isOptional = false, escaped = false;
                var newBlockMarker = false; //indicates wheter the begin/ending of a block should be indicated

                return $.map(opts.mask.split(""), function (element, index) {
                    var outElem = [];

                    if (element == opts.escapeChar) {
                        escaped = true;
                    } else if (element == opts.optionalmarker.start && !escaped) {
                        isOptional = true;
                        newBlockMarker = true;
                    }
                    else if (element == opts.optionalmarker.end && !escaped) {
                        isOptional = false;
                        newBlockMarker = true;
                    }
                    else {
                        var maskdef = opts.definitions[element];
                        if (maskdef && !escaped) {
                            var prevalidators = maskdef["prevalidator"], prevalidatorsL = prevalidators ? prevalidators.length : 0;
                            for (var i = 1; i < maskdef.cardinality; i++) {
                                var prevalidator = prevalidatorsL >= i ? prevalidators[i - 1] : [], validator = prevalidator["validator"], cardinality = prevalidator["cardinality"];
                                outElem.push({ fn: validator ? typeof validator == 'string' ? new RegExp(validator) : new function () { this.test = validator; } : new RegExp("."), cardinality: cardinality ? cardinality : 1, optionality: isOptional, newBlockMarker: isOptional == true ? newBlockMarker : false, offset: 0, casing: maskdef["casing"], def: element });
                                if (isOptional == true) //reset newBlockMarker
                                    newBlockMarker = false;
                            }
                            outElem.push({ fn: maskdef.validator ? typeof maskdef.validator == 'string' ? new RegExp(maskdef.validator) : new function () { this.test = maskdef.validator; } : new RegExp("."), cardinality: maskdef.cardinality, optionality: isOptional, newBlockMarker: newBlockMarker, offset: 0, casing: maskdef["casing"], def: element });
                        } else {
                            outElem.push({ fn: null, cardinality: 0, optionality: isOptional, newBlockMarker: newBlockMarker, offset: 0, casing: null, def: element });
                            escaped = false;
                        }
                        //reset newBlockMarker
                        newBlockMarker = false;
                        return outElem;
                    }
                });
            }

            function isValid(pos, c, buffer, strict) { //strict true ~ no correction or autofill
                var result = false;
                if (pos >= 0 && pos < getMaskLength()) {
                    var testPos = determineTestPosition(pos), loopend = c ? 1 : 0, chrs = '';
                    for (var i = tests[testPos].cardinality; i > loopend; i--) {
                        chrs += getBufferElement(buffer, testPos - (i - 1));
                    }

                    if (c) {
                        chrs += c;
                    }
                    //return is false or a json object => { pos: ??, c: ??}
                    result = tests[testPos].fn != null ? tests[testPos].fn.test(chrs, buffer, pos, strict, opts) : false;
                }
                //setTimeout(opts.onKeyValidation.call(this, result, opts), 0); //extra stuff to execute on keydown
                return result;
            }

            function isMask(pos) {
                var testPos = determineTestPosition(pos);
                var test = tests[testPos];

                return test != undefined ? test.fn : false;
            }

            function determineTestPosition(pos) {
                return pos % tests.length;
            }

            function getPlaceHolder(pos) {
                return opts.placeholder.charAt(pos % opts.placeholder.length);
            }

            function getMaskLength() {
                var calculatedLength = _buffer.length;
                if (!opts.greedy && opts.repeat > 1) {
                    calculatedLength += (_buffer.length * (opts.repeat - 1));
                }
                return calculatedLength;
            }

            //pos: from position
            function seekNext(buffer, pos) {
                var maskL = getMaskLength();
                if (pos >= maskL) return maskL;
                var position = pos;
                while (++position < maskL && !isMask(position)) { };
                return position;
            }
            //pos: from position
            function seekPrevious(buffer, pos) {
                var position = pos;
                if (position <= 0) return 0;

                while (--position > 0 && !isMask(position)) { };
                return position;
            }

            function setBufferElement(buffer, position, element) {
                //position = prepareBuffer(buffer, position);

                var test = tests[determineTestPosition(position)];
                var elem = element;
                if (elem != undefined) {
                    switch (test.casing) {
                        case "upper":
                            elem = element.toUpperCase();
                            break;
                        case "lower":
                            elem = element.toLowerCase();
                            break;
                    }
                }

                buffer[position] = elem;
            }
            function getBufferElement(buffer, position, autoPrepare) {
                if (autoPrepare) position = prepareBuffer(buffer, position);
                return buffer[position];
            }

            //needed to handle the non-greedy mask repetitions
            function prepareBuffer(buffer, position, isRTL) {
                var j;
                if (isRTL) {
                    while (position < 0 && buffer.length < getMaskLength()) {
                        j = _buffer.length - 1;
                        position = _buffer.length;
                        while (_buffer[j] !== undefined) {
                            buffer.unshift(_buffer[j--]);
                        }
                    }
                } else {
                    while (buffer[position] == undefined && buffer.length < getMaskLength()) {
                        j = 0;
                        while (_buffer[j] !== undefined) { //add a new buffer
                            buffer.push(_buffer[j++]);
                        }
                    }
                }

                return position;
            }

            function writeBuffer(input, buffer, caretPos) {
                input._valueSet(buffer.join(''));
                if (caretPos != undefined) {
                    if (android) {
                        setTimeout(function () {
                            caret(input, caretPos);
                        }, 100);
                    }
                    else caret(input, caretPos);
                }
            };
            function clearBuffer(buffer, start, end) {
                for (var i = start, maskL = getMaskLength(); i < end && i < maskL; i++) {
                    setBufferElement(buffer, i, getBufferElement(_buffer.slice(), i));
                }
            };

            function setReTargetPlaceHolder(buffer, pos) {
                var testPos = determineTestPosition(pos);
                setBufferElement(buffer, pos, getBufferElement(_buffer, testPos));
            }

            function checkVal(input, buffer, clearInvalid, skipRadixHandling) {
                var isRTL = $(input).data('inputmask')['isRTL'],
                    inputValue = truncateInput(input._valueGet(), isRTL).split('');

                if (isRTL) { //align inputValue for RTL/numeric input
                    var maskL = getMaskLength();
                    var inputValueRev = inputValue.reverse(); inputValueRev.length = maskL;

                    for (var i = 0; i < maskL; i++) {
                        var targetPosition = determineTestPosition(maskL - (i + 1));
                        if (tests[targetPosition].fn == null && inputValueRev[i] != getBufferElement(_buffer, targetPosition)) {
                            inputValueRev.splice(i, 0, getBufferElement(_buffer, targetPosition));
                            inputValueRev.length = maskL;
                        } else {
                            inputValueRev[i] = inputValueRev[i] || getBufferElement(_buffer, targetPosition);
                        }
                    }
                    inputValue = inputValueRev.reverse();
                }
                clearBuffer(buffer, 0, buffer.length);
                buffer.length = _buffer.length;
                var lastMatch = -1, checkPosition = -1, np, maskL = getMaskLength(), ivl = inputValue.length, rtlMatch = ivl == 0 ? maskL : -1;
                for (var i = 0; i < ivl; i++) {
                    for (var pos = checkPosition + 1; pos < maskL; pos++) {
                        if (isMask(pos)) {
                            var c = inputValue[i];
                            if ((np = isValid(pos, c, buffer, !clearInvalid)) !== false) {
                                if (np !== true) {
                                    pos = np.pos || pos; //set new position from isValid
                                    c = np.c || c; //set new char from isValid
                                }
                                setBufferElement(buffer, pos, c);
                                lastMatch = checkPosition = pos;
                            } else {
                                setReTargetPlaceHolder(buffer, pos);
                                if (c == getPlaceHolder(pos)) {
                                    checkPosition = pos;
                                    rtlMatch = pos;
                                }
                            }
                            break;
                        } else {   //nonmask
                            setReTargetPlaceHolder(buffer, pos);
                            if (lastMatch == checkPosition) //once outsync the nonmask cannot be the lastmatch
                                lastMatch = pos;
                            checkPosition = pos;
                            if (inputValue[i] == getBufferElement(buffer, pos))
                                break;
                        }
                    }
                }
                //Truncate buffer when using non-greedy masks
                if (opts.greedy == false) {
                    var newBuffer = truncateInput(buffer.join(''), isRTL).split('');
                    while (buffer.length != newBuffer.length) {  //map changes into the original buffer
                        isRTL ? buffer.shift() : buffer.pop();
                    }
                }

                if (clearInvalid) {
                    writeBuffer(input, buffer);
                }
                return isRTL ? (opts.numericInput ? ($.inArray(opts.radixPoint, buffer) != -1 && skipRadixHandling !== true ? $.inArray(opts.radixPoint, buffer) : seekNext(buffer, maskL)) : seekNext(buffer, rtlMatch)) : seekNext(buffer, lastMatch);
            }

            function escapeRegex(str) {
                var specials = ['/', '.', '*', '+', '?', '|', '(', ')', '[', ']', '{', '}', '\\'];
                return str.replace(new RegExp('(\\' + specials.join('|\\') + ')', 'gim'), '\\$1');
            }
            function truncateInput(inputValue, rtl) {
                return rtl ? inputValue.replace(new RegExp("^(" + escapeRegex(_buffer.join('')) + ")*"), "") : inputValue.replace(new RegExp("(" + escapeRegex(_buffer.join('')) + ")*$"), "");
            }

            function clearOptionalTail(input, buffer) {
                checkVal(input, buffer, false);
                var tmpBuffer = buffer.slice();
                if ($(input).data('inputmask')['isRTL']) {
                    for (var pos = 0; pos <= tmpBuffer.length - 1; pos++) {
                        var testPos = determineTestPosition(pos);
                        if (tests[testPos].optionality) {
                            if (getPlaceHolder(pos) == buffer[pos] || !isMask(pos))
                                tmpBuffer.splice(0, 1);
                            else break;
                        } else break;
                    }
                } else {
                    for (var pos = tmpBuffer.length - 1; pos >= 0; pos--) {
                        var testPos = determineTestPosition(pos);
                        if (tests[testPos].optionality) {
                            if (getPlaceHolder(pos) == buffer[pos] || !isMask(pos))
                                tmpBuffer.pop();
                            else break;
                        } else break;
                    }
                }
                writeBuffer(input, tmpBuffer);
            }

            //functionality fn
            function unmaskedvalue($input, skipDatepickerCheck) {
                var input = $input[0];
                if (tests && (skipDatepickerCheck === true || !$input.hasClass('hasDatepicker'))) {
                    var buffer = _buffer.slice();
                    checkVal(input, buffer);
                    return $.map(buffer, function (element, index) {
                        return isMask(index) && element != getBufferElement(_buffer.slice(), index) ? element : null;
                    }).join('');
                }
                else {
                    return input._valueGet();
                }
            }

            function caret(input, begin, end) {
                var npt = input.jquery && input.length > 0 ? input[0] : input;
                if (typeof begin == 'number') {
                    end = (typeof end == 'number') ? end : begin;
                    if (opts.insertMode == false && begin == end) end++; //set visualization for insert/overwrite mode
                    if (npt.setSelectionRange) {
                        npt.setSelectionRange(begin, end);
                    } else if (npt.createTextRange) {
                        var range = npt.createTextRange();
                        range.collapse(true);
                        range.moveEnd('character', end);
                        range.moveStart('character', begin);
                        range.select();
                    }
                    npt.focus();
                    if (android && end != npt.selectionEnd) caretposCorrection = { begin: begin, end: end };
                } else {
                    var caretpos = android ? caretposCorrection : null, caretposCorrection = null;
                    if (caretpos == null) {
                        if (npt.setSelectionRange) {
                            begin = npt.selectionStart;
                            end = npt.selectionEnd;
                        } else if (document.selection && document.selection.createRange) {
                            var range = document.selection.createRange();
                            begin = 0 - range.duplicate().moveStart('character', -100000);
                            end = begin + range.text.length;
                        }
                        caretpos = { begin: begin, end: end };
                    }
                    return caretpos;
                }
            };

            function mask(el) {
                var $input = $(el);
                if (!$input.is(":input")) return;

                //correct greedy setting if needed
                opts.greedy = opts.greedy ? opts.greedy : opts.repeat == 0;

                //handle maxlength attribute
                var maxLength = $input.prop('maxLength');
                if (getMaskLength() > maxLength && maxLength > -1) { //FF sets no defined max length to -1
                    if (maxLength < _buffer.length) _buffer.length = maxLength;
                    if (opts.greedy == false) {
                        opts.repeat = Math.round(maxLength / _buffer.length);
                    }
                }
                $input.prop('maxLength', getMaskLength() * 2);

                //store tests & original buffer in the input element - used to get the unmasked value
                $input.data('inputmask', {
                    'tests': tests,
                    '_buffer': _buffer,
                    'greedy': opts.greedy,
                    'repeat': opts.repeat,
                    'autoUnmask': opts.autoUnmask,
                    'definitions': opts.definitions,
                    'isRTL': false
                });

                patchValueProperty(el);

                //init vars
                var buffer = _buffer.slice(),
                undoBuffer = el._valueGet(),
                skipKeyPressEvent = false, //Safari 5.1.x - modal dialog fires keypress twice workaround
                ignorable = false,
                lastPosition = -1,
                firstMaskPos = seekNext(buffer, -1),
                lastMaskPos = seekPrevious(buffer, getMaskLength()),
                isRTL = false;
                if (el.dir == "rtl" || opts.numericInput) {
                    el.dir = "ltr"
                    $input.css("text-align", "right");
                    $input.removeAttr("dir");
                    var inputData = $input.data('inputmask');
                    inputData['isRTL'] = true;
                    $input.data('inputmask', inputData);
                    isRTL = true;
                }

                //unbind all events - to make sure that no other mask will interfere when re-masking
                $input.unbind(".inputmask");
                $input.removeClass('focus.inputmask');
                //bind events
                $input.bind("mouseenter.inputmask", function () {
                    var $input = $(this), input = this;
                    if (!$input.hasClass('focus.inputmask') && opts.showMaskOnHover) {
                        var nptL = input._valueGet().length;
                        if (nptL < buffer.length) {
                            if (nptL == 0)
                                buffer = _buffer.slice();
                            writeBuffer(input, buffer);
                        }
                    }
                }).bind("blur.inputmask", function () {
                    var $input = $(this), input = this, nptValue = input._valueGet();
                    $input.removeClass('focus.inputmask');
                    if (nptValue != undoBuffer) {
                        $input.change();
                    }
                    if (opts.clearMaskOnLostFocus) {
                        if (nptValue == _buffer.join(''))
                            input._valueSet('');
                        else { //clearout optional tail of the mask
                            clearOptionalTail(input, buffer);
                        }
                    }
                    if (!isComplete(input)) {
                        $input.trigger("incomplete");
                        if (opts.clearIncomplete) {
                            if (opts.clearMaskOnLostFocus)
                                input._valueSet('');
                            else {
                                buffer = _buffer.slice();
                                writeBuffer(input, buffer);
                            }
                        }
                    }
                }).bind("focus.inputmask", function () {
                    var $input = $(this), input = this;
                    if (!opts.overrideFocus) {
                        if (!$input.hasClass('focus.inputmask') && !opts.showMaskOnHover) {
                            var nptL = input._valueGet().length;
                            if (nptL < buffer.length) {
                                if (nptL == 0)
                                    buffer = _buffer.slice();
                                caret(input, checkVal(input, buffer, true));
                            }
                        }
                    }
                    $input.addClass('focus.inputmask');
                    undoBuffer = input._valueGet();
                }).bind("mouseleave.inputmask", function () {
                    var $input = $(this), input = this;
                    if (opts.clearMaskOnLostFocus) {
                        if (!$input.hasClass('focus.inputmask')) {
                            if (input._valueGet() == _buffer.join('') || input._valueGet() == '')
                                input._valueSet('');
                            else { //clearout optional tail of the mask
                                clearOptionalTail(input, buffer);
                            }
                        }
                    }
                }).bind("click.inputmask", function () {
                    var input = this;
                    setTimeout(function () {
                        var selectedCaret = caret(input);
                        if (selectedCaret.begin == selectedCaret.end) {
                            var clickPosition = selectedCaret.begin;
                            lastPosition = checkVal(input, buffer, false);
                            if (isRTL)
                                caret(input, clickPosition > lastPosition && (isValid(clickPosition, buffer[clickPosition], buffer, true) !== false || !isMask(clickPosition)) ? clickPosition : lastPosition);
                            else
                                caret(input, clickPosition < lastPosition && (isValid(clickPosition, buffer[clickPosition], buffer, true) !== false || !isMask(clickPosition)) ? clickPosition : lastPosition);
                        }
                    }, 0);
                }).bind('dblclick.inputmask', function () {
                    var input = this;
                    setTimeout(function () {
                        caret(input, 0, lastPosition);
                    }, 0);
                }).bind("keydown.inputmask", keydownEvent
                ).bind("keypress.inputmask", keypressEvent
                ).bind("keyup.inputmask", keyupEvent
                ).bind(pasteEvent + ".inputmask, dragdrop.inputmask, drop.inputmask", function () {
                    var input = this;
                    setTimeout(function () {
                        caret(input, checkVal(input, buffer, true));
                    }, 0);
                }).bind('setvalue.inputmask', function () {
                    var input = this;
                    undoBuffer = input._valueGet();
                    checkVal(input, buffer, true);
                    if (input._valueGet() == _buffer.join(''))
                        input._valueSet('');
                }).bind('complete.inputmask', opts.oncomplete)
                .bind('incomplete.inputmask', opts.onincomplete)
                .bind('cleared.inputmask', opts.oncleared);

                //apply mask
                lastPosition = checkVal(el, buffer, true);

                // Wrap document.activeElement in a try/catch block since IE9 throw "Unspecified error" if document.activeElement is undefined when we are in an IFrame.
                var activeElement;
                try {
                    activeElement = document.activeElement;
                } catch (e) { }
                if (activeElement === el) { //position the caret when in focus
                    $input.addClass('focus.inputmask');
                    caret(el, lastPosition);
                } else if (opts.clearMaskOnLostFocus) {
                    if (el._valueGet() == _buffer.join('')) {
                        el._valueSet('');
                    } else {
                        clearOptionalTail(el, buffer);
                    }
                }

                installEventRuler(el);

                //private functions
                function isComplete(npt) {
                    var complete = true, nptValue = npt._valueGet(), ml = nptValue.length;
                    for (var i = 0; i < ml; i++) {
                        if (isMask(i) && nptValue.charAt(i) == getPlaceHolder(i)) {
                            complete = false;
                            break;
                        }
                    }
                    return complete;
                }


                function installEventRuler(npt) {
                    var events = $._data(npt).events;

                    $.each(events, function (eventType, eventHandlers) {
                        $(npt).bind(eventType + ".inputmask", function (event) {
                            if (this.readOnly || this.disabled) {
                                event.stopPropagation();
                                event.stopImmediatePropagation();
                                event.preventDefault();
                                return false;
                            }
                        });
                        //!! the bound handlers are executed in the order they where bound
                        //reorder the events
                        var ourHandler = eventHandlers[eventHandlers.length - 1];
                        for (var i = eventHandlers.length - 1; i > 0; i--) {
                            eventHandlers[i] = eventHandlers[i - 1];
                        }
                        eventHandlers[0] = ourHandler;
                    });
                }

                function patchValueProperty(npt) {
                    var valueProperty;
                    if (Object.getOwnPropertyDescriptor)
                        valueProperty = Object.getOwnPropertyDescriptor(npt, "value");
                    if (valueProperty && valueProperty.get) {
                        if (!npt._valueGet) {

                            npt._valueGet = valueProperty.get;
                            npt._valueSet = valueProperty.set;

                            Object.defineProperty(npt, "value", {
                                get: function () {
                                    var $self = $(this), inputData = $(this).data('inputmask');
                                    return inputData && inputData['autoUnmask'] ? $self.inputmask('unmaskedvalue') : this._valueGet() != inputData['_buffer'].join('') ? this._valueGet() : '';
                                },
                                set: function (value) {
                                    this._valueSet(value); $(this).triggerHandler('setvalue.inputmask');
                                }
                            });
                        }
                    } else if (document.__lookupGetter__ && npt.__lookupGetter__("value")) {
                        if (!npt._valueGet) {
                            npt._valueGet = npt.__lookupGetter__("value");
                            npt._valueSet = npt.__lookupSetter__("value");

                            npt.__defineGetter__("value", function () {
                                var $self = $(this), inputData = $(this).data('inputmask');
                                return inputData && inputData['autoUnmask'] ? $self.inputmask('unmaskedvalue') : this._valueGet() != inputData['_buffer'].join('') ? this._valueGet() : '';
                            });
                            npt.__defineSetter__("value", function (value) {
                                this._valueSet(value); $(this).triggerHandler('setvalue.inputmask');
                            });
                        }
                    } else {
                        if (!npt._valueGet) {
                            npt._valueGet = function () { return this.value; }
                            npt._valueSet = function (value) { this.value = value; }
                        }
                        if ($.fn.val.inputmaskpatch != true) {
                            $.fn.val = function () {
                                if (arguments.length == 0) {
                                    var $self = $(this);
                                    if ($self.data('inputmask')) {
                                        if ($self.data('inputmask')['autoUnmask'])
                                            return $self.inputmask('unmaskedvalue');
                                        else {
                                            var result = $.inputmask.val.apply($self);
                                            return result != $self.data('inputmask')['_buffer'].join('') ? result : '';
                                        }
                                    } else return $.inputmask.val.apply($self);
                                } else {
                                    var args = arguments;
                                    return this.each(function () {
                                        var $self = $(this);
                                        var result = $.inputmask.val.apply($self, args);
                                        if ($self.data('inputmask')) $self.triggerHandler('setvalue.inputmask');
                                        return result;
                                    });
                                }
                            };
                            $.extend($.fn.val, {
                                inputmaskpatch: true
                            });
                        }
                    }
                }
                //shift chars to left from start to end and put c at end position if defined
                function shiftL(start, end, c) {
                    while (!isMask(start) && start - 1 >= 0) start--;
                    for (var i = start; i < end && i < getMaskLength(); i++) {
                        if (isMask(i)) {
                            setReTargetPlaceHolder(buffer, i);
                            var j = seekNext(buffer, i);
                            var p = getBufferElement(buffer, j);
                            if (p != getPlaceHolder(j)) {
                                if (j < getMaskLength() && isValid(i, p, buffer, true) !== false && tests[determineTestPosition(i)].def == tests[determineTestPosition(j)].def) {
                                    setBufferElement(buffer, i, getBufferElement(buffer, j));
                                    setReTargetPlaceHolder(buffer, j); //cleanup next position
                                } else {
                                    if (isMask(i))
                                        break;
                                }
                            } else if (c == undefined) break;
                        } else {
                            setReTargetPlaceHolder(buffer, i);
                        }
                    }
                    if (c != undefined)
                        setBufferElement(buffer, isRTL ? end : seekPrevious(buffer, end), c);

                    buffer = truncateInput(buffer.join(''), isRTL).split('');
                    if (buffer.length == 0) buffer = _buffer.slice();

                    return start; //return the used start position
                }
                function shiftR(start, end, c, full) { //full => behave like a push right ~ do not stop on placeholders
                    for (var i = start; i <= end && i < getMaskLength(); i++) {
                        if (isMask(i)) {
                            var t = getBufferElement(buffer, i);
                            setBufferElement(buffer, i, c);
                            if (t != getPlaceHolder(i)) {
                                var j = seekNext(buffer, i);
                                if (j < getMaskLength()) {
                                    if (isValid(j, t, buffer, true) !== false && tests[determineTestPosition(i)].def == tests[determineTestPosition(j)].def)
                                        c = t;
                                    else {
                                        if (isMask(j))
                                            break;
                                        else c = t;
                                    }
                                } else break;
                            } else if (full !== true) break;
                        } else
                            setReTargetPlaceHolder(buffer, i);
                    }
                    var lengthBefore = buffer.length;
                    buffer = truncateInput(buffer.join(''), isRTL).split('');
                    if (buffer.length == 0) buffer = _buffer.slice();

                    return end - (lengthBefore - buffer.length);  //return new start position
                };

                function keydownEvent(e) {
                    //Safari 5.1.x - modal dialog fires keypress twice workaround
                    skipKeyPressEvent = false;

                    var input = this, k = e.keyCode, pos = caret(input);

                    //set input direction according the position to the radixPoint
                    if (opts.numericInput) {
                        var nptStr = input._valueGet();
                        var radixPosition = nptStr.indexOf(opts.radixPoint);
                        if (radixPosition != -1) {
                            isRTL = pos.begin <= radixPosition || pos.end <= radixPosition;
                        }
                    }

                    //backspace, delete, and escape get special treatment
                    if (k == opts.keyCode.BACKSPACE || k == opts.keyCode.DELETE || (iphone && k == 127)) {//backspace/delete
                        var maskL = getMaskLength();
                        if (pos.begin == 0 && pos.end == maskL) {
                            buffer = _buffer.slice();
                            writeBuffer(input, buffer);
                            caret(input, checkVal(input, buffer, false));
                        } else if ((pos.end - pos.begin) > 1 || ((pos.end - pos.begin) == 1 && opts.insertMode)) {
                            clearBuffer(buffer, pos.begin, pos.end);
                            writeBuffer(input, buffer, isRTL ? checkVal(input, buffer, false) : pos.begin);
                        } else {
                            var beginPos = pos.begin - (k == opts.keyCode.DELETE ? 0 : 1);
                            if (beginPos < firstMaskPos && k == opts.keyCode.DELETE) {
                                beginPos = firstMaskPos;
                            }
                            if (beginPos >= firstMaskPos) {
                                if (opts.numericInput && opts.greedy && k == opts.keyCode.DELETE && buffer[beginPos] == opts.radixPoint) {
                                    beginPos = seekNext(buffer, beginPos);
                                    isRTL = false;
                                }
                                if (isRTL) {
                                    beginPos = shiftR(firstMaskPos, beginPos, getPlaceHolder(beginPos), true);
                                    beginPos = (opts.numericInput && opts.greedy && k == opts.keyCode.BACKSPACE && buffer[beginPos + 1] == opts.radixPoint) ? beginPos + 1 : seekNext(buffer, beginPos);
                                } else beginPos = shiftL(beginPos, maskL);
                                writeBuffer(input, buffer, beginPos);
                            }
                        }
                        if (input._valueGet() == _buffer.join(''))
                            $(input).trigger('cleared');

                        return false;
                    } else if (k == opts.keyCode.END || k == opts.keyCode.PAGE_DOWN) { //when END or PAGE_DOWN pressed set position at lastmatch
                        setTimeout(function () {
                            var caretPos = checkVal(input, buffer, false, true);
                            if (!opts.insertMode && caretPos == getMaskLength() && !e.shiftKey) caretPos--;
                            caret(input, e.shiftKey ? pos.begin : caretPos, caretPos);
                        }, 0);
                        return false;
                    } else if (k == opts.keyCode.HOME || k == opts.keyCode.PAGE_UP) {//Home or page_up
                        caret(input, 0, e.shiftKey ? pos.begin : 0);
                        return false;
                    }
                    else if (k == opts.keyCode.ESCAPE) {//escape
                        input._valueSet(undoBuffer);
                        caret(input, 0, checkVal(input, buffer));
                        return false;
                    } else if (k == opts.keyCode.INSERT) {//insert
                        opts.insertMode = !opts.insertMode;
                        caret(input, !opts.insertMode && pos.begin == getMaskLength() ? pos.begin - 1 : pos.begin);
                        return false;
                    } else if (e.ctrlKey && k == 88) {
                        setTimeout(function () {
                            caret(input, checkVal(input, buffer, true));
                        }, 0);
                    } else if (!opts.insertMode) { //overwritemode
                        if (k == opts.keyCode.RIGHT) {//right
                            var caretPos = pos.begin == pos.end ? pos.end + 1 : pos.end;
                            caretPos = caretPos < getMaskLength() ? caretPos : pos.end;
                            caret(input, e.shiftKey ? pos.begin : caretPos, e.shiftKey ? caretPos + 1 : caretPos);
                            return false;
                        } else if (k == opts.keyCode.LEFT) {//left
                            var caretPos = pos.begin - 1;
                            caretPos = caretPos > 0 ? caretPos : 0;
                            caret(input, caretPos, e.shiftKey ? pos.end : caretPos);
                            return false;
                        }
                    }

                    opts.onKeyDown.call(this, e, opts); //extra stuff to execute on keydown
                    ignorable = $.inArray(k, opts.ignorables) != -1;
                }

                function keypressEvent(e) {
                    //Safari 5.1.x - modal dialog fires keypress twice workaround
                    if (skipKeyPressEvent) return false;
                    skipKeyPressEvent = true;

                    var input = this, $input = $(input);

                    e = e || window.event;
                    var k = e.which || e.charCode || e.keyCode;

                    if (opts.numericInput && k == opts.radixPoint.charCodeAt(opts.radixPoint.length - 1)) {
                        var nptStr = input._valueGet();
                        var radixPosition = nptStr.indexOf(opts.radixPoint);
                        caret(input, seekNext(buffer, radixPosition != -1 ? radixPosition : getMaskLength()));
                    }

                    if (e.ctrlKey || e.altKey || e.metaKey || ignorable) {//Ignore
                        return true;
                    } else {
                        if (k) {
                            $input.trigger('input');

                            var pos = caret(input), c = String.fromCharCode(k), maskL = getMaskLength();
                            clearBuffer(buffer, pos.begin, pos.end);

                            if (isRTL) {
                                var p = opts.numericInput ? pos.end : seekPrevious(buffer, pos.end), np;
                                if ((np = isValid(p == maskL || getBufferElement(buffer, p) == opts.radixPoint ? seekPrevious(buffer, p) : p, c, buffer, false)) !== false) {
                                    if (np !== true) {
                                        p = np.pos || pos; //set new position from isValid
                                        c = np.c || c; //set new char from isValid
                                    }

                                    var firstUnmaskedPosition = firstMaskPos;
                                    if (opts.insertMode == true) {
                                        if (opts.greedy == true) {
                                            var bfrClone = buffer.slice();
                                            while (getBufferElement(bfrClone, firstUnmaskedPosition, true) != getPlaceHolder(firstUnmaskedPosition) && firstUnmaskedPosition <= p) {
                                                firstUnmaskedPosition = firstUnmaskedPosition == maskL ? (maskL + 1) : seekNext(buffer, firstUnmaskedPosition);
                                            }
                                        }

                                        if (firstUnmaskedPosition <= p && (opts.greedy || buffer.length < maskL)) {
                                            if (buffer[firstMaskPos] != getPlaceHolder(firstMaskPos) && buffer.length < maskL) {
                                                var offset = prepareBuffer(buffer, -1, isRTL);
                                                if (pos.end != 0) p = p + offset;
                                                maskL = buffer.length;
                                            }
                                            shiftL(firstUnmaskedPosition, opts.numericInput ? seekPrevious(buffer, p) : p, c);
                                        } else return false;
                                    } else setBufferElement(buffer, opts.numericInput ? seekPrevious(buffer, p) : p, c);
                                    writeBuffer(input, buffer, opts.numericInput && p == 0 ? seekNext(buffer, p) : p);
                                    setTimeout(function () { //timeout needed for IE
                                        if (isComplete(input))
                                            $input.trigger("complete");
                                    }, 0);
                                } else if (android) writeBuffer(input, buffer, pos.begin);
                            }
                            else {
                                var p = seekNext(buffer, pos.begin - 1), np;
                                prepareBuffer(buffer, p, isRTL);
                                if ((np = isValid(p, c, buffer, false)) !== false) {
                                    if (np !== true) {
                                        p = np.pos || p; //set new position from isValid
                                        c = np.c || c; //set new char from isValid
                                    }
                                    if (opts.insertMode == true) {
                                        var lastUnmaskedPosition = getMaskLength();
                                        var bfrClone = buffer.slice();
                                        while (getBufferElement(bfrClone, lastUnmaskedPosition, true) != getPlaceHolder(lastUnmaskedPosition) && lastUnmaskedPosition >= p) {
                                            lastUnmaskedPosition = lastUnmaskedPosition == 0 ? -1 : seekPrevious(buffer, lastUnmaskedPosition);
                                        }
                                        if (lastUnmaskedPosition >= p)
                                            shiftR(p, buffer.length, c);
                                        else return false;
                                    }
                                    else setBufferElement(buffer, p, c);
                                    var next = seekNext(buffer, p);
                                    writeBuffer(input, buffer, next);

                                    setTimeout(function () { //timeout needed for IE
                                        if (isComplete(input))
                                            $input.trigger("complete");
                                    }, 0);
                                } else if (android) writeBuffer(input, buffer, pos.begin);
                            }
                            return false;
                        }
                    }
                }

                function keyupEvent(e) {
                    var $input = $(this), input = this;
                    var k = e.keyCode;
                    opts.onKeyUp.call(this, e, opts); //extra stuff to execute on keyup
                    if (k == opts.keyCode.TAB && $input.hasClass('focus.inputmask') && input._valueGet().length == 0) {
                        buffer = _buffer.slice();
                        writeBuffer(input, buffer);
                        if (!isRTL) caret(input, 0);
                        undoBuffer = input._valueGet();
                    }
                }
            }

            return this; //return this to expose publics
        };
    }
})(jQuery);
/*! Video.js v4.12.7 Copyright 2014 Brightcove, Inc. https://github.com/videojs/video.js/blob/master/LICENSE */ 
(function() {var b=void 0,f=!0,j=null,l=!1;function m(){return function(){}}function n(a){return function(){return this[a]}}function q(a){return function(){return a}}var s;document.createElement("video");document.createElement("audio");document.createElement("track");
function t(a,c,d){if("string"===typeof a){0===a.indexOf("#")&&(a=a.slice(1));if(t.Aa[a])return c&&t.log.warn('Player "'+a+'" is already initialised. Options will not be applied.'),d&&t.Aa[a].I(d),t.Aa[a];a=t.m(a)}if(!a||!a.nodeName)throw new TypeError("The element or ID supplied is not valid. (videojs)");return a.player||new t.Player(a,c,d)}var videojs=window.videojs=t;t.ic="4.12";t.vd="https:"==document.location.protocol?"https://":"http://";t.VERSION="4.12.7";
t.options={techOrder:["html5","flash"],html5:{},flash:{},width:300,height:150,defaultVolume:0,playbackRates:[],inactivityTimeout:2E3,children:{mediaLoader:{},posterImage:{},loadingSpinner:{},textTrackDisplay:{},bigPlayButton:{},controlBar:{},errorDisplay:{},textTrackSettings:{}},language:document.getElementsByTagName("html")[0].getAttribute("lang")||navigator.languages&&navigator.languages[0]||navigator.If||navigator.language||"en",languages:{},notSupportedMessage:"No compatible source was found for this video."};
"GENERATED_CDN_VSN"!==t.ic&&(videojs.options.flash.swf=t.vd+"vjs.zencdn.net/"+t.ic+"/video-js.swf");t.Jd=function(a,c){t.options.languages[a]=t.options.languages[a]!==b?t.$.ya(t.options.languages[a],c):c;return t.options.languages};t.Aa={};"function"===typeof define&&define.amd?define("videojs",[],function(){return videojs}):"object"===typeof exports&&"object"===typeof module&&(module.exports=videojs);t.Ea=t.CoreObject=m();
t.Ea.extend=function(a){var c,d;a=a||{};c=a.init||a.l||this.prototype.init||this.prototype.l||m();d=function(){c.apply(this,arguments)};d.prototype=t.i.create(this.prototype);d.prototype.constructor=d;d.extend=t.Ea.extend;d.create=t.Ea.create;for(var e in a)a.hasOwnProperty(e)&&(d.prototype[e]=a[e]);return d};t.Ea.create=function(){var a=t.i.create(this.prototype);this.apply(a,arguments);return a};
t.b=function(a,c,d){if(t.i.isArray(c))return v(t.b,a,c,d);var e=t.getData(a);e.G||(e.G={});e.G[c]||(e.G[c]=[]);d.s||(d.s=t.s++);e.G[c].push(d);e.ca||(e.disabled=l,e.ca=function(c){if(!e.disabled){c=t.Pb(c);var d=e.G[c.type];if(d)for(var d=d.slice(0),k=0,p=d.length;k<p&&!c.Rc();k++)d[k].call(a,c)}});1==e.G[c].length&&(a.addEventListener?a.addEventListener(c,e.ca,l):a.attachEvent&&a.attachEvent("on"+c,e.ca))};
t.n=function(a,c,d){if(t.Mc(a)){var e=t.getData(a);if(e.G){if(t.i.isArray(c))return v(t.n,a,c,d);if(c){var g=e.G[c];if(g){if(d){if(d.s)for(e=0;e<g.length;e++)g[e].s===d.s&&g.splice(e--,1)}else e.G[c]=[];t.Ac(a,c)}}else for(g in e.G)c=g,e.G[c]=[],t.Ac(a,c)}}};t.Ac=function(a,c){var d=t.getData(a);0===d.G[c].length&&(delete d.G[c],a.removeEventListener?a.removeEventListener(c,d.ca,l):a.detachEvent&&a.detachEvent("on"+c,d.ca));t.ib(d.G)&&(delete d.G,delete d.ca,delete d.disabled);t.ib(d)&&t.cd(a)};
t.Pb=function(a){function c(){return f}function d(){return l}if(!a||!a.Vb){var e=a||window.event;a={};for(var g in e)"layerX"!==g&&("layerY"!==g&&"keyLocation"!==g)&&("returnValue"==g&&e.preventDefault||(a[g]=e[g]));a.target||(a.target=a.srcElement||document);a.relatedTarget=a.fromElement===a.target?a.toElement:a.fromElement;a.preventDefault=function(){e.preventDefault&&e.preventDefault();a.returnValue=l;a.ie=c;a.defaultPrevented=f};a.ie=d;a.defaultPrevented=l;a.stopPropagation=function(){e.stopPropagation&&
e.stopPropagation();a.cancelBubble=f;a.Vb=c};a.Vb=d;a.stopImmediatePropagation=function(){e.stopImmediatePropagation&&e.stopImmediatePropagation();a.Rc=c;a.stopPropagation()};a.Rc=d;if(a.clientX!=j){g=document.documentElement;var h=document.body;a.pageX=a.clientX+(g&&g.scrollLeft||h&&h.scrollLeft||0)-(g&&g.clientLeft||h&&h.clientLeft||0);a.pageY=a.clientY+(g&&g.scrollTop||h&&h.scrollTop||0)-(g&&g.clientTop||h&&h.clientTop||0)}a.which=a.charCode||a.keyCode;a.button!=j&&(a.button=a.button&1?0:a.button&
4?1:a.button&2?2:0)}return a};t.o=function(a,c){var d=t.Mc(a)?t.getData(a):{},e=a.parentNode||a.ownerDocument;"string"===typeof c&&(c={type:c,target:a});c=t.Pb(c);d.ca&&d.ca.call(a,c);if(e&&!c.Vb()&&c.bubbles!==l)t.o(e,c);else if(!e&&!c.defaultPrevented&&(d=t.getData(c.target),c.target[c.type])){d.disabled=f;if("function"===typeof c.target[c.type])c.target[c.type]();d.disabled=l}return!c.defaultPrevented};
t.N=function(a,c,d){function e(){t.n(a,c,e);d.apply(this,arguments)}if(t.i.isArray(c))return v(t.N,a,c,d);e.s=d.s=d.s||t.s++;t.b(a,c,e)};function v(a,c,d,e){t.wc.forEach(d,function(d){a(c,d,e)})}var w=Object.prototype.hasOwnProperty;t.e=function(a,c){var d;c=c||{};d=document.createElement(a||"div");t.i.da(c,function(a,c){-1!==a.indexOf("aria-")||"role"==a?d.setAttribute(a,c):d[a]=c});return d};t.ua=function(a){return a.charAt(0).toUpperCase()+a.slice(1)};t.i={};
t.i.create=Object.create||function(a){function c(){}c.prototype=a;return new c};t.i.da=function(a,c,d){for(var e in a)w.call(a,e)&&c.call(d||this,e,a[e])};t.i.D=function(a,c){if(!c)return a;for(var d in c)w.call(c,d)&&(a[d]=c[d]);return a};t.i.Rd=function(a,c){var d,e,g;a=t.i.copy(a);for(d in c)w.call(c,d)&&(e=a[d],g=c[d],a[d]=t.i.jb(e)&&t.i.jb(g)?t.i.Rd(e,g):c[d]);return a};t.i.copy=function(a){return t.i.D({},a)};
t.i.jb=function(a){return!!a&&"object"===typeof a&&"[object Object]"===a.toString()&&a.constructor===Object};t.i.isArray=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)};t.ke=function(a){return a!==a};t.bind=function(a,c,d){function e(){return c.apply(a,arguments)}c.s||(c.s=t.s++);e.s=d?d+"_"+c.s:c.s;return e};t.ta={};t.s=1;t.expando="vdata"+(new Date).getTime();t.getData=function(a){var c=a[t.expando];c||(c=a[t.expando]=t.s++);t.ta[c]||(t.ta[c]={});return t.ta[c]};
t.Mc=function(a){a=a[t.expando];return!(!a||t.ib(t.ta[a]))};t.cd=function(a){var c=a[t.expando];if(c){delete t.ta[c];try{delete a[t.expando]}catch(d){a.removeAttribute?a.removeAttribute(t.expando):a[t.expando]=j}}};t.ib=function(a){for(var c in a)if(a[c]!==j)return l;return f};t.Oa=function(a,c){return-1!==(" "+a.className+" ").indexOf(" "+c+" ")};t.p=function(a,c){t.Oa(a,c)||(a.className=""===a.className?c:a.className+" "+c)};
t.r=function(a,c){var d,e;if(t.Oa(a,c)){d=a.className.split(" ");for(e=d.length-1;0<=e;e--)d[e]===c&&d.splice(e,1);a.className=d.join(" ")}};t.A=t.e("video");var x=document.createElement("track");x.Wb="captions";x.hd="en";x.label="English";t.A.appendChild(x);t.P=navigator.userAgent;t.Cd=/iPhone/i.test(t.P);t.Bd=/iPad/i.test(t.P);t.Dd=/iPod/i.test(t.P);t.Ad=t.Cd||t.Bd||t.Dd;var aa=t,y;var z=t.P.match(/OS (\d+)_/i);y=z&&z[1]?z[1]:b;aa.kf=y;t.zd=/Android/i.test(t.P);var ba=t,B;
var C=t.P.match(/Android (\d+)(?:\.(\d+))?(?:\.(\d+))*/i),D,E;C?(D=C[1]&&parseFloat(C[1]),E=C[2]&&parseFloat(C[2]),B=D&&E?parseFloat(C[1]+"."+C[2]):D?D:j):B=j;ba.hc=B;t.Ed=t.zd&&/webkit/i.test(t.P)&&2.3>t.hc;t.jc=/Firefox/i.test(t.P);t.lf=/Chrome/i.test(t.P);t.oa=/MSIE\s8\.0/.test(t.P);t.Eb=!!("ontouchstart"in window||window.xd&&document instanceof window.xd);t.wd="backgroundSize"in t.A.style;
t.ed=function(a,c){t.i.da(c,function(c,e){e===j||"undefined"===typeof e||e===l?a.removeAttribute(c):a.setAttribute(c,e===f?"":e)})};t.Na=function(a){var c,d,e,g;c={};if(a&&a.attributes&&0<a.attributes.length){d=a.attributes;for(var h=d.length-1;0<=h;h--){e=d[h].name;g=d[h].value;if("boolean"===typeof a[e]||-1!==",autoplay,controls,loop,muted,default,".indexOf(","+e+","))g=g!==j?f:l;c[e]=g}}return c};
t.vf=function(a,c){var d="";document.defaultView&&document.defaultView.getComputedStyle?d=document.defaultView.getComputedStyle(a,"").getPropertyValue(c):a.currentStyle&&(d=a["client"+c.substr(0,1).toUpperCase()+c.substr(1)]+"px");return d};t.Ub=function(a,c){c.firstChild?c.insertBefore(a,c.firstChild):c.appendChild(a)};t.cb={};t.m=function(a){0===a.indexOf("#")&&(a=a.slice(1));return document.getElementById(a)};
t.Ma=function(a,c){c=c||a;var d=Math.floor(a%60),e=Math.floor(a/60%60),g=Math.floor(a/3600),h=Math.floor(c/60%60),k=Math.floor(c/3600);if(isNaN(a)||Infinity===a)g=e=d="-";g=0<g||0<k?g+":":"";return g+(((g||10<=h)&&10>e?"0"+e:e)+":")+(10>d?"0"+d:d)};t.Ld=function(){document.body.focus();document.onselectstart=q(l)};t.af=function(){document.onselectstart=q(f)};t.trim=function(a){return(a+"").replace(/^\s+|\s+$/g,"")};t.round=function(a,c){c||(c=0);return Math.round(a*Math.pow(10,c))/Math.pow(10,c)};
t.Lb=function(a,c){return{length:1,start:function(){return a},end:function(){return c}}};t.Me=function(a){try{var c=window.localStorage||l;c&&(c.volume=a)}catch(d){22==d.code||1014==d.code?t.log("LocalStorage Full (VideoJS)",d):18==d.code?t.log("LocalStorage not allowed (VideoJS)",d):t.log("LocalStorage Error (VideoJS)",d)}};t.$d=function(a){a.match(/^https?:\/\//)||(a=t.e("div",{innerHTML:'<a href="'+a+'">x</a>'}).firstChild.href);return a};
t.Ee=function(a){var c,d,e,g;g="protocol hostname port pathname search hash host".split(" ");d=t.e("a",{href:a});if(e=""===d.host&&"file:"!==d.protocol)c=t.e("div"),c.innerHTML='<a href="'+a+'"></a>',d=c.firstChild,c.setAttribute("style","display:none; position:absolute;"),document.body.appendChild(c);a={};for(var h=0;h<g.length;h++)a[g[h]]=d[g[h]];"http:"===a.protocol&&(a.host=a.host.replace(/:80$/,""));"https:"===a.protocol&&(a.host=a.host.replace(/:443$/,""));e&&document.body.removeChild(c);return a};
function F(a,c){var d,e;d=Array.prototype.slice.call(c);e=m();e=window.console||{log:e,warn:e,error:e};a?d.unshift(a.toUpperCase()+":"):a="log";t.log.history.push(d);d.unshift("VIDEOJS:");if(e[a].apply)e[a].apply(e,d);else e[a](d.join(" "))}t.log=function(){F(j,arguments)};t.log.history=[];t.log.error=function(){F("error",arguments)};t.log.warn=function(){F("warn",arguments)};
t.Yd=function(a){var c,d;a.getBoundingClientRect&&a.parentNode&&(c=a.getBoundingClientRect());if(!c)return{left:0,top:0};a=document.documentElement;d=document.body;return{left:t.round(c.left+(window.pageXOffset||d.scrollLeft)-(a.clientLeft||d.clientLeft||0)),top:t.round(c.top+(window.pageYOffset||d.scrollTop)-(a.clientTop||d.clientTop||0))}};t.wc={};t.wc.forEach=function(a,c,d){if(t.i.isArray(a)&&c instanceof Function)for(var e=0,g=a.length;e<g;++e)c.call(d||t,a[e],e,a);return a};
t.ff=function(a,c){var d,e,g,h,k,p,r;"string"===typeof a&&(a={uri:a});videojs.$.ya({method:"GET",timeout:45E3},a);c=c||m();p=function(){window.clearTimeout(k);c(j,e,e.response||e.responseText)};r=function(a){window.clearTimeout(k);if(!a||"string"===typeof a)a=Error(a);c(a,e)};d=window.XMLHttpRequest;"undefined"===typeof d&&(d=function(){try{return new window.ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(a){}try{return new window.ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(c){}try{return new window.ActiveXObject("Msxml2.XMLHTTP")}catch(d){}throw Error("This browser does not support XMLHttpRequest.");
});e=new d;e.uri=a.uri;d=t.Ee(a.uri);g=window.location;d.protocol+d.host!==g.protocol+g.host&&window.XDomainRequest&&!("withCredentials"in e)?(e=new window.XDomainRequest,e.onload=p,e.onerror=r,e.onprogress=m(),e.ontimeout=m()):(h="file:"==d.protocol||"file:"==g.protocol,e.onreadystatechange=function(){if(4===e.readyState){if(e.Ye)return r("timeout");200===e.status||h&&0===e.status?p():r()}},a.timeout&&(k=window.setTimeout(function(){4!==e.readyState&&(e.Ye=f,e.abort())},a.timeout)));try{e.open(a.method||
"GET",a.uri,f)}catch(u){r(u);return}a.withCredentials&&(e.withCredentials=f);a.responseType&&(e.responseType=a.responseType);try{e.send()}catch(A){r(A)}};t.$={};t.$.ya=function(a,c){var d,e,g;a=t.i.copy(a);for(d in c)c.hasOwnProperty(d)&&(e=a[d],g=c[d],a[d]=t.i.jb(e)&&t.i.jb(g)?t.$.ya(e,g):c[d]);return a};t.z=m();s=t.z.prototype;s.bb={};s.b=function(a,c){var d=this.addEventListener;this.addEventListener=Function.prototype;t.b(this,a,c);this.addEventListener=d};s.addEventListener=t.z.prototype.b;
s.n=function(a,c){t.n(this,a,c)};s.removeEventListener=t.z.prototype.n;s.N=function(a,c){t.N(this,a,c)};s.o=function(a){var c=a.type||a;"string"===typeof a&&(a={type:c});a=t.Pb(a);if(this.bb[c]&&this["on"+c])this["on"+c](a);t.o(this,a)};s.dispatchEvent=t.z.prototype.o;
t.a=t.Ea.extend({l:function(a,c,d){this.d=a;this.q=t.i.copy(this.q);c=this.options(c);this.Pa=c.id||c.el&&c.el.id;this.Pa||(this.Pa=(a.id&&a.id()||"no_player")+"_component_"+t.s++);this.te=c.name||j;this.c=c.el||this.e();this.R=[];this.fb={};this.gb={};this.Oc();this.I(d);if(c.dd!==l){var e,g;this.k().reportUserActivity&&(e=t.bind(this.k(),this.k().reportUserActivity),this.b("touchstart",function(){e();this.clearInterval(g);g=this.setInterval(e,250)}),a=function(){e();this.clearInterval(g)},this.b("touchmove",
e),this.b("touchend",a),this.b("touchcancel",a))}}});s=t.a.prototype;s.dispose=function(){this.o({type:"dispose",bubbles:l});if(this.R)for(var a=this.R.length-1;0<=a;a--)this.R[a].dispose&&this.R[a].dispose();this.gb=this.fb=this.R=j;this.n();this.c.parentNode&&this.c.parentNode.removeChild(this.c);t.cd(this.c);this.c=j};s.d=f;s.k=n("d");s.options=function(a){return a===b?this.q:this.q=t.$.ya(this.q,a)};s.e=function(a,c){return t.e(a,c)};
s.v=function(a){var c=this.d.language(),d=this.d.languages();return d&&d[c]&&d[c][a]?d[c][a]:a};s.m=n("c");s.va=function(){return this.B||this.c};s.id=n("Pa");s.name=n("te");s.children=n("R");s.ae=function(a){return this.fb[a]};s.ea=function(a){return this.gb[a]};
s.ba=function(a,c){var d,e;"string"===typeof a?(e=a,c=c||{},d=c.componentClass||t.ua(e),c.name=e,d=new window.videojs[d](this.d||this,c)):d=a;this.R.push(d);"function"===typeof d.id&&(this.fb[d.id()]=d);(e=e||d.name&&d.name())&&(this.gb[e]=d);"function"===typeof d.el&&d.el()&&this.va().appendChild(d.el());return d};
s.removeChild=function(a){"string"===typeof a&&(a=this.ea(a));if(a&&this.R){for(var c=l,d=this.R.length-1;0<=d;d--)if(this.R[d]===a){c=f;this.R.splice(d,1);break}c&&(this.fb[a.id()]=j,this.gb[a.name()]=j,(c=a.m())&&c.parentNode===this.va()&&this.va().removeChild(a.m()))}};
s.Oc=function(){var a,c,d,e,g,h;a=this;c=a.options();if(d=c.children)if(h=function(d,e){c[d]!==b&&(e=c[d]);e!==l&&(a[d]=a.ba(d,e))},t.i.isArray(d))for(var k=0;k<d.length;k++)e=d[k],"string"==typeof e?(g=e,e={}):g=e.name,h(g,e);else t.i.da(d,h)};s.V=q("");
s.b=function(a,c,d){var e,g,h;"string"===typeof a||t.i.isArray(a)?t.b(this.c,a,t.bind(this,c)):(e=t.bind(this,d),h=this,g=function(){h.n(a,c,e)},g.s=e.s,this.b("dispose",g),d=function(){h.n("dispose",g)},d.s=e.s,a.nodeName?(t.b(a,c,e),t.b(a,"dispose",d)):"function"===typeof a.b&&(a.b(c,e),a.b("dispose",d)));return this};
s.n=function(a,c,d){!a||"string"===typeof a||t.i.isArray(a)?t.n(this.c,a,c):(d=t.bind(this,d),this.n("dispose",d),a.nodeName?(t.n(a,c,d),t.n(a,"dispose",d)):(a.n(c,d),a.n("dispose",d)));return this};s.N=function(a,c,d){var e,g,h;"string"===typeof a||t.i.isArray(a)?t.N(this.c,a,t.bind(this,c)):(e=t.bind(this,d),g=this,h=function(){g.n(a,c,h);e.apply(this,arguments)},h.s=e.s,this.b(a,c,h));return this};s.o=function(a){t.o(this.c,a);return this};
s.I=function(a){a&&(this.wa?a.call(this):(this.nb===b&&(this.nb=[]),this.nb.push(a)));return this};s.Wa=function(){this.wa=f;var a=this.nb;if(a&&0<a.length){for(var c=0,d=a.length;c<d;c++)a[c].call(this);this.nb=[];this.o("ready")}};s.Oa=function(a){return t.Oa(this.c,a)};s.p=function(a){t.p(this.c,a);return this};s.r=function(a){t.r(this.c,a);return this};s.show=function(){this.r("vjs-hidden");return this};s.Y=function(){this.p("vjs-hidden");return this};function G(a){a.r("vjs-lock-showing")}
s.width=function(a,c){return ca(this,"width",a,c)};s.height=function(a,c){return ca(this,"height",a,c)};s.Td=function(a,c){return this.width(a,f).height(c)};function ca(a,c,d,e){if(d!==b){if(d===j||t.ke(d))d=0;a.c.style[c]=-1!==(""+d).indexOf("%")||-1!==(""+d).indexOf("px")?d:"auto"===d?"":d+"px";e||a.o("resize");return a}if(!a.c)return 0;d=a.c.style[c];e=d.indexOf("px");return-1!==e?parseInt(d.slice(0,e),10):parseInt(a.c["offset"+t.ua(c)],10)}
function da(a){var c,d,e,g,h,k,p,r;c=0;d=j;a.b("touchstart",function(a){1===a.touches.length&&(d=t.i.copy(a.touches[0]),c=(new Date).getTime(),g=f)});a.b("touchmove",function(a){1<a.touches.length?g=l:d&&(k=a.touches[0].pageX-d.pageX,p=a.touches[0].pageY-d.pageY,r=Math.sqrt(k*k+p*p),10<r&&(g=l))});h=function(){g=l};a.b("touchleave",h);a.b("touchcancel",h);a.b("touchend",function(a){d=j;g===f&&(e=(new Date).getTime()-c,200>e&&(a.preventDefault(),this.o("tap")))})}
s.setTimeout=function(a,c){function d(){this.clearTimeout(e)}a=t.bind(this,a);var e=setTimeout(a,c);d.s="vjs-timeout-"+e;this.b("dispose",d);return e};s.clearTimeout=function(a){function c(){}clearTimeout(a);c.s="vjs-timeout-"+a;this.n("dispose",c);return a};s.setInterval=function(a,c){function d(){this.clearInterval(e)}a=t.bind(this,a);var e=setInterval(a,c);d.s="vjs-interval-"+e;this.b("dispose",d);return e};
s.clearInterval=function(a){function c(){}clearInterval(a);c.s="vjs-interval-"+a;this.n("dispose",c);return a};t.w=t.a.extend({l:function(a,c){t.a.call(this,a,c);da(this);this.b("tap",this.u);this.b("click",this.u);this.b("focus",this.lb);this.b("blur",this.kb)}});s=t.w.prototype;
s.e=function(a,c){var d;c=t.i.D({className:this.V(),role:"button","aria-live":"polite",tabIndex:0},c);d=t.a.prototype.e.call(this,a,c);c.innerHTML||(this.B=t.e("div",{className:"vjs-control-content"}),this.Jb=t.e("span",{className:"vjs-control-text",innerHTML:this.v(this.sa)||"Need Text"}),this.B.appendChild(this.Jb),d.appendChild(this.B));return d};s.V=function(){return"vjs-control "+t.a.prototype.V.call(this)};s.u=m();s.lb=function(){t.b(document,"keydown",t.bind(this,this.ka))};
s.ka=function(a){if(32==a.which||13==a.which)a.preventDefault(),this.u()};s.kb=function(){t.n(document,"keydown",t.bind(this,this.ka))};t.U=t.a.extend({l:function(a,c){t.a.call(this,a,c);this.Kd=this.ea(this.q.barName);this.handle=this.ea(this.q.handleName);this.b("mousedown",this.mb);this.b("touchstart",this.mb);this.b("focus",this.lb);this.b("blur",this.kb);this.b("click",this.u);this.b(a,"controlsvisible",this.update);this.b(a,this.Yc,this.update)}});s=t.U.prototype;
s.e=function(a,c){c=c||{};c.className+=" vjs-slider";c=t.i.D({role:"slider","aria-valuenow":0,"aria-valuemin":0,"aria-valuemax":100,tabIndex:0},c);return t.a.prototype.e.call(this,a,c)};s.mb=function(a){a.preventDefault();t.Ld();this.p("vjs-sliding");this.b(document,"mousemove",this.la);this.b(document,"mouseup",this.za);this.b(document,"touchmove",this.la);this.b(document,"touchend",this.za);this.la(a)};s.la=m();
s.za=function(){t.af();this.r("vjs-sliding");this.n(document,"mousemove",this.la);this.n(document,"mouseup",this.za);this.n(document,"touchmove",this.la);this.n(document,"touchend",this.za);this.update()};s.update=function(){if(this.c){var a,c=this.Sb(),d=this.handle,e=this.Kd;if("number"!==typeof c||c!==c||0>c||Infinity===c)c=0;a=c;if(d){a=this.c.offsetWidth;var g=d.m().offsetWidth;a=g?g/a:0;c*=1-a;a=c+a/2;d.m().style.left=t.round(100*c,2)+"%"}e&&(e.m().style.width=t.round(100*a,2)+"%")}};
function ea(a,c){var d,e,g,h;d=a.c;e=t.Yd(d);h=g=d.offsetWidth;d=a.handle;if(a.options().vertical)return h=e.top,e=c.changedTouches?c.changedTouches[0].pageY:c.pageY,d&&(d=d.m().offsetHeight,h+=d/2,g-=d),Math.max(0,Math.min(1,(h-e+g)/g));g=e.left;e=c.changedTouches?c.changedTouches[0].pageX:c.pageX;d&&(d=d.m().offsetWidth,g+=d/2,h-=d);return Math.max(0,Math.min(1,(e-g)/h))}s.lb=function(){this.b(document,"keydown",this.ka)};
s.ka=function(a){if(37==a.which||40==a.which)a.preventDefault(),this.jd();else if(38==a.which||39==a.which)a.preventDefault(),this.kd()};s.kb=function(){this.n(document,"keydown",this.ka)};s.u=function(a){a.stopImmediatePropagation();a.preventDefault()};t.ha=t.a.extend();t.ha.prototype.defaultValue=0;t.ha.prototype.e=function(a,c){c=c||{};c.className+=" vjs-slider-handle";c=t.i.D({innerHTML:'<span class="vjs-control-text">'+this.defaultValue+"</span>"},c);return t.a.prototype.e.call(this,"div",c)};
t.pa=t.a.extend();function fa(a,c){a.ba(c);c.b("click",t.bind(a,function(){G(this)}))}t.pa.prototype.e=function(){var a=this.options().Cc||"ul";this.B=t.e(a,{className:"vjs-menu-content"});a=t.a.prototype.e.call(this,"div",{append:this.B,className:"vjs-menu"});a.appendChild(this.B);t.b(a,"click",function(a){a.preventDefault();a.stopImmediatePropagation()});return a};t.M=t.w.extend({l:function(a,c){t.w.call(this,a,c);this.selected(c.selected)}});
t.M.prototype.e=function(a,c){return t.w.prototype.e.call(this,"li",t.i.D({className:"vjs-menu-item",innerHTML:this.v(this.q.label)},c))};t.M.prototype.u=function(){this.selected(f)};t.M.prototype.selected=function(a){a?(this.p("vjs-selected"),this.c.setAttribute("aria-selected",f)):(this.r("vjs-selected"),this.c.setAttribute("aria-selected",l))};
t.O=t.w.extend({l:function(a,c){t.w.call(this,a,c);this.update();this.b("keydown",this.ka);this.c.setAttribute("aria-haspopup",f);this.c.setAttribute("role","button")}});s=t.O.prototype;s.update=function(){var a=this.Ja();this.xa&&this.removeChild(this.xa);this.xa=a;this.ba(a);this.H&&0===this.H.length?this.Y():this.H&&1<this.H.length&&this.show()};s.Ha=l;
s.Ja=function(){var a=new t.pa(this.d);this.options().title&&a.va().appendChild(t.e("li",{className:"vjs-menu-title",innerHTML:t.ua(this.options().title),We:-1}));if(this.H=this.createItems())for(var c=0;c<this.H.length;c++)fa(a,this.H[c]);return a};s.Ia=m();s.V=function(){return this.className+" vjs-menu-button "+t.w.prototype.V.call(this)};s.lb=m();s.kb=m();s.u=function(){this.N("mouseout",t.bind(this,function(){G(this.xa);this.c.blur()}));this.Ha?H(this):ga(this)};
s.ka=function(a){32==a.which||13==a.which?(this.Ha?H(this):ga(this),a.preventDefault()):27==a.which&&(this.Ha&&H(this),a.preventDefault())};function ga(a){a.Ha=f;a.xa.p("vjs-lock-showing");a.c.setAttribute("aria-pressed",f);a.H&&0<a.H.length&&a.H[0].m().focus()}function H(a){a.Ha=l;G(a.xa);a.c.setAttribute("aria-pressed",l)}t.J=function(a){"number"===typeof a?this.code=a:"string"===typeof a?this.message=a:"object"===typeof a&&t.i.D(this,a);this.message||(this.message=t.J.Sd[this.code]||"")};
t.J.prototype.code=0;t.J.prototype.message="";t.J.prototype.status=j;t.J.hb="MEDIA_ERR_CUSTOM MEDIA_ERR_ABORTED MEDIA_ERR_NETWORK MEDIA_ERR_DECODE MEDIA_ERR_SRC_NOT_SUPPORTED MEDIA_ERR_ENCRYPTED".split(" ");
t.J.Sd={1:"You aborted the video playback",2:"A network error caused the video download to fail part-way.",3:"The video playback was aborted due to a corruption problem or because the video used features your browser did not support.",4:"The video could not be loaded, either because the server or network failed or because the format is not supported.",5:"The video is encrypted and we do not have the keys to decrypt it."};for(var I=0;I<t.J.hb.length;I++)t.J[t.J.hb[I]]=I,t.J.prototype[t.J.hb[I]]=I;
var J,ha,K,L;
J=["requestFullscreen exitFullscreen fullscreenElement fullscreenEnabled fullscreenchange fullscreenerror".split(" "),"webkitRequestFullscreen webkitExitFullscreen webkitFullscreenElement webkitFullscreenEnabled webkitfullscreenchange webkitfullscreenerror".split(" "),"webkitRequestFullScreen webkitCancelFullScreen webkitCurrentFullScreenElement webkitCancelFullScreen webkitfullscreenchange webkitfullscreenerror".split(" "),"mozRequestFullScreen mozCancelFullScreen mozFullScreenElement mozFullScreenEnabled mozfullscreenchange mozfullscreenerror".split(" "),"msRequestFullscreen msExitFullscreen msFullscreenElement msFullscreenEnabled MSFullscreenChange MSFullscreenError".split(" ")];
ha=J[0];for(L=0;L<J.length;L++)if(J[L][1]in document){K=J[L];break}if(K){t.cb.Rb={};for(L=0;L<K.length;L++)t.cb.Rb[ha[L]]=K[L]}
t.Player=t.a.extend({l:function(a,c,d){this.L=a;a.id=a.id||"vjs_video_"+t.s++;this.Xe=a&&t.Na(a);c=t.i.D(ia(a),c);this.Tc=c.language||t.options.language;this.ne=c.languages||t.options.languages;this.K={};this.Zc=c.poster||"";this.Kb=!!c.controls;a.controls=l;c.dd=l;ja(this,"audio"===this.L.nodeName.toLowerCase());t.a.call(this,this,c,d);this.controls()?this.p("vjs-controls-enabled"):this.p("vjs-controls-disabled");ja(this)&&this.p("vjs-audio");t.Aa[this.Pa]=this;c.plugins&&t.i.da(c.plugins,function(a,
c){this[a](c)},this);var e,g,h,k,p;e=t.bind(this,this.reportUserActivity);this.b("mousedown",function(){e();this.clearInterval(g);g=this.setInterval(e,250)});this.b("mousemove",function(a){if(a.screenX!=k||a.screenY!=p)k=a.screenX,p=a.screenY,e()});this.b("mouseup",function(){e();this.clearInterval(g)});this.b("keydown",e);this.b("keyup",e);this.setInterval(function(){if(this.Da){this.Da=l;this.userActive(f);this.clearTimeout(h);var a=this.options().inactivityTimeout;0<a&&(h=this.setTimeout(function(){this.Da||
this.userActive(l)},a))}},250)}});s=t.Player.prototype;s.language=function(a){if(a===b)return this.Tc;this.Tc=a;return this};s.languages=n("ne");s.q=t.options;s.dispose=function(){this.o("dispose");this.n("dispose");t.Aa[this.Pa]=j;this.L&&this.L.player&&(this.L.player=j);this.c&&this.c.player&&(this.c.player=j);this.h&&this.h.dispose();t.a.prototype.dispose.call(this)};
function ia(a){var c,d,e={sources:[],tracks:[]};c=t.Na(a);d=c["data-setup"];d!==j&&t.i.D(c,t.JSON.parse(d||"{}"));t.i.D(e,c);if(a.hasChildNodes()){var g,h;a=a.childNodes;g=0;for(h=a.length;g<h;g++)c=a[g],d=c.nodeName.toLowerCase(),"source"===d?e.sources.push(t.Na(c)):"track"===d&&e.tracks.push(t.Na(c))}return e}
s.e=function(){var a=this.c=t.a.prototype.e.call(this,"div"),c=this.L,d;c.removeAttribute("width");c.removeAttribute("height");d=t.Na(c);t.i.da(d,function(c){"class"==c?a.className=d[c]:a.setAttribute(c,d[c])});c.id+="_html5_api";c.className="vjs-tech";c.player=a.player=this;this.p("vjs-paused");this.width(this.q.width,f);this.height(this.q.height,f);c.ge=c.networkState;c.parentNode&&c.parentNode.insertBefore(a,c);t.Ub(c,a);this.c=a;this.b("loadstart",this.xe);this.b("waiting",this.De);this.b(["canplay",
"canplaythrough","playing","ended"],this.Ce);this.b("seeking",this.Ae);this.b("seeked",this.ze);this.b("ended",this.ue);this.b("play",this.$b);this.b("firstplay",this.ve);this.b("pause",this.Zb);this.b("progress",this.ye);this.b("durationchange",this.Wc);this.b("fullscreenchange",this.we);return a};
function ka(a,c,d){a.h&&(a.wa=l,a.h.dispose(),a.h=l);"Html5"!==c&&a.L&&(t.f.Mb(a.L),a.L=j);a.Ua=c;a.wa=l;var e=t.i.D({source:d,parentEl:a.c},a.q[c.toLowerCase()]);d&&(a.Gc=d.type,d.src==a.K.src&&0<a.K.currentTime&&(e.startTime=a.K.currentTime),a.K.src=d.src);a.h=new window.videojs[c](a,e);a.h.I(function(){this.d.Wa()})}s.xe=function(){this.r("vjs-ended");this.error(j);this.paused()?la(this,l):this.o("firstplay")};s.Nc=l;
function la(a,c){c!==b&&a.Nc!==c&&((a.Nc=c)?(a.p("vjs-has-started"),a.o("firstplay")):a.r("vjs-has-started"))}s.$b=function(){this.r("vjs-ended");this.r("vjs-paused");this.p("vjs-playing");la(this,f)};s.De=function(){this.p("vjs-waiting")};s.Ce=function(){this.r("vjs-waiting")};s.Ae=function(){this.p("vjs-seeking")};s.ze=function(){this.r("vjs-seeking")};s.ve=function(){this.q.starttime&&this.currentTime(this.q.starttime);this.p("vjs-has-started")};s.Zb=function(){this.r("vjs-playing");this.p("vjs-paused")};
s.ye=function(){1==this.bufferedPercent()&&this.o("loadedalldata")};s.ue=function(){this.p("vjs-ended");this.q.loop?(this.currentTime(0),this.play()):this.paused()||this.pause()};s.Wc=function(){var a=M(this,"duration");a&&(0>a&&(a=Infinity),this.duration(a),Infinity===a?this.p("vjs-live"):this.r("vjs-live"))};s.we=function(){this.isFullscreen()?this.p("vjs-fullscreen"):this.r("vjs-fullscreen")};
function N(a,c,d){if(a.h&&!a.h.wa)a.h.I(function(){this[c](d)});else try{a.h[c](d)}catch(e){throw t.log(e),e;}}function M(a,c){if(a.h&&a.h.wa)try{return a.h[c]()}catch(d){throw a.h[c]===b?t.log("Video.js: "+c+" method not defined for "+a.Ua+" playback technology.",d):"TypeError"==d.name?(t.log("Video.js: "+c+" unavailable on "+a.Ua+" playback technology element.",d),a.h.wa=l):t.log(d),d;}}s.play=function(){N(this,"play");return this};s.pause=function(){N(this,"pause");return this};
s.paused=function(){return M(this,"paused")===l?l:f};s.currentTime=function(a){return a!==b?(N(this,"setCurrentTime",a),this):this.K.currentTime=M(this,"currentTime")||0};s.duration=function(a){if(a!==b)return this.K.duration=parseFloat(a),this;this.K.duration===b&&this.Wc();return this.K.duration||0};s.remainingTime=function(){return this.duration()-this.currentTime()};s.buffered=function(){var a=M(this,"buffered");if(!a||!a.length)a=t.Lb(0,0);return a};
s.bufferedPercent=function(){var a=this.duration(),c=this.buffered(),d=0,e,g;if(!a)return 0;for(var h=0;h<c.length;h++)e=c.start(h),g=c.end(h),g>a&&(g=a),d+=g-e;return d/a};s.volume=function(a){if(a!==b)return a=Math.max(0,Math.min(1,parseFloat(a))),this.K.volume=a,N(this,"setVolume",a),t.Me(a),this;a=parseFloat(M(this,"volume"));return isNaN(a)?1:a};s.muted=function(a){return a!==b?(N(this,"setMuted",a),this):M(this,"muted")||l};s.Ta=function(){return M(this,"supportsFullScreen")||l};s.Qc=l;
s.isFullscreen=function(a){return a!==b?(this.Qc=!!a,this):this.Qc};s.isFullScreen=function(a){t.log.warn('player.isFullScreen() has been deprecated, use player.isFullscreen() with a lowercase "s")');return this.isFullscreen(a)};
s.requestFullscreen=function(){var a=t.cb.Rb;this.isFullscreen(f);a?(t.b(document,a.fullscreenchange,t.bind(this,function(c){this.isFullscreen(document[a.fullscreenElement]);this.isFullscreen()===l&&t.n(document,a.fullscreenchange,arguments.callee);this.o("fullscreenchange")})),this.c[a.requestFullscreen]()):this.h.Ta()?N(this,"enterFullScreen"):(this.Jc(),this.o("fullscreenchange"));return this};
s.requestFullScreen=function(){t.log.warn('player.requestFullScreen() has been deprecated, use player.requestFullscreen() with a lowercase "s")');return this.requestFullscreen()};s.exitFullscreen=function(){var a=t.cb.Rb;this.isFullscreen(l);if(a)document[a.exitFullscreen]();else this.h.Ta()?N(this,"exitFullScreen"):(this.Nb(),this.o("fullscreenchange"));return this};s.cancelFullScreen=function(){t.log.warn("player.cancelFullScreen() has been deprecated, use player.exitFullscreen()");return this.exitFullscreen()};
s.Jc=function(){this.je=f;this.Ud=document.documentElement.style.overflow;t.b(document,"keydown",t.bind(this,this.Kc));document.documentElement.style.overflow="hidden";t.p(document.body,"vjs-full-window");this.o("enterFullWindow")};s.Kc=function(a){27===a.keyCode&&(this.isFullscreen()===f?this.exitFullscreen():this.Nb())};s.Nb=function(){this.je=l;t.n(document,"keydown",this.Kc);document.documentElement.style.overflow=this.Ud;t.r(document.body,"vjs-full-window");this.o("exitFullWindow")};
s.selectSource=function(a){for(var c=0,d=this.q.techOrder;c<d.length;c++){var e=t.ua(d[c]),g=window.videojs[e];if(g){if(g.isSupported())for(var h=0,k=a;h<k.length;h++){var p=k[h];if(g.canPlaySource(p))return{source:p,h:e}}}else t.log.error('The "'+e+'" tech is undefined. Skipped browser support check for that tech.')}return l};
s.src=function(a){if(a===b)return M(this,"src");t.i.isArray(a)?ma(this,a):"string"===typeof a?this.src({src:a}):a instanceof Object&&(a.type&&!window.videojs[this.Ua].canPlaySource(a)?ma(this,[a]):(this.K.src=a.src,this.Gc=a.type||"",this.I(function(){window.videojs[this.Ua].prototype.hasOwnProperty("setSource")?N(this,"setSource",a):N(this,"src",a.src);"auto"==this.q.preload&&this.load();this.q.autoplay&&this.play()})));return this};
function ma(a,c){var d=a.selectSource(c);d?d.h===a.Ua?a.src(d.source):ka(a,d.h,d.source):(a.setTimeout(function(){this.error({code:4,message:this.v(this.options().notSupportedMessage)})},0),a.Wa())}s.load=function(){N(this,"load");return this};s.currentSrc=function(){return M(this,"currentSrc")||this.K.src||""};s.Qd=function(){return this.Gc||""};s.Qa=function(a){return a!==b?(N(this,"setPreload",a),this.q.preload=a,this):M(this,"preload")};
s.autoplay=function(a){return a!==b?(N(this,"setAutoplay",a),this.q.autoplay=a,this):M(this,"autoplay")};s.loop=function(a){return a!==b?(N(this,"setLoop",a),this.q.loop=a,this):M(this,"loop")};s.poster=function(a){if(a===b)return this.Zc;a||(a="");this.Zc=a;N(this,"setPoster",a);this.o("posterchange");return this};
s.controls=function(a){return a!==b?(a=!!a,this.Kb!==a&&((this.Kb=a)?(this.r("vjs-controls-disabled"),this.p("vjs-controls-enabled"),this.o("controlsenabled")):(this.r("vjs-controls-enabled"),this.p("vjs-controls-disabled"),this.o("controlsdisabled"))),this):this.Kb};t.Player.prototype.ec;s=t.Player.prototype;
s.usingNativeControls=function(a){return a!==b?(a=!!a,this.ec!==a&&((this.ec=a)?(this.p("vjs-using-native-controls"),this.o("usingnativecontrols")):(this.r("vjs-using-native-controls"),this.o("usingcustomcontrols"))),this):this.ec};s.ja=j;s.error=function(a){if(a===b)return this.ja;if(a===j)return this.ja=a,this.r("vjs-error"),this;this.ja=a instanceof t.J?a:new t.J(a);this.o("error");this.p("vjs-error");t.log.error("(CODE:"+this.ja.code+" "+t.J.hb[this.ja.code]+")",this.ja.message,this.ja);return this};
s.ended=function(){return M(this,"ended")};s.seeking=function(){return M(this,"seeking")};s.Da=f;s.reportUserActivity=function(){this.Da=f};s.dc=f;s.userActive=function(a){return a!==b?(a=!!a,a!==this.dc&&((this.dc=a)?(this.Da=f,this.r("vjs-user-inactive"),this.p("vjs-user-active"),this.o("useractive")):(this.Da=l,this.h&&this.h.N("mousemove",function(a){a.stopPropagation();a.preventDefault()}),this.r("vjs-user-active"),this.p("vjs-user-inactive"),this.o("userinactive"))),this):this.dc};
s.playbackRate=function(a){return a!==b?(N(this,"setPlaybackRate",a),this):this.h&&this.h.featuresPlaybackRate?M(this,"playbackRate"):1};s.Pc=l;function ja(a,c){return c!==b?(a.Pc=!!c,a):a.Pc}s.networkState=function(){return M(this,"networkState")};s.readyState=function(){return M(this,"readyState")};s.textTracks=function(){return this.h&&this.h.textTracks()};s.Z=function(){return this.h&&this.h.remoteTextTracks()};s.addTextTrack=function(a,c,d){return this.h&&this.h.addTextTrack(a,c,d)};
s.ia=function(a){return this.h&&this.h.addRemoteTextTrack(a)};s.Ba=function(a){this.h&&this.h.removeRemoteTextTrack(a)};t.ub=t.a.extend();t.ub.prototype.q={wf:"play",children:{playToggle:{},currentTimeDisplay:{},timeDivider:{},durationDisplay:{},remainingTimeDisplay:{},liveDisplay:{},progressControl:{},fullscreenToggle:{},volumeControl:{},muteToggle:{},playbackRateMenuButton:{},subtitlesButton:{},captionsButton:{},chaptersButton:{}}};t.ub.prototype.e=function(){return t.e("div",{className:"vjs-control-bar"})};
t.kc=t.a.extend({l:function(a,c){t.a.call(this,a,c)}});t.kc.prototype.e=function(){var a=t.a.prototype.e.call(this,"div",{className:"vjs-live-controls vjs-control"});this.B=t.e("div",{className:"vjs-live-display",innerHTML:'<span class="vjs-control-text">'+this.v("Stream Type")+"</span>"+this.v("LIVE"),"aria-live":"off"});a.appendChild(this.B);return a};t.nc=t.w.extend({l:function(a,c){t.w.call(this,a,c);this.b(a,"play",this.$b);this.b(a,"pause",this.Zb)}});s=t.nc.prototype;s.sa="Play";
s.V=function(){return"vjs-play-control "+t.w.prototype.V.call(this)};s.u=function(){this.d.paused()?this.d.play():this.d.pause()};s.$b=function(){this.r("vjs-paused");this.p("vjs-playing");this.c.children[0].children[0].innerHTML=this.v("Pause")};s.Zb=function(){this.r("vjs-playing");this.p("vjs-paused");this.c.children[0].children[0].innerHTML=this.v("Play")};t.vb=t.a.extend({l:function(a,c){t.a.call(this,a,c);this.b(a,"timeupdate",this.ga)}});
t.vb.prototype.e=function(){var a=t.a.prototype.e.call(this,"div",{className:"vjs-current-time vjs-time-controls vjs-control"});this.B=t.e("div",{className:"vjs-current-time-display",innerHTML:'<span class="vjs-control-text">Current Time </span>0:00',"aria-live":"off"});a.appendChild(this.B);return a};t.vb.prototype.ga=function(){var a=this.d.ob?this.d.K.currentTime:this.d.currentTime();this.B.innerHTML='<span class="vjs-control-text">'+this.v("Current Time")+"</span> "+t.Ma(a,this.d.duration())};
t.wb=t.a.extend({l:function(a,c){t.a.call(this,a,c);this.b(a,"timeupdate",this.ga);this.b(a,"loadedmetadata",this.ga)}});t.wb.prototype.e=function(){var a=t.a.prototype.e.call(this,"div",{className:"vjs-duration vjs-time-controls vjs-control"});this.B=t.e("div",{className:"vjs-duration-display",innerHTML:'<span class="vjs-control-text">'+this.v("Duration Time")+"</span> 0:00","aria-live":"off"});a.appendChild(this.B);return a};
t.wb.prototype.ga=function(){var a=this.d.duration();a&&(this.B.innerHTML='<span class="vjs-control-text">'+this.v("Duration Time")+"</span> "+t.Ma(a))};t.tc=t.a.extend({l:function(a,c){t.a.call(this,a,c)}});t.tc.prototype.e=function(){return t.a.prototype.e.call(this,"div",{className:"vjs-time-divider",innerHTML:"<div><span>/</span></div>"})};t.Db=t.a.extend({l:function(a,c){t.a.call(this,a,c);this.b(a,"timeupdate",this.ga)}});
t.Db.prototype.e=function(){var a=t.a.prototype.e.call(this,"div",{className:"vjs-remaining-time vjs-time-controls vjs-control"});this.B=t.e("div",{className:"vjs-remaining-time-display",innerHTML:'<span class="vjs-control-text">'+this.v("Remaining Time")+"</span> -0:00","aria-live":"off"});a.appendChild(this.B);return a};t.Db.prototype.ga=function(){this.d.duration()&&(this.B.innerHTML='<span class="vjs-control-text">'+this.v("Remaining Time")+"</span> -"+t.Ma(this.d.remainingTime()))};
t.Za=t.w.extend({l:function(a,c){t.w.call(this,a,c)}});t.Za.prototype.sa="Fullscreen";t.Za.prototype.V=function(){return"vjs-fullscreen-control "+t.w.prototype.V.call(this)};t.Za.prototype.u=function(){this.d.isFullscreen()?(this.d.exitFullscreen(),this.Jb.innerHTML=this.v("Fullscreen")):(this.d.requestFullscreen(),this.Jb.innerHTML=this.v("Non-Fullscreen"))};t.Cb=t.a.extend({l:function(a,c){t.a.call(this,a,c)}});t.Cb.prototype.q={children:{seekBar:{}}};
t.Cb.prototype.e=function(){return t.a.prototype.e.call(this,"div",{className:"vjs-progress-control vjs-control"})};t.qc=t.U.extend({l:function(a,c){t.U.call(this,a,c);this.b(a,"timeupdate",this.Ca);a.I(t.bind(this,this.Ca))}});s=t.qc.prototype;s.q={children:{loadProgressBar:{},playProgressBar:{},seekHandle:{}},barName:"playProgressBar",handleName:"seekHandle"};s.Yc="timeupdate";s.e=function(){return t.U.prototype.e.call(this,"div",{className:"vjs-progress-holder","aria-label":"video progress bar"})};
s.Ca=function(){var a=this.d.ob?this.d.K.currentTime:this.d.currentTime();this.c.setAttribute("aria-valuenow",t.round(100*this.Sb(),2));this.c.setAttribute("aria-valuetext",t.Ma(a,this.d.duration()))};s.Sb=function(){return this.d.currentTime()/this.d.duration()};s.mb=function(a){t.U.prototype.mb.call(this,a);this.d.ob=f;this.d.p("vjs-scrubbing");this.df=!this.d.paused();this.d.pause()};s.la=function(a){a=ea(this,a)*this.d.duration();a==this.d.duration()&&(a-=0.1);this.d.currentTime(a)};
s.za=function(a){t.U.prototype.za.call(this,a);this.d.ob=l;this.d.r("vjs-scrubbing");this.df&&this.d.play()};s.kd=function(){this.d.currentTime(this.d.currentTime()+5)};s.jd=function(){this.d.currentTime(this.d.currentTime()-5)};t.zb=t.a.extend({l:function(a,c){t.a.call(this,a,c);this.b(a,"progress",this.update)}});t.zb.prototype.e=function(){return t.a.prototype.e.call(this,"div",{className:"vjs-load-progress",innerHTML:'<span class="vjs-control-text"><span>'+this.v("Loaded")+"</span>: 0%</span>"})};
t.zb.prototype.update=function(){var a,c,d,e,g=this.d.buffered();a=this.d.duration();var h,k=this.d;h=k.buffered();k=k.duration();h=h.end(h.length-1);h>k&&(h=k);k=this.c.children;this.c.style.width=100*(h/a||0)+"%";for(a=0;a<g.length;a++)c=g.start(a),d=g.end(a),(e=k[a])||(e=this.c.appendChild(t.e())),e.style.left=100*(c/h||0)+"%",e.style.width=100*((d-c)/h||0)+"%";for(a=k.length;a>g.length;a--)this.c.removeChild(k[a-1])};t.mc=t.a.extend({l:function(a,c){t.a.call(this,a,c)}});
t.mc.prototype.e=function(){return t.a.prototype.e.call(this,"div",{className:"vjs-play-progress",innerHTML:'<span class="vjs-control-text"><span>'+this.v("Progress")+"</span>: 0%</span>"})};t.$a=t.ha.extend({l:function(a,c){t.ha.call(this,a,c);this.b(a,"timeupdate",this.ga)}});t.$a.prototype.defaultValue="00:00";t.$a.prototype.e=function(){return t.ha.prototype.e.call(this,"div",{className:"vjs-seek-handle","aria-live":"off"})};
t.$a.prototype.ga=function(){var a=this.d.ob?this.d.K.currentTime:this.d.currentTime();this.c.innerHTML='<span class="vjs-control-text">'+t.Ma(a,this.d.duration())+"</span>"};t.Gb=t.a.extend({l:function(a,c){t.a.call(this,a,c);a.h&&a.h.featuresVolumeControl===l&&this.p("vjs-hidden");this.b(a,"loadstart",function(){a.h.featuresVolumeControl===l?this.p("vjs-hidden"):this.r("vjs-hidden")})}});t.Gb.prototype.q={children:{volumeBar:{}}};
t.Gb.prototype.e=function(){return t.a.prototype.e.call(this,"div",{className:"vjs-volume-control vjs-control"})};t.Fb=t.U.extend({l:function(a,c){t.U.call(this,a,c);this.b(a,"volumechange",this.Ca);a.I(t.bind(this,this.Ca))}});s=t.Fb.prototype;s.Ca=function(){this.c.setAttribute("aria-valuenow",t.round(100*this.d.volume(),2));this.c.setAttribute("aria-valuetext",t.round(100*this.d.volume(),2)+"%")};s.q={children:{volumeLevel:{},volumeHandle:{}},barName:"volumeLevel",handleName:"volumeHandle"};
s.Yc="volumechange";s.e=function(){return t.U.prototype.e.call(this,"div",{className:"vjs-volume-bar","aria-label":"volume level"})};s.la=function(a){this.d.muted()&&this.d.muted(l);this.d.volume(ea(this,a))};s.Sb=function(){return this.d.muted()?0:this.d.volume()};s.kd=function(){this.d.volume(this.d.volume()+0.1)};s.jd=function(){this.d.volume(this.d.volume()-0.1)};t.uc=t.a.extend({l:function(a,c){t.a.call(this,a,c)}});
t.uc.prototype.e=function(){return t.a.prototype.e.call(this,"div",{className:"vjs-volume-level",innerHTML:'<span class="vjs-control-text"></span>'})};t.Hb=t.ha.extend();t.Hb.prototype.defaultValue="00:00";t.Hb.prototype.e=function(){return t.ha.prototype.e.call(this,"div",{className:"vjs-volume-handle"})};
t.qa=t.w.extend({l:function(a,c){t.w.call(this,a,c);this.b(a,"volumechange",this.update);a.h&&a.h.featuresVolumeControl===l&&this.p("vjs-hidden");this.b(a,"loadstart",function(){a.h.featuresVolumeControl===l?this.p("vjs-hidden"):this.r("vjs-hidden")})}});t.qa.prototype.e=function(){return t.w.prototype.e.call(this,"div",{className:"vjs-mute-control vjs-control",innerHTML:'<div><span class="vjs-control-text">'+this.v("Mute")+"</span></div>"})};
t.qa.prototype.u=function(){this.d.muted(this.d.muted()?l:f)};t.qa.prototype.update=function(){var a=this.d.volume(),c=3;0===a||this.d.muted()?c=0:0.33>a?c=1:0.67>a&&(c=2);this.d.muted()?this.c.children[0].children[0].innerHTML!=this.v("Unmute")&&(this.c.children[0].children[0].innerHTML=this.v("Unmute")):this.c.children[0].children[0].innerHTML!=this.v("Mute")&&(this.c.children[0].children[0].innerHTML=this.v("Mute"));for(a=0;4>a;a++)t.r(this.c,"vjs-vol-"+a);t.p(this.c,"vjs-vol-"+c)};
t.Fa=t.O.extend({l:function(a,c){t.O.call(this,a,c);this.b(a,"volumechange",this.ef);a.h&&a.h.featuresVolumeControl===l&&this.p("vjs-hidden");this.b(a,"loadstart",function(){a.h.featuresVolumeControl===l?this.p("vjs-hidden"):this.r("vjs-hidden")});this.p("vjs-menu-button")}});t.Fa.prototype.Ja=function(){var a=new t.pa(this.d,{Cc:"div"}),c=new t.Fb(this.d,this.q.volumeBar);c.b("focus",function(){a.p("vjs-lock-showing")});c.b("blur",function(){G(a)});a.ba(c);return a};
t.Fa.prototype.u=function(){t.qa.prototype.u.call(this);t.O.prototype.u.call(this)};t.Fa.prototype.e=function(){return t.w.prototype.e.call(this,"div",{className:"vjs-volume-menu-button vjs-menu-button vjs-control",innerHTML:'<div><span class="vjs-control-text">'+this.v("Mute")+"</span></div>"})};t.Fa.prototype.ef=t.qa.prototype.update;t.oc=t.O.extend({l:function(a,c){t.O.call(this,a,c);this.sd();this.rd();this.b(a,"loadstart",this.sd);this.b(a,"ratechange",this.rd)}});s=t.oc.prototype;s.sa="Playback Rate";
s.className="vjs-playback-rate";s.e=function(){var a=t.O.prototype.e.call(this);this.Sc=t.e("div",{className:"vjs-playback-rate-value",innerHTML:1});a.appendChild(this.Sc);return a};s.Ja=function(){var a=new t.pa(this.k()),c=this.k().options().playbackRates;if(c)for(var d=c.length-1;0<=d;d--)a.ba(new t.Bb(this.k(),{rate:c[d]+"x"}));return a};s.Ca=function(){this.m().setAttribute("aria-valuenow",this.k().playbackRate())};
s.u=function(){for(var a=this.k().playbackRate(),c=this.k().options().playbackRates,d=c[0],e=0;e<c.length;e++)if(c[e]>a){d=c[e];break}this.k().playbackRate(d)};function na(a){return a.k().h&&a.k().h.featuresPlaybackRate&&a.k().options().playbackRates&&0<a.k().options().playbackRates.length}s.sd=function(){na(this)?this.r("vjs-hidden"):this.p("vjs-hidden")};s.rd=function(){na(this)&&(this.Sc.innerHTML=this.k().playbackRate()+"x")};
t.Bb=t.M.extend({Cc:"button",l:function(a,c){var d=this.label=c.rate,e=this.$c=parseFloat(d,10);c.label=d;c.selected=1===e;t.M.call(this,a,c);this.b(a,"ratechange",this.update)}});t.Bb.prototype.u=function(){t.M.prototype.u.call(this);this.k().playbackRate(this.$c)};t.Bb.prototype.update=function(){this.selected(this.k().playbackRate()==this.$c)};t.pc=t.w.extend({l:function(a,c){t.w.call(this,a,c);this.update();a.b("posterchange",t.bind(this,this.update))}});s=t.pc.prototype;
s.dispose=function(){this.k().n("posterchange",this.update);t.w.prototype.dispose.call(this)};s.e=function(){var a=t.e("div",{className:"vjs-poster",tabIndex:-1});t.wd||(this.Ob=t.e("img"),a.appendChild(this.Ob));return a};s.update=function(){var a=this.k().poster();this.ma(a);a?this.show():this.Y()};s.ma=function(a){var c;this.Ob?this.Ob.src=a:(c="",a&&(c='url("'+a+'")'),this.c.style.backgroundImage=c)};s.u=function(){this.d.play()};t.lc=t.a.extend({l:function(a,c){t.a.call(this,a,c)}});
t.lc.prototype.e=function(){return t.a.prototype.e.call(this,"div",{className:"vjs-loading-spinner"})};t.sb=t.w.extend();t.sb.prototype.e=function(){return t.w.prototype.e.call(this,"div",{className:"vjs-big-play-button",innerHTML:'<span aria-hidden="true"></span>',"aria-label":"play video"})};t.sb.prototype.u=function(){this.d.play()};t.xb=t.a.extend({l:function(a,c){t.a.call(this,a,c);this.update();this.b(a,"error",this.update)}});
t.xb.prototype.e=function(){var a=t.a.prototype.e.call(this,"div",{className:"vjs-error-display"});this.B=t.e("div");a.appendChild(this.B);return a};t.xb.prototype.update=function(){this.k().error()&&(this.B.innerHTML=this.v(this.k().error().message))};var O;t.j=t.a.extend({l:function(a,c,d){c=c||{};c.dd=l;t.a.call(this,a,c,d);this.featuresProgressEvents||this.re();this.featuresTimeupdateEvents||this.se();this.fe();this.featuresNativeTextTracks||this.Vd();this.he()}});s=t.j.prototype;
s.fe=function(){var a,c;a=this.k();c=function(){a.controls()&&!a.usingNativeControls()&&this.Id()};this.I(c);this.b(a,"controlsenabled",c);this.b(a,"controlsdisabled",this.He);this.I(function(){this.networkState&&0<this.networkState()&&this.k().o("loadstart")})};
s.Id=function(){var a;this.b("mousedown",this.u);this.b("touchstart",function(){a=this.d.userActive()});this.b("touchmove",function(){a&&this.k().reportUserActivity()});this.b("touchend",function(a){a.preventDefault()});da(this);this.b("tap",this.Be)};s.He=function(){this.n("tap");this.n("touchstart");this.n("touchmove");this.n("touchleave");this.n("touchcancel");this.n("touchend");this.n("click");this.n("mousedown")};
s.u=function(a){0===a.button&&this.k().controls()&&(this.k().paused()?this.k().play():this.k().pause())};s.Be=function(){this.k().userActive(!this.k().userActive())};s.re=function(){this.Uc=f;this.$e()};s.qe=function(){this.Uc=l;this.ld()};s.$e=function(){this.Ge=this.setInterval(function(){var a=this.k().bufferedPercent();this.Md!=a&&this.k().o("progress");this.Md=a;1===a&&this.ld()},500)};s.ld=function(){this.clearInterval(this.Ge)};
s.se=function(){var a=this.d;this.Yb=f;this.b(a,"play",this.pd);this.b(a,"pause",this.rb);this.N("timeupdate",function(){this.featuresTimeupdateEvents=f;this.Vc()})};s.Vc=function(){var a=this.d;this.Yb=l;this.rb();this.n(a,"play",this.pd);this.n(a,"pause",this.rb)};s.pd=function(){this.Fc&&this.rb();this.Fc=this.setInterval(function(){this.k().o("timeupdate")},250)};s.rb=function(){this.clearInterval(this.Fc);this.k().o("timeupdate")};s.dispose=function(){this.Uc&&this.qe();this.Yb&&this.Vc();t.a.prototype.dispose.call(this)};
s.bc=function(){this.Yb&&this.k().o("timeupdate")};s.he=function(){function a(){var a=c.ea("textTrackDisplay");a&&a.C()}var c=this.d,d;if(d=this.textTracks())d.addEventListener("removetrack",a),d.addEventListener("addtrack",a),this.b("dispose",t.bind(this,function(){d.removeEventListener("removetrack",a);d.removeEventListener("addtrack",a)}))};
s.Vd=function(){var a=this.d,c,d,e;window.WebVTT||(e=document.createElement("script"),e.src=a.options()["vtt.js"]||"../node_modules/vtt.js/dist/vtt.js",a.m().appendChild(e),window.WebVTT=f);if(d=this.textTracks())c=function(){var c,d,e;e=a.ea("textTrackDisplay");e.C();for(c=0;c<this.length;c++)d=this[c],d.removeEventListener("cuechange",t.bind(e,e.C)),"showing"===d.mode&&d.addEventListener("cuechange",t.bind(e,e.C))},d.addEventListener("change",c),this.b("dispose",t.bind(this,function(){d.removeEventListener("change",
c)}))};s.textTracks=function(){this.d.od=this.d.od||new t.F;return this.d.od};s.Z=function(){this.d.ad=this.d.ad||new t.F;return this.d.ad};O=function(a,c,d,e,g){var h=a.textTracks();g=g||{};g.kind=c;d&&(g.label=d);e&&(g.language=e);g.player=a.d;a=new t.t(g);P(h,a);return a};t.j.prototype.addTextTrack=function(a,c,d){if(!a)throw Error("TextTrack kind is required but was not provided");return O(this,a,c,d)};t.j.prototype.ia=function(a){a=O(this,a.kind,a.label,a.language,a);P(this.Z(),a);return{T:a}};
t.j.prototype.Ba=function(a){Q(this.textTracks(),a);Q(this.Z(),a)};t.j.prototype.fd=m();t.j.prototype.featuresVolumeControl=f;t.j.prototype.featuresFullscreenResize=l;t.j.prototype.featuresPlaybackRate=l;t.j.prototype.featuresProgressEvents=l;t.j.prototype.featuresTimeupdateEvents=l;t.j.prototype.featuresNativeTextTracks=l;
t.j.gc=function(a){a.Ra=function(c,d){var e=a.gd;e||(e=a.gd=[]);d===b&&(d=e.length);e.splice(d,0,c)};a.pb=function(c){for(var d=a.gd||[],e,g=0;g<d.length;g++)if(e=d[g].eb(c))return d[g];return j};a.zc=function(c){var d=a.pb(c);return d?d.eb(c):""};a.prototype.Sa=function(c){var d=a.pb(c);d||(a.S?d=a.S:t.log.error("No source hander found for the current source."));this.Ka();this.n("dispose",this.Ka);this.Ec=c;this.cc=d.Tb(c,this);this.b("dispose",this.Ka);return this};a.prototype.Ka=function(){this.cc&&
this.cc.dispose&&this.cc.dispose()}};t.media={};
t.f=t.j.extend({l:function(a,c,d){var e,g,h;if(c.nativeCaptions===l||c.nativeTextTracks===l)this.featuresNativeTextTracks=l;t.j.call(this,a,c,d);for(d=t.f.yb.length-1;0<=d;d--)this.b(t.f.yb[d],this.Wd);(c=c.source)&&(this.c.currentSrc!==c.src||a.L&&3===a.L.ge)&&this.Sa(c);if(this.c.hasChildNodes()){d=this.c.childNodes;e=d.length;for(c=[];e--;)g=d[e],h=g.nodeName.toLowerCase(),"track"===h&&(this.featuresNativeTextTracks?P(this.Z(),g.track):c.push(g));for(d=0;d<c.length;d++)this.c.removeChild(c[d])}this.featuresNativeTextTracks&&
this.b("loadstart",t.bind(this,this.ee));if(t.Eb&&a.options().nativeControlsForTouch===f){var k,p,r,u;k=this;p=this.k();c=p.controls();k.c.controls=!!c;r=function(){k.c.controls=f};u=function(){k.c.controls=l};p.b("controlsenabled",r);p.b("controlsdisabled",u);c=function(){p.n("controlsenabled",r);p.n("controlsdisabled",u)};k.b("dispose",c);p.b("usingcustomcontrols",c);p.usingNativeControls(f)}a.I(function(){this.src()&&(this.L&&this.q.autoplay&&this.paused())&&(delete this.L.poster,this.play())});
this.Wa()}});s=t.f.prototype;s.dispose=function(){t.f.Mb(this.c);t.j.prototype.dispose.call(this)};
s.e=function(){var a=this.d,c,d,e,g=a.L;if(!g||this.movingMediaElementInDOM===l){g?(e=g.cloneNode(l),t.f.Mb(g),g=e,a.L=j):(g=t.e("video"),e=videojs.$.ya({},a.Xe),(!t.Eb||a.options().nativeControlsForTouch!==f)&&delete e.controls,t.ed(g,t.i.D(e,{id:a.id()+"_html5_api","class":"vjs-tech"})));g.player=a;if(a.q.qd)for(e=0;e<a.q.qd.length;e++)c=a.q.qd[e],d=document.createElement("track"),d.Wb=c.Wb,d.label=c.label,d.hd=c.hd,d.src=c.src,"default"in c&&d.setAttribute("default","default"),g.appendChild(d);
t.Ub(g,a.m())}c=["autoplay","preload","loop","muted"];for(e=c.length-1;0<=e;e--){d=c[e];var h={};"undefined"!==typeof a.q[d]&&(h[d]=a.q[d]);t.ed(g,h)}return g};s.ee=function(){for(var a=this.c.querySelectorAll("track"),c,d=a.length,e={captions:1,subtitles:1};d--;)if((c=a[d].T)&&c.kind in e&&!a[d]["default"])c.mode="disabled"};s.Wd=function(a){"error"==a.type&&this.error()?this.k().error(this.error().code):(a.bubbles=l,this.k().o(a))};s.play=function(){this.c.play()};s.pause=function(){this.c.pause()};
s.paused=function(){return this.c.paused};s.currentTime=function(){return this.c.currentTime};s.bc=function(a){try{this.c.currentTime=a}catch(c){t.log(c,"Video is not ready. (Video.js)")}};s.duration=function(){return this.c.duration||0};s.buffered=function(){return this.c.buffered};s.volume=function(){return this.c.volume};s.Se=function(a){this.c.volume=a};s.muted=function(){return this.c.muted};s.Oe=function(a){this.c.muted=a};s.width=function(){return this.c.offsetWidth};s.height=function(){return this.c.offsetHeight};
s.Ta=function(){return"function"==typeof this.c.webkitEnterFullScreen&&(/Android/.test(t.P)||!/Chrome|Mac OS X 10.5/.test(t.P))?f:l};s.Ic=function(){var a=this.c;"webkitDisplayingFullscreen"in a&&this.N("webkitbeginfullscreen",function(){this.d.isFullscreen(f);this.N("webkitendfullscreen",function(){this.d.isFullscreen(l);this.d.o("fullscreenchange")});this.d.o("fullscreenchange")});a.paused&&a.networkState<=a.jf?(this.c.play(),this.setTimeout(function(){a.pause();a.webkitEnterFullScreen()},0)):a.webkitEnterFullScreen()};
s.Xd=function(){this.c.webkitExitFullScreen()};s.src=function(a){if(a===b)return this.c.src;this.ma(a)};s.ma=function(a){this.c.src=a};s.load=function(){this.c.load()};s.currentSrc=function(){return this.c.currentSrc};s.poster=function(){return this.c.poster};s.fd=function(a){this.c.poster=a};s.Qa=function(){return this.c.Qa};s.Qe=function(a){this.c.Qa=a};s.autoplay=function(){return this.c.autoplay};s.Le=function(a){this.c.autoplay=a};s.controls=function(){return this.c.controls};s.loop=function(){return this.c.loop};
s.Ne=function(a){this.c.loop=a};s.error=function(){return this.c.error};s.seeking=function(){return this.c.seeking};s.ended=function(){return this.c.ended};s.playbackRate=function(){return this.c.playbackRate};s.Pe=function(a){this.c.playbackRate=a};s.networkState=function(){return this.c.networkState};s.readyState=function(){return this.c.readyState};s.textTracks=function(){return!this.featuresNativeTextTracks?t.j.prototype.textTracks.call(this):this.c.textTracks};
s.addTextTrack=function(a,c,d){return!this.featuresNativeTextTracks?t.j.prototype.addTextTrack.call(this,a,c,d):this.c.addTextTrack(a,c,d)};
s.ia=function(a){if(!this.featuresNativeTextTracks)return t.j.prototype.ia.call(this,a);var c=document.createElement("track");a=a||{};a.kind&&(c.kind=a.kind);a.label&&(c.label=a.label);if(a.language||a.srclang)c.srclang=a.language||a.srclang;a["default"]&&(c["default"]=a["default"]);a.id&&(c.id=a.id);a.src&&(c.src=a.src);this.m().appendChild(c);c.track.mode="metadata"===c.T.kind?"hidden":"disabled";c.onload=function(){var a=c.track;2<=c.readyState&&("metadata"===a.kind&&"hidden"!==a.mode?a.mode="hidden":
"metadata"!==a.kind&&"disabled"!==a.mode&&(a.mode="disabled"),c.onload=j)};P(this.Z(),c.T);return c};s.Ba=function(a){if(!this.featuresNativeTextTracks)return t.j.prototype.Ba.call(this,a);var c,d;Q(this.Z(),a);c=this.m().querySelectorAll("track");for(d=0;d<c.length;d++)if(c[d]===a||c[d].track===a){c[d].parentNode.removeChild(c[d]);break}};t.f.isSupported=function(){try{t.A.volume=0.5}catch(a){return l}return!!t.A.canPlayType};t.j.gc(t.f);t.f.S={};
t.f.S.eb=function(a){function c(a){try{return t.A.canPlayType(a)}catch(c){return""}}return a.type?c(a.type):a.src?(a=(a=a.src.match(/\.([^.\/\?]+)(\?[^\/]+)?$/i))&&a[1],c("video/"+a)):""};t.f.S.Tb=function(a,c){c.ma(a.src)};t.f.S.dispose=m();t.f.Ra(t.f.S);t.f.Od=function(){var a=t.A.volume;t.A.volume=a/2+0.1;return a!==t.A.volume};t.f.Nd=function(){var a=t.A.playbackRate;t.A.playbackRate=a/2+0.1;return a!==t.A.playbackRate};
t.f.Ve=function(){var a;(a=!!t.A.textTracks)&&0<t.A.textTracks.length&&(a="number"!==typeof t.A.textTracks[0].mode);a&&t.jc&&(a=l);return a};t.f.prototype.featuresVolumeControl=t.f.Od();t.f.prototype.featuresPlaybackRate=t.f.Nd();t.f.prototype.movingMediaElementInDOM=!t.Ad;t.f.prototype.featuresFullscreenResize=f;t.f.prototype.featuresProgressEvents=f;t.f.prototype.featuresNativeTextTracks=t.f.Ve();var S,oa=/^application\/(?:x-|vnd\.apple\.)mpegurl/i,pa=/^video\/mp4/i;
t.f.Xc=function(){4<=t.hc&&(S||(S=t.A.constructor.prototype.canPlayType),t.A.constructor.prototype.canPlayType=function(a){return a&&oa.test(a)?"maybe":S.call(this,a)});t.Ed&&(S||(S=t.A.constructor.prototype.canPlayType),t.A.constructor.prototype.canPlayType=function(a){return a&&pa.test(a)?"maybe":S.call(this,a)})};t.f.bf=function(){var a=t.A.constructor.prototype.canPlayType;t.A.constructor.prototype.canPlayType=S;S=j;return a};t.f.Xc();t.f.yb="loadstart suspend abort error emptied stalled loadedmetadata loadeddata canplay canplaythrough playing waiting seeking seeked ended durationchange timeupdate progress play pause ratechange volumechange".split(" ");
t.f.Mb=function(a){if(a){a.player=j;for(a.parentNode&&a.parentNode.removeChild(a);a.hasChildNodes();)a.removeChild(a.firstChild);a.removeAttribute("src");if("function"===typeof a.load)try{a.load()}catch(c){}}};
t.g=t.j.extend({l:function(a,c,d){t.j.call(this,a,c,d);var e=c.source;d=a.id()+"_flash_api";var g=a.q,g=t.i.D({readyFunction:"videojs.Flash.onReady",eventProxyFunction:"videojs.Flash.onEvent",errorEventProxyFunction:"videojs.Flash.onError",autoplay:g.autoplay,preload:g.Qa,loop:g.loop,muted:g.muted},c.flashVars),h=t.i.D({wmode:"opaque",bgcolor:"#000000"},c.params);d=t.i.D({id:d,name:d,"class":"vjs-tech"},c.attributes);e&&this.I(function(){this.Sa(e)});t.Ub(this.c,c.parentEl);c.startTime&&this.I(function(){this.load();
this.play();this.currentTime(c.startTime)});t.jc&&this.I(function(){this.b("mousemove",function(){this.k().o({type:"mousemove",bubbles:l})})});a.b("stageclick",a.reportUserActivity);this.c=t.g.Hc(c.swf,this.c,g,h,d)}});s=t.g.prototype;s.dispose=function(){t.j.prototype.dispose.call(this)};s.play=function(){this.c.vjs_play()};s.pause=function(){this.c.vjs_pause()};s.src=function(a){return a===b?this.currentSrc():this.ma(a)};
s.ma=function(a){a=t.$d(a);this.c.vjs_src(a);if(this.d.autoplay()){var c=this;this.setTimeout(function(){c.play()},0)}};t.g.prototype.setCurrentTime=function(a){this.oe=a;this.c.vjs_setProperty("currentTime",a);t.j.prototype.bc.call(this)};t.g.prototype.currentTime=function(){return this.seeking()?this.oe||0:this.c.vjs_getProperty("currentTime")};t.g.prototype.currentSrc=function(){return this.Ec?this.Ec.src:this.c.vjs_getProperty("currentSrc")};t.g.prototype.load=function(){this.c.vjs_load()};
t.g.prototype.poster=function(){this.c.vjs_getProperty("poster")};t.g.prototype.setPoster=m();t.g.prototype.buffered=function(){return t.Lb(0,this.c.vjs_getProperty("buffered"))};t.g.prototype.Ta=q(l);t.g.prototype.Ic=q(l);function qa(){var a=T[U],c=a.charAt(0).toUpperCase()+a.slice(1);ra["set"+c]=function(c){return this.c.vjs_setProperty(a,c)}}function sa(a){ra[a]=function(){return this.c.vjs_getProperty(a)}}
var ra=t.g.prototype,T="rtmpConnection rtmpStream preload defaultPlaybackRate playbackRate autoplay loop mediaGroup controller controls volume muted defaultMuted".split(" "),ta="error networkState readyState seeking initialTime duration startOffsetTime paused played seekable ended videoTracks audioTracks videoWidth videoHeight".split(" "),U;for(U=0;U<T.length;U++)sa(T[U]),qa();for(U=0;U<ta.length;U++)sa(ta[U]);t.g.isSupported=function(){return 10<=t.g.version()[0]};t.j.gc(t.g);t.g.S={};
t.g.S.eb=function(a){return!a.type?"":a.type.replace(/;.*/,"").toLowerCase()in t.g.Zd?"maybe":""};t.g.S.Tb=function(a,c){c.ma(a.src)};t.g.S.dispose=m();t.g.Ra(t.g.S);t.g.Zd={"video/flv":"FLV","video/x-flv":"FLV","video/mp4":"MP4","video/m4v":"MP4"};t.g.onReady=function(a){var c;if(c=(a=t.m(a))&&a.parentNode&&a.parentNode.player)a.player=c,t.g.checkReady(c.h)};t.g.checkReady=function(a){a.m()&&(a.m().vjs_getProperty?a.Wa():this.setTimeout(function(){t.g.checkReady(a)},50))};
t.g.onEvent=function(a,c){t.m(a).player.o(c)};t.g.onError=function(a,c){var d=t.m(a).player,e="FLASH: "+c;"srcnotfound"==c?d.error({code:4,message:e}):d.error(e)};
t.g.version=function(){var a="0,0,0";try{a=(new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash")).GetVariable("$version").replace(/\D+/g,",").match(/^,?(.+),?$/)[1]}catch(c){try{navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin&&(a=(navigator.plugins["Shockwave Flash 2.0"]||navigator.plugins["Shockwave Flash"]).description.replace(/\D+/g,",").match(/^,?(.+),?$/)[1])}catch(d){}}return a.split(",")};
t.g.Hc=function(a,c,d,e,g){a=t.g.ce(a,d,e,g);a=t.e("div",{innerHTML:a}).childNodes[0];d=c.parentNode;c.parentNode.replaceChild(a,c);a[t.expando]=c[t.expando];var h=d.childNodes[0];setTimeout(function(){h.style.display="block"},1E3);return a};
t.g.ce=function(a,c,d,e){var g="",h="",k="";c&&t.i.da(c,function(a,c){g+=a+"="+c+"&amp;"});d=t.i.D({movie:a,flashvars:g,allowScriptAccess:"always",allowNetworking:"all"},d);t.i.da(d,function(a,c){h+='<param name="'+a+'" value="'+c+'" />'});e=t.i.D({data:a,width:"100%",height:"100%"},e);t.i.da(e,function(a,c){k+=a+'="'+c+'" '});return'<object type="application/x-shockwave-flash" '+k+">"+h+"</object>"};t.g.Ue={"rtmp/mp4":"MP4","rtmp/flv":"FLV"};t.g.Hf=function(a,c){return a+"&"+c};
t.g.Te=function(a){var c={Bc:"",md:""};if(!a)return c;var d=a.indexOf("&"),e;-1!==d?e=d+1:(d=e=a.lastIndexOf("/")+1,0===d&&(d=e=a.length));c.Bc=a.substring(0,d);c.md=a.substring(e,a.length);return c};t.g.me=function(a){return a in t.g.Ue};t.g.Gd=/^rtmp[set]?:\/\//i;t.g.le=function(a){return t.g.Gd.test(a)};t.g.ac={};t.g.ac.eb=function(a){return t.g.me(a.type)||t.g.le(a.src)?"maybe":""};t.g.ac.Tb=function(a,c){var d=t.g.Te(a.src);c.setRtmpConnection(d.Bc);c.setRtmpStream(d.md)};t.g.Ra(t.g.ac);
t.Fd=t.a.extend({l:function(a,c,d){t.a.call(this,a,c,d);if(!a.q.sources||0===a.q.sources.length){c=0;for(d=a.q.techOrder;c<d.length;c++){var e=t.ua(d[c]),g=window.videojs[e];if(g&&g.isSupported()){ka(a,e);break}}}else a.src(a.q.sources)}});t.rc={disabled:"disabled",hidden:"hidden",showing:"showing"};t.Hd={subtitles:"subtitles",captions:"captions",descriptions:"descriptions",chapters:"chapters",metadata:"metadata"};
t.t=function(a){var c,d,e,g,h,k,p,r,u,A,R;a=a||{};if(!a.player)throw Error("A player was not provided.");c=this;if(t.oa)for(R in c=document.createElement("custom"),t.t.prototype)c[R]=t.t.prototype[R];c.d=a.player;e=t.rc[a.mode]||"disabled";g=t.Hd[a.kind]||"subtitles";h=a.label||"";k=a.language||a.srclang||"";d=a.id||"vjs_text_track_"+t.s++;if("metadata"===g||"chapters"===g)e="hidden";c.X=[];c.Ga=[];p=new t.W(c.X);r=new t.W(c.Ga);A=l;u=t.bind(c,function(){this.activeCues;A&&(this.trigger("cuechange"),
A=l)});"disabled"!==e&&c.d.b("timeupdate",u);Object.defineProperty(c,"kind",{get:function(){return g},set:Function.prototype});Object.defineProperty(c,"label",{get:function(){return h},set:Function.prototype});Object.defineProperty(c,"language",{get:function(){return k},set:Function.prototype});Object.defineProperty(c,"id",{get:function(){return d},set:Function.prototype});Object.defineProperty(c,"mode",{get:function(){return e},set:function(a){t.rc[a]&&(e=a,"showing"===e&&this.d.b("timeupdate",u),
this.o("modechange"))}});Object.defineProperty(c,"cues",{get:function(){return!this.Xb?j:p},set:Function.prototype});Object.defineProperty(c,"activeCues",{get:function(){var a,c,d,e,g;if(!this.Xb)return j;if(0===this.cues.length)return r;e=this.d.currentTime();a=0;c=this.cues.length;for(d=[];a<c;a++)g=this.cues[a],g.startTime<=e&&g.endTime>=e?d.push(g):g.startTime===g.endTime&&(g.startTime<=e&&g.startTime+0.5>=e)&&d.push(g);A=l;if(d.length!==this.Ga.length)A=f;else for(a=0;a<d.length;a++)-1===ua.call(this.Ga,
d[a])&&(A=f);this.Ga=d;r.qb(this.Ga);return r},set:Function.prototype});a.src?va(a.src,c):c.Xb=f;if(t.oa)return c};t.t.prototype=t.i.create(t.z.prototype);t.t.prototype.constructor=t.t;t.t.prototype.bb={cuechange:"cuechange"};t.t.prototype.vc=function(a){var c=this.d.textTracks(),d=0;if(c)for(;d<c.length;d++)c[d]!==this&&c[d].bd(a);this.X.push(a);this.cues.qb(this.X)};t.t.prototype.bd=function(a){for(var c=0,d=this.X.length,e,g=l;c<d;c++)e=this.X[c],e===a&&(this.X.splice(c,1),g=f);g&&this.Dc.qb(this.X)};
var va,V,ua;va=function(a,c){t.ff(a,t.bind(this,function(a,e,g){if(a)return t.log.error(a);c.Xb=f;V(g,c)}))};V=function(a,c){if("function"!==typeof window.WebVTT)window.setTimeout(function(){V(a,c)},25);else{var d=new window.WebVTT.Parser(window,window.vttjs,window.WebVTT.StringDecoder());d.oncue=function(a){c.vc(a)};d.onparsingerror=function(a){t.log.error(a)};d.parse(a);d.flush()}};
ua=function(a,c){var d;if(this==j)throw new TypeError('"this" is null or not defined');var e=Object(this),g=e.length>>>0;if(0===g)return-1;d=+c||0;Infinity===Math.abs(d)&&(d=0);if(d>=g)return-1;for(d=Math.max(0<=d?d:g-Math.abs(d),0);d<g;){if(d in e&&e[d]===a)return d;d++}return-1};
t.F=function(a){var c=this,d,e=0;if(t.oa)for(d in c=document.createElement("custom"),t.F.prototype)c[d]=t.F.prototype[d];a=a||[];c.Va=[];for(Object.defineProperty(c,"length",{get:function(){return this.Va.length}});e<a.length;e++)P(c,a[e]);if(t.oa)return c};t.F.prototype=t.i.create(t.z.prototype);t.F.prototype.constructor=t.F;t.F.prototype.bb={change:"change",addtrack:"addtrack",removetrack:"removetrack"};for(var wa in t.F.prototype.bb)t.F.prototype["on"+wa]=j;
function P(a,c){var d=a.Va.length;""+d in a||Object.defineProperty(a,d,{get:function(){return this.Va[d]}});c.addEventListener("modechange",t.bind(a,function(){this.o("change")}));a.Va.push(c);a.o({type:"addtrack",T:c})}function Q(a,c){for(var d=0,e=a.length,g;d<e;d++)if(g=a[d],g===c){a.Va.splice(d,1);break}a.o({type:"removetrack",T:c})}t.F.prototype.de=function(a){for(var c=0,d=this.length,e=j,g;c<d;c++)if(g=this[c],g.id===a){e=g;break}return e};
t.W=function(a){var c=this,d;if(t.oa)for(d in c=document.createElement("custom"),t.W.prototype)c[d]=t.W.prototype[d];t.W.prototype.qb.call(c,a);Object.defineProperty(c,"length",{get:n("pe")});if(t.oa)return c};t.W.prototype.qb=function(a){var c=this.length||0,d=0,e=a.length;this.X=a;this.pe=a.length;a=function(a){""+a in this||Object.defineProperty(this,""+a,{get:function(){return this.X[a]}})};if(c<e)for(d=c;d<e;d++)a.call(this,d)};
t.W.prototype.be=function(a){for(var c=0,d=this.length,e=j,g;c<d;c++)if(g=this[c],g.id===a){e=g;break}return e};t.ra=t.a.extend({l:function(a,c,d){t.a.call(this,a,c,d);a.b("loadstart",t.bind(this,this.Ze));a.I(t.bind(this,function(){if(a.h&&a.h.featuresNativeTextTracks)this.Y();else{var c,d,h;a.b("fullscreenchange",t.bind(this,this.C));d=a.q.tracks||[];for(c=0;c<d.length;c++)h=d[c],this.d.ia(h)}}))}});t.ra.prototype.Ze=function(){this.d.h&&this.d.h.featuresNativeTextTracks?this.Y():this.show()};
t.ra.prototype.e=function(){return t.a.prototype.e.call(this,"div",{className:"vjs-text-track-display"})};t.ra.prototype.Pd=function(){"function"===typeof window.WebVTT&&window.WebVTT.processCues(window,[],this.c)};function W(a,c){return"rgba("+parseInt(a[1]+a[1],16)+","+parseInt(a[2]+a[2],16)+","+parseInt(a[3]+a[3],16)+","+c+")"}
var xa={xf:"monospace",Df:"sans-serif",Ff:"serif",yf:'"Andale Mono", "Lucida Console", monospace',zf:'"Courier New", monospace',Bf:"sans-serif",Cf:"serif",of:'"Comic Sans MS", Impact, fantasy',Ef:'"Monotype Corsiva", cursive',Gf:'"Andale Mono", "Lucida Console", monospace, sans-serif'};t.ra.prototype.C=function(){var a=this.d.textTracks(),c=0,d;this.Pd();if(a)for(;c<a.length;c++)d=a[c],"showing"===d.mode&&this.cf(d)};
t.ra.prototype.cf=function(a){if("function"===typeof window.WebVTT&&a.activeCues){for(var c=0,d=this.d.textTrackSettings.Lc(),e,g=[];c<a.activeCues.length;c++)g.push(a.activeCues[c]);window.WebVTT.processCues(window,a.activeCues,this.c);for(c=g.length;c--;){a=g[c].pf;d.color&&(a.firstChild.style.color=d.color);if(d.nd)try{a.firstChild.style.color=W(d.color||"#fff",d.nd)}catch(h){}d.backgroundColor&&(a.firstChild.style.backgroundColor=d.backgroundColor);if(d.yc)try{a.firstChild.style.backgroundColor=
W(d.backgroundColor||"#000",d.yc)}catch(k){}if(d.fc)if(d.ud)try{a.style.backgroundColor=W(d.fc,d.ud)}catch(p){}else a.style.backgroundColor=d.fc;d.La&&("dropshadow"===d.La?a.firstChild.style.textShadow="2px 2px 3px #222, 2px 2px 4px #222, 2px 2px 5px #222":"raised"===d.La?a.firstChild.style.textShadow="1px 1px #222, 2px 2px #222, 3px 3px #222":"depressed"===d.La?a.firstChild.style.textShadow="1px 1px #ccc, 0 1px #ccc, -1px -1px #222, 0 -1px #222":"uniform"===d.La&&(a.firstChild.style.textShadow="0 0 4px #222, 0 0 4px #222, 0 0 4px #222, 0 0 4px #222"));
d.Qb&&1!==d.Qb&&(e=window.Af(a.style.fontSize),a.style.fontSize=e*d.Qb+"px",a.style.height="auto",a.style.top="auto",a.style.bottom="2px");d.fontFamily&&"default"!==d.fontFamily&&("small-caps"===d.fontFamily?a.firstChild.style.fontVariant="small-caps":a.firstChild.style.fontFamily=xa[d.fontFamily])}}};
t.aa=t.M.extend({l:function(a,c){var d=this.T=c.track,e=a.textTracks(),g,h;e&&(g=t.bind(this,function(){var a="showing"===this.T.mode,c,d,g;if(this instanceof t.Ab){a=f;d=0;for(g=e.length;d<g;d++)if(c=e[d],c.kind===this.T.kind&&"showing"===c.mode){a=l;break}}this.selected(a)}),e.addEventListener("change",g),a.b("dispose",function(){e.removeEventListener("change",g)}));c.label=d.label||d.language||"Unknown";c.selected=d["default"]||"showing"===d.mode;t.M.call(this,a,c);e&&e.onchange===b&&this.b(["tap",
"click"],function(){if("object"!==typeof window.yd)try{h=new window.yd("change")}catch(a){}h||(h=document.createEvent("Event"),h.initEvent("change",f,f));e.dispatchEvent(h)})}});t.aa.prototype.u=function(){var a=this.T.kind,c=this.d.textTracks(),d,e=0;t.M.prototype.u.call(this);if(c)for(;e<c.length;e++)d=c[e],d.kind===a&&(d.mode=d===this.T?"showing":"disabled")};t.Ab=t.aa.extend({l:function(a,c){c.track={kind:c.kind,player:a,label:c.kind+" off","default":l,mode:"disabled"};t.aa.call(this,a,c);this.selected(f)}});
t.tb=t.aa.extend({l:function(a,c){c.track={kind:c.kind,player:a,label:c.kind+" settings","default":l,mode:"disabled"};t.aa.call(this,a,c);this.p("vjs-texttrack-settings")}});t.tb.prototype.u=function(){this.k().ea("textTrackSettings").show()};
t.Q=t.O.extend({l:function(a,c){var d,e;t.O.call(this,a,c);d=this.d.textTracks();1>=this.H.length&&this.Y();d&&(e=t.bind(this,this.update),d.addEventListener("removetrack",e),d.addEventListener("addtrack",e),this.d.b("dispose",function(){d.removeEventListener("removetrack",e);d.removeEventListener("addtrack",e)}))}});
t.Q.prototype.Ia=function(){var a=[],c,d;this instanceof t.na&&(!this.k().h||!this.k().h.featuresNativeTextTracks)&&a.push(new t.tb(this.d,{kind:this.fa}));a.push(new t.Ab(this.d,{kind:this.fa}));d=this.d.textTracks();if(!d)return a;for(var e=0;e<d.length;e++)c=d[e],c.kind===this.fa&&a.push(new t.aa(this.d,{track:c}));return a};t.na=t.Q.extend({l:function(a,c,d){t.Q.call(this,a,c,d);this.c.setAttribute("aria-label","Captions Menu")}});t.na.prototype.fa="captions";t.na.prototype.sa="Captions";
t.na.prototype.className="vjs-captions-button";t.na.prototype.update=function(){var a=2;t.Q.prototype.update.call(this);this.k().h&&this.k().h.featuresNativeTextTracks&&(a=1);this.H&&this.H.length>a?this.show():this.Y()};t.ab=t.Q.extend({l:function(a,c,d){t.Q.call(this,a,c,d);this.c.setAttribute("aria-label","Subtitles Menu")}});t.ab.prototype.fa="subtitles";t.ab.prototype.sa="Subtitles";t.ab.prototype.className="vjs-subtitles-button";
t.Xa=t.Q.extend({l:function(a,c,d){t.Q.call(this,a,c,d);this.c.setAttribute("aria-label","Chapters Menu")}});s=t.Xa.prototype;s.fa="chapters";s.sa="Chapters";s.className="vjs-chapters-button";s.Ia=function(){var a=[],c,d;d=this.d.textTracks();if(!d)return a;for(var e=0;e<d.length;e++)c=d[e],c.kind===this.fa&&a.push(new t.aa(this.d,{track:c}));return a};
s.Ja=function(){for(var a=this.d.textTracks()||[],c=0,d=a.length,e,g,h=this.H=[];c<d;c++)if(e=a[c],e.kind==this.fa)if(e.Dc){g=e;break}else e.mode="hidden",window.setTimeout(t.bind(this,function(){this.Ja()}),100);a=this.xa;a===b&&(a=new t.pa(this.d),a.va().appendChild(t.e("li",{className:"vjs-menu-title",innerHTML:t.ua(this.fa),We:-1})));if(g){e=g.cues;for(var k,c=0,d=e.length;c<d;c++)k=e[c],k=new t.Ya(this.d,{track:g,cue:k}),h.push(k),a.ba(k);this.ba(a)}0<this.H.length&&this.show();return a};
t.Ya=t.M.extend({l:function(a,c){var d=this.T=c.track,e=this.cue=c.cue,g=a.currentTime();c.label=e.text;c.selected=e.startTime<=g&&g<e.endTime;t.M.call(this,a,c);d.addEventListener("cuechange",t.bind(this,this.update))}});t.Ya.prototype.u=function(){t.M.prototype.u.call(this);this.d.currentTime(this.cue.startTime);this.update(this.cue.startTime)};t.Ya.prototype.update=function(){var a=this.cue,c=this.d.currentTime();this.selected(a.startTime<=c&&c<a.endTime)};
function X(a){var c;a.Ke?c=a.Ke[0]:a.options&&(c=a.options[a.options.selectedIndex]);return c.value}function Y(a,c){var d,e;if(c){for(d=0;d<a.options.length&&!(e=a.options[d],e.value===c);d++);a.selectedIndex=d}}
t.sc=t.a.extend({l:function(a,c){t.a.call(this,a,c);this.Y();t.b(this.m().querySelector(".vjs-done-button"),"click",t.bind(this,function(){this.Je();this.Y()}));t.b(this.m().querySelector(".vjs-default-button"),"click",t.bind(this,function(){this.m().querySelector(".vjs-fg-color > select").selectedIndex=0;this.m().querySelector(".vjs-bg-color > select").selectedIndex=0;this.m().querySelector(".window-color > select").selectedIndex=0;this.m().querySelector(".vjs-text-opacity > select").selectedIndex=
0;this.m().querySelector(".vjs-bg-opacity > select").selectedIndex=0;this.m().querySelector(".vjs-window-opacity > select").selectedIndex=0;this.m().querySelector(".vjs-edge-style select").selectedIndex=0;this.m().querySelector(".vjs-font-family select").selectedIndex=0;this.m().querySelector(".vjs-font-percent select").selectedIndex=2;this.C()}));t.b(this.m().querySelector(".vjs-fg-color > select"),"change",t.bind(this,this.C));t.b(this.m().querySelector(".vjs-bg-color > select"),"change",t.bind(this,
this.C));t.b(this.m().querySelector(".window-color > select"),"change",t.bind(this,this.C));t.b(this.m().querySelector(".vjs-text-opacity > select"),"change",t.bind(this,this.C));t.b(this.m().querySelector(".vjs-bg-opacity > select"),"change",t.bind(this,this.C));t.b(this.m().querySelector(".vjs-window-opacity > select"),"change",t.bind(this,this.C));t.b(this.m().querySelector(".vjs-font-percent select"),"change",t.bind(this,this.C));t.b(this.m().querySelector(".vjs-edge-style select"),"change",t.bind(this,
this.C));t.b(this.m().querySelector(".vjs-font-family select"),"change",t.bind(this,this.C));a.options().persistTextTrackSettings&&this.Ie()}});s=t.sc.prototype;s.e=function(){return t.a.prototype.e.call(this,"div",{className:"vjs-caption-settings vjs-modal-overlay",innerHTML:'<div class="vjs-tracksettings"><div class="vjs-tracksettings-colors"><div class="vjs-fg-color vjs-tracksetting"><label class="vjs-label">Foreground</label><select><option value="">---</option><option value="#FFF">White</option><option value="#000">Black</option><option value="#F00">Red</option><option value="#0F0">Green</option><option value="#00F">Blue</option><option value="#FF0">Yellow</option><option value="#F0F">Magenta</option><option value="#0FF">Cyan</option></select><span class="vjs-text-opacity vjs-opacity"><select><option value="">---</option><option value="1">Opaque</option><option value="0.5">Semi-Opaque</option></select></span></div><div class="vjs-bg-color vjs-tracksetting"><label class="vjs-label">Background</label><select><option value="">---</option><option value="#FFF">White</option><option value="#000">Black</option><option value="#F00">Red</option><option value="#0F0">Green</option><option value="#00F">Blue</option><option value="#FF0">Yellow</option><option value="#F0F">Magenta</option><option value="#0FF">Cyan</option></select><span class="vjs-bg-opacity vjs-opacity"><select><option value="">---</option><option value="1">Opaque</option><option value="0.5">Semi-Transparent</option><option value="0">Transparent</option></select></span></div><div class="window-color vjs-tracksetting"><label class="vjs-label">Window</label><select><option value="">---</option><option value="#FFF">White</option><option value="#000">Black</option><option value="#F00">Red</option><option value="#0F0">Green</option><option value="#00F">Blue</option><option value="#FF0">Yellow</option><option value="#F0F">Magenta</option><option value="#0FF">Cyan</option></select><span class="vjs-window-opacity vjs-opacity"><select><option value="">---</option><option value="1">Opaque</option><option value="0.5">Semi-Transparent</option><option value="0">Transparent</option></select></span></div></div><div class="vjs-tracksettings-font"><div class="vjs-font-percent vjs-tracksetting"><label class="vjs-label">Font Size</label><select><option value="0.50">50%</option><option value="0.75">75%</option><option value="1.00" selected>100%</option><option value="1.25">125%</option><option value="1.50">150%</option><option value="1.75">175%</option><option value="2.00">200%</option><option value="3.00">300%</option><option value="4.00">400%</option></select></div><div class="vjs-edge-style vjs-tracksetting"><label class="vjs-label">Text Edge Style</label><select><option value="none">None</option><option value="raised">Raised</option><option value="depressed">Depressed</option><option value="uniform">Uniform</option><option value="dropshadow">Dropshadow</option></select></div><div class="vjs-font-family vjs-tracksetting"><label class="vjs-label">Font Family</label><select><option value="">Default</option><option value="monospaceSerif">Monospace Serif</option><option value="proportionalSerif">Proportional Serif</option><option value="monospaceSansSerif">Monospace Sans-Serif</option><option value="proportionalSansSerif">Proportional Sans-Serif</option><option value="casual">Casual</option><option value="script">Script</option><option value="small-caps">Small Caps</option></select></div></div></div><div class="vjs-tracksettings-controls"><button class="vjs-default-button">Defaults</button><button class="vjs-done-button">Done</button></div>'})};
s.Lc=function(){var a,c,d,e,g,h,k,p,r,u;a=this.m();g=X(a.querySelector(".vjs-edge-style select"));h=X(a.querySelector(".vjs-font-family select"));k=X(a.querySelector(".vjs-fg-color > select"));d=X(a.querySelector(".vjs-text-opacity > select"));p=X(a.querySelector(".vjs-bg-color > select"));c=X(a.querySelector(".vjs-bg-opacity > select"));r=X(a.querySelector(".window-color > select"));e=X(a.querySelector(".vjs-window-opacity > select"));a=window.parseFloat(X(a.querySelector(".vjs-font-percent > select")));
c={backgroundOpacity:c,textOpacity:d,windowOpacity:e,edgeStyle:g,fontFamily:h,color:k,backgroundColor:p,windowColor:r,fontPercent:a};for(u in c)(""===c[u]||"none"===c[u]||"fontPercent"===u&&1===c[u])&&delete c[u];return c};
s.Re=function(a){var c=this.m();Y(c.querySelector(".vjs-edge-style select"),a.La);Y(c.querySelector(".vjs-font-family select"),a.fontFamily);Y(c.querySelector(".vjs-fg-color > select"),a.color);Y(c.querySelector(".vjs-text-opacity > select"),a.nd);Y(c.querySelector(".vjs-bg-color > select"),a.backgroundColor);Y(c.querySelector(".vjs-bg-opacity > select"),a.yc);Y(c.querySelector(".window-color > select"),a.fc);Y(c.querySelector(".vjs-window-opacity > select"),a.ud);(a=a.Qb)&&(a=a.toFixed(2));Y(c.querySelector(".vjs-font-percent > select"),
a)};s.Ie=function(){var a;try{a=JSON.parse(window.localStorage.getItem("vjs-text-track-settings"))}catch(c){}a&&this.Re(a)};s.Je=function(){var a;if(this.d.options().persistTextTrackSettings){a=this.Lc();try{t.ib(a)?window.localStorage.removeItem("vjs-text-track-settings"):window.localStorage.setItem("vjs-text-track-settings",JSON.stringify(a))}catch(c){}}};s.C=function(){var a=this.d.ea("textTrackDisplay");a&&a.C()};
if("undefined"!==typeof window.JSON&&"function"===typeof window.JSON.parse)t.JSON=window.JSON;else{t.JSON={};var Z=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;t.JSON.parse=function(a,c){function d(a,e){var k,p,r=a[e];if(r&&"object"===typeof r)for(k in r)Object.prototype.hasOwnProperty.call(r,k)&&(p=d(r,k),p!==b?r[k]=p:delete r[k]);return c.call(a,e,r)}var e;a=String(a);Z.lastIndex=0;Z.test(a)&&(a=a.replace(Z,function(a){return"\\u"+("0000"+
a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return e=eval("("+a+")"),"function"===typeof c?d({"":e},""):e;throw new SyntaxError("JSON.parse(): invalid or malformed JSON data");}}
t.xc=function(){var a,c,d,e;a=document.getElementsByTagName("video");c=document.getElementsByTagName("audio");var g=[];if(a&&0<a.length){d=0;for(e=a.length;d<e;d++)g.push(a[d])}if(c&&0<c.length){d=0;for(e=c.length;d<e;d++)g.push(c[d])}if(g&&0<g.length){d=0;for(e=g.length;d<e;d++)if((c=g[d])&&c.getAttribute)c.player===b&&(a=c.getAttribute("data-setup"),a!==j&&videojs(c));else{t.Ib();break}}else t.td||t.Ib()};t.Ib=function(){setTimeout(t.xc,1)};
"complete"===document.readyState?t.td=f:t.N(window,"load",function(){t.td=f});t.Ib();t.Fe=function(a,c){t.Player.prototype[a]=c};var ya=this;function $(a,c){var d=a.split("."),e=ya;!(d[0]in e)&&e.execScript&&e.execScript("var "+d[0]);for(var g;d.length&&(g=d.shift());)!d.length&&c!==b?e[g]=c:e=e[g]?e[g]:e[g]={}};$("videojs",t);$("_V_",t);$("videojs.options",t.options);$("videojs.players",t.Aa);$("videojs.TOUCH_ENABLED",t.Eb);$("videojs.cache",t.ta);$("videojs.Component",t.a);t.a.prototype.player=t.a.prototype.k;t.a.prototype.options=t.a.prototype.options;t.a.prototype.init=t.a.prototype.l;t.a.prototype.dispose=t.a.prototype.dispose;t.a.prototype.createEl=t.a.prototype.e;t.a.prototype.contentEl=t.a.prototype.va;t.a.prototype.el=t.a.prototype.m;t.a.prototype.addChild=t.a.prototype.ba;
t.a.prototype.getChild=t.a.prototype.ea;t.a.prototype.getChildById=t.a.prototype.ae;t.a.prototype.children=t.a.prototype.children;t.a.prototype.initChildren=t.a.prototype.Oc;t.a.prototype.removeChild=t.a.prototype.removeChild;t.a.prototype.on=t.a.prototype.b;t.a.prototype.off=t.a.prototype.n;t.a.prototype.one=t.a.prototype.N;t.a.prototype.trigger=t.a.prototype.o;t.a.prototype.triggerReady=t.a.prototype.Wa;t.a.prototype.show=t.a.prototype.show;t.a.prototype.hide=t.a.prototype.Y;
t.a.prototype.width=t.a.prototype.width;t.a.prototype.height=t.a.prototype.height;t.a.prototype.dimensions=t.a.prototype.Td;t.a.prototype.ready=t.a.prototype.I;t.a.prototype.addClass=t.a.prototype.p;t.a.prototype.removeClass=t.a.prototype.r;t.a.prototype.hasClass=t.a.prototype.Oa;t.a.prototype.buildCSSClass=t.a.prototype.V;t.a.prototype.localize=t.a.prototype.v;t.a.prototype.setInterval=t.a.prototype.setInterval;t.a.prototype.setTimeout=t.a.prototype.setTimeout;$("videojs.EventEmitter",t.z);
t.z.prototype.on=t.z.prototype.b;t.z.prototype.addEventListener=t.z.prototype.addEventListener;t.z.prototype.off=t.z.prototype.n;t.z.prototype.removeEventListener=t.z.prototype.removeEventListener;t.z.prototype.one=t.z.prototype.N;t.z.prototype.trigger=t.z.prototype.o;t.z.prototype.dispatchEvent=t.z.prototype.dispatchEvent;t.Player.prototype.ended=t.Player.prototype.ended;t.Player.prototype.enterFullWindow=t.Player.prototype.Jc;t.Player.prototype.exitFullWindow=t.Player.prototype.Nb;
t.Player.prototype.preload=t.Player.prototype.Qa;t.Player.prototype.remainingTime=t.Player.prototype.remainingTime;t.Player.prototype.supportsFullScreen=t.Player.prototype.Ta;t.Player.prototype.currentType=t.Player.prototype.Qd;t.Player.prototype.requestFullScreen=t.Player.prototype.requestFullScreen;t.Player.prototype.requestFullscreen=t.Player.prototype.requestFullscreen;t.Player.prototype.cancelFullScreen=t.Player.prototype.cancelFullScreen;t.Player.prototype.exitFullscreen=t.Player.prototype.exitFullscreen;
t.Player.prototype.isFullScreen=t.Player.prototype.isFullScreen;t.Player.prototype.isFullscreen=t.Player.prototype.isFullscreen;t.Player.prototype.textTracks=t.Player.prototype.textTracks;t.Player.prototype.remoteTextTracks=t.Player.prototype.Z;t.Player.prototype.addTextTrack=t.Player.prototype.addTextTrack;t.Player.prototype.addRemoteTextTrack=t.Player.prototype.ia;t.Player.prototype.removeRemoteTextTrack=t.Player.prototype.Ba;$("videojs.MediaLoader",t.Fd);$("videojs.TextTrackDisplay",t.ra);
$("videojs.ControlBar",t.ub);$("videojs.Button",t.w);$("videojs.PlayToggle",t.nc);$("videojs.FullscreenToggle",t.Za);$("videojs.BigPlayButton",t.sb);$("videojs.LoadingSpinner",t.lc);$("videojs.CurrentTimeDisplay",t.vb);$("videojs.DurationDisplay",t.wb);$("videojs.TimeDivider",t.tc);$("videojs.RemainingTimeDisplay",t.Db);$("videojs.LiveDisplay",t.kc);$("videojs.ErrorDisplay",t.xb);$("videojs.Slider",t.U);$("videojs.ProgressControl",t.Cb);$("videojs.SeekBar",t.qc);$("videojs.LoadProgressBar",t.zb);
$("videojs.PlayProgressBar",t.mc);$("videojs.SeekHandle",t.$a);$("videojs.VolumeControl",t.Gb);$("videojs.VolumeBar",t.Fb);$("videojs.VolumeLevel",t.uc);$("videojs.VolumeMenuButton",t.Fa);$("videojs.VolumeHandle",t.Hb);$("videojs.MuteToggle",t.qa);$("videojs.PosterImage",t.pc);$("videojs.Menu",t.pa);$("videojs.MenuItem",t.M);$("videojs.MenuButton",t.O);$("videojs.PlaybackRateMenuButton",t.oc);$("videojs.ChaptersTrackMenuItem",t.Ya);$("videojs.TextTrackButton",t.Q);$("videojs.TextTrackMenuItem",t.aa);
$("videojs.OffTextTrackMenuItem",t.Ab);$("videojs.CaptionSettingsMenuItem",t.tb);t.O.prototype.createItems=t.O.prototype.Ia;t.Q.prototype.createItems=t.Q.prototype.Ia;t.Xa.prototype.createItems=t.Xa.prototype.Ia;$("videojs.SubtitlesButton",t.ab);$("videojs.CaptionsButton",t.na);$("videojs.ChaptersButton",t.Xa);$("videojs.MediaTechController",t.j);t.j.withSourceHandlers=t.j.gc;t.j.prototype.featuresVolumeControl=t.j.prototype.uf;t.j.prototype.featuresFullscreenResize=t.j.prototype.qf;
t.j.prototype.featuresPlaybackRate=t.j.prototype.rf;t.j.prototype.featuresProgressEvents=t.j.prototype.sf;t.j.prototype.featuresTimeupdateEvents=t.j.prototype.tf;t.j.prototype.setPoster=t.j.prototype.fd;t.j.prototype.textTracks=t.j.prototype.textTracks;t.j.prototype.remoteTextTracks=t.j.prototype.Z;t.j.prototype.addTextTrack=t.j.prototype.addTextTrack;t.j.prototype.addRemoteTextTrack=t.j.prototype.ia;t.j.prototype.removeRemoteTextTrack=t.j.prototype.Ba;$("videojs.Html5",t.f);t.f.Events=t.f.yb;
t.f.isSupported=t.f.isSupported;t.f.canPlaySource=t.f.zc;t.f.patchCanPlayType=t.f.Xc;t.f.unpatchCanPlayType=t.f.bf;t.f.prototype.setCurrentTime=t.f.prototype.bc;t.f.prototype.setVolume=t.f.prototype.Se;t.f.prototype.setMuted=t.f.prototype.Oe;t.f.prototype.setPreload=t.f.prototype.Qe;t.f.prototype.setAutoplay=t.f.prototype.Le;t.f.prototype.setLoop=t.f.prototype.Ne;t.f.prototype.enterFullScreen=t.f.prototype.Ic;t.f.prototype.exitFullScreen=t.f.prototype.Xd;t.f.prototype.playbackRate=t.f.prototype.playbackRate;
t.f.prototype.setPlaybackRate=t.f.prototype.Pe;t.f.registerSourceHandler=t.f.Ra;t.f.selectSourceHandler=t.f.pb;t.f.prototype.setSource=t.f.prototype.Sa;t.f.prototype.disposeSourceHandler=t.f.prototype.Ka;t.f.prototype.textTracks=t.f.prototype.textTracks;t.f.prototype.remoteTextTracks=t.f.prototype.Z;t.f.prototype.addTextTrack=t.f.prototype.addTextTrack;t.f.prototype.addRemoteTextTrack=t.f.prototype.ia;t.f.prototype.removeRemoteTextTrack=t.f.prototype.Ba;$("videojs.Flash",t.g);t.g.isSupported=t.g.isSupported;
t.g.canPlaySource=t.g.zc;t.g.onReady=t.g.onReady;t.g.embed=t.g.Hc;t.g.version=t.g.version;t.g.prototype.setSource=t.g.prototype.Sa;t.g.registerSourceHandler=t.g.Ra;t.g.selectSourceHandler=t.g.pb;t.g.prototype.setSource=t.g.prototype.Sa;t.g.prototype.disposeSourceHandler=t.g.prototype.Ka;$("videojs.TextTrack",t.t);$("videojs.TextTrackList",t.F);$("videojs.TextTrackCueList",t.W);$("videojs.TextTrackSettings",t.sc);t.t.prototype.id=t.t.prototype.id;t.t.prototype.label=t.t.prototype.label;
t.t.prototype.kind=t.t.prototype.Wb;t.t.prototype.mode=t.t.prototype.mode;t.t.prototype.cues=t.t.prototype.Dc;t.t.prototype.activeCues=t.t.prototype.nf;t.t.prototype.addCue=t.t.prototype.vc;t.t.prototype.removeCue=t.t.prototype.bd;t.F.prototype.getTrackById=t.F.prototype.de;t.W.prototype.getCueById=t.F.prototype.be;$("videojs.CaptionsTrack",t.gf);$("videojs.SubtitlesTrack",t.mf);$("videojs.ChaptersTrack",t.hf);$("videojs.autoSetup",t.xc);$("videojs.plugin",t.Fe);$("videojs.createTimeRange",t.Lb);
$("videojs.util",t.$);t.$.mergeOptions=t.$.ya;t.addLanguage=t.Jd;})();

/* vtt.js - v0.11.11 (https://github.com/mozilla/vtt.js) built on 22-01-2015 */
!function(a){var b=a.vttjs={},c=b.VTTCue,d=b.VTTRegion,e=a.VTTCue,f=a.VTTRegion;b.shim=function(){b.VTTCue=c,b.VTTRegion=d},b.restore=function(){b.VTTCue=e,b.VTTRegion=f}}(this),function(a,b){function c(a){if("string"!=typeof a)return!1;var b=h[a.toLowerCase()];return b?a.toLowerCase():!1}function d(a){if("string"!=typeof a)return!1;var b=i[a.toLowerCase()];return b?a.toLowerCase():!1}function e(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c)a[d]=c[d]}return a}function f(a,b,f){var h=this,i=/MSIE\s8\.0/.test(navigator.userAgent),j={};i?h=document.createElement("custom"):j.enumerable=!0,h.hasBeenReset=!1;var k="",l=!1,m=a,n=b,o=f,p=null,q="",r=!0,s="auto",t="start",u=50,v="middle",w=50,x="middle";return Object.defineProperty(h,"id",e({},j,{get:function(){return k},set:function(a){k=""+a}})),Object.defineProperty(h,"pauseOnExit",e({},j,{get:function(){return l},set:function(a){l=!!a}})),Object.defineProperty(h,"startTime",e({},j,{get:function(){return m},set:function(a){if("number"!=typeof a)throw new TypeError("Start time must be set to a number.");m=a,this.hasBeenReset=!0}})),Object.defineProperty(h,"endTime",e({},j,{get:function(){return n},set:function(a){if("number"!=typeof a)throw new TypeError("End time must be set to a number.");n=a,this.hasBeenReset=!0}})),Object.defineProperty(h,"text",e({},j,{get:function(){return o},set:function(a){o=""+a,this.hasBeenReset=!0}})),Object.defineProperty(h,"region",e({},j,{get:function(){return p},set:function(a){p=a,this.hasBeenReset=!0}})),Object.defineProperty(h,"vertical",e({},j,{get:function(){return q},set:function(a){var b=c(a);if(b===!1)throw new SyntaxError("An invalid or illegal string was specified.");q=b,this.hasBeenReset=!0}})),Object.defineProperty(h,"snapToLines",e({},j,{get:function(){return r},set:function(a){r=!!a,this.hasBeenReset=!0}})),Object.defineProperty(h,"line",e({},j,{get:function(){return s},set:function(a){if("number"!=typeof a&&a!==g)throw new SyntaxError("An invalid number or illegal string was specified.");s=a,this.hasBeenReset=!0}})),Object.defineProperty(h,"lineAlign",e({},j,{get:function(){return t},set:function(a){var b=d(a);if(!b)throw new SyntaxError("An invalid or illegal string was specified.");t=b,this.hasBeenReset=!0}})),Object.defineProperty(h,"position",e({},j,{get:function(){return u},set:function(a){if(0>a||a>100)throw new Error("Position must be between 0 and 100.");u=a,this.hasBeenReset=!0}})),Object.defineProperty(h,"positionAlign",e({},j,{get:function(){return v},set:function(a){var b=d(a);if(!b)throw new SyntaxError("An invalid or illegal string was specified.");v=b,this.hasBeenReset=!0}})),Object.defineProperty(h,"size",e({},j,{get:function(){return w},set:function(a){if(0>a||a>100)throw new Error("Size must be between 0 and 100.");w=a,this.hasBeenReset=!0}})),Object.defineProperty(h,"align",e({},j,{get:function(){return x},set:function(a){var b=d(a);if(!b)throw new SyntaxError("An invalid or illegal string was specified.");x=b,this.hasBeenReset=!0}})),h.displayState=void 0,i?h:void 0}var g="auto",h={"":!0,lr:!0,rl:!0},i={start:!0,middle:!0,end:!0,left:!0,right:!0};f.prototype.getCueAsHTML=function(){return WebVTT.convertCueToDOMTree(window,this.text)},a.VTTCue=a.VTTCue||f,b.VTTCue=f}(this,this.vttjs||{}),function(a,b){function c(a){if("string"!=typeof a)return!1;var b=f[a.toLowerCase()];return b?a.toLowerCase():!1}function d(a){return"number"==typeof a&&a>=0&&100>=a}function e(){var a=100,b=3,e=0,f=100,g=0,h=100,i="";Object.defineProperties(this,{width:{enumerable:!0,get:function(){return a},set:function(b){if(!d(b))throw new Error("Width must be between 0 and 100.");a=b}},lines:{enumerable:!0,get:function(){return b},set:function(a){if("number"!=typeof a)throw new TypeError("Lines must be set to a number.");b=a}},regionAnchorY:{enumerable:!0,get:function(){return f},set:function(a){if(!d(a))throw new Error("RegionAnchorX must be between 0 and 100.");f=a}},regionAnchorX:{enumerable:!0,get:function(){return e},set:function(a){if(!d(a))throw new Error("RegionAnchorY must be between 0 and 100.");e=a}},viewportAnchorY:{enumerable:!0,get:function(){return h},set:function(a){if(!d(a))throw new Error("ViewportAnchorY must be between 0 and 100.");h=a}},viewportAnchorX:{enumerable:!0,get:function(){return g},set:function(a){if(!d(a))throw new Error("ViewportAnchorX must be between 0 and 100.");g=a}},scroll:{enumerable:!0,get:function(){return i},set:function(a){var b=c(a);if(b===!1)throw new SyntaxError("An invalid or illegal string was specified.");i=b}}})}var f={"":!0,up:!0};a.VTTRegion=a.VTTRegion||e,b.VTTRegion=e}(this,this.vttjs||{}),function(a){function b(a,b){this.name="ParsingError",this.code=a.code,this.message=b||a.message}function c(a){function b(a,b,c,d){return 3600*(0|a)+60*(0|b)+(0|c)+(0|d)/1e3}var c=a.match(/^(\d+):(\d{2})(:\d{2})?\.(\d{3})/);return c?c[3]?b(c[1],c[2],c[3].replace(":",""),c[4]):c[1]>59?b(c[1],c[2],0,c[4]):b(0,c[1],c[2],c[4]):null}function d(){this.values=o(null)}function e(a,b,c,d){var e=d?a.split(d):[a];for(var f in e)if("string"==typeof e[f]){var g=e[f].split(c);if(2===g.length){var h=g[0],i=g[1];b(h,i)}}}function f(a,f,g){function h(){var d=c(a);if(null===d)throw new b(b.Errors.BadTimeStamp,"Malformed timestamp: "+k);return a=a.replace(/^[^\sa-zA-Z-]+/,""),d}function i(a,b){var c=new d;e(a,function(a,b){switch(a){case"region":for(var d=g.length-1;d>=0;d--)if(g[d].id===b){c.set(a,g[d].region);break}break;case"vertical":c.alt(a,b,["rl","lr"]);break;case"line":var e=b.split(","),f=e[0];c.integer(a,f),c.percent(a,f)?c.set("snapToLines",!1):null,c.alt(a,f,["auto"]),2===e.length&&c.alt("lineAlign",e[1],["start","middle","end"]);break;case"position":e=b.split(","),c.percent(a,e[0]),2===e.length&&c.alt("positionAlign",e[1],["start","middle","end"]);break;case"size":c.percent(a,b);break;case"align":c.alt(a,b,["start","middle","end","left","right"])}},/:/,/\s/),b.region=c.get("region",null),b.vertical=c.get("vertical",""),b.line=c.get("line","auto"),b.lineAlign=c.get("lineAlign","start"),b.snapToLines=c.get("snapToLines",!0),b.size=c.get("size",100),b.align=c.get("align","middle"),b.position=c.get("position",{start:0,left:0,middle:50,end:100,right:100},b.align),b.positionAlign=c.get("positionAlign",{start:"start",left:"start",middle:"middle",end:"end",right:"end"},b.align)}function j(){a=a.replace(/^\s+/,"")}var k=a;if(j(),f.startTime=h(),j(),"-->"!==a.substr(0,3))throw new b(b.Errors.BadTimeStamp,"Malformed time stamp (time stamps must be separated by '-->'): "+k);a=a.substr(3),j(),f.endTime=h(),j(),i(a,f)}function g(a,b){function d(){function a(a){return b=b.substr(a.length),a}if(!b)return null;var c=b.match(/^([^<]*)(<[^>]+>?)?/);return a(c[1]?c[1]:c[2])}function e(a){return p[a]}function f(a){for(;o=a.match(/&(amp|lt|gt|lrm|rlm|nbsp);/);)a=a.replace(o[0],e);return a}function g(a,b){return!s[b.localName]||s[b.localName]===a.localName}function h(b,c){var d=q[b];if(!d)return null;var e=a.document.createElement(d);e.localName=d;var f=r[b];return f&&c&&(e[f]=c.trim()),e}for(var i,j=a.document.createElement("div"),k=j,l=[];null!==(i=d());)if("<"!==i[0])k.appendChild(a.document.createTextNode(f(i)));else{if("/"===i[1]){l.length&&l[l.length-1]===i.substr(2).replace(">","")&&(l.pop(),k=k.parentNode);continue}var m,n=c(i.substr(1,i.length-2));if(n){m=a.document.createProcessingInstruction("timestamp",n),k.appendChild(m);continue}var o=i.match(/^<([^.\s/0-9>]+)(\.[^\s\\>]+)?([^>\\]+)?(\\?)>?$/);if(!o)continue;if(m=h(o[1],o[3]),!m)continue;if(!g(k,m))continue;o[2]&&(m.className=o[2].substr(1).replace("."," ")),l.push(o[1]),k.appendChild(m),k=m}return j}function h(a){function b(a,b){for(var c=b.childNodes.length-1;c>=0;c--)a.push(b.childNodes[c])}function c(a){if(!a||!a.length)return null;var d=a.pop(),e=d.textContent||d.innerText;if(e){var f=e.match(/^.*(\n|\r)/);return f?(a.length=0,f[0]):e}return"ruby"===d.tagName?c(a):d.childNodes?(b(a,d),c(a)):void 0}var d,e=[],f="";if(!a||!a.childNodes)return"ltr";for(b(e,a);f=c(e);)for(var g=0;g<f.length;g++){d=f.charCodeAt(g);for(var h=0;h<t.length;h++)if(t[h]===d)return"rtl"}return"ltr"}function i(a){if("number"==typeof a.line&&(a.snapToLines||a.line>=0&&a.line<=100))return a.line;if(!a.track||!a.track.textTrackList||!a.track.textTrackList.mediaElement)return-1;for(var b=a.track,c=b.textTrackList,d=0,e=0;e<c.length&&c[e]!==b;e++)"showing"===c[e].mode&&d++;return-1*++d}function j(){}function k(a,b,c){var d=/MSIE\s8\.0/.test(navigator.userAgent),e="rgba(255, 255, 255, 1)",f="rgba(0, 0, 0, 0.8)";d&&(e="rgb(255, 255, 255)",f="rgb(0, 0, 0)"),j.call(this),this.cue=b,this.cueDiv=g(a,b.text);var i={color:e,backgroundColor:f,position:"relative",left:0,right:0,top:0,bottom:0,display:"inline"};d||(i.writingMode=""===b.vertical?"horizontal-tb":"lr"===b.vertical?"vertical-lr":"vertical-rl",i.unicodeBidi="plaintext"),this.applyStyles(i,this.cueDiv),this.div=a.document.createElement("div"),i={textAlign:"middle"===b.align?"center":b.align,font:c.font,whiteSpace:"pre-line",position:"absolute"},d||(i.direction=h(this.cueDiv),i.writingMode=""===b.vertical?"horizontal-tb":"lr"===b.vertical?"vertical-lr":"vertical-rl".stylesunicodeBidi="plaintext"),this.applyStyles(i),this.div.appendChild(this.cueDiv);var k=0;switch(b.positionAlign){case"start":k=b.position;break;case"middle":k=b.position-b.size/2;break;case"end":k=b.position-b.size}this.applyStyles(""===b.vertical?{left:this.formatStyle(k,"%"),width:this.formatStyle(b.size,"%")}:{top:this.formatStyle(k,"%"),height:this.formatStyle(b.size,"%")}),this.move=function(a){this.applyStyles({top:this.formatStyle(a.top,"px"),bottom:this.formatStyle(a.bottom,"px"),left:this.formatStyle(a.left,"px"),right:this.formatStyle(a.right,"px"),height:this.formatStyle(a.height,"px"),width:this.formatStyle(a.width,"px")})}}function l(a){var b,c,d,e,f=/MSIE\s8\.0/.test(navigator.userAgent);if(a.div){c=a.div.offsetHeight,d=a.div.offsetWidth,e=a.div.offsetTop;var g=(g=a.div.childNodes)&&(g=g[0])&&g.getClientRects&&g.getClientRects();a=a.div.getBoundingClientRect(),b=g?Math.max(g[0]&&g[0].height||0,a.height/g.length):0}this.left=a.left,this.right=a.right,this.top=a.top||e,this.height=a.height||c,this.bottom=a.bottom||e+(a.height||c),this.width=a.width||d,this.lineHeight=void 0!==b?b:a.lineHeight,f&&!this.lineHeight&&(this.lineHeight=13)}function m(a,b,c,d){function e(a,b){for(var e,f=new l(a),g=1,h=0;h<b.length;h++){for(;a.overlapsOppositeAxis(c,b[h])||a.within(c)&&a.overlapsAny(d);)a.move(b[h]);if(a.within(c))return a;var i=a.intersectPercentage(c);g>i&&(e=new l(a),g=i),a=new l(f)}return e||f}var f=new l(b),g=b.cue,h=i(g),j=[];if(g.snapToLines){var k;switch(g.vertical){case"":j=["+y","-y"],k="height";break;case"rl":j=["+x","-x"],k="width";break;case"lr":j=["-x","+x"],k="width"}var m=f.lineHeight,n=m*Math.round(h),o=c[k]+m,p=j[0];Math.abs(n)>o&&(n=0>n?-1:1,n*=Math.ceil(o/m)*m),0>h&&(n+=""===g.vertical?c.height:c.width,j=j.reverse()),f.move(p,n)}else{var q=f.lineHeight/c.height*100;switch(g.lineAlign){case"middle":h-=q/2;break;case"end":h-=q}switch(g.vertical){case"":b.applyStyles({top:b.formatStyle(h,"%")});break;case"rl":b.applyStyles({left:b.formatStyle(h,"%")});break;case"lr":b.applyStyles({right:b.formatStyle(h,"%")})}j=["+y","-x","+x","-y"],f=new l(b)}var r=e(f,j);b.move(r.toCSSCompatValues(c))}function n(){}var o=Object.create||function(){function a(){}return function(b){if(1!==arguments.length)throw new Error("Object.create shim only accepts one parameter.");return a.prototype=b,new a}}();b.prototype=o(Error.prototype),b.prototype.constructor=b,b.Errors={BadSignature:{code:0,message:"Malformed WebVTT signature."},BadTimeStamp:{code:1,message:"Malformed time stamp."}},d.prototype={set:function(a,b){this.get(a)||""===b||(this.values[a]=b)},get:function(a,b,c){return c?this.has(a)?this.values[a]:b[c]:this.has(a)?this.values[a]:b},has:function(a){return a in this.values},alt:function(a,b,c){for(var d=0;d<c.length;++d)if(b===c[d]){this.set(a,b);break}},integer:function(a,b){/^-?\d+$/.test(b)&&this.set(a,parseInt(b,10))},percent:function(a,b){var c;return(c=b.match(/^([\d]{1,3})(\.[\d]*)?%$/))&&(b=parseFloat(b),b>=0&&100>=b)?(this.set(a,b),!0):!1}};var p={"&amp;":"&","&lt;":"<","&gt;":">","&lrm;":"‎","&rlm;":"‏","&nbsp;":" "},q={c:"span",i:"i",b:"b",u:"u",ruby:"ruby",rt:"rt",v:"span",lang:"span"},r={v:"title",lang:"lang"},s={rt:"ruby"},t=[1470,1472,1475,1478,1488,1489,1490,1491,1492,1493,1494,1495,1496,1497,1498,1499,1500,1501,1502,1503,1504,1505,1506,1507,1508,1509,1510,1511,1512,1513,1514,1520,1521,1522,1523,1524,1544,1547,1549,1563,1566,1567,1568,1569,1570,1571,1572,1573,1574,1575,1576,1577,1578,1579,1580,1581,1582,1583,1584,1585,1586,1587,1588,1589,1590,1591,1592,1593,1594,1595,1596,1597,1598,1599,1600,1601,1602,1603,1604,1605,1606,1607,1608,1609,1610,1645,1646,1647,1649,1650,1651,1652,1653,1654,1655,1656,1657,1658,1659,1660,1661,1662,1663,1664,1665,1666,1667,1668,1669,1670,1671,1672,1673,1674,1675,1676,1677,1678,1679,1680,1681,1682,1683,1684,1685,1686,1687,1688,1689,1690,1691,1692,1693,1694,1695,1696,1697,1698,1699,1700,1701,1702,1703,1704,1705,1706,1707,1708,1709,1710,1711,1712,1713,1714,1715,1716,1717,1718,1719,1720,1721,1722,1723,1724,1725,1726,1727,1728,1729,1730,1731,1732,1733,1734,1735,1736,1737,1738,1739,1740,1741,1742,1743,1744,1745,1746,1747,1748,1749,1765,1766,1774,1775,1786,1787,1788,1789,1790,1791,1792,1793,1794,1795,1796,1797,1798,1799,1800,1801,1802,1803,1804,1805,1807,1808,1810,1811,1812,1813,1814,1815,1816,1817,1818,1819,1820,1821,1822,1823,1824,1825,1826,1827,1828,1829,1830,1831,1832,1833,1834,1835,1836,1837,1838,1839,1869,1870,1871,1872,1873,1874,1875,1876,1877,1878,1879,1880,1881,1882,1883,1884,1885,1886,1887,1888,1889,1890,1891,1892,1893,1894,1895,1896,1897,1898,1899,1900,1901,1902,1903,1904,1905,1906,1907,1908,1909,1910,1911,1912,1913,1914,1915,1916,1917,1918,1919,1920,1921,1922,1923,1924,1925,1926,1927,1928,1929,1930,1931,1932,1933,1934,1935,1936,1937,1938,1939,1940,1941,1942,1943,1944,1945,1946,1947,1948,1949,1950,1951,1952,1953,1954,1955,1956,1957,1969,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2e3,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023,2024,2025,2026,2036,2037,2042,2048,2049,2050,2051,2052,2053,2054,2055,2056,2057,2058,2059,2060,2061,2062,2063,2064,2065,2066,2067,2068,2069,2074,2084,2088,2096,2097,2098,2099,2100,2101,2102,2103,2104,2105,2106,2107,2108,2109,2110,2112,2113,2114,2115,2116,2117,2118,2119,2120,2121,2122,2123,2124,2125,2126,2127,2128,2129,2130,2131,2132,2133,2134,2135,2136,2142,2208,2210,2211,2212,2213,2214,2215,2216,2217,2218,2219,2220,8207,64285,64287,64288,64289,64290,64291,64292,64293,64294,64295,64296,64298,64299,64300,64301,64302,64303,64304,64305,64306,64307,64308,64309,64310,64312,64313,64314,64315,64316,64318,64320,64321,64323,64324,64326,64327,64328,64329,64330,64331,64332,64333,64334,64335,64336,64337,64338,64339,64340,64341,64342,64343,64344,64345,64346,64347,64348,64349,64350,64351,64352,64353,64354,64355,64356,64357,64358,64359,64360,64361,64362,64363,64364,64365,64366,64367,64368,64369,64370,64371,64372,64373,64374,64375,64376,64377,64378,64379,64380,64381,64382,64383,64384,64385,64386,64387,64388,64389,64390,64391,64392,64393,64394,64395,64396,64397,64398,64399,64400,64401,64402,64403,64404,64405,64406,64407,64408,64409,64410,64411,64412,64413,64414,64415,64416,64417,64418,64419,64420,64421,64422,64423,64424,64425,64426,64427,64428,64429,64430,64431,64432,64433,64434,64435,64436,64437,64438,64439,64440,64441,64442,64443,64444,64445,64446,64447,64448,64449,64467,64468,64469,64470,64471,64472,64473,64474,64475,64476,64477,64478,64479,64480,64481,64482,64483,64484,64485,64486,64487,64488,64489,64490,64491,64492,64493,64494,64495,64496,64497,64498,64499,64500,64501,64502,64503,64504,64505,64506,64507,64508,64509,64510,64511,64512,64513,64514,64515,64516,64517,64518,64519,64520,64521,64522,64523,64524,64525,64526,64527,64528,64529,64530,64531,64532,64533,64534,64535,64536,64537,64538,64539,64540,64541,64542,64543,64544,64545,64546,64547,64548,64549,64550,64551,64552,64553,64554,64555,64556,64557,64558,64559,64560,64561,64562,64563,64564,64565,64566,64567,64568,64569,64570,64571,64572,64573,64574,64575,64576,64577,64578,64579,64580,64581,64582,64583,64584,64585,64586,64587,64588,64589,64590,64591,64592,64593,64594,64595,64596,64597,64598,64599,64600,64601,64602,64603,64604,64605,64606,64607,64608,64609,64610,64611,64612,64613,64614,64615,64616,64617,64618,64619,64620,64621,64622,64623,64624,64625,64626,64627,64628,64629,64630,64631,64632,64633,64634,64635,64636,64637,64638,64639,64640,64641,64642,64643,64644,64645,64646,64647,64648,64649,64650,64651,64652,64653,64654,64655,64656,64657,64658,64659,64660,64661,64662,64663,64664,64665,64666,64667,64668,64669,64670,64671,64672,64673,64674,64675,64676,64677,64678,64679,64680,64681,64682,64683,64684,64685,64686,64687,64688,64689,64690,64691,64692,64693,64694,64695,64696,64697,64698,64699,64700,64701,64702,64703,64704,64705,64706,64707,64708,64709,64710,64711,64712,64713,64714,64715,64716,64717,64718,64719,64720,64721,64722,64723,64724,64725,64726,64727,64728,64729,64730,64731,64732,64733,64734,64735,64736,64737,64738,64739,64740,64741,64742,64743,64744,64745,64746,64747,64748,64749,64750,64751,64752,64753,64754,64755,64756,64757,64758,64759,64760,64761,64762,64763,64764,64765,64766,64767,64768,64769,64770,64771,64772,64773,64774,64775,64776,64777,64778,64779,64780,64781,64782,64783,64784,64785,64786,64787,64788,64789,64790,64791,64792,64793,64794,64795,64796,64797,64798,64799,64800,64801,64802,64803,64804,64805,64806,64807,64808,64809,64810,64811,64812,64813,64814,64815,64816,64817,64818,64819,64820,64821,64822,64823,64824,64825,64826,64827,64828,64829,64848,64849,64850,64851,64852,64853,64854,64855,64856,64857,64858,64859,64860,64861,64862,64863,64864,64865,64866,64867,64868,64869,64870,64871,64872,64873,64874,64875,64876,64877,64878,64879,64880,64881,64882,64883,64884,64885,64886,64887,64888,64889,64890,64891,64892,64893,64894,64895,64896,64897,64898,64899,64900,64901,64902,64903,64904,64905,64906,64907,64908,64909,64910,64911,64914,64915,64916,64917,64918,64919,64920,64921,64922,64923,64924,64925,64926,64927,64928,64929,64930,64931,64932,64933,64934,64935,64936,64937,64938,64939,64940,64941,64942,64943,64944,64945,64946,64947,64948,64949,64950,64951,64952,64953,64954,64955,64956,64957,64958,64959,64960,64961,64962,64963,64964,64965,64966,64967,65008,65009,65010,65011,65012,65013,65014,65015,65016,65017,65018,65019,65020,65136,65137,65138,65139,65140,65142,65143,65144,65145,65146,65147,65148,65149,65150,65151,65152,65153,65154,65155,65156,65157,65158,65159,65160,65161,65162,65163,65164,65165,65166,65167,65168,65169,65170,65171,65172,65173,65174,65175,65176,65177,65178,65179,65180,65181,65182,65183,65184,65185,65186,65187,65188,65189,65190,65191,65192,65193,65194,65195,65196,65197,65198,65199,65200,65201,65202,65203,65204,65205,65206,65207,65208,65209,65210,65211,65212,65213,65214,65215,65216,65217,65218,65219,65220,65221,65222,65223,65224,65225,65226,65227,65228,65229,65230,65231,65232,65233,65234,65235,65236,65237,65238,65239,65240,65241,65242,65243,65244,65245,65246,65247,65248,65249,65250,65251,65252,65253,65254,65255,65256,65257,65258,65259,65260,65261,65262,65263,65264,65265,65266,65267,65268,65269,65270,65271,65272,65273,65274,65275,65276,67584,67585,67586,67587,67588,67589,67592,67594,67595,67596,67597,67598,67599,67600,67601,67602,67603,67604,67605,67606,67607,67608,67609,67610,67611,67612,67613,67614,67615,67616,67617,67618,67619,67620,67621,67622,67623,67624,67625,67626,67627,67628,67629,67630,67631,67632,67633,67634,67635,67636,67637,67639,67640,67644,67647,67648,67649,67650,67651,67652,67653,67654,67655,67656,67657,67658,67659,67660,67661,67662,67663,67664,67665,67666,67667,67668,67669,67671,67672,67673,67674,67675,67676,67677,67678,67679,67840,67841,67842,67843,67844,67845,67846,67847,67848,67849,67850,67851,67852,67853,67854,67855,67856,67857,67858,67859,67860,67861,67862,67863,67864,67865,67866,67867,67872,67873,67874,67875,67876,67877,67878,67879,67880,67881,67882,67883,67884,67885,67886,67887,67888,67889,67890,67891,67892,67893,67894,67895,67896,67897,67903,67968,67969,67970,67971,67972,67973,67974,67975,67976,67977,67978,67979,67980,67981,67982,67983,67984,67985,67986,67987,67988,67989,67990,67991,67992,67993,67994,67995,67996,67997,67998,67999,68e3,68001,68002,68003,68004,68005,68006,68007,68008,68009,68010,68011,68012,68013,68014,68015,68016,68017,68018,68019,68020,68021,68022,68023,68030,68031,68096,68112,68113,68114,68115,68117,68118,68119,68121,68122,68123,68124,68125,68126,68127,68128,68129,68130,68131,68132,68133,68134,68135,68136,68137,68138,68139,68140,68141,68142,68143,68144,68145,68146,68147,68160,68161,68162,68163,68164,68165,68166,68167,68176,68177,68178,68179,68180,68181,68182,68183,68184,68192,68193,68194,68195,68196,68197,68198,68199,68200,68201,68202,68203,68204,68205,68206,68207,68208,68209,68210,68211,68212,68213,68214,68215,68216,68217,68218,68219,68220,68221,68222,68223,68352,68353,68354,68355,68356,68357,68358,68359,68360,68361,68362,68363,68364,68365,68366,68367,68368,68369,68370,68371,68372,68373,68374,68375,68376,68377,68378,68379,68380,68381,68382,68383,68384,68385,68386,68387,68388,68389,68390,68391,68392,68393,68394,68395,68396,68397,68398,68399,68400,68401,68402,68403,68404,68405,68416,68417,68418,68419,68420,68421,68422,68423,68424,68425,68426,68427,68428,68429,68430,68431,68432,68433,68434,68435,68436,68437,68440,68441,68442,68443,68444,68445,68446,68447,68448,68449,68450,68451,68452,68453,68454,68455,68456,68457,68458,68459,68460,68461,68462,68463,68464,68465,68466,68472,68473,68474,68475,68476,68477,68478,68479,68608,68609,68610,68611,68612,68613,68614,68615,68616,68617,68618,68619,68620,68621,68622,68623,68624,68625,68626,68627,68628,68629,68630,68631,68632,68633,68634,68635,68636,68637,68638,68639,68640,68641,68642,68643,68644,68645,68646,68647,68648,68649,68650,68651,68652,68653,68654,68655,68656,68657,68658,68659,68660,68661,68662,68663,68664,68665,68666,68667,68668,68669,68670,68671,68672,68673,68674,68675,68676,68677,68678,68679,68680,126464,126465,126466,126467,126469,126470,126471,126472,126473,126474,126475,126476,126477,126478,126479,126480,126481,126482,126483,126484,126485,126486,126487,126488,126489,126490,126491,126492,126493,126494,126495,126497,126498,126500,126503,126505,126506,126507,126508,126509,126510,126511,126512,126513,126514,126516,126517,126518,126519,126521,126523,126530,126535,126537,126539,126541,126542,126543,126545,126546,126548,126551,126553,126555,126557,126559,126561,126562,126564,126567,126568,126569,126570,126572,126573,126574,126575,126576,126577,126578,126580,126581,126582,126583,126585,126586,126587,126588,126590,126592,126593,126594,126595,126596,126597,126598,126599,126600,126601,126603,126604,126605,126606,126607,126608,126609,126610,126611,126612,126613,126614,126615,126616,126617,126618,126619,126625,126626,126627,126629,126630,126631,126632,126633,126635,126636,126637,126638,126639,126640,126641,126642,126643,126644,126645,126646,126647,126648,126649,126650,126651,1114109];j.prototype.applyStyles=function(a,b){b=b||this.div;for(var c in a)a.hasOwnProperty(c)&&(b.style[c]=a[c])},j.prototype.formatStyle=function(a,b){return 0===a?0:a+b},k.prototype=o(j.prototype),k.prototype.constructor=k,l.prototype.move=function(a,b){switch(b=void 0!==b?b:this.lineHeight,a){case"+x":this.left+=b,this.right+=b;break;case"-x":this.left-=b,this.right-=b;break;case"+y":this.top+=b,this.bottom+=b;break;case"-y":this.top-=b,this.bottom-=b}},l.prototype.overlaps=function(a){return this.left<a.right&&this.right>a.left&&this.top<a.bottom&&this.bottom>a.top},l.prototype.overlapsAny=function(a){for(var b=0;b<a.length;b++)if(this.overlaps(a[b]))return!0;return!1},l.prototype.within=function(a){return this.top>=a.top&&this.bottom<=a.bottom&&this.left>=a.left&&this.right<=a.right},l.prototype.overlapsOppositeAxis=function(a,b){switch(b){case"+x":return this.left<a.left;case"-x":return this.right>a.right;case"+y":return this.top<a.top;case"-y":return this.bottom>a.bottom}},l.prototype.intersectPercentage=function(a){var b=Math.max(0,Math.min(this.right,a.right)-Math.max(this.left,a.left)),c=Math.max(0,Math.min(this.bottom,a.bottom)-Math.max(this.top,a.top)),d=b*c;return d/(this.height*this.width)},l.prototype.toCSSCompatValues=function(a){return{top:this.top-a.top,bottom:a.bottom-this.bottom,left:this.left-a.left,right:a.right-this.right,height:this.height,width:this.width}},l.getSimpleBoxPosition=function(a){var b=a.div?a.div.offsetHeight:a.tagName?a.offsetHeight:0,c=a.div?a.div.offsetWidth:a.tagName?a.offsetWidth:0,d=a.div?a.div.offsetTop:a.tagName?a.offsetTop:0;a=a.div?a.div.getBoundingClientRect():a.tagName?a.getBoundingClientRect():a;var e={left:a.left,right:a.right,top:a.top||d,height:a.height||b,bottom:a.bottom||d+(a.height||b),width:a.width||c};return e},n.StringDecoder=function(){return{decode:function(a){if(!a)return"";if("string"!=typeof a)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(a))}}},n.convertCueToDOMTree=function(a,b){return a&&b?g(a,b):null};var u=.05,v="sans-serif",w="1.5%";n.processCues=function(a,b,c){function d(a){for(var b=0;b<a.length;b++)if(a[b].hasBeenReset||!a[b].displayState)return!0;return!1}if(!a||!b||!c)return null;for(;c.firstChild;)c.removeChild(c.firstChild);var e=a.document.createElement("div");if(e.style.position="absolute",e.style.left="0",e.style.right="0",e.style.top="0",e.style.bottom="0",e.style.margin=w,c.appendChild(e),d(b)){var f=[],g=l.getSimpleBoxPosition(e),h=Math.round(g.height*u*100)/100,i={font:h+"px "+v};!function(){for(var c,d,h=0;h<b.length;h++)d=b[h],c=new k(a,d,i),e.appendChild(c.div),m(a,c,g,f),d.displayState=c.div,f.push(l.getSimpleBoxPosition(c))}()}else for(var j=0;j<b.length;j++)e.appendChild(b[j].displayState)},n.Parser=function(a,b,c){c||(c=b,b={}),b||(b={}),this.window=a,this.vttjs=b,this.state="INITIAL",this.buffer="",this.decoder=c||new TextDecoder("utf8"),this.regionList=[]},n.Parser.prototype={reportOrThrowError:function(a){if(!(a instanceof b))throw a;this.onparsingerror&&this.onparsingerror(a)},parse:function(a){function c(){for(var a=i.buffer,b=0;b<a.length&&"\r"!==a[b]&&"\n"!==a[b];)++b;var c=a.substr(0,b);return"\r"===a[b]&&++b,"\n"===a[b]&&++b,i.buffer=a.substr(b),c}function g(a){var b=new d;if(e(a,function(a,c){switch(a){case"id":b.set(a,c);break;case"width":b.percent(a,c);break;case"lines":b.integer(a,c);break;case"regionanchor":case"viewportanchor":var e=c.split(",");if(2!==e.length)break;var f=new d;if(f.percent("x",e[0]),f.percent("y",e[1]),!f.has("x")||!f.has("y"))break;b.set(a+"X",f.get("x")),b.set(a+"Y",f.get("y"));break;case"scroll":b.alt(a,c,["up"])}},/=/,/\s/),b.has("id")){var c=new(i.vttjs.VTTRegion||i.window.VTTRegion);c.width=b.get("width",100),c.lines=b.get("lines",3),c.regionAnchorX=b.get("regionanchorX",0),c.regionAnchorY=b.get("regionanchorY",100),c.viewportAnchorX=b.get("viewportanchorX",0),c.viewportAnchorY=b.get("viewportanchorY",100),c.scroll=b.get("scroll",""),i.onregion&&i.onregion(c),i.regionList.push({id:b.get("id"),region:c})}}function h(a){e(a,function(a,b){switch(a){case"Region":g(b)}},/:/)}var i=this;a&&(i.buffer+=i.decoder.decode(a,{stream:!0}));try{var j;if("INITIAL"===i.state){if(!/\r\n|\n/.test(i.buffer))return this;j=c();var k=j.match(/^WEBVTT([ \t].*)?$/);if(!k||!k[0])throw new b(b.Errors.BadSignature);i.state="HEADER"}for(var l=!1;i.buffer;){if(!/\r\n|\n/.test(i.buffer))return this;switch(l?l=!1:j=c(),i.state){case"HEADER":/:/.test(j)?h(j):j||(i.state="ID");continue;case"NOTE":j||(i.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(j)){i.state="NOTE";break}if(!j)continue;if(i.cue=new(i.vttjs.VTTCue||i.window.VTTCue)(0,0,""),i.state="CUE",-1===j.indexOf("-->")){i.cue.id=j;continue}case"CUE":try{f(j,i.cue,i.regionList)}catch(m){i.reportOrThrowError(m),i.cue=null,i.state="BADCUE";continue}i.state="CUETEXT";continue;case"CUETEXT":var n=-1!==j.indexOf("-->");if(!j||n&&(l=!0)){i.oncue&&i.oncue(i.cue),i.cue=null,i.state="ID";continue}i.cue.text&&(i.cue.text+="\n"),i.cue.text+=j;continue;case"BADCUE":j||(i.state="ID");continue}}}catch(m){i.reportOrThrowError(m),"CUETEXT"===i.state&&i.cue&&i.oncue&&i.oncue(i.cue),i.cue=null,i.state="INITIAL"===i.state?"BADWEBVTT":"BADCUE"}return this},flush:function(){var a=this;try{if(a.buffer+=a.decoder.decode(),(a.cue||"HEADER"===a.state)&&(a.buffer+="\n\n",a.parse()),"INITIAL"===a.state)throw new b(b.Errors.BadSignature)}catch(c){a.reportOrThrowError(c)}return a.onflush&&a.onflush(),this}},a.WebVTT=n}(this,this.vttjs||{});
/* global videojs, YT */
/* jshint browser: true */

(function() {
  /**
   * @fileoverview YouTube Media Controller - Wrapper for YouTube Media API
   */

  /**
   * YouTube Media Controller - Wrapper for YouTube Media API
   * @param {videojs.Player|Object} player
   * @param {Object=} options
   * @param {Function=} ready
   * @constructor
   */

  function addEventListener(element, event, cb) {
    if(!element.addEventListener) {
      element.attachEvent(event, cb);
    } else {
      element.addEventListener(event, cb, true);
    }
  }

  videojs.Youtube = videojs.MediaTechController.extend({
    /** @constructor */
    init: function(player, options, ready) {
      // Save this for internal usage
      this.player_ = player;

      // No event is triggering this for YouTube
      this['featuresProgressEvents'] = false;
      this['featuresTimeupdateEvents'] = false;
      // Enable rate changes
      this['featuresPlaybackRate'] = true;

      this['featuresNativeTextTracks'] = true;

      videojs.MediaTechController.call(this, player, options, ready);

      this.isIos = /(iPad|iPhone|iPod)/g.test( navigator.userAgent );
      this.isAndroid = /(Android)/g.test( navigator.userAgent );
      //used to prevent play events on IOS7 and Android > 4.2 until the user has clicked the player
      this.playVideoIsAllowed = !(this.isIos || this.isAndroid);

      // autoplay is disabled for mobile
      if (this.isIos || this.isAndroid) {
        this.player_.options()['autoplay'] = false;
      }

      // Copy the JavaScript options if they exists
      if(typeof options['source'] !== 'undefined') {
        for(var key in options['source']) {
          if(options['source'].hasOwnProperty(key)) {
            player.options()[key] = options['source'][key];
          }
        }
      }

      this.player_.options()['playbackRates'] = [];

      this.userQuality = videojs.Youtube.convertQualityName(player.options()['quality']);

      this.playerEl_ = player.el();
      this.playerEl_.className += ' vjs-youtube';

      // Create the Quality button
      this.qualityButton = document.createElement('div');
      this.qualityButton.setAttribute('class', 'vjs-quality-button vjs-menu-button vjs-control');
      this.qualityButton.setAttribute('tabindex', 0);

      var qualityContent = document.createElement('div');
      qualityContent.setAttribute('class', 'vjs-control-content');
      this.qualityButton.appendChild(qualityContent);

      this.qualityTitle = document.createElement('span');
      this.qualityTitle.setAttribute('class', 'vjs-control-text');
      qualityContent.appendChild(this.qualityTitle);

      if(player.options()['quality'] !== 'undefined') {
        setInnerText(this.qualityTitle, player.options()['quality'] || 'auto');
      }

      var qualityMenu = document.createElement('div');
      qualityMenu.setAttribute('class', 'vjs-menu');
      qualityContent.appendChild(qualityMenu);

      this.qualityMenuContent = document.createElement('ul');
      this.qualityMenuContent.setAttribute('class', 'vjs-menu-content');
      qualityMenu.appendChild(this.qualityMenuContent);

      this.id_ = this.player_.id() + '_youtube_api';

      this.el_ = videojs.Component.prototype.createEl('iframe', {
        id: this.id_,
        className: 'vjs-tech',
        scrolling: 'no',
        marginWidth: 0,
        marginHeight: 0,
        frameBorder: 0
      });

      this.el_.setAttribute('allowFullScreen', '');

      this.playerEl_.insertBefore(this.el_, this.playerEl_.firstChild);

      if(/MSIE (\d+\.\d+);/.test(navigator.userAgent)) {
        var ieVersion = Number(RegExp.$1);
        this.addIframeBlocker(ieVersion);
      } else if(!/(iPad|iPhone|iPod|Android)/g.test(navigator.userAgent)) {
        // the pointer-events: none block the mobile player
        this.el_.className += ' onDesktop';
        this.addIframeBlocker();
      }

      this.parseSrc(player.options()['src']);

      this.playOnReady = this.player_.options()['autoplay'] && this.playVideoIsAllowed;
      this.forceHTML5 = !!(
        typeof this.player_.options()['forceHTML5'] === 'undefined' ||
          this.player_.options()['forceHTML5'] === true
        );

      this.updateIframeSrc();

      var self = this;

      player.ready(function() {
        if (self.player_.options()['controls']) {
          var controlBar = self.playerEl_.querySelectorAll('.vjs-control-bar')[0];
          if (controlBar) {
            controlBar.appendChild(self.qualityButton);
          }
        }

        if(self.playOnReady && !self.player_.options()['ytcontrols']) {
          if(typeof self.player_.loadingSpinner !== 'undefined') {
            self.player_.loadingSpinner.show();
          }
          if(typeof self.player_.bigPlayButton !== 'undefined') {
            self.player_.bigPlayButton.hide();
          }
        }

        player.trigger('loadstart');
      });

      this.on('dispose', function() {
        if(this.ytplayer) {
          this.ytplayer.destroy();
        }

        if(!this.player_.options()['ytcontrols']) {
          this.player_.off('waiting', this.bindedWaiting);
        }

        // Remove the poster
        this.playerEl_.querySelectorAll('.vjs-poster')[0].style.backgroundImage = 'none';

        // If still connected to the DOM, remove it.
        if(this.el_.parentNode) {
          this.el_.parentNode.removeChild(this.el_);
        }

        // Get rid of the created DOM elements
        if (this.qualityButton.parentNode) {
          this.qualityButton.parentNode.removeChild(this.qualityButton);
        }

        if(typeof this.player_.loadingSpinner !== 'undefined') {
          this.player_.loadingSpinner.hide();
        }
        if(typeof this.player_.bigPlayButton !== 'undefined') {
          this.player_.bigPlayButton.hide();
        }

        if(this.iframeblocker) {
          this.playerEl_.removeChild(this.iframeblocker);
        }
      });
    }
  });

  // Tries to get the highest resolution thumbnail available for the video
  videojs.Youtube.prototype.loadThumbnailUrl = function(id, callback){

    var uri = 'https://img.youtube.com/vi/' + id + '/maxresdefault.jpg';
    var fallback = 'https://img.youtube.com/vi/' + id + '/0.jpg';

    try{
      var image = new Image();
      image.onload = function(){
        // Onload may still be called if YouTube returns the 120x90 error thumbnail
        if('naturalHeight' in this){
          if(this.naturalHeight <= 90 || this.naturalWidth <= 120) {
            this.onerror();
            return;
          }
        } else if(this.height <= 90 || this.width <= 120) {
          this.onerror();
          return;
        }

        callback(uri);
      };
      image.onerror = function(){
        callback(fallback);
      };
      image.src = uri;
    }
    catch(e){ callback(fallback); }
  };

  videojs.Youtube.prototype.updateIframeSrc = function() {
    var fullscreenControls = (
      typeof this.player_.options()['ytFullScreenControls'] !== 'undefined' &&
      !this.player_.options()['ytFullScreenControls']
    ) ? 0 : 1;

    var params = {
      enablejsapi: 1,
      /*jshint -W106 */
      iv_load_policy: 3,
      /*jshint +W106 */
      playerapiid: this.id(),
      disablekb: 1,
      wmode: 'transparent',
      controls: (this.player_.options()['ytcontrols']) ? 1 : 0,
      fs: fullscreenControls,
      html5: (this.player_.options()['forceHTML5']) ? 1 : null,
      playsinline: (this.player_.options()['playsInline']) ? 1 : 0,
      showinfo: 0,
      rel: 0,
      autoplay: (this.playOnReady) ? 1 : 0,
      loop: (this.player_.options()['loop']) ? 1 : 0,
      list: this.playlistId,
      vq: this.userQuality,
      origin: window.location.protocol + '//' + window.location.host
    };

    var isLocalProtocol = window.location.protocol === 'file:' || window.location.protocol === 'app:';

    // When running with no Web server, we can't specify the origin or it will break the YouTube API messages
    if(isLocalProtocol) {
      delete params.origin;
    }

    // Delete unset properties
    for(var prop in params) {
      if(params.hasOwnProperty(prop) &&
        ( typeof params[ prop ] === 'undefined' || params[ prop ] === null )
        ) {
        delete params[ prop ];
      }
    }
    var self = this;

    if(!this.videoId && !this.playlistId) {
      this.el_.src = 'about:blank';
      setTimeout(function() {
        self.triggerReady();
      }, 500);
    } else {
      this.el_.src = 'https://www.youtube.com/embed/' +
                     (this.videoId || 'videoseries') + '?' + videojs.Youtube.makeQueryString(params);

      if(this.player_.options()['ytcontrols']) {
        // Disable the video.js controls if we use the YouTube controls
        this.player_.controls(false);
      } else if(this.videoId && (typeof this.player_.poster() === 'undefined' || this.player_.poster().length === 0)) {
        // Wait here because the tech is still null in constructor
        setTimeout(function() {
          self.loadThumbnailUrl(self.videoId, function(url){
            self.player_.poster(url);
          });
        }, 100);
      }

      this.bindedWaiting = function() {
        self.onWaiting();
      };

      this.player_.on('waiting', this.bindedWaiting);

      if(videojs.Youtube.apiReady) {
        this.loadYoutube();
      } else {
        // Add to the queue because the YouTube API is not ready
        videojs.Youtube.loadingQueue.push(this);

        // Load the YouTube API if it is the first YouTube video
        if(!videojs.Youtube.apiLoading) {
          var tag = document.createElement('script');
          tag.onerror = function(e) {
            self.onError(e);
          };
          tag.src = 'https://www.youtube.com/iframe_api';
          var firstScriptTag = document.getElementsByTagName('script')[0];
          firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
          videojs.Youtube.apiLoading = true;
        }
      }
    }
  };

  videojs.Youtube.prototype.onWaiting = function(/*e*/) {
    // Make sure to hide the play button while the spinner is there
    if(typeof this.player_.bigPlayButton !== 'undefined') {
      this.player_.bigPlayButton.hide();
    }
  };

  videojs.Youtube.prototype.addIframeBlocker = function(ieVersion) {
    this.iframeblocker = videojs.Component.prototype.createEl('div');

    this.iframeblocker.className = 'iframeblocker';

    this.iframeblocker.style.position = 'absolute';
    this.iframeblocker.style.left = 0;
    this.iframeblocker.style.right = 0;
    this.iframeblocker.style.top = 0;
    this.iframeblocker.style.bottom = 0;

    // Odd quirk for IE8 (doesn't support rgba)
    if(ieVersion && ieVersion < 9) {
      this.iframeblocker.style.opacity = 0.01;
    } else {
      this.iframeblocker.style.background = 'rgba(255, 255, 255, 0.01)';
    }

    var self = this;
    addEventListener(this.iframeblocker, 'mousemove', function(e) {
      if(!self.player_.userActive()) {
        self.player_.userActive(true);
      }

      e.stopPropagation();
      e.preventDefault();
    });

    addEventListener(this.iframeblocker, 'click', function(/*e*/) {
      if(self.paused()) {
        self.play();
      } else {
        self.pause();
      }
    });

    this.playerEl_.insertBefore(this.iframeblocker, this.el_.nextSibling);
  };

  videojs.Youtube.prototype.parseSrc = function(src) {
    this.srcVal = src;

    if(src) {
      // Regex to parse the video ID
      var regId = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      var match = src.match(regId);

      if(match && match[2].length === 11) {
        this.videoId = match[2];
      } else {
        this.videoId = null;
      }

      // Regex to parse the playlist ID
      var regPlaylist = /[?&]list=([^#\&\?]+)/;
      match = src.match(regPlaylist);

      if(match !== null && match.length > 1) {
        this.playlistId = match[1];
      } else {
        // Make sure their is no playlist
        if(this.playlistId) {
          delete this.playlistId;
        }
      }

      // Parse video quality option
      var regVideoQuality = /[?&]vq=([^#\&\?]+)/;
      match = src.match(regVideoQuality);

      if(match !== null && match.length > 1) {
        this.userQuality = match[1];
        videojs.Youtube.appendQualityLabel(this.qualityTitle, this.userQuality);
      }
    }
  };

  videojs.Youtube.prototype.src = function(src) {
    if(typeof src !== 'undefined') {
      this.parseSrc(src);

      if(this.el_.src === 'about:blank') {
        this.updateIframeSrc();
        return;
      }

      delete this.defaultQuality;

      if(this.videoId !== null) {
        if(this.player_.options()['autoplay'] && this.playVideoIsAllowed) {
          this.ytplayer.loadVideoById({
            videoId: this.videoId,
            suggestedQuality: this.userQuality
          });
        } else {
          this.ytplayer.cueVideoById({
            videoId: this.videoId,
            suggestedQuality: this.userQuality
          });
        }

        var self = this;
        this.loadThumbnailUrl(this.videoId, function(url){
            // Update the poster
            self.playerEl_.querySelectorAll('.vjs-poster')[0].style.backgroundImage =
              'url(' + url + ')';
            self.player_.poster(url);
        });
      }
      /* else Invalid URL */
    }

    return this.srcVal;
  };

  videojs.Youtube.prototype.load = function() {
  };

  videojs.Youtube.prototype.play = function() {
    if(this.videoId !== null) {

      // Make sure to not display the spinner for mobile
      if(!this.player_.options()['ytcontrols']) {
        // Display the spinner until the video is playing by YouTube
        this.player_.trigger('waiting');
      }

      if(this.isReady_) {
        // Sync the player volume with YouTube
        this.ytplayer.setVolume(this.player_.volume() * 100);

        if(this.volumeVal > 0) {
          this.ytplayer.unMute();
        } else {
          this.ytplayer.mute();
        }

        if(this.playVideoIsAllowed) {
          this.ytplayer.playVideo();
        }
      } else {
        this.playOnReady = true;
      }
    }
  };

  videojs.Youtube.prototype.pause = function() {
    if(this.ytplayer) {
      this.ytplayer.pauseVideo();
    }
  };
  videojs.Youtube.prototype.paused = function() {
    return (this.ytplayer) ?
      (this.lastState !== YT.PlayerState.PLAYING && this.lastState !== YT.PlayerState.BUFFERING)
      : true;
  };
  videojs.Youtube.prototype.currentTime = function() {
    return (this.ytplayer && this.ytplayer.getCurrentTime) ? this.ytplayer.getCurrentTime() : 0;
  };
  videojs.Youtube.prototype.setCurrentTime = function(seconds) {
    if (this.lastState === YT.PlayerState.PAUSED) {
      this.timeBeforeSeek = this.currentTime();
    }

    this.ytplayer.seekTo(seconds, true);
    this.player_.trigger('timeupdate');
    this.player_.trigger('seeking');
    this.isSeeking = true;

    // A seek event during pause does not return an event to trigger a seeked event,
    // so run an interval timer to look for the currentTime to change
    if (this.lastState === YT.PlayerState.PAUSED && this.timeBeforeSeek !== seconds) {
      this.checkSeekedInPauseInterval = setInterval( videojs.bind(this, function() {
        if (this.lastState !== YT.PlayerState.PAUSED || !this.isSeeking) {
          // If something changed while we were waiting for the currentTime to change,
          //  clear the interval timer
          clearInterval(this.checkSeekedInPauseInterval);
        } else if (this.currentTime() !== this.timeBeforeSeek) {
          this.player_.trigger('timeupdate');
          this.player_.trigger('seeked');
          this.isSeeking = false;
          clearInterval(this.checkSeekedInPauseInterval);
        }
      }), 250);
    }
  };

  videojs.Youtube.prototype.playbackRate = function() {
    return (this.ytplayer && this.ytplayer.getPlaybackRate) ? this.ytplayer.getPlaybackRate() : 1.0;
  };

  videojs.Youtube.prototype.setPlaybackRate = function(suggestedRate) {
    if (this.ytplayer && this.ytplayer.setPlaybackRate) {
      this.ytplayer.setPlaybackRate(suggestedRate);
      var self = this;
      setTimeout(function () {
        self.player_.trigger('ratechange');
      }, 100);
    }
  };

  videojs.Youtube.prototype.duration = function() {
    return (this.ytplayer && this.ytplayer.getDuration) ? this.ytplayer.getDuration() : 0;
  };

  videojs.Youtube.prototype.currentSrc = function() {
    return this.srcVal;
  };
  
  videojs.Youtube.prototype.ended = function() {
    return (this.ytplayer) ? (this.lastState === YT.PlayerState.ENDED) : false;
  };

  videojs.Youtube.prototype.volume = function() {
    if(this.ytplayer && isNaN(this.volumeVal)) {
      this.volumeVal = this.ytplayer.getVolume() / 100.0;
      this.volumeVal = (isNaN(this.volumeVal)) ? 1 : this.volumeVal;
      this.player_.volume(this.volumeVal);
    }

    return this.volumeVal;
  };

  videojs.Youtube.prototype.setVolume = function(percentAsDecimal) {
    if(typeof(percentAsDecimal) !== 'undefined' && percentAsDecimal !== this.volumeVal) {
      this.ytplayer.setVolume(percentAsDecimal * 100.0);
      this.volumeVal = percentAsDecimal;
      this.player_.trigger('volumechange');
    }
  };

  videojs.Youtube.prototype.muted = function() {
    return this.mutedVal;
  };
  videojs.Youtube.prototype.setMuted = function(muted) {
    if(muted) {
      this.storedVolume = this.volumeVal;
      this.ytplayer.mute();
      this.player_.volume(0);
    } else {
      this.ytplayer.unMute();
      this.player_.volume(this.storedVolume);
    }

    this.mutedVal = muted;

    this.player_.trigger('volumechange');
  };

  videojs.Youtube.prototype.buffered = function() {
    if(this.ytplayer && this.ytplayer.getVideoBytesLoaded) {
      var loadedBytes = this.ytplayer.getVideoBytesLoaded();
      var totalBytes = this.ytplayer.getVideoBytesTotal();
      if(!loadedBytes || !totalBytes) {
        return 0;
      }

      var duration = this.ytplayer.getDuration();
      var secondsBuffered = (loadedBytes / totalBytes) * duration;
      var secondsOffset = (this.ytplayer.getVideoStartBytes() / totalBytes) * duration;

      return videojs.createTimeRange(secondsOffset, secondsOffset + secondsBuffered);
    } else {
      return videojs.createTimeRange(0, 0);
    }
  };

  videojs.Youtube.prototype.supportsFullScreen = function() {
    if (typeof this.el_.webkitEnterFullScreen === 'function') {

        // Seems to be broken in Chromium/Chrome && Safari in Leopard
        if (/Android/.test(videojs.USER_AGENT) || !/Chrome|Mac OS X 10.5/.test(videojs.USER_AGENT)) {
            return true;
        }
    }
    return false;
  };

  // YouTube is supported on all platforms
  videojs.Youtube.isSupported = function() {
    return true;
  };

  // You can use video/youtube as a media in your HTML5 video to specify the source
  videojs.Youtube.canPlaySource = function(srcObj) {
    return (srcObj.type === 'video/youtube');
  };

  // Always can control the volume
  videojs.Youtube.canControlVolume = function() {
    return true;
  };

  ////////////////////////////// YouTube specific functions //////////////////////////////

  // All videos created before YouTube API is loaded
  videojs.Youtube.loadingQueue = [];

  // Create the YouTube player
  videojs.Youtube.prototype.loadYoutube = function() {
    var self = this;
    this.ytplayer = new YT.Player(this.id_, {
      events: {
        onReady: function(e) {
          e.target.vjsTech.onReady();
          self.player_.trigger('ratechange');
        },
        onStateChange: function(e) {
          e.target.vjsTech.onStateChange(e.data);
        },
        onPlaybackQualityChange: function(e) {
          e.target.vjsTech.onPlaybackQualityChange(e.data);
        },
        onError: function(e) {
          e.target.vjsTech.onError(e.data);
        }
      }
    });

    this.ytplayer.vjsTech = this;
  };

  // Transform a JavaScript object into URL params
  videojs.Youtube.makeQueryString = function(args) {
    var array = ['modestbranding=1'];
    for(var key in args) {
      if(args.hasOwnProperty(key)) {
        array.push(key + '=' + args[key]);
      }
    }

    return array.join('&');
  };

  // Called when YouTube API is ready to be used
  window.onYouTubeIframeAPIReady = function() {
    var yt;
    while((yt = videojs.Youtube.loadingQueue.shift())) {
      yt.loadYoutube();
    }
    videojs.Youtube.loadingQueue = [];
    videojs.Youtube.apiReady = true;
  };

  videojs.Youtube.prototype.onReady = function() {
    this.isReady_ = true;
    this.triggerReady();

    this.player_.options()['playbackRates'] = this.ytplayer.getAvailablePlaybackRates();
    this.player_.controlBar.playbackRateMenuButton.update();

    this.player_.trigger('loadedmetadata');

    // The duration is loaded so we might as well fire off the timeupdate and duration events
    // this allows for the duration of the video (timeremaining) to be displayed if styled
    // to show the control bar initially. This gives the user the ability to see how long the video
    // is before clicking play
    this.player_.trigger('durationchange');
    this.player_.trigger('timeupdate');

    // Let the player take care of itself as soon as the YouTube is ready
    // The loading spinner while waiting for the tech would be impossible otherwise
    if (typeof this.player_.loadingSpinner !== 'undefined' && !this.isIos && !this.isAndroid) {
      this.player_.loadingSpinner.hide();
    }

    if(this.player_.options()['muted']) {
      this.setMuted(true);
    }

    // Set the poster of the first video of the playlist if not specified
    if (!this.videoId && this.playlistId) {
      this.videoId = this.ytplayer.getPlaylist()[0];
        var self = this;
        this.loadThumbnailUrl(this.videoId, function(url){
          self.player_.poster(url);
        });
    }

    // Play ASAP if they clicked play before it's ready
    if(this.playOnReady) {
      this.playOnReady = false;
      this.play();
    }
  };


  videojs.Youtube.prototype.updateCaptions = function() {
    this.ytplayer.loadModule('captions');
    this.ytplayer.loadModule('cc');

    var options = this.ytplayer.getOptions();
    // The name of the captions module: 'captions' for html5 or 'cc' for flash
    var cc = options.indexOf('captions') >= 0? 'captions'
          : (options.indexOf('cc') >= 0? 'cc' : null);

    if(cc !== null && !this.tracked_){

      var tracks = this.ytplayer.getOption(cc, 'tracklist');

      if(tracks && tracks.length > 0){

        var tt;
        for(var i = 0; i < tracks.length; i++){
          tt = this.addTextTrack('captions', tracks[i].displayName, tracks[i].languageCode);
        }

        var self = this;
        this.textTracks().on('change', function(){
          var code = null;
          for(var i = 0; i < this.length; i++){
            if(this[i].mode === 'showing'){
              code = this[i].language;
              break;
            }
          }

          if(code !== null){
            self.ytplayer.setOption(cc, 'track', {'languageCode': code});
          }
          else{
            self.ytplayer.setOption(cc, 'track', {});
          }

        });

        this.tracked_ = true;
      }
    }
  };

  videojs.Youtube.prototype.updateQualities = function() {

    function setupEventListener(el) {
      addEventListener(el, 'click', function() {
        var quality = this.getAttribute('data-val');
        self.ytplayer.setPlaybackQuality(quality);

        self.userQuality = quality;
        videojs.Youtube.appendQualityLabel(self.qualityTitle, quality);

        var selected = self.qualityMenuContent.querySelector('.vjs-selected');
        if(selected) {
          videojs.Youtube.removeClass(selected, 'vjs-selected');
        }

        videojs.Youtube.addClass(this, 'vjs-selected');
      });
    }

    var qualities = this.ytplayer.getAvailableQualityLevels();
    var self = this;

    if(qualities.indexOf(this.userQuality) < 0) {
      videojs.Youtube.appendQualityLabel(self.qualityTitle, this.defaultQuality);
    }

    if(qualities.length === 0) {
      this.qualityButton.style.display = 'none';
    } else {
      this.qualityButton.style.display = '';

      while(this.qualityMenuContent.hasChildNodes()) {
        this.qualityMenuContent.removeChild(this.qualityMenuContent.lastChild);
      }

      for(var i = 0; i < qualities.length; ++i) {
        var el = document.createElement('li');
        el.setAttribute('class', 'vjs-menu-item');
        el.setAttribute('data-val', qualities[i]);
        videojs.Youtube.appendQualityLabel(el, qualities[i]);
        if(qualities[i] === this.quality) {
          videojs.Youtube.addClass(el, 'vjs-selected');
        }
        setupEventListener(el);

        this.qualityMenuContent.appendChild(el);
      }
    }
  };
  		 
var title = "";
  videojs.Youtube.prototype.onStateChange = function(state) {
    if(state !== this.lastState) {
             $.get('https://www.googleapis.com/youtube/v3/videos?id='+this.videoId+'&key=AIzaSyCW0OAJgcHlErEzYf9SNAJwOn3uT1bHj9Y&part=status,snippet,player',function(data) {  
				title = data.items[0].snippet.title;        	
			});
          
      switch(state) {
		   
        case -1:
          this.player_.trigger('durationchange');
          break;

        case YT.PlayerState.ENDED:
          var stopPlaying = true;

          // Stop the playlist when it is starting over
          if (this.playlistId && !this.player_.options()['loop']) {
            stopPlaying = this.ytplayer.getPlaylistIndex() === 0;
          }

          if (stopPlaying) {
            // Replace YouTube play button by our own
            if(!this.player_.options()['ytcontrols']) {
              this.playerEl_.querySelectorAll('.vjs-poster')[0].style.display = 'block';
              if(typeof this.player_.bigPlayButton !== 'undefined') {
                this.player_.bigPlayButton.show();
              }
            }

            this.player_.trigger('pause');
            this.player_.trigger('ended');
          }
		  try{
			utag.link({
			'eventCategory' : page_section,
			'eventAction' : 'end video',
			'eventLabel': title,
			'event' : 'endVideo'});
			}catch(err){
					utagError=err;
			}

          break;

        case YT.PlayerState.PLAYING:
          this.playerEl_.querySelectorAll('.vjs-poster')[0].style.display = 'none';

          this.playVideoIsAllowed = true;
          this.updateQualities();
          this.updateCaptions();
          this.player_.trigger('timeupdate');
          this.player_.trigger('durationchange');
          this.player_.trigger('playing');
          this.player_.trigger('play');

          if (this.isSeeking) {
            this.player_.trigger('seeked');
            this.isSeeking = false;
          }
		  	
		try{

		utag.link({
		'eventCategory' : page_section,
		'eventAction' : 'play video',
		'eventLabel': title,
		'event' : 'playVideo'});
		}catch(err){
				utagError=err;
		}
          break;

        case YT.PlayerState.PAUSED:
          this.player_.trigger('pause');
		try{
		utag.link({
		'eventCategory' : page_section,
		'eventAction' : 'pause video',
		'eventLabel': title,
		'event' : 'pauseVideo'});
		}catch(err){
				utagError=err;
		}
          break;

        case YT.PlayerState.BUFFERING:
          this.player_.trigger('timeupdate');

          // Make sure to not display the spinner for mobile
          if(!this.player_.options()['ytcontrols']) {
            this.player_.trigger('waiting');
          }
          break;

        case YT.PlayerState.CUED:
          break;
      }

      this.lastState = state;
    }
  };

  videojs.Youtube.convertQualityName = function(name) {
    switch(name) {
      case '144p':
        return 'tiny';

      case '240p':
        return 'small';

      case '360p':
        return 'medium';

      case '480p':
        return 'large';

      case '720p':
        return 'hd720';

      case '1080p':
        return 'hd1080';

      case '1440p':
        return 'hd1440';

      case '2160p':
        return 'hd2160';
    }

    return 'auto';
  };

  videojs.Youtube.parseQualityName = function(name) {
    switch(name) {
      case 'tiny':
        return '144p';

      case 'small':
        return '240p';

      case 'medium':
        return '360p';

      case 'large':
        return '480p';

      case 'hd720':
        return '720p';

      case 'hd1080':
        return '1080p';

      case 'hd1440':
        return '1440p';

      case 'hd2160':
        return '2160p';
    }

    return 'auto';
  };

  videojs.Youtube.appendQualityLabel = function(element, quality) {
    setInnerText(element, videojs.Youtube.parseQualityName(quality));

    var label = document.createElement('span');
    label.setAttribute('class', 'vjs-hd-label');

    switch(quality) {
      case 'hd720':
      case 'hd1080':
      case 'hd1440':
        setInnerText(label, 'HD');
        element.appendChild(label);
        break;

      case 'hd2160':
        setInnerText(label, '4K');
        element.appendChild(label);
        break;
    }
  };

  videojs.Youtube.prototype.onPlaybackQualityChange = function(quality) {
    if(typeof this.defaultQuality === 'undefined') {
      this.defaultQuality = quality;

      if(typeof this.userQuality !== 'undefined') {
        return;
      }
    }

    this.quality = quality;
    videojs.Youtube.appendQualityLabel(this.qualityTitle, quality);

    switch(quality) {
      case 'medium':
        this.player_.videoWidth = 480;
        this.player_.videoHeight = 360;
        break;

      case 'large':
        this.player_.videoWidth = 640;
        this.player_.videoHeight = 480;
        break;

      case 'hd720':
        this.player_.videoWidth = 960;
        this.player_.videoHeight = 720;
        break;

      case 'hd1080':
        this.player_.videoWidth = 1440;
        this.player_.videoHeight = 1080;
        break;

      case 'highres':
        this.player_.videoWidth = 1920;
        this.player_.videoHeight = 1080;
        break;

      case 'small':
        this.player_.videoWidth = 320;
        this.player_.videoHeight = 240;
        break;

      case 'tiny':
        this.player_.videoWidth = 144;
        this.player_.videoHeight = 108;
        break;

      default:
        this.player_.videoWidth = 0;
        this.player_.videoHeight = 0;
        break;
    }

    this.player_.trigger('ratechange');
  };

  videojs.Youtube.prototype.onError = function(error) {
    this.player_.error(error);
  };

  /**
   * Add a CSS class name to an element
   * @param {Element} element    Element to add class name to
   * @param {String} classToAdd Classname to add
   */
  videojs.Youtube.addClass = function(element, classToAdd) {
    if((' ' + element.className + ' ').indexOf(' ' + classToAdd + ' ') === -1) {
      element.className = element.className === '' ? classToAdd : element.className + ' ' + classToAdd;
    }
  };

  /**
   * Remove a CSS class name from an element
   * @param {Element} element    Element to remove from class name
   * @param {String} classToRemove Classname to remove
   */
  videojs.Youtube.removeClass = function(element, classToRemove) {
    var classNames, i;

    if(element.className.indexOf(classToRemove) === -1) {
      return;
    }

    classNames = element.className.split(' ');

    // no arr.indexOf in ie8, and we don't want to add a big shim
    for(i = classNames.length - 1; i >= 0; i--) {
      if(classNames[i] === classToRemove) {
        classNames.splice(i, 1);
      }
    }

    element.className = classNames.join(' ');
  };

  // Cross-browsers support (IE8 wink wink)
  function setInnerText(element, text) {
    if(typeof element === 'undefined') {
      return false;
    }

    var textProperty = ('innerText' in element) ? 'innerText' : 'textContent';

    try {
      element[textProperty] = text;
    } catch(anException) {
      //IE<9 FIX
      element.setAttribute('innerText', text);
    }
  }


  // Stretch the YouTube poster
  var style = document.createElement('style');
  var def = ' ' +
    '.vjs-youtube .vjs-poster { background-size: 100%!important; }' +
    '.vjs-youtube .vjs-poster, ' +
    '.vjs-youtube .vjs-loading-spinner, ' +
    '.vjs-youtube .vjs-big-play-button, .vjs-youtube .vjs-text-track-display{ pointer-events: none !important; }' +
    '.vjs-youtube.vjs-user-active .iframeblocker { display: none; }' +
    '.vjs-youtube.vjs-user-inactive .vjs-tech.onDesktop { pointer-events: none; }' +
    '.vjs-quality-button > div:first-child > span:first-child { position:relative;top:7px }';

  style.setAttribute('type', 'text/css');
  document.getElementsByTagName('head')[0].appendChild(style);

  if(style.styleSheet) {
    style.styleSheet.cssText = def;
  } else {
    style.appendChild(document.createTextNode(def));
  }

  // IE8 fix for indexOf
  if(!Array.prototype.indexOf) {
    Array.prototype.indexOf = function(elt /*, from*/) {
      var len = this.length >>> 0; // jshint ignore:line

      var from = Number(arguments[1]) || 0;
      from = (from < 0) ?
        Math.ceil(from)
        : Math.floor(from);
      if(from < 0) {
        from += len;
      }

      for(; from < len; from++) {
        if(from in this && this[from] === elt) {
          return from;
        }
      }
      return -1;
    };
  }
})();

// ==================================================
// fancyBox v3.5.7
//
// Licensed GPLv3 for open source use
// or fancyBox Commercial License for commercial use
//
// http://fancyapps.com/fancybox/
// Copyright 2019 fancyApps
//
// ==================================================
!function(t,e,n,o){"use strict";function i(t,e){var o,i,a,s=[],r=0;t&&t.isDefaultPrevented()||(t.preventDefault(),e=e||{},t&&t.data&&(e=h(t.data.options,e)),o=e.$target||n(t.currentTarget).trigger("blur"),(a=n.fancybox.getInstance())&&a.$trigger&&a.$trigger.is(o)||(e.selector?s=n(e.selector):(i=o.attr("data-fancybox")||"",i?(s=t.data?t.data.items:[],s=s.length?s.filter('[data-fancybox="'+i+'"]'):n('[data-fancybox="'+i+'"]')):s=[o]),r=n(s).index(o),r<0&&(r=0),a=n.fancybox.open(s,e,r),a.$trigger=o))}if(t.console=t.console||{info:function(t){}},n){if(n.fn.fancybox)return void console.info("fancyBox already initialized");var a={closeExisting:!1,loop:!1,gutter:50,keyboard:!0,preventCaptionOverlap:!0,arrows:!0,infobar:!0,smallBtn:"auto",toolbar:"auto",buttons:["zoom","slideShow","thumbs","close"],idleTime:3,protect:!1,modal:!1,image:{preload:!1},ajax:{settings:{data:{fancybox:!0}}},iframe:{tpl:'<iframe id="fancybox-frame{rnd}" name="fancybox-frame{rnd}" class="fancybox-iframe" allowfullscreen="allowfullscreen" allow="autoplay; fullscreen" src=""></iframe>',preload:!0,css:{},attr:{scrolling:"auto"}},video:{tpl:'<video class="fancybox-video" controls controlsList="nodownload" poster="{{poster}}"><source src="{{src}}" type="{{format}}" />Sorry, your browser doesn\'t support embedded videos, <a href="{{src}}">download</a> and watch with your favorite video player!</video>',format:"",autoStart:!0},defaultType:"image",animationEffect:"zoom",animationDuration:366,zoomOpacity:"auto",transitionEffect:"fade",transitionDuration:366,slideClass:"",baseClass:"",baseTpl:'<div class="fancybox-container" role="dialog" tabindex="-1"><div class="fancybox-bg"></div><div class="fancybox-inner"><div class="fancybox-infobar"><span data-fancybox-index></span>&nbsp;/&nbsp;<span data-fancybox-count></span></div><div class="fancybox-toolbar">{{buttons}}</div><div class="fancybox-navigation">{{arrows}}</div><div class="fancybox-stage"></div><div class="fancybox-caption"><div class="fancybox-caption__body"></div></div></div></div>',spinnerTpl:'<div class="fancybox-loading"></div>',errorTpl:'<div class="fancybox-error"><p>{{ERROR}}</p></div>',btnTpl:{download:'<a download data-fancybox-download class="fancybox-button fancybox-button--download" title="{{DOWNLOAD}}" href="javascript:;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.62 17.09V19H5.38v-1.91zm-2.97-6.96L17 11.45l-5 4.87-5-4.87 1.36-1.32 2.68 2.64V5h1.92v7.77z"/></svg></a>',zoom:'<button data-fancybox-zoom class="fancybox-button fancybox-button--zoom" title="{{ZOOM}}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.7 17.3l-3-3a5.9 5.9 0 0 0-.6-7.6 5.9 5.9 0 0 0-8.4 0 5.9 5.9 0 0 0 0 8.4 5.9 5.9 0 0 0 7.7.7l3 3a1 1 0 0 0 1.3 0c.4-.5.4-1 0-1.5zM8.1 13.8a4 4 0 0 1 0-5.7 4 4 0 0 1 5.7 0 4 4 0 0 1 0 5.7 4 4 0 0 1-5.7 0z"/></svg></button>',close:'<button data-fancybox-close class="fancybox-button fancybox-button--close" title="{{CLOSE}}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 10.6L6.6 5.2 5.2 6.6l5.4 5.4-5.4 5.4 1.4 1.4 5.4-5.4 5.4 5.4 1.4-1.4-5.4-5.4 5.4-5.4-1.4-1.4-5.4 5.4z"/></svg></button>',arrowLeft:'<button data-fancybox-prev class="fancybox-button fancybox-button--arrow_left" title="{{PREV}}"><div><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11.28 15.7l-1.34 1.37L5 12l4.94-5.07 1.34 1.38-2.68 2.72H19v1.94H8.6z"/></svg></div></button>',arrowRight:'<button data-fancybox-next class="fancybox-button fancybox-button--arrow_right" title="{{NEXT}}"><div><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15.4 12.97l-2.68 2.72 1.34 1.38L19 12l-4.94-5.07-1.34 1.38 2.68 2.72H5v1.94z"/></svg></div></button>',smallBtn:'<button type="button" data-fancybox-close class="fancybox-button fancybox-close-small" title="{{CLOSE}}"><svg xmlns="http://www.w3.org/2000/svg" version="1" viewBox="0 0 24 24"><path d="M13 12l5-5-1-1-5 5-5-5-1 1 5 5-5 5 1 1 5-5 5 5 1-1z"/></svg></button>'},parentEl:"body",hideScrollbar:!0,autoFocus:!0,backFocus:!0,trapFocus:!0,fullScreen:{autoStart:!1},touch:{vertical:!0,momentum:!0},hash:null,media:{},slideShow:{autoStart:!1,speed:3e3},thumbs:{autoStart:!1,hideOnClose:!0,parentEl:".fancybox-container",axis:"y"},wheel:"auto",onInit:n.noop,beforeLoad:n.noop,afterLoad:n.noop,beforeShow:n.noop,afterShow:n.noop,beforeClose:n.noop,afterClose:n.noop,onActivate:n.noop,onDeactivate:n.noop,clickContent:function(t,e){return"image"===t.type&&"zoom"},clickSlide:"close",clickOutside:"close",dblclickContent:!1,dblclickSlide:!1,dblclickOutside:!1,mobile:{preventCaptionOverlap:!1,idleTime:!1,clickContent:function(t,e){return"image"===t.type&&"toggleControls"},clickSlide:function(t,e){return"image"===t.type?"toggleControls":"close"},dblclickContent:function(t,e){return"image"===t.type&&"zoom"},dblclickSlide:function(t,e){return"image"===t.type&&"zoom"}},lang:"en",i18n:{en:{CLOSE:"Close",NEXT:"Next",PREV:"Previous",ERROR:"The requested content cannot be loaded. <br/> Please try again later.",PLAY_START:"Start slideshow",PLAY_STOP:"Pause slideshow",FULL_SCREEN:"Full screen",THUMBS:"Thumbnails",DOWNLOAD:"Download",SHARE:"Share",ZOOM:"Zoom"},de:{CLOSE:"Schlie&szlig;en",NEXT:"Weiter",PREV:"Zur&uuml;ck",ERROR:"Die angeforderten Daten konnten nicht geladen werden. <br/> Bitte versuchen Sie es sp&auml;ter nochmal.",PLAY_START:"Diaschau starten",PLAY_STOP:"Diaschau beenden",FULL_SCREEN:"Vollbild",THUMBS:"Vorschaubilder",DOWNLOAD:"Herunterladen",SHARE:"Teilen",ZOOM:"Vergr&ouml;&szlig;ern"}}},s=n(t),r=n(e),c=0,l=function(t){return t&&t.hasOwnProperty&&t instanceof n},d=function(){return t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||t.oRequestAnimationFrame||function(e){return t.setTimeout(e,1e3/60)}}(),u=function(){return t.cancelAnimationFrame||t.webkitCancelAnimationFrame||t.mozCancelAnimationFrame||t.oCancelAnimationFrame||function(e){t.clearTimeout(e)}}(),f=function(){var t,n=e.createElement("fakeelement"),o={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(t in o)if(void 0!==n.style[t])return o[t];return"transitionend"}(),p=function(t){return t&&t.length&&t[0].offsetHeight},h=function(t,e){var o=n.extend(!0,{},t,e);return n.each(e,function(t,e){n.isArray(e)&&(o[t]=e)}),o},g=function(t){var o,i;return!(!t||t.ownerDocument!==e)&&(n(".fancybox-container").css("pointer-events","none"),o={x:t.getBoundingClientRect().left+t.offsetWidth/2,y:t.getBoundingClientRect().top+t.offsetHeight/2},i=e.elementFromPoint(o.x,o.y)===t,n(".fancybox-container").css("pointer-events",""),i)},b=function(t,e,o){var i=this;i.opts=h({index:o},n.fancybox.defaults),n.isPlainObject(e)&&(i.opts=h(i.opts,e)),n.fancybox.isMobile&&(i.opts=h(i.opts,i.opts.mobile)),i.id=i.opts.id||++c,i.currIndex=parseInt(i.opts.index,10)||0,i.prevIndex=null,i.prevPos=null,i.currPos=0,i.firstRun=!0,i.group=[],i.slides={},i.addContent(t),i.group.length&&i.init()};n.extend(b.prototype,{init:function(){var o,i,a=this,s=a.group[a.currIndex],r=s.opts;r.closeExisting&&n.fancybox.close(!0),n("body").addClass("fancybox-active"),!n.fancybox.getInstance()&&!1!==r.hideScrollbar&&!n.fancybox.isMobile&&e.body.scrollHeight>t.innerHeight&&(n("head").append('<style id="fancybox-style-noscroll" type="text/css">.compensate-for-scrollbar{margin-right:'+(t.innerWidth-e.documentElement.clientWidth)+"px;}</style>"),n("body").addClass("compensate-for-scrollbar")),i="",n.each(r.buttons,function(t,e){i+=r.btnTpl[e]||""}),o=n(a.translate(a,r.baseTpl.replace("{{buttons}}",i).replace("{{arrows}}",r.btnTpl.arrowLeft+r.btnTpl.arrowRight))).attr("id","fancybox-container-"+a.id).addClass(r.baseClass).data("FancyBox",a).appendTo(r.parentEl),a.$refs={container:o},["bg","inner","infobar","toolbar","stage","caption","navigation"].forEach(function(t){a.$refs[t]=o.find(".fancybox-"+t)}),a.trigger("onInit"),a.activate(),a.jumpTo(a.currIndex)},translate:function(t,e){var n=t.opts.i18n[t.opts.lang]||t.opts.i18n.en;return e.replace(/\{\{(\w+)\}\}/g,function(t,e){return void 0===n[e]?t:n[e]})},addContent:function(t){var e,o=this,i=n.makeArray(t);n.each(i,function(t,e){var i,a,s,r,c,l={},d={};n.isPlainObject(e)?(l=e,d=e.opts||e):"object"===n.type(e)&&n(e).length?(i=n(e),d=i.data()||{},d=n.extend(!0,{},d,d.options),d.$orig=i,l.src=o.opts.src||d.src||i.attr("href"),l.type||l.src||(l.type="inline",l.src=e)):l={type:"html",src:e+""},l.opts=n.extend(!0,{},o.opts,d),n.isArray(d.buttons)&&(l.opts.buttons=d.buttons),n.fancybox.isMobile&&l.opts.mobile&&(l.opts=h(l.opts,l.opts.mobile)),a=l.type||l.opts.type,r=l.src||"",!a&&r&&((s=r.match(/\.(mp4|mov|ogv|webm)((\?|#).*)?$/i))?(a="video",l.opts.video.format||(l.opts.video.format="video/"+("ogv"===s[1]?"ogg":s[1]))):r.match(/(^data:image\/[a-z0-9+\/=]*,)|(\.(jp(e|g|eg)|gif|png|bmp|webp|svg|ico)((\?|#).*)?$)/i)?a="image":r.match(/\.(pdf)((\?|#).*)?$/i)?(a="iframe",l=n.extend(!0,l,{contentType:"pdf",opts:{iframe:{preload:!1}}})):"#"===r.charAt(0)&&(a="inline")),a?l.type=a:o.trigger("objectNeedsType",l),l.contentType||(l.contentType=n.inArray(l.type,["html","inline","ajax"])>-1?"html":l.type),l.index=o.group.length,"auto"==l.opts.smallBtn&&(l.opts.smallBtn=n.inArray(l.type,["html","inline","ajax"])>-1),"auto"===l.opts.toolbar&&(l.opts.toolbar=!l.opts.smallBtn),l.$thumb=l.opts.$thumb||null,l.opts.$trigger&&l.index===o.opts.index&&(l.$thumb=l.opts.$trigger.find("img:first"),l.$thumb.length&&(l.opts.$orig=l.opts.$trigger)),l.$thumb&&l.$thumb.length||!l.opts.$orig||(l.$thumb=l.opts.$orig.find("img:first")),l.$thumb&&!l.$thumb.length&&(l.$thumb=null),l.thumb=l.opts.thumb||(l.$thumb?l.$thumb[0].src:null),"function"===n.type(l.opts.caption)&&(l.opts.caption=l.opts.caption.apply(e,[o,l])),"function"===n.type(o.opts.caption)&&(l.opts.caption=o.opts.caption.apply(e,[o,l])),l.opts.caption instanceof n||(l.opts.caption=void 0===l.opts.caption?"":l.opts.caption+""),"ajax"===l.type&&(c=r.split(/\s+/,2),c.length>1&&(l.src=c.shift(),l.opts.filter=c.shift())),l.opts.modal&&(l.opts=n.extend(!0,l.opts,{trapFocus:!0,infobar:0,toolbar:0,smallBtn:0,keyboard:0,slideShow:0,fullScreen:0,thumbs:0,touch:0,clickContent:!1,clickSlide:!1,clickOutside:!1,dblclickContent:!1,dblclickSlide:!1,dblclickOutside:!1})),o.group.push(l)}),Object.keys(o.slides).length&&(o.updateControls(),(e=o.Thumbs)&&e.isActive&&(e.create(),e.focus()))},addEvents:function(){var e=this;e.removeEvents(),e.$refs.container.on("click.fb-close","[data-fancybox-close]",function(t){t.stopPropagation(),t.preventDefault(),e.close(t)}).on("touchstart.fb-prev click.fb-prev","[data-fancybox-prev]",function(t){t.stopPropagation(),t.preventDefault(),e.previous()}).on("touchstart.fb-next click.fb-next","[data-fancybox-next]",function(t){t.stopPropagation(),t.preventDefault(),e.next()}).on("click.fb","[data-fancybox-zoom]",function(t){e[e.isScaledDown()?"scaleToActual":"scaleToFit"]()}),s.on("orientationchange.fb resize.fb",function(t){t&&t.originalEvent&&"resize"===t.originalEvent.type?(e.requestId&&u(e.requestId),e.requestId=d(function(){e.update(t)})):(e.current&&"iframe"===e.current.type&&e.$refs.stage.hide(),setTimeout(function(){e.$refs.stage.show(),e.update(t)},n.fancybox.isMobile?600:250))}),r.on("keydown.fb",function(t){var o=n.fancybox?n.fancybox.getInstance():null,i=o.current,a=t.keyCode||t.which;if(9==a)return void(i.opts.trapFocus&&e.focus(t));if(!(!i.opts.keyboard||t.ctrlKey||t.altKey||t.shiftKey||n(t.target).is("input,textarea,video,audio,select")))return 8===a||27===a?(t.preventDefault(),void e.close(t)):37===a||38===a?(t.preventDefault(),void e.previous()):39===a||40===a?(t.preventDefault(),void e.next()):void e.trigger("afterKeydown",t,a)}),e.group[e.currIndex].opts.idleTime&&(e.idleSecondsCounter=0,r.on("mousemove.fb-idle mouseleave.fb-idle mousedown.fb-idle touchstart.fb-idle touchmove.fb-idle scroll.fb-idle keydown.fb-idle",function(t){e.idleSecondsCounter=0,e.isIdle&&e.showControls(),e.isIdle=!1}),e.idleInterval=t.setInterval(function(){++e.idleSecondsCounter>=e.group[e.currIndex].opts.idleTime&&!e.isDragging&&(e.isIdle=!0,e.idleSecondsCounter=0,e.hideControls())},1e3))},removeEvents:function(){var e=this;s.off("orientationchange.fb resize.fb"),r.off("keydown.fb .fb-idle"),this.$refs.container.off(".fb-close .fb-prev .fb-next"),e.idleInterval&&(t.clearInterval(e.idleInterval),e.idleInterval=null)},previous:function(t){return this.jumpTo(this.currPos-1,t)},next:function(t){return this.jumpTo(this.currPos+1,t)},jumpTo:function(t,e){var o,i,a,s,r,c,l,d,u,f=this,h=f.group.length;if(!(f.isDragging||f.isClosing||f.isAnimating&&f.firstRun)){if(t=parseInt(t,10),!(a=f.current?f.current.opts.loop:f.opts.loop)&&(t<0||t>=h))return!1;if(o=f.firstRun=!Object.keys(f.slides).length,r=f.current,f.prevIndex=f.currIndex,f.prevPos=f.currPos,s=f.createSlide(t),h>1&&((a||s.index<h-1)&&f.createSlide(t+1),(a||s.index>0)&&f.createSlide(t-1)),f.current=s,f.currIndex=s.index,f.currPos=s.pos,f.trigger("beforeShow",o),f.updateControls(),s.forcedDuration=void 0,n.isNumeric(e)?s.forcedDuration=e:e=s.opts[o?"animationDuration":"transitionDuration"],e=parseInt(e,10),i=f.isMoved(s),s.$slide.addClass("fancybox-slide--current"),o)return s.opts.animationEffect&&e&&f.$refs.container.css("transition-duration",e+"ms"),f.$refs.container.addClass("fancybox-is-open").trigger("focus"),f.loadSlide(s),void f.preload("image");c=n.fancybox.getTranslate(r.$slide),l=n.fancybox.getTranslate(f.$refs.stage),n.each(f.slides,function(t,e){n.fancybox.stop(e.$slide,!0)}),r.pos!==s.pos&&(r.isComplete=!1),r.$slide.removeClass("fancybox-slide--complete fancybox-slide--current"),i?(u=c.left-(r.pos*c.width+r.pos*r.opts.gutter),n.each(f.slides,function(t,o){o.$slide.removeClass("fancybox-animated").removeClass(function(t,e){return(e.match(/(^|\s)fancybox-fx-\S+/g)||[]).join(" ")});var i=o.pos*c.width+o.pos*o.opts.gutter;n.fancybox.setTranslate(o.$slide,{top:0,left:i-l.left+u}),o.pos!==s.pos&&o.$slide.addClass("fancybox-slide--"+(o.pos>s.pos?"next":"previous")),p(o.$slide),n.fancybox.animate(o.$slide,{top:0,left:(o.pos-s.pos)*c.width+(o.pos-s.pos)*o.opts.gutter},e,function(){o.$slide.css({transform:"",opacity:""}).removeClass("fancybox-slide--next fancybox-slide--previous"),o.pos===f.currPos&&f.complete()})})):e&&s.opts.transitionEffect&&(d="fancybox-animated fancybox-fx-"+s.opts.transitionEffect,r.$slide.addClass("fancybox-slide--"+(r.pos>s.pos?"next":"previous")),n.fancybox.animate(r.$slide,d,e,function(){r.$slide.removeClass(d).removeClass("fancybox-slide--next fancybox-slide--previous")},!1)),s.isLoaded?f.revealContent(s):f.loadSlide(s),f.preload("image")}},createSlide:function(t){var e,o,i=this;return o=t%i.group.length,o=o<0?i.group.length+o:o,!i.slides[t]&&i.group[o]&&(e=n('<div class="fancybox-slide"></div>').appendTo(i.$refs.stage),i.slides[t]=n.extend(!0,{},i.group[o],{pos:t,$slide:e,isLoaded:!1}),i.updateSlide(i.slides[t])),i.slides[t]},scaleToActual:function(t,e,o){var i,a,s,r,c,l=this,d=l.current,u=d.$content,f=n.fancybox.getTranslate(d.$slide).width,p=n.fancybox.getTranslate(d.$slide).height,h=d.width,g=d.height;l.isAnimating||l.isMoved()||!u||"image"!=d.type||!d.isLoaded||d.hasError||(l.isAnimating=!0,n.fancybox.stop(u),t=void 0===t?.5*f:t,e=void 0===e?.5*p:e,i=n.fancybox.getTranslate(u),i.top-=n.fancybox.getTranslate(d.$slide).top,i.left-=n.fancybox.getTranslate(d.$slide).left,r=h/i.width,c=g/i.height,a=.5*f-.5*h,s=.5*p-.5*g,h>f&&(a=i.left*r-(t*r-t),a>0&&(a=0),a<f-h&&(a=f-h)),g>p&&(s=i.top*c-(e*c-e),s>0&&(s=0),s<p-g&&(s=p-g)),l.updateCursor(h,g),n.fancybox.animate(u,{top:s,left:a,scaleX:r,scaleY:c},o||366,function(){l.isAnimating=!1}),l.SlideShow&&l.SlideShow.isActive&&l.SlideShow.stop())},scaleToFit:function(t){var e,o=this,i=o.current,a=i.$content;o.isAnimating||o.isMoved()||!a||"image"!=i.type||!i.isLoaded||i.hasError||(o.isAnimating=!0,n.fancybox.stop(a),e=o.getFitPos(i),o.updateCursor(e.width,e.height),n.fancybox.animate(a,{top:e.top,left:e.left,scaleX:e.width/a.width(),scaleY:e.height/a.height()},t||366,function(){o.isAnimating=!1}))},getFitPos:function(t){var e,o,i,a,s=this,r=t.$content,c=t.$slide,l=t.width||t.opts.width,d=t.height||t.opts.height,u={};return!!(t.isLoaded&&r&&r.length)&&(e=n.fancybox.getTranslate(s.$refs.stage).width,o=n.fancybox.getTranslate(s.$refs.stage).height,e-=parseFloat(c.css("paddingLeft"))+parseFloat(c.css("paddingRight"))+parseFloat(r.css("marginLeft"))+parseFloat(r.css("marginRight")),o-=parseFloat(c.css("paddingTop"))+parseFloat(c.css("paddingBottom"))+parseFloat(r.css("marginTop"))+parseFloat(r.css("marginBottom")),l&&d||(l=e,d=o),i=Math.min(1,e/l,o/d),l*=i,d*=i,l>e-.5&&(l=e),d>o-.5&&(d=o),"image"===t.type?(u.top=Math.floor(.5*(o-d))+parseFloat(c.css("paddingTop")),u.left=Math.floor(.5*(e-l))+parseFloat(c.css("paddingLeft"))):"video"===t.contentType&&(a=t.opts.width&&t.opts.height?l/d:t.opts.ratio||16/9,d>l/a?d=l/a:l>d*a&&(l=d*a)),u.width=l,u.height=d,u)},update:function(t){var e=this;n.each(e.slides,function(n,o){e.updateSlide(o,t)})},updateSlide:function(t,e){var o=this,i=t&&t.$content,a=t.width||t.opts.width,s=t.height||t.opts.height,r=t.$slide;o.adjustCaption(t),i&&(a||s||"video"===t.contentType)&&!t.hasError&&(n.fancybox.stop(i),n.fancybox.setTranslate(i,o.getFitPos(t)),t.pos===o.currPos&&(o.isAnimating=!1,o.updateCursor())),o.adjustLayout(t),r.length&&(r.trigger("refresh"),t.pos===o.currPos&&o.$refs.toolbar.add(o.$refs.navigation.find(".fancybox-button--arrow_right")).toggleClass("compensate-for-scrollbar",r.get(0).scrollHeight>r.get(0).clientHeight)),o.trigger("onUpdate",t,e)},centerSlide:function(t){var e=this,o=e.current,i=o.$slide;!e.isClosing&&o&&(i.siblings().css({transform:"",opacity:""}),i.parent().children().removeClass("fancybox-slide--previous fancybox-slide--next"),n.fancybox.animate(i,{top:0,left:0,opacity:1},void 0===t?0:t,function(){i.css({transform:"",opacity:""}),o.isComplete||e.complete()},!1))},isMoved:function(t){var e,o,i=t||this.current;return!!i&&(o=n.fancybox.getTranslate(this.$refs.stage),e=n.fancybox.getTranslate(i.$slide),!i.$slide.hasClass("fancybox-animated")&&(Math.abs(e.top-o.top)>.5||Math.abs(e.left-o.left)>.5))},updateCursor:function(t,e){var o,i,a=this,s=a.current,r=a.$refs.container;s&&!a.isClosing&&a.Guestures&&(r.removeClass("fancybox-is-zoomable fancybox-can-zoomIn fancybox-can-zoomOut fancybox-can-swipe fancybox-can-pan"),o=a.canPan(t,e),i=!!o||a.isZoomable(),r.toggleClass("fancybox-is-zoomable",i),n("[data-fancybox-zoom]").prop("disabled",!i),o?r.addClass("fancybox-can-pan"):i&&("zoom"===s.opts.clickContent||n.isFunction(s.opts.clickContent)&&"zoom"==s.opts.clickContent(s))?r.addClass("fancybox-can-zoomIn"):s.opts.touch&&(s.opts.touch.vertical||a.group.length>1)&&"video"!==s.contentType&&r.addClass("fancybox-can-swipe"))},isZoomable:function(){var t,e=this,n=e.current;if(n&&!e.isClosing&&"image"===n.type&&!n.hasError){if(!n.isLoaded)return!0;if((t=e.getFitPos(n))&&(n.width>t.width||n.height>t.height))return!0}return!1},isScaledDown:function(t,e){var o=this,i=!1,a=o.current,s=a.$content;return void 0!==t&&void 0!==e?i=t<a.width&&e<a.height:s&&(i=n.fancybox.getTranslate(s),i=i.width<a.width&&i.height<a.height),i},canPan:function(t,e){var o=this,i=o.current,a=null,s=!1;return"image"===i.type&&(i.isComplete||t&&e)&&!i.hasError&&(s=o.getFitPos(i),void 0!==t&&void 0!==e?a={width:t,height:e}:i.isComplete&&(a=n.fancybox.getTranslate(i.$content)),a&&s&&(s=Math.abs(a.width-s.width)>1.5||Math.abs(a.height-s.height)>1.5)),s},loadSlide:function(t){var e,o,i,a=this;if(!t.isLoading&&!t.isLoaded){if(t.isLoading=!0,!1===a.trigger("beforeLoad",t))return t.isLoading=!1,!1;switch(e=t.type,o=t.$slide,o.off("refresh").trigger("onReset").addClass(t.opts.slideClass),e){case"image":a.setImage(t);break;case"iframe":a.setIframe(t);break;case"html":a.setContent(t,t.src||t.content);break;case"video":a.setContent(t,t.opts.video.tpl.replace(/\{\{src\}\}/gi,t.src).replace("{{format}}",t.opts.videoFormat||t.opts.video.format||"").replace("{{poster}}",t.thumb||""));break;case"inline":n(t.src).length?a.setContent(t,n(t.src)):a.setError(t);break;case"ajax":a.showLoading(t),i=n.ajax(n.extend({},t.opts.ajax.settings,{url:t.src,success:function(e,n){"success"===n&&a.setContent(t,e)},error:function(e,n){e&&"abort"!==n&&a.setError(t)}})),o.one("onReset",function(){i.abort()});break;default:a.setError(t)}return!0}},setImage:function(t){var o,i=this;setTimeout(function(){var e=t.$image;i.isClosing||!t.isLoading||e&&e.length&&e[0].complete||t.hasError||i.showLoading(t)},50),i.checkSrcset(t),t.$content=n('<div class="fancybox-content"></div>').addClass("fancybox-is-hidden").appendTo(t.$slide.addClass("fancybox-slide--image")),!1!==t.opts.preload&&t.opts.width&&t.opts.height&&t.thumb&&(t.width=t.opts.width,t.height=t.opts.height,o=e.createElement("img"),o.onerror=function(){n(this).remove(),t.$ghost=null},o.onload=function(){i.afterLoad(t)},t.$ghost=n(o).addClass("fancybox-image").appendTo(t.$content).attr("src",t.thumb)),i.setBigImage(t)},checkSrcset:function(e){var n,o,i,a,s=e.opts.srcset||e.opts.image.srcset;if(s){i=t.devicePixelRatio||1,a=t.innerWidth*i,o=s.split(",").map(function(t){var e={};return t.trim().split(/\s+/).forEach(function(t,n){var o=parseInt(t.substring(0,t.length-1),10);if(0===n)return e.url=t;o&&(e.value=o,e.postfix=t[t.length-1])}),e}),o.sort(function(t,e){return t.value-e.value});for(var r=0;r<o.length;r++){var c=o[r];if("w"===c.postfix&&c.value>=a||"x"===c.postfix&&c.value>=i){n=c;break}}!n&&o.length&&(n=o[o.length-1]),n&&(e.src=n.url,e.width&&e.height&&"w"==n.postfix&&(e.height=e.width/e.height*n.value,e.width=n.value),e.opts.srcset=s)}},setBigImage:function(t){var o=this,i=e.createElement("img"),a=n(i);t.$image=a.one("error",function(){o.setError(t)}).one("load",function(){var e;t.$ghost||(o.resolveImageSlideSize(t,this.naturalWidth,this.naturalHeight),o.afterLoad(t)),o.isClosing||(t.opts.srcset&&(e=t.opts.sizes,e&&"auto"!==e||(e=(t.width/t.height>1&&s.width()/s.height()>1?"100":Math.round(t.width/t.height*100))+"vw"),a.attr("sizes",e).attr("srcset",t.opts.srcset)),t.$ghost&&setTimeout(function(){t.$ghost&&!o.isClosing&&t.$ghost.hide()},Math.min(300,Math.max(1e3,t.height/1600))),o.hideLoading(t))}).addClass("fancybox-image").attr("src",t.src).appendTo(t.$content),(i.complete||"complete"==i.readyState)&&a.naturalWidth&&a.naturalHeight?a.trigger("load"):i.error&&a.trigger("error")},resolveImageSlideSize:function(t,e,n){var o=parseInt(t.opts.width,10),i=parseInt(t.opts.height,10);t.width=e,t.height=n,o>0&&(t.width=o,t.height=Math.floor(o*n/e)),i>0&&(t.width=Math.floor(i*e/n),t.height=i)},setIframe:function(t){var e,o=this,i=t.opts.iframe,a=t.$slide;t.$content=n('<div class="fancybox-content'+(i.preload?" fancybox-is-hidden":"")+'"></div>').css(i.css).appendTo(a),a.addClass("fancybox-slide--"+t.contentType),t.$iframe=e=n(i.tpl.replace(/\{rnd\}/g,(new Date).getTime())).attr(i.attr).appendTo(t.$content),i.preload?(o.showLoading(t),e.on("load.fb error.fb",function(e){this.isReady=1,t.$slide.trigger("refresh"),o.afterLoad(t)}),a.on("refresh.fb",function(){var n,o,s=t.$content,r=i.css.width,c=i.css.height;if(1===e[0].isReady){try{n=e.contents(),o=n.find("body")}catch(t){}o&&o.length&&o.children().length&&(a.css("overflow","visible"),s.css({width:"100%","max-width":"100%",height:"9999px"}),void 0===r&&(r=Math.ceil(Math.max(o[0].clientWidth,o.outerWidth(!0)))),s.css("width",r||"").css("max-width",""),void 0===c&&(c=Math.ceil(Math.max(o[0].clientHeight,o.outerHeight(!0)))),s.css("height",c||""),a.css("overflow","auto")),s.removeClass("fancybox-is-hidden")}})):o.afterLoad(t),e.attr("src",t.src),a.one("onReset",function(){try{n(this).find("iframe").hide().unbind().attr("src","//about:blank")}catch(t){}n(this).off("refresh.fb").empty(),t.isLoaded=!1,t.isRevealed=!1})},setContent:function(t,e){var o=this;o.isClosing||(o.hideLoading(t),t.$content&&n.fancybox.stop(t.$content),t.$slide.empty(),l(e)&&e.parent().length?((e.hasClass("fancybox-content")||e.parent().hasClass("fancybox-content"))&&e.parents(".fancybox-slide").trigger("onReset"),t.$placeholder=n("<div>").hide().insertAfter(e),e.css("display","inline-block")):t.hasError||("string"===n.type(e)&&(e=n("<div>").append(n.trim(e)).contents()),t.opts.filter&&(e=n("<div>").html(e).find(t.opts.filter))),t.$slide.one("onReset",function(){n(this).find("video,audio").trigger("pause"),t.$placeholder&&(t.$placeholder.after(e.removeClass("fancybox-content").hide()).remove(),t.$placeholder=null),t.$smallBtn&&(t.$smallBtn.remove(),t.$smallBtn=null),t.hasError||(n(this).empty(),t.isLoaded=!1,t.isRevealed=!1)}),n(e).appendTo(t.$slide),n(e).is("video,audio")&&(n(e).addClass("fancybox-video"),n(e).wrap("<div></div>"),t.contentType="video",t.opts.width=t.opts.width||n(e).attr("width"),t.opts.height=t.opts.height||n(e).attr("height")),t.$content=t.$slide.children().filter("div,form,main,video,audio,article,.fancybox-content").first(),t.$content.siblings().hide(),t.$content.length||(t.$content=t.$slide.wrapInner("<div></div>").children().first()),t.$content.addClass("fancybox-content"),t.$slide.addClass("fancybox-slide--"+t.contentType),o.afterLoad(t))},setError:function(t){t.hasError=!0,t.$slide.trigger("onReset").removeClass("fancybox-slide--"+t.contentType).addClass("fancybox-slide--error"),t.contentType="html",this.setContent(t,this.translate(t,t.opts.errorTpl)),t.pos===this.currPos&&(this.isAnimating=!1)},showLoading:function(t){var e=this;(t=t||e.current)&&!t.$spinner&&(t.$spinner=n(e.translate(e,e.opts.spinnerTpl)).appendTo(t.$slide).hide().fadeIn("fast"))},hideLoading:function(t){var e=this;(t=t||e.current)&&t.$spinner&&(t.$spinner.stop().remove(),delete t.$spinner)},afterLoad:function(t){var e=this;e.isClosing||(t.isLoading=!1,t.isLoaded=!0,e.trigger("afterLoad",t),e.hideLoading(t),!t.opts.smallBtn||t.$smallBtn&&t.$smallBtn.length||(t.$smallBtn=n(e.translate(t,t.opts.btnTpl.smallBtn)).appendTo(t.$content)),t.opts.protect&&t.$content&&!t.hasError&&(t.$content.on("contextmenu.fb",function(t){return 2==t.button&&t.preventDefault(),!0}),"image"===t.type&&n('<div class="fancybox-spaceball"></div>').appendTo(t.$content)),e.adjustCaption(t),e.adjustLayout(t),t.pos===e.currPos&&e.updateCursor(),e.revealContent(t))},adjustCaption:function(t){var e,n=this,o=t||n.current,i=o.opts.caption,a=o.opts.preventCaptionOverlap,s=n.$refs.caption,r=!1;s.toggleClass("fancybox-caption--separate",a),a&&i&&i.length&&(o.pos!==n.currPos?(e=s.clone().appendTo(s.parent()),e.children().eq(0).empty().html(i),r=e.outerHeight(!0),e.empty().remove()):n.$caption&&(r=n.$caption.outerHeight(!0)),o.$slide.css("padding-bottom",r||""))},adjustLayout:function(t){var e,n,o,i,a=this,s=t||a.current;s.isLoaded&&!0!==s.opts.disableLayoutFix&&(s.$content.css("margin-bottom",""),s.$content.outerHeight()>s.$slide.height()+.5&&(o=s.$slide[0].style["padding-bottom"],i=s.$slide.css("padding-bottom"),parseFloat(i)>0&&(e=s.$slide[0].scrollHeight,s.$slide.css("padding-bottom",0),Math.abs(e-s.$slide[0].scrollHeight)<1&&(n=i),s.$slide.css("padding-bottom",o))),s.$content.css("margin-bottom",n))},revealContent:function(t){var e,o,i,a,s=this,r=t.$slide,c=!1,l=!1,d=s.isMoved(t),u=t.isRevealed;return t.isRevealed=!0,e=t.opts[s.firstRun?"animationEffect":"transitionEffect"],i=t.opts[s.firstRun?"animationDuration":"transitionDuration"],i=parseInt(void 0===t.forcedDuration?i:t.forcedDuration,10),!d&&t.pos===s.currPos&&i||(e=!1),"zoom"===e&&(t.pos===s.currPos&&i&&"image"===t.type&&!t.hasError&&(l=s.getThumbPos(t))?c=s.getFitPos(t):e="fade"),"zoom"===e?(s.isAnimating=!0,c.scaleX=c.width/l.width,c.scaleY=c.height/l.height,a=t.opts.zoomOpacity,"auto"==a&&(a=Math.abs(t.width/t.height-l.width/l.height)>.1),a&&(l.opacity=.1,c.opacity=1),n.fancybox.setTranslate(t.$content.removeClass("fancybox-is-hidden"),l),p(t.$content),void n.fancybox.animate(t.$content,c,i,function(){s.isAnimating=!1,s.complete()})):(s.updateSlide(t),e?(n.fancybox.stop(r),o="fancybox-slide--"+(t.pos>=s.prevPos?"next":"previous")+" fancybox-animated fancybox-fx-"+e,r.addClass(o).removeClass("fancybox-slide--current"),t.$content.removeClass("fancybox-is-hidden"),p(r),"image"!==t.type&&t.$content.hide().show(0),void n.fancybox.animate(r,"fancybox-slide--current",i,function(){r.removeClass(o).css({transform:"",opacity:""}),t.pos===s.currPos&&s.complete()},!0)):(t.$content.removeClass("fancybox-is-hidden"),u||!d||"image"!==t.type||t.hasError||t.$content.hide().fadeIn("fast"),void(t.pos===s.currPos&&s.complete())))},getThumbPos:function(t){var e,o,i,a,s,r=!1,c=t.$thumb;return!(!c||!g(c[0]))&&(e=n.fancybox.getTranslate(c),o=parseFloat(c.css("border-top-width")||0),i=parseFloat(c.css("border-right-width")||0),a=parseFloat(c.css("border-bottom-width")||0),s=parseFloat(c.css("border-left-width")||0),r={top:e.top+o,left:e.left+s,width:e.width-i-s,height:e.height-o-a,scaleX:1,scaleY:1},e.width>0&&e.height>0&&r)},complete:function(){var t,e=this,o=e.current,i={};!e.isMoved()&&o.isLoaded&&(o.isComplete||(o.isComplete=!0,o.$slide.siblings().trigger("onReset"),e.preload("inline"),p(o.$slide),o.$slide.addClass("fancybox-slide--complete"),n.each(e.slides,function(t,o){o.pos>=e.currPos-1&&o.pos<=e.currPos+1?i[o.pos]=o:o&&(n.fancybox.stop(o.$slide),o.$slide.off().remove())}),e.slides=i),e.isAnimating=!1,e.updateCursor(),e.trigger("afterShow"),o.opts.video.autoStart&&o.$slide.find("video,audio").filter(":visible:first").trigger("play").one("ended",function(){Document.exitFullscreen?Document.exitFullscreen():this.webkitExitFullscreen&&this.webkitExitFullscreen(),e.next()}),o.opts.autoFocus&&"html"===o.contentType&&(t=o.$content.find("input[autofocus]:enabled:visible:first"),t.length?t.trigger("focus"):e.focus(null,!0)),o.$slide.scrollTop(0).scrollLeft(0))},preload:function(t){var e,n,o=this;o.group.length<2||(n=o.slides[o.currPos+1],e=o.slides[o.currPos-1],e&&e.type===t&&o.loadSlide(e),n&&n.type===t&&o.loadSlide(n))},focus:function(t,o){var i,a,s=this,r=["a[href]","area[href]",'input:not([disabled]):not([type="hidden"]):not([aria-hidden])',"select:not([disabled]):not([aria-hidden])","textarea:not([disabled]):not([aria-hidden])","button:not([disabled]):not([aria-hidden])","iframe","object","embed","video","audio","[contenteditable]",'[tabindex]:not([tabindex^="-"])'].join(",");s.isClosing||(i=!t&&s.current&&s.current.isComplete?s.current.$slide.find("*:visible"+(o?":not(.fancybox-close-small)":"")):s.$refs.container.find("*:visible"),i=i.filter(r).filter(function(){return"hidden"!==n(this).css("visibility")&&!n(this).hasClass("disabled")}),i.length?(a=i.index(e.activeElement),t&&t.shiftKey?(a<0||0==a)&&(t.preventDefault(),i.eq(i.length-1).trigger("focus")):(a<0||a==i.length-1)&&(t&&t.preventDefault(),i.eq(0).trigger("focus"))):s.$refs.container.trigger("focus"))},activate:function(){var t=this;n(".fancybox-container").each(function(){var e=n(this).data("FancyBox");e&&e.id!==t.id&&!e.isClosing&&(e.trigger("onDeactivate"),e.removeEvents(),e.isVisible=!1)}),t.isVisible=!0,(t.current||t.isIdle)&&(t.update(),t.updateControls()),t.trigger("onActivate"),t.addEvents()},close:function(t,e){var o,i,a,s,r,c,l,u=this,f=u.current,h=function(){u.cleanUp(t)};return!u.isClosing&&(u.isClosing=!0,!1===u.trigger("beforeClose",t)?(u.isClosing=!1,d(function(){u.update()}),!1):(u.removeEvents(),a=f.$content,o=f.opts.animationEffect,i=n.isNumeric(e)?e:o?f.opts.animationDuration:0,f.$slide.removeClass("fancybox-slide--complete fancybox-slide--next fancybox-slide--previous fancybox-animated"),!0!==t?n.fancybox.stop(f.$slide):o=!1,f.$slide.siblings().trigger("onReset").remove(),i&&u.$refs.container.removeClass("fancybox-is-open").addClass("fancybox-is-closing").css("transition-duration",i+"ms"),u.hideLoading(f),u.hideControls(!0),u.updateCursor(),"zoom"!==o||a&&i&&"image"===f.type&&!u.isMoved()&&!f.hasError&&(l=u.getThumbPos(f))||(o="fade"),"zoom"===o?(n.fancybox.stop(a),s=n.fancybox.getTranslate(a),c={top:s.top,left:s.left,scaleX:s.width/l.width,scaleY:s.height/l.height,width:l.width,height:l.height},r=f.opts.zoomOpacity,
"auto"==r&&(r=Math.abs(f.width/f.height-l.width/l.height)>.1),r&&(l.opacity=0),n.fancybox.setTranslate(a,c),p(a),n.fancybox.animate(a,l,i,h),!0):(o&&i?n.fancybox.animate(f.$slide.addClass("fancybox-slide--previous").removeClass("fancybox-slide--current"),"fancybox-animated fancybox-fx-"+o,i,h):!0===t?setTimeout(h,i):h(),!0)))},cleanUp:function(e){var o,i,a,s=this,r=s.current.opts.$orig;s.current.$slide.trigger("onReset"),s.$refs.container.empty().remove(),s.trigger("afterClose",e),s.current.opts.backFocus&&(r&&r.length&&r.is(":visible")||(r=s.$trigger),r&&r.length&&(i=t.scrollX,a=t.scrollY,r.trigger("focus"),n("html, body").scrollTop(a).scrollLeft(i))),s.current=null,o=n.fancybox.getInstance(),o?o.activate():(n("body").removeClass("fancybox-active compensate-for-scrollbar"),n("#fancybox-style-noscroll").remove())},trigger:function(t,e){var o,i=Array.prototype.slice.call(arguments,1),a=this,s=e&&e.opts?e:a.current;if(s?i.unshift(s):s=a,i.unshift(a),n.isFunction(s.opts[t])&&(o=s.opts[t].apply(s,i)),!1===o)return o;"afterClose"!==t&&a.$refs?a.$refs.container.trigger(t+".fb",i):r.trigger(t+".fb",i)},updateControls:function(){var t=this,o=t.current,i=o.index,a=t.$refs.container,s=t.$refs.caption,r=o.opts.caption;o.$slide.trigger("refresh"),r&&r.length?(t.$caption=s,s.children().eq(0).html(r)):t.$caption=null,t.hasHiddenControls||t.isIdle||t.showControls(),a.find("[data-fancybox-count]").html(t.group.length),a.find("[data-fancybox-index]").html(i+1),a.find("[data-fancybox-prev]").prop("disabled",!o.opts.loop&&i<=0),a.find("[data-fancybox-next]").prop("disabled",!o.opts.loop&&i>=t.group.length-1),"image"===o.type?a.find("[data-fancybox-zoom]").show().end().find("[data-fancybox-download]").attr("href",o.opts.image.src||o.src).show():o.opts.toolbar&&a.find("[data-fancybox-download],[data-fancybox-zoom]").hide(),n(e.activeElement).is(":hidden,[disabled]")&&t.$refs.container.trigger("focus")},hideControls:function(t){var e=this,n=["infobar","toolbar","nav"];!t&&e.current.opts.preventCaptionOverlap||n.push("caption"),this.$refs.container.removeClass(n.map(function(t){return"fancybox-show-"+t}).join(" ")),this.hasHiddenControls=!0},showControls:function(){var t=this,e=t.current?t.current.opts:t.opts,n=t.$refs.container;t.hasHiddenControls=!1,t.idleSecondsCounter=0,n.toggleClass("fancybox-show-toolbar",!(!e.toolbar||!e.buttons)).toggleClass("fancybox-show-infobar",!!(e.infobar&&t.group.length>1)).toggleClass("fancybox-show-caption",!!t.$caption).toggleClass("fancybox-show-nav",!!(e.arrows&&t.group.length>1)).toggleClass("fancybox-is-modal",!!e.modal)},toggleControls:function(){this.hasHiddenControls?this.showControls():this.hideControls()}}),n.fancybox={version:"3.5.7",defaults:a,getInstance:function(t){var e=n('.fancybox-container:not(".fancybox-is-closing"):last').data("FancyBox"),o=Array.prototype.slice.call(arguments,1);return e instanceof b&&("string"===n.type(t)?e[t].apply(e,o):"function"===n.type(t)&&t.apply(e,o),e)},open:function(t,e,n){return new b(t,e,n)},close:function(t){var e=this.getInstance();e&&(e.close(),!0===t&&this.close(t))},destroy:function(){this.close(!0),r.add("body").off("click.fb-start","**")},isMobile:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),use3d:function(){var n=e.createElement("div");return t.getComputedStyle&&t.getComputedStyle(n)&&t.getComputedStyle(n).getPropertyValue("transform")&&!(e.documentMode&&e.documentMode<11)}(),getTranslate:function(t){var e;return!(!t||!t.length)&&(e=t[0].getBoundingClientRect(),{top:e.top||0,left:e.left||0,width:e.width,height:e.height,opacity:parseFloat(t.css("opacity"))})},setTranslate:function(t,e){var n="",o={};if(t&&e)return void 0===e.left&&void 0===e.top||(n=(void 0===e.left?t.position().left:e.left)+"px, "+(void 0===e.top?t.position().top:e.top)+"px",n=this.use3d?"translate3d("+n+", 0px)":"translate("+n+")"),void 0!==e.scaleX&&void 0!==e.scaleY?n+=" scale("+e.scaleX+", "+e.scaleY+")":void 0!==e.scaleX&&(n+=" scaleX("+e.scaleX+")"),n.length&&(o.transform=n),void 0!==e.opacity&&(o.opacity=e.opacity),void 0!==e.width&&(o.width=e.width),void 0!==e.height&&(o.height=e.height),t.css(o)},animate:function(t,e,o,i,a){var s,r=this;n.isFunction(o)&&(i=o,o=null),r.stop(t),s=r.getTranslate(t),t.on(f,function(c){(!c||!c.originalEvent||t.is(c.originalEvent.target)&&"z-index"!=c.originalEvent.propertyName)&&(r.stop(t),n.isNumeric(o)&&t.css("transition-duration",""),n.isPlainObject(e)?void 0!==e.scaleX&&void 0!==e.scaleY&&r.setTranslate(t,{top:e.top,left:e.left,width:s.width*e.scaleX,height:s.height*e.scaleY,scaleX:1,scaleY:1}):!0!==a&&t.removeClass(e),n.isFunction(i)&&i(c))}),n.isNumeric(o)&&t.css("transition-duration",o+"ms"),n.isPlainObject(e)?(void 0!==e.scaleX&&void 0!==e.scaleY&&(delete e.width,delete e.height,t.parent().hasClass("fancybox-slide--image")&&t.parent().addClass("fancybox-is-scaling")),n.fancybox.setTranslate(t,e)):t.addClass(e),t.data("timer",setTimeout(function(){t.trigger(f)},o+33))},stop:function(t,e){t&&t.length&&(clearTimeout(t.data("timer")),e&&t.trigger(f),t.off(f).css("transition-duration",""),t.parent().removeClass("fancybox-is-scaling"))}},n.fn.fancybox=function(t){var e;return t=t||{},e=t.selector||!1,e?n("body").off("click.fb-start",e).on("click.fb-start",e,{options:t},i):this.off("click.fb-start").on("click.fb-start",{items:this,options:t},i),this},r.on("click.fb-start","[data-fancybox]",i),r.on("click.fb-start","[data-fancybox-trigger]",function(t){n('[data-fancybox="'+n(this).attr("data-fancybox-trigger")+'"]').eq(n(this).attr("data-fancybox-index")||0).trigger("click.fb-start",{$trigger:n(this)})}),function(){var t=null;r.on("mousedown mouseup focus blur",".fancybox-button",function(e){switch(e.type){case"mousedown":t=n(this);break;case"mouseup":t=null;break;case"focusin":n(".fancybox-button").removeClass("fancybox-focus"),n(this).is(t)||n(this).is("[disabled]")||n(this).addClass("fancybox-focus");break;case"focusout":n(".fancybox-button").removeClass("fancybox-focus")}})}()}}(window,document,jQuery),function(t){"use strict";var e={youtube:{matcher:/(youtube\.com|youtu\.be|youtube\-nocookie\.com)\/(watch\?(.*&)?v=|v\/|u\/|embed\/?)?(videoseries\?list=(.*)|[\w-]{11}|\?listType=(.*)&list=(.*))(.*)/i,params:{autoplay:1,autohide:1,fs:1,rel:0,hd:1,wmode:"transparent",enablejsapi:1,html5:1},paramPlace:8,type:"iframe",url:"https://www.youtube-nocookie.com/embed/$4",thumb:"https://img.youtube.com/vi/$4/hqdefault.jpg"},vimeo:{matcher:/^.+vimeo.com\/(.*\/)?([\d]+)(.*)?/,params:{autoplay:1,hd:1,show_title:1,show_byline:1,show_portrait:0,fullscreen:1},paramPlace:3,type:"iframe",url:"//player.vimeo.com/video/$2"},instagram:{matcher:/(instagr\.am|instagram\.com)\/p\/([a-zA-Z0-9_\-]+)\/?/i,type:"image",url:"//$1/p/$2/media/?size=l"},gmap_place:{matcher:/(maps\.)?google\.([a-z]{2,3}(\.[a-z]{2})?)\/(((maps\/(place\/(.*)\/)?\@(.*),(\d+.?\d+?)z))|(\?ll=))(.*)?/i,type:"iframe",url:function(t){return"//maps.google."+t[2]+"/?ll="+(t[9]?t[9]+"&z="+Math.floor(t[10])+(t[12]?t[12].replace(/^\//,"&"):""):t[12]+"").replace(/\?/,"&")+"&output="+(t[12]&&t[12].indexOf("layer=c")>0?"svembed":"embed")}},gmap_search:{matcher:/(maps\.)?google\.([a-z]{2,3}(\.[a-z]{2})?)\/(maps\/search\/)(.*)/i,type:"iframe",url:function(t){return"//maps.google."+t[2]+"/maps?q="+t[5].replace("query=","q=").replace("api=1","")+"&output=embed"}}},n=function(e,n,o){if(e)return o=o||"","object"===t.type(o)&&(o=t.param(o,!0)),t.each(n,function(t,n){e=e.replace("$"+t,n||"")}),o.length&&(e+=(e.indexOf("?")>0?"&":"?")+o),e};t(document).on("objectNeedsType.fb",function(o,i,a){var s,r,c,l,d,u,f,p=a.src||"",h=!1;s=t.extend(!0,{},e,a.opts.media),t.each(s,function(e,o){if(c=p.match(o.matcher)){if(h=o.type,f=e,u={},o.paramPlace&&c[o.paramPlace]){d=c[o.paramPlace],"?"==d[0]&&(d=d.substring(1)),d=d.split("&");for(var i=0;i<d.length;++i){var s=d[i].split("=",2);2==s.length&&(u[s[0]]=decodeURIComponent(s[1].replace(/\+/g," ")))}}return l=t.extend(!0,{},o.params,a.opts[e],u),p="function"===t.type(o.url)?o.url.call(this,c,l,a):n(o.url,c,l),r="function"===t.type(o.thumb)?o.thumb.call(this,c,l,a):n(o.thumb,c),"youtube"===e?p=p.replace(/&t=((\d+)m)?(\d+)s/,function(t,e,n,o){return"&start="+((n?60*parseInt(n,10):0)+parseInt(o,10))}):"vimeo"===e&&(p=p.replace("&%23","#")),!1}}),h?(a.opts.thumb||a.opts.$thumb&&a.opts.$thumb.length||(a.opts.thumb=r),"iframe"===h&&(a.opts=t.extend(!0,a.opts,{iframe:{preload:!1,attr:{scrolling:"no"}}})),t.extend(a,{type:h,src:p,origSrc:a.src,contentSource:f,contentType:"image"===h?"image":"gmap_place"==f||"gmap_search"==f?"map":"video"})):p&&(a.type=a.opts.defaultType)});var o={youtube:{src:"https://www.youtube.com/iframe_api",class:"YT",loading:!1,loaded:!1},vimeo:{src:"https://player.vimeo.com/api/player.js",class:"Vimeo",loading:!1,loaded:!1},load:function(t){var e,n=this;if(this[t].loaded)return void setTimeout(function(){n.done(t)});this[t].loading||(this[t].loading=!0,e=document.createElement("script"),e.type="text/javascript",e.src=this[t].src,"youtube"===t?window.onYouTubeIframeAPIReady=function(){n[t].loaded=!0,n.done(t)}:e.onload=function(){n[t].loaded=!0,n.done(t)},document.body.appendChild(e))},done:function(e){var n,o,i;"youtube"===e&&delete window.onYouTubeIframeAPIReady,(n=t.fancybox.getInstance())&&(o=n.current.$content.find("iframe"),"youtube"===e&&void 0!==YT&&YT?i=new YT.Player(o.attr("id"),{events:{onStateChange:function(t){0==t.data&&n.next()}}}):"vimeo"===e&&void 0!==Vimeo&&Vimeo&&(i=new Vimeo.Player(o),i.on("ended",function(){n.next()})))}};t(document).on({"afterShow.fb":function(t,e,n){e.group.length>1&&("youtube"===n.contentSource||"vimeo"===n.contentSource)&&o.load(n.contentSource)}})}(jQuery),function(t,e,n){"use strict";var o=function(){return t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||t.oRequestAnimationFrame||function(e){return t.setTimeout(e,1e3/60)}}(),i=function(){return t.cancelAnimationFrame||t.webkitCancelAnimationFrame||t.mozCancelAnimationFrame||t.oCancelAnimationFrame||function(e){t.clearTimeout(e)}}(),a=function(e){var n=[];e=e.originalEvent||e||t.e,e=e.touches&&e.touches.length?e.touches:e.changedTouches&&e.changedTouches.length?e.changedTouches:[e];for(var o in e)e[o].pageX?n.push({x:e[o].pageX,y:e[o].pageY}):e[o].clientX&&n.push({x:e[o].clientX,y:e[o].clientY});return n},s=function(t,e,n){return e&&t?"x"===n?t.x-e.x:"y"===n?t.y-e.y:Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)):0},r=function(t){if(t.is('a,area,button,[role="button"],input,label,select,summary,textarea,video,audio,iframe')||n.isFunction(t.get(0).onclick)||t.data("selectable"))return!0;for(var e=0,o=t[0].attributes,i=o.length;e<i;e++)if("data-fancybox-"===o[e].nodeName.substr(0,14))return!0;return!1},c=function(e){var n=t.getComputedStyle(e)["overflow-y"],o=t.getComputedStyle(e)["overflow-x"],i=("scroll"===n||"auto"===n)&&e.scrollHeight>e.clientHeight,a=("scroll"===o||"auto"===o)&&e.scrollWidth>e.clientWidth;return i||a},l=function(t){for(var e=!1;;){if(e=c(t.get(0)))break;if(t=t.parent(),!t.length||t.hasClass("fancybox-stage")||t.is("body"))break}return e},d=function(t){var e=this;e.instance=t,e.$bg=t.$refs.bg,e.$stage=t.$refs.stage,e.$container=t.$refs.container,e.destroy(),e.$container.on("touchstart.fb.touch mousedown.fb.touch",n.proxy(e,"ontouchstart"))};d.prototype.destroy=function(){var t=this;t.$container.off(".fb.touch"),n(e).off(".fb.touch"),t.requestId&&(i(t.requestId),t.requestId=null),t.tapped&&(clearTimeout(t.tapped),t.tapped=null)},d.prototype.ontouchstart=function(o){var i=this,c=n(o.target),d=i.instance,u=d.current,f=u.$slide,p=u.$content,h="touchstart"==o.type;if(h&&i.$container.off("mousedown.fb.touch"),(!o.originalEvent||2!=o.originalEvent.button)&&f.length&&c.length&&!r(c)&&!r(c.parent())&&(c.is("img")||!(o.originalEvent.clientX>c[0].clientWidth+c.offset().left))){if(!u||d.isAnimating||u.$slide.hasClass("fancybox-animated"))return o.stopPropagation(),void o.preventDefault();i.realPoints=i.startPoints=a(o),i.startPoints.length&&(u.touch&&o.stopPropagation(),i.startEvent=o,i.canTap=!0,i.$target=c,i.$content=p,i.opts=u.opts.touch,i.isPanning=!1,i.isSwiping=!1,i.isZooming=!1,i.isScrolling=!1,i.canPan=d.canPan(),i.startTime=(new Date).getTime(),i.distanceX=i.distanceY=i.distance=0,i.canvasWidth=Math.round(f[0].clientWidth),i.canvasHeight=Math.round(f[0].clientHeight),i.contentLastPos=null,i.contentStartPos=n.fancybox.getTranslate(i.$content)||{top:0,left:0},i.sliderStartPos=n.fancybox.getTranslate(f),i.stagePos=n.fancybox.getTranslate(d.$refs.stage),i.sliderStartPos.top-=i.stagePos.top,i.sliderStartPos.left-=i.stagePos.left,i.contentStartPos.top-=i.stagePos.top,i.contentStartPos.left-=i.stagePos.left,n(e).off(".fb.touch").on(h?"touchend.fb.touch touchcancel.fb.touch":"mouseup.fb.touch mouseleave.fb.touch",n.proxy(i,"ontouchend")).on(h?"touchmove.fb.touch":"mousemove.fb.touch",n.proxy(i,"ontouchmove")),n.fancybox.isMobile&&e.addEventListener("scroll",i.onscroll,!0),((i.opts||i.canPan)&&(c.is(i.$stage)||i.$stage.find(c).length)||(c.is(".fancybox-image")&&o.preventDefault(),n.fancybox.isMobile&&c.parents(".fancybox-caption").length))&&(i.isScrollable=l(c)||l(c.parent()),n.fancybox.isMobile&&i.isScrollable||o.preventDefault(),(1===i.startPoints.length||u.hasError)&&(i.canPan?(n.fancybox.stop(i.$content),i.isPanning=!0):i.isSwiping=!0,i.$container.addClass("fancybox-is-grabbing")),2===i.startPoints.length&&"image"===u.type&&(u.isLoaded||u.$ghost)&&(i.canTap=!1,i.isSwiping=!1,i.isPanning=!1,i.isZooming=!0,n.fancybox.stop(i.$content),i.centerPointStartX=.5*(i.startPoints[0].x+i.startPoints[1].x)-n(t).scrollLeft(),i.centerPointStartY=.5*(i.startPoints[0].y+i.startPoints[1].y)-n(t).scrollTop(),i.percentageOfImageAtPinchPointX=(i.centerPointStartX-i.contentStartPos.left)/i.contentStartPos.width,i.percentageOfImageAtPinchPointY=(i.centerPointStartY-i.contentStartPos.top)/i.contentStartPos.height,i.startDistanceBetweenFingers=s(i.startPoints[0],i.startPoints[1]))))}},d.prototype.onscroll=function(t){var n=this;n.isScrolling=!0,e.removeEventListener("scroll",n.onscroll,!0)},d.prototype.ontouchmove=function(t){var e=this;return void 0!==t.originalEvent.buttons&&0===t.originalEvent.buttons?void e.ontouchend(t):e.isScrolling?void(e.canTap=!1):(e.newPoints=a(t),void((e.opts||e.canPan)&&e.newPoints.length&&e.newPoints.length&&(e.isSwiping&&!0===e.isSwiping||t.preventDefault(),e.distanceX=s(e.newPoints[0],e.startPoints[0],"x"),e.distanceY=s(e.newPoints[0],e.startPoints[0],"y"),e.distance=s(e.newPoints[0],e.startPoints[0]),e.distance>0&&(e.isSwiping?e.onSwipe(t):e.isPanning?e.onPan():e.isZooming&&e.onZoom()))))},d.prototype.onSwipe=function(e){var a,s=this,r=s.instance,c=s.isSwiping,l=s.sliderStartPos.left||0;if(!0!==c)"x"==c&&(s.distanceX>0&&(s.instance.group.length<2||0===s.instance.current.index&&!s.instance.current.opts.loop)?l+=Math.pow(s.distanceX,.8):s.distanceX<0&&(s.instance.group.length<2||s.instance.current.index===s.instance.group.length-1&&!s.instance.current.opts.loop)?l-=Math.pow(-s.distanceX,.8):l+=s.distanceX),s.sliderLastPos={top:"x"==c?0:s.sliderStartPos.top+s.distanceY,left:l},s.requestId&&(i(s.requestId),s.requestId=null),s.requestId=o(function(){s.sliderLastPos&&(n.each(s.instance.slides,function(t,e){var o=e.pos-s.instance.currPos;n.fancybox.setTranslate(e.$slide,{top:s.sliderLastPos.top,left:s.sliderLastPos.left+o*s.canvasWidth+o*e.opts.gutter})}),s.$container.addClass("fancybox-is-sliding"))});else if(Math.abs(s.distance)>10){if(s.canTap=!1,r.group.length<2&&s.opts.vertical?s.isSwiping="y":r.isDragging||!1===s.opts.vertical||"auto"===s.opts.vertical&&n(t).width()>800?s.isSwiping="x":(a=Math.abs(180*Math.atan2(s.distanceY,s.distanceX)/Math.PI),s.isSwiping=a>45&&a<135?"y":"x"),"y"===s.isSwiping&&n.fancybox.isMobile&&s.isScrollable)return void(s.isScrolling=!0);r.isDragging=s.isSwiping,s.startPoints=s.newPoints,n.each(r.slides,function(t,e){var o,i;n.fancybox.stop(e.$slide),o=n.fancybox.getTranslate(e.$slide),i=n.fancybox.getTranslate(r.$refs.stage),e.$slide.css({transform:"",opacity:"","transition-duration":""}).removeClass("fancybox-animated").removeClass(function(t,e){return(e.match(/(^|\s)fancybox-fx-\S+/g)||[]).join(" ")}),e.pos===r.current.pos&&(s.sliderStartPos.top=o.top-i.top,s.sliderStartPos.left=o.left-i.left),n.fancybox.setTranslate(e.$slide,{top:o.top-i.top,left:o.left-i.left})}),r.SlideShow&&r.SlideShow.isActive&&r.SlideShow.stop()}},d.prototype.onPan=function(){var t=this;if(s(t.newPoints[0],t.realPoints[0])<(n.fancybox.isMobile?10:5))return void(t.startPoints=t.newPoints);t.canTap=!1,t.contentLastPos=t.limitMovement(),t.requestId&&i(t.requestId),t.requestId=o(function(){n.fancybox.setTranslate(t.$content,t.contentLastPos)})},d.prototype.limitMovement=function(){var t,e,n,o,i,a,s=this,r=s.canvasWidth,c=s.canvasHeight,l=s.distanceX,d=s.distanceY,u=s.contentStartPos,f=u.left,p=u.top,h=u.width,g=u.height;return i=h>r?f+l:f,a=p+d,t=Math.max(0,.5*r-.5*h),e=Math.max(0,.5*c-.5*g),n=Math.min(r-h,.5*r-.5*h),o=Math.min(c-g,.5*c-.5*g),l>0&&i>t&&(i=t-1+Math.pow(-t+f+l,.8)||0),l<0&&i<n&&(i=n+1-Math.pow(n-f-l,.8)||0),d>0&&a>e&&(a=e-1+Math.pow(-e+p+d,.8)||0),d<0&&a<o&&(a=o+1-Math.pow(o-p-d,.8)||0),{top:a,left:i}},d.prototype.limitPosition=function(t,e,n,o){var i=this,a=i.canvasWidth,s=i.canvasHeight;return n>a?(t=t>0?0:t,t=t<a-n?a-n:t):t=Math.max(0,a/2-n/2),o>s?(e=e>0?0:e,e=e<s-o?s-o:e):e=Math.max(0,s/2-o/2),{top:e,left:t}},d.prototype.onZoom=function(){var e=this,a=e.contentStartPos,r=a.width,c=a.height,l=a.left,d=a.top,u=s(e.newPoints[0],e.newPoints[1]),f=u/e.startDistanceBetweenFingers,p=Math.floor(r*f),h=Math.floor(c*f),g=(r-p)*e.percentageOfImageAtPinchPointX,b=(c-h)*e.percentageOfImageAtPinchPointY,m=(e.newPoints[0].x+e.newPoints[1].x)/2-n(t).scrollLeft(),v=(e.newPoints[0].y+e.newPoints[1].y)/2-n(t).scrollTop(),y=m-e.centerPointStartX,x=v-e.centerPointStartY,w=l+(g+y),$=d+(b+x),S={top:$,left:w,scaleX:f,scaleY:f};e.canTap=!1,e.newWidth=p,e.newHeight=h,e.contentLastPos=S,e.requestId&&i(e.requestId),e.requestId=o(function(){n.fancybox.setTranslate(e.$content,e.contentLastPos)})},d.prototype.ontouchend=function(t){var o=this,s=o.isSwiping,r=o.isPanning,c=o.isZooming,l=o.isScrolling;if(o.endPoints=a(t),o.dMs=Math.max((new Date).getTime()-o.startTime,1),o.$container.removeClass("fancybox-is-grabbing"),n(e).off(".fb.touch"),e.removeEventListener("scroll",o.onscroll,!0),o.requestId&&(i(o.requestId),o.requestId=null),o.isSwiping=!1,o.isPanning=!1,o.isZooming=!1,o.isScrolling=!1,o.instance.isDragging=!1,o.canTap)return o.onTap(t);o.speed=100,o.velocityX=o.distanceX/o.dMs*.5,o.velocityY=o.distanceY/o.dMs*.5,r?o.endPanning():c?o.endZooming():o.endSwiping(s,l)},d.prototype.endSwiping=function(t,e){var o=this,i=!1,a=o.instance.group.length,s=Math.abs(o.distanceX),r="x"==t&&a>1&&(o.dMs>130&&s>10||s>50);o.sliderLastPos=null,"y"==t&&!e&&Math.abs(o.distanceY)>50?(n.fancybox.animate(o.instance.current.$slide,{top:o.sliderStartPos.top+o.distanceY+150*o.velocityY,opacity:0},200),i=o.instance.close(!0,250)):r&&o.distanceX>0?i=o.instance.previous(300):r&&o.distanceX<0&&(i=o.instance.next(300)),!1!==i||"x"!=t&&"y"!=t||o.instance.centerSlide(200),o.$container.removeClass("fancybox-is-sliding")},d.prototype.endPanning=function(){var t,e,o,i=this;i.contentLastPos&&(!1===i.opts.momentum||i.dMs>350?(t=i.contentLastPos.left,e=i.contentLastPos.top):(t=i.contentLastPos.left+500*i.velocityX,e=i.contentLastPos.top+500*i.velocityY),o=i.limitPosition(t,e,i.contentStartPos.width,i.contentStartPos.height),o.width=i.contentStartPos.width,o.height=i.contentStartPos.height,n.fancybox.animate(i.$content,o,366))},d.prototype.endZooming=function(){var t,e,o,i,a=this,s=a.instance.current,r=a.newWidth,c=a.newHeight;a.contentLastPos&&(t=a.contentLastPos.left,e=a.contentLastPos.top,i={top:e,left:t,width:r,height:c,scaleX:1,scaleY:1},n.fancybox.setTranslate(a.$content,i),r<a.canvasWidth&&c<a.canvasHeight?a.instance.scaleToFit(150):r>s.width||c>s.height?a.instance.scaleToActual(a.centerPointStartX,a.centerPointStartY,150):(o=a.limitPosition(t,e,r,c),n.fancybox.animate(a.$content,o,150)))},d.prototype.onTap=function(e){var o,i=this,s=n(e.target),r=i.instance,c=r.current,l=e&&a(e)||i.startPoints,d=l[0]?l[0].x-n(t).scrollLeft()-i.stagePos.left:0,u=l[0]?l[0].y-n(t).scrollTop()-i.stagePos.top:0,f=function(t){var o=c.opts[t];if(n.isFunction(o)&&(o=o.apply(r,[c,e])),o)switch(o){case"close":r.close(i.startEvent);break;case"toggleControls":r.toggleControls();break;case"next":r.next();break;case"nextOrClose":r.group.length>1?r.next():r.close(i.startEvent);break;case"zoom":"image"==c.type&&(c.isLoaded||c.$ghost)&&(r.canPan()?r.scaleToFit():r.isScaledDown()?r.scaleToActual(d,u):r.group.length<2&&r.close(i.startEvent))}};if((!e.originalEvent||2!=e.originalEvent.button)&&(s.is("img")||!(d>s[0].clientWidth+s.offset().left))){if(s.is(".fancybox-bg,.fancybox-inner,.fancybox-outer,.fancybox-container"))o="Outside";else if(s.is(".fancybox-slide"))o="Slide";else{if(!r.current.$content||!r.current.$content.find(s).addBack().filter(s).length)return;o="Content"}if(i.tapped){if(clearTimeout(i.tapped),i.tapped=null,Math.abs(d-i.tapX)>50||Math.abs(u-i.tapY)>50)return this;f("dblclick"+o)}else i.tapX=d,i.tapY=u,c.opts["dblclick"+o]&&c.opts["dblclick"+o]!==c.opts["click"+o]?i.tapped=setTimeout(function(){i.tapped=null,r.isAnimating||f("click"+o)},500):f("click"+o);return this}},n(e).on("onActivate.fb",function(t,e){e&&!e.Guestures&&(e.Guestures=new d(e))}).on("beforeClose.fb",function(t,e){e&&e.Guestures&&e.Guestures.destroy()})}(window,document,jQuery),function(t,e){"use strict";e.extend(!0,e.fancybox.defaults,{btnTpl:{slideShow:'<button data-fancybox-play class="fancybox-button fancybox-button--play" title="{{PLAY_START}}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.5 5.4v13.2l11-6.6z"/></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.33 5.75h2.2v12.5h-2.2V5.75zm5.15 0h2.2v12.5h-2.2V5.75z"/></svg></button>'},slideShow:{autoStart:!1,speed:3e3,progress:!0}});var n=function(t){this.instance=t,this.init()};e.extend(n.prototype,{timer:null,isActive:!1,$button:null,init:function(){var t=this,n=t.instance,o=n.group[n.currIndex].opts.slideShow;t.$button=n.$refs.toolbar.find("[data-fancybox-play]").on("click",function(){t.toggle()}),n.group.length<2||!o?t.$button.hide():o.progress&&(t.$progress=e('<div class="fancybox-progress"></div>').appendTo(n.$refs.inner))},set:function(t){var n=this,o=n.instance,i=o.current;i&&(!0===t||i.opts.loop||o.currIndex<o.group.length-1)?n.isActive&&"video"!==i.contentType&&(n.$progress&&e.fancybox.animate(n.$progress.show(),{scaleX:1},i.opts.slideShow.speed),n.timer=setTimeout(function(){o.current.opts.loop||o.current.index!=o.group.length-1?o.next():o.jumpTo(0)},i.opts.slideShow.speed)):(n.stop(),o.idleSecondsCounter=0,o.showControls())},clear:function(){var t=this;clearTimeout(t.timer),t.timer=null,t.$progress&&t.$progress.removeAttr("style").hide()},start:function(){var t=this,e=t.instance.current;e&&(t.$button.attr("title",(e.opts.i18n[e.opts.lang]||e.opts.i18n.en).PLAY_STOP).removeClass("fancybox-button--play").addClass("fancybox-button--pause"),t.isActive=!0,e.isComplete&&t.set(!0),t.instance.trigger("onSlideShowChange",!0))},stop:function(){var t=this,e=t.instance.current;t.clear(),t.$button.attr("title",(e.opts.i18n[e.opts.lang]||e.opts.i18n.en).PLAY_START).removeClass("fancybox-button--pause").addClass("fancybox-button--play"),t.isActive=!1,t.instance.trigger("onSlideShowChange",!1),t.$progress&&t.$progress.removeAttr("style").hide()},toggle:function(){var t=this;t.isActive?t.stop():t.start()}}),e(t).on({"onInit.fb":function(t,e){e&&!e.SlideShow&&(e.SlideShow=new n(e))},"beforeShow.fb":function(t,e,n,o){var i=e&&e.SlideShow;o?i&&n.opts.slideShow.autoStart&&i.start():i&&i.isActive&&i.clear()},"afterShow.fb":function(t,e,n){var o=e&&e.SlideShow;o&&o.isActive&&o.set()},"afterKeydown.fb":function(n,o,i,a,s){var r=o&&o.SlideShow;!r||!i.opts.slideShow||80!==s&&32!==s||e(t.activeElement).is("button,a,input")||(a.preventDefault(),r.toggle())},"beforeClose.fb onDeactivate.fb":function(t,e){var n=e&&e.SlideShow;n&&n.stop()}}),e(t).on("visibilitychange",function(){var n=e.fancybox.getInstance(),o=n&&n.SlideShow;o&&o.isActive&&(t.hidden?o.clear():o.set())})}(document,jQuery),function(t,e){"use strict";var n=function(){for(var e=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],n={},o=0;o<e.length;o++){var i=e[o];if(i&&i[1]in t){for(var a=0;a<i.length;a++)n[e[0][a]]=i[a];return n}}return!1}();if(n){var o={request:function(e){e=e||t.documentElement,e[n.requestFullscreen](e.ALLOW_KEYBOARD_INPUT)},exit:function(){t[n.exitFullscreen]()},toggle:function(e){e=e||t.documentElement,this.isFullscreen()?this.exit():this.request(e)},isFullscreen:function(){return Boolean(t[n.fullscreenElement])},enabled:function(){return Boolean(t[n.fullscreenEnabled])}};e.extend(!0,e.fancybox.defaults,{btnTpl:{fullScreen:'<button data-fancybox-fullscreen class="fancybox-button fancybox-button--fsenter" title="{{FULL_SCREEN}}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 16h3v3h2v-5H5zm3-8H5v2h5V5H8zm6 11h2v-3h3v-2h-5zm2-11V5h-2v5h5V8z"/></svg></button>'},fullScreen:{autoStart:!1}}),e(t).on(n.fullscreenchange,function(){var t=o.isFullscreen(),n=e.fancybox.getInstance();n&&(n.current&&"image"===n.current.type&&n.isAnimating&&(n.isAnimating=!1,n.update(!0,!0,0),n.isComplete||n.complete()),n.trigger("onFullscreenChange",t),n.$refs.container.toggleClass("fancybox-is-fullscreen",t),n.$refs.toolbar.find("[data-fancybox-fullscreen]").toggleClass("fancybox-button--fsenter",!t).toggleClass("fancybox-button--fsexit",t))})}e(t).on({"onInit.fb":function(t,e){var i;if(!n)return void e.$refs.toolbar.find("[data-fancybox-fullscreen]").remove();e&&e.group[e.currIndex].opts.fullScreen?(i=e.$refs.container,i.on("click.fb-fullscreen","[data-fancybox-fullscreen]",function(t){t.stopPropagation(),t.preventDefault(),o.toggle()}),e.opts.fullScreen&&!0===e.opts.fullScreen.autoStart&&o.request(),e.FullScreen=o):e&&e.$refs.toolbar.find("[data-fancybox-fullscreen]").hide()},"afterKeydown.fb":function(t,e,n,o,i){e&&e.FullScreen&&70===i&&(o.preventDefault(),e.FullScreen.toggle())},"beforeClose.fb":function(t,e){e&&e.FullScreen&&e.$refs.container.hasClass("fancybox-is-fullscreen")&&o.exit()}})}(document,jQuery),function(t,e){"use strict";var n="fancybox-thumbs";e.fancybox.defaults=e.extend(!0,{btnTpl:{thumbs:'<button data-fancybox-thumbs class="fancybox-button fancybox-button--thumbs" title="{{THUMBS}}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.59 14.59h3.76v3.76h-3.76v-3.76zm-4.47 0h3.76v3.76h-3.76v-3.76zm-4.47 0h3.76v3.76H5.65v-3.76zm8.94-4.47h3.76v3.76h-3.76v-3.76zm-4.47 0h3.76v3.76h-3.76v-3.76zm-4.47 0h3.76v3.76H5.65v-3.76zm8.94-4.47h3.76v3.76h-3.76V5.65zm-4.47 0h3.76v3.76h-3.76V5.65zm-4.47 0h3.76v3.76H5.65V5.65z"/></svg></button>'},thumbs:{autoStart:!1,hideOnClose:!0,parentEl:".fancybox-container",axis:"y"}},e.fancybox.defaults);var o=function(t){this.init(t)};e.extend(o.prototype,{$button:null,$grid:null,$list:null,isVisible:!1,isActive:!1,init:function(t){var e=this,n=t.group,o=0;e.instance=t,e.opts=n[t.currIndex].opts.thumbs,t.Thumbs=e,e.$button=t.$refs.toolbar.find("[data-fancybox-thumbs]");for(var i=0,a=n.length;i<a&&(n[i].thumb&&o++,!(o>1));i++);o>1&&e.opts?(e.$button.removeAttr("style").on("click",function(){e.toggle()}),e.isActive=!0):e.$button.hide()},create:function(){var t,o=this,i=o.instance,a=o.opts.parentEl,s=[];o.$grid||(o.$grid=e('<div class="'+n+" "+n+"-"+o.opts.axis+'"></div>').appendTo(i.$refs.container.find(a).addBack().filter(a)),o.$grid.on("click","a",function(){i.jumpTo(e(this).attr("data-index"))})),o.$list||(o.$list=e('<div class="'+n+'__list">').appendTo(o.$grid)),e.each(i.group,function(e,n){t=n.thumb,t||"image"!==n.type||(t=n.src),s.push('<a href="javascript:;" tabindex="0" data-index="'+e+'"'+(t&&t.length?' style="background-image:url('+t+')"':'class="fancybox-thumbs-missing"')+"></a>")}),o.$list[0].innerHTML=s.join(""),"x"===o.opts.axis&&o.$list.width(parseInt(o.$grid.css("padding-right"),10)+i.group.length*o.$list.children().eq(0).outerWidth(!0))},focus:function(t){var e,n,o=this,i=o.$list,a=o.$grid;o.instance.current&&(e=i.children().removeClass("fancybox-thumbs-active").filter('[data-index="'+o.instance.current.index+'"]').addClass("fancybox-thumbs-active"),n=e.position(),"y"===o.opts.axis&&(n.top<0||n.top>i.height()-e.outerHeight())?i.stop().animate({scrollTop:i.scrollTop()+n.top},t):"x"===o.opts.axis&&(n.left<a.scrollLeft()||n.left>a.scrollLeft()+(a.width()-e.outerWidth()))&&i.parent().stop().animate({scrollLeft:n.left},t))},update:function(){var t=this;t.instance.$refs.container.toggleClass("fancybox-show-thumbs",this.isVisible),t.isVisible?(t.$grid||t.create(),t.instance.trigger("onThumbsShow"),t.focus(0)):t.$grid&&t.instance.trigger("onThumbsHide"),t.instance.update()},hide:function(){this.isVisible=!1,this.update()},show:function(){this.isVisible=!0,this.update()},toggle:function(){this.isVisible=!this.isVisible,this.update()}}),e(t).on({"onInit.fb":function(t,e){var n;e&&!e.Thumbs&&(n=new o(e),n.isActive&&!0===n.opts.autoStart&&n.show())},"beforeShow.fb":function(t,e,n,o){var i=e&&e.Thumbs;i&&i.isVisible&&i.focus(o?0:250)},"afterKeydown.fb":function(t,e,n,o,i){var a=e&&e.Thumbs;a&&a.isActive&&71===i&&(o.preventDefault(),a.toggle())},"beforeClose.fb":function(t,e){var n=e&&e.Thumbs;n&&n.isVisible&&!1!==n.opts.hideOnClose&&n.$grid.hide()}})}(document,jQuery),function(t,e){"use strict";function n(t){var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};return String(t).replace(/[&<>"'`=\/]/g,function(t){return e[t]})}e.extend(!0,e.fancybox.defaults,{btnTpl:{share:'<button data-fancybox-share class="fancybox-button fancybox-button--share" title="{{SHARE}}"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2.55 19c1.4-8.4 9.1-9.8 11.9-9.8V5l7 7-7 6.3v-3.5c-2.8 0-10.5 2.1-11.9 4.2z"/></svg></button>'},share:{url:function(t,e){return!t.currentHash&&"inline"!==e.type&&"html"!==e.type&&(e.origSrc||e.src)||window.location},
tpl:'<div class="fancybox-share"><h1>{{SHARE}}</h1><p><a class="fancybox-share__button fancybox-share__button--fb" href="https://www.facebook.com/sharer/sharer.php?u={{url}}"><svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m287 456v-299c0-21 6-35 35-35h38v-63c-7-1-29-3-55-3-54 0-91 33-91 94v306m143-254h-205v72h196" /></svg><span>Facebook</span></a><a class="fancybox-share__button fancybox-share__button--tw" href="https://twitter.com/intent/tweet?url={{url}}&text={{descr}}"><svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m456 133c-14 7-31 11-47 13 17-10 30-27 37-46-15 10-34 16-52 20-61-62-157-7-141 75-68-3-129-35-169-85-22 37-11 86 26 109-13 0-26-4-37-9 0 39 28 72 65 80-12 3-25 4-37 2 10 33 41 57 77 57-42 30-77 38-122 34 170 111 378-32 359-208 16-11 30-25 41-42z" /></svg><span>Twitter</span></a><a class="fancybox-share__button fancybox-share__button--pt" href="https://www.pinterest.com/pin/create/button/?url={{url}}&description={{descr}}&media={{media}}"><svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="m265 56c-109 0-164 78-164 144 0 39 15 74 47 87 5 2 10 0 12-5l4-19c2-6 1-8-3-13-9-11-15-25-15-45 0-58 43-110 113-110 62 0 96 38 96 88 0 67-30 122-73 122-24 0-42-19-36-44 6-29 20-60 20-81 0-19-10-35-31-35-25 0-44 26-44 60 0 21 7 36 7 36l-30 125c-8 37-1 83 0 87 0 3 4 4 5 2 2-3 32-39 42-75l16-64c8 16 31 29 56 29 74 0 124-67 124-157 0-69-58-132-146-132z" fill="#fff"/></svg><span>Pinterest</span></a></p><p><input class="fancybox-share__input" type="text" value="{{url_raw}}" onclick="select()" /></p></div>'}}),e(t).on("click","[data-fancybox-share]",function(){var t,o,i=e.fancybox.getInstance(),a=i.current||null;a&&("function"===e.type(a.opts.share.url)&&(t=a.opts.share.url.apply(a,[i,a])),o=a.opts.share.tpl.replace(/\{\{media\}\}/g,"image"===a.type?encodeURIComponent(a.src):"").replace(/\{\{url\}\}/g,encodeURIComponent(t)).replace(/\{\{url_raw\}\}/g,n(t)).replace(/\{\{descr\}\}/g,i.$caption?encodeURIComponent(i.$caption.text()):""),e.fancybox.open({src:i.translate(i,o),type:"html",opts:{touch:!1,animationEffect:!1,afterLoad:function(t,e){i.$refs.container.one("beforeClose.fb",function(){t.close(null,0)}),e.$content.find(".fancybox-share__button").click(function(){return window.open(this.href,"Share","width=550, height=450"),!1})},mobile:{autoFocus:!1}}}))})}(document,jQuery),function(t,e,n){"use strict";function o(){var e=t.location.hash.substr(1),n=e.split("-"),o=n.length>1&&/^\+?\d+$/.test(n[n.length-1])?parseInt(n.pop(-1),10)||1:1,i=n.join("-");return{hash:e,index:o<1?1:o,gallery:i}}function i(t){""!==t.gallery&&n("[data-fancybox='"+n.escapeSelector(t.gallery)+"']").eq(t.index-1).focus().trigger("click.fb-start")}function a(t){var e,n;return!!t&&(e=t.current?t.current.opts:t.opts,""!==(n=e.hash||(e.$orig?e.$orig.data("fancybox")||e.$orig.data("fancybox-trigger"):""))&&n)}n.escapeSelector||(n.escapeSelector=function(t){return(t+"").replace(/([\0-\x1f\x7f]|^-?\d)|^-$|[^\x80-\uFFFF\w-]/g,function(t,e){return e?"\0"===t?"�":t.slice(0,-1)+"\\"+t.charCodeAt(t.length-1).toString(16)+" ":"\\"+t})}),n(function(){!1!==n.fancybox.defaults.hash&&(n(e).on({"onInit.fb":function(t,e){var n,i;!1!==e.group[e.currIndex].opts.hash&&(n=o(),(i=a(e))&&n.gallery&&i==n.gallery&&(e.currIndex=n.index-1))},"beforeShow.fb":function(n,o,i,s){var r;i&&!1!==i.opts.hash&&(r=a(o))&&(o.currentHash=r+(o.group.length>1?"-"+(i.index+1):""),t.location.hash!=="#"+o.currentHash&&(s&&!o.origHash&&(o.origHash=t.location.hash),o.hashTimer&&clearTimeout(o.hashTimer),o.hashTimer=setTimeout(function(){"replaceState"in t.history?(t.history[s?"pushState":"replaceState"]({},e.title,t.location.pathname+t.location.search+"#"+o.currentHash),s&&(o.hasCreatedHistory=!0)):t.location.hash=o.currentHash,o.hashTimer=null},300)))},"beforeClose.fb":function(n,o,i){i&&!1!==i.opts.hash&&(clearTimeout(o.hashTimer),o.currentHash&&o.hasCreatedHistory?t.history.back():o.currentHash&&("replaceState"in t.history?t.history.replaceState({},e.title,t.location.pathname+t.location.search+(o.origHash||"")):t.location.hash=o.origHash),o.currentHash=null)}}),n(t).on("hashchange.fb",function(){var t=o(),e=null;n.each(n(".fancybox-container").get().reverse(),function(t,o){var i=n(o).data("FancyBox");if(i&&i.currentHash)return e=i,!1}),e?e.currentHash===t.gallery+"-"+t.index||1===t.index&&e.currentHash==t.gallery||(e.currentHash=null,e.close()):""!==t.gallery&&i(t)}),setTimeout(function(){n.fancybox.getInstance()||i(o())},50))})}(window,document,jQuery),function(t,e){"use strict";var n=(new Date).getTime();e(t).on({"onInit.fb":function(t,e,o){e.$refs.stage.on("mousewheel DOMMouseScroll wheel MozMousePixelScroll",function(t){var o=e.current,i=(new Date).getTime();e.group.length<2||!1===o.opts.wheel||"auto"===o.opts.wheel&&"image"!==o.type||(t.preventDefault(),t.stopPropagation(),o.$slide.hasClass("fancybox-animated")||(t=t.originalEvent||t,i-n<250||(n=i,e[(-t.deltaY||-t.deltaX||t.wheelDelta||-t.detail)<0?"next":"previous"]())))})}})}(document,jQuery);
/*! nouislider - 13.1.5 - 4/24/2019 */
!function(t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():window.noUiSlider=t()}(function(){"use strict";var ut="13.1.5";function ct(t){t.parentElement.removeChild(t)}function s(t){return null!=t}function pt(t){t.preventDefault()}function i(t){return"number"==typeof t&&!isNaN(t)&&isFinite(t)}function ft(t,e,r){0<r&&(mt(t,e),setTimeout(function(){gt(t,e)},r))}function dt(t){return Math.max(Math.min(t,100),0)}function ht(t){return Array.isArray(t)?t:[t]}function e(t){var e=(t=String(t)).split(".");return 1<e.length?e[1].length:0}function mt(t,e){t.classList?t.classList.add(e):t.className+=" "+e}function gt(t,e){t.classList?t.classList.remove(e):t.className=t.className.replace(new RegExp("(^|\\b)"+e.split(" ").join("|")+"(\\b|$)","gi")," ")}function vt(t){var e=void 0!==window.pageXOffset,r="CSS1Compat"===(t.compatMode||"");return{x:e?window.pageXOffset:r?t.documentElement.scrollLeft:t.body.scrollLeft,y:e?window.pageYOffset:r?t.documentElement.scrollTop:t.body.scrollTop}}function c(t,e){return 100/(e-t)}function p(t,e){return 100*e/(t[1]-t[0])}function f(t,e){for(var r=1;t>=e[r];)r+=1;return r}function r(t,e,r){if(r>=t.slice(-1)[0])return 100;var n,i,o=f(r,t),a=t[o-1],s=t[o],l=e[o-1],u=e[o];return l+(i=r,p(n=[a,s],n[0]<0?i+Math.abs(n[0]):i-n[0])/c(l,u))}function n(t,e,r,n){if(100===n)return n;var i,o,a=f(n,t),s=t[a-1],l=t[a];return r?(l-s)/2<n-s?l:s:e[a-1]?t[a-1]+(i=n-t[a-1],o=e[a-1],Math.round(i/o)*o):n}function o(t,e,r){var n;if("number"==typeof e&&(e=[e]),!Array.isArray(e))throw new Error("noUiSlider ("+ut+"): 'range' contains invalid value.");if(!i(n="min"===t?0:"max"===t?100:parseFloat(t))||!i(e[0]))throw new Error("noUiSlider ("+ut+"): 'range' value isn't numeric.");r.xPct.push(n),r.xVal.push(e[0]),n?r.xSteps.push(!isNaN(e[1])&&e[1]):isNaN(e[1])||(r.xSteps[0]=e[1]),r.xHighestCompleteStep.push(0)}function a(t,e,r){if(e)if(r.xVal[t]!==r.xVal[t+1]){r.xSteps[t]=p([r.xVal[t],r.xVal[t+1]],e)/c(r.xPct[t],r.xPct[t+1]);var n=(r.xVal[t+1]-r.xVal[t])/r.xNumSteps[t],i=Math.ceil(Number(n.toFixed(3))-1),o=r.xVal[t]+r.xNumSteps[t]*i;r.xHighestCompleteStep[t]=o}else r.xSteps[t]=r.xHighestCompleteStep[t]=r.xVal[t]}function l(t,e,r){var n;this.xPct=[],this.xVal=[],this.xSteps=[r||!1],this.xNumSteps=[!1],this.xHighestCompleteStep=[],this.snap=e;var i=[];for(n in t)t.hasOwnProperty(n)&&i.push([t[n],n]);for(i.length&&"object"==typeof i[0][0]?i.sort(function(t,e){return t[0][0]-e[0][0]}):i.sort(function(t,e){return t[0]-e[0]}),n=0;n<i.length;n++)o(i[n][1],i[n][0],this);for(this.xNumSteps=this.xSteps.slice(0),n=0;n<this.xNumSteps.length;n++)a(n,this.xNumSteps[n],this)}l.prototype.getMargin=function(t){var e=this.xNumSteps[0];if(e&&t/e%1!=0)throw new Error("noUiSlider ("+ut+"): 'limit', 'margin' and 'padding' must be divisible by step.");return 2===this.xPct.length&&p(this.xVal,t)},l.prototype.toStepping=function(t){return t=r(this.xVal,this.xPct,t)},l.prototype.fromStepping=function(t){return function(t,e,r){if(100<=r)return t.slice(-1)[0];var n,i=f(r,e),o=t[i-1],a=t[i],s=e[i-1],l=e[i];return n=[o,a],(r-s)*c(s,l)*(n[1]-n[0])/100+n[0]}(this.xVal,this.xPct,t)},l.prototype.getStep=function(t){return t=n(this.xPct,this.xSteps,this.snap,t)},l.prototype.getDefaultStep=function(t,e,r){var n=f(t,this.xPct);return(100===t||e&&t===this.xPct[n-1])&&(n=Math.max(n-1,1)),(this.xVal[n]-this.xVal[n-1])/r},l.prototype.getNearbySteps=function(t){var e=f(t,this.xPct);return{stepBefore:{startValue:this.xVal[e-2],step:this.xNumSteps[e-2],highestStep:this.xHighestCompleteStep[e-2]},thisStep:{startValue:this.xVal[e-1],step:this.xNumSteps[e-1],highestStep:this.xHighestCompleteStep[e-1]},stepAfter:{startValue:this.xVal[e],step:this.xNumSteps[e],highestStep:this.xHighestCompleteStep[e]}}},l.prototype.countStepDecimals=function(){var t=this.xNumSteps.map(e);return Math.max.apply(null,t)},l.prototype.convert=function(t){return this.getStep(this.toStepping(t))};var u={to:function(t){return void 0!==t&&t.toFixed(2)},from:Number};function d(t){if("object"==typeof(e=t)&&"function"==typeof e.to&&"function"==typeof e.from)return!0;var e;throw new Error("noUiSlider ("+ut+"): 'format' requires 'to' and 'from' methods.")}function h(t,e){if(!i(e))throw new Error("noUiSlider ("+ut+"): 'step' is not numeric.");t.singleStep=e}function m(t,e){if("object"!=typeof e||Array.isArray(e))throw new Error("noUiSlider ("+ut+"): 'range' is not an object.");if(void 0===e.min||void 0===e.max)throw new Error("noUiSlider ("+ut+"): Missing 'min' or 'max' in 'range'.");if(e.min===e.max)throw new Error("noUiSlider ("+ut+"): 'range' 'min' and 'max' cannot be equal.");t.spectrum=new l(e,t.snap,t.singleStep)}function g(t,e){if(e=ht(e),!Array.isArray(e)||!e.length)throw new Error("noUiSlider ("+ut+"): 'start' option is incorrect.");t.handles=e.length,t.start=e}function v(t,e){if("boolean"!=typeof(t.snap=e))throw new Error("noUiSlider ("+ut+"): 'snap' option must be a boolean.")}function b(t,e){if("boolean"!=typeof(t.animate=e))throw new Error("noUiSlider ("+ut+"): 'animate' option must be a boolean.")}function S(t,e){if("number"!=typeof(t.animationDuration=e))throw new Error("noUiSlider ("+ut+"): 'animationDuration' option must be a number.")}function x(t,e){var r,n=[!1];if("lower"===e?e=[!0,!1]:"upper"===e&&(e=[!1,!0]),!0===e||!1===e){for(r=1;r<t.handles;r++)n.push(e);n.push(!1)}else{if(!Array.isArray(e)||!e.length||e.length!==t.handles+1)throw new Error("noUiSlider ("+ut+"): 'connect' option doesn't match handle count.");n=e}t.connect=n}function w(t,e){switch(e){case"horizontal":t.ort=0;break;case"vertical":t.ort=1;break;default:throw new Error("noUiSlider ("+ut+"): 'orientation' option is invalid.")}}function y(t,e){if(!i(e))throw new Error("noUiSlider ("+ut+"): 'margin' option must be numeric.");if(0!==e&&(t.margin=t.spectrum.getMargin(e),!t.margin))throw new Error("noUiSlider ("+ut+"): 'margin' option is only supported on linear sliders.")}function E(t,e){if(!i(e))throw new Error("noUiSlider ("+ut+"): 'limit' option must be numeric.");if(t.limit=t.spectrum.getMargin(e),!t.limit||t.handles<2)throw new Error("noUiSlider ("+ut+"): 'limit' option is only supported on linear sliders with 2 or more handles.")}function C(t,e){if(!i(e)&&!Array.isArray(e))throw new Error("noUiSlider ("+ut+"): 'padding' option must be numeric or array of exactly 2 numbers.");if(Array.isArray(e)&&2!==e.length&&!i(e[0])&&!i(e[1]))throw new Error("noUiSlider ("+ut+"): 'padding' option must be numeric or array of exactly 2 numbers.");if(0!==e){if(Array.isArray(e)||(e=[e,e]),!(t.padding=[t.spectrum.getMargin(e[0]),t.spectrum.getMargin(e[1])])===t.padding[0]||!1===t.padding[1])throw new Error("noUiSlider ("+ut+"): 'padding' option is only supported on linear sliders.");if(t.padding[0]<0||t.padding[1]<0)throw new Error("noUiSlider ("+ut+"): 'padding' option must be a positive number(s).");if(100<t.padding[0]+t.padding[1])throw new Error("noUiSlider ("+ut+"): 'padding' option must not exceed 100% of the range.")}}function N(t,e){switch(e){case"ltr":t.dir=0;break;case"rtl":t.dir=1;break;default:throw new Error("noUiSlider ("+ut+"): 'direction' option was not recognized.")}}function U(t,e){if("string"!=typeof e)throw new Error("noUiSlider ("+ut+"): 'behaviour' must be a string containing options.");var r=0<=e.indexOf("tap"),n=0<=e.indexOf("drag"),i=0<=e.indexOf("fixed"),o=0<=e.indexOf("snap"),a=0<=e.indexOf("hover"),s=0<=e.indexOf("unconstrained");if(i){if(2!==t.handles)throw new Error("noUiSlider ("+ut+"): 'fixed' behaviour must be used with 2 handles");y(t,t.start[1]-t.start[0])}if(s&&(t.margin||t.limit))throw new Error("noUiSlider ("+ut+"): 'unconstrained' behaviour cannot be used with margin or limit");t.events={tap:r||o,drag:n,fixed:i,snap:o,hover:a,unconstrained:s}}function k(t,e){if(!1!==e)if(!0===e){t.tooltips=[];for(var r=0;r<t.handles;r++)t.tooltips.push(!0)}else{if(t.tooltips=ht(e),t.tooltips.length!==t.handles)throw new Error("noUiSlider ("+ut+"): must pass a formatter for all handles.");t.tooltips.forEach(function(t){if("boolean"!=typeof t&&("object"!=typeof t||"function"!=typeof t.to))throw new Error("noUiSlider ("+ut+"): 'tooltips' must be passed a formatter or 'false'.")})}}function P(t,e){d(t.ariaFormat=e)}function A(t,e){d(t.format=e)}function V(t,e){if("boolean"!=typeof(t.keyboardSupport=e))throw new Error("noUiSlider ("+ut+"): 'keyboardSupport' option must be a boolean.")}function M(t,e){t.documentElement=e}function O(t,e){if("string"!=typeof e&&!1!==e)throw new Error("noUiSlider ("+ut+"): 'cssPrefix' must be a string or `false`.");t.cssPrefix=e}function L(t,e){if("object"!=typeof e)throw new Error("noUiSlider ("+ut+"): 'cssClasses' must be an object.");if("string"==typeof t.cssPrefix)for(var r in t.cssClasses={},e)e.hasOwnProperty(r)&&(t.cssClasses[r]=t.cssPrefix+e[r]);else t.cssClasses=e}function bt(e){var r={margin:0,limit:0,padding:0,animate:!0,animationDuration:300,ariaFormat:u,format:u},n={step:{r:!1,t:h},start:{r:!0,t:g},connect:{r:!0,t:x},direction:{r:!0,t:N},snap:{r:!1,t:v},animate:{r:!1,t:b},animationDuration:{r:!1,t:S},range:{r:!0,t:m},orientation:{r:!1,t:w},margin:{r:!1,t:y},limit:{r:!1,t:E},padding:{r:!1,t:C},behaviour:{r:!0,t:U},ariaFormat:{r:!1,t:P},format:{r:!1,t:A},tooltips:{r:!1,t:k},keyboardSupport:{r:!0,t:V},documentElement:{r:!1,t:M},cssPrefix:{r:!0,t:O},cssClasses:{r:!0,t:L}},i={connect:!1,direction:"ltr",behaviour:"tap",orientation:"horizontal",keyboardSupport:!0,cssPrefix:"noUi-",cssClasses:{target:"target",base:"base",origin:"origin",handle:"handle",handleLower:"handle-lower",handleUpper:"handle-upper",touchArea:"touch-area",horizontal:"horizontal",vertical:"vertical",background:"background",connect:"connect",connects:"connects",ltr:"ltr",rtl:"rtl",draggable:"draggable",drag:"state-drag",tap:"state-tap",active:"active",tooltip:"tooltip",pips:"pips",pipsHorizontal:"pips-horizontal",pipsVertical:"pips-vertical",marker:"marker",markerHorizontal:"marker-horizontal",markerVertical:"marker-vertical",markerNormal:"marker-normal",markerLarge:"marker-large",markerSub:"marker-sub",value:"value",valueHorizontal:"value-horizontal",valueVertical:"value-vertical",valueNormal:"value-normal",valueLarge:"value-large",valueSub:"value-sub"}};e.format&&!e.ariaFormat&&(e.ariaFormat=e.format),Object.keys(n).forEach(function(t){if(!s(e[t])&&void 0===i[t]){if(n[t].r)throw new Error("noUiSlider ("+ut+"): '"+t+"' is required.");return!0}n[t].t(r,s(e[t])?e[t]:i[t])}),r.pips=e.pips;var t=document.createElement("div"),o=void 0!==t.style.msTransform,a=void 0!==t.style.transform;r.transformRule=a?"transform":o?"msTransform":"webkitTransform";return r.style=[["left","top"],["right","bottom"]][r.dir][r.ort],r}function z(t,f,o){var l,u,a,c,i,s,e,p,d=window.navigator.pointerEnabled?{start:"pointerdown",move:"pointermove",end:"pointerup"}:window.navigator.msPointerEnabled?{start:"MSPointerDown",move:"MSPointerMove",end:"MSPointerUp"}:{start:"mousedown touchstart",move:"mousemove touchmove",end:"mouseup touchend"},h=window.CSS&&CSS.supports&&CSS.supports("touch-action","none")&&function(){var t=!1;try{var e=Object.defineProperty({},"passive",{get:function(){t=!0}});window.addEventListener("test",null,e)}catch(t){}return t}(),y=t,E=f.spectrum,m=[],g=[],v=[],b=0,S={},x=t.ownerDocument,w=f.documentElement||x.documentElement,C=x.body,N=-1,U=0,k=1,P=2,A="rtl"===x.dir||1===f.ort?0:100;function V(t,e){var r=x.createElement("div");return e&&mt(r,e),t.appendChild(r),r}function M(t,e){var r=V(t,f.cssClasses.origin),n=V(r,f.cssClasses.handle);return V(n,f.cssClasses.touchArea),n.setAttribute("data-handle",e),f.keyboardSupport&&(n.setAttribute("tabindex","0"),n.addEventListener("keydown",function(t){return function(t,e){if(L()||z(e))return!1;var r=["Left","Right"],n=["Down","Up"];f.dir&&!f.ort?r.reverse():f.ort&&!f.dir&&n.reverse();var i=t.key.replace("Arrow",""),o=i===n[0]||i===r[0],a=i===n[1]||i===r[1];if(!o&&!a)return!0;t.preventDefault();var s=o?0:1,l=lt(e)[s];if(null===l)return!1;!1===l&&(l=E.getDefaultStep(g[e],o,10));return l=Math.max(l,1e-7),l*=o?-1:1,at(e,m[e]+l,!0),!1}(t,e)})),n.setAttribute("role","slider"),n.setAttribute("aria-orientation",f.ort?"vertical":"horizontal"),0===e?mt(n,f.cssClasses.handleLower):e===f.handles-1&&mt(n,f.cssClasses.handleUpper),r}function O(t,e){return!!e&&V(t,f.cssClasses.connect)}function r(t,e){return!!f.tooltips[e]&&V(t.firstChild,f.cssClasses.tooltip)}function L(){return y.hasAttribute("disabled")}function z(t){return u[t].hasAttribute("disabled")}function j(){i&&(G("update.tooltips"),i.forEach(function(t){t&&ct(t)}),i=null)}function H(){j(),i=u.map(r),$("update.tooltips",function(t,e,r){if(i[e]){var n=t[e];!0!==f.tooltips[e]&&(n=f.tooltips[e].to(r[e])),i[e].innerHTML=n}})}function F(e,i,o){var a=x.createElement("div"),s=[];s[U]=f.cssClasses.valueNormal,s[k]=f.cssClasses.valueLarge,s[P]=f.cssClasses.valueSub;var l=[];l[U]=f.cssClasses.markerNormal,l[k]=f.cssClasses.markerLarge,l[P]=f.cssClasses.markerSub;var u=[f.cssClasses.valueHorizontal,f.cssClasses.valueVertical],c=[f.cssClasses.markerHorizontal,f.cssClasses.markerVertical];function p(t,e){var r=e===f.cssClasses.value,n=r?s:l;return e+" "+(r?u:c)[f.ort]+" "+n[t]}return mt(a,f.cssClasses.pips),mt(a,0===f.ort?f.cssClasses.pipsHorizontal:f.cssClasses.pipsVertical),Object.keys(e).forEach(function(t){!function(t,e,r){if((r=i?i(e,r):r)!==N){var n=V(a,!1);n.className=p(r,f.cssClasses.marker),n.style[f.style]=t+"%",U<r&&((n=V(a,!1)).className=p(r,f.cssClasses.value),n.setAttribute("data-value",e),n.style[f.style]=t+"%",n.innerHTML=o.to(e))}}(t,e[t][0],e[t][1])}),a}function D(){c&&(ct(c),c=null)}function T(t){D();var m,g,v,b,e,r,S,x,w,n=t.mode,i=t.density||1,o=t.filter||!1,a=function(t,e,r){if("range"===t||"steps"===t)return E.xVal;if("count"===t){if(e<2)throw new Error("noUiSlider ("+ut+"): 'values' (>= 2) required for mode 'count'.");var n=e-1,i=100/n;for(e=[];n--;)e[n]=n*i;e.push(100),t="positions"}return"positions"===t?e.map(function(t){return E.fromStepping(r?E.getStep(t):t)}):"values"===t?r?e.map(function(t){return E.fromStepping(E.getStep(E.toStepping(t)))}):e:void 0}(n,t.values||!1,t.stepped||!1),s=(m=i,g=n,v=a,b={},e=E.xVal[0],r=E.xVal[E.xVal.length-1],x=S=!1,w=0,(v=v.slice().sort(function(t,e){return t-e}).filter(function(t){return!this[t]&&(this[t]=!0)},{}))[0]!==e&&(v.unshift(e),S=!0),v[v.length-1]!==r&&(v.push(r),x=!0),v.forEach(function(t,e){var r,n,i,o,a,s,l,u,c,p,f=t,d=v[e+1],h="steps"===g;if(h&&(r=E.xNumSteps[e]),r||(r=d-f),!1!==f&&void 0!==d)for(r=Math.max(r,1e-7),n=f;n<=d;n=(n+r).toFixed(7)/1){for(u=(a=(o=E.toStepping(n))-w)/m,p=a/(c=Math.round(u)),i=1;i<=c;i+=1)b[(s=w+i*p).toFixed(5)]=[E.fromStepping(s),0];l=-1<v.indexOf(n)?k:h?P:U,!e&&S&&(l=0),n===d&&x||(b[o.toFixed(5)]=[n,l]),w=o}}),b),l=t.format||{to:Math.round};return c=y.appendChild(F(s,o,l))}function R(){var t=l.getBoundingClientRect(),e="offset"+["Width","Height"][f.ort];return 0===f.ort?t.width||l[e]:t.height||l[e]}function B(n,i,o,a){var e=function(t){return!!(t=function(t,e,r){var n,i,o=0===t.type.indexOf("touch"),a=0===t.type.indexOf("mouse"),s=0===t.type.indexOf("pointer");0===t.type.indexOf("MSPointer")&&(s=!0);if(o){var l=function(t){return t.target===r||r.contains(t.target)};if("touchstart"===t.type){var u=Array.prototype.filter.call(t.touches,l);if(1<u.length)return!1;n=u[0].pageX,i=u[0].pageY}else{var c=Array.prototype.find.call(t.changedTouches,l);if(!c)return!1;n=c.pageX,i=c.pageY}}e=e||vt(x),(a||s)&&(n=t.clientX+e.x,i=t.clientY+e.y);return t.pageOffset=e,t.points=[n,i],t.cursor=a||s,t}(t,a.pageOffset,a.target||i))&&(!(L()&&!a.doNotReject)&&(e=y,r=f.cssClasses.tap,!((e.classList?e.classList.contains(r):new RegExp("\\b"+r+"\\b").test(e.className))&&!a.doNotReject)&&(!(n===d.start&&void 0!==t.buttons&&1<t.buttons)&&((!a.hover||!t.buttons)&&(h||t.preventDefault(),t.calcPoint=t.points[f.ort],void o(t,a))))));var e,r},r=[];return n.split(" ").forEach(function(t){i.addEventListener(t,e,!!h&&{passive:!0}),r.push([t,e])}),r}function q(t){var e,r,n,i,o,a,s=100*(t-(e=l,r=f.ort,n=e.getBoundingClientRect(),i=e.ownerDocument,o=i.documentElement,a=vt(i),/webkit.*Chrome.*Mobile/i.test(navigator.userAgent)&&(a.x=0),r?n.top+a.y-o.clientTop:n.left+a.x-o.clientLeft))/R();return s=dt(s),f.dir?100-s:s}function X(t,e){"mouseout"===t.type&&"HTML"===t.target.nodeName&&null===t.relatedTarget&&_(t,e)}function Y(t,e){if(-1===navigator.appVersion.indexOf("MSIE 9")&&0===t.buttons&&0!==e.buttonsProperty)return _(t,e);var r=(f.dir?-1:1)*(t.calcPoint-e.startCalcPoint);Z(0<r,100*r/e.baseSize,e.locations,e.handleNumbers)}function _(t,e){e.handle&&(gt(e.handle,f.cssClasses.active),b-=1),e.listeners.forEach(function(t){w.removeEventListener(t[0],t[1])}),0===b&&(gt(y,f.cssClasses.drag),et(),t.cursor&&(C.style.cursor="",C.removeEventListener("selectstart",pt))),e.handleNumbers.forEach(function(t){J("change",t),J("set",t),J("end",t)})}function I(t,e){if(e.handleNumbers.some(z))return!1;var r;1===e.handleNumbers.length&&(r=u[e.handleNumbers[0]].children[0],b+=1,mt(r,f.cssClasses.active));t.stopPropagation();var n=[],i=B(d.move,w,Y,{target:t.target,handle:r,listeners:n,startCalcPoint:t.calcPoint,baseSize:R(),pageOffset:t.pageOffset,handleNumbers:e.handleNumbers,buttonsProperty:t.buttons,locations:g.slice()}),o=B(d.end,w,_,{target:t.target,handle:r,listeners:n,doNotReject:!0,handleNumbers:e.handleNumbers}),a=B("mouseout",w,X,{target:t.target,handle:r,listeners:n,doNotReject:!0,handleNumbers:e.handleNumbers});n.push.apply(n,i.concat(o,a)),t.cursor&&(C.style.cursor=getComputedStyle(t.target).cursor,1<u.length&&mt(y,f.cssClasses.drag),C.addEventListener("selectstart",pt,!1)),e.handleNumbers.forEach(function(t){J("start",t)})}function n(t){t.stopPropagation();var n,i,o,e=q(t.calcPoint),r=(n=e,o=!(i=100),u.forEach(function(t,e){if(!z(e)){var r=Math.abs(g[e]-n);(r<i||100===r&&100===i)&&(o=e,i=r)}}),o);if(!1===r)return!1;f.events.snap||ft(y,f.cssClasses.tap,f.animationDuration),rt(r,e,!0,!0),et(),J("slide",r,!0),J("update",r,!0),J("change",r,!0),J("set",r,!0),f.events.snap&&I(t,{handleNumbers:[r]})}function W(t){var e=q(t.calcPoint),r=E.getStep(e),n=E.fromStepping(r);Object.keys(S).forEach(function(t){"hover"===t.split(".")[0]&&S[t].forEach(function(t){t.call(s,n)})})}function $(t,e){S[t]=S[t]||[],S[t].push(e),"update"===t.split(".")[0]&&u.forEach(function(t,e){J("update",e)})}function G(t){var n=t&&t.split(".")[0],i=n&&t.substring(n.length);Object.keys(S).forEach(function(t){var e=t.split(".")[0],r=t.substring(e.length);n&&n!==e||i&&i!==r||delete S[t]})}function J(r,n,i){Object.keys(S).forEach(function(t){var e=t.split(".")[0];r===e&&S[t].forEach(function(t){t.call(s,m.map(f.format.to),n,m.slice(),i||!1,g.slice())})})}function K(t,e,r,n,i,o){return 1<u.length&&!f.events.unconstrained&&(n&&0<e&&(r=Math.max(r,t[e-1]+f.margin)),i&&e<u.length-1&&(r=Math.min(r,t[e+1]-f.margin))),1<u.length&&f.limit&&(n&&0<e&&(r=Math.min(r,t[e-1]+f.limit)),i&&e<u.length-1&&(r=Math.max(r,t[e+1]-f.limit))),f.padding&&(0===e&&(r=Math.max(r,f.padding[0])),e===u.length-1&&(r=Math.min(r,100-f.padding[1]))),!((r=dt(r=E.getStep(r)))===t[e]&&!o)&&r}function Q(t,e){var r=f.ort;return(r?e:t)+", "+(r?t:e)}function Z(t,n,r,e){var i=r.slice(),o=[!t,t],a=[t,!t];e=e.slice(),t&&e.reverse(),1<e.length?e.forEach(function(t,e){var r=K(i,t,i[t]+n,o[e],a[e],!1);!1===r?n=0:(n=r-i[t],i[t]=r)}):o=a=[!0];var s=!1;e.forEach(function(t,e){s=rt(t,r[t]+n,o[e],a[e])||s}),s&&e.forEach(function(t){J("update",t),J("slide",t)})}function tt(t,e){return f.dir?100-t-e:t}function et(){v.forEach(function(t){var e=50<g[t]?-1:1,r=3+(u.length+e*t);u[t].style.zIndex=r})}function rt(t,e,r,n){return!1!==(e=K(g,t,e,r,n,!1))&&(function(t,e){g[t]=e,m[t]=E.fromStepping(e);var r="translate("+Q(tt(e,0)-A+"%","0")+")";u[t].style[f.transformRule]=r,nt(t),nt(t+1)}(t,e),!0)}function nt(t){if(a[t]){var e=0,r=100;0!==t&&(e=g[t-1]),t!==a.length-1&&(r=g[t]);var n=r-e,i="translate("+Q(tt(e,n)+"%","0")+")",o="scale("+Q(n/100,"1")+")";a[t].style[f.transformRule]=i+" "+o}}function it(t,e){return null===t||!1===t||void 0===t?g[e]:("number"==typeof t&&(t=String(t)),t=f.format.from(t),!1===(t=E.toStepping(t))||isNaN(t)?g[e]:t)}function ot(t,e){var r=ht(t),n=void 0===g[0];e=void 0===e||!!e,f.animate&&!n&&ft(y,f.cssClasses.tap,f.animationDuration),v.forEach(function(t){rt(t,it(r[t],t),!0,!1)}),v.forEach(function(t){rt(t,g[t],!0,!0)}),et(),v.forEach(function(t){J("update",t),null!==r[t]&&e&&J("set",t)})}function at(t,e,r){if(!(0<=(t=Number(t))&&t<v.length))throw new Error("noUiSlider ("+ut+"): invalid handle number, got: "+t);rt(t,it(e,t),!0,!0),J("update",t),r&&J("set",t)}function st(){var t=m.map(f.format.to);return 1===t.length?t[0]:t}function lt(t){var e=g[t],r=E.getNearbySteps(e),n=m[t],i=r.thisStep.step,o=null;if(f.snap)return[n-r.stepBefore.startValue||null,r.stepAfter.startValue-n||null];!1!==i&&n+i>r.stepAfter.startValue&&(i=r.stepAfter.startValue-n),o=n>r.thisStep.startValue?r.thisStep.step:!1!==r.stepBefore.step&&n-r.stepBefore.highestStep,100===e?i=null:0===e&&(o=null);var a=E.countStepDecimals();return null!==i&&!1!==i&&(i=Number(i.toFixed(a))),null!==o&&!1!==o&&(o=Number(o.toFixed(a))),[o,i]}return mt(e=y,f.cssClasses.target),0===f.dir?mt(e,f.cssClasses.ltr):mt(e,f.cssClasses.rtl),0===f.ort?mt(e,f.cssClasses.horizontal):mt(e,f.cssClasses.vertical),l=V(e,f.cssClasses.base),function(t,e){var r=V(e,f.cssClasses.connects);u=[],(a=[]).push(O(r,t[0]));for(var n=0;n<f.handles;n++)u.push(M(e,n)),v[n]=n,a.push(O(r,t[n+1]))}(f.connect,l),(p=f.events).fixed||u.forEach(function(t,e){B(d.start,t.children[0],I,{handleNumbers:[e]})}),p.tap&&B(d.start,l,n,{}),p.hover&&B(d.move,l,W,{hover:!0}),p.drag&&a.forEach(function(t,e){if(!1!==t&&0!==e&&e!==a.length-1){var r=u[e-1],n=u[e],i=[t];mt(t,f.cssClasses.draggable),p.fixed&&(i.push(r.children[0]),i.push(n.children[0])),i.forEach(function(t){B(d.start,t,I,{handles:[r,n],handleNumbers:[e-1,e]})})}}),ot(f.start),f.pips&&T(f.pips),f.tooltips&&H(),$("update",function(t,e,a,r,s){v.forEach(function(t){var e=u[t],r=K(g,t,0,!0,!0,!0),n=K(g,t,100,!0,!0,!0),i=s[t],o=f.ariaFormat.to(a[t]);r=E.fromStepping(r).toFixed(1),n=E.fromStepping(n).toFixed(1),i=E.fromStepping(i).toFixed(1),e.children[0].setAttribute("aria-valuemin",r),e.children[0].setAttribute("aria-valuemax",n),e.children[0].setAttribute("aria-valuenow",i),e.children[0].setAttribute("aria-valuetext",o)})}),s={destroy:function(){for(var t in f.cssClasses)f.cssClasses.hasOwnProperty(t)&&gt(y,f.cssClasses[t]);for(;y.firstChild;)y.removeChild(y.firstChild);delete y.noUiSlider},steps:function(){return v.map(lt)},on:$,off:G,get:st,set:ot,setHandle:at,reset:function(t){ot(f.start,t)},__moveHandles:function(t,e,r){Z(t,e,g,r)},options:o,updateOptions:function(e,t){var r=st(),n=["margin","limit","padding","range","animate","snap","step","format","pips","tooltips"];n.forEach(function(t){void 0!==e[t]&&(o[t]=e[t])});var i=bt(o);n.forEach(function(t){void 0!==e[t]&&(f[t]=i[t])}),E=i.spectrum,f.margin=i.margin,f.limit=i.limit,f.padding=i.padding,f.pips?T(f.pips):D(),f.tooltips?H():j(),g=[],ot(e.start||r,t)},target:y,removePips:D,removeTooltips:j,pips:T}}return{__spectrum:l,version:ut,create:function(t,e){if(!t||!t.nodeName)throw new Error("noUiSlider ("+ut+"): create requires a single element, got: "+t);if(t.noUiSlider)throw new Error("noUiSlider ("+ut+"): Slider was already initialized.");var r=z(t,bt(e),e);return t.noUiSlider=r}}});
/** @preserve
 * MIT License
 *
 * Copyright (c) 2018 Will Po
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:

 *The above copyright notice and this permission notice shall be included in all
 *copies or substantial portions of the Software.
 * https://github.com/willmcpo/body-scroll-lock
 */
(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(['exports'], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports);
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports);
    global.bodyScrollLock = mod.exports;
  }
})(this, function (exports) {
  'use strict';

  Object.defineProperty(exports, "__esModule", {
    value: true
  });

  function _toConsumableArray(arr) {
    if (Array.isArray(arr)) {
      for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) {
        arr2[i] = arr[i];
      }

      return arr2;
    } else {
      return Array.from(arr);
    }
  }

  // Older browsers don't support event options, feature detect it.

  // Adopted and modified solution from Bohdan Didukh (2017)
  // https://stackoverflow.com/questions/41594997/ios-10-safari-prevent-scrolling-behind-a-fixed-overlay-and-maintain-scroll-posi

  var hasPassiveEvents = false;
  if (typeof window !== 'undefined') {
    var passiveTestOptions = {
      get passive() {
        hasPassiveEvents = true;
        return undefined;
      }
    };
    window.addEventListener('testPassive', null, passiveTestOptions);
    window.removeEventListener('testPassive', null, passiveTestOptions);
  }

  var isIosDevice = typeof window !== 'undefined' && window.navigator && window.navigator.platform && /iP(ad|hone|od)/.test(window.navigator.platform);


  var locks = [];
  var documentListenerAdded = false;
  var initialClientY = -1;
  var previousBodyOverflowSetting = void 0;
  var previousBodyPaddingRight = void 0;

  // returns true if `el` should be allowed to receive touchmove events.
  var allowTouchMove = function allowTouchMove(el) {
    return locks.some(function (lock) {
      if (lock.options.allowTouchMove && lock.options.allowTouchMove(el)) {
        return true;
      }

      return false;
    });
  };

  var preventDefault = function preventDefault(rawEvent) {
    var e = rawEvent || window.event;

    // For the case whereby consumers adds a touchmove event listener to document.
    // Recall that we do document.addEventListener('touchmove', preventDefault, { passive: false })
    // in disableBodyScroll - so if we provide this opportunity to allowTouchMove, then
    // the touchmove event on document will break.
    if (allowTouchMove(e.target)) {
      return true;
    }

    // Do not prevent if the event has more than one touch (usually meaning this is a multi touch gesture like pinch to zoom).
    if (e.touches.length > 1) return true;

    if (e.preventDefault) e.preventDefault();

    return false;
  };

  var setOverflowHidden = function setOverflowHidden(options) {
    // Setting overflow on body/documentElement synchronously in Desktop Safari slows down
    // the responsiveness for some reason. Setting within a setTimeout fixes this.
    setTimeout(function () {
      // If previousBodyPaddingRight is already set, don't set it again.
      if (previousBodyPaddingRight === undefined) {
        var _reserveScrollBarGap = !!options && options.reserveScrollBarGap === true;
        var scrollBarGap = window.innerWidth - document.documentElement.clientWidth;

        if (_reserveScrollBarGap && scrollBarGap > 0) {
          previousBodyPaddingRight = document.body.style.paddingRight;
          document.body.style.paddingRight = scrollBarGap + 'px';
        }
      }

      // If previousBodyOverflowSetting is already set, don't set it again.
      if (previousBodyOverflowSetting === undefined) {
        previousBodyOverflowSetting = document.body.style.overflow;
        document.body.style.overflow = 'hidden';
      }
    });
  };

  var restoreOverflowSetting = function restoreOverflowSetting() {
    // Setting overflow on body/documentElement synchronously in Desktop Safari slows down
    // the responsiveness for some reason. Setting within a setTimeout fixes this.
    setTimeout(function () {
      if (previousBodyPaddingRight !== undefined) {
        document.body.style.paddingRight = previousBodyPaddingRight;

        // Restore previousBodyPaddingRight to undefined so setOverflowHidden knows it
        // can be set again.
        previousBodyPaddingRight = undefined;
      }

      if (previousBodyOverflowSetting !== undefined) {
        document.body.style.overflow = previousBodyOverflowSetting;

        // Restore previousBodyOverflowSetting to undefined
        // so setOverflowHidden knows it can be set again.
        previousBodyOverflowSetting = undefined;
      }
    });
  };

  // https://developer.mozilla.org/en-US/docs/Web/API/Element/scrollHeight#Problems_and_solutions
  var isTargetElementTotallyScrolled = function isTargetElementTotallyScrolled(targetElement) {
    return targetElement ? targetElement.scrollHeight - targetElement.scrollTop <= targetElement.clientHeight : false;
  };

  var handleScroll = function handleScroll(event, targetElement) {
    var clientY = event.targetTouches[0].clientY - initialClientY;

    if (allowTouchMove(event.target)) {
      return false;
    }

    if (targetElement && targetElement.scrollTop === 0 && clientY > 0) {
      // element is at the top of its scroll.
      return preventDefault(event);
    }

    if (isTargetElementTotallyScrolled(targetElement) && clientY < 0) {
      // element is at the top of its scroll.
      return preventDefault(event);
    }

    event.stopPropagation();
    return true;
  };

  var disableBodyScroll = exports.disableBodyScroll = function disableBodyScroll(targetElement, options) {
    if (isIosDevice) {
      // targetElement must be provided, and disableBodyScroll must not have been
      // called on this targetElement before.
      if (!targetElement) {
        // eslint-disable-next-line no-console
        console.error('disableBodyScroll unsuccessful - targetElement must be provided when calling disableBodyScroll on IOS devices.');
        return;
      }

      if (targetElement && !locks.some(function (lock) {
        return lock.targetElement === targetElement;
      })) {
        var lock = {
          targetElement: targetElement,
          options: options || {}
        };

        locks = [].concat(_toConsumableArray(locks), [lock]);

        targetElement.ontouchstart = function (event) {
          if (event.targetTouches.length === 1) {
            // detect single touch.
            initialClientY = event.targetTouches[0].clientY;
          }
        };
        targetElement.ontouchmove = function (event) {
          if (event.targetTouches.length === 1) {
            // detect single touch.
            handleScroll(event, targetElement);
          }
        };

        if (!documentListenerAdded) {
          document.addEventListener('touchmove', preventDefault, hasPassiveEvents ? { passive: false } : undefined);
          documentListenerAdded = true;
        }
      }
    } else {
      setOverflowHidden(options);
      var _lock = {
        targetElement: targetElement,
        options: options || {}
      };

      locks = [].concat(_toConsumableArray(locks), [_lock]);
    }
  };

  var clearAllBodyScrollLocks = exports.clearAllBodyScrollLocks = function clearAllBodyScrollLocks() {
    if (isIosDevice) {
      // Clear all locks ontouchstart/ontouchmove handlers, and the references.
      locks.forEach(function (lock) {
        lock.targetElement.ontouchstart = null;
        lock.targetElement.ontouchmove = null;
      });

      if (documentListenerAdded) {
        document.removeEventListener('touchmove', preventDefault, hasPassiveEvents ? { passive: false } : undefined);
        documentListenerAdded = false;
      }

      locks = [];

      // Reset initial clientY.
      initialClientY = -1;
    } else {
      restoreOverflowSetting();
      locks = [];
    }
  };

  var enableBodyScroll = exports.enableBodyScroll = function enableBodyScroll(targetElement) {
    if (isIosDevice) {
      if (!targetElement) {
        // eslint-disable-next-line no-console
        console.error('enableBodyScroll unsuccessful - targetElement must be provided when calling enableBodyScroll on IOS devices.');
        return;
      }

      targetElement.ontouchstart = null;
      targetElement.ontouchmove = null;

      locks = locks.filter(function (lock) {
        return lock.targetElement !== targetElement;
      });

      if (documentListenerAdded && locks.length === 0) {
        document.removeEventListener('touchmove', preventDefault, hasPassiveEvents ? { passive: false } : undefined);

        documentListenerAdded = false;
      }
    } else {
      locks = locks.filter(function (lock) {
        return lock.targetElement !== targetElement;
      });
      if (!locks.length) {
        restoreOverflowSetting();
      }
    }
  };
});

/*
 * jQuery doTimeout: Like setTimeout, but better! - v1.0 - 3/3/2010
 * http://benalman.com/projects/jquery-dotimeout-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function($){var a={},c="doTimeout",d=Array.prototype.slice;$[c]=function(){return b.apply(window,[0].concat(d.call(arguments)))};$.fn[c]=function(){var f=d.call(arguments),e=b.apply(this,[c+f[0]].concat(f));return typeof f[0]==="number"||typeof f[1]==="number"?this:e};function b(l){var m=this,h,k={},g=l?$.fn:$,n=arguments,i=4,f=n[1],j=n[2],p=n[3];if(typeof f!=="string"){i--;f=l=0;j=n[1];p=n[2]}if(l){h=m.eq(0);h.data(l,k=h.data(l)||{})}else{if(f){k=a[f]||(a[f]={})}}k.id&&clearTimeout(k.id);delete k.id;function e(){if(l){h.removeData(l)}else{if(f){delete a[f]}}}function o(){k.id=setTimeout(function(){k.fn()},j)}if(p){k.fn=function(q){if(typeof p==="string"){p=g[p]}p.apply(m,d.call(n,i))===true&&!q?o():e()};o()}else{if(k.fn){j===undefined?e():k.fn(j===false);return true}else{e()}}}})(jQuery);
/* ========================================================================
 * Bootstrap: button.js v3.3.1
 * http://getbootstrap.com/javascript/#buttons
 * ========================================================================
 * Copyright 2011-2014 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // BUTTON PUBLIC CLASS DEFINITION
  // ==============================

  var Button = function (element, options) {
    this.$element  = $(element)
    this.options   = $.extend({}, Button.DEFAULTS, options)
    this.isLoading = false
  }

  Button.VERSION  = '3.3.1'

  Button.DEFAULTS = {
    loadingText: 'loading...'
  }

  Button.prototype.setState = function (state) {
    var d    = 'disabled'
    var $el  = this.$element
    var val  = $el.is('input') ? 'val' : 'html'
    var data = $el.data()

    state = state + 'Text'

    if (data.resetText == null) $el.data('resetText', $el[val]())

    // push to event loop to allow forms to submit
    setTimeout($.proxy(function () {
      $el[val](data[state] == null ? this.options[state] : data[state])

      if (state == 'loadingText') {
        this.isLoading = true
        $el.addClass(d).attr(d, d)
      } else if (this.isLoading) {
        this.isLoading = false
        $el.removeClass(d).removeAttr(d)
      }
    }, this), 0)
  }

  Button.prototype.toggle = function () {
    var changed = true
    var $parent = this.$element.closest('[data-toggle="buttons"]')

    if ($parent.length) {
      var $input = this.$element.find('input')
      if ($input.prop('type') == 'radio') {
        if ($input.prop('checked') && this.$element.hasClass('active')) changed = false
        else $parent.find('.active').removeClass('active')
      }
      if (changed) $input.prop('checked', !this.$element.hasClass('active')).trigger('change')
    } else {
      this.$element.attr('aria-pressed', !this.$element.hasClass('active'))
    }

    if (changed) this.$element.toggleClass('active')
  }


  // BUTTON PLUGIN DEFINITION
  // ========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.button')
      var options = typeof option == 'object' && option

      if (!data) $this.data('bs.button', (data = new Button(this, options)))

      if (option == 'toggle') data.toggle()
      else if (option) data.setState(option)
    })
  }

  var old = $.fn.button

  $.fn.button             = Plugin
  $.fn.button.Constructor = Button


  // BUTTON NO CONFLICT
  // ==================

  $.fn.button.noConflict = function () {
    $.fn.button = old
    return this
  }


  // BUTTON DATA-API
  // ===============

  $(document)
    .on('click.bs.button.data-api', '[data-toggle^="button"]', function (e) {
      var $btn = $(e.target)
      if (!$btn.hasClass('btn')) $btn = $btn.closest('.btn')
      Plugin.call($btn, 'toggle')
      e.preventDefault()
    })
    .on('focus.bs.button.data-api blur.bs.button.data-api', '[data-toggle^="button"]', function (e) {
      $(e.target).closest('.btn').toggleClass('focus', /^focus(in)?$/.test(e.type))
    })

}(jQuery);

/* ========================================================================
 * Bootstrap: collapse.js v3.3.1
 * http://getbootstrap.com/javascript/#collapse
 * ========================================================================
 * Copyright 2011-2014 Twitter, Inc.
 * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
 * ======================================================================== */


+function ($) {
  'use strict';

  // COLLAPSE PUBLIC CLASS DEFINITION
  // ================================

  var Collapse = function (element, options) {
    this.$element      = $(element)
    this.options       = $.extend({}, Collapse.DEFAULTS, options)
    this.$trigger      = $(this.options.trigger).filter('[href="#' + element.id + '"], [data-target="#' + element.id + '"]')
    this.transitioning = null

    if (this.options.parent) {
      this.$parent = this.getParent()
    } else {
      this.addAriaAndCollapsedClass(this.$element, this.$trigger)
    }

    if (this.options.toggle) this.toggle()
  }

  Collapse.VERSION  = '3.3.1'

  Collapse.TRANSITION_DURATION = 350

  Collapse.DEFAULTS = {
    toggle: true,
    trigger: '[data-toggle="collapse"]'
  }

  Collapse.prototype.dimension = function () {
    var hasWidth = this.$element.hasClass('width')
    return hasWidth ? 'width' : 'height'
  }

  Collapse.prototype.show = function () {
    if (this.transitioning || this.$element.hasClass('in')) return

    var activesData
    var actives = this.$parent && this.$parent.find('> .panel').children('.in, .collapsing')

    if (actives && actives.length) {
      activesData = actives.data('bs.collapse')
      if (activesData && activesData.transitioning) return
    }

    var startEvent = $.Event('show.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    if (actives && actives.length) {
      Plugin.call(actives, 'hide')
      activesData || actives.data('bs.collapse', null)
    }

    var dimension = this.dimension()

    this.$element
      .removeClass('collapse')
      .addClass('collapsing')[dimension](0)
      .attr('aria-expanded', true)

    this.$trigger
      .removeClass('collapsed')
      .attr('aria-expanded', true)

    this.transitioning = 1

    var complete = function () {
      this.$element
        .removeClass('collapsing')
        .addClass('collapse in')[dimension]('')
      this.transitioning = 0
      this.$element
        .trigger('shown.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    var scrollSize = $.camelCase(['scroll', dimension].join('-'))

    this.$element
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)[dimension](this.$element[0][scrollSize])
  }

  Collapse.prototype.hide = function () {
    if (this.transitioning || !this.$element.hasClass('in')) return

    var startEvent = $.Event('hide.bs.collapse')
    this.$element.trigger(startEvent)
    if (startEvent.isDefaultPrevented()) return

    var dimension = this.dimension()

    this.$element[dimension](this.$element[dimension]())[0].offsetHeight

    this.$element
      .addClass('collapsing')
      .removeClass('collapse in')
      .attr('aria-expanded', false)

    this.$trigger
      .addClass('collapsed')
      .attr('aria-expanded', false)

    this.transitioning = 1

    var complete = function () {
      this.transitioning = 0
      this.$element
        .removeClass('collapsing')
        .addClass('collapse')
        .trigger('hidden.bs.collapse')
    }

    if (!$.support.transition) return complete.call(this)

    this.$element
      [dimension](0)
      .one('bsTransitionEnd', $.proxy(complete, this))
      .emulateTransitionEnd(Collapse.TRANSITION_DURATION)
  }

  Collapse.prototype.toggle = function () {
    this[this.$element.hasClass('in') ? 'hide' : 'show']()
  }

  Collapse.prototype.getParent = function () {
    return $(this.options.parent)
      .find('[data-toggle="collapse"][data-parent="' + this.options.parent + '"]')
      .each($.proxy(function (i, element) {
        var $element = $(element)
        this.addAriaAndCollapsedClass(getTargetFromTrigger($element), $element)
      }, this))
      .end()
  }

  Collapse.prototype.addAriaAndCollapsedClass = function ($element, $trigger) {
    var isOpen = $element.hasClass('in')

    $element.attr('aria-expanded', isOpen)
    $trigger
      .toggleClass('collapsed', !isOpen)
      .attr('aria-expanded', isOpen)
  }

  function getTargetFromTrigger($trigger) {
    var href
    var target = $trigger.attr('data-target')
      || (href = $trigger.attr('href')) && href.replace(/.*(?=#[^\s]+$)/, '') // strip for ie7

    return $(target)
  }


  // COLLAPSE PLUGIN DEFINITION
  // ==========================

  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var data    = $this.data('bs.collapse')
      var options = $.extend({}, Collapse.DEFAULTS, $this.data(), typeof option == 'object' && option)

      if (!data && options.toggle && option == 'show') options.toggle = false
      if (!data) $this.data('bs.collapse', (data = new Collapse(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.collapse

  $.fn.collapse             = Plugin
  $.fn.collapse.Constructor = Collapse


  // COLLAPSE NO CONFLICT
  // ====================

  $.fn.collapse.noConflict = function () {
    $.fn.collapse = old
    return this
  }


  // COLLAPSE DATA-API
  // =================

  $(document).on('click.bs.collapse.data-api', '[data-toggle="collapse"]', function (e) {
    var $this   = $(this)

    if (!$this.attr('data-target')) e.preventDefault()

    var $target = getTargetFromTrigger($this)
    var data    = $target.data('bs.collapse')
    var option  = data ? 'toggle' : $.extend({}, $this.data(), { trigger: this })

    Plugin.call($target, option)
  })

}(jQuery);

/* jqBootstrapValidation
 * A plugin for automating validation on Twitter Bootstrap formatted forms.
 * ATENCIÓN SE MODIFICA PLUGIN -- Linea 527
 *
 * v1.3.6
 *
 * License: MIT <http://opensource.org/licenses/mit-license.php> - see LICENSE file
 *
 * http://ReactiveRaven.github.com/jqBootstrapValidation/
 */

/*
  Modificaciones:
  #001: Comentada la línea:
                $controlGroup.removeClass("has-success");
        ** Para mantener la clase .has-succes al perder el foco
  y añadido:
                if( $this.attr("required") !== undefined && $this.val().length < 1 ) {
                  $this.closest('.form-group').addClass('has-error');
                } else {
                  $this.closest('.form-group').removeClass('has-error');
                }
  ** Para añadir o eliminar la clase .has-error en los campos requeridos
  
  #002: Comentada la línea:
              $controlGroup.removeClass("has-success");
        ** Para mantener la clase .has-succes al perder el foco

  ** Para mostrar el mensaje de error cuando se pierde el foco (además de mantener la clase .has-error)
  #003: añadidas las líneas
  if(!params && e.type === "blur") {
    params = {
      submitting: true
    };
  }
*/

(function( $ ){

	var createdElements = [];

	var defaults = {
		options: {
			prependExistingHelpBlock: false,
			sniffHtml: true, // sniff for 'required', 'maxlength', etc
			preventSubmit: true, // stop the form submit event from firing if validation fails
			submitError: false, // function called if there is an error when trying to submit
			submitSuccess: false, // function called just before a successful submit event is sent to the server
            semanticallyStrict: false, // set to true to tidy up generated HTML output
            bindEvents: 'default',
			autoAdd: {
				helpBlocks: true
			},
            filter: function () {
                return ($(this).is(":visible")) || (($(this).is('[type="checkbox"]'))); // only validate elements you can see
                return true; // validate everything
            }
		},
    methods: {
      init : function( options ) {

        var settings = $.extend(true, {}, defaults);

        settings.options = $.extend(true, settings.options, options);

        var $siblingElements = this;

        var uniqueForms = $.unique(
          $siblingElements.map( function () {
            return $(this).parents("form")[0];
          }).toArray()
        );

        $(uniqueForms).bind("submit", function (e) {
          var $form = $(this);
          var warningsFound = 0;
          var $inputs = $form.find("input,textarea,select").not("[type=submit],[type=image]").filter(settings.options.filter);
          $inputs.trigger("submit.validation").trigger("validationLostFocus.validation");

          $inputs.each(function (i, el) {
            var $this = $(el),
              $controlGroup = $this.parents(".form-group:not(.no-validate)").first();
            if (
              $controlGroup.hasClass("has-warning")
            ) {
              $controlGroup.removeClass("has-warning").addClass("has-error");
              warningsFound++;
            }
          });

          $inputs.trigger("validationLostFocus.validation");

          if (warningsFound) {
            if (settings.options.preventSubmit) {
              e.preventDefault();
            }
            $form.addClass("error");
            if ($.isFunction(settings.options.submitError)) {
              settings.options.submitError($form, e, $inputs.jqBootstrapValidation("collectErrors", true));
            }
          } else {
            $form.removeClass("error");
            if ($.isFunction(settings.options.submitSuccess)) {
              settings.options.submitSuccess($form, e);
            }
          }
        });

        return this.each(function(){

          // Get references to everything we're interested in
          var $this = $(this),
            $controlGroup = $this.parents(".form-group:not(.no-validate)").first(),
            $helpBlock = $controlGroup.find(".help-block").first(),
            $form = $this.parents("form").first(),
            validatorNames = [];

          // create message container if not exists
          if (!$helpBlock.length && settings.options.autoAdd && settings.options.autoAdd.helpBlocks) {
              $helpBlock = $('<div class="help-block" />');
              $controlGroup.find('.controls').append($helpBlock);
							createdElements.push($helpBlock[0]);
          }

          // =============================================================
          //                                     SNIFF HTML FOR VALIDATORS
          // =============================================================

          // *snort sniff snuffle*

          if (settings.options.sniffHtml) {
            var message = "";
            // ---------------------------------------------------------
            //                                                   PATTERN
            // ---------------------------------------------------------
            if ($this.attr("pattern") !== undefined) {
              message = "Not in the expected format<!-- data-validation-pattern-message to override -->";
              if ($this.data("validationPatternMessage")) {
                message = $this.data("validationPatternMessage");
              }
              $this.data("validationPatternMessage", message);
              $this.data("validationPatternRegex", $this.attr("pattern"));
            }
            // ---------------------------------------------------------
            //                                                       MAX
            // ---------------------------------------------------------
            if ($this.attr("max") !== undefined || $this.attr("aria-valuemax") !== undefined) {
              var max = ($this.attr("max") !== undefined ? $this.attr("max") : $this.attr("aria-valuemax"));
              message = "Too high: Maximum of '" + max + "'<!-- data-validation-max-message to override -->";
              if ($this.data("validationMaxMessage")) {
                message = $this.data("validationMaxMessage");
              }
              $this.data("validationMaxMessage", message);
              $this.data("validationMaxMax", max);
            }
            // ---------------------------------------------------------
            //                                                       MIN
            // ---------------------------------------------------------
            if ($this.attr("min") !== undefined || $this.attr("aria-valuemin") !== undefined) {
              var min = ($this.attr("min") !== undefined ? $this.attr("min") : $this.attr("aria-valuemin"));
              message = "Too low: Minimum of '" + min + "'<!-- data-validation-min-message to override -->";
              if ($this.data("validationMinMessage")) {
                message = $this.data("validationMinMessage");
              }
              $this.data("validationMinMessage", message);
              $this.data("validationMinMin", min);
            }
            // ---------------------------------------------------------
            //                                                 MAXLENGTH
            // ---------------------------------------------------------
            if ($this.attr("maxlength") !== undefined) {
              message = "Too long: Maximum of '" + $this.attr("maxlength") + "' characters<!-- data-validation-maxlength-message to override -->";
              if ($this.data("validationMaxlengthMessage")) {
                message = $this.data("validationMaxlengthMessage");
              }
              $this.data("validationMaxlengthMessage", message);
              $this.data("validationMaxlengthMaxlength", $this.attr("maxlength"));
            }
            // ---------------------------------------------------------
            //                                                 MINLENGTH
            // ---------------------------------------------------------
            if ($this.attr("minlength") !== undefined) {
              message = "Too short: Minimum of '" + $this.attr("minlength") + "' characters<!-- data-validation-minlength-message to override -->";
              if ($this.data("validationMinlengthMessage")) {
                message = $this.data("validationMinlengthMessage");
              }
              $this.data("validationMinlengthMessage", message);
              $this.data("validationMinlengthMinlength", $this.attr("minlength"));
            }
            // ---------------------------------------------------------
            //                                                  REQUIRED
            // ---------------------------------------------------------
            if ($this.attr("required") !== undefined || $this.attr("aria-required") !== undefined) {
              message = settings.builtInValidators.required.message;
              if ($this.data("validationRequiredMessage")) {
                message = $this.data("validationRequiredMessage");
              }
              $this.data("validationRequiredMessage", message);
            }
            // ---------------------------------------------------------
            //                                                    NUMBER
            // ---------------------------------------------------------
            if ($this.attr("type") !== undefined && $this.attr("type").toLowerCase() === "number") {
              message = settings.builtInValidators.number.message;
              if ($this.data("validationNumberMessage")) {
                message = $this.data("validationNumberMessage");
              }
              $this.data("validationNumberMessage", message);
            }
            // ---------------------------------------------------------
            //                                                     EMAIL
            // ---------------------------------------------------------
            if ($this.attr("type") !== undefined && $this.attr("type").toLowerCase() === "email") {
              message = "Not a valid email address<!-- data-validator-validemail-message to override -->";
              if ($this.data("validationValidemailMessage")) {
                message = $this.data("validationValidemailMessage");
              } else if ($this.data("validationEmailMessage")) {
                message = $this.data("validationEmailMessage");
              }
              $this.data("validationValidemailMessage", message);
            }
            // ---------------------------------------------------------
            //                                                MINCHECKED
            // ---------------------------------------------------------
            if ($this.attr("minchecked") !== undefined) {
              message = "Not enough options checked; Minimum of '" + $this.attr("minchecked") + "' required<!-- data-validation-minchecked-message to override -->";
              if ($this.data("validationMincheckedMessage")) {
                message = $this.data("validationMincheckedMessage");
              }
              $this.data("validationMincheckedMessage", message);
              $this.data("validationMincheckedMinchecked", $this.attr("minchecked"));
            }
            // ---------------------------------------------------------
            //                                                MAXCHECKED
            // ---------------------------------------------------------
            if ($this.attr("maxchecked") !== undefined) {
              message = "Too many options checked; Maximum of '" + $this.attr("maxchecked") + "' required<!-- data-validation-maxchecked-message to override -->";
              if ($this.data("validationMaxcheckedMessage")) {
                message = $this.data("validationMaxcheckedMessage");
              }
              $this.data("validationMaxcheckedMessage", message);
              $this.data("validationMaxcheckedMaxchecked", $this.attr("maxchecked"));
            }
          }

          // =============================================================
          //                                       COLLECT VALIDATOR NAMES
          // =============================================================

          // Get named validators
          if ($this.data("validation") !== undefined) {
            validatorNames = $this.data("validation").split(",");
          }

          // Get extra ones defined on the element's data attributes
          $.each($this.data(), function (i, el) {
            var parts = i.replace(/([A-Z])/g, ",$1").split(",");
            if (parts[0] === "validation" && parts[1]) {
              validatorNames.push(parts[1]);
            }
          });

          // =============================================================
          //                                     NORMALISE VALIDATOR NAMES
          // =============================================================

          var validatorNamesToInspect = validatorNames;
          var newValidatorNamesToInspect = [];

          do // repeatedly expand 'shortcut' validators into their real validators
          {
            // Uppercase only the first letter of each name
            $.each(validatorNames, function (i, el) {
              validatorNames[i] = formatValidatorName(el);
            });

            // Remove duplicate validator names
            validatorNames = $.unique(validatorNames);

            // Pull out the new validator names from each shortcut
            newValidatorNamesToInspect = [];
            $.each(validatorNamesToInspect, function(i, el) {
              if ($this.data("validation" + el + "Shortcut") !== undefined) {
                // Are these custom validators?
                // Pull them out!
                $.each($this.data("validation" + el + "Shortcut").split(","), function(i2, el2) {
                  newValidatorNamesToInspect.push(el2);
                });
              } else if (settings.builtInValidators[el.toLowerCase()]) {
                // Is this a recognised built-in?
                // Pull it out!
                var validator = settings.builtInValidators[el.toLowerCase()];
                if (validator.type.toLowerCase() === "shortcut") {
                  $.each(validator.shortcut.split(","), function (i, el) {
                    el = formatValidatorName(el);
                    newValidatorNamesToInspect.push(el);
                    validatorNames.push(el);
                  });
                }
              }
            });

            validatorNamesToInspect = newValidatorNamesToInspect;

          } while (validatorNamesToInspect.length > 0)

          // =============================================================
          //                                       SET UP VALIDATOR ARRAYS
          // =============================================================

          var validators = {};

          $.each(validatorNames, function (i, el) {
            // Set up the 'override' message
            var message = $this.data("validation" + el + "Message");
            var hasOverrideMessage = (message !== undefined);
            var foundValidator = false;
            message =
              (
                message
                  ? message
                  : "'" + el + "' validation failed <!-- Add attribute 'data-validation-" + el.toLowerCase() + "-message' to input to change this message -->"
              )
            ;

            $.each(
              settings.validatorTypes,
              function (validatorType, validatorTemplate) {
                if (validators[validatorType] === undefined) {
                  validators[validatorType] = [];
                }
                if (!foundValidator && $this.data("validation" + el + formatValidatorName(validatorTemplate.name)) !== undefined) {
                  validators[validatorType].push(
                    $.extend(
                      true,
                      {
                        name: formatValidatorName(validatorTemplate.name),
                        message: message
                      },
                      validatorTemplate.init($this, el)
                    )
                  );
                  foundValidator = true;
                }
              }
            );

            if (!foundValidator && settings.builtInValidators[el.toLowerCase()]) {

              var validator = $.extend(true, {}, settings.builtInValidators[el.toLowerCase()]);
              if (hasOverrideMessage) {
                validator.message = message;
              }
              var validatorType = validator.type.toLowerCase();

              if (validatorType === "shortcut") {
                foundValidator = true;
              } else {
                $.each(
                  settings.validatorTypes,
                  function (validatorTemplateType, validatorTemplate) {
                    if (validators[validatorTemplateType] === undefined) {
                      validators[validatorTemplateType] = [];
                    }
                    if (!foundValidator && validatorType === validatorTemplateType.toLowerCase()) {
                      $this.data("validation" + el + formatValidatorName(validatorTemplate.name), validator[validatorTemplate.name.toLowerCase()]);
                      validators[validatorType].push(
                        $.extend(
                          validator,
                          validatorTemplate.init($this, el)
                        )
                      );
                      foundValidator = true;
                    }
                  }
                );
              }
            }

            if (! foundValidator) {
              $.error("Cannot find validation info for '" + el + "'");
            }
          });

          // =============================================================
          //                                         STORE FALLBACK VALUES
          // =============================================================

          $helpBlock.data(
            "original-contents",
            (
              $helpBlock.data("original-contents")
                ? $helpBlock.data("original-contents")
                : $helpBlock.html()
            )
          );

          $helpBlock.data(
            "original-role",
            (
              $helpBlock.data("original-role")
                ? $helpBlock.data("original-role")
                : $helpBlock.attr("role")
            )
          );

          $controlGroup.data(
            "original-classes",
            (
              $controlGroup.data("original-clases")
                ? $controlGroup.data("original-classes")
                : $controlGroup.attr("class")
            )
          );

          $this.data(
            "original-aria-invalid",
            (
              $this.data("original-aria-invalid")
                ? $this.data("original-aria-invalid")
                : $this.attr("aria-invalid")
            )
          );

          // =============================================================
          //                                                    VALIDATION
          // =============================================================

          $this.bind(
            "validation.validation",
            function (event, params) {

              var value = getValue($this);

              // Get a list of the errors to apply
              var errorsFound = [];

              $.each(validators, function (validatorType, validatorTypeArray) {
                if (value || value.length || (params && params.includeEmpty) || (!!settings.validatorTypes[validatorType].blockSubmit && params && !!params.submitting)) {
                  $.each(validatorTypeArray, function (i, validator) {
                    if (settings.validatorTypes[validatorType].validate($this, value, validator)) {
                      errorsFound.push(validator.message);
                    }
                  });
                }
              });

              return errorsFound;
            }
          );

          $this.bind(
            "getValidators.validation",
            function () {
              return validators;
            }
          );

          // =============================================================
          //                                             WATCH FOR CHANGES
          // =============================================================
          $this.bind(
            "submit.validation",
            function () {
              return $this.triggerHandler("change.validation", {submitting: true});
            }
          );
          
          if( settings.options.bindEvents=="default") {
			var events = [
				"keyup",
				"focus",
				"blur",
				"click",
				"keydown",
				"keypress",
				"change"
			];
          } else {
	          var events = settings.options.bindEvents;
          }
          

          $this.bind(
            events.join(".validation ") + ".validation",
            function (e, params) {

              var value = getValue($this);

              var errorsFound = [];

              // Modificado a partir de aquí #003
              if(!params && e.type === "blur") {
                params = {
                  submitting: true
                };
              }
              // Modificado hasta aquí #003

              $controlGroup.find("input,textarea,select").each(function (i, el) {
                var oldCount = errorsFound.length;
                $.each($(el).triggerHandler("validation.validation", params), function (j, message) {
                  errorsFound.push(message);
                });
                if (errorsFound.length > oldCount) {
                  $(el).attr("aria-invalid", "true");
                } else {
                  var original = $this.data("original-aria-invalid");
                  $(el).attr("aria-invalid", (original !== undefined ? original : false));
                }
              });

              $form.find("input,select,textarea").not($this).not("[name=\"" + $this.attr("name") + "\"]").trigger("validationLostFocus.validation");

              errorsFound = $.unique(errorsFound.sort());

              // Were there any errors?
              if (errorsFound.length) {
                // Better flag it up as a warning.
                $controlGroup.removeClass("has-success has-error").addClass("has-warning");

                // How many errors did we find?
                if (settings.options.semanticallyStrict && errorsFound.length === 1) {
                  // Only one? Being strict? Just output it.
                  $helpBlock.html(errorsFound[0] + 
                    ( settings.options.prependExistingHelpBlock ? $helpBlock.data("original-contents") : "" ));
                } else {
                  // Multiple? Being sloppy? Glue them together into an UL.
                  $helpBlock.html("<ul role=\"alert\"><li>" + errorsFound.join("</li><li>") + "</li></ul>" +
                    ( settings.options.prependExistingHelpBlock ? $helpBlock.data("original-contents") : "" ));
                }
              } else {
                $controlGroup.removeClass("has-warning has-error has-success");
                if (value.length > 0) {
                  $controlGroup.addClass("has-success");
                }
                $helpBlock.html($helpBlock.data("original-contents"));
              }

              if (e.type === "blur") {
                // Modificado a partir de aquí #001

                // $controlGroup.removeClass("has-success");
                if( $this.attr("required") !== undefined && $this.val().length < 1 ) {
                  $this.closest('.form-group').addClass('has-error');
                } else {
                  $this.closest('.form-group').removeClass('has-error');

                // Modificado hasta aquí #001
                }
              }
            }
          );
          $this.bind("validationLostFocus.validation", function () {
            // Modificado a partir de aquí #002
            // $controlGroup.removeClass("has-success");
            // Modificado hasta aquí #002
          });
        });
      },
      destroy : function( ) {

        return this.each(
          function() {

            var
              $this = $(this),
              $controlGroup = $this.parents(".form-group:not(.no-validate)").first(),
              $helpBlock = $controlGroup.find(".help-block").first();
              
              //ADN modification
             $(this.form).unbind("submit");

            // remove our events
            $this.unbind('.validation'); // events are namespaced.
            // reset help text
            $helpBlock.html($helpBlock.data("original-contents"));
            // reset classes
            $controlGroup.attr("class", $controlGroup.data("original-classes"));
            // reset aria
            $this.attr("aria-invalid", $this.data("original-aria-invalid"));
            // reset role
            $helpBlock.attr("role", $this.data("original-role"));
						// remove all elements we created
						if (createdElements.indexOf($helpBlock[0]) > -1) {
							$helpBlock.remove();
						}

          }
        );

      },
      collectErrors : function(includeEmpty) {

        var errorMessages = {};
        this.each(function (i, el) {
          var $el = $(el);
          var name = $el.attr("name");
          var errors = $el.triggerHandler("validation.validation", {includeEmpty: true});
          errorMessages[name] = $.extend(true, errors, errorMessages[name]);
        });

        $.each(errorMessages, function (i, el) {
          if (el.length === 0) {
            delete errorMessages[i];
          }
        });

        return errorMessages;

      },
      hasErrors: function() {

        var errorMessages = [];

        this.each(function (i, el) {
          errorMessages = errorMessages.concat(
            $(el).triggerHandler("getValidators.validation") ? $(el).triggerHandler("validation.validation", {submitting: true}) : []
          );
        });

        return (errorMessages.length > 0);
      },
      override : function (newDefaults) {
        defaults = $.extend(true, defaults, newDefaults);
      }
    },
		validatorTypes: {
      callback: {
        name: "callback",
        init: function ($this, name) {
          return {
            validatorName: name,
            callback: $this.data("validation" + name + "Callback"),
            lastValue: $this.val(),
            lastValid: true,
            lastFinished: true
          };
        },
        validate: function ($this, value, validator) {
          if (validator.lastValue === value && validator.lastFinished) {
            return !validator.lastValid;
          }

          if (validator.lastFinished === true)
          {
            validator.lastValue = value;
            validator.lastValid = true;
            validator.lastFinished = false;

            var rrjqbvValidator = validator;
            var rrjqbvThis = $this;
            executeFunctionByName(
              validator.callback,
              window,
              $this,
              value,
              function (data) {
                if (rrjqbvValidator.lastValue === data.value) {
                  rrjqbvValidator.lastValid = data.valid;
                  if (data.message) {
                    rrjqbvValidator.message = data.message;
                  }
                  rrjqbvValidator.lastFinished = true;
                  rrjqbvThis.data("validation" + rrjqbvValidator.validatorName + "Message", rrjqbvValidator.message);
                  // Timeout is set to avoid problems with the events being considered 'already fired'
                  setTimeout(function () {
                    rrjqbvThis.trigger("change.validation");
                  }, 1); // doesn't need a long timeout, just long enough for the event bubble to burst
                }
              }
            );
          }

          return false;

        }
      },
      ajax: {
        name: "ajax",
        init: function ($this, name) {
          return {
            validatorName: name,
            url: $this.data("validation" + name + "Ajax"),
            lastValue: $this.val(),
            lastValid: true,
            lastFinished: true
          };
        },
        validate: function ($this, value, validator) {
          if (""+validator.lastValue === ""+value && validator.lastFinished === true) {
            return validator.lastValid === false;
          }

          if (validator.lastFinished === true)
          {
            validator.lastValue = value;
            validator.lastValid = true;
            validator.lastFinished = false;
            $.ajax({
              url: validator.url,
              data: "value=" + value + "&field=" + $this.attr("name"),
              dataType: "json",
              success: function (data) {
                if (""+validator.lastValue === ""+data.value) {
                  validator.lastValid = !!(data.valid);
                  if (data.message) {
                    validator.message = data.message;
                  }
                  validator.lastFinished = true;
                  $this.data("validation" + validator.validatorName + "Message", validator.message);
                  // Timeout is set to avoid problems with the events being considered 'already fired'
                  setTimeout(function () {
                    $this.trigger("change.validation");
                  }, 1); // doesn't need a long timeout, just long enough for the event bubble to burst
                }
              },
              failure: function () {
                validator.lastValid = true;
                validator.message = "ajax call failed";
                validator.lastFinished = true;
                $this.data("validation" + validator.validatorName + "Message", validator.message);
                // Timeout is set to avoid problems with the events being considered 'already fired'
                setTimeout(function () {
                  $this.trigger("change.validation");
                }, 1); // doesn't need a long timeout, just long enough for the event bubble to burst
              }
            });
          }

          return false;

        }
      },
			regex: {
				name: "regex",
				init: function ($this, name) {
					return {regex: regexFromString($this.data("validation" + name + "Regex"))};
				},
				validate: function ($this, value, validator) {
					return (!validator.regex.test(value) && ! validator.negative)
						|| (validator.regex.test(value) && validator.negative);
				}
			},
			required: {
				name: "required",
				init: function ($this, name) {
					return {};
				},
				validate: function ($this, value, validator) {
					return !!(value.length === 0  && ! validator.negative)
						|| !!(value.length > 0 && validator.negative);
				},
        blockSubmit: true
			},
			match: {
				name: "match",
				init: function ($this, name) {
					var element = $this.parents("form").first().find("[name=\"" + $this.data("validation" + name + "Match") + "\"]").first();
					element.bind("validation.validation", function () {
						//$this.trigger("change.validation", {submitting: true});
					});
					return {"element": element};
				},
				validate: function ($this, value, validator) {
					return (value !== validator.element.val() && ! validator.negative)
						|| (value === validator.element.val() && validator.negative);
				},
        blockSubmit: true
			},
			max: {
				name: "max",
				init: function ($this, name) {
					return {max: $this.data("validation" + name + "Max")};
				},
				validate: function ($this, value, validator) {
					return (parseFloat(value, 10) > parseFloat(validator.max, 10) && ! validator.negative)
						|| (parseFloat(value, 10) <= parseFloat(validator.max, 10) && validator.negative);
				}
			},
			min: {
				name: "min",
				init: function ($this, name) {
					return {min: $this.data("validation" + name + "Min")};
				},
				validate: function ($this, value, validator) {
					return (parseFloat(value) < parseFloat(validator.min) && ! validator.negative)
						|| (parseFloat(value) >= parseFloat(validator.min) && validator.negative);
				}
			},
			maxlength: {
				name: "maxlength",
				init: function ($this, name) {
					return {maxlength: $this.data("validation" + name + "Maxlength")};
				},
				validate: function ($this, value, validator) {
					return ((value.length > validator.maxlength) && ! validator.negative)
						|| ((value.length <= validator.maxlength) && validator.negative);
				}
			},
			minlength: {
				name: "minlength",
				init: function ($this, name) {
					return {minlength: $this.data("validation" + name + "Minlength")};
				},
				validate: function ($this, value, validator) {
					return ((value.length < validator.minlength) && ! validator.negative)
						|| ((value.length >= validator.minlength) && validator.negative);
				}
			},
			maxchecked: {
				name: "maxchecked",
				init: function ($this, name) {
					var elements = $this.parents("form").first().find("[name=\"" + $this.attr("name") + "\"]");
					elements.bind("click.validation", function () {
						$this.trigger("change.validation", {includeEmpty: true});
					});
					return {maxchecked: $this.data("validation" + name + "Maxchecked"), elements: elements};
				},
				validate: function ($this, value, validator) {
					return (validator.elements.filter(":checked").length > validator.maxchecked && ! validator.negative)
						|| (validator.elements.filter(":checked").length <= validator.maxchecked && validator.negative);
				},
        blockSubmit: true
			},
			minchecked: {
				name: "minchecked",
				init: function ($this, name) {
					var elements = $this.parents("form").first().find("[name=\"" + $this.attr("name") + "\"]");
					elements.bind("click.validation", function () {
						$this.trigger("change.validation", {includeEmpty: true});
					});
					return {minchecked: $this.data("validation" + name + "Minchecked"), elements: elements};
				},
				validate: function ($this, value, validator) {
					return (validator.elements.filter(":checked").length < validator.minchecked && ! validator.negative)
						|| (validator.elements.filter(":checked").length >= validator.minchecked && validator.negative);
				},
        blockSubmit: true
			}
		},
		builtInValidators: {
			email: {
				name: "Email",
				type: "shortcut",
				shortcut: "validemail"
			},
			validemail: {
				name: "Validemail",
				type: "regex",
				regex: "[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\\.[A-Za-z]{2,4}",
				message: "Not a valid email address<!-- data-validator-validemail-message to override -->"
			},
			passwordagain: {
				name: "Passwordagain",
				type: "match",
				match: "password",
				message: "Does not match the given password<!-- data-validator-paswordagain-message to override -->"
			},
			positive: {
				name: "Positive",
				type: "shortcut",
				shortcut: "number,positivenumber"
			},
			negative: {
				name: "Negative",
				type: "shortcut",
				shortcut: "number,negativenumber"
			},
			number: {
				name: "Number",
				type: "regex",
				regex: "([+-]?\\\d+(\\\.\\\d*)?([eE][+-]?[0-9]+)?)?",
				message: "Must be a number<!-- data-validator-number-message to override -->"
			},
			integer: {
				name: "Integer",
				type: "regex",
				regex: "[+-]?\\\d+",
				message: "No decimal places allowed<!-- data-validator-integer-message to override -->"
			},
			positivenumber: {
				name: "Positivenumber",
				type: "min",
				min: 0,
				message: "Must be a positive number<!-- data-validator-positivenumber-message to override -->"
			},
			negativenumber: {
				name: "Negativenumber",
				type: "max",
				max: 0,
				message: "Must be a negative number<!-- data-validator-negativenumber-message to override -->"
			},
			required: {
				name: "Required",
				type: "required",
				message: "This is required<!-- data-validator-required-message to override -->"
			},
			checkone: {
				name: "Checkone",
				type: "minchecked",
				minchecked: 1,
				message: "Check at least one option<!-- data-validation-checkone-message to override -->"
			}
		}
	};

	var formatValidatorName = function (name) {
		return name
			.toLowerCase()
			.replace(
				/(^|\s)([a-z])/g ,
				function(m,p1,p2) {
					return p1+p2.toUpperCase();
				}
			)
		;
	};

	var getValue = function ($this) {
		// Extract the value we're talking about
		var value = $this.val();
		var type = $this.attr("type");
		if (type === "checkbox") {
			value = ($this.is(":checked") ? value : "");
		}
		if (type === "radio") {
			value = ($('input[name="' + $this.attr("name") + '"]:checked').length > 0 ? value : "");
		}
		return value;
	};

  function regexFromString(inputstring) {
		return new RegExp("^" + inputstring + "$");
	}

  /**
   * Thanks to Jason Bunting via StackOverflow.com
   *
   * http://stackoverflow.com/questions/359788/how-to-execute-a-javascript-function-when-i-have-its-name-as-a-string#answer-359910
   * Short link: http://tinyurl.com/executeFunctionByName
  **/
  function executeFunctionByName(functionName, context /*, args*/) {
    var args = Array.prototype.slice.call(arguments).splice(2);
    var namespaces = functionName.split(".");
    var func = namespaces.pop();
    for(var i = 0; i < namespaces.length; i++) {
      context = context[namespaces[i]];
    }
    return context[func].apply(this, args);
  }

	$.fn.jqBootstrapValidation = function( method ) {

		if ( defaults.methods[method] ) {
			return defaults.methods[method].apply( this, Array.prototype.slice.call( arguments, 1 ));
		} else if ( typeof method === 'object' || ! method ) {
			return defaults.methods.init.apply( this, arguments );
		} else {
		$.error( 'Method ' +  method + ' does not exist on jQuery.jqBootstrapValidation' );
			return null;
		}

	};

  $.jqBootstrapValidation = function (options) {
    $(":input").not("[type=image],[type=submit]").jqBootstrapValidation.apply(this,arguments);
  };

})( jQuery );

/* ========================================================================
 * Bootstrap (plugin): validator.js v0.11.9
 * ========================================================================
 * The MIT License (MIT)
 *
 * Copyright (c) 2016 Cina Saffary.
 * Made by @1000hz in the style of Bootstrap 3 era @fat
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * ======================================================================== */


+function ($) {
  'use strict';

  // VALIDATOR CLASS DEFINITION
  // ==========================

  function getValue($el) {
    return $el.is('[type="checkbox"]') ? $el.prop('checked')                                     :
           $el.is('[type="radio"]')    ? !!$('[name="' + $el.attr('name') + '"]:checked').length :
           $el.is('select[multiple]')  ? ($el.val() || []).length                                :
                                         $el.val()
  }

  var Validator = function (element, options) {
    this.options    = options
    this.validators = $.extend({}, Validator.VALIDATORS, options.custom)
    this.$element   = $(element)
    this.$btn       = $('button[type="submit"], input[type="submit"]')
                        .filter('[form="' + this.$element.attr('id') + '"]')
                        .add(this.$element.find('input[type="submit"], button[type="submit"]'))

    this.update()

    this.$element.on('input.bs.validator change.bs.validator focusout.bs.validator', $.proxy(this.onInput, this))
    this.$element.on('submit.bs.validator', $.proxy(this.onSubmit, this))
    this.$element.on('reset.bs.validator', $.proxy(this.reset, this))

    this.$element.find('[data-match]').each(function () {
      var $this  = $(this)
      var target = $this.attr('data-match')

      $(target).on('input.bs.validator', function (e) {
        getValue($this) && $this.trigger('input.bs.validator')
      })
    })

    // run validators for fields with values, but don't clobber server-side errors
    this.$inputs.filter(function () {
      return getValue($(this)) && !$(this).closest('.has-error').length
    }).trigger('focusout')

    this.$element.attr('novalidate', true) // disable automatic native validation
  }

  Validator.VERSION = '0.11.9'

  Validator.INPUT_SELECTOR = ':input:not([type="hidden"], [type="submit"], [type="reset"], button)'

  Validator.FOCUS_OFFSET = 20

  Validator.DEFAULTS = {
    delay: 500,
    html: false,
    disable: true,
    focus: true,
    custom: {},
    errors: {
      match: 'Does not match',
      minlength: 'Not long enough'
    },
    feedback: {
      success: 'glyphicon-ok',
      error: 'glyphicon-remove'
    }
  }

  Validator.VALIDATORS = {
    'native': function ($el) {
      var el = $el[0]
      if (el.checkValidity) {
        return !el.checkValidity() && !el.validity.valid && (el.validationMessage || "error!")
      }
    },
    'match': function ($el) {
      var target = $el.attr('data-match')
      return $el.val() !== $(target).val() && Validator.DEFAULTS.errors.match
    },
    'minlength': function ($el) {
      var minlength = $el.attr('data-minlength')
      return $el.val().length < minlength && Validator.DEFAULTS.errors.minlength
    }
  }

  Validator.prototype.update = function () {
    var self = this

    this.$inputs = this.$element.find(Validator.INPUT_SELECTOR)
      .add(this.$element.find('[data-validate="true"]'))
      .not(this.$element.find('[data-validate="false"]')
        .each(function () { self.clearErrors($(this)) })
      )

    this.toggleSubmit()

    return this
  }

  Validator.prototype.onInput = function (e) {
    var self        = this
    var $el         = $(e.target)
    var deferErrors = e.type !== 'focusout'

    if (!this.$inputs.is($el)) return

    this.validateInput($el, deferErrors).done(function () {
      self.toggleSubmit()
    })
  }

  Validator.prototype.validateInput = function ($el, deferErrors) {
    var value      = getValue($el)
    var prevErrors = $el.data('bs.validator.errors')

    if ($el.is('[type="radio"]')) $el = this.$element.find('input[name="' + $el.attr('name') + '"]')

    var e = $.Event('validate.bs.validator', {relatedTarget: $el[0]})
    this.$element.trigger(e)
    if (e.isDefaultPrevented()) return

    var self = this

    return this.runValidators($el).done(function (errors) {
      $el.data('bs.validator.errors', errors)

      errors.length
        ? deferErrors ? self.defer($el, self.showErrors) : self.showErrors($el)
        : self.clearErrors($el)

      if (!prevErrors || errors.toString() !== prevErrors.toString()) {
        e = errors.length
          ? $.Event('invalid.bs.validator', {relatedTarget: $el[0], detail: errors})
          : $.Event('valid.bs.validator', {relatedTarget: $el[0], detail: prevErrors})

        self.$element.trigger(e)
      }

      self.toggleSubmit()

      self.$element.trigger($.Event('validated.bs.validator', {relatedTarget: $el[0]}))
    })
  }


  Validator.prototype.runValidators = function ($el) {
    var errors   = []
    var deferred = $.Deferred()

    $el.data('bs.validator.deferred') && $el.data('bs.validator.deferred').reject()
    $el.data('bs.validator.deferred', deferred)

    function getValidatorSpecificError(key) {
      return $el.attr('data-' + key + '-error')
    }

    function getValidityStateError() {
      var validity = $el[0].validity
      return validity.typeMismatch    ? $el.attr('data-type-error')
           : validity.patternMismatch ? $el.attr('data-pattern-error')
           : validity.stepMismatch    ? $el.attr('data-step-error')
           : validity.rangeOverflow   ? $el.attr('data-max-error')
           : validity.rangeUnderflow  ? $el.attr('data-min-error')
           : validity.valueMissing    ? $el.attr('data-required-error')
           :                            null
    }

    function getGenericError() {
      return $el.attr('data-error')
    }

    function getErrorMessage(key) {
      return getValidatorSpecificError(key)
          || getValidityStateError()
          || getGenericError()
    }

    $.each(this.validators, $.proxy(function (key, validator) {
      var error = null
      var value = getValue($el);
      if ((value == '' || value || $el.attr('required')) &&
      //if ((getValue($el) || $el.attr('required')) &&
          ($el.attr('data-' + key) !== undefined || key == 'native') &&
          (error = validator.call(this, $el))) {
         error = getErrorMessage(key) || error
        !~errors.indexOf(error) && errors.push(error)
      }
    }, this))

    if (!errors.length && getValue($el) && $el.attr('data-remote')) {
      this.defer($el, function () {
        var data = {}
        data[$el.attr('name')] = getValue($el)
        $.get($el.attr('data-remote'), data)
          .fail(function (jqXHR, textStatus, error) { errors.push(getErrorMessage('remote') || error) })
          .always(function () { deferred.resolve(errors)})
      })
    } else deferred.resolve(errors)

    return deferred.promise()
  }

  Validator.prototype.validate = function () {
    var self = this

    $.when(this.$inputs.map(function (el) {
      return self.validateInput($(this), false)
    })).then(function () {
      self.toggleSubmit()
      self.focusError()
    })

    return this
  }

  Validator.prototype.focusError = function () {
    if (!this.options.focus) return

    var $input = this.$element.find(".has-error :input:first")
    if ($input.length === 0) return

    $('html, body').animate({scrollTop: $input.offset().top - Validator.FOCUS_OFFSET}, 250)
    $input.focus()
  }

  Validator.prototype.showErrors = function ($el) {
    var method = this.options.html ? 'html' : 'text'
    var errors = $el.data('bs.validator.errors')
    var $group = $el.closest('.form-group')
    var $block = $group.find('.help-block.with-errors')
    var $feedback = $group.find('.form-control-feedback')

    if (!errors.length) return

    errors = $('<ul/>')
      .addClass('list-unstyled')
      .append($.map(errors, function (error) { return $('<li/>')[method](error) }))

    $block.data('bs.validator.originalContent') === undefined && $block.data('bs.validator.originalContent', $block.html())
    $block.empty().append(errors)
    $group.addClass('has-error has-danger')

    $group.hasClass('has-feedback')
      && $feedback.removeClass(this.options.feedback.success)
      && $feedback.addClass(this.options.feedback.error)
      && $group.removeClass('has-success')
  }

  Validator.prototype.clearErrors = function ($el) {
    var $group = $el.closest('.form-group')
    var $block = $group.find('.help-block.with-errors')
    var $feedback = $group.find('.form-control-feedback')

    $block.html($block.data('bs.validator.originalContent'))
    $group.removeClass('has-error has-danger has-success')

    $group.hasClass('has-feedback')
      && $feedback.removeClass(this.options.feedback.error)
      && $feedback.removeClass(this.options.feedback.success)
      && getValue($el)
      && $feedback.addClass(this.options.feedback.success)
      && $group.addClass('has-success')
  }

  Validator.prototype.hasErrors = function () {
    function fieldErrors() {
      return !!($(this).data('bs.validator.errors') || []).length
    }

    return !!this.$inputs.filter(fieldErrors).length
  }

  Validator.prototype.isIncomplete = function () {
    function fieldIncomplete() {
      var value = getValue($(this))
      return !(typeof value == "string" ? $.trim(value) : value)
    }

    return !!this.$inputs.filter('[required]').filter(fieldIncomplete).length
  }

  Validator.prototype.onSubmit = function (e) {
    this.validate()
    if (this.isIncomplete() || this.hasErrors()) e.preventDefault()
  }

  Validator.prototype.toggleSubmit = function () {
    if (!this.options.disable) return
    this.$btn.toggleClass('disabled', this.isIncomplete() || this.hasErrors())
  }

  Validator.prototype.defer = function ($el, callback) {
    callback = $.proxy(callback, this, $el)
    if (!this.options.delay) return callback()
    window.clearTimeout($el.data('bs.validator.timeout'))
    $el.data('bs.validator.timeout', window.setTimeout(callback, this.options.delay))
  }

  Validator.prototype.reset = function () {
    this.$element.find('.form-control-feedback')
      .removeClass(this.options.feedback.error)
      .removeClass(this.options.feedback.success)

    this.$inputs
      .removeData(['bs.validator.errors', 'bs.validator.deferred'])
      .each(function () {
        var $this = $(this)
        var timeout = $this.data('bs.validator.timeout')
        window.clearTimeout(timeout) && $this.removeData('bs.validator.timeout')
      })

    this.$element.find('.help-block.with-errors')
      .each(function () {
        var $this = $(this)
        var originalContent = $this.data('bs.validator.originalContent')

        $this
          .removeData('bs.validator.originalContent')
          .html(originalContent)
      })

    this.$btn.removeClass('disabled')

    this.$element.find('.has-error, .has-danger, .has-success').removeClass('has-error has-danger has-success')

    return this
  }

  Validator.prototype.destroy = function () {
    this.reset()

    this.$element
      .removeAttr('novalidate')
      .removeData('bs.validator')
      .off('.bs.validator')

    this.$inputs
      .off('.bs.validator')

    this.options    = null
    this.validators = null
    this.$element   = null
    this.$btn       = null
    this.$inputs    = null

    return this
  }

  // VALIDATOR PLUGIN DEFINITION
  // ===========================


  function Plugin(option) {
    return this.each(function () {
      var $this   = $(this)
      var options = $.extend({}, Validator.DEFAULTS, $this.data(), typeof option == 'object' && option)
      var data    = $this.data('bs.validator')

      if (!data && option == 'destroy') return
      if (!data) $this.data('bs.validator', (data = new Validator(this, options)))
      if (typeof option == 'string') data[option]()
    })
  }

  var old = $.fn.validator

  $.fn.validator             = Plugin
  $.fn.validator.Constructor = Validator


  // VALIDATOR NO CONFLICT
  // =====================

  $.fn.validator.noConflict = function () {
    $.fn.validator = old
    return this
  }


  // VALIDATOR DATA-API
  // ==================

  $(window).on('load', function () {
    $('form[data-toggle="validator"]').each(function () {
      var $form = $(this)
      Plugin.call($form, $form.data())
    })
  })

}(jQuery);

/**
* @fileoverview dragscroll - scroll area by dragging
* @version 0.0.8
* 
* @license MIT, see http://github.com/asvd/dragscroll
* @copyright 2015 asvd <heliosframework@gmail.com> 
*/


(function (root, factory) {
  root = root || window;
  if (typeof define === 'function' && define.amd) {
      define(['exports'], factory);
  } else if (typeof exports !== 'undefined') {
      factory(exports);
  } else {
      factory((root.dragscroll = {}));
  }
}(this, function (exports) {
  var _window = window;
  var _document = document;
  var mousemove = 'mousemove';
  var mouseup = 'mouseup';
  var mousedown = 'mousedown';
  var EventListener = 'EventListener';
  var addEventListener = 'add'+EventListener;
  var removeEventListener = 'remove'+EventListener;
  var newScrollX, newScrollY;

  var dragged = [];
  var reset = function(i, el) {
      for (i = 0; i < dragged.length;) {
          el = dragged[i++];
          el = el.container || el;
          el[removeEventListener](mousedown, el.md, 0);
          _window[removeEventListener](mouseup, el.mu, 0);
          _window[removeEventListener](mousemove, el.mm, 0);
      }

      // cloning into array since HTMLCollection is updated dynamically
      dragged = [].slice.call(_document.getElementsByClassName('dragscroll'));
      for (i = 0; i < dragged.length;) {
          (function(el, lastClientX, lastClientY, pushed, scroller, cont){
              (cont = el.container || el)[addEventListener](
                  mousedown,
                  cont.md = function(e) {
                      if (!el.hasAttribute('nochilddrag') ||
                          _document.elementFromPoint(
                              e.pageX, e.pageY
                          ) == cont
                      ) {
                          pushed = 1;
                          lastClientX = e.clientX;
                          lastClientY = e.clientY;

                          e.preventDefault();
                      }
                  }, 0
              );

              _window[addEventListener](
                  mouseup, cont.mu = function() {
                    pushed = 0;
                    setTimeout(function() {
                      el.setAttribute("data-scrolling", false);
                    }, 200);
                  }, 0
              );

              _window[addEventListener](
                  mousemove,
                  cont.mm = function(e) {
                    
                      if (pushed) {
                          (scroller = el.scroller||el).scrollLeft -=
                              newScrollX = (- lastClientX + (lastClientX=e.clientX));
                          scroller.scrollTop -=
                              newScrollY = (- lastClientY + (lastClientY=e.clientY));
                          if (el == _document.body) {
                              (scroller = _document.documentElement).scrollLeft -= newScrollX;
                              scroller.scrollTop -= newScrollY;
                          }

                          if(Math.abs(newScrollX) > 10) {
                            el.setAttribute("data-scrolling", true);
                          }
                      }
                  }, 0
              );
           })(dragged[i++]);
      }
  }

    
  if (_document.readyState == 'complete') {
      reset();
  } else {
      _window[addEventListener]('load', reset, 0);
  }

  exports.reset = reset;
}));
;(function($) {
 
  /**
  * @description Paginates displayed info by hidding/showing children of the provided selector

  * @param {number}  itemsPerPage    - number of items to show per page
  * @param {boolean} showPrevNext    - Show the Previous and/or Next arrow icons
  * @param {boolean} hidePageNumbers - Hides the numer of the page
  * @param {string} paginateElement  - selector of the element to be paginated (contains the items)
  * @param {string} prevLinkText     - text to apply to prev page button
  * @param {string} nextLinkText     - text to apply to next page button
  */
  $.inputFilter = function(element, options) { 
    var defaults = {
      type: null
    };
    var filters = {
      number: /^[0-9]*$/i,
      letters: /^[a-z]*$/i,
      positive: /^\d*$/
    };
    var plugin = this;

    var $element = $(element),
        element = element;



    plugin.settings = {};

    plugin.init = function() {
      plugin.settings = $.extend({}, defaults, options);
      if(plugin.settings.type) {
        $element.on("input keydown keyup mousedown mouseup select contextmenu drop", function(ev) {
          if(filters[plugin.settings.type].test(this.value)) {
            this.oldValue = this.value;
            this.oldSelectionStart = this.selectionStart;
            this.oldSelectionEnd = this.selectionEnd;
          } else {
            this.value = this.oldValue;
            this.setSelectionRange(this.oldSelectionStart, this.oldSelectionEnd);
          }
        });
      }
    };

    plugin.init();
  };
 
  $.fn.inputFilter = function(options) {
    return this.each(function() {
      if (undefined == $(this).data('inputFilter')) {
        var plugin = new $.inputFilter(this, options);
        $(this).data('inputFilter', plugin);
      }
    });
  };

  //esto es para inicializar elementos con paginación automaticamente. Solo se da un caso en el dxa-uikit.
  //globalConfig.elements.$paginateElements.paginateMe();
  $(".js-only-numbers").inputFilter({type:"number"});
 
})(jQuery);
/*!
 * jQuery & Zepto Lazy - v1.7.10
 * http://jquery.eisbehr.de/lazy/
 *
 * Copyright 2012 - 2018, Daniel 'Eisbehr' Kern
 *
 * Dual licensed under the MIT and GPL-2.0 licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl-2.0.html
 *
 * $("img.lazy").lazy();
 */

;(function(window, undefined) {
    "use strict";

    // noinspection JSUnresolvedVariable
    /**
     * library instance - here and not in construct to be shorter in minimization
     * @return void
     */
    var $ = window.jQuery || window.Zepto,

    /**
     * unique plugin instance id counter
     * @type {number}
     */
    lazyInstanceId = 0,

    /**
     * helper to register window load for jQuery 3
     * @type {boolean}
     */    
    windowLoaded = false;

    /**
     * make lazy available to jquery - and make it a bit more case-insensitive :)
     * @access public
     * @type {function}
     * @param {object} settings
     * @return {LazyPlugin}
     */
    $.fn.Lazy = $.fn.lazy = function(settings) {
        return new LazyPlugin(this, settings);
    };

    /**
     * helper to add plugins to lazy prototype configuration
     * @access public
     * @type {function}
     * @param {string|Array} names
     * @param {string|Array|function} [elements]
     * @param {function} loader
     * @return void
     */
    $.Lazy = $.lazy = function(names, elements, loader) {
        // make second parameter optional
        if ($.isFunction(elements)) {
            loader = elements;
            elements = [];
        }

        // exit here if parameter is not a callable function
        if (!$.isFunction(loader)) {
            return;
        }

        // make parameters an array of names to be sure
        names = $.isArray(names) ? names : [names];
        elements = $.isArray(elements) ? elements : [elements];

        var config = LazyPlugin.prototype.config,
            forced = config._f || (config._f = {});

        // add the loader plugin for every name
        for (var i = 0, l = names.length; i < l; i++) {
            if (config[names[i]] === undefined || $.isFunction(config[names[i]])) {
                config[names[i]] = loader;
            }
        }

        // add forced elements loader
        for (var c = 0, a = elements.length; c < a; c++) {
            forced[elements[c]] = names[0];
        }
    };

    /**
     * contains all logic and the whole element handling
     * is packed in a private function outside class to reduce memory usage, because it will not be created on every plugin instance
     * @access private
     * @type {function}
     * @param {LazyPlugin} instance
     * @param {object} config
     * @param {object|Array} items
     * @param {object} events
     * @param {string} namespace
     * @return void
     */
    function _executeLazy(instance, config, items, events, namespace) {
        /**
         * a helper to trigger the 'onFinishedAll' callback after all other events
         * @access private
         * @type {number}
         */
        var _awaitingAfterLoad = 0,

        /**
         * visible content width
         * @access private
         * @type {number}
         */
        _actualWidth = -1,

        /**
         * visible content height
         * @access private
         * @type {number}
         */
        _actualHeight = -1,

        /**
         * determine possibly detected high pixel density
         * @access private
         * @type {boolean}
         */
        _isRetinaDisplay = false, 

        /**
         * dictionary entry for better minimization
         * @access private
         * @type {string}
         */
        _afterLoad = 'afterLoad',

        /**
         * dictionary entry for better minimization
         * @access private
         * @type {string}
         */
        _load = 'load',

        /**
         * dictionary entry for better minimization
         * @access private
         * @type {string}
         */
        _error = 'error',

        /**
         * dictionary entry for better minimization
         * @access private
         * @type {string}
         */
        _img = 'img',

        /**
         * dictionary entry for better minimization
         * @access private
         * @type {string}
         */
        _src = 'src',

        /**
         * dictionary entry for better minimization
         * @access private
         * @type {string}
         */
        _srcset = 'srcset',

        /**
         * dictionary entry for better minimization
         * @access private
         * @type {string}
         */
        _sizes = 'sizes',

        /**
         * dictionary entry for better minimization
         * @access private
         * @type {string}
         */
        _backgroundImage = 'background-image';

        /**
         * initialize plugin
         * bind loading to events or set delay time to load all items at once
         * @access private
         * @return void
         */
        function _initialize() {
            // detect actual device pixel ratio
            // noinspection JSUnresolvedVariable
            _isRetinaDisplay = window.devicePixelRatio > 1;

            // prepare all initial items
            items = _prepareItems(items);

            // if delay time is set load all items at once after delay time
            if (config.delay >= 0) {
                setTimeout(function() {
                    _lazyLoadItems(true);
                }, config.delay);
            }

            // if no delay is set or combine usage is active bind events
            if (config.delay < 0 || config.combined) {
                // create unique event function
                events.e = _throttle(config.throttle, function(event) {
                    // reset detected window size on resize event
                    if (event.type === 'resize') {
                        _actualWidth = _actualHeight = -1;
                    }

                    // execute 'lazy magic'
                    _lazyLoadItems(event.all);
                });

                // create function to add new items to instance
                events.a = function(additionalItems) {
                    additionalItems = _prepareItems(additionalItems);
                    items.push.apply(items, additionalItems);
                };

                // create function to get all instance items left
                events.g = function() {
                    // filter loaded items before return in case internal filter was not running until now
                    return (items = $(items).filter(function() {
                        return !$(this).data(config.loadedName);
                    }));
                };

                // create function to force loading elements
                events.f = function(forcedItems) {
                    for (var i = 0; i < forcedItems.length; i++) {
                        // only handle item if available in current instance
                        // use a compare function, because Zepto can't handle object parameter for filter
                        // var item = items.filter(forcedItems[i]);
                        /* jshint loopfunc: true */
                        var item = items.filter(function() {
                            return this === forcedItems[i];
                        });

                        if (item.length) {
                            _lazyLoadItems(false, item);   
                        }
                    }
                };

                // load initial items
                _lazyLoadItems();

                // bind lazy load functions to scroll and resize event
                // noinspection JSUnresolvedVariable
                $(config.appendScroll).on('scroll.' + namespace + ' resize.' + namespace, events.e);
            }
        }

        /**
         * prepare items before handle them
         * @access private
         * @param {Array|object|jQuery} items
         * @return {Array|object|jQuery}
         */
        function _prepareItems(items) {
            // fetch used configurations before loops
            var defaultImage = config.defaultImage,
                placeholder = config.placeholder,
                imageBase = config.imageBase,
                srcsetAttribute = config.srcsetAttribute,
                loaderAttribute = config.loaderAttribute,
                forcedTags = config._f || {};

            // filter items and only add those who not handled yet and got needed attributes available
            items = $(items).filter(function() {
                var element = $(this),
                    tag = _getElementTagName(this);

                return !element.data(config.handledName) && 
                       (element.attr(config.attribute) || element.attr(srcsetAttribute) || element.attr(loaderAttribute) || forcedTags[tag] !== undefined);
            })

            // append plugin instance to all elements
            .data('plugin_' + config.name, instance);

            for (var i = 0, l = items.length; i < l; i++) {
                var element = $(items[i]),
                    tag = _getElementTagName(items[i]),
                    elementImageBase = element.attr(config.imageBaseAttribute) || imageBase;

                // generate and update source set if an image base is set
                if (tag === _img && elementImageBase && element.attr(srcsetAttribute)) {
                    element.attr(srcsetAttribute, _getCorrectedSrcSet(element.attr(srcsetAttribute), elementImageBase));
                }

                // add loader to forced element types
                if (forcedTags[tag] !== undefined && !element.attr(loaderAttribute)) {
                    element.attr(loaderAttribute, forcedTags[tag]);
                }

                // set default image on every element without source
                if (tag === _img && defaultImage && !element.attr(_src)) {
                    element.attr(_src, defaultImage);
                }

                // set placeholder on every element without background image
                else if (tag !== _img && placeholder && (!element.css(_backgroundImage) || element.css(_backgroundImage) === 'none')) {
                    element.css(_backgroundImage, "url('" + placeholder + "')");
                }
            }

            return items;
        }

        /**
         * the 'lazy magic' - check all items
         * @access private
         * @param {boolean} [allItems]
         * @param {object} [forced]
         * @return void
         */
        function _lazyLoadItems(allItems, forced) {
            // skip if no items where left
            if (!items.length) {
                // destroy instance if option is enabled
                if (config.autoDestroy) {
                    // noinspection JSUnresolvedFunction
                    instance.destroy();
                }

                return;
            }

            var elements = forced || items,
                loadTriggered = false,
                imageBase = config.imageBase || '',
                srcsetAttribute = config.srcsetAttribute,
                handledName = config.handledName;

            // loop all available items
            for (var i = 0; i < elements.length; i++) {
                // item is at least in loadable area
                if (allItems || forced || _isInLoadableArea(elements[i])) {
                    var element = $(elements[i]),
                        tag = _getElementTagName(elements[i]),
                        attribute = element.attr(config.attribute),
                        elementImageBase = element.attr(config.imageBaseAttribute) || imageBase,
                        customLoader = element.attr(config.loaderAttribute);

                        // is not already handled 
                    if (!element.data(handledName) &&
                        // and is visible or visibility doesn't matter
                        (!config.visibleOnly || element.is(':visible')) && (
                        // and image source or source set attribute is available
                        (attribute || element.attr(srcsetAttribute)) && (
                            // and is image tag where attribute is not equal source or source set
                            (tag === _img && (elementImageBase + attribute !== element.attr(_src) || element.attr(srcsetAttribute) !== element.attr(_srcset))) ||
                            // or is non image tag where attribute is not equal background
                            (tag !== _img && elementImageBase + attribute !== element.css(_backgroundImage))
                        ) ||
                        // or custom loader is available
                        customLoader))
                    {
                        // mark element always as handled as this point to prevent double handling
                        loadTriggered = true;
                        element.data(handledName, true);

                        // load item
                        _handleItem(element, tag, elementImageBase, customLoader);
                    }
                }
            }

            // when something was loaded remove them from remaining items
            if (loadTriggered) {
                items = $(items).filter(function() {
                    return !$(this).data(handledName);
                });
            }
        }

        /**
         * load the given element the lazy way
         * @access private
         * @param {object} element
         * @param {string} tag
         * @param {string} imageBase
         * @param {function} [customLoader]
         * @return void
         */
        function _handleItem(element, tag, imageBase, customLoader) {
            // increment count of items waiting for after load
            ++_awaitingAfterLoad;

            // extended error callback for correct 'onFinishedAll' handling
            var errorCallback = function() {
                _triggerCallback('onError', element);
                _reduceAwaiting();

                // prevent further callback calls
                errorCallback = $.noop;
            };

            // trigger function before loading image
            _triggerCallback('beforeLoad', element);

            // fetch all double used data here for better code minimization
            var srcAttribute = config.attribute,
                srcsetAttribute = config.srcsetAttribute,
                sizesAttribute = config.sizesAttribute,
                retinaAttribute = config.retinaAttribute,
                removeAttribute = config.removeAttribute,
                loadedName = config.loadedName,
                elementRetina = element.attr(retinaAttribute);

            // handle custom loader
            if (customLoader) {
                // on load callback
                var loadCallback = function() {
                    // remove attribute from element
                    if (removeAttribute) {
                        element.removeAttr(config.loaderAttribute);
                    }

                    // mark element as loaded
                    element.data(loadedName, true);

                    // call after load event
                    _triggerCallback(_afterLoad, element);

                    // remove item from waiting queue and possibly trigger finished event
                    // it's needed to be asynchronous to run after filter was in _lazyLoadItems
                    setTimeout(_reduceAwaiting, 1);

                    // prevent further callback calls
                    loadCallback = $.noop;
                };

                // bind error event to trigger callback and reduce waiting amount
                element.off(_error).one(_error, errorCallback)

                // bind after load callback to element
                .one(_load, loadCallback);

                // trigger custom loader and handle response
                if (!_triggerCallback(customLoader, element, function(response) {
                    if(response) {
                        element.off(_load);
                        loadCallback();
                    }
                    else {
                        element.off(_error);
                        errorCallback();
                    }
                })) {
                    element.trigger(_error);
                }
            }

            // handle images
            else {
                // create image object
                var imageObj = $(new Image());

                // bind error event to trigger callback and reduce waiting amount
                imageObj.one(_error, errorCallback)

                // bind after load callback to image
                .one(_load, function() {
                    // remove element from view
                    element.hide();

                    // set image back to element
                    // do it as single 'attr' calls, to be sure 'src' is set after 'srcset'
                    if (tag === _img) {
                        element.attr(_sizes, imageObj.attr(_sizes))
                               .attr(_srcset, imageObj.attr(_srcset))
                               .attr(_src, imageObj.attr(_src));
                    }
                    else {
                        element.css(_backgroundImage, "url('" + imageObj.attr(_src) + "')");
                    }

                    // bring it back with some effect!
                    element[config.effect](config.effectTime);

                    // remove attribute from element
                    if (removeAttribute) {
                        element.removeAttr(srcAttribute + ' ' + srcsetAttribute + ' ' + retinaAttribute + ' ' + config.imageBaseAttribute);

                        // only remove 'sizes' attribute, if it was a custom one
                        if (sizesAttribute !== _sizes) {
                            element.removeAttr(sizesAttribute);
                        }
                    }

                    // mark element as loaded
                    element.data(loadedName, true);

                    // call after load event
                    _triggerCallback(_afterLoad, element);

                    // cleanup image object
                    imageObj.remove();

                    // remove item from waiting queue and possibly trigger finished event
                    _reduceAwaiting();
                });

                // set sources
                // do it as single 'attr' calls, to be sure 'src' is set after 'srcset'
                var imageSrc = (_isRetinaDisplay && elementRetina ? elementRetina : element.attr(srcAttribute)) || '';
                imageObj.attr(_sizes, element.attr(sizesAttribute))
                        .attr(_srcset, element.attr(srcsetAttribute))
                        .attr(_src, imageSrc ? imageBase + imageSrc : null);

                // call after load even on cached image
                imageObj.complete && imageObj.trigger(_load); // jshint ignore : line
            }
        }

        /**
         * check if the given element is inside the current viewport or threshold
         * @access private
         * @param {object} element
         * @return {boolean}
         */
        function _isInLoadableArea(element) {
            var elementBound = element.getBoundingClientRect(),
                direction    = config.scrollDirection,
                threshold    = config.threshold,
                vertical     = // check if element is in loadable area from top
                               ((_getActualHeight() + threshold) > elementBound.top) &&
                               // check if element is even in loadable are from bottom
                               (-threshold < elementBound.bottom),
                horizontal   = // check if element is in loadable area from left
                               ((_getActualWidth() + threshold) > elementBound.left) &&
                               // check if element is even in loadable area from right
                               (-threshold < elementBound.right);

            if (direction === 'vertical') {
                return vertical;
            }
            else if (direction === 'horizontal') {
                return horizontal;
            }

            return vertical && horizontal;
        }

        /**
         * receive the current viewed width of the browser
         * @access private
         * @return {number}
         */
        function _getActualWidth() {
            return _actualWidth >= 0 ? _actualWidth : (_actualWidth = $(window).width());
        }

        /**
         * receive the current viewed height of the browser
         * @access private
         * @return {number}
         */
        function _getActualHeight() {
            return _actualHeight >= 0 ? _actualHeight : (_actualHeight = $(window).height());
        }

        /**
         * get lowercase tag name of an element
         * @access private
         * @param {object} element
         * @returns {string}
         */
        function _getElementTagName(element) {
            return element.tagName.toLowerCase();
        }

        /**
         * prepend image base to all srcset entries
         * @access private
         * @param {string} srcset
         * @param {string} imageBase
         * @returns {string}
         */
        function _getCorrectedSrcSet(srcset, imageBase) {
            if (imageBase) {
                // trim, remove unnecessary spaces and split entries
                var entries = srcset.split(',');
                srcset = '';

                for (var i = 0, l = entries.length; i < l; i++) {
                    srcset += imageBase + entries[i].trim() + (i !== l - 1 ? ',' : '');
                }
            }

            return srcset;
        }

        /**
         * helper function to throttle down event triggering
         * @access private
         * @param {number} delay
         * @param {function} callback
         * @return {function}
         */
        function _throttle(delay, callback) {
            var timeout,
                lastExecute = 0;

            return function(event, ignoreThrottle) {
                var elapsed = +new Date() - lastExecute;

                function run() {
                    lastExecute = +new Date();
                    // noinspection JSUnresolvedFunction
                    callback.call(instance, event);
                }

                timeout && clearTimeout(timeout); // jshint ignore : line

                if (elapsed > delay || !config.enableThrottle || ignoreThrottle) {
                    run();
                }
                else {
                    timeout = setTimeout(run, delay - elapsed);
                }
            };
        }

        /**
         * reduce count of awaiting elements to 'afterLoad' event and fire 'onFinishedAll' if reached zero
         * @access private
         * @return void
         */
        function _reduceAwaiting() {
            --_awaitingAfterLoad;

            // if no items were left trigger finished event
            if (!items.length && !_awaitingAfterLoad) {
                _triggerCallback('onFinishedAll');
            }
        }

        /**
         * single implementation to handle callbacks, pass element and set 'this' to current instance
         * @access private
         * @param {string|function} callback
         * @param {object} [element]
         * @param {*} [args]
         * @return {boolean}
         */
        function _triggerCallback(callback, element, args) {
            if ((callback = config[callback])) {
                // jQuery's internal '$(arguments).slice(1)' are causing problems at least on old iPads
                // below is shorthand of 'Array.prototype.slice.call(arguments, 1)'
                callback.apply(instance, [].slice.call(arguments, 1));
                return true;
            }

            return false;
        }

        // if event driven or window is already loaded don't wait for page loading
        if (config.bind === 'event' || windowLoaded) {
            _initialize();
        }

        // otherwise load initial items and start lazy after page load
        else {
            // noinspection JSUnresolvedVariable
            $(window).on(_load + '.' + namespace, _initialize);
        }  
    }

    /**
     * lazy plugin class constructor
     * @constructor
     * @access private
     * @param {object} elements
     * @param {object} settings
     * @return {object|LazyPlugin}
     */
    function LazyPlugin(elements, settings) {
        /**
         * this lazy plugin instance
         * @access private
         * @type {object|LazyPlugin|LazyPlugin.prototype}
         */
        var _instance = this,

        /**
         * this lazy plugin instance configuration
         * @access private
         * @type {object}
         */
        _config = $.extend({}, _instance.config, settings),

        /**
         * instance generated event executed on container scroll or resize
         * packed in an object to be referenceable and short named because properties will not be minified
         * @access private
         * @type {object}
         */
        _events = {},

        /**
         * unique namespace for instance related events
         * @access private
         * @type {string}
         */
        _namespace = _config.name + '-' + (++lazyInstanceId);

        // noinspection JSUndefinedPropertyAssignment
        /**
         * wrapper to get or set an entry from plugin instance configuration
         * much smaller on minify as direct access
         * @access public
         * @type {function}
         * @param {string} entryName
         * @param {*} [value]
         * @return {LazyPlugin|*}
         */
        _instance.config = function(entryName, value) {
            if (value === undefined) {
                return _config[entryName];
            }

            _config[entryName] = value;
            return _instance;
        };

        // noinspection JSUndefinedPropertyAssignment
        /**
         * add additional items to current instance
         * @access public
         * @param {Array|object|string} items
         * @return {LazyPlugin}
         */
        _instance.addItems = function(items) {
            _events.a && _events.a($.type(items) === 'string' ? $(items) : items); // jshint ignore : line
            return _instance;
        };

        // noinspection JSUndefinedPropertyAssignment
        /**
         * get all left items of this instance
         * @access public
         * @returns {object}
         */
        _instance.getItems = function() {
            return _events.g ? _events.g() : {};
        };

        // noinspection JSUndefinedPropertyAssignment
        /**
         * force lazy to load all items in loadable area right now
         * by default without throttle
         * @access public
         * @type {function}
         * @param {boolean} [useThrottle]
         * @return {LazyPlugin}
         */
        _instance.update = function(useThrottle) {
            _events.e && _events.e({}, !useThrottle); // jshint ignore : line
            return _instance;
        };

        // noinspection JSUndefinedPropertyAssignment
        /**
         * force element(s) to load directly, ignoring the viewport
         * @access public
         * @param {Array|object|string} items
         * @return {LazyPlugin}
         */
        _instance.force = function(items) {
            _events.f && _events.f($.type(items) === 'string' ? $(items) : items); // jshint ignore : line
            return _instance;
        };

        // noinspection JSUndefinedPropertyAssignment
        /**
         * force lazy to load all available items right now
         * this call ignores throttling
         * @access public
         * @type {function}
         * @return {LazyPlugin}
         */
        _instance.loadAll = function() {
            _events.e && _events.e({all: true}, true); // jshint ignore : line
            return _instance;
        };

        // noinspection JSUndefinedPropertyAssignment
        /**
         * destroy this plugin instance
         * @access public
         * @type {function}
         * @return undefined
         */
        _instance.destroy = function() {
            // unbind instance generated events
            // noinspection JSUnresolvedFunction, JSUnresolvedVariable
            $(_config.appendScroll).off('.' + _namespace, _events.e);
            // noinspection JSUnresolvedVariable
            $(window).off('.' + _namespace);

            // clear events
            _events = {};

            return undefined;
        };

        // start using lazy and return all elements to be chainable or instance for further use
        // noinspection JSUnresolvedVariable
        _executeLazy(_instance, _config, elements, _events, _namespace);
        return _config.chainable ? elements : _instance;
    }

    /**
     * settings and configuration data
     * @access public
     * @type {object|*}
     */
    LazyPlugin.prototype.config = {
        // general
        name               : 'lazy',
        chainable          : true,
        autoDestroy        : true,
        bind               : 'load',
        threshold          : 500,
        visibleOnly        : false,
        appendScroll       : window,
        scrollDirection    : 'both',
        imageBase          : null,
        defaultImage       : 'data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==',
        placeholder        : null,
        delay              : -1,
        combined           : false,

        // attributes
        attribute          : 'data-src',
        srcsetAttribute    : 'data-srcset',
        sizesAttribute     : 'data-sizes',
        retinaAttribute    : 'data-retina',
        loaderAttribute    : 'data-loader',
        imageBaseAttribute : 'data-imagebase',
        removeAttribute    : true,
        handledName        : 'handled',
        loadedName         : 'loaded',

        // effect
        effect             : 'show',
        effectTime         : 0,

        // throttle
        enableThrottle     : true,
        throttle           : 250,

        // callbacks
        beforeLoad         : undefined,
        afterLoad          : undefined,
        onError            : undefined,
        onFinishedAll      : undefined
    };

    // register window load event globally to prevent not loading elements
    // since jQuery 3.X ready state is fully async and may be executed after 'load' 
    $(window).on('load', function() {
        windowLoaded = true;
    });
})(window);
/*
 *         ________                                                            ________
 *         ______(_)_____ ____  __________________  __ _____________________   ______(_)_______
 *         _____  /_  __ `/  / / /  _ \_  ___/_  / / / ___  __ \  _ \__  __ \  _____  /__  ___/
 *         ____  / / /_/ // /_/ //  __/  /   _  /_/ /____  /_/ /  __/_  /_/ /______  / _(__  )
 *         ___  /  \__, / \__,_/ \___//_/    _\__, /_(_)  .___/\___/_  .___/_(_)__  /  /____/
 *         /___/     /_/                     /____/    /_/          /_/        /___/
 *
 *        http://pep.briangonzalez.org
 *        Kinetic drag for mobile/desktop.
 *
 *        Copyright (c) 2014 Brian Gonzalez
 *        Licensed under the MIT license.
 *
 *        Title generated using "Speed" @
 *        http://patorjk.com/software/taag/#p=display&f=Speed&t=jquery.pep.js
 */

;(function ( $, window, undefined ) {

  "use strict";

  //  create the defaults once
  var pluginName = 'pep';
  var defaults   = {

    // Options
    // ----------------------------------------------------------------------------------------------
    // See ** https://github.com/briangonzalez/jquery.pep.js ** for fully documented options.
    // It was too hard to manage options here and in the readme.
    // ----------------------------------------------------------------------------------------------
    initiate:                       function(){},
    start:                          function(){},
    drag:                           function(){},
    stop:                           function(){},
    easing:                         null,
    rest:                           function(){},
    moveTo:                         false,
    callIfNotStarted:               ['stop', 'rest'],
    startThreshold:                 [0,0],
    grid:                           [1,1],
    debug:                          false,
    activeClass:                    'pep-active',
    startClass:                     'pep-start',
    easeClass:                      'pep-ease',
    multiplier:                     1,
    velocityMultiplier:             2.5,
    shouldPreventDefault:           true,
    allowDragEventPropagation:      true,
    stopEvents:                     '',
    hardwareAccelerate:             true,
    useCSSTranslation:              true,
    disableSelect:                  true,
    cssEaseString:                  "cubic-bezier(0.190, 1.000, 0.220, 1.000)",
    cssEaseDuration:                1000,
    shouldEase:                     true,
    droppable:                      false,
    droppableActiveClass:           'pep-dpa',
    overlapFunction:                false,
    constrainTo:                    false,
    removeMargins:                  true,
    place:                          true,
    deferPlacement:                 false,
    axis:                           null,
    forceNonCSS3Movement:           false,
    elementsWithInteraction:        'input',
    revert:                         false,
    revertAfter:                    'stop',
    revertIf:                       function(){ return true; },
    ignoreRightClick:               true,
    startPos:                       {
        left:                           null,
        top:                            null
    },
    useBoundingClientRect:          false
  };

  //  ---------------------------------
  //  -----  Our main Pep object  -----
  //  ---------------------------------
  function Pep( el, options ) {

    this.name = pluginName;

    // reference to our DOM object
    // and it's jQuery equivalent.
    this.el  = el;
    this.$el = $(el);

    //  merge in defaults
    this.options    = $.extend( {}, defaults, options) ;

    // store document/body so we don't need to keep grabbing them
    // throughout the code
    this.$document  = $(this.$el[0].ownerDocument);
    this.$body      = this.$document.find('body');

    //  Create our triggers based on touch/click device
    this.moveTrigger        = "MSPointerMove pointermove touchmove mousemove";
    this.startTrigger       = "MSPointerDown pointerdown touchstart mousedown";
    this.stopTrigger        = "MSPointerUp pointerup touchend mouseup";
    this.startTriggerArray  = this.startTrigger.split(' ');
    this.moveTriggerArray   = this.moveTrigger.split(' ');
    this.stopTriggerArray   = this.stopTrigger.split(' ');
    this.stopEvents         = [ this.stopTrigger, this.options.stopEvents ].join(' ');

    if ( this.options.constrainTo === 'window' )
      this.$container = this.$document;
    else if ( this.options.constrainTo && (this.options.constrainTo !== 'parent') )
      this.$container = $(this.options.constrainTo);
    else
      this.$container = this.$el.parent();

    // IE need this
    if ( this.isPointerEventCompatible() )
      this.applyMSDefaults();

    this.CSSEaseHash    = this.getCSSEaseHash();
    this.scale          = 1;
    this.started        = false;
    this.disabled       = false;
    this.autoAxis       = false;
    this.activeDropRegions = [];
    this.resetVelocityQueue();

    this.init();
    return this;
  }

  //  init();
  //    initialization logic
  //    you already have access to the DOM el and the options via the instance,
  //    e.g., this.el and this.options
  Pep.prototype.init = function () {

    if ( this.options.debug )
      this.buildDebugDiv();

    if ( this.options.disableSelect )
      this.disableSelect();

    // position the parent & place the object, if necessary.
    if ( this.options.place && !this.options.deferPlacement ) {
      this.positionParent();
      this.placeObject();
    }

    this.ev = {};       // to store our event movements
    this.pos = {};      // to store positions
    this.subscribe();
  };

  //  subscribe();
  //    useful in the event we want to programmatically
  //    interact with our Pep object.
  //      e.g.:     $('#pep').trigger('stop')
  Pep.prototype.subscribe = function () {
    var self = this;

    // Subscribe to our start event
    this.onStartEvent = function(ev){ self.handleStart(ev); };
    this.$el.on(this.startTrigger, this.onStartEvent);

    // Add a flag to events that start on elements that should allow interaction
    // so handleStart() can ignore them but allow them to bubble up through the DOM
    this.onStartEventOnElementsWithInteraction = function(ev){ ev.ignorePropagation = true; };
    this.$el.on(
      this.startTrigger,
      this.options.elementsWithInteraction,
      this.onStartEventOnElementsWithInteraction
    );

    // Subscribe to our stop event
    this.onStopEvents = function(ev) { self.handleStop(ev); };
    this.$document.on(this.stopEvents, this.onStopEvents);

    // Subscribe to our move event
    this.onMoveEvents = function(ev){ self.moveEvent = ev; };
    this.$document.on(this.moveTrigger, this.onMoveEvents);
  };

  Pep.prototype.unsubscribe = function() {
    this.$el.off(this.startTrigger, this.onStartEvent);
    this.$el.off(
      this.startTrigger,
      this.options.elementsWithInteraction,
      this.onStartEventOnElementsWithInteraction
    );
    this.$document.off(this.stopEvents, this.onStopEvents);
    this.$document.off(this.moveTrigger, this.onMoveEvents);
  };

  //  handleStart();
  //    once this.startTrigger occurs, handle all of the logic
  //    that must go on. This is where Pep's heavy lifting is done.
  Pep.prototype.handleStart = function(ev) {

    // ignorePropagation is set to true if the event originates from an element
    // listed in this.options.elementsWithInteraction
    if (ev.ignorePropagation) return;

    var self = this;

            // only continue chugging if our start event is a valid move event.
            if ( this.isValidMoveEvent(ev) && !this.disabled ){

              if( !(this.options.ignoreRightClick && ev.which === 3) ) {

                    // IE10 Hack. Me not happy.
                    if ( this.isPointerEventCompatible() && ev.preventManipulation )
                      ev.preventManipulation();

                    // normalize event
                    ev = this.normalizeEvent(ev);

                    // position the parent & place the object, if necessary.
                    if ( this.options.place && this.options.deferPlacement ) {
                      this.positionParent();
                      this.placeObject();
                    }

                    // log it
                    this.log({ type: 'event', event: ev.type });

                    // hardware accelerate, if necessary.
                    if ( this.options.hardwareAccelerate && !this.hardwareAccelerated ) {
                      this.hardwareAccelerate();
                      this.hardwareAccelerated = true;
                    }

                    // fire user's initiate event.
                    var shouldContinue = this.options.initiate.call(this, ev, this);
                    if ( shouldContinue === false )
                      return;


                    // cancel the rest timeout
                    clearTimeout( this.restTimeout );

                    // add active class and reset css animation, if necessary
                    this.$el.addClass( this.options.activeClass );
                    this.removeCSSEasing();

                    // store event's x & y values for later use
                    this.startX = this.ev.x = ev.pep.x;
                    this.startY = this.ev.y = ev.pep.y;

                    // store initial offset.
                    this.initialPosition = this.initialPosition || this.$el.position();

                    // store the initial touch/click event, used to calculate the inital delta values.
                    this.startEvent = this.moveEvent = ev;

                    // make object active, so watchMoveLoop starts looping.
                    this.active     = true;

                    // preventDefault(), is necessary
                    if ( this.options.shouldPreventDefault )
                      ev.preventDefault();

                    // allow / disallow event bubbling
                    if ( !this.options.allowDragEventPropagation )
                      ev.stopPropagation();

                    // animation loop to ensure we don't fire
                    // too many unneccessary repaints
                    (function watchMoveLoop(){
                        if ( !self.active ) return;
                        self.handleMove();
                        self.requestAnimationFrame( watchMoveLoop );
                    })();

                    (function watchEasingLoop(){
                        if ( !self.options.easing ) return;
                        if ( self.easing ) self.options.easing.call(self, null, self);
                        self.requestAnimationFrame( watchEasingLoop );
                    })();
              }
            }
  };

  //  handleMove();
  //    the logic for when the move events occur
  Pep.prototype.handleMove = function() {

            // setup our event object
            if ( typeof(this.moveEvent) === 'undefined' )
              return;

            // get our move event's x & y
            var ev      = this.normalizeEvent( this.moveEvent );
            var curX    = window.parseInt(ev.pep.x / this.options.grid[0]) * this.options.grid[0];
            var curY    = window.parseInt(ev.pep.y / this.options.grid[1]) * this.options.grid[1];

            // last in, first out (LIFO) queue to help us manage velocity
            this.addToLIFO( { time: ev.timeStamp, x: curX, y: curY } );

            // calculate values necessary to moving
            var dx, dy;

            if ( $.inArray( ev.type, this.startTriggerArray ) > -1  ){
              dx = 0;
              dy = 0;
            } else{
              dx = curX - this.ev.x;
              dy = curY - this.ev.y;
            }

            this.dx   = dx;
            this.dy   = dy;
            this.ev.x = curX;
            this.ev.y = curY;

            // no movement in either direction -- so return
            if (dx === 0 && dy === 0){
              this.log({ type: 'event', event: '** stopped **' });
              return;
            }

            // check if object has moved past X/Y thresholds
            // if so, fire users start event
            var initialDx  = Math.abs(this.startX - curX);
            var initialDy  = Math.abs(this.startY - curY);
            if ( !this.started && ( initialDx > this.options.startThreshold[0] || initialDy > this.options.startThreshold[1] ) ){
              this.started = true;
              this.$el.addClass(this.options.startClass);
              this.options.start.call(this, this.startEvent, this);
            }

            // Move before calculate position and fire events
            this.doMoveTo(dx, dy);

            // Calculate our drop regions
            if ( this.options.droppable ) {
              this.calculateActiveDropRegions();
            }

            // fire user's drag event.
            var continueDrag = this.options.drag.call(this, ev, this);

            if ( continueDrag === false ) {
              this.resetVelocityQueue();
              return;
            }

            // log the move trigger & event position
            this.log({ type: 'event', event: ev.type });
            this.log({ type: 'event-coords', x: this.ev.x, y: this.ev.y });
            this.log({ type: 'velocity' });
  };

  Pep.prototype.doMoveTo = function(dx, dy) {
            var hash = this.handleConstraint(dx, dy);
            var xOp, yOp;

            // if using the "auto" axis, determine which axis to use based on
            // whether the user has dragged more along the x or the y axis
            if ( this.options.axis === 'auto' && !this.autoAxis) {
              if ( Math.abs(dx) > Math.abs(dy) ) this.autoAxis = 'x';
              else
              if ( Math.abs(dx) < Math.abs(dy) ) this.autoAxis = 'y';
              // don't move at all if the axis can't be determined
              else {
                dy = 0;
                dx = 0;
              }
            }

            // if using not using CSS transforms, move object via absolute position
            if ( typeof this.options.moveTo === 'function') {
              xOp     = ( dx >= 0 ) ? "+=" + Math.abs(dx/this.scale)*this.options.multiplier : "-=" + Math.abs(dx/this.scale)*this.options.multiplier;
              yOp     = ( dy >= 0 ) ? "+=" + Math.abs(dy/this.scale)*this.options.multiplier : "-=" + Math.abs(dy/this.scale)*this.options.multiplier;

              if ( this.options.constrainTo ) {
                xOp = (hash.x !== false) ? hash.x : xOp;
                yOp = (hash.y !== false) ? hash.y : yOp;
              }

              // only move along single axis, if necessary
              if ( this.options.axis === 'x' || this.autoAxis === 'x' ) yOp = hash.y;
              if ( this.options.axis === 'y' || this.autoAxis === 'y' ) xOp = hash.x;

              this.options.moveTo.call(this, xOp, yOp);
            } else if ( !this.shouldUseCSSTranslation() ){
              xOp     = ( dx >= 0 ) ? "+=" + Math.abs(dx/this.scale)*this.options.multiplier : "-=" + Math.abs(dx/this.scale)*this.options.multiplier;
              yOp     = ( dy >= 0 ) ? "+=" + Math.abs(dy/this.scale)*this.options.multiplier : "-=" + Math.abs(dy/this.scale)*this.options.multiplier;

              if ( this.options.constrainTo ) {
                xOp = (hash.x !== false) ? hash.x : xOp;
                yOp = (hash.y !== false) ? hash.y : yOp;
              }

              // only move along single axis, if necessary
              if ( this.options.axis === 'x' || this.autoAxis === 'x' ) yOp = hash.y;
              if ( this.options.axis === 'y' || this.autoAxis === 'y' ) xOp = hash.x;

              this.moveTo(xOp, yOp);
            }
            else {

              dx = (dx/this.scale)*this.options.multiplier;
              dy = (dy/this.scale)*this.options.multiplier;

              if ( this.options.constrainTo ) {
                dx = (hash.x === false) ? dx : 0 ;
                dy = (hash.y === false) ? dy : 0 ;
              }

              // only move along single axis, if necessary
              if ( this.options.axis === 'x' || this.autoAxis === 'x' ) dy = 0;
              if ( this.options.axis === 'y' || this.autoAxis === 'y' ) dx = 0;

              this.moveToUsingTransforms( dx, dy );
            }
  };

  //  handleStop();
  //    the logic for when the stop events occur
  Pep.prototype.handleStop = function(ev) {

            // no need to handle stop event if we're not active
            if (!this.active)
              return;

            // log it
            this.log({ type: 'event', event: ev.type });

            // make object inactive, so watchMoveLoop returns
            this.active = false;

            // make object easing.
            this.easing = true;

            // remove our start class
            this.$el.removeClass(this.options.startClass)
                    .addClass(this.options.easeClass);

            // Calculate our drop regions
            if ( this.options.droppable ) {
              this.calculateActiveDropRegions();
            }

            // fire user's stop event.
            if ( this.started || (!this.started &&  $.inArray('stop', this.options.callIfNotStarted) > -1 ) ) {
              this.options.stop.call(this, ev, this);
            }

            // ease the object, if necessary.
            if (this.options.shouldEase) {
              this.ease(ev, this.started);
            } else {
              this.removeActiveClass();
            }

            if ( this.options.revert && (this.options.revertAfter === 'stop' || !this.options.shouldEase) && ( this.options.revertIf && this.options.revertIf.call(this) ) ) {
              this.revert();
            }

            // this must be set to false after
            // the user's stop event is called, so the dev
            // has access to it.
            this.started = false;

            // reset the auto-axis
            if ( this.autoAxis ) this.autoAxis = false;

            // reset the velocity queue
            this.resetVelocityQueue();

  };

  //  ease();
  //    used in conjunction with the LIFO queue
  //    to ease the object after stop
  Pep.prototype.ease = function(ev, started){

            var pos       = this.$el.position();
            var vel       = this.velocity();
            var dt        = this.dt;
            var x         = (vel.x/this.scale) * this.options.multiplier;
            var y         = (vel.y/this.scale) * this.options.multiplier;

            var hash      = this.handleConstraint(x, y, true);

            // ✪  Apply the CSS3 animation easing magic  ✪
            if ( this.cssAnimationsSupported() )
              this.$el.css( this.getCSSEaseHash() );

            var xOp = ( vel.x > 0 ) ? "+=" + x : "-=" + Math.abs(x);
            var yOp = ( vel.y > 0 ) ? "+=" + y : "-=" + Math.abs(y);

            if ( this.options.constrainTo ) {
              xOp = (hash.x !== false) ? hash.x : xOp;
              yOp = (hash.y !== false) ? hash.y : yOp;
            }

            if ( this.options.axis === 'x' || this.autoAxis === 'x' ) yOp = "+=0";
            if ( this.options.axis === 'y' || this.autoAxis === 'y' ) xOp = "+=0";

            // ease it via JS, the last true tells it to animate.
            var jsAnimateFallback = !this.cssAnimationsSupported() || this.options.forceNonCSS3Movement;
            if (typeof this.options.moveTo === 'function') {
              this.options.moveTo.call(this, xOp, yOp);
            } else {
              this.moveTo(xOp, yOp, jsAnimateFallback);
            }

            // when the rest occurs, remove active class and call
            // user's rest event.
            var self = this;
            this.restTimeout = setTimeout( function(){

              // Calculate our drop regions
              if ( self.options.droppable ) {
                self.calculateActiveDropRegions();
              }

              self.easing = false;

              // call users rest event.
              if ( started || ( !started && $.inArray('rest', self.options.callIfNotStarted) > -1 ) ) {
                self.options.rest.call(self, ev, self);
              }

              // revert thy self!
              if ( self.options.revert && (self.options.revertAfter === 'ease' && self.options.shouldEase) && ( self.options.revertIf && self.options.revertIf.call(self) ) ) {
                self.revert();
              }

              // remove active class
              self.removeActiveClass();

            }, this.options.cssEaseDuration );

  };

  // normalizeEvent()
  Pep.prototype.normalizeEvent = function(ev) {
      ev.pep        = {};

      if ( this.isTouch(ev) ) {

        ev.pep.x      = ev.originalEvent.touches[0].pageX;
        ev.pep.y      = ev.originalEvent.touches[0].pageY;
        ev.pep.type   = ev.type;

      }
      else if ( this.isPointerEventCompatible() || !this.isTouch(ev) ) {

        if ( ev.pageX  ) {
          ev.pep.x      = ev.pageX;
          ev.pep.y      = ev.pageY;
        } else {
          ev.pep.x      = ev.originalEvent.pageX;
          ev.pep.y      = ev.originalEvent.pageY;
        }

        ev.pep.type   = ev.type;

      }

      return ev;
   };

  // resetVelocityQueue()
  //
  Pep.prototype.resetVelocityQueue = function() {
    this.velocityQueue = new Array(5);
  };

  //  moveTo();
  //    move the object to an x and/or y value
  //    using jQuery's .css function -- this fxn uses the
  //    .css({top: "+=20", left: "-=30"}) syntax
  Pep.prototype.moveTo = function(x,y, animate) {

    this.log({ type: 'delta', x: x, y: y });
    if ( animate ) {
      this.$el.animate({ top: y, left: x }, 0, 'easeOutQuad', {queue: false});
    } else{
      this.$el.stop(true, false).css({ top: y , left: x });
    }

  };

  //  moveToUsingTransforms();
  //    move the object to an x and/or y value
  Pep.prototype.moveToUsingTransforms = function(x,y) {

    // Check for our initial values if we don't have them.
    var matrixArray  = this.matrixToArray( this.matrixString() );
    if ( !this.cssX )
      this.cssX = this.xTranslation( matrixArray );

    if ( !this.cssY )
      this.cssY = this.yTranslation( matrixArray );

    // CSS3 transforms are additive from current position
    this.cssX = this.cssX + x;
    this.cssY = this.cssY + y;

    this.log({ type: 'delta', x: x, y: y });

    matrixArray[4]    = this.cssX;
    matrixArray[5]    = this.cssY;

    this.translation  = this.arrayToMatrix( matrixArray );
    this.transform( this.translation );
  };

  Pep.prototype.transform = function(value) {
    this.$el.css({
        '-webkit-transform': value,
           '-moz-transform': value,
            '-ms-transform': value,
             '-o-transform': value,
                'transform': value  });
  };

  Pep.prototype.xTranslation = function(matrixArray) {
    matrixArray  = matrixArray || this.matrixToArray( this.matrixString() );
    return parseInt(matrixArray[4], 10);
  };

  Pep.prototype.yTranslation = function(matrixArray) {
    matrixArray  = matrixArray || this.matrixToArray( this.matrixString() );
    return parseInt(matrixArray[5], 10);
  };


  // 3 helper functions for working with the
  // objects CSS3 transforms
  // matrixString
  // matrixToArray
  // arrayToMatrix
  Pep.prototype.matrixString = function() {

    var validMatrix = function(o){
      return !( !o || o === 'none' || o.indexOf('matrix') < 0  );
    };

    var matrix = "matrix(1, 0, 0, 1, 0, 0)";

    if ( validMatrix( this.$el.css('-webkit-transform') ) )
      matrix = this.$el.css('-webkit-transform');

    if ( validMatrix( this.$el.css('-moz-transform') ) )
      matrix = this.$el.css('-moz-transform');

    if ( validMatrix( this.$el.css('-ms-transform') ) )
      matrix = this.$el.css('-ms-transform');

    if ( validMatrix( this.$el.css('-o-transform') ) )
      matrix = this.$el.css('-o-transform');

    if ( validMatrix( this.$el.css('transform') ) )
      matrix = this.$el.css('transform');

    return matrix;
  };

  Pep.prototype.matrixToArray = function(str) {
      return str.split('(')[1].split(')')[0].split(',');
  };

  Pep.prototype.arrayToMatrix = function(array) {
      return "matrix(" +  array.join(',')  + ")";
  };

  //  addToLIFO();
  //    a Last-In/First-Out array of the 5 most recent
  //    velocity points, which is used for easing
  Pep.prototype.addToLIFO = function(val){
    // last in, first out
    var arr = this.velocityQueue;
    arr = arr.slice(1, arr.length);
    arr.push(val);
    this.velocityQueue = arr;
  };

  //  velocity();
  //    using the LIFO, calculate velocity and return
  //    velocity in each direction (x & y)
  Pep.prototype.velocity = function(){
    var sumX = 0;
    var sumY = 0;

    for ( var i = 0; i < this.velocityQueue.length -1; i++  ){
      if ( this.velocityQueue[i] ){
        sumX        += (this.velocityQueue[i+1].x - this.velocityQueue[i].x);
        sumY        += (this.velocityQueue[i+1].y - this.velocityQueue[i].y);
        this.dt     = ( this.velocityQueue[i+1].time - this.velocityQueue[i].time );
      }
    }

    // return velocity in each direction.
    return { x: sumX*this.options.velocityMultiplier, y: sumY*this.options.velocityMultiplier};
  };

  Pep.prototype.revert = function() {
    if ( this.shouldUseCSSTranslation() ){
      this.moveToUsingTransforms(-this.xTranslation(),-this.yTranslation());
    }

    if (this.options.place) {
      this.moveTo(this.initialPosition.left, this.initialPosition.top);
    }
  };

  //  requestAnimationFrame();
  //    requestAnimationFrame Polyfill
  //    More info:
  //    http://paulirish.com/2011/requestanimationframe-for-smart-animating/
  Pep.prototype.requestAnimationFrame = function(callback) {
    return  window.requestAnimationFrame        && window.requestAnimationFrame(callback)         ||
            window.webkitRequestAnimationFrame  && window.webkitRequestAnimationFrame(callback)   ||
            window.mozRequestAnimationFrame     && window.mozRequestAnimationFrame(callback)      ||
            window.oRequestAnimationFrame       && window.mozRequestAnimationFrame(callback)      ||
            window.msRequestAnimationFrame      && window.msRequestAnimationFrame(callback)       ||
            window.setTimeout(callback, 1000 / 60);
  };

  //  positionParent();
  //    add the right positioning to the parent object
  Pep.prototype.positionParent = function() {

    if ( !this.options.constrainTo || this.parentPositioned )
      return;

    this.parentPositioned = true;

    // make `relative` parent if necessary
    if ( this.options.constrainTo === 'parent' ) {
      this.$container.css({ position: 'relative' });
    } else if ( this.options.constrainTo === 'window'             &&
                this.$container.get(0).nodeName !== "#document"   &&
                this.$container.css('position') !== 'static' )
    {
      this.$container.css({ position: 'static' });
    }

  };

  //  placeObject();
  //    add the right positioning to the object
  Pep.prototype.placeObject = function() {

    if ( this.objectPlaced )
      return;

    this.objectPlaced = true;

    this.offset = (this.options.constrainTo === 'parent' || this.hasNonBodyRelative() ) ?
                    this.$el.position() : this.$el.offset();

    // better to leave absolute position alone if
    // it already has one.
    if ( parseInt( this.$el.css('left'), 10 ) )
      this.offset.left = this.$el.css('left');

    if (typeof this.options.startPos.left === "number")
        this.offset.left = this.options.startPos.left;

    if ( parseInt( this.$el.css('top'), 10 ) )
      this.offset.top = this.$el.css('top');

    if (typeof this.options.startPos.top === "number")
        this.offset.top = this.options.startPos.top;

    if ( this.options.removeMargins )
      this.$el.css({margin: 0});

    this.$el.css({
      position:   'absolute',
      top:        this.offset.top,
      left:       this.offset.left
    });

  };

  //  hasNonBodyRelative()
  //    returns true if any parent other than the body
  //    has relative positioning
  Pep.prototype.hasNonBodyRelative = function() {
    return this.$el.parents().filter(function() {
        var $this = $(this);
        return $this.is('body') || $this.css('position') === 'relative';
    }).length > 1;
  };

  //  setScale()
  //    set the scale of the object being moved.
  Pep.prototype.setScale = function(val) {
    this.scale = val;
  };

  //  setMultiplier()
  //    set the multiplier of the object being moved.
  Pep.prototype.setMultiplier = function(val) {
    this.options.multiplier = val;
  };

  //  removeCSSEasing();
  //    remove CSS easing properties, if necessary
  Pep.prototype.removeCSSEasing = function() {
    if ( this.cssAnimationsSupported() )
      this.$el.css( this.getCSSEaseHash(true) );
  };

  //  disableSelect();
  //    add the property which causes the object
  //    to not be selected user drags over text areas
  Pep.prototype.disableSelect = function() {

    this.$el.css({
      '-webkit-touch-callout' : 'none',
        '-webkit-user-select' : 'none',
         '-khtml-user-select' : 'none',
           '-moz-user-select' : 'none',
            '-ms-user-select' : 'none',
                'user-select' : 'none'
    });

  };

  // removeActiveClass()
  //  Removes the active class.
  Pep.prototype.removeActiveClass = function() {
    this.$el.removeClass( [this.options.activeClass, this.options.easeClass].join(' ') );
  };

  //  handleConstraint();
  //    returns a hash of where to move to
  //    when we constrain to parent/window
  Pep.prototype.handleConstraint = function(dx, dy, accountForTranslation) {
    var pos               = this.$el.position();
    this.pos.x            = pos.left;
    this.pos.y            = pos.top;

    var hash              = { x: false, y: false };

    var upperYLimit, upperXLimit, lowerXLimit, lowerYLimit;

    // log our positions
    this.log({ type: "pos-coords", x: this.pos.x, y: this.pos.y});

    if ( $.isArray( this.options.constrainTo ) ) {

      if ( this.options.constrainTo[3] !== undefined && this.options.constrainTo[1] !== undefined ) {
        upperXLimit     = this.options.constrainTo[1] === false ?  Infinity : this.options.constrainTo[1];
        lowerXLimit     = this.options.constrainTo[3] === false ? -Infinity : this.options.constrainTo[3];
      }
      if ( this.options.constrainTo[0] !== false && this.options.constrainTo[2] !== false ) {
        upperYLimit       = this.options.constrainTo[2] === false ?  Infinity : this.options.constrainTo[2];
        lowerYLimit       = this.options.constrainTo[0] === false ? -Infinity : this.options.constrainTo[0];
      }

      // is our object trying to move outside lower X & Y limits?
      if ( this.pos.x + dx < lowerXLimit)     hash.x = lowerXLimit;
      if ( this.pos.y + dy < lowerYLimit)     hash.y = lowerYLimit;

    } else if ( typeof this.options.constrainTo === 'string' ) {
      lowerXLimit       = 0;
      lowerYLimit       = 0;
      upperXLimit       = this.$container.width()  - (this.options.useBoundingClientRect ? this.$el[0].getBoundingClientRect().width : this.$el.outerWidth());
      upperYLimit       = this.$container.height() - (this.options.useBoundingClientRect ? this.$el[0].getBoundingClientRect().height : this.$el.outerHeight());

      // is our object trying to move outside lower X & Y limits?
      if ( this.pos.x + dx < 0 )              hash.x = 0;
      if ( this.pos.y + dy < 0 )              hash.y = 0;
    }

    // is our object trying to move outside upper X & Y limits?
    if ( this.pos.x + dx > upperXLimit )    hash.x = upperXLimit;
    if ( this.pos.y + dy > upperYLimit )    hash.y = upperYLimit;

    // Account for translation, which makes movement a little tricky.
    if ( this.shouldUseCSSTranslation() && accountForTranslation ){
      if (hash.x === lowerXLimit && this.xTranslation() ) hash.x = lowerXLimit - this.xTranslation();
      if (hash.x === upperXLimit && this.xTranslation() ) hash.x = upperXLimit - this.xTranslation();

      if (hash.y === lowerYLimit && this.yTranslation() ) hash.y = lowerYLimit - this.yTranslation();
      if (hash.y === upperYLimit && this.yTranslation() ) hash.y = upperYLimit - this.yTranslation();
    }

    return hash;
  };

  //  getCSSEaseHash();
  //    returns a hash of params used in conjunction
  //    with this.options.cssEaseString
  Pep.prototype.getCSSEaseHash = function(reset){
    if ( typeof(reset) === 'undefined' ) reset = false;

    var cssEaseString;
    if (reset){
      cssEaseString = '';
    } else if ( this.CSSEaseHash ) {
      return this.CSSEaseHash;
    } else {
      cssEaseString = ['all', this.options.cssEaseDuration + 'ms', this.options.cssEaseString].join(' ');
    }

    return {
                  '-webkit-transition'   : cssEaseString,   // chrome, safari, etc.
                     '-moz-transition'   : cssEaseString,   // firefox
                      '-ms-transition'   : cssEaseString,   // microsoft
                       '-o-transition'   : cssEaseString,   // opera
                          'transition'   : cssEaseString    // future
          };
  };

  // calculateActiveDropRegions()
  //    sets parent droppables of this.
  Pep.prototype.calculateActiveDropRegions = function() {
    var self = this;
    this.activeDropRegions.length = 0;

    $.each( $(this.options.droppable), function(idx, el){
      var $el = $(el);
      if ( self.isOverlapping($el, self.$el) ){
        $el.addClass(self.options.droppableActiveClass);
        self.activeDropRegions.push($el);
      } else {
        $el.removeClass(self.options.droppableActiveClass);
      }
    });

  };

  //  isOverlapping();
  //    returns true if element a over
  Pep.prototype.isOverlapping = function($a,$b) {

    if ( this.options.overlapFunction ) {
      return this.options.overlapFunction($a,$b);
    }

    var rect1 = $a[0].getBoundingClientRect();
    var rect2 = $b[0].getBoundingClientRect();

    return !( rect1.right   < rect2.left  ||
              rect1.left    > rect2.right ||
              rect1.bottom  < rect2.top   ||
              rect1.top     > rect2.bottom  );
  };

  //  isTouch();
  //    returns whether or not event is a touch event
  Pep.prototype.isTouch = function(ev){
    return ev.type.search('touch') > -1;
  };

  // isPointerEventCompatible();
  //    return whether or note our device is pointer
  //    event compatible; typically means where on a
  //    touch Win8 device
  Pep.prototype.isPointerEventCompatible = function() {
    return ("MSPointerEvent" in window);
  };

  // applyMSDefaults();
  Pep.prototype.applyMSDefaults = function(first_argument) {
    this.$el.css({
        '-ms-touch-action' :    'none',
        'touch-action' :        'none',
        '-ms-scroll-chaining':  'none',
        '-ms-scroll-limit':     '0 0 0 0'
    });
  };

  //  isValidMoveEvent();
  //    returns true if we're on a non-touch device -- or --
  //    if the event is **single** touch event on a touch device
  Pep.prototype.isValidMoveEvent = function(ev){
    return ( !this.isTouch(ev) || ( this.isTouch(ev) && ev.originalEvent && ev.originalEvent.touches && ev.originalEvent.touches.length === 1 ) );
  };

  //  shouldUseCSSTranslation();
  //    return true if we should use CSS transforms for move the object
  Pep.prototype.shouldUseCSSTranslation = function() {

    if ( this.options.forceNonCSS3Movement )
      return false;

    if ( typeof(this.useCSSTranslation) !== "undefined" )
      return this.useCSSTranslation;

    var useCSSTranslation = false;

    if ( !this.options.useCSSTranslation || ( typeof(Modernizr) !== "undefined" && !Modernizr.csstransforms)){
      useCSSTranslation = false;
    }
    else{
      useCSSTranslation = true;
    }

    this.useCSSTranslation =  useCSSTranslation;
    return useCSSTranslation;
  };

  //  cssAnimationsSupported():
  //    returns true if the browser supports CSS animations
  //    which are used for easing..
  Pep.prototype.cssAnimationsSupported = function() {

    if ( typeof(this.cssAnimationsSupport) !== "undefined" ){
      return this.cssAnimationsSupport;
    }

    // If the page has Modernizr, let them do the heavy lifting.
    if ( ( typeof(Modernizr) !== "undefined" && Modernizr.cssanimations) ){
      this.cssAnimationsSupport = true;
      return true;
    }

    var animation = false,
        elm = document.createElement('div'),
        animationstring = 'animation',
        keyframeprefix = '',
        domPrefixes = 'Webkit Moz O ms Khtml'.split(' '),
        pfx  = '';

    if( elm.style.animationName ) { animation = true; }

    if( animation === false ) {
      for( var i = 0; i < domPrefixes.length; i++ ) {
        if( elm.style[ domPrefixes[i] + 'AnimationName' ] !== undefined ) {
          pfx = domPrefixes[ i ];
          animationstring = pfx + 'Animation';
          keyframeprefix = '-' + pfx.toLowerCase() + '-';
          animation = true;
          break;
        }
      }
    }

    this.cssAnimationsSupport = animation;
    return animation;
  };

  //  hardwareAccelerate();
  //    add fool-proof CSS3 hardware acceleration.
  Pep.prototype.hardwareAccelerate = function() {
    this.$el.css({
      '-webkit-perspective':          1000,
      'perspective':                  1000,
      '-webkit-backface-visibility':  'hidden',
      'backface-visibility':          'hidden'
    });
   };

  //  getMovementValues();
  //    returns object pos, event position, and velocity in each direction.
  Pep.prototype.getMovementValues = function() {
    return { ev: this.ev, pos: this.pos, velocity: this.velocity() };
   };

  //  buildDebugDiv();
  //    Create a little div in the lower right corner of the window
  //    for extra info about the object currently moving
  Pep.prototype.buildDebugDiv = function() {

    // Build the debugDiv and it's inner HTML -- if necessary
    var $debugDiv;
    if ( $('#pep-debug').length === 0 ){
      $debugDiv = $('<div></div>');
      $debugDiv
        .attr('id', 'pep-debug')
        .append("<div style='font-weight:bold; background: red; color: white;'>DEBUG MODE</div>")
        .append("<div id='pep-debug-event'>no event</div>")
        .append("<div id='pep-debug-ev-coords'>event coords: <span class='pep-x'>-</span>, <span class='pep-y'>-</span></div>")
        .append("<div id='pep-debug-pos-coords'>position coords: <span class='pep-x'>-</span>, <span class='pep-y'>-</span></div>")
        .append("<div id='pep-debug-velocity'>velocity: <span class='pep-x'>-</span>, <span class='pep-y'>-</span></div>")
        .append("<div id='pep-debug-delta'>&Delta; movement: <span class='pep-x'>-</span>, <span class='pep-y'>-</span></div>")
        .css({
          position:   'fixed',
          bottom:     5,
          right:      5,
          zIndex:     99999,
          textAlign:  'right',
          fontFamily: 'Arial, sans',
          fontSize:   10,
          border:     '1px solid #DDD',
          padding:    '3px',
          background: 'white',
          color:      '#333'
        });
    }

    var self = this;
    setTimeout(function(){
      self.debugElements = {
        $event:      $("#pep-debug-event"),
        $velocityX:  $("#pep-debug-velocity .pep-x"),
        $velocityY:  $("#pep-debug-velocity .pep-y"),
        $dX:         $("#pep-debug-delta .pep-x"),
        $dY:         $("#pep-debug-delta .pep-y"),
        $evCoordsX:  $("#pep-debug-ev-coords .pep-x"),
        $evCoordsY:  $("#pep-debug-ev-coords .pep-y"),
        $posCoordsX: $("#pep-debug-pos-coords .pep-x"),
        $posCoordsY: $("#pep-debug-pos-coords .pep-y")
      };
    }, 0);

    $('body').append( $debugDiv );
  };

  // log()
  Pep.prototype.log = function(opts) {
    if ( !this.options.debug ) return;

    switch (opts.type){
    case "event":
      this.debugElements.$event.text(opts.event);
      break;
    case "pos-coords":
      this.debugElements.$posCoordsX.text(opts.x);
      this.debugElements.$posCoordsY.text(opts.y);
      break;
    case "event-coords":
      this.debugElements.$evCoordsX.text(opts.x);
      this.debugElements.$evCoordsY.text(opts.y);
      break;
    case "delta":
      this.debugElements.$dX.text(opts.x);
      this.debugElements.$dY.text(opts.y);
      break;
    case "velocity":
      var vel = this.velocity();
      this.debugElements.$velocityX.text( Math.round(vel.x) );
      this.debugElements.$velocityY.text( Math.round(vel.y) );
      break;
    }
  };

  // toggle()
  //  toggle the pep object
  Pep.prototype.toggle = function(on) {
    if ( typeof(on) === "undefined"){
      this.disabled = !this.disabled;
    }
    else {
      this.disabled = !on;
    }
  };

  //  *** Special Easings functions ***
  //    Used for JS easing fallback
  //    We can use any of these for a
  //    good intertia ease
  $.extend($.easing,
  {
    easeOutQuad: function (x, t, b, c, d) {
      return -c *(t/=d)*(t-2) + b;
    },
    easeOutCirc: function (x, t, b, c, d) {
      return c * Math.sqrt(1 - (t=t/d-1)*t) + b;
    },
    easeOutExpo: function (x, t, b, c, d) {
      return (t===d) ? b+c : c * (-Math.pow(2, -10 * t/d) + 1) + b;
    }
  });

  //  wrap it
  //    A really lightweight plugin wrapper around the constructor,
  //    preventing against multiple instantiations.
  $.fn[pluginName] = function ( options ) {
    return this.each(function () {
      if (!$.data(this, 'plugin_' + pluginName)) {
        var pepObj = new Pep( this, options );
        $.data(this, 'plugin_' + pluginName, pepObj);
        $.pep.peps.push(pepObj);
      }
    });
  };

  //  The   _   ___ ___
  //       /_\ | _ \_ _|
  //      / _ \|  _/| |
  //     /_/ \_\_| |___|
  //
  $.pep = {};
  $.pep.peps = [];
  $.pep.toggleAll = function(on){
    $.each(this.peps, function(index, pepObj){
      pepObj.toggle(on);
    });
  };

  $.pep.unbind = function($obj){
    $.each($obj, function(index, pepObj) {
      pepObj = $(pepObj);
      var pep = pepObj.data('plugin_' + pluginName);

      if ( typeof pep === 'undefined' )
        return;

      pep.toggle(false);
      pep.unsubscribe();
      pepObj.removeData('plugin_' + pluginName);
    });
  };

}(jQuery, window));

/*
Version: 1.0.9
Documentation: http://baymard.com/labs/country-selector#documentation
Copyright (C) 2011 by Jamie Appleseed, Baymard Institute (baymard.com)
Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
*/
(function($){
  var settings = {
    'sort': false,
    'sort-attr': 'data-priority',
    'sort-desc': false,
    'autoselect': true,
    'alternative-spellings': true,
    'alternative-spellings-attr': 'data-alternative-spellings',
    'remove-valueless-options': true,
    'copy-attributes-to-text-field': true,
    'autocomplete-plugin': 'jquery_ui',
    'relevancy-sorting': true,
    'relevancy-sorting-partial-match-value': 1,
    'relevancy-sorting-strict-match-value': 5,
    'relevancy-sorting-booster-attr': 'data-relevancy-booster',
    'minLength': 0,
	  'delay': 0,
    'autoFocus': true,
    handle_invalid_input: function( context ) {
      var selected_finder = 'option:selected:first';
      if ( context.settings['remove-valueless-options'] ) {
        selected_finder = 'option:selected[value!=""]:first';
      }
      context.$text_field.val( context.$select_field.find( selected_finder ).text() );
    },
    handle_select_field: function( $select_field ) {
      return $select_field.hide();
    },
    insert_text_field: function( context ) {
      var $text_field = $( '<input type="text" data-initialized="true"></input>' );
      if ( settings['copy-attributes-to-text-field'] ) {
        var attrs = {};
        var raw_attrs = context.$select_field[0].attributes;
        for (var i=0; i < raw_attrs.length; i++) {
          var key = raw_attrs[i].nodeName;
          var value = raw_attrs[i].nodeValue;
          /*if ( key !== 'name' && key !== 'id' && typeof context.$select_field.attr(key) !== 'undefined' ) {
            attrs[key] = value;
          }*/
          //modificación para evitar confilcto con labelup @paradigma
          if ( key !== 'name' && typeof context.$select_field.attr(key) !== 'undefined' ) {
            attrs[key] = (key === 'id') ? value + "-clone" : value;
          }
        }
        $text_field.attr( attrs );
      }
      $text_field.blur(function() {
        var valid_values = context.$select_field.find('option').map(function(i, option) { return $(option).text(); });
        if ( ($.inArray($text_field.val(), valid_values) < 0) && typeof settings['handle_invalid_input'] === 'function' ) {
          settings['handle_invalid_input'](context);
        }
      });
      // give the input box the ability to select all text on mouse click
      if ( context.settings['autoselect'] ) {
         $text_field.click( function() {
             this.select();
            });
      }
      var selected_finder = 'option:selected:first';
      if ( context.settings['remove-valueless-options'] ) {
        selected_finder = 'option:selected[value!=""]:first';
      }
      return $text_field.val( context.$select_field.find( selected_finder ).text() )
        .insertAfter( context.$select_field );
    },
    extract_options: function( $select_field ) {
      var options = [];
      var $options = $select_field.find('option');
      var number_of_options = $options.length;

      // go over each option in the select tag
      $options.each(function(){
        var $option = $(this);
        var option = {
          'real-value': $option.attr('value'),
          'label': $option.text()
        }
        if ( settings['remove-valueless-options'] && option['real-value'] === '') {
          // skip options without a value
        } else {
          // prepare the 'matches' string which must be filtered on later
          option['matches'] = option['label'];
          var alternative_spellings = $option.attr( settings['alternative-spellings-attr'] );
          if ( alternative_spellings ) {
            option['matches'] += ' ' + alternative_spellings;
          }
          // give each option a weight paramter for sorting
          if ( settings['sort'] ) {
            var weight = parseInt( $option.attr( settings['sort-attr'] ), 10 );
            if ( weight ) {
              option['weight'] = weight;
            } else {
              option['weight'] = number_of_options;
            }
          }
          // add relevancy score
          if ( settings['relevancy-sorting'] ) {
            option['relevancy-score'] = 0;
            option['relevancy-score-booster'] = 1;
            var boost_by = parseFloat( $option.attr( settings['relevancy-sorting-booster-attr'] ) );
            if ( boost_by ) {
              option['relevancy-score-booster'] = boost_by;
            }
          }
          // add option to combined array
          options.push( option );
        }
      });
      // sort the options based on weight
      if ( settings['sort'] ) {
        if ( settings['sort-desc'] ) {
          options.sort( function( a, b ) { return b['weight'] - a['weight']; } );
        } else {
          options.sort( function( a, b ) { return a['weight'] - b['weight']; } );
        }
      }

      // return the set of options, each with the following attributes: real-value, label, matches, weight (optional)
      return options;
    }
  };

  var public_methods = {
    init: function( customizations ) {

      if ( /msie/.test(navigator.userAgent.toLowerCase()) && parseInt(navigator.appVersion,10) <= 6) {

        return this;

      } else {

        settings = $.extend( settings, customizations );

        return this.each(function(){
          var $select_field = $(this);

          if(!$select_field.attr("data-initialized")) {

            var context = {
              '$select_field': $select_field,
              'options': settings['extract_options']( $select_field ),
              'settings': settings
            };

            context['$text_field'] = settings['insert_text_field']( context );

            settings['handle_select_field']( $select_field );

            if ( typeof settings['autocomplete-plugin'] === 'string' ) {
              adapters[settings['autocomplete-plugin']]( context );
            } else {
              settings['autocomplete-plugin']( context );
            }

            $select_field.attr("data-initialized", true);
          }
        });

      }

    }
  };

  var adapters = {
    jquery_ui: function( context ) {
      // loose matching of search terms
      var filter_options = function( term ) {
        var split_term = term.split(' ');
        var matchers = [];
        for (var i=0; i < split_term.length; i++) {
          if ( split_term[i].length > 0 ) {
            var matcher = {};
            matcher['partial'] = new RegExp( $.ui.autocomplete.escapeRegex( split_term[i] ), "i" );
            if ( context.settings['relevancy-sorting'] ) {
              matcher['strict'] = new RegExp( "^" + $.ui.autocomplete.escapeRegex( split_term[i] ), "i" );
            }
            matchers.push( matcher );
          }
        };

        return $.grep( context.options, function( option ) {
          var partial_matches = 0;
          if ( context.settings['relevancy-sorting'] ) {
            var strict_match = false;
            var split_option_matches = option.matches.split(' ');
          }
          for ( var i=0; i < matchers.length; i++ ) {
            if ( matchers[i]['partial'].test( option.matches ) ) {
              partial_matches++;
            }
            if ( context.settings['relevancy-sorting'] ) {
              for (var q=0; q < split_option_matches.length; q++) {
                if ( matchers[i]['strict'].test( split_option_matches[q] ) ) {
                  strict_match = true;
                  break;
                }
              };
            }
          };
          if ( context.settings['relevancy-sorting'] ) {
            var option_score = 0;
            option_score += partial_matches * context.settings['relevancy-sorting-partial-match-value'];
            if ( strict_match ) {
              option_score += context.settings['relevancy-sorting-strict-match-value'];
            }
            option_score = option_score * option['relevancy-score-booster'];
            option['relevancy-score'] = option_score;
          }
          return (!term || matchers.length === partial_matches );
        });
      }
      // update the select field value using either selected option or current input in the text field
      var update_select_value = function( option ) {
        if ( option ) {
          if ( context.$select_field.val() !== option['real-value'] ) {
            context.$select_field.val( option['real-value'] );
            context.$select_field.change();
          }
        } else {
          var option_name = context.$text_field.val().toLowerCase();
          var matching_option = { 'real-value': false };
          for (var i=0; i < context.options.length; i++) {
            if ( option_name === context.options[i]['label'].toLowerCase() ) {
              matching_option = context.options[i];
              break;
            }
          };
          if ( context.$select_field.val() !== matching_option['real-value'] ) {
            context.$select_field.val( matching_option['real-value'] || '' );
            context.$select_field.change();
          }
          if ( matching_option['real-value'] ) {
            context.$text_field.val( matching_option['label'] );
          }
          if ( typeof context.settings['handle_invalid_input'] === 'function' && context.$select_field.val() === '' ) {
            context.settings['handle_invalid_input']( context );
          }
        }
      }
      // jQuery UI autocomplete settings & behavior
      context.$text_field.autocomplete({
        'minLength': context.settings['minLength'],
        'delay': context.settings['delay'],
        'autoFocus': context.settings['autoFocus'],
        source: function( request, response ) {
          var filtered_options = filter_options( request.term );
          if ( context.settings['relevancy-sorting'] ) {
            filtered_options = filtered_options.sort( function( a, b ) {
            	if (b['relevancy-score'] == a['relevancy-score']) {
            		return b['label'] < a['label'] ? 1 : -1;
            	} else {
            		return b['relevancy-score'] - a['relevancy-score'];
            	}
            } );
          }
          response( filtered_options );
        },
        select: function( event, ui ) {
          update_select_value( ui.item );
        },
        change: function( event, ui ) {
          update_select_value( ui.item );
        }
      });
      // force refresh value of select field when form is submitted
      context.$text_field.parents('form:first').submit(function(){
        update_select_value();
      });
      // select current value
      update_select_value();
    }
  };

  $.fn.selectToAutocomplete = function( method ) {
    if ( public_methods[method] ) {
      return public_methods[ method ].apply( this, Array.prototype.slice.call( arguments, 1 ));
    } else if ( typeof method === 'object' || ! method ) {
      return public_methods.init.apply( this, arguments );
    } else {
      $.error( 'Method ' +  method + ' does not exist on jQuery.fn.selectToAutocomplete' );
    }
  };

})(jQuery); 

/**
 * @description funcionalidad de menus para moviles
 */
var offCanvas = (function() {
    var $html = $("html");
    var $body = $("body");
    var $canvasWrap = $('.canvas-wrap');
    var $offCanvas = $('.off-canvas');

    /**
     * @description - set the chaptcha image challenge position centered in the window
     * @param {string} position of the div container of chaptcha image challenge (absolute or fixed)
     */
    function _setChaptchaChallengePosition(position) {
      var $challenges = $("[title='recaptcha challenge']");
      $challenges.each(function() {
        var $this = $(this);
        var $parent = $this.parent(); 
        var $ancestor = $this.parent().parent();
        //$ancestor.css("position", position);
        if(position === "fixed") {
          //$ancestor.addClass("center-challenge2");
          $parent.addClass("center-img-challenge");
        } else {
          //$ancestor.removeClass("center-challenge2");
          $parent.removeClass("center-img-challenge");
        }
      });
    }

    function _closeCanvas() {
        if ($body.hasClass('in')) {
            //Cerramos todos los que haya abiertos
            $('.off-canvas').removeClass('out');

            //Abrimos el seleccionado.
            $body.removeClass('in').css({'position': 'relative'}).addClass('out');
            $html.removeClass('in').css({'position': 'relative'}).addClass('out');

            $canvasWrap.hide();

            setTimeout(function () {
                $body.removeClass('out left right');
                $html.removeClass('out left right');
            }, 50);

            //quitamos el fixed del captcha
            _setChaptchaChallengePosition("absolute");
        }
    }

    function _toggleNavbar() {
        var $this = $(this);
        var $canvasTarget = $($this.attr('data-target'));
        var dataSide = $this.attr('data-side');

        //Indicamos en la capa la dirección para cerrarla después
        $canvasWrap.addClass(dataSide);

        //Si el target tiene .out esta abierto, asi que lo cerramos...
        if ( $canvasTarget.hasClass('out') ){
            _closeCanvas();
        } else {
            //Cerramos todos los que haya abiertos
            $offCanvas.removeClass('out');

            //Abrimos el seleccionado.
            //$body.addClass('in').css('position','fixed').removeClass('left right').addClass(dataSide);
            $body.addClass('in').css('position','relative').removeClass('left right').addClass(dataSide);
            $html.addClass('in').removeClass('left right').addClass(dataSide);
            $canvasTarget.addClass('out');
            $canvasWrap.show().css('height', '100%');

            //ponemos el captcha fixed
            _setChaptchaChallengePosition("fixed");
        }
    }

    function toggleNavbarOnBodyClick(e) {
        var $this = $(this);
            //outerWidth
            var hcanvas;
            var lcanvas;
            if($("#off-canvas-left-mob:visible").length > 0) {
              hcanvas = $("#off-canvas-left-mob").outerWidth();
            } else {
              hcanvas = $("#off-canvas-menuLeft").outerWidth();
            }
            if($("#off-canvas-right-mob:visible").length > 0) {
              lcanvas = $("#off-canvas-right-mob").outerWidth();
            } else {
              lcanvas = $("#off-canvas-right").outerWidth();
            }
            if ($this.hasClass('in') && $this.hasClass('left')) {
                if (e.pageX > hcanvas){
                    $('.navbar-toggle:visible[data-side="left"]').trigger('click');
                }
            }

            if ($this.hasClass('in') && $this.hasClass('right')) {
                var margen = parseInt($(window).width(),10) - lcanvas;
                if (e.pageX < margen){
                    $('.navbar-toggle:visible[data-side="right"]').trigger('click');
                }
            }
    }

    function init() {
        //si pulsamos fuera del menu, cerramos
        $body.on("click touchend", toggleNavbarOnBodyClick);

        //botones menu hamburguesa y telefono (al pulsar muestran su menu lateral);
        $('button.navbar-toggle').on("click", _toggleNavbar);

        $('.canvas-wrap').click('click touchend', _closeCanvas);
        $('.off-canvas [data-toggle="close"]').click('click touchend', _closeCanvas);

        $(window).on("resize", function() {
          if(globalConfig.windowWidth > globalConfig.smBreak) {
            _setChaptchaChallengePosition("absolute");
    }
        });
    }

    // PUBLIC API
    return {
      init: init
    };

})();



$(function() {
  offCanvas.init();
});

;(function($) {
 
  /**
  * @description Paginates displayed info by hidding/showing children of the provided selector

  * @param {number}  itemsPerPage    - number of items to show per page
  * @param {boolean} showPrevNext    - Show the Previous and/or Next arrow icons
  * @param {boolean} hidePageNumbers - Hides the numer of the page
  * @param {string} paginateElement  - selector of the element to be paginated (contains the items)
  * @param {string} prevLinkText     - text to apply to prev page button
  * @param {string} nextLinkText     - text to apply to next page button
  */
  $.paginateMe = function(element, options) { 
    var defaults = {
      itemsPerPage: 5,
      showPrevNext: true,
      hidePageNumbers: false,
      paginateElement: ".paginate",
      prevLinkText: "Previous",
      nextLinkText: "Next"
    };

    var plugin = this;

    var $element = $(element),
        element = element;

    var $elementToPaginate = null;

    var pagination = {
      $container: null,
      $prev: null,
      $next: null,
      $pages: null
    };

    var config = {
      items: null,
      itemsNumber: 0,
      pages: 0,
      currentPage: 1
    };

    plugin.settings = {};

    plugin.init = function() {
      plugin.settings = $.extend({}, defaults, options);

      $elementToPaginate = $element.find(`${plugin.settings.paginateElement}`);
      config = {
        items: $elementToPaginate.children(),
        get itemsNumber() {
          return this.items.size();
        },
        get pages() {
          return Math.ceil(this.itemsNumber / plugin.settings.itemsPerPage);
        },
        currentPage: 0
      };
      
      _buildPagination();

      pagination.$pages.click(function(ev) {
        var $this = $(this);
        var selectedPage = $this.data("page") - 1;
        ev.preventDefault();
        $element.trigger("pg.init");
        if(!$this.hasClass("active")) {
          _goToPage(selectedPage);
        }
      });

      pagination.$prev.click(_goToPreviousPage);
      pagination.$next.click(_goToNextPage);

      //realizmos la paginación a la primera página
      pagination.$pages.eq(0).trigger("click");
    };


    //TODO: hacer un destroy para el plugin y un refresh

    /*plugin.foo_public_method = function() {
      // code goes here
    };*/

    var _goToPage = function(selectedPage) {
      const startAt = selectedPage * plugin.settings.itemsPerPage;
      const endOn = startAt + plugin.settings.itemsPerPage;
      config.currentPage = selectedPage;
      config.items.hide().slice(startAt, endOn).show();
      //pagination.$prev.toggle(selectedPage >= 1);
      pagination.$prev.toggleClass("disabled", selectedPage < 1);
      //pagination.$next.toggle(selectedPage < (config.pages - 1));
      pagination.$next.toggleClass("disabled", selectedPage >= (config.pages - 1));
      pagination.$pages.removeClass("active").eq(selectedPage).addClass("active");
      $element.trigger("pg.end");
    };

    var _goToPreviousPage = function(ev) {
      ev.preventDefault();
      if (config.currentPage > 0) {
        _goToPage(config.currentPage - 1);
      }

    };
    var _goToNextPage = function(ev) {
      ev.preventDefault();
      if (config.currentPage < (config.pages - 1)) {
        _goToPage(config.currentPage + 1);
      }
    };

    var _buildPagination = function() {
      pagination.$container = $(`<div class="m-pagination"><ul class="pagination">${_getPrevNexButton("prev")}${_getPagesButtons()}${_getPrevNexButton("next")}</ul></div>`);
      pagination.$prev = pagination.$container.find(".prev-link");
      pagination.$next = pagination.$container.find(".next-link");
      pagination.$pages = pagination.$container.find(".page-link");
      $element.append(pagination.$container);
    };

    var _getPrevNexButton = function(type) {
      var template = "";
      if (plugin.settings.showPrevNext) {
        template = `<li><a href="#" role="button" class="${type}-link"><span aria-hidden="true">${plugin.settings[type + "LinkText"]}</span></a></li>`;
        //template = `<li><a href="#" role="button" class="${type}-link"><span class="nh-ic-chevron" aria-hidden="true"></span></a></li>`;
      }

      return template;
    };

    var _getPagesButtons = function() {
      var template = "";
      if(plugin.settings.hidePageNumbers === false) {
        for(let x = 0; x < config.pages; x++) {
          template += `<li><a href="#" role="button" class="page-link" data-page="${x + 1}" aria-label="Página ${x + 1}">${x + 1}</a></li>`;
        } 
      }
      return template;
    };

    plugin.init();
  };
 
  $.fn.paginateMe = function(options) {
    return this.each(function() {
      if (undefined == $(this).data('paginateMe')) {
        var plugin = new $.paginateMe(this, options);
        $(this).data('paginateMe', plugin);
      }
    });
  };

  //esto es para inicializar elementos con paginación automaticamente. Solo se da un caso en el dxa-uikit.
  globalConfig.elements.$paginateElements.paginateMe();
 
})(jQuery);

/**
 * @description Paginates displayed info by hidding/showing children of the provided selector

 * @param {string}  pagerSelector  - The selector for <UL> tag containing the clickable pages (one <LI> per page). Default if not provided: $(".pager")
 * @param {boolean} showPrevNext - Show the Previous and/or Next arrow icons
 * @param {boolean} hidePageNumbers - Hides the numer of the page
 * @param {integer} hidePageNumbers - Number of elements to show in each page
 */
/*
$.fn.pageMe = function(opts) {
  var $this = this, defaults = {
      perPage: 5,
      showPrevNext: false,
      hidePageNumbers: false
  }, settings = $.extend(defaults, opts);
  var listElement = $this;
  var perPage = settings.perPage;
  var children = listElement.children();
  var pager = $(".pager");
  if (typeof settings.childSelector != "undefined") {
      children = listElement.find(settings.childSelector);
  }
  if (typeof settings.pagerSelector != "undefined") {
      pager = $(settings.pagerSelector);
  }
  var numItems = children.size();
  var numPages = Math.ceil(numItems / perPage);
  pager.data("curr", 0);
  if (settings.showPrevNext) {
      $('<li><a href="#" role="button" class="prev-link"><span aria-hidden="true">Anterior</span></a></li>').appendTo(pager);
  }
  var curr = 0;
  while (numPages > curr && settings.hidePageNumbers == false) {
      $(`<li><a href="#" role="button" class="page-link"
        ${(function(){
          let liItem = (curr === 0 )? ('aria-selected="true" aria-label="Página 1">' + (curr+1) + '</a></li>') : 'aria-label="Página " + ' + (curr+1) + '>' + (curr+1) + '</a></li>';
          return liItem;
      })()}`).appendTo(pager);
      curr++;
  }
  if (settings.showPrevNext) {
      $('<li><a href="#" role="button" class="next-link"><span aria-hidden="true">Siguiente</span></a></li>').appendTo(pager);
  }
  pager.find(".page-link:first").addClass("active");
  pager.find(".prev-link").hide();
  if (numPages <= 1) {
      pager.find(".next-link").hide();
  }
  pager.children().eq(1).addClass("active");
  children.hide();
  children.slice(0, perPage).show();
  pager.find("li .page-link").click(function() {
      var clickedPage = $(this).html().valueOf() - 1;
      goTo(clickedPage, perPage);
      return false;
  });
  pager.find("li .prev-link").click(function() {
      previous();
      return false;
  });
  pager.find("li .next-link").click(function() {
      next();
      return false;
  });
  function previous() {
      var goToPage = parseInt(pager.data("curr")) - 1;
      goTo(goToPage);
  }
  function next() {
      var goToPage = parseInt(pager.data("curr")) + 1;
      goTo(goToPage);
  }
  function goTo(page) {
      var startAt = page * perPage, endOn = startAt + perPage;
      children.css("display", "none").slice(startAt, endOn).show();
      if (page >= 1) {
          pager.find(".prev-link").show();
      } else {
          pager.find(".prev-link").hide();
      }
      if (page < numPages - 1) {
          pager.find(".next-link").show();
      } else {
          pager.find(".next-link").hide();
      }
      pager.data("curr", page);
      pager.children().removeClass("active");
      pager.children().eq(page + 1).addClass("active");
      if ($(".card-columns").length) {
          var $cardGrid = $(".card-columns").masonry({
              itemSelector: ".card",
              columnWidth: ".card",
              gutter: ".gutter-sizer",
              percentPosition: true,
              transitionDuration: "0.3s"
          });
      }
  }
  if ($(".card-columns").length) {
      var $cardGrid = $(".card-columns").not("hide").masonry({
          itemSelector: ".card",
          columnWidth: ".card",
          gutter: ".gutter-sizer",
          percentPosition: true,
          transitionDuration: "0.3s"
      });
  }
};

*/

// IMPORTANTE
// Este js ha sido modificado para suprimir las animaciones ya que cuando se establecía
// monthChangeAnimation como false los calendarios dejaban de funcionar.
// Para suprimirlos se han comentado los if correspondientes a monthChangeAnimation
//Puesto rotate a 0 para que no haga la animación, no es posible realizarlo mediante la opción monthChangeAnimation

// Generated by CoffeeScript 1.6.1

/*!
  # Responsive Celendar widget script
  # by w3widgets
  # Author: Lukasz Kokoszkiewicz
  #
  # Copyright © w3widgets 2013 All Rights Reserved
*/

function getCurrentDate() {
  var currentDate = {
    date: new Date(),
    year: null,
    month: null
  }

  currentDate.year = currentDate.date.getFullYear();
  currentDate.month = currentDate.date.getMonth();

  return currentDate;
}

function isNavigateToPastDatesAllowed(selectedMonth, selectedYear, isPastCalendar) {
  var currentDate = getCurrentDate();
  var allowed = false;

  if(isPastCalendar) {
    allowed = true;
  } else if (selectedYear > currentDate.year) {
    allowed = true;
  } else if(selectedYear === currentDate.year && selectedMonth >= currentDate.month) {
    allowed = true;
  }

  return allowed;
} 

function isNavigateToFutureDatesAllowed(selectedMonth, selectedYear, isPastCalendar) {
  var currentDate = getCurrentDate();
  var allowed = true;
  
  if (selectedYear > currentDate.year && isPastCalendar) {
    allowed = false;
  } else if (selectedYear === currentDate.year && selectedMonth >= currentDate.month && isPastCalendar) {
    allowed = false;
  }

  return allowed;
}

function togglePrevButton(month, year, isPastCalendar, prevButton) {
  var enableButton;
  var previousMonth = month - 1;
  var selectedYear = year;

  if (previousMonth < 0) {
    selectedYear = year - 1;
    previousMonth = 11;
  } else {
    previousMonth = month - 1;
  } 

  enableButton = isNavigateToPastDatesAllowed(previousMonth, selectedYear, isPastCalendar);
  prevButton.toggleClass("disabled", !enableButton);
}

function toggleNextButton(month, year, isPastCalendar, nextButton) {
  var enableButton = isNavigateToFutureDatesAllowed(month, year, isPastCalendar);
  nextButton.toggleClass("disabled", !enableButton);
}


function toggleNavigationButtons(data) {
  console.log("data", data);
  togglePrevButton(data.currentMonth, data.currentYear, data.isPastCalendar, data.prevButton);
  toggleNextButton(data.currentMonth, data.currentYear, data.isPastCalendar, data.nextButton);
}


// -----------------------------------------------------------------------------
// Limpia los rangos de un calendario
// Parámetros:
//		cal (string): 			id del calendario en el que se encuentra la fecha
// -----------------------------------------------------------------------------
function resetRanges(cal) {
	cal.find(".range-start").removeClass("range-start");
	cal.find(".range-end").removeClass("range-end");
	cal.find(".range-in").removeClass("range-in");
}
	
//Funcion para llamar a data atributes y pintar el rango
function batchPaintRange(cal) {
	resetRanges(cal);
		
	if(cal.attr("data-range-start") && cal.attr("data-range-start")!="" && cal.attr("data-range-end") && cal.attr("data-range-end")!="") {
		var rangeStart = parseInt(cal.attr("data-range-start"));
		var rangeEnd = parseInt(cal.attr("data-range-end"));
			
		var dateStart = moment(rangeStart);
		var dateEnd = moment(rangeEnd);	
			
		cal.find('[data-day="'+dateStart.date()+'"][data-month="'+(dateStart.month()+1)+'"][data-year="'+dateStart.year()+'"]').addClass("range-start");
		cal.find('[data-day='+dateEnd.date()+'][data-month='+(dateEnd.month()+1)+'][data-year='+dateEnd.year()+']').addClass("range-end");
			
		while(!dateStart.isAfter(dateEnd)) {
			var currentDay = cal.find('[data-day='+dateStart.date()+'][data-month='+(dateStart.month()+1)+'][data-year='+dateStart.year()+']');
			if(!currentDay.hasClass("range-start") && !currentDay.hasClass("range-end")) {
				currentDay.addClass("range-in");
			}
			dateStart.add(1, 'day');
		}
	} else {
		if (cal.attr("data-range-start") && cal.attr("data-range-start")!="") {
			
			var rangeStart = parseInt(cal.attr("data-range-start"));
			var dateStart = moment(rangeStart);
			cal.find('[data-day='+dateStart.date()+'][data-month='+(dateStart.month()+1)+'][data-year='+dateStart.year()+']').addClass("range-start");
			
		} else {
			
			var rangeEnd = parseInt(cal.attr("data-range-end"));
			var dateEnd = moment(rangeEnd);	
			cal.find('[data-day='+dateEnd.date()+'][data-month='+(dateEnd.month()+1)+'][data-year='+dateEnd.year()+']').addClass("range-end");
				
		}
	}

}

function applyCurrentDay(){
	var now = new Date();
	$('[data-day='+parseInt(now.getDate())+'][data-month='+parseInt(now.getMonth()+1)+'][data-year='+now.getFullYear()+']').addClass("currentDay");
}

function shadowDays(){
	var diasMes = $(".myDay");
	var now = new Date();
	var day = now.getDate();
	var month = now.getMonth();
	month++;
	var year = now.getFullYear();
	var hoy = new Date(year, month - 1, day);
	
	var one_day=1000*60*60*24;
	
	//$("#fecha").val('Fecha a partir de: '+day+'-'+month+'-'+year);
	
	for (var i=0;i<diasMes.length;i++){
		var diaSel = parseInt($(diasMes[i]).attr("data-day"),10);
		var mesSel = parseInt($(diasMes[i]).attr("data-month"),10);
		var anioSel = parseInt($(diasMes[i]).attr("data-year"),10);
		
		var myDay = new Date(anioSel, mesSel - 1, diaSel);
		
		var diferencia = Math.floor((myDay.getTime()-hoy.getTime())/(one_day));
		
		if(diferencia < 0){
			$(diasMes[i]).addClass("shadow");
			$(diasMes[i]).attr("onclick","");
		}
	}
}

	// -----------------------------------------------------------------------------
	// Determina si un día es válido
	// -----------------------------------------------------------------------------
	// No es válido si:
	//		- Se trata de un día pasado
	//		- Se ha deshabilitado ese día (clase disabled-date)
	function isValidDay(obj){
		var valid = false;
		if(!obj.parent(".day").hasClass("past") && !obj.hasClass("disabled-date")) { 
			valid=true; 
		}
		return valid;
	}




	// -----------------------------------------------------------------------------
	// Calendario de rango: Gestión de click en un día
	// -----------------------------------------------------------------------------
	function rangeSelectDay(obj){
		// Input/s en los que vamos a introducir la/s fecha/s seleccionada/s en formato string
		var dateInput = obj.closest(".responsive-calendar-wrap").attr("data-date-input");
		var dateInputStart = obj.closest(".responsive-calendar").attr("data-date-input-from");
		var dateInputEnd = obj.closest(".responsive-calendar").attr("data-date-input-to");
		// Tipo de input (inicio o fin de rango)
		var rangeType = obj.closest(".responsive-calendar-wrap").attr("data-range-type");
		// Calendario actual
		var curCalendar = obj.closest(".responsive-calendar-wrap");
		// Calendario inicio
		var curCalendarIn = $($(obj.closest(".responsive-calendar").attr("data-date-input-from")).attr("data-calendar"));
		// Calendario fin
		var curCalendarOut = $($(obj.closest(".responsive-calendar").attr("data-date-input-to")).attr("data-calendar"));
		// Número mínimo de noches seleccionable
		var minDays = obj.closest(".responsive-calendar").attr("data-min-nights") || 1;
		// Número máximo de noches seleccionables
		var maxDays = obj.closest(".responsive-calendar").attr("data-max-nights") || 99;
		
		var errNights = obj.closest(".responsive-calendar").attr("data-error-nights");
		
		var errBlacks = obj.closest(".responsive-calendar").attr("data-error-blackout");
		
		// Fechas válidas (inicio/fin) de haberlas
		var initRange = obj.closest(".responsive-calendar").attr("data-first-valid-date");
		var endRange = obj.closest(".responsive-calendar").attr("data-last-valid-date");
		if(initRange && endRange) {
			initRange = initRange.split("/");
			endRange = endRange.split("/");
			var objInitRange = moment({ year : parseInt(initRange[2]), month : parseInt(initRange[1])-1, day :  parseInt(initRange[0])});
			var objEndRange = moment({ year : parseInt(endRange[2]), month : parseInt(endRange[1])-1, day :  parseInt(endRange[0])});
			var rangeNights = objEndRange.diff(objInitRange, 'days');
			if (rangeNights < minDays) {
				minDays = rangeNights;
			}
		}

		// Fecha actual 
		var gDay = obj.attr("data-day");
		var gMonth = obj.attr("data-month");
		var gYear = obj.attr("data-year");
		
		// Fecha string formato DD/MM/YYYY
		var selectedDate = fillZeros(gDay,2,"left")+"/"+fillZeros(gMonth,2,"left")+"/"+gYear;
		
		// Moment de la fecha actual
		var currentDate = moment({ year : gYear, month : (gMonth-1), day : gDay});	
		
		// Moment de hoy
		var todayDate = moment();	
		
		// Almacenará el número de días de diferencia entre 2 fechas
		var numDays = 0;
		
		// Variable que contiene temporalmente una fecha
		var newDate;
		
		// Marca el día seleccionado en función de si es inicio/fin de rango
		curCalendar.find(".selected-day").removeClass("selected-day");
		
		
		// Si es INICIO de rango
		if(rangeType=="start") {
			
			// Si hay final de rango
			if(curCalendar.attr("data-range-end") && curCalendar.attr("data-range-end")!="") {
								
				// Se comprueba si el día de inicio es menor que el de fin de rango
				// En caso contrario se reestablece el fin de rango al día siguiente del nuevo inicio escogido
				var currentEnd = moment(parseInt(curCalendar.attr("data-range-end")));
				
				// Obtenemos el número de días que hay entre la fecha de inicio y la fecha seleccionada
				if (!validateBlackOuts(currentDate,currentEnd)){
					
					
					$('#error-modal').modal();
					return false;
				}
				numDays = currentEnd.diff(currentDate, 'days');
				if (numDays > parseInt(maxDays,10)){
					$('#error-modal').modal();
					return false;
				}
				
				// Si la fecha de inicio seleccionada está después de la fecha de fin
				if(currentDate.isAfter(currentEnd)){	
					// Si hay establecidas un rango de fechas válidas se establece como fin la primera fecha válida en base al número mínimo de noches
					if(initRange && endRange) {
						currentDate.add(minDays, 'day');
						if(!currentDate.isAfter(objEndRange)) {
							currentDate.subtract(minDays, 'day');
							updateDate(curCalendarIn,curCalendarOut,currentDate,"range-start",dateInputStart);
							curCalendarIn.attr("data-range-start",currentDate);
							curCalendarOut.attr("data-range-start",currentDate);
							currentDate.add(minDays, 'day');
							updateDate(curCalendarIn,curCalendarOut,currentDate,"range-end",dateInputEnd);
							curCalendarIn.attr("data-range-end",currentDate);
							curCalendarOut.attr("data-range-end",currentDate);						
						}
					} else {
						updateDate(curCalendarIn,curCalendarOut,currentDate,"range-start",dateInputStart);
						curCalendarIn.attr("data-range-start",currentDate);
						curCalendarOut.attr("data-range-start",currentDate);
						currentDate.add(minDays, 'day');
						updateDate(curCalendarIn,curCalendarOut,currentDate,"range-end",dateInputEnd);
						curCalendarIn.attr("data-range-end",currentDate);
						curCalendarOut.attr("data-range-end",currentDate);
					}
					
				} else {
					// Si la fecha de inicio seleccionada está antes de la fecha de fin
					// Se establece la fecha de inicio
					
					// Si hay establecidas un rango de fechas válidas se establece como inicio la primera fecha válida
					if(initRange && endRange) {
						currentDate.add(minDays, 'day');
					
						if(currentDate.isAfter(objEndRange)) {	
							updateDate(curCalendarIn,curCalendarOut,objEndRange,"range-end",dateInputEnd);
							curCalendarIn.attr("data-range-end",objEndRange);
							curCalendarOut.attr("data-range-end",objEndRange);
							objEndRange.subtract(minDays, 'day');
							updateDate(curCalendarIn,curCalendarOut,objEndRange,"range-start",dateInputStart);
							curCalendarIn.attr("data-range-start",objEndRange);
							curCalendarOut.attr("data-range-start",objEndRange);
						} else {
							currentDate.subtract(minDays, 'day');
							updateDate(curCalendarIn,curCalendarOut,currentDate,"range-start",dateInputStart);
							curCalendarIn.attr("data-range-start",currentDate);
							curCalendarOut.attr("data-range-start",currentDate);
							numDays = currentEnd.diff(currentDate, 'days');
							// Se comprueba si se respeta el número mínimo de días
							if(numDays<minDays) {
								// Si no es así se reasigna la fecha de fin
								currentDate.add(minDays, 'day');
								updateDate(curCalendarIn,curCalendarOut,currentDate,"range-end",dateInputEnd);
								curCalendarIn.attr("data-range-end",currentDate);
								curCalendarOut.attr("data-range-end",currentDate);
							} 
						}
					} else {
						updateDate(curCalendarIn,curCalendarOut,currentDate,"range-start",dateInputStart);
						curCalendarIn.attr("data-range-start",currentDate);
						curCalendarOut.attr("data-range-start",currentDate);
						// Se comprueba si se respeta el número mínimo de días
						if(numDays<minDays) {
							// Si no es así se reasigna la fecha de fin
							currentDate.add(minDays, 'day');
							updateDate(curCalendarIn,curCalendarOut,currentDate,"range-end",dateInputEnd);
							curCalendarIn.attr("data-range-end",currentDate);
							curCalendarOut.attr("data-range-end",currentDate);

						} 
					}
					
					
				}
			} else {
				
				updateDate(curCalendarIn,curCalendarOut,currentDate,"range-start",dateInputStart);
				curCalendarIn.attr("data-range-start",currentDate);
				curCalendarOut.attr("data-range-start",currentDate);
				currentDate.add(minDays, 'day');
				updateDate(curCalendarIn,curCalendarOut,currentDate,"range-end",dateInputEnd);
				curCalendarIn.attr("data-range-end",currentDate);
				curCalendarOut.attr("data-range-end",currentDate);
				
			}
			
		} else {
			
			// Si hay inicio de rango ES FINAL DE RANGO
			if(curCalendar.attr("data-range-start") && curCalendar.attr("data-range-start")!="") {
				
				// Si lo hay se comprueba si el día de inicio es menor que el de fin de rango
				// En caso contrario se reestablece el inicio de rango al día anterior del nuevo fin escogido
				var currentStart = moment(parseInt(curCalendar.attr("data-range-start")));
				
				// Obtenemos el número de días que hay entre la fecha de inicio y la fecha seleccionada
				numDays = currentDate.diff(currentStart, 'days');

				if (!validateBlackOuts(currentStart,currentDate)){
					
					$('#error-modal').modal();
					return false;					
				}
				if (numDays > parseInt(maxDays,10)){
					
					$('#error-modal').modal();
					return false;
				}
				
				if(currentDate.isBefore(currentStart)){
					// Para establecer un nuevo inicio comprobamos si se respeta el número mínimo de días
					currentDate.subtract(minDays, 'day');
					
					// Si están especificadas unas fechas válidas se tiene en cuenta la primera fecha válida
					if(initRange && endRange) {
						todayDate = objInitRange;
					}
					
					if(currentDate.isBefore(todayDate)) {
						// Si la fecha seleccionada - el número mínimo de días no se puede seleccionar (pasado)
						// recalcula inicio (hoy) y fin (hoy + mínimo de días)
						updateDate(curCalendarIn,curCalendarOut,todayDate,"range-start",dateInputStart);
						curCalendarIn.attr("data-range-start",todayDate);
						curCalendarOut.attr("data-range-start",todayDate);
						todayDate.add(minDays, 'day');
						updateDate(curCalendarIn,curCalendarOut,todayDate,"range-end",dateInputEnd);
						curCalendarIn.attr("data-range-end",todayDate);
						curCalendarOut.attr("data-range-end",todayDate);
					} else {
						// Si hay días suficientes hacia atrás 
						// Se establece la fecha seleccionada como fecha de fin y la de inicio como "fin - mínimo de días"
						currentDate.add(minDays, 'day');
						updateDate(curCalendarIn,curCalendarOut,currentDate,"range-end",dateInputEnd);
						curCalendarIn.attr("data-range-end",currentDate);
						curCalendarOut.attr("data-range-end",currentDate);
						currentDate.subtract(minDays, 'day');
						updateDate(curCalendarIn,curCalendarOut,currentDate,"range-start",dateInputStart);
						curCalendarIn.attr("data-range-start",currentDate);
						curCalendarOut.attr("data-range-start",currentDate);
					}
						
					
				} else {
					// Si se da la condición de número mínimo de días
					// Si hay definido rango de fechas válidas
					if(initRange && endRange) {
						// Si nos pasamos de la fecha fin válida establecemos la fecha fin como la fecha fin válida
						// Y la de inicio como la fecha fin válida - número mínimo de noches
						currentDate.subtract(minDays, 'day');
						if(currentDate.isBefore(objInitRange)) {
							updateDate(curCalendarIn,curCalendarOut,objInitRange,"range-start",dateInputStart);
							curCalendarIn.attr("data-range-start",objInitRange);
							curCalendarOut.attr("data-range-start",objInitRange);
							objInitRange.add(minDays, 'day');
							updateDate(curCalendarIn,curCalendarOut,objInitRange,"range-end",dateInputEnd);
							curCalendarIn.attr("data-range-end",objInitRange);
							curCalendarOut.attr("data-range-end",objInitRange);
							
						} else {
							currentDate.add(minDays, 'day');
							if(numDays>=minDays) {
								updateDate(curCalendarIn,curCalendarOut,currentDate,"range-end",dateInputEnd);
								curCalendarIn.attr("data-range-end",currentDate);
								curCalendarOut.attr("data-range-end",currentDate);
							} else {
								// Sino se autoselecciona la siguiente fecha que cumpla el número mínimo de días
								currentStart.add(minDays, 'day');
								updateDate(curCalendarIn,curCalendarOut,currentStart,"range-end",dateInputEnd);
								curCalendarIn.attr("data-range-end",currentStart);
								curCalendarOut.attr("data-range-end",currentStart);
							}
						}
					} else {
						if(numDays>=minDays) {
							updateDate(curCalendarIn,curCalendarOut,currentDate,"range-end",dateInputEnd);
							curCalendarIn.attr("data-range-end",currentDate);
							curCalendarOut.attr("data-range-end",currentDate);
						} else {
							// Sino se autoselecciona la siguiente fecha que cumpla el número mínimo de días
							currentStart.add(minDays, 'day');
							updateDate(curCalendarIn,curCalendarOut,currentStart,"range-end",dateInputEnd);
							curCalendarIn.attr("data-range-end",currentStart);
							curCalendarOut.attr("data-range-end",currentStart);
						}
					}
					
					
				}
			} else {
				// Si no hay inicio de rango establecemos la fecha seleccionada como la fecha fin de rango
				updateDate(curCalendarIn,curCalendarOut,currentDate,"range-end",dateInputEnd);
				curCalendarIn.attr("data-range-end",currentDate);
				curCalendarOut.attr("data-range-end",currentDate);
				
				//Se comprueba el mes seleccionado para posicionar el calendario de inicio de rango en el mismo
				var curEndDate = moment(parseInt(curCalendar.attr("data-range-end")));
				$(curCalendarIn).find('.responsive-calendar').responsiveCalendar(curEndDate.format('YYYY-MM'));
			
			}
		}
		
		// Añade la clase range-in a los días intermedios entre range-start y range-end
		paintRange(curCalendarIn);
		paintRange(curCalendarOut);
		
		// Cierra el calendario al seleccionar una fecha
		obj.closest(".responsive-calendar-wrap").removeClass("active");
		
		
	}


	//Validamos si hay un blackout entre dos fechas seleccionadas
	function validateBlackOuts(date1,date2){
		var blacks = getBlackOuts();
		for (i=0; i<blacks.length; i++){
			//operamos con fechas
			var ab = blacks[i].split("-");
			var black = moment(blacks[i]);
			if (moment(blacks[i]).isBetween(date1,date2)){
				return false;
			}
		}
		return true;
	}
	
	
	//Pintamos los Blackouts
	function paintBlackOuts(){
		//alert($('[data-day=26][data-month=10][data-year=2016]').html());
		var blacks = getBlackOuts();
		for (i=0; i<blacks.length; i++){
			var ab = blacks[i].split("-");
			var month = ab[1];
			$('[data-day='+ab[2]+'][data-month='+month+'][data-year='+ab[0]+']').parent().removeClass("future");
			//alert($('[data-day='+ab[2]+'][data-month='+ab[1]+'][data-year='+ab[0]+']').html());
			$('[data-day='+ab[2]+'][data-month='+month+'][data-year='+ab[0]+']').parent().addClass("past");	
		}
	}
	// Funcion que obtiene un array con todos los balckouts
	//En produccion su contenido debe ser reemplazado con un $ajax al servidor que devuelva la misma estructura de datos
	function getBlackOuts(){
		if(typeof(dateString) != "undefined"){ var aDates = dateString.split("*"); }
		else{ var aDates = ""; }
		return aDates;
	}
	
	
	// -----------------------------------------------------------------------------
	// Le asigna la clase dada a la fecha dada y actualiza el input dado
	// Parámetros:
	//		cal (string): 			id del calendario en el que se encuentra la fecha
	// 		currentDate (moment): 	fecha a actualizar
	//		newClass (string): 		clase que se le asignará a la fecha
	//		dateInput (string): 	id del input de la fecha (#dateInput)
	// -----------------------------------------------------------------------------
	function updateDate(calIn,calOut,currentDate,newClass,dateInput) {
		var day = currentDate.date();
		var month = (currentDate.month()+1);
		var year = currentDate.year();
		var inputYear = year.toString();
		
		// Añade la nueva clase a la fecha
		calIn.find('[data-day='+day+'][data-month='+month+'][data-year='+year+']').addClass(newClass);
		calOut.find('[data-day='+day+'][data-month='+month+'][data-year='+year+']').addClass(newClass);
		
		// Actualiza el input
		if($(dateInput).attr("data-short-year")) {
			inputYear = inputYear.substring(2, 4);
		}
		$(dateInput).val(fillZeros(day.toString(),2,"left")+"/"+fillZeros(month.toString(),2,"left")+"/"+inputYear).change();
	}

function paintRange(cal){
		// var diaIni = parseInt($("#diaLlegada").val(),10); var mesIni = parseInt($("#mesLlegada").val(),10); var anoIni = parseInt($("#anioLlegada").val(),10);
		// var diaFin = parseInt($("#diaSalida").val(),10); var mesFin = parseInt($("#mesSalida").val(),10); var anoFin = parseInt($("#anioSalida").val(),10);
		
		// 	var inicialb = new Date(anoIni, mesIni - 1, diaIni);
		// 	var inicialf = new Date(anoIni, mesIni - 1, diaIni);
		// 	var finalf = new Date(anoFin, mesFin - 1, diaFin);
		// 	//alert(inicialf + ' ' + finalf);
		// 	var diasSum = parseInt(1,10);
			
		// 	var one_day=1000*60*60*24;
			
		// 	var diferencia = Math.floor((finalf.getTime()-inicialf.getTime())/(one_day));		
			
		// 	while (diferencia > -1){
		// 		var trueMonth = inicialf.getMonth()+1;
		// 		$('[data-day='+inicialf.getDate()+'][data-month='+trueMonth+'][data-year='+inicialf.getFullYear()+']').attr("style","background-color:#e9efff;");
		// 		inicialf.setDate(inicialf.getDate() + 1);
		// 		diferencia--;
		// 	}
		// 	$('[data-day='+parseInt(inicialb.getDate())+'][data-month='+parseInt(inicialb.getMonth()+1)+'][data-year='+inicialb.getFullYear()+']').attr("style","background-color:#002a92; color:#fff;");
		// 	$('[data-day='+parseInt(finalf.getDate())+'][data-month='+parseInt(finalf.getMonth()+1)+'][data-year='+finalf.getFullYear()+']').attr("style","background-color:#002a92; color:#fff;");
	// var cal = $('#modal-check-in-cal');
	resetRanges(cal);
		
	if(cal.attr("data-range-start") && cal.attr("data-range-start")!="" && cal.attr("data-range-end") && cal.attr("data-range-end")!="") {
		var rangeStart = parseInt(cal.attr("data-range-start"));
		var rangeEnd = parseInt(cal.attr("data-range-end"));
			
		var dateStart = moment(rangeStart);
		var dateEnd = moment(rangeEnd);	
			
		cal.find('[data-day="'+dateStart.date()+'"][data-month="'+(dateStart.month()+1)+'"][data-year="'+dateStart.year()+'"]').addClass("range-start");
		cal.find('[data-day='+dateEnd.date()+'][data-month='+(dateEnd.month()+1)+'][data-year='+dateEnd.year()+']').addClass("range-end");
			
		while(!dateStart.isAfter(dateEnd)) {
			var currentDay = cal.find('[data-day='+dateStart.date()+'][data-month='+(dateStart.month()+1)+'][data-year='+dateStart.year()+']');
			if(!currentDay.hasClass("range-start") && !currentDay.hasClass("range-end")) {
				currentDay.addClass("range-in");
			}
			dateStart.add(1, 'day');
		}
	} else {
		if (cal.attr("data-range-start") && cal.attr("data-range-start")!="") {
			
			var rangeStart = parseInt(cal.attr("data-range-start"));
			var dateStart = moment(rangeStart);
			cal.find('[data-day='+dateStart.date()+'][data-month='+(dateStart.month()+1)+'][data-year='+dateStart.year()+']').addClass("range-start");
			
		} else {
			
			var rangeEnd = parseInt(cal.attr("data-range-end"));
			var dateEnd = moment(rangeEnd);	
			cal.find('[data-day='+dateEnd.date()+'][data-month='+(dateEnd.month()+1)+'][data-year='+dateEnd.year()+']').addClass("range-end");
				
		}
	}
}

function muestraDias(elemento){
	$(".currentDay").removeClass("currentDay");
	var one_day=1000*60*60*24;
	var meses = new Array("None","Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre");
	var aDias = new Array("Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo");
	
	var idPadre = $(elemento).parent().parent().attr("id");
	if (idPadre == "diasIda"){
		$(".myDay").attr("style","");
		$("#hideSal").show();
		$("#diaLlegada").val($(elemento).attr("data-day"));
		$("#mesLlegada").val($(elemento).attr("data-month"));
		$("#mesLlegadav").val(meses[$(elemento).attr("data-month")]);
		$("#anioLlegada").val($(elemento).attr("data-year"));
		
		var diaSet = parseInt($("#diaLlegada").val(),10); var mesSet = parseInt($("#mesLlegada").val(),10); var anoSet = parseInt($("#anioLlegada").val(),10);
		//Modificamos esta linea la suma de diaSet para cambiar los días seleccionados por defecto
		var iFechaSet = new Date(anoSet, mesSet - 1, diaSet);
		var fechaSet = new Date(anoSet, mesSet - 1, diaSet + 1);
		var fechaSetDays = fechaSet.getTime();
		fechaSetDays = fechaSetDays + one_day;
		var firstDay = iFechaSet.getDay();
		var lastDay = fechaSet.getDay();
		$("#nameDiaLlegada").val(aDias[firstDay]);
		$("#nameDiaSalida").val(aDias[lastDay]);
		//alert(fechaSetDays);
		
		$("#diaSalida").val(parseInt(fechaSet.getDate()));
		$("#mesSalida").val(parseInt(fechaSet.getMonth()+1));
		$("#mesSalidav").val(meses[parseInt(fechaSet.getMonth()+1)]);
		$("#anioSalida").val(fechaSet.getFullYear());
		
		//Pintamos el rango de nuevo para que se refleje el rango
		paintRange();
		$('[data-day='+$(elemento).attr("data-day")+'][data-month='+$(elemento).attr("data-month")+'][data-year='+$(elemento).attr("data-year")+']');
		$('[data-day='+parseInt(fechaSet.getDate())+'][data-month='+parseInt(fechaSet.getMonth()+1)+'][data-year='+fechaSet.getFullYear()+']');
		$('#nNoches').html("1");
	}else{
		$(".myDay").attr("style","");
		$("#diaSalida").val($(elemento).attr("data-day"));
		$("#mesSalida").val($(elemento).attr("data-month"));
		$("#mesSalidav").val(meses[$(elemento).attr("data-month")]);
		$("#anioSalida").val($(elemento).attr("data-year"));
		

		
		var diaIni = parseInt($("#diaLlegada").val(),10); var mesIni = parseInt($("#mesLlegada").val(),10); var anoIni = parseInt($("#anioLlegada").val(),10);
		var diaFin = parseInt($("#diaSalida").val(),10); var mesFin = parseInt($("#mesSalida").val(),10); var anoFin = parseInt($("#anioSalida").val(),10);
		
			var inicialb = new Date(anoIni, mesIni - 1, diaIni);
			var inicialf = new Date(anoIni, mesIni - 1, diaIni);
			var finalf = new Date(anoFin, mesFin - 1, diaFin);
			
			//alert(inicialf + ' ' + finalf);
			var diasSum = parseInt(1,10);
			
			var diferencia = Math.floor((finalf.getTime()-inicialf.getTime())/(one_day));

			//Verificamos que la fecha introducida es correcta
			$('#nNoches').html(diferencia);
			if (diferencia <= 0){
				$('#nNoches').html("1");
				$(".myDay").attr("style","");
				$("#diaSalida").val($("#diaLlegada").val());
				$("#mesSalida").val($("#mesLlegada").val());
				$("#anioSalida").val($("#anioLlegada").val());
				$('[data-day='+parseInt(inicialb.getDate())+'][data-month='+parseInt(inicialb.getMonth()+1)+'][data-year='+inicialb.getFullYear()+']').attr("style","background-color:#002a92; color:#fff;");
				var solveDate = new Date(anoFin, mesFin - 1, parseInt(diaFin,10) + 1);
				var firstDay = inicialb.getDay();
				var lastDay = solveDate.getDay();
				$("#nameDiaLlegada").val(aDias[firstDay]);
				$("#nameDiaSalida").val(aDias[lastDay]);
				alert("La fecha de salida debe ser mayor a la de llegada.");
				$('[data-day='+parseInt(solveDate.getDate())+'][data-month='+parseInt(solveDate.getMonth()+1)+'][data-year='+solveDate.getFullYear()+']').attr("style","background-color:#002a92; color:#fff;");
				$("#diaSalida").val(parseInt(solveDate.getDate()));
				$("#mesSalida").val(parseInt(solveDate.getMonth()+1));
				$("#mesSalidav").val(meses[parseInt(solveDate.getMonth()+1)]);
				$("#anioSalida").val($(elemento).attr(solveDate.getFullYear()));
				//Actualizamos dia de salida controlada por el sistema
				var diaFin = parseInt($("#diaSalida").val(),10); var mesFin = parseInt($("#mesSalida").val(),10); var anoFin = parseInt($("#anioSalida").val(),10);
				return false;
			}			
			
			while (diferencia > -1){
				var trueMonth = inicialf.getMonth()+1;
				$('[data-day='+inicialf.getDate()+'][data-month='+trueMonth+'][data-year='+inicialf.getFullYear()+']').attr("style","background-color:#e9efff;");
				inicialf.setDate(inicialf.getDate() + 1);
				diferencia--;
			}
			
			var firstDay = inicialb.getDay();
			var lastDay = finalf.getDay();
			$("#nameDiaLlegada").val(aDias[firstDay]);
			$("#nameDiaSalida").val(aDias[lastDay]);
			$('[data-day='+parseInt(inicialb.getDate())+'][data-month='+parseInt(inicialb.getMonth()+1)+'][data-year='+inicialb.getFullYear()+']').attr("style","background-color:#002a92; color:#fff;");
			$('[data-day='+parseInt(finalf.getDate())+'][data-month='+parseInt(finalf.getMonth()+1)+'][data-year='+finalf.getFullYear()+']').attr("style","background-color:#002a92; color:#fff;");
	}
}

(function() {

  (function($) {
    "use strict";
    var Calendar, opts, spy;
    Calendar = function(element, options) {
      var time;
      this.$element = element;
      this.options = options;
      this.weekDays = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
      this.time = new Date();
      this.currentYear = this.time.getYear();
      this.currentMonth = this.time.getMonth();

      //GUARDAMOS EL BOTON DE AVANZAR MES, RETROCECER MES Y TIPO DE CALENDARIO
      this.prevButton = this.$element.find(".go-prev-month");
      this.nextButton = this.$element.find(".go-next-month");
      this.isPastCalendar = this.$element.data("past-calendar");

      if (this.options.time) {
        time = this.splitDateString(this.options.time);
        this.currentYear = time.year;
        this.currentMonth = time.month;
      }
      this.initialDraw();
      return null;
    };
    Calendar.prototype = {
      addLeadingZero: function(num) {
        if (num < 10) {
          return "0" + num;
        } else {
          return "" + num;
        }
      },
      applyTransition: function($el, transition) {
        $el.css('transition', transition);
        $el.css('-ms-transition', '-ms-' + transition);
        $el.css('-moz-transition', '-moz-' + transition);
        return $el.css('-webkit-transition', '-webkit-' + transition);
      },
      applyBackfaceVisibility: function($el) {
        $el.css('backface-visibility', 'hidden');
        $el.css('-ms-backface-visibility', 'hidden');
        $el.css('-moz-backface-visibility', 'hidden');
        return $el.css('-webkit-backface-visibility', 'hidden');
      },
      applyTransform: function($el, transform) {
        $el.css('transform', transform);
        $el.css('-ms-transform', transform);
        $el.css('-moz-transform', transform);
        return $el.css('-webkit-transform', transform);
      },
      splitDateString: function(dateString) {
        var day, month, time, year;
        time = dateString.split('-');
        year = parseInt(time[0]);
        month = parseInt(time[1] - 1);
        day = parseInt(time[2]);
        return time = {
          year: year,
          month: month,
          day: day
        };
      },
      initialDraw: function() {
        //deshabilitamos-habilitamos botons de ir hacia atras o hacia adelante
        togglePrevButton(this.currentMonth, this.currentYear, this.isPastCalendar, this.prevButton);
        toggleNextButton(this.currentMonth, this.currentYear, this.isPastCalendar, this.nextButton);

        return this.drawDays(this.currentYear, this.currentMonth);
      },
      editDays: function(events) {
        var dateString, day, dayEvents, time, _results;
        _results = [];
        for (dateString in events) {
          dayEvents = events[dateString];
          this.options.events[dateString] = events[dateString];
          time = this.splitDateString(dateString);
          day = this.$element.find('[data-year="' + time.year + '"][data-month="' + (time.month + 1) + '"][data-day="' + time.day + '"]').parent('.day');
          day.removeClass('active');
          day.find('.badge').remove();
          day.find('a').removeAttr('href');
          if (this.currentMonth === time.month || this.options.activateNonCurrentMonths) {
            _results.push(this.makeActive(day, dayEvents));
          } else {
            _results.push(void 0);
          }
        }
        return _results;
      },
      clearDays: function(days) {
        var dateString, day, time, _i, _len, _results;
        _results = [];
        for (_i = 0, _len = days.length; _i < _len; _i++) {
          dateString = days[_i];
          delete this.options.events[dateString];
          time = this.splitDateString(dateString);
          day = this.$element.find('[data-year="' + time.year + '"][data-month="' + (time.month + 1) + '"][data-day="' + time.day + '"]').parent('.day');
          day.removeClass('active');
          day.find('.badge').remove();
          _results.push(day.find('a').removeAttr('href'));
        }
        return _results;
      },
      clearAll: function() {
        var day, days, i, _i, _len, _results;
        this.options.events = {};
        days = this.$element.find('[data-group="days"] .day');
        _results = [];
        for (i = _i = 0, _len = days.length; _i < _len; i = ++_i) {
          day = days[i];
          $(day).removeClass('active');
          $(day).find('.badge').remove();
          _results.push($(day).find('a').removeAttr('href'));
        }
        return _results;
      },
      setMonth: function(dateString) {
        var time;
        time = this.splitDateString(dateString);
        return this.currentMonth = this.drawDays(time.year, time.month);
      },
      setYear: function(dateString) {
        var time;
        time = this.splitDateString(dateString);
        return this.currentYear = time.year;
      },
      prev: function() {
        var goToPast = null;
        var selectedYear = this.currentYear;
        var selectedMonth = this.currentMonth;

        if (this.currentMonth - 1 < 0) {
          this.currentYear = this.currentYear - 1;
          this.currentMonth = 11;
        } else {
          this.currentMonth = this.currentMonth - 1;
        }

        //DESHABILITAMOS BOTON RETROCEDER MES SI NO PODEMOS IR A PASADO
        goToPast = isNavigateToPastDatesAllowed(this.currentMonth, this.currentYear, this.isPastCalendar);
        togglePrevButton(this.currentMonth, this.currentYear, this.isPastCalendar, this.prevButton);
        toggleNextButton(this.currentMonth, this.currentYear, this.isPastCalendar, this.nextButton);
        //toggleNextButton(selectedMonth, selectedYear, this.isPastCalendar, this.nextButton);

        if(goToPast) {
          this.drawDays(this.currentYear, this.currentMonth);
        } else {
          this.currentYear = selectedYear;
          this.currentMonth = selectedMonth;
        }

        return null;
      },
      next: function() {
        var goToFuture = null;
        var selectedMonth = this.currentMonth;
        var selectedYear = this.currentYear;

        if (this.currentMonth + 1 > 11) {
          this.currentYear = this.currentYear + 1;
          this.currentMonth = 0;
        } else {
          this.currentMonth = this.currentMonth + 1;
        }

        //DESHABILITAMOS BOTON AVANZAR MES SI NO PODEMOS IR A FUTURO
        goToFuture = isNavigateToFutureDatesAllowed(selectedMonth, selectedYear, this.isPastCalendar);
        toggleNextButton(this.currentMonth, this.currentYear, this.isPastCalendar, this.nextButton);
        togglePrevButton(this.currentMonth, this.currentYear, this.isPastCalendar, this.prevButton);

        if(goToFuture) {
          this.drawDays(this.currentYear, this.currentMonth);
        } else {
          this.currentYear = selectedYear;
          this.currentMonth = selectedMonth;
        }

        return null;
      },
	  setNewDate: function(myDate) {
		var aDate = myDate.split("-");
        this.currentYear = parseInt(aDate[1],10);
        this.currentMonth = parseInt(aDate[0],10) - 1;
		
        this.drawDays(this.currentYear, this.currentMonth);
        if (this.options.onMonthChange) {
          this.options.onMonthChange.call(this);
        }
        return null;
      },
	  getCurrentDate: function() {
		var visualMonth = this.currentMonth + 1;
		var sDate = visualMonth + '-' + this.currentYear;
        return sDate;
      },
      addOthers: function(day, dayEvents) {
        if (typeof dayEvents === "object") {
          if ((dayEvents.number != null) && (dayEvents.badgeClass != null)) {
            day.append($("<span></span>").html(dayEvents.number).addClass("badge").addClass(dayEvents.badgeClass));
          }
          if (dayEvents.url) {
            day.find("a").attr("href", dayEvents.url);
          }
        }
        return day;
      },
      makeActive: function(day, dayEvents) {
        var classes, eventClass, i, _i, _len;
        if (dayEvents) {
          if (dayEvents["class"]) {
            classes = dayEvents["class"].split(" ");
            for (i = _i = 0, _len = classes.length; _i < _len; i = ++_i) {
              eventClass = classes[i];
              day.addClass(eventClass);
            }
          } else {
            day.addClass("active");
          }
          day = this.addOthers(day, dayEvents);
        }
        return day;
      },
      getDaysInMonth: function(year, month) {
        return new Date(year, month + 1, 0).getDate();
      },
      drawDay: function(lastDayOfMonth, yearNum, monthNum, dayNum, i) {
        var calcDate, dateNow, dateString, day, dayDate, pastFutureClass;
        day = $("<div></div>").addClass("day");
        dateNow = new Date();
        dateNow.setHours(0, 0, 0, 0);
        dayDate = new Date(yearNum, monthNum - 1, dayNum);
        /*if (dayDate.getTime() < dateNow.getTime() && !this.isPastCalendar) {
          pastFutureClass = "past";
        } else if (dayDate.getTime() === dateNow.getTime()) {
          pastFutureClass = (this.isPastCalendar) ? "today past" : "today";
        } else {
          pastFutureClass =(this.isPastCalendar) ? "allowed-past" : "future";
        }*/
        if (dayDate.getTime() < dateNow.getTime()) {
          pastFutureClass = (this.isPastCalendar) ? "allowed-past" : "past";
        } else if (dayDate.getTime() === dateNow.getTime()) {
          pastFutureClass = (this.isPastCalendar) ? "today past" : "today";
        } else {
          pastFutureClass =(this.isPastCalendar) ? "past" : "future";
        }

        day.addClass(this.weekDays[i % 7]);
        day.addClass(pastFutureClass);
        dateString = yearNum + "-" + this.addLeadingZero(monthNum) + "-" + this.addLeadingZero(dayNum);
        if (dayNum <= 0 || dayNum > lastDayOfMonth) {
          calcDate = new Date(yearNum, monthNum - 1, dayNum);
          dayNum = calcDate.getDate();
          monthNum = calcDate.getMonth() + 1;
          yearNum = calcDate.getFullYear();
          day.addClass("not-current").addClass(pastFutureClass);
          if (this.options.activateNonCurrentMonths) {
            dateString = yearNum + "-" + this.addLeadingZero(monthNum) + "-" + this.addLeadingZero(dayNum);
          }
        }
        //day.append($("<a class='myDay' onclick='muestraDias(this)'>" + dayNum + "</a>").attr("data-day", dayNum).attr("data-month", monthNum).attr("data-year", yearNum));
        day.append($("<a class='myDay'>" + dayNum + "</a>").attr("data-day", dayNum).attr("data-month", monthNum).attr("data-year", yearNum));
        //if (this.options.monthChangeAnimation) {
          this.applyTransform(day, 'rotateY(0deg)');
          this.applyBackfaceVisibility(day);
        //}
        day = this.makeActive(day, this.options.events[dateString]);
        return this.$element.find('[data-group="days"]').append(day);
      },
      drawDays: function(year, month) {
        var currentMonth, day, dayBase, days, delay, draw, firstDayOfMonth, i, lastDayOfMonth, loopBase, monthNum, multiplier, thisRef, time, timeout, yearNum, _i, _len;
        thisRef = this;
        time = new Date(year, month);
        currentMonth = time.getMonth();
        monthNum = time.getMonth() + 1;
        yearNum = time.getFullYear();
        time.setDate(1);
        firstDayOfMonth = this.options.startFromSunday ? time.getDay() + 1 : time.getDay() || 7;
        lastDayOfMonth = this.getDaysInMonth(year, month);
        if (this.options.monthChangeAnimation) {
          timeout = 0;
          days = this.$element.find('[data-group="days"] .day');
          for (i = _i = 0, _len = days.length; _i < _len; i = ++_i) {
            day = days[i];
            delay = i * 0.01;
            this.applyTransition($(day), 'transform .5s ease ' + delay + 's');
            this.applyTransform($(day), 'rotateY(0deg)');
            this.applyBackfaceVisibility($(day));
            timeout = (delay + 0.1) * 1000;
          }
        }
        dayBase = 2;
        if (this.options.allRows) {
          loopBase = 42;
        } else {
          multiplier = Math.ceil((firstDayOfMonth - (dayBase - 1) + lastDayOfMonth) / 7);
          loopBase = multiplier * 7;
        }
        this.$element.find(".timeInfo").html(time.getFullYear() + " " + this.options.translateMonths[time.getMonth()]);
        draw = function() {
          var dayNum;
          thisRef.$element.find('[data-group="days"]').empty();
          dayNum = dayBase - firstDayOfMonth;
          i = thisRef.options.startFromSunday ? 0 : 1;
          while (dayNum < loopBase - firstDayOfMonth + dayBase) {
            thisRef.drawDay(lastDayOfMonth, yearNum, monthNum, dayNum, i);
            dayNum = dayNum + 1;
            i = i + 1;
          }
          paintRange(thisRef.$element); //Volvemos a pintar el rango cada vez que movemos un mes
          delay = function() {
            var _j, _len1;
            days = thisRef.$element.find('[data-group="days"] .day');
            for (i = _j = 0, _len1 = days.length; _j < _len1; i = ++_j) {
              day = days[i];
              thisRef.applyTransition($(day), 'transform .5s ease ' + (i * 0.01) + 's');
              thisRef.applyTransform($(day), 'rotateY(0deg)');
            }
            if (thisRef.options.onDayClick) {
              thisRef.$element.find('[data-group="days"] .day a').click(function() {
                return thisRef.options.onDayClick.call(this, thisRef.options.events);
              });
            }
            if (thisRef.options.onDayHover) {
              thisRef.$element.find('[data-group="days"] .day a').hover(function() {
                return thisRef.options.onDayHover.call(this, thisRef.options.events);
              });
            }
            if (thisRef.options.onActiveDayClick) {
              thisRef.$element.find('[data-group="days"] .day.active a').click(function() {
                return thisRef.options.onActiveDayClick.call(this, thisRef.options.events);
              });
            }
            if (thisRef.options.onActiveDayHover) {
              return thisRef.$element.find('[data-group="days"] .day.active a').hover(function() {
                return thisRef.options.onActiveDayHover.call(this, thisRef.options.events);
              });
            }
            shadowDays();
          
          };
          //if (thisRef.options.monthChangeAnimation) {
            return setTimeout(delay, 0);
          //}
        };
        setTimeout(draw, timeout);
        return currentMonth;
      }
    };
    $.fn.responsiveCalendar = function(option, params) {
      var init, options, publicFunc;
      if (params == null) {
        params = void 0;
      }
      options = $.extend({}, $.fn.responsiveCalendar.defaults, typeof option === 'object' && option);
      publicFunc = {
        next: 'next',
        prev: 'prev',
        edit: 'editDays',
        clear: 'clearDays',
        clearAll: 'clearAll',
		setNewDate: 'setNewDate',
		getCurrentDate: 'getCurrentDate'
      };
      init = function($this) {
        var data;
        options = $.metadata ? $.extend({}, options, $this.metadata()) : options;
        $this.data('calendar', (data = new Calendar($this, options)));
        if (options.onInit) {
          options.onInit.call(this);
        }
        return $this.find("[data-go]").click(function() {
          if ($(this).data("go") === "prev") {
            data.prev();
          }
          if ($(this).data("go") === "next") {
            data.next();
          }
          if (options.onMonthChange) {
            return options.onMonthChange.call(this);
          }
        });
      };
      return this.each(function() {
        var $this, data;
        $this = $(this);
        data = $this.data('calendar');
        if (!data) {
          init($this);
        } else if (typeof option === 'string') {
          if (publicFunc[option] != null) {
            data[publicFunc[option]](params);
          } else {
            data.setMonth(option);
            data.setYear(option);
            toggleNavigationButtons(data);
          }
        } else if (typeof option === 'number') {
          data.jump(Math.abs(option) + 1);
        }
        return null;
      });
    };
    $.fn.responsiveCalendar.defaults = {
      translateMonths: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
      events: {},
      time: void 0,
      allRows: true,
      startFromSunday: false,
      activateNonCurrentMonths: false,
      monthChangeAnimation: false,
      onInit: void 0,
      onDayClick: void 0,
      onDayHover: void 0,
      onActiveDayClick: void 0,
      onActiveDayHover: void 0,
      onMonthChange: void 0
    };
    spy = $('[data-spy="responsive-calendar"]');
    if (spy.length) {
      opts = {};
      if ((spy.data('translate-months')) != null) {
        opts.translateMonths = spy.data('translate-months').split(',');
      }
      if ((spy.data('time')) != null) {
        opts.time = spy.data('time');
      }
      if ((spy.data('all-rows')) != null) {
        opts.allRows = spy.data('all-rows');
      }
      if ((spy.data('start-from-sunday')) != null) {
        opts.startFromSunday = spy.data('start-from-sunday');
      }
      if ((spy.data('activate-non-current-months')) != null) {
        opts.activateNonCurrentMonths = spy.data('activate-non-current-months');
      }
      if ((spy.data('month-change-animation')) != null) {
        opts.monthChangeAnimation = spy.data('month-change-animation');
      }
      return spy.responsiveCalendar(opts);
    }
	})(jQuery);

	/*	--------------------------------------------------
		Oculta el desplegable Checkin/Checkout al clickar en el documento
	-------------------------------------------------- */

	$(document).on('mouseup touchend keyup', {className: ".js-close-blur"},closeElementOnEvent)
	.on('keyup', {className: ".js-close-esc"}, closeElementOnEvent);

	function closeElementOnEvent(ev) {
		var data;
		$(ev.data.className).each(function() { 
			data = {
				container: $(this),
				get linked() {
					return $(this.container.attr("data-linked-element"));
				}
			};
			if (ev.keyCode && ev.keyCode === 27) {
				hideElement(data);
			} else if (!data.container.is(ev.target) && data.container.has(ev.target).length === 0 && !data.linked.is(ev.target) && data.linked.has(ev.target).length === 0) {
				closeElementOnMouseup(ev, data);
			}
		});
	}

	function closeElementOnMouseup(ev, data) {
		if (!data.container.is(ev.target) && data.container.has(ev.target).length === 0 && !data.linked.is(ev.target) && data.linked.has(ev.target).length === 0) {
			hideElement(data);
		}
	}

	function hideElement(data) {
		if(data.container.is(":visible")) {
			data.linked.trigger('blur');
			data.container.removeClass('active');
		}
	}
}).call(this);

/*!
  # Responsive Celendar functions
  #
  # Funciones generales de los responsive-calendar
*/

$(function() {

	// -----------------------------------------------------------------------------
	// Carga de calendarios de la página
	// -----------------------------------------------------------------------------

	function isMobile() {
    if( /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent) ) {
      return true;
    }
  }

	// Definicion de los dias de la semana
	var weekDays = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];

	if($(".responsive-calendar").length) {
		$.each( $(".responsive-calendar"), function() {
			var $curCalendar = $(this);
			var dateInput=$($curCalendar.attr("data-date-input"));
			if(!dateInput.hasClass("prevent-mobile") || (dateInput.hasClass("prevent-mobile") && !isMobile())) {
				var calType = $curCalendar.attr("data-calendar-type");
				var isPastCalendar = $curCalendar.data("past-calendar");
				var rangeType = $($curCalendar.closest('.responsive-calendar-wrap').attr('data-linked-element')).attr('data-range-type');
				var now = new Date();
				var tday = now.getDate();
				var tmonth = now.getMonth()+1;
				var tyear = now.getFullYear();
				var strFormt = tyear+"-"+tmonth;
				var x = "";
				var monthsDefaults = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
				var firstValidDate;
				var firstWeeklyDay;


				if(dateInput.length) {
					dateInput.attr("type", "text").prop("readonly", true);
				}
        if (($(this).data('translate-months')) != null) {
          var monthsArray = $(this).data("translate-months").split(',');
        }
				//console.log(meses);

				//if ( monthArray.length) {
					//x = monthArray;
				//} else {
				//	console.log()
				//}

				//Para calendario de rangos debemos generar el calendario en el mes de 'data-first-valid-date' ya que es la primera fecha válida
				//a no ser que el més de "data-first-valid-date" sea anterior al mes actual, que generaremos el calendario en el mes actual
				if($curCalendar.attr('data-first-valid-date') && calType == 'range'){
					firstValidDate = $curCalendar.attr('data-first-valid-date').split("/");
					firstWeeklyDay = $curCalendar.attr('data-first-weekly-day');
					if (!firstValidDate && firstWeeklyDay) {
						firstValidDate = setFirstWeekAvailableDay(firstWeeklyDay, moment().format('DD/MM/YYYY'));
					} else if (firstValidDate && firstWeeklyDay) {
						firstValidDate = setFirstWeekAvailableDay(firstWeeklyDay, firstValidDate).split("/");
					}
					//si el mes del día que ponemos en el data-first-valid-date es posterior al día actual, abrimos el calendario en el mes actual
					if (strFormt < parseInt(firstValidDate[2])+'-'+parseInt(firstValidDate[1])) {
						strFormt = parseInt(firstValidDate[2]) + '-' + parseInt(firstValidDate[1]);
					}
				}

				$curCalendar.responsiveCalendar({

					time: strFormt,
					translateMonths: (typeof monthsArray !== "undefined" ? monthsArray : monthsArray),
					allRows: false,
					onDayClick: function(events) {
						var $dayClicked = $(this);
						// Si se ha hecho click en un día válido
						if(isValidDay($dayClicked)){
							// Trata la selección en base al tipo de calendario
							switch(calType) {
								case "simple": simpleSelectDay($dayClicked);
									break;
								case "multiselect": multiSelectDay($dayClicked);
									break;
								case "range": rangeSelectDay($dayClicked, isPastCalendar);
									break;
								default: simpleSelectDay($dayClicked);
							}
						}
					},
					onInit: function(){
						if(rangeType == 'end'){
							//Deshabilitamos la fecha today en el calendario de final de rango
							setTimeout(function(){$curCalendar.find('.today').addClass('past')}, 50);
						}
					}
				});
			}
		});
	}

	// -----------------------------------------------------------------------------
	// Navegación calendario rango
	// -----------------------------------------------------------------------------
	$( ".responsive-calendar[data-calendar-type='range'] .go-prev-month" ).click(function() {
		var curCalendar = $(this).closest(".responsive-calendar-wrap");
		var self = $(this);

		//$(this).closest(".responsive-calendar").responsiveCalendar('prev');

		setTimeout(function(){
			if(curCalendar.attr("data-range-end") && curCalendar.attr("data-range-end")!="" && curCalendar.attr("data-range-start") && curCalendar.attr("data-range-start")!="") {
				paintRange(curCalendar);
			}
			// Deshabilitamos los días fuera de rango si hay un rango indicado de fechas seleccionables
			disableDates("#" + self.closest(".responsive-calendar-wrap").attr("id"));
			paintBlackOuts();
		}, 10);
	});

	$( ".responsive-calendar[data-calendar-type='range'] .go-next-month" ).click(function(e) {
		e.preventDefault();
		var curCalendar = $(this).closest(".responsive-calendar-wrap");
		var self = $(this);

		//$(this).closest(".responsive-calendar").responsiveCalendar('next');

		setTimeout(function(){
			if(curCalendar.attr("data-range-end") && curCalendar.attr("data-range-end")!="" && curCalendar.attr("data-range-start") && curCalendar.attr("data-range-start")!="") {
				paintRange(curCalendar);
			}
			// Deshabilitamos los días fuera de rango si hay un rango indicado de fechas seleccionables
			disableDates("#" + self.closest(".responsive-calendar-wrap").attr("id"));
			paintBlackOuts();
		}, 10);

	});


	// -----------------------------------------------------------------------------
	// Calendario Simple: Gestión de click en un día
	// -----------------------------------------------------------------------------
	function simpleSelectDay(obj){
		// Selecciona el input en el que vamos a introducir la fecha seleccionada en formato string
		var dateInput=obj.closest(".responsive-calendar[data-calendar-type='simple']").attr("data-date-input");

		// Obtiene la fecha seleccionada rellenando con 0 a la izquierda
		var gDay = fillZeros(obj.attr("data-day"),2,"left");
		var gMonth = fillZeros(obj.attr("data-month"),2,"left");
		var gYear = obj.attr("data-year");
		var selectedDateText = gDay+"/"+gMonth+"/"+gYear;
		var selectedDate = gYear + "-" + gMonth + "-" + gDay;

		// Marca el día seleccionado
		obj.closest(".responsive-calendar-wrap").find(".selected-day").removeClass("selected-day");
		obj.addClass("selected-day");

		// Asigna el nuevo valor al input
		if($(dateInput).is("input[type='date']")) {
			$(dateInput).val(selectedDate).change();
		} else {
			$(dateInput).val(selectedDateText).change();
		}

		// Cierra el calendario al seleccionar una fecha
		obj.closest(".responsive-calendar-wrap").removeClass("active");
	}


	// -----------------------------------------------------------------------------
	// Calendario Multiselección: Gestión de click en un día
	// -----------------------------------------------------------------------------
	function multiSelectDay(obj){
		// Selecciona el input en el que vamos a introducir la fecha seleccionada en formato string
		var dateInput=obj.closest(".responsive-calendar[data-calendar-type='multiselect']").attr("data-date-input");

		// Obtiene los valores de fecha de input y lo guarda en un array
		var selectedDates = $(dateInput).val().split(", ");

		// Obtiene la fecha seleccionada rellenando con 0 a la izquierda
		var gDay = fillZeros(obj.attr("data-day"),2,"left");
		var gMonth = fillZeros(obj.attr("data-month"),2,"left");
		var gYear = obj.attr("data-year");
		var selectedDate = gDay+"/"+gMonth+"/"+gYear;

		// Si estaba previamente seleccionado lo deseleccionamos
		if(obj.hasClass("selected-day")) {
			obj.removeClass("selected-day");

			// Y eliminamos la fecha del input
			if(selectedDates.length==1) {
				$(dateInput).val("").change();
			} else {
				$.each( selectedDates, function( key, value ) {
					if(value == selectedDate) {
						// Elimina la fecha del array
						selectedDates.splice(key,1);
						// Asigna el nuevo valor sin la fecha deseleccionada al input
						newValue=selectedDates.join(", ");
					}
				});
			}

		} else {
			// Sino lo marcamos como seleccionado
			obj.addClass("selected-day");

			// Concatena la nueva fecha escogida a las fechas ya seleccionadas (si las hay)
			if($(dateInput).val()=="") {
				var newValue = selectedDate;
			} else {
				var newValue = $(dateInput).val()+", "+selectedDate;
			}
		}

		// Asigna el nuevo valor (todas las fechas concatenadas) al input
		$(dateInput).val(newValue).change();
	}

  // -----------------------------------------------------------------------------
  // Calendario de rango: Gestión de click en un día
  // -----------------------------------------------------------------------------

  function getSelectedDate($day) {
    var selectedDay = $day.attr("data-day");
    var selectedMonth = $day.attr("data-month");
    var selectedYear = $day.attr("data-year");
    var selectedDate = {
      day: parseInt(selectedDay),
      month: parseInt(selectedMonth),
      year: parseInt(selectedYear),
      stringDate: fillZeros(selectedDay, 2, "left")+ "/" + fillZeros(selectedMonth, 2, "left") + "/" + selectedYear,
      date: moment({ year : selectedYear, month : ( selectedMonth - 1), day : selectedDay})
    };

    return selectedDate;
  }

	/**
	 * @description obtenemos la fecha de fin de un rango teniendo en cuenta los minimos de días permitidos para ese rango
	 * @param {object} selectedDate 	objecto que contiene el dia, mes, año de la fecha seleccionada y la fecha seleccionada como string
	 * @param {number} minDaysAllowed	numero minimo de días que debe de tener el rango para ser válido
	 * @returns devuelve un objeto tipo fecha moment con la fecha de fin(fecha de inicio + minimo días)
	 */
	function getEndDate(selectedDate, minDaysAllowed) {
		var date = moment({ year : selectedDate.year, month : (selectedDate.month - 1), day : selectedDate.day});
		date.add(minDaysAllowed, 'day');
		return date;
	}

	/**
	 * @description obtenemos la fecha de inicio de un rango teniendo en cuenta los minimos de días permitidos para ese rango
	 * @param {object} selectedDate 	objecto que contiene el dia, mes, año de la fecha seleccionada y la fecha seleccionada como string
	 * @param {number} minDaysAllowed	numero minimo de días que debe de tener el rango para ser válido
	 * @returns devuelve un objeto tipo fecha moment con la fecha de fin(fecha de inicio - minimo días)
	 */
	function getStartDate(selectedDate, minDaysAllowed) {
		var date = moment({ year : selectedDate.year, month : (selectedDate.month - 1), day : selectedDate.day});
		date.subtract(minDaysAllowed, 'day');
		return date;
	}

	/**
	 * @description comprobamos si las fechas seleccionadas del rango(inicio y fin) son validas
	 * @param {object} rangeData objeto que contiene los datos necesarios del rango de fechas
	 * @returns devuelve si las fechas de inicio y fin seleccionadas son validas o no
	 */
	function isValidRangeDates(rangeData, isPastCalendar) {
		var isInvalidStartDate = false;
		var isInvalidEndDate = false;
		var lastValidDay = moment().subtract(1, 'd');
		if(rangeData.start.validRangeDate) {
			//isInvalidStartDate = (rangeData.start.date.isBefore(rangeData.start.validRangeDate) || rangeData.start.date.isSame(rangeData.start.validRangeDate));
			isInvalidStartDate = (rangeData.start.date.isBefore(rangeData.start.validRangeDate));
		}

		if(rangeData.end.validRangeDate) {
			//isInvalidEndDate = (rangeData.end.date.isAfter(rangeData.end.validRangeDate) || rangeData.end.date.isSame(rangeData.end.validRangeDate));
			isInvalidEndDate = (rangeData.end.date.isAfter(rangeData.end.validRangeDate));

			if(isPastCalendar) {
				isInvalidEndDate = (rangeData.end.date.isAfter(lastValidDay));
			}
		}

		return (!isInvalidStartDate && !isInvalidEndDate);
	}

	/**
	 * @description comprobamos si el rango seleccionado es válido
	 * @param {object} rangeData objeto que contiene los datos necesarios del rango de fechas
	 * @returns devuelve si el rango seleccionado es válido o no
	 */
	function isValidRange(rangeData, isPastCalendar) {
		var isValidRange = true;
		var isValidDays = (rangeData.numDaysSelected >= rangeData.minDaysAllowed) && (rangeData.numDaysSelected <= rangeData.maxDaysAllowed);

		if(!isValidRangeDates(rangeData, isPastCalendar) || !validateBlackOuts(rangeData.start.date, rangeData.end.date) || !isValidDays) {
			isValidRange = false;
		}

		return isValidRange;
	}

	/**
	 * @description obtenemos la fecha mínima de inicio de rango válida.
	 * @param {object} $currentCalendar - objeto jquery que contiene el calendario sobre el que se está actuando
	 * @returns devuelve la fecha mínima de inicio de rango válida
	 */
	function getValidInitRangeDate($currentCalendar) {
		var initRangeDate = $currentCalendar.data("first-valid-date");
		// Primer dia de la semana seleccionable.
		var firstWeeklyDay = $currentCalendar.data('first-weekly-day');

		if (!initRangeDate && firstWeeklyDay) {
			initRangeDate = setFirstWeekAvailableDay(firstWeeklyDay, moment().format('DD/MM/YYYY'));
		} else if (initRangeDate && firstWeeklyDay) {
			initRangeDate = setFirstWeekAvailableDay(firstWeeklyDay, initRangeDate);
		}

		return initRangeDate;
	}

	/**
	 * @description obtenemos el número de días mínimos que debe de tener el rango
	 * @param {object} $currentCalendar - objeto jquery que contiene el calendario sobre el que se está actuando
	 * @param {object} rangeData 		- objeto que contiene los datos necesarios del rango de fechas
	 * @returns el número de días mínimos que debe de tener el rango
	 */
	function getMinDaysAllowed($currentCalendar, rangeData) {
		var minDaysAllowed = $currentCalendar.data("min-nights") || 1;
		var rangeNights = 0;

		if(rangeData.start.validRangeDate && rangeData.end.validRangeDate) {
			rangeNights = rangeData.end.validRangeDate.diff(rangeData.start.validRangeDate, 'days');
		}

		if (rangeNights < minDaysAllowed) {
			minDaysAllowed = rangeNights;
		}

		return minDaysAllowed;
	}

	/**
	 * @description obtenemos una fecha en formato moment a traves de un string
	 * @param {string} date - texto con fecha en formato dd-mm-yyyy
	 * @returns una fecha en formato moment
	 */
	function getValidRangeDate(date) {
		date = (date) ? date.split("/") : "";
		return moment({ year : parseInt(date[2]), month: parseInt(date[1])-1, day: parseInt(date[0])});
	}

  /**
   * @description obtenemos un objeto js con todos los datos necesarios para trabajar con los rangos
   * @param {object} $day - objeto jquery con el elemento del día del calendario pulsado
   * @returns objeto js con todos los datos necesarios para trabajar con los rangos
   */
  function getCalendarData($day) {
    var $currentCalendarWrap = $day.closest(".responsive-calendar-wrap");
    var $currentCalendar = $currentCalendarWrap.find(".responsive-calendar");
    var dateInputStartId = $currentCalendar.data("date-input-from");
    var dateInputEndId = $currentCalendar.data("date-input-to");
    var $dateInputStart = $(dateInputStartId);
    var $dateInputEnd = $(dateInputEndId);
    var calendarStartId = $dateInputStart.data("calendar");
    var calendarEndId = $dateInputEnd.data("calendar");

    return {
      $wrapper: $currentCalendarWrap,
      $currentCalendar: $currentCalendar,
      $calendarStart: $(calendarStartId),
      $calendarEnd:  $(calendarEndId),
      $inputStart: $dateInputStart,
      $inputEnd: $dateInputEnd,
      inClass: "range-start",
      outClass: "range-end",
      startValidRangeDate: getValidInitRangeDate($currentCalendar),
      endValidRangeDate: $currentCalendar.data("last-valid-date")
    };
  }

  /**
   * @description obtenemos una fecha en formato moment a traves de un string dado, si no devolvemos un null
   * @param {string} dateData - string con fecha guardada
   * @returns fecha en formato moment o null
   */
  function getOldDate(dateData) {
    var date = null;
    if(dateData && dateData !== "") {
      return moment(parseInt(dateData,10));
    }
    return date;
  }

	/**
	 * @description - Calendario de rango: Gestión de click en un día
	 * @param {object} $day jquery object of the day selected
	 * @param {boolean} isPastCalendar if calendar only allows past dates or not
	 * 
	 */
	function rangeSelectDay($day, isPastCalendar) {
		//Datos del calendario sobre el que se interactua (elementos jquery, clases, etc) que se van a utilizar para actualizarse o actualizar elementos o datos
		var calendarData = getCalendarData($day);

    //var $erroModal = $('#error-modal'); //,modal que contiene el error
    //var $erroModal = $('#modal-range-error'); //,modal que contiene el error
    var $errorModal = (calendarData.$currentCalendar.data("max-nights")) ? $('#modal-range-error') :  $('#modal-max-days');
		var selectedDate = getSelectedDate($day); //fecha seleccionada

		//Guardamos los datos del rango de fechas
		var rangeData = {
			start: {
				validRangeDate: getValidRangeDate(calendarData.startValidRangeDate),
				date: null,
				oldDate: getOldDate(calendarData.$wrapper.attr("data-range-start"))
			},
			end: {
				validRangeDate: getValidRangeDate(calendarData.endValidRangeDate),
				date: null,
				oldDate: getOldDate(calendarData.$wrapper.attr("data-range-end"))
			},
			rangeType: calendarData.$wrapper.data("range-type"),
			minDaysAllowed: 0,
			numDaysSelected: 0,
			maxDaysAllowed: parseInt(calendarData.$currentCalendar.data("max-nights"), 10) || 15
		};

		rangeData.minDaysAllowed = getMinDaysAllowed(calendarData.$currentCalendar, rangeData);

		if(rangeData.rangeType === "start") {
			rangeData.start.date = selectedDate.date;
			rangeData.end.date = getEndDate(selectedDate, rangeData.minDaysAllowed);
			rangeData.numDaysSelected = rangeData.end.date.diff(rangeData.start.date, 'days');

			//si no es valido el rango mostramos modal
			if(!isValidRange(rangeData, isPastCalendar)) {
				$erroModal.modal();
				return false;
			}

			//si no tenemos fecha de fin seleccionada, cogemos como fecha fin anterior el día actual
			rangeData.end.oldDate = (rangeData.end.oldDate) ? rangeData.end.oldDate : moment();

			//Si la nueva fecha de fin tiene el mes o año distinto a la fecha de fin anterior, renderizamos el calendario con la nueva fecha
			if((rangeData.end.date.get("month") !== rangeData.end.oldDate.get("month")) || (rangeData.end.date.get("year") !== rangeData.end.oldDate.get("year"))) {
				calendarData.$calendarEnd.find(".responsive-calendar").responsiveCalendar(rangeData.end.date.format('YYYY-MM'));
			}
		} else {
			rangeData.end.date = selectedDate.date;

			//if($currentCalendarWrap.attr("data-range-start") && $currentCalendarWrap.attr("data-range-start") !== "") {
			if(rangeData.start.oldDate) {
				if(rangeData.end.date.isBefore(rangeData.start.oldDate)) {
					rangeData.start.date = getStartDate(selectedDate, rangeData.minDaysAllowed);
					rangeData.numDaysSelected = rangeData.end.date.diff(rangeData.start.date, 'days');
					if(!isValidRange(rangeData)) {
						$errorModal.modal();
						return false;
					}

					//Si la nueva fecha de fin tiene el mes o año distinto a la fecha de fin anterior, renderizamos el calendario con la nueva fecha
					if((rangeData.start.date.get("month") !== rangeData.start.oldDate.get("month")) || (rangeData.start.date.get("year") !== rangeData.start.oldDate.get("year"))) {
						calendarData.$calendarStart.find(".responsive-calendar").responsiveCalendar(rangeData.start.date.format('YYYY-MM'));
					}

				} else {
					rangeData.start.date = rangeData.start.oldDate;
					rangeData.numDaysSelected = rangeData.end.date.diff(rangeData.start.date, 'days');
					if(!isValidRange(rangeData, isPastCalendar)) {
						$errorModal.modal();
						return false;
					}
				}
			} else {
				//Si la nueva fecha de fin tiene el mes o año distinto a la fecha de fin anterior, renderizamos el calendario con la nueva fecha
				if((moment().get("month") !== rangeData.end.date.get("month")) || (rangeData.end.date.get("year") !== rangeData.end.date.get("year"))) {
					calendarData.$calendarStart.find(".responsive-calendar").responsiveCalendar(rangeData.end.date.format('YYYY-MM'));
				}
			}
		}

		//ponemos un timeout para que de tiempo a renderizar el calendario con el nuevo mes antes de
		//actualizarlo.

		setTimeout(function() {
			updateDate(calendarData.$calendarStart,calendarData.$calendarEnd, rangeData.start.date ,"range-start", calendarData.$inputStart);
			updateDate(calendarData.$calendarStart, calendarData.$calendarEnd, rangeData.end.date, "range-end", calendarData.$inputEnd);
			calendarData.$calendarStart.attr({
				"data-range-start": rangeData.start.date,
				"data-range-end": rangeData.end.date
			});
			calendarData.$calendarEnd.attr({
				"data-range-start": rangeData.start.date,
				"data-range-end": rangeData.end.date
			});

			// Añade la clase range-in a los días intermedios entre range-start y range-end
			paintRange(calendarData.$calendarStart);
			paintRange(calendarData.$calendarEnd);
		}, 100);



		// Cierra el calendario al seleccionar una fecha
		calendarData.$wrapper.removeClass("active");
	}

	// -----------------------------------------------------------------------------
	// Muestra el calendario al hacer click en el botón que hace de datepicker
	// -----------------------------------------------------------------------------
	$('.js-date-select').on('focus', function(e){
		if(!$(this).hasClass("prevent-mobile") || ($(this).hasClass("prevent-mobile") && !isMobile())) {
			var calendar=$( this ).attr("data-calendar");
			var rangeType = $(this).attr("data-range-type");

			// Posiciona el calendario
			calendarPosition(calendar,$(this));

			// Oculta todos los calendarios abiertos
			$(".responsive-calendar-wrap.active").removeClass("active");

			// Si el calendario es de tipo rango se guarda el tipo de input (inicio/fin)
			if($(calendar).find(".responsive-calendar").attr("data-calendar-type")=="range") {
				$(calendar).attr("data-range-type",$(this).attr("data-range-type"));

				// Deshabilitamos los días fuera de rango si hay un rango indicado de fechas seleccionables
				disableDates(calendar);
				//Pintamos los blackouts
				paintBlackOuts();

			}

			// Muestra el calendario
			$(calendar).addClass("active").attr("data-date-input","#"+$(this).attr("id"));

			///$(this).responsiveCalendar(parseInt(arrayFirstDay[2])+'-'+parseInt(arrayFirstDay[1]));
		}
	});

	// -----------------------------------------------------------------------------
	// Deshabilita los días especificados en el calendar
	// -----------------------------------------------------------------------------
	function disableDates(calendar) {
		// Deshabilitamos los días fuera de rango si hay un rango indicado de fechas seleccionables
		var initRange = $(calendar).find(".responsive-calendar").attr("data-first-valid-date");
		var endRange = $(calendar).find(".responsive-calendar").attr("data-last-valid-date");
    // Primer dia de la semana seleccionable.
		var firstWeeklyDay = $(calendar).find('.responsive-calendar').attr('data-first-weekly-day');
		if (!initRange && firstWeeklyDay) {
			initRange = setFirstWeekAvailableDay(firstWeeklyDay, moment().format('DD/MM/YYYY'));
		} else if (initRange && firstWeeklyDay) {
			initRange = setFirstWeekAvailableDay(firstWeeklyDay, initRange);
		}
		if(initRange || endRange) {
			initRange = initRange ? initRange.split("/") : '';
			endRange = endRange ? endRange.split("/") : '';
			var objInitRange = moment({ year : parseInt(initRange[2]), month : parseInt(initRange[1])-1, day :  parseInt(initRange[0])});
			var objEndRange = moment({ year : parseInt(endRange[2]), month : parseInt(endRange[1])-1, day :  parseInt(endRange[0])});
			var objCurDate = "";

			$.each( $(calendar).find('.days').find('.day'), function(index) {
				var self = $(this).find('.myDay');
				objCurDate =  moment({ year : parseInt(self.attr("data-year")), month : parseInt(self.attr("data-month"))-1, day :  parseInt(self.attr("data-day")) });

				if(objCurDate.isBefore(objInitRange) || objCurDate.isAfter(objEndRange)){
					$(this).addClass("past").removeClass("future").removeClass('today');
				}
			});
		}
	}

	// -----------------------------------------------------------------------------
	// Determina el primer dia de la semana a partir del cual se puede seleccionar
	// una fecha
	// -----------------------------------------------------------------------------
	function setFirstWeekAvailableDay(firstWeeklyDay, date) {
		var dateMoment = moment(date,'DD/MM/YYYY');
			var firstWeeklyDayNumber = weekDays.indexOf(firstWeeklyDay);
			//  Si la fecha actual es posterior, se pasa el primer dia seleccionable
			// a la semana siguiente
			if (firstWeeklyDayNumber > dateMoment.day() ) {
				dateMoment.day(firstWeeklyDayNumber);
			} else if (firstWeeklyDayNumber < dateMoment.day()){
				dateMoment.day(firstWeeklyDayNumber + 7);
			}
			return dateMoment.format('DD/MM/YYYY');
	}


	// -----------------------------------------------------------------------------
	// Determina si un día es válido
	// -----------------------------------------------------------------------------
	// No es válido si:
	//		- Se trata de un día pasado
	//		- Se ha deshabilitado ese día (clase disabled-date)
	function isValidDay(obj){
		var valid = false;
		if(!obj.parent(".day").hasClass("past") && !obj.hasClass("disabled-date")) {
			valid=true;
		}
		return valid;
	}


	// -----------------------------------------------------------------------------
	// Botón cerrar calendario
	// -----------------------------------------------------------------------------
	$(".js-close-calendar").on('click', function(e){
		$(this).closest(".responsive-calendar-wrap").removeClass("active");
	});


	// -----------------------------------------------------------------------------
	// Posicionamiento del calendario
	// Parámetros:
	// 		calendar(string):  id del calendario
	//		dateInput(string): id del input
	// -----------------------------------------------------------------------------
	function calendarPosition(calendar,dateInput) {

		var relativeY = dateInput.offset().top - dateInput.closest(".form-group").offset().top;

		// Ajuste de -1px
		var topPosition = dateInput.outerHeight()+relativeY - 1;

		// Establece las coordenadas y posiciona
		topPosition = topPosition + "px";

		// Si tiene a true la opción de ajustar a input (mismo width que input)
		if($(calendar).find('.responsive-calendar').attr("data-fit-to-input")) {
			$(calendar).closest('.responsive-calendar-wrap').css("top", topPosition).css("width",dateInput.closest(".form-group").outerWidth());
		}

		// Si tiene a true la opción de ajustar a ambos inputs
		if($(calendar).find('.responsive-calendar').attr("data-fit-to-range-input")) {
			var inputPadding = dateInput.closest('[class^="col-"]').css('padding-left');
			inputPadding = parseInt(inputPadding.replace("px", ""));

			var posRight = inputPadding;

      // Si los inputs están juntos no utilizamos el padding para posicionar el calendario y darle width
      if(dateInput.closest(".form-group").hasClass("js-input-wrapper")) {
          inputPadding = 0;
					posRight = inputPadding;
      }

			var widthToSet = dateInput.closest(".form-group")[0].getBoundingClientRect().width*2;

			if(dateInput.attr("data-range-type")=="start") {
				$(calendar).closest('.responsive-calendar-wrap').css("top", topPosition).css("width",widthToSet+(inputPadding*2));
			} else {
				if(dateInput.attr("data-range-type")=="end") {
					$(calendar).closest('.responsive-calendar-wrap').css("top", topPosition).css("width",widthToSet+(inputPadding*2)).css("right",posRight+"px");
				}
			}
		}


		// Se posiciona
		$(calendar).closest('.responsive-calendar-wrap').css("top", topPosition);
	}


	// -----------------------------------------------------------------------------
	// Reposicionamiento del calendario en resize
	// -----------------------------------------------------------------------------
	$( window ).resize(function() {
		var activeCal = $(".responsive-calendar-wrap.active");
		var inputReference = activeCal.attr("data-date-input");
		if(activeCal.length) {
			calendarPosition("#"+activeCal.attr("id"),$(inputReference));
		}
	});


  	// -----------------------------------------------------------------------------
  	// Le asigna la clase dada a la fecha dada y actualiza el input dado
  	// Parámetros:
  	//		cal (string): 			id del calendario en el que se encuentra la fecha
  	// 		currentDate (moment): 	fecha a actualizar
  	//		newClass (string): 		clase que se le asignará a la fecha
  	//		dateInput (string): 	id del input de la fecha (#dateInput)
  	// -----------------------------------------------------------------------------
  	function updateDate(calIn,calOut,currentDate,newClass,dateInput) {
  		var day;
  		var month;
  		var year;
  		var inputYear;
  		if(currentDate) {
  			day = currentDate.date();
  			month = (currentDate.month()+1);
  			year = currentDate.year();
  			inputYear = year.toString();

  			// Añade la nueva clase a la fecha
  			calIn.find('[data-day='+day+'][data-month='+month+'][data-year='+year+']').addClass(newClass);
  			calOut.find('[data-day='+day+'][data-month='+month+'][data-year='+year+']').addClass(newClass);

  			// Actualiza el input
  			if(dateInput.attr("data-short-year")) {
  				inputYear = inputYear.substring(2, 4);
  			}
  			dateInput.val(fillZeros(day.toString(),2,"left")+"/"+fillZeros(month.toString(),2,"left")+"/"+inputYear).change();
  		}
  	}

	// -----------------------------------------------------------------------------
	// Limpia los rangos de un calendario
	// Parámetros:
	//		cal (string): 			id del calendario en el que se encuentra la fecha
	// -----------------------------------------------------------------------------
	function resetRanges(cal) {
		cal.find(".range-start").removeClass("range-start");
		cal.find(".range-end").removeClass("range-end");
		cal.find(".range-in").removeClass("range-in");
	}


	// -----------------------------------------------------------------------------
	// Añade la clase range-in a los días intermedios entre range-start y range-end
	// Parámetros:
	//		cal (string): 			id del calendario en el que se encuentran la fechas
	// -----------------------------------------------------------------------------
	function paintRange(cal) {
		resetRanges(cal);

		if(cal.attr("data-range-start") && cal.attr("data-range-start")!="" && cal.attr("data-range-end") && cal.attr("data-range-end")!="") {

			var rangeStart = parseInt(cal.attr("data-range-start"));
			var rangeEnd = parseInt(cal.attr("data-range-end"));

			var dateStart = moment(rangeStart);
			var dateEnd = moment(rangeEnd);

			cal.find('[data-day='+dateStart.date()+'][data-month='+(dateStart.month()+1)+'][data-year='+dateStart.year()+']').addClass("range-start");
			cal.find('[data-day='+dateEnd.date()+'][data-month='+(dateEnd.month()+1)+'][data-year='+dateEnd.year()+']').addClass("range-end");

			while(!dateStart.isAfter(dateEnd)) {
				var currentDay = cal.find('[data-day='+dateStart.date()+'][data-month='+(dateStart.month()+1)+'][data-year='+dateStart.year()+']');
				if(!currentDay.hasClass("range-start") && !currentDay.hasClass("range-end")) {
					currentDay.addClass("range-in");
				}
				dateStart.add(1, 'day');
			}
		} else {
			if (cal.attr("data-range-start") && cal.attr("data-range-start")!="") {

				var rangeStart = parseInt(cal.attr("data-range-start"));
				var dateStart = moment(rangeStart);
				cal.find('[data-day='+dateStart.date()+'][data-month='+(dateStart.month()+1)+'][data-year='+dateStart.year()+']').addClass("range-start");

			} else {

				var rangeEnd = parseInt(cal.attr("data-range-end"));
				var dateEnd = moment(rangeEnd);
				cal.find('[data-day='+dateEnd.date()+'][data-month='+(dateEnd.month()+1)+'][data-year='+dateEnd.year()+']').addClass("range-end");

			}
		}

	}

	// -----------------------------------------------------------------------------
	// Rellena con 0 hasta llegar a la longitud especificada.
	// Parámetros:
	// 		val: valor original
	//		len: longitud que debe tener
	//		dir: si es "left" rellena a la izquierda, si "right" a la derecha
	// -----------------------------------------------------------------------------
	function fillZeros(val,len,dir) {
		if(dir=="left") {
			while(val.length<len) {
				val="0"+val;
			}
		} else {
			while(val.length<len) {
				val=val+"0";
			}
		}
		return val;
	}


	//Pintamos los Blackouts
	function paintBlackOuts(){
		//alert($('[data-day=26][data-month=10][data-year=2016]').html());
		var blacks = getBlackOuts();
		for (var i=0; i<blacks.length; i++){
			var ab = blacks[i].split("-");
			var month = ab[1];
			$('[data-day='+ab[2]+'][data-month='+month+'][data-year='+ab[0]+']').parent().removeClass("future");
			//alert($('[data-day='+ab[2]+'][data-month='+ab[1]+'][data-year='+ab[0]+']').html());
			$('[data-day='+ab[2]+'][data-month='+month+'][data-year='+ab[0]+']').parent().addClass("past");
		}
	}
	// Funcion que obtiene un array con todos los balckouts
	//En produccion su contenido debe ser reemplazado con un $ajax al servidor que devuelva la misma estructura de datos
	function getBlackOuts(){
		if(typeof(dateString) != "undefined"){ var aDates = dateString.split("*"); }
		else{ var aDates = ""; }
		return aDates;
	}

  //Validamos si hay un blackout entre dos fechas seleccionadas
	function validateBlackOuts(date1,date2){
		var blacks = getBlackOuts();
		var blackDay = null;
		var black = null;
		var blackDate = null;
		for (var i=0; i<blacks.length; i++){
			//operamos con fechas
			blackDay = blacks[i].split("-");
			black = moment(blacks[i]);
			blackDate = moment({ year: parseInt(blackDay[0]), month: ( parseInt(blackDay[1]) - 1), day : parseInt(blackDay[2])});
			if (blackDate.isBetween(date1,date2) || blackDate.isSame(date1) || blackDate.isSame(date2)){
				return false;
			}
		}
		return true;
	}

});
/*
     _ _      _       _
 ___| (_) ___| | __  (_)___
/ __| | |/ __| |/ /  | / __|
\__ \ | | (__|   < _ | \__ \
|___/_|_|\___|_|\_(_)/ |___/
                   |__/

 Version: 1.8.0
  Author: Ken Wheeler
 Website: http://kenwheeler.github.io
    Docs: http://kenwheeler.github.io/slick
    Repo: http://github.com/kenwheeler/slick
  Issues: http://github.com/kenwheeler/slick/issues

 */
/* global window, document, define, jQuery, setInterval, clearInterval */
;(function(factory) {
    'use strict';
    if (typeof define === 'function' && define.amd) {
        define(['jquery'], factory);
    } else if (typeof exports !== 'undefined') {
        module.exports = factory(require('jquery'));
    } else {
        factory(jQuery);
    }

}(function($) {
    'use strict';
    var Slick = window.Slick || {};

    Slick = (function() {

        var instanceUid = 0;

        function Slick(element, settings) {

            var _ = this, dataSettings;

            _.defaults = {
                accessibility: true,
                adaptiveHeight: false,
                appendArrows: $(element),
                appendDots: $(element),
                arrows: true,
                asNavFor: null,
                prevArrow: '<button class="slick-prev" aria-label="Previous" type="button">Previous</button>',
                nextArrow: '<button class="slick-next" aria-label="Next" type="button">Next</button>',
                autoplay: false,
                autoplaySpeed: 3000,
                centerMode: false,
                centerPadding: '50px',
                cssEase: 'ease',
                customPaging: function(slider, i) {
                    return $('<button type="button" />').text(i + 1);
                },
                dots: false,
                dotsClass: 'slick-dots',
                draggable: true,
                easing: 'linear',
                edgeFriction: 0.35,
                fade: false,
                focusOnSelect: false,
                focusOnChange: false,
                infinite: true,
                initialSlide: 0,
                lazyLoad: 'ondemand',
                mobileFirst: false,
                pauseOnHover: true,
                pauseOnFocus: true,
                pauseOnDotsHover: false,
                respondTo: 'window',
                responsive: null,
                rows: 1,
                rtl: false,
                slide: '',
                slidesPerRow: 1,
                slidesToShow: 1,
                slidesToScroll: 1,
                speed: 500,
                swipe: true,
                swipeToSlide: false,
                touchMove: true,
                touchThreshold: 5,
                useCSS: true,
                useTransform: true,
                variableWidth: false,
                vertical: false,
                verticalSwiping: false,
                waitForAnimate: true,
                zIndex: 1000
            };

            _.initials = {
                animating: false,
                dragging: false,
                autoPlayTimer: null,
                currentDirection: 0,
                currentLeft: null,
                currentSlide: 0,
                direction: 1,
                $dots: null,
                listWidth: null,
                listHeight: null,
                loadIndex: 0,
                $nextArrow: null,
                $prevArrow: null,
                scrolling: false,
                slideCount: null,
                slideWidth: null,
                $slideTrack: null,
                $slides: null,
                sliding: false,
                slideOffset: 0,
                swipeLeft: null,
                swiping: false,
                $list: null,
                touchObject: {},
                transformsEnabled: false,
                unslicked: false
            };

            $.extend(_, _.initials);

            _.activeBreakpoint = null;
            _.animType = null;
            _.animProp = null;
            _.breakpoints = [];
            _.breakpointSettings = [];
            _.cssTransitions = false;
            _.focussed = false;
            _.interrupted = false;
            _.hidden = 'hidden';
            _.paused = true;
            _.positionProp = null;
            _.respondTo = null;
            _.rowCount = 1;
            _.shouldClick = true;
            _.$slider = $(element);
            _.$slidesCache = null;
            _.transformType = null;
            _.transitionType = null;
            _.visibilityChange = 'visibilitychange';
            _.windowWidth = 0;
            _.windowTimer = null;

            dataSettings = $(element).data('slick') || {};

            _.options = $.extend({}, _.defaults, settings, dataSettings);

            _.currentSlide = _.options.initialSlide;

            _.originalSettings = _.options;

            if (typeof document.mozHidden !== 'undefined') {
                _.hidden = 'mozHidden';
                _.visibilityChange = 'mozvisibilitychange';
            } else if (typeof document.webkitHidden !== 'undefined') {
                _.hidden = 'webkitHidden';
                _.visibilityChange = 'webkitvisibilitychange';
            }

            _.autoPlay = $.proxy(_.autoPlay, _);
            _.autoPlayClear = $.proxy(_.autoPlayClear, _);
            _.autoPlayIterator = $.proxy(_.autoPlayIterator, _);
            _.changeSlide = $.proxy(_.changeSlide, _);
            _.clickHandler = $.proxy(_.clickHandler, _);
            _.selectHandler = $.proxy(_.selectHandler, _);
            _.setPosition = $.proxy(_.setPosition, _);
            _.swipeHandler = $.proxy(_.swipeHandler, _);
            _.dragHandler = $.proxy(_.dragHandler, _);
            _.keyHandler = $.proxy(_.keyHandler, _);

            _.instanceUid = instanceUid++;

            // A simple way to check for HTML strings
            // Strict HTML recognition (must start with <)
            // Extracted from jQuery v1.11 source
            _.htmlExpr = /^(?:\s*(<[\w\W]+>)[^>]*)$/;


            _.registerBreakpoints();
            _.init(true);

        }

        return Slick;

    }());

    Slick.prototype.activateADA = function() {
        var _ = this;

        _.$slideTrack.find('.slick-active').attr({
            'aria-hidden': 'false'
        }).find('a, input, button, select').attr({
            'tabindex': '0'
        });

    };

    Slick.prototype.addSlide = Slick.prototype.slickAdd = function(markup, index, addBefore) {

        var _ = this;

        if (typeof(index) === 'boolean') {
            addBefore = index;
            index = null;
        } else if (index < 0 || (index >= _.slideCount)) {
            return false;
        }

        _.unload();

        if (typeof(index) === 'number') {
            if (index === 0 && _.$slides.length === 0) {
                $(markup).appendTo(_.$slideTrack);
            } else if (addBefore) {
                $(markup).insertBefore(_.$slides.eq(index));
            } else {
                $(markup).insertAfter(_.$slides.eq(index));
            }
        } else {
            if (addBefore === true) {
                $(markup).prependTo(_.$slideTrack);
            } else {
                $(markup).appendTo(_.$slideTrack);
            }
        }

        _.$slides = _.$slideTrack.children(this.options.slide);

        _.$slideTrack.children(this.options.slide).detach();

        _.$slideTrack.append(_.$slides);

        _.$slides.each(function(index, element) {
            $(element).attr('data-slick-index', index);
        });

        _.$slidesCache = _.$slides;

        _.reinit();

    };

    Slick.prototype.animateHeight = function() {
        var _ = this;
        if (_.options.slidesToShow === 1 && _.options.adaptiveHeight === true && _.options.vertical === false) {
            var targetHeight = _.$slides.eq(_.currentSlide).outerHeight(true);
            _.$list.animate({
                height: targetHeight
            }, _.options.speed);
        }
    };

    Slick.prototype.animateSlide = function(targetLeft, callback) {

        var animProps = {},
            _ = this;

        _.animateHeight();

        if (_.options.rtl === true && _.options.vertical === false) {
            targetLeft = -targetLeft;
        }
        if (_.transformsEnabled === false) {
            if (_.options.vertical === false) {
                _.$slideTrack.animate({
                    left: targetLeft
                }, _.options.speed, _.options.easing, callback);
            } else {
                _.$slideTrack.animate({
                    top: targetLeft
                }, _.options.speed, _.options.easing, callback);
            }

        } else {

            if (_.cssTransitions === false) {
                if (_.options.rtl === true) {
                    _.currentLeft = -(_.currentLeft);
                }
                $({
                    animStart: _.currentLeft
                }).animate({
                    animStart: targetLeft
                }, {
                    duration: _.options.speed,
                    easing: _.options.easing,
                    step: function(now) {
                        now = Math.ceil(now);
                        if (_.options.vertical === false) {
                            animProps[_.animType] = 'translate(' +
                                now + 'px, 0px)';
                            _.$slideTrack.css(animProps);
                        } else {
                            animProps[_.animType] = 'translate(0px,' +
                                now + 'px)';
                            _.$slideTrack.css(animProps);
                        }
                    },
                    complete: function() {
                        if (callback) {
                            callback.call();
                        }
                    }
                });

            } else {

                _.applyTransition();
                targetLeft = Math.ceil(targetLeft);

                if (_.options.vertical === false) {
                    animProps[_.animType] = 'translate3d(' + targetLeft + 'px, 0px, 0px)';
                } else {
                    animProps[_.animType] = 'translate3d(0px,' + targetLeft + 'px, 0px)';
                }
                _.$slideTrack.css(animProps);

                if (callback) {
                    setTimeout(function() {

                        _.disableTransition();

                        callback.call();
                    }, _.options.speed);
                }

            }

        }

    };

    Slick.prototype.getNavTarget = function() {

        var _ = this,
            asNavFor = _.options.asNavFor;

        if ( asNavFor && asNavFor !== null ) {
            asNavFor = $(asNavFor).not(_.$slider);
        }

        return asNavFor;

    };

    Slick.prototype.asNavFor = function(index) {

        var _ = this,
            asNavFor = _.getNavTarget();

        if ( asNavFor !== null && typeof asNavFor === 'object' ) {
            asNavFor.each(function() {
                var target = $(this).slick('getSlick');
                if(!target.unslicked) {
                    target.slideHandler(index, true);
                }
            });
        }

    };

    Slick.prototype.applyTransition = function(slide) {

        var _ = this,
            transition = {};

        if (_.options.fade === false) {
            transition[_.transitionType] = _.transformType + ' ' + _.options.speed + 'ms ' + _.options.cssEase;
        } else {
            transition[_.transitionType] = 'opacity ' + _.options.speed + 'ms ' + _.options.cssEase;
        }

        if (_.options.fade === false) {
            _.$slideTrack.css(transition);
        } else {
            _.$slides.eq(slide).css(transition);
        }

    };

    Slick.prototype.autoPlay = function() {

        var _ = this;

        _.autoPlayClear();

        if ( _.slideCount > _.options.slidesToShow ) {
            _.autoPlayTimer = setInterval( _.autoPlayIterator, _.options.autoplaySpeed );
        }

    };

    Slick.prototype.autoPlayClear = function() {

        var _ = this;

        if (_.autoPlayTimer) {
            clearInterval(_.autoPlayTimer);
        }

    };

    Slick.prototype.autoPlayIterator = function() {

        var _ = this,
            slideTo = _.currentSlide + _.options.slidesToScroll;

        if ( !_.paused && !_.interrupted && !_.focussed ) {

            if ( _.options.infinite === false ) {

                if ( _.direction === 1 && ( _.currentSlide + 1 ) === ( _.slideCount - 1 )) {
                    _.direction = 0;
                }

                else if ( _.direction === 0 ) {

                    slideTo = _.currentSlide - _.options.slidesToScroll;

                    if ( _.currentSlide - 1 === 0 ) {
                        _.direction = 1;
                    }

                }

            }

            _.slideHandler( slideTo );

        }

    };

    Slick.prototype.buildArrows = function() {

        var _ = this;

        if (_.options.arrows === true ) {

            _.$prevArrow = $(_.options.prevArrow).addClass('slick-arrow');
            _.$nextArrow = $(_.options.nextArrow).addClass('slick-arrow');

            if( _.slideCount > _.options.slidesToShow ) {

                _.$prevArrow.removeClass('slick-hidden').removeAttr('aria-hidden tabindex');
                _.$nextArrow.removeClass('slick-hidden').removeAttr('aria-hidden tabindex');

                if (_.htmlExpr.test(_.options.prevArrow)) {
                    _.$prevArrow.prependTo(_.options.appendArrows);
                }

                if (_.htmlExpr.test(_.options.nextArrow)) {
                    _.$nextArrow.appendTo(_.options.appendArrows);
                }

                if (_.options.infinite !== true) {
                    _.$prevArrow
                        .addClass('slick-disabled')
                        .attr('aria-disabled', 'true');
                }

            } else {

                _.$prevArrow.add( _.$nextArrow )

                    .addClass('slick-hidden')
                    .attr({
                        'aria-disabled': 'true',
                        'tabindex': '-1'
                    });

            }

        }

    };

    Slick.prototype.buildDots = function() {

        var _ = this,
            i, dot;

        if (_.options.dots === true && _.slideCount > _.options.slidesToShow) {

            _.$slider.addClass('slick-dotted');

            dot = $('<ul />').addClass(_.options.dotsClass);

            for (i = 0; i <= _.getDotCount(); i += 1) {
                dot.append($('<li />').append(_.options.customPaging.call(this, _, i)));
            }

            _.$dots = dot.appendTo(_.options.appendDots);

            _.$dots.find('li').first().addClass('slick-active');

        }

    };

    Slick.prototype.buildOut = function() {

        var _ = this;

        _.$slides =
            _.$slider
                .children( _.options.slide + ':not(.slick-cloned)')
                .addClass('slick-slide');

        _.slideCount = _.$slides.length;

        _.$slides.each(function(index, element) {
            $(element)
                .attr('data-slick-index', index)
                .data('originalStyling', $(element).attr('style') || '');
        });

        _.$slider.addClass('slick-slider');

        _.$slideTrack = (_.slideCount === 0) ?
            $('<div class="slick-track"/>').appendTo(_.$slider) :
            _.$slides.wrapAll('<div class="slick-track"/>').parent();

        _.$list = _.$slideTrack.wrap(
            '<div class="slick-list"/>').parent();
        _.$slideTrack.css('opacity', 0);

        if (_.options.centerMode === true || _.options.swipeToSlide === true) {
            _.options.slidesToScroll = 1;
        }

        $('img[data-lazy]', _.$slider).not('[src]').addClass('slick-loading');

        _.setupInfinite();

        _.buildArrows();

        _.buildDots();

        _.updateDots();


        _.setSlideClasses(typeof _.currentSlide === 'number' ? _.currentSlide : 0);

        if (_.options.draggable === true) {
            _.$list.addClass('draggable');
        }

    };

    Slick.prototype.buildRows = function() {

        var _ = this, a, b, c, newSlides, numOfSlides, originalSlides,slidesPerSection;

        newSlides = document.createDocumentFragment();
        originalSlides = _.$slider.children();

        if(_.options.rows > 0) {

            slidesPerSection = _.options.slidesPerRow * _.options.rows;
            numOfSlides = Math.ceil(
                originalSlides.length / slidesPerSection
            );

            for(a = 0; a < numOfSlides; a++){
                var slide = document.createElement('div');
                for(b = 0; b < _.options.rows; b++) {
                    var row = document.createElement('div');
                    for(c = 0; c < _.options.slidesPerRow; c++) {
                        var target = (a * slidesPerSection + ((b * _.options.slidesPerRow) + c));
                        if (originalSlides.get(target)) {
                            row.appendChild(originalSlides.get(target));
                        }
                    }
                    slide.appendChild(row);
                }
                newSlides.appendChild(slide);
            }

            _.$slider.empty().append(newSlides);
            _.$slider.children().children().children()
                .css({
                    'width':(100 / _.options.slidesPerRow) + '%',
                    'display': 'inline-block'
                });

        }

    };

    Slick.prototype.checkResponsive = function(initial, forceUpdate) {

        var _ = this,
            breakpoint, targetBreakpoint, respondToWidth, triggerBreakpoint = false;
        var sliderWidth = _.$slider.width();
        var windowWidth = window.innerWidth || $(window).width();

        if (_.respondTo === 'window') {
            respondToWidth = windowWidth;
        } else if (_.respondTo === 'slider') {
            respondToWidth = sliderWidth;
        } else if (_.respondTo === 'min') {
            respondToWidth = Math.min(windowWidth, sliderWidth);
        }

        if ( _.options.responsive &&
            _.options.responsive.length &&
            _.options.responsive !== null) {

            targetBreakpoint = null;

            for (breakpoint in _.breakpoints) {
                if (_.breakpoints.hasOwnProperty(breakpoint)) {
                    if (_.originalSettings.mobileFirst === false) {
                        if (respondToWidth < _.breakpoints[breakpoint]) {
                            targetBreakpoint = _.breakpoints[breakpoint];
                        }
                    } else {
                        if (respondToWidth > _.breakpoints[breakpoint]) {
                            targetBreakpoint = _.breakpoints[breakpoint];
                        }
                    }
                }
            }

            if (targetBreakpoint !== null) {
                if (_.activeBreakpoint !== null) {
                    if (targetBreakpoint !== _.activeBreakpoint || forceUpdate) {
                        _.activeBreakpoint =
                            targetBreakpoint;
                        if (_.breakpointSettings[targetBreakpoint] === 'unslick') {
                            _.unslick(targetBreakpoint);
                        } else {
                            _.options = $.extend({}, _.originalSettings,
                                _.breakpointSettings[
                                    targetBreakpoint]);
                            if (initial === true) {
                                _.currentSlide = _.options.initialSlide;
                            }
                            _.refresh(initial);
                        }
                        triggerBreakpoint = targetBreakpoint;
                    }
                } else {
                    _.activeBreakpoint = targetBreakpoint;
                    if (_.breakpointSettings[targetBreakpoint] === 'unslick') {
                        _.unslick(targetBreakpoint);
                    } else {
                        _.options = $.extend({}, _.originalSettings,
                            _.breakpointSettings[
                                targetBreakpoint]);
                        if (initial === true) {
                            _.currentSlide = _.options.initialSlide;
                        }
                        _.refresh(initial);
                    }
                    triggerBreakpoint = targetBreakpoint;
                }
            } else {
                if (_.activeBreakpoint !== null) {
                    _.activeBreakpoint = null;
                    _.options = _.originalSettings;
                    if (initial === true) {
                        _.currentSlide = _.options.initialSlide;
                    }
                    _.refresh(initial);
                    triggerBreakpoint = targetBreakpoint;
                }
            }

            // only trigger breakpoints during an actual break. not on initialize.
            if( !initial && triggerBreakpoint !== false ) {
                _.$slider.trigger('breakpoint', [_, triggerBreakpoint]);
            }
        }

    };

    Slick.prototype.changeSlide = function(event, dontAnimate) {

        var _ = this,
            $target = $(event.currentTarget),
            indexOffset, slideOffset, unevenOffset;

        // If target is a link, prevent default action.
        if($target.is('a')) {
            event.preventDefault();
        }

        // If target is not the <li> element (ie: a child), find the <li>.
        if(!$target.is('li')) {
            $target = $target.closest('li');
        }

        unevenOffset = (_.slideCount % _.options.slidesToScroll !== 0);
        indexOffset = unevenOffset ? 0 : (_.slideCount - _.currentSlide) % _.options.slidesToScroll;

        switch (event.data.message) {

            case 'previous':
                slideOffset = indexOffset === 0 ? _.options.slidesToScroll : _.options.slidesToShow - indexOffset;
                if (_.slideCount > _.options.slidesToShow) {
                    _.slideHandler(_.currentSlide - slideOffset, false, dontAnimate);
                }
                break;

            case 'next':
                slideOffset = indexOffset === 0 ? _.options.slidesToScroll : indexOffset;
                if (_.slideCount > _.options.slidesToShow) {
                    _.slideHandler(_.currentSlide + slideOffset, false, dontAnimate);
                }
                break;

            case 'index':
                var index = event.data.index === 0 ? 0 :
                    event.data.index || $target.index() * _.options.slidesToScroll;

                _.slideHandler(_.checkNavigable(index), false, dontAnimate);
                $target.children().trigger('focus');
                break;

            default:
                return;
        }

    };

    Slick.prototype.checkNavigable = function(index) {

        var _ = this,
            navigables, prevNavigable;

        navigables = _.getNavigableIndexes();
        prevNavigable = 0;
        if (index > navigables[navigables.length - 1]) {
            index = navigables[navigables.length - 1];
        } else {
            for (var n in navigables) {
                if (index < navigables[n]) {
                    index = prevNavigable;
                    break;
                }
                prevNavigable = navigables[n];
            }
        }

        return index;
    };

    Slick.prototype.cleanUpEvents = function() {

        var _ = this;

        if (_.options.dots && _.$dots !== null) {

            $('li', _.$dots)
                .off('click.slick', _.changeSlide)
                .off('mouseenter.slick', $.proxy(_.interrupt, _, true))
                .off('mouseleave.slick', $.proxy(_.interrupt, _, false));

            if (_.options.accessibility === true) {
                _.$dots.off('keydown.slick', _.keyHandler);
            }
        }

        _.$slider.off('focus.slick blur.slick');

        if (_.options.arrows === true && _.slideCount > _.options.slidesToShow) {
            _.$prevArrow && _.$prevArrow.off('click.slick', _.changeSlide);
            _.$nextArrow && _.$nextArrow.off('click.slick', _.changeSlide);

            if (_.options.accessibility === true) {
                _.$prevArrow && _.$prevArrow.off('keydown.slick', _.keyHandler);
                _.$nextArrow && _.$nextArrow.off('keydown.slick', _.keyHandler);
            }
        }

        _.$list.off('touchstart.slick mousedown.slick', _.swipeHandler);
        _.$list.off('touchmove.slick mousemove.slick', _.swipeHandler);
        _.$list.off('touchend.slick mouseup.slick', _.swipeHandler);
        _.$list.off('touchcancel.slick mouseleave.slick', _.swipeHandler);

        _.$list.off('click.slick', _.clickHandler);

        $(document).off(_.visibilityChange, _.visibility);

        _.cleanUpSlideEvents();

        if (_.options.accessibility === true) {
            _.$list.off('keydown.slick', _.keyHandler);
        }

        if (_.options.focusOnSelect === true) {
            $(_.$slideTrack).children().off('click.slick', _.selectHandler);
        }

        $(window).off('orientationchange.slick.slick-' + _.instanceUid, _.orientationChange);

        $(window).off('resize.slick.slick-' + _.instanceUid, _.resize);

        $('[draggable!=true]', _.$slideTrack).off('dragstart', _.preventDefault);

        $(window).off('load.slick.slick-' + _.instanceUid, _.setPosition);

    };

    Slick.prototype.cleanUpSlideEvents = function() {

        var _ = this;

        _.$list.off('mouseenter.slick', $.proxy(_.interrupt, _, true));
        _.$list.off('mouseleave.slick', $.proxy(_.interrupt, _, false));

    };

    Slick.prototype.cleanUpRows = function() {

        var _ = this, originalSlides;

        if(_.options.rows > 0) {
            originalSlides = _.$slides.children().children();
            originalSlides.removeAttr('style');
            _.$slider.empty().append(originalSlides);
        }

    };

    Slick.prototype.clickHandler = function(event) {

        var _ = this;

        if (_.shouldClick === false) {
            event.stopImmediatePropagation();
            event.stopPropagation();
            event.preventDefault();
        }

    };

    Slick.prototype.destroy = function(refresh) {

        var _ = this;

        _.autoPlayClear();

        _.touchObject = {};

        _.cleanUpEvents();

        $('.slick-cloned', _.$slider).detach();

        if (_.$dots) {
            _.$dots.remove();
        }

        if ( _.$prevArrow && _.$prevArrow.length ) {

            _.$prevArrow
                .removeClass('slick-disabled slick-arrow slick-hidden')
                .removeAttr('aria-hidden aria-disabled tabindex')
                .css('display','');

            if ( _.htmlExpr.test( _.options.prevArrow )) {
                _.$prevArrow.remove();
            }
        }

        if ( _.$nextArrow && _.$nextArrow.length ) {

            _.$nextArrow
                .removeClass('slick-disabled slick-arrow slick-hidden')
                .removeAttr('aria-hidden aria-disabled tabindex')
                .css('display','');

            if ( _.htmlExpr.test( _.options.nextArrow )) {
                _.$nextArrow.remove();
            }
        }


        if (_.$slides) {

            _.$slides
                .removeClass('slick-slide slick-active slick-center slick-visible slick-current')
                .removeAttr('aria-hidden')
                .removeAttr('data-slick-index')
                .each(function(){
                    $(this).attr('style', $(this).data('originalStyling'));
                });

            _.$slideTrack.children(this.options.slide).detach();

            _.$slideTrack.detach();

            _.$list.detach();

            _.$slider.append(_.$slides);
        }

        _.cleanUpRows();

        _.$slider.removeClass('slick-slider');
        _.$slider.removeClass('slick-initialized');
        _.$slider.removeClass('slick-dotted');

        _.unslicked = true;

        if(!refresh) {
            _.$slider.trigger('destroy', [_]);
        }

    };

    Slick.prototype.disableTransition = function(slide) {

        var _ = this,
            transition = {};

        transition[_.transitionType] = '';

        if (_.options.fade === false) {
            _.$slideTrack.css(transition);
        } else {
            _.$slides.eq(slide).css(transition);
        }

    };

    Slick.prototype.fadeSlide = function(slideIndex, callback) {

        var _ = this;

        if (_.cssTransitions === false) {

            _.$slides.eq(slideIndex).css({
                zIndex: _.options.zIndex
            });

            _.$slides.eq(slideIndex).animate({
                opacity: 1
            }, _.options.speed, _.options.easing, callback);

        } else {

            _.applyTransition(slideIndex);

            _.$slides.eq(slideIndex).css({
                opacity: 1,
                zIndex: _.options.zIndex
            });

            if (callback) {
                setTimeout(function() {

                    _.disableTransition(slideIndex);

                    callback.call();
                }, _.options.speed);
            }

        }

    };

    Slick.prototype.fadeSlideOut = function(slideIndex) {

        var _ = this;

        if (_.cssTransitions === false) {

            _.$slides.eq(slideIndex).animate({
                opacity: 0,
                zIndex: _.options.zIndex - 2
            }, _.options.speed, _.options.easing);

        } else {

            _.applyTransition(slideIndex);

            _.$slides.eq(slideIndex).css({
                opacity: 0,
                zIndex: _.options.zIndex - 2
            });

        }

    };

    Slick.prototype.filterSlides = Slick.prototype.slickFilter = function(filter) {

        var _ = this;

        if (filter !== null) {

            _.$slidesCache = _.$slides;

            _.unload();

            _.$slideTrack.children(this.options.slide).detach();

            _.$slidesCache.filter(filter).appendTo(_.$slideTrack);

            _.reinit();

        }

    };

    Slick.prototype.focusHandler = function() {

        var _ = this;

        _.$slider
            .off('focus.slick blur.slick')
            .on('focus.slick blur.slick', '*', function(event) {

            event.stopImmediatePropagation();
            var $sf = $(this);

            setTimeout(function() {

                if( _.options.pauseOnFocus ) {
                    _.focussed = $sf.is(':focus');
                    _.autoPlay();
                }

            }, 0);

        });
    };

    Slick.prototype.getCurrent = Slick.prototype.slickCurrentSlide = function() {

        var _ = this;
        return _.currentSlide;

    };

    Slick.prototype.getDotCount = function() {

        var _ = this;

        var breakPoint = 0;
        var counter = 0;
        var pagerQty = 0;

        if (_.options.infinite === true) {
            if (_.slideCount <= _.options.slidesToShow) {
                 ++pagerQty;
            } else {
                while (breakPoint < _.slideCount) {
                    ++pagerQty;
                    breakPoint = counter + _.options.slidesToScroll;
                    counter += _.options.slidesToScroll <= _.options.slidesToShow ? _.options.slidesToScroll : _.options.slidesToShow;
                }
            }
        } else if (_.options.centerMode === true) {
            pagerQty = _.slideCount;
        } else if(!_.options.asNavFor) {
            pagerQty = 1 + Math.ceil((_.slideCount - _.options.slidesToShow) / _.options.slidesToScroll);
        }else {
            while (breakPoint < _.slideCount) {
                ++pagerQty;
                breakPoint = counter + _.options.slidesToScroll;
                counter += _.options.slidesToScroll <= _.options.slidesToShow ? _.options.slidesToScroll : _.options.slidesToShow;
            }
        }

        return pagerQty - 1;

    };

    Slick.prototype.getLeft = function(slideIndex) {

        var _ = this,
            targetLeft,
            verticalHeight,
            verticalOffset = 0,
            targetSlide,
            coef;

        _.slideOffset = 0;
        verticalHeight = _.$slides.first().outerHeight(true);

        if (_.options.infinite === true) {
            if (_.slideCount > _.options.slidesToShow) {
                _.slideOffset = (_.slideWidth * _.options.slidesToShow) * -1;
                coef = -1

                if (_.options.vertical === true && _.options.centerMode === true) {
                    if (_.options.slidesToShow === 2) {
                        coef = -1.5;
                    } else if (_.options.slidesToShow === 1) {
                        coef = -2
                    }
                }
                verticalOffset = (verticalHeight * _.options.slidesToShow) * coef;
            }
            if (_.slideCount % _.options.slidesToScroll !== 0) {
                if (slideIndex + _.options.slidesToScroll > _.slideCount && _.slideCount > _.options.slidesToShow) {
                    if (slideIndex > _.slideCount) {
                        _.slideOffset = ((_.options.slidesToShow - (slideIndex - _.slideCount)) * _.slideWidth) * -1;
                        verticalOffset = ((_.options.slidesToShow - (slideIndex - _.slideCount)) * verticalHeight) * -1;
                    } else {
                        _.slideOffset = ((_.slideCount % _.options.slidesToScroll) * _.slideWidth) * -1;
                        verticalOffset = ((_.slideCount % _.options.slidesToScroll) * verticalHeight) * -1;
                    }
                }
            }
        } else {
            if (slideIndex + _.options.slidesToShow > _.slideCount) {
                _.slideOffset = ((slideIndex + _.options.slidesToShow) - _.slideCount) * _.slideWidth;
                verticalOffset = ((slideIndex + _.options.slidesToShow) - _.slideCount) * verticalHeight;
            }
        }

        if (_.slideCount <= _.options.slidesToShow) {
            _.slideOffset = 0;
            verticalOffset = 0;
        }

        if (_.options.centerMode === true && _.slideCount <= _.options.slidesToShow) {
            _.slideOffset = ((_.slideWidth * Math.floor(_.options.slidesToShow)) / 2) - ((_.slideWidth * _.slideCount) / 2);
        } else if (_.options.centerMode === true && _.options.infinite === true) {
            _.slideOffset += _.slideWidth * Math.floor(_.options.slidesToShow / 2) - _.slideWidth;
        } else if (_.options.centerMode === true) {
            _.slideOffset = 0;
            _.slideOffset += _.slideWidth * Math.floor(_.options.slidesToShow / 2);
        }

        if (_.options.vertical === false) {
            targetLeft = ((slideIndex * _.slideWidth) * -1) + _.slideOffset;
        } else {
            targetLeft = ((slideIndex * verticalHeight) * -1) + verticalOffset;
        }

        if (_.options.variableWidth === true) {

            if (_.slideCount <= _.options.slidesToShow || _.options.infinite === false) {
                targetSlide = _.$slideTrack.children('.slick-slide').eq(slideIndex);
            } else {
                targetSlide = _.$slideTrack.children('.slick-slide').eq(slideIndex + _.options.slidesToShow);
            }

            if (_.options.rtl === true) {
                if (targetSlide[0]) {
                    targetLeft = (_.$slideTrack.width() - targetSlide[0].offsetLeft - targetSlide.width()) * -1;
                } else {
                    targetLeft =  0;
                }
            } else {
                targetLeft = targetSlide[0] ? targetSlide[0].offsetLeft * -1 : 0;
            }

            if (_.options.centerMode === true) {
                if (_.slideCount <= _.options.slidesToShow || _.options.infinite === false) {
                    targetSlide = _.$slideTrack.children('.slick-slide').eq(slideIndex);
                } else {
                    targetSlide = _.$slideTrack.children('.slick-slide').eq(slideIndex + _.options.slidesToShow + 1);
                }

                if (_.options.rtl === true) {
                    if (targetSlide[0]) {
                        targetLeft = (_.$slideTrack.width() - targetSlide[0].offsetLeft - targetSlide.width()) * -1;
                    } else {
                        targetLeft =  0;
                    }
                } else {
                    targetLeft = targetSlide[0] ? targetSlide[0].offsetLeft * -1 : 0;
                }

                targetLeft += (_.$list.width() - targetSlide.outerWidth()) / 2;
            }
        }

        return targetLeft;

    };

    Slick.prototype.getOption = Slick.prototype.slickGetOption = function(option) {

        var _ = this;

        return _.options[option];

    };

    Slick.prototype.getNavigableIndexes = function() {

        var _ = this,
            breakPoint = 0,
            counter = 0,
            indexes = [],
            max;

        if (_.options.infinite === false) {
            max = _.slideCount;
        } else {
            breakPoint = _.options.slidesToScroll * -1;
            counter = _.options.slidesToScroll * -1;
            max = _.slideCount * 2;
        }

        while (breakPoint < max) {
            indexes.push(breakPoint);
            breakPoint = counter + _.options.slidesToScroll;
            counter += _.options.slidesToScroll <= _.options.slidesToShow ? _.options.slidesToScroll : _.options.slidesToShow;
        }

        return indexes;

    };

    Slick.prototype.getSlick = function() {

        return this;

    };

    Slick.prototype.getSlideCount = function() {

        var _ = this,
            slidesTraversed, swipedSlide, centerOffset;

        centerOffset = _.options.centerMode === true ? _.slideWidth * Math.floor(_.options.slidesToShow / 2) : 0;

        if (_.options.swipeToSlide === true) {
            _.$slideTrack.find('.slick-slide').each(function(index, slide) {
                if (slide.offsetLeft - centerOffset + ($(slide).outerWidth() / 2) > (_.swipeLeft * -1)) {
                    swipedSlide = slide;
                    return false;
                }
            });

            slidesTraversed = Math.abs($(swipedSlide).attr('data-slick-index') - _.currentSlide) || 1;

            return slidesTraversed;

        } else {
            return _.options.slidesToScroll;
        }

    };

    Slick.prototype.goTo = Slick.prototype.slickGoTo = function(slide, dontAnimate) {

        var _ = this;

        _.changeSlide({
            data: {
                message: 'index',
                index: parseInt(slide)
            }
        }, dontAnimate);

    };

    Slick.prototype.init = function(creation) {

        var _ = this;

        if (!$(_.$slider).hasClass('slick-initialized')) {

            $(_.$slider).addClass('slick-initialized');

            _.buildRows();
            _.buildOut();
            _.setProps();
            _.startLoad();
            _.loadSlider();
            _.initializeEvents();
            _.updateArrows();
            _.updateDots();
            _.checkResponsive(true);
            _.focusHandler();

        }

        if (creation) {
            _.$slider.trigger('init', [_]);
        }

        if (_.options.accessibility === true) {
            _.initADA();
        }

        if ( _.options.autoplay ) {

            _.paused = false;
            _.autoPlay();

        }

    };

    Slick.prototype.initADA = function() {
        var _ = this,
                numDotGroups = Math.ceil(_.slideCount / _.options.slidesToShow),
                tabControlIndexes = _.getNavigableIndexes().filter(function(val) {
                    return (val >= 0) && (val < _.slideCount);
                });

        _.$slides.add(_.$slideTrack.find('.slick-cloned')).attr({
            'aria-hidden': 'true',
            'tabindex': '-1'
        }).find('a, input, button, select').attr({
            'tabindex': '-1'
        });

        if (_.$dots !== null) {
            _.$slides.not(_.$slideTrack.find('.slick-cloned')).each(function(i) {
                var slideControlIndex = tabControlIndexes.indexOf(i);

                $(this).attr({
                    'role': 'tabpanel',
                    'id': 'slick-slide' + _.instanceUid + i,
                    'tabindex': -1
                });

                if (slideControlIndex !== -1) {
                   var ariaButtonControl = 'slick-slide-control' + _.instanceUid + slideControlIndex
                   if ($('#' + ariaButtonControl).length) {
                     $(this).attr({
                         'aria-describedby': ariaButtonControl
                     });
                   }
                }
            });

            _.$dots.attr('role', 'tablist').find('li').each(function(i) {
                var mappedSlideIndex = tabControlIndexes[i];

                $(this).attr({
                    'role': 'presentation'
                });

                $(this).find('button').first().attr({
                    'role': 'tab',
                    'id': 'slick-slide-control' + _.instanceUid + i,
                    'aria-controls': 'slick-slide' + _.instanceUid + mappedSlideIndex,
                    'aria-label': (i + 1) + ' of ' + numDotGroups,
                    'aria-selected': null,
                    'tabindex': '-1'
                });

            }).eq(_.currentSlide).find('button').attr({
                'aria-selected': 'true',
                'tabindex': '0'
            }).end();
        }

        for (var i=_.currentSlide, max=i+_.options.slidesToShow; i < max; i++) {
          if (_.options.focusOnChange) {
            _.$slides.eq(i).attr({'tabindex': '0'});
          } else {
            _.$slides.eq(i).removeAttr('tabindex');
          }
        }

        _.activateADA();

    };

    Slick.prototype.initArrowEvents = function() {

        var _ = this;

        if (_.options.arrows === true && _.slideCount > _.options.slidesToShow) {
            _.$prevArrow
               .off('click.slick')
               .on('click.slick', {
                    message: 'previous'
               }, _.changeSlide);
            _.$nextArrow
               .off('click.slick')
               .on('click.slick', {
                    message: 'next'
               }, _.changeSlide);

            if (_.options.accessibility === true) {
                _.$prevArrow.on('keydown.slick', _.keyHandler);
                _.$nextArrow.on('keydown.slick', _.keyHandler);
            }
        }

    };

    Slick.prototype.initDotEvents = function() {

        var _ = this;

        if (_.options.dots === true && _.slideCount > _.options.slidesToShow) {
            $('li', _.$dots).on('click.slick', {
                message: 'index'
            }, _.changeSlide);

            if (_.options.accessibility === true) {
                _.$dots.on('keydown.slick', _.keyHandler);
            }
        }

        if (_.options.dots === true && _.options.pauseOnDotsHover === true && _.slideCount > _.options.slidesToShow) {

            $('li', _.$dots)
                .on('mouseenter.slick', $.proxy(_.interrupt, _, true))
                .on('mouseleave.slick', $.proxy(_.interrupt, _, false));

        }

    };

    Slick.prototype.initSlideEvents = function() {

        var _ = this;

        if ( _.options.pauseOnHover ) {

            _.$list.on('mouseenter.slick', $.proxy(_.interrupt, _, true));
            _.$list.on('mouseleave.slick', $.proxy(_.interrupt, _, false));

        }

    };

    Slick.prototype.initializeEvents = function() {

        var _ = this;

        _.initArrowEvents();

        _.initDotEvents();
        _.initSlideEvents();

        _.$list.on('touchstart.slick mousedown.slick', {
            action: 'start'
        }, _.swipeHandler);
        _.$list.on('touchmove.slick mousemove.slick', {
            action: 'move'
        }, _.swipeHandler);
        _.$list.on('touchend.slick mouseup.slick', {
            action: 'end'
        }, _.swipeHandler);
        _.$list.on('touchcancel.slick mouseleave.slick', {
            action: 'end'
        }, _.swipeHandler);

        _.$list.on('click.slick', _.clickHandler);

        $(document).on(_.visibilityChange, $.proxy(_.visibility, _));

        if (_.options.accessibility === true) {
            _.$list.on('keydown.slick', _.keyHandler);
        }

        if (_.options.focusOnSelect === true) {
            $(_.$slideTrack).children().on('click.slick', _.selectHandler);
        }

        $(window).on('orientationchange.slick.slick-' + _.instanceUid, $.proxy(_.orientationChange, _));

        $(window).on('resize.slick.slick-' + _.instanceUid, $.proxy(_.resize, _));

        $('[draggable!=true]', _.$slideTrack).on('dragstart', _.preventDefault);

        $(window).on('load.slick.slick-' + _.instanceUid, _.setPosition);
        $(_.setPosition);

    };

    Slick.prototype.initUI = function() {

        var _ = this;

        if (_.options.arrows === true && _.slideCount > _.options.slidesToShow) {

            _.$prevArrow.show();
            _.$nextArrow.show();

        }

        if (_.options.dots === true && _.slideCount > _.options.slidesToShow) {

            _.$dots.show();

        }

    };

    Slick.prototype.keyHandler = function(event) {

        var _ = this;
         //Dont slide if the cursor is inside the form fields and arrow keys are pressed
        if(!event.target.tagName.match('TEXTAREA|INPUT|SELECT')) {
            if (event.keyCode === 37 && _.options.accessibility === true) {
                _.changeSlide({
                    data: {
                        message: _.options.rtl === true ? 'next' :  'previous'
                    }
                });
            } else if (event.keyCode === 39 && _.options.accessibility === true) {
                _.changeSlide({
                    data: {
                        message: _.options.rtl === true ? 'previous' : 'next'
                    }
                });
            }
        }

    };

    Slick.prototype.lazyLoad = function() {

        var _ = this,
            loadRange, cloneRange, rangeStart, rangeEnd;

        function loadImages(imagesScope) {

            $('img[data-lazy]', imagesScope).each(function() {

                var image = $(this),
                    imageSource = $(this).attr('data-lazy'),
                    imageSrcSet = $(this).attr('data-srcset'),
                    imageSizes  = $(this).attr('data-sizes') || _.$slider.attr('data-sizes'),
                    imageToLoad = document.createElement('img');

                imageToLoad.onload = function() {

                    image
                        .animate({ opacity: 0 }, 100, function() {

                            if (imageSrcSet) {
                                image
                                    .attr('srcset', imageSrcSet );

                                if (imageSizes) {
                                    image
                                        .attr('sizes', imageSizes );
                                }
                            }

                            image
                                .attr('src', imageSource)
                                .animate({ opacity: 1 }, 200, function() {
                                    image
                                        .removeAttr('data-lazy data-srcset data-sizes')
                                        .removeClass('slick-loading');
                                });
                            _.$slider.trigger('lazyLoaded', [_, image, imageSource]);
                        });

                };

                imageToLoad.onerror = function() {

                    image
                        .removeAttr( 'data-lazy' )
                        .removeClass( 'slick-loading' )
                        .addClass( 'slick-lazyload-error' );

                    _.$slider.trigger('lazyLoadError', [ _, image, imageSource ]);

                };

                imageToLoad.src = imageSource;

            });

        }

        if (_.options.centerMode === true) {
            if (_.options.infinite === true) {
                rangeStart = _.currentSlide + (_.options.slidesToShow / 2 + 1);
                rangeEnd = rangeStart + _.options.slidesToShow + 2;
            } else {
                rangeStart = Math.max(0, _.currentSlide - (_.options.slidesToShow / 2 + 1));
                rangeEnd = 2 + (_.options.slidesToShow / 2 + 1) + _.currentSlide;
            }
        } else {
            rangeStart = _.options.infinite ? _.options.slidesToShow + _.currentSlide : _.currentSlide;
            rangeEnd = Math.ceil(rangeStart + _.options.slidesToShow);
            if (_.options.fade === true) {
                if (rangeStart > 0) rangeStart--;
                if (rangeEnd <= _.slideCount) rangeEnd++;
            }
        }

        loadRange = _.$slider.find('.slick-slide').slice(rangeStart, rangeEnd);

        if (_.options.lazyLoad === 'anticipated') {
            var prevSlide = rangeStart - 1,
                nextSlide = rangeEnd,
                $slides = _.$slider.find('.slick-slide');

            for (var i = 0; i < _.options.slidesToScroll; i++) {
                if (prevSlide < 0) prevSlide = _.slideCount - 1;
                loadRange = loadRange.add($slides.eq(prevSlide));
                loadRange = loadRange.add($slides.eq(nextSlide));
                prevSlide--;
                nextSlide++;
            }
        }

        loadImages(loadRange);

        if (_.slideCount <= _.options.slidesToShow) {
            cloneRange = _.$slider.find('.slick-slide');
            loadImages(cloneRange);
        } else
        if (_.currentSlide >= _.slideCount - _.options.slidesToShow) {
            cloneRange = _.$slider.find('.slick-cloned').slice(0, _.options.slidesToShow);
            loadImages(cloneRange);
        } else if (_.currentSlide === 0) {
            cloneRange = _.$slider.find('.slick-cloned').slice(_.options.slidesToShow * -1);
            loadImages(cloneRange);
        }

    };

    Slick.prototype.loadSlider = function() {

        var _ = this;

        _.setPosition();

        _.$slideTrack.css({
            opacity: 1
        });

        _.$slider.removeClass('slick-loading');

        _.initUI();

        if (_.options.lazyLoad === 'progressive') {
            _.progressiveLazyLoad();
        }

    };

    Slick.prototype.next = Slick.prototype.slickNext = function() {

        var _ = this;

        _.changeSlide({
            data: {
                message: 'next'
            }
        });

    };

    Slick.prototype.orientationChange = function() {

        var _ = this;

        _.checkResponsive();
        _.setPosition();

    };

    Slick.prototype.pause = Slick.prototype.slickPause = function() {

        var _ = this;

        _.autoPlayClear();
        _.paused = true;

    };

    Slick.prototype.play = Slick.prototype.slickPlay = function() {

        var _ = this;

        _.autoPlay();
        _.options.autoplay = true;
        _.paused = false;
        _.focussed = false;
        _.interrupted = false;

    };

    Slick.prototype.postSlide = function(index) {

        var _ = this;

        if( !_.unslicked ) {

            _.$slider.trigger('afterChange', [_, index]);

            _.animating = false;

            if (_.slideCount > _.options.slidesToShow) {
                _.setPosition();
            }

            _.swipeLeft = null;

            if ( _.options.autoplay ) {
                _.autoPlay();
            }

            if (_.options.accessibility === true) {
                _.initADA();

                if (_.options.focusOnChange) {
                    var $currentSlide = $(_.$slides.get(_.currentSlide));
                    $currentSlide.attr('tabindex', 0).focus();
                }
            }

        }

    };

    Slick.prototype.prev = Slick.prototype.slickPrev = function() {

        var _ = this;

        _.changeSlide({
            data: {
                message: 'previous'
            }
        });

    };

    Slick.prototype.preventDefault = function(event) {

        event.preventDefault();

    };

    Slick.prototype.progressiveLazyLoad = function( tryCount ) {

        tryCount = tryCount || 1;

        var _ = this,
            $imgsToLoad = $( 'img[data-lazy]', _.$slider ),
            image,
            imageSource,
            imageSrcSet,
            imageSizes,
            imageToLoad;

        if ( $imgsToLoad.length ) {

            image = $imgsToLoad.first();
            imageSource = image.attr('data-lazy');
            imageSrcSet = image.attr('data-srcset');
            imageSizes  = image.attr('data-sizes') || _.$slider.attr('data-sizes');
            imageToLoad = document.createElement('img');

            imageToLoad.onload = function() {

                if (imageSrcSet) {
                    image
                        .attr('srcset', imageSrcSet );

                    if (imageSizes) {
                        image
                            .attr('sizes', imageSizes );
                    }
                }

                image
                    .attr( 'src', imageSource )
                    .removeAttr('data-lazy data-srcset data-sizes')
                    .removeClass('slick-loading');

                if ( _.options.adaptiveHeight === true ) {
                    _.setPosition();
                }

                _.$slider.trigger('lazyLoaded', [ _, image, imageSource ]);
                _.progressiveLazyLoad();

            };

            imageToLoad.onerror = function() {

                if ( tryCount < 3 ) {

                    /**
                     * try to load the image 3 times,
                     * leave a slight delay so we don't get
                     * servers blocking the request.
                     */
                    setTimeout( function() {
                        _.progressiveLazyLoad( tryCount + 1 );
                    }, 500 );

                } else {

                    image
                        .removeAttr( 'data-lazy' )
                        .removeClass( 'slick-loading' )
                        .addClass( 'slick-lazyload-error' );

                    _.$slider.trigger('lazyLoadError', [ _, image, imageSource ]);

                    _.progressiveLazyLoad();

                }

            };

            imageToLoad.src = imageSource;

        } else {

            _.$slider.trigger('allImagesLoaded', [ _ ]);

        }

    };

    Slick.prototype.refresh = function( initializing ) {

        var _ = this, currentSlide, lastVisibleIndex;

        lastVisibleIndex = _.slideCount - _.options.slidesToShow;

        // in non-infinite sliders, we don't want to go past the
        // last visible index.
        if( !_.options.infinite && ( _.currentSlide > lastVisibleIndex )) {
            _.currentSlide = lastVisibleIndex;
        }

        // if less slides than to show, go to start.
        if ( _.slideCount <= _.options.slidesToShow ) {
            _.currentSlide = 0;

        }

        currentSlide = _.currentSlide;

        _.destroy(true);

        $.extend(_, _.initials, { currentSlide: currentSlide });

        _.init();

        if( !initializing ) {

            _.changeSlide({
                data: {
                    message: 'index',
                    index: currentSlide
                }
            }, false);

        }

    };

    Slick.prototype.registerBreakpoints = function() {

        var _ = this, breakpoint, currentBreakpoint, l,
            responsiveSettings = _.options.responsive || null;

        if ( $.type(responsiveSettings) === 'array' && responsiveSettings.length ) {

            _.respondTo = _.options.respondTo || 'window';

            for ( breakpoint in responsiveSettings ) {

                l = _.breakpoints.length-1;

                if (responsiveSettings.hasOwnProperty(breakpoint)) {
                    currentBreakpoint = responsiveSettings[breakpoint].breakpoint;

                    // loop through the breakpoints and cut out any existing
                    // ones with the same breakpoint number, we don't want dupes.
                    while( l >= 0 ) {
                        if( _.breakpoints[l] && _.breakpoints[l] === currentBreakpoint ) {
                            _.breakpoints.splice(l,1);
                        }
                        l--;
                    }

                    _.breakpoints.push(currentBreakpoint);
                    _.breakpointSettings[currentBreakpoint] = responsiveSettings[breakpoint].settings;

                }

            }

            _.breakpoints.sort(function(a, b) {
                return ( _.options.mobileFirst ) ? a-b : b-a;
            });

        }

    };

    Slick.prototype.reinit = function() {

        var _ = this;

        _.$slides =
            _.$slideTrack
                .children(_.options.slide)
                .addClass('slick-slide');

        _.slideCount = _.$slides.length;

        if (_.currentSlide >= _.slideCount && _.currentSlide !== 0) {
            _.currentSlide = _.currentSlide - _.options.slidesToScroll;
        }

        if (_.slideCount <= _.options.slidesToShow) {
            _.currentSlide = 0;
        }

        _.registerBreakpoints();

        _.setProps();
        _.setupInfinite();
        _.buildArrows();
        _.updateArrows();
        _.initArrowEvents();
        _.buildDots();
        _.updateDots();
        _.initDotEvents();
        _.cleanUpSlideEvents();
        _.initSlideEvents();

        _.checkResponsive(false, true);

        if (_.options.focusOnSelect === true) {
            $(_.$slideTrack).children().on('click.slick', _.selectHandler);
        }

        _.setSlideClasses(typeof _.currentSlide === 'number' ? _.currentSlide : 0);

        _.setPosition();
        _.focusHandler();

        _.paused = !_.options.autoplay;
        _.autoPlay();

        _.$slider.trigger('reInit', [_]);

    };

    Slick.prototype.resize = function() {

        var _ = this;

        if ($(window).width() !== _.windowWidth) {
            clearTimeout(_.windowDelay);
            _.windowDelay = window.setTimeout(function() {
                _.windowWidth = $(window).width();
                _.checkResponsive();
                if( !_.unslicked ) { _.setPosition(); }
            }, 50);
        }
    };

    Slick.prototype.removeSlide = Slick.prototype.slickRemove = function(index, removeBefore, removeAll) {

        var _ = this;

        if (typeof(index) === 'boolean') {
            removeBefore = index;
            index = removeBefore === true ? 0 : _.slideCount - 1;
        } else {
            index = removeBefore === true ? --index : index;
        }

        if (_.slideCount < 1 || index < 0 || index > _.slideCount - 1) {
            return false;
        }

        _.unload();

        if (removeAll === true) {
            _.$slideTrack.children().remove();
        } else {
            _.$slideTrack.children(this.options.slide).eq(index).remove();
        }

        _.$slides = _.$slideTrack.children(this.options.slide);

        _.$slideTrack.children(this.options.slide).detach();

        _.$slideTrack.append(_.$slides);

        _.$slidesCache = _.$slides;

        _.reinit();

    };

    Slick.prototype.setCSS = function(position) {

        var _ = this,
            positionProps = {},
            x, y;

        if (_.options.rtl === true) {
            position = -position;
        }
        x = _.positionProp == 'left' ? Math.ceil(position) + 'px' : '0px';
        y = _.positionProp == 'top' ? Math.ceil(position) + 'px' : '0px';

        positionProps[_.positionProp] = position;

        if (_.transformsEnabled === false) {
            _.$slideTrack.css(positionProps);
        } else {
            positionProps = {};
            if (_.cssTransitions === false) {
                positionProps[_.animType] = 'translate(' + x + ', ' + y + ')';
                _.$slideTrack.css(positionProps);
            } else {
                positionProps[_.animType] = 'translate3d(' + x + ', ' + y + ', 0px)';
                _.$slideTrack.css(positionProps);
            }
        }

    };

    Slick.prototype.setDimensions = function() {

        var _ = this;

        if (_.options.vertical === false) {
            if (_.options.centerMode === true) {
                _.$list.css({
                    padding: ('0px ' + _.options.centerPadding)
                });
            }
        } else {
            _.$list.height(_.$slides.first().outerHeight(true) * _.options.slidesToShow);
            if (_.options.centerMode === true) {
                _.$list.css({
                    padding: (_.options.centerPadding + ' 0px')
                });
            }
        }

        _.listWidth = _.$list.width();
        _.listHeight = _.$list.height();


        if (_.options.vertical === false && _.options.variableWidth === false) {
            _.slideWidth = Math.ceil(_.listWidth / _.options.slidesToShow);
            _.$slideTrack.width(Math.ceil((_.slideWidth * _.$slideTrack.children('.slick-slide').length)));

        } else if (_.options.variableWidth === true) {
            _.$slideTrack.width(5000 * _.slideCount);
        } else {
            _.slideWidth = Math.ceil(_.listWidth);
            _.$slideTrack.height(Math.ceil((_.$slides.first().outerHeight(true) * _.$slideTrack.children('.slick-slide').length)));
        }

        var offset = _.$slides.first().outerWidth(true) - _.$slides.first().width();
        if (_.options.variableWidth === false) _.$slideTrack.children('.slick-slide').width(_.slideWidth - offset);

    };

    Slick.prototype.setFade = function() {

        var _ = this,
            targetLeft;

        _.$slides.each(function(index, element) {
            targetLeft = (_.slideWidth * index) * -1;
            if (_.options.rtl === true) {
                $(element).css({
                    position: 'relative',
                    right: targetLeft,
                    top: 0,
                    zIndex: _.options.zIndex - 2,
                    opacity: 0
                });
            } else {
                $(element).css({
                    position: 'relative',
                    left: targetLeft,
                    top: 0,
                    zIndex: _.options.zIndex - 2,
                    opacity: 0
                });
            }
        });

        _.$slides.eq(_.currentSlide).css({
            zIndex: _.options.zIndex - 1,
            opacity: 1
        });

    };

    Slick.prototype.setHeight = function() {

        var _ = this;

        if (_.options.slidesToShow === 1 && _.options.adaptiveHeight === true && _.options.vertical === false) {
            var targetHeight = _.$slides.eq(_.currentSlide).outerHeight(true);
            _.$list.css('height', targetHeight);
        }

    };

    Slick.prototype.setOption =
    Slick.prototype.slickSetOption = function() {

        /**
         * accepts arguments in format of:
         *
         *  - for changing a single option's value:
         *     .slick("setOption", option, value, refresh )
         *
         *  - for changing a set of responsive options:
         *     .slick("setOption", 'responsive', [{}, ...], refresh )
         *
         *  - for updating multiple values at once (not responsive)
         *     .slick("setOption", { 'option': value, ... }, refresh )
         */

        var _ = this, l, item, option, value, refresh = false, type;

        if( $.type( arguments[0] ) === 'object' ) {

            option =  arguments[0];
            refresh = arguments[1];
            type = 'multiple';

        } else if ( $.type( arguments[0] ) === 'string' ) {

            option =  arguments[0];
            value = arguments[1];
            refresh = arguments[2];

            if ( arguments[0] === 'responsive' && $.type( arguments[1] ) === 'array' ) {

                type = 'responsive';

            } else if ( typeof arguments[1] !== 'undefined' ) {

                type = 'single';

            }

        }

        if ( type === 'single' ) {

            _.options[option] = value;


        } else if ( type === 'multiple' ) {

            $.each( option , function( opt, val ) {

                _.options[opt] = val;

            });


        } else if ( type === 'responsive' ) {

            for ( item in value ) {

                if( $.type( _.options.responsive ) !== 'array' ) {

                    _.options.responsive = [ value[item] ];

                } else {

                    l = _.options.responsive.length-1;

                    // loop through the responsive object and splice out duplicates.
                    while( l >= 0 ) {

                        if( _.options.responsive[l].breakpoint === value[item].breakpoint ) {

                            _.options.responsive.splice(l,1);

                        }

                        l--;

                    }

                    _.options.responsive.push( value[item] );

                }

            }

        }

        if ( refresh ) {

            _.unload();
            _.reinit();

        }

    };

    Slick.prototype.setPosition = function() {

        var _ = this;

        _.setDimensions();

        _.setHeight();

        if (_.options.fade === false) {
            _.setCSS(_.getLeft(_.currentSlide));
        } else {
            _.setFade();
        }

        _.$slider.trigger('setPosition', [_]);

    };

    Slick.prototype.setProps = function() {

        var _ = this,
            bodyStyle = document.body.style;

        _.positionProp = _.options.vertical === true ? 'top' : 'left';

        if (_.positionProp === 'top') {
            _.$slider.addClass('slick-vertical');
        } else {
            _.$slider.removeClass('slick-vertical');
        }

        if (bodyStyle.WebkitTransition !== undefined ||
            bodyStyle.MozTransition !== undefined ||
            bodyStyle.msTransition !== undefined) {
            if (_.options.useCSS === true) {
                _.cssTransitions = true;
            }
        }

        if ( _.options.fade ) {
            if ( typeof _.options.zIndex === 'number' ) {
                if( _.options.zIndex < 3 ) {
                    _.options.zIndex = 3;
                }
            } else {
                _.options.zIndex = _.defaults.zIndex;
            }
        }

        if (bodyStyle.OTransform !== undefined) {
            _.animType = 'OTransform';
            _.transformType = '-o-transform';
            _.transitionType = 'OTransition';
            if (bodyStyle.perspectiveProperty === undefined && bodyStyle.webkitPerspective === undefined) _.animType = false;
        }
        if (bodyStyle.MozTransform !== undefined) {
            _.animType = 'MozTransform';
            _.transformType = '-moz-transform';
            _.transitionType = 'MozTransition';
            if (bodyStyle.perspectiveProperty === undefined && bodyStyle.MozPerspective === undefined) _.animType = false;
        }
        if (bodyStyle.webkitTransform !== undefined) {
            _.animType = 'webkitTransform';
            _.transformType = '-webkit-transform';
            _.transitionType = 'webkitTransition';
            if (bodyStyle.perspectiveProperty === undefined && bodyStyle.webkitPerspective === undefined) _.animType = false;
        }
        if (bodyStyle.msTransform !== undefined) {
            _.animType = 'msTransform';
            _.transformType = '-ms-transform';
            _.transitionType = 'msTransition';
            if (bodyStyle.msTransform === undefined) _.animType = false;
        }
        if (bodyStyle.transform !== undefined && _.animType !== false) {
            _.animType = 'transform';
            _.transformType = 'transform';
            _.transitionType = 'transition';
        }
        _.transformsEnabled = _.options.useTransform && (_.animType !== null && _.animType !== false);
    };


    Slick.prototype.setSlideClasses = function(index) {

        var _ = this,
            centerOffset, allSlides, indexOffset, remainder;

        allSlides = _.$slider
            .find('.slick-slide')
            .removeClass('slick-active slick-center slick-current')
            .attr('aria-hidden', 'true');

        _.$slides
            .eq(index)
            .addClass('slick-current');

        if (_.options.centerMode === true) {

            var evenCoef = _.options.slidesToShow % 2 === 0 ? 1 : 0;

            centerOffset = Math.floor(_.options.slidesToShow / 2);

            if (_.options.infinite === true) {

                if (index >= centerOffset && index <= (_.slideCount - 1) - centerOffset) {
                    _.$slides
                        .slice(index - centerOffset + evenCoef, index + centerOffset + 1)
                        .addClass('slick-active')
                        .attr('aria-hidden', 'false');

                } else {

                    indexOffset = _.options.slidesToShow + index;
                    allSlides
                        .slice(indexOffset - centerOffset + 1 + evenCoef, indexOffset + centerOffset + 2)
                        .addClass('slick-active')
                        .attr('aria-hidden', 'false');

                }

                if (index === 0) {

                    allSlides
                        .eq(allSlides.length - 1 - _.options.slidesToShow)
                        .addClass('slick-center');

                } else if (index === _.slideCount - 1) {

                    allSlides
                        .eq(_.options.slidesToShow)
                        .addClass('slick-center');

                }

            }

            _.$slides
                .eq(index)
                .addClass('slick-center');

        } else {

            if (index >= 0 && index <= (_.slideCount - _.options.slidesToShow)) {

                _.$slides
                    .slice(index, index + _.options.slidesToShow)
                    .addClass('slick-active')
                    .attr('aria-hidden', 'false');

            } else if (allSlides.length <= _.options.slidesToShow) {

                allSlides
                    .addClass('slick-active')
                    .attr('aria-hidden', 'false');

            } else {

                remainder = _.slideCount % _.options.slidesToShow;
                indexOffset = _.options.infinite === true ? _.options.slidesToShow + index : index;

                if (_.options.slidesToShow == _.options.slidesToScroll && (_.slideCount - index) < _.options.slidesToShow) {

                    allSlides
                        .slice(indexOffset - (_.options.slidesToShow - remainder), indexOffset + remainder)
                        .addClass('slick-active')
                        .attr('aria-hidden', 'false');

                } else {

                    allSlides
                        .slice(indexOffset, indexOffset + _.options.slidesToShow)
                        .addClass('slick-active')
                        .attr('aria-hidden', 'false');

                }

            }

        }

        if (_.options.lazyLoad === 'ondemand' || _.options.lazyLoad === 'anticipated') {
            _.lazyLoad();
        }
    };

    Slick.prototype.setupInfinite = function() {

        var _ = this,
            i, slideIndex, infiniteCount;

        if (_.options.fade === true) {
            _.options.centerMode = false;
        }

        if (_.options.infinite === true && _.options.fade === false) {

            slideIndex = null;

            if (_.slideCount > _.options.slidesToShow) {

                if (_.options.centerMode === true) {
                    infiniteCount = _.options.slidesToShow + 1;
                } else {
                    infiniteCount = _.options.slidesToShow;
                }

                for (i = _.slideCount; i > (_.slideCount -
                        infiniteCount); i -= 1) {
                    slideIndex = i - 1;
                    $(_.$slides[slideIndex]).clone(true).attr('id', '')
                        .attr('data-slick-index', slideIndex - _.slideCount)
                        .prependTo(_.$slideTrack).addClass('slick-cloned');
                }
                for (i = 0; i < infiniteCount  + _.slideCount; i += 1) {
                    slideIndex = i;
                    $(_.$slides[slideIndex]).clone(true).attr('id', '')
                        .attr('data-slick-index', slideIndex + _.slideCount)
                        .appendTo(_.$slideTrack).addClass('slick-cloned');
                }
                _.$slideTrack.find('.slick-cloned').find('[id]').each(function() {
                    $(this).attr('id', '');
                });

            }

        }

    };

    Slick.prototype.interrupt = function( toggle ) {

        var _ = this;

        if( !toggle ) {
            _.autoPlay();
        }
        _.interrupted = toggle;

    };

    Slick.prototype.selectHandler = function(event) {

        var _ = this;

        var targetElement =
            $(event.target).is('.slick-slide') ?
                $(event.target) :
                $(event.target).parents('.slick-slide');

        var index = parseInt(targetElement.attr('data-slick-index'));

        if (!index) index = 0;

        if (_.slideCount <= _.options.slidesToShow) {

            _.slideHandler(index, false, true);
            return;

        }

        _.slideHandler(index);

    };

    Slick.prototype.slideHandler = function(index, sync, dontAnimate) {

        var targetSlide, animSlide, oldSlide, slideLeft, targetLeft = null,
            _ = this, navTarget;

        sync = sync || false;

        if (_.animating === true && _.options.waitForAnimate === true) {
            return;
        }

        if (_.options.fade === true && _.currentSlide === index) {
            return;
        }

        if (sync === false) {
            _.asNavFor(index);
        }

        targetSlide = index;
        targetLeft = _.getLeft(targetSlide);
        slideLeft = _.getLeft(_.currentSlide);

        _.currentLeft = _.swipeLeft === null ? slideLeft : _.swipeLeft;

        if (_.options.infinite === false && _.options.centerMode === false && (index < 0 || index > _.getDotCount() * _.options.slidesToScroll)) {
            if (_.options.fade === false) {
                targetSlide = _.currentSlide;
                if (dontAnimate !== true && _.slideCount > _.options.slidesToShow) {
                    _.animateSlide(slideLeft, function() {
                        _.postSlide(targetSlide);
                    });
                } else {
                    _.postSlide(targetSlide);
                }
            }
            return;
        } else if (_.options.infinite === false && _.options.centerMode === true && (index < 0 || index > (_.slideCount - _.options.slidesToScroll))) {
            if (_.options.fade === false) {
                targetSlide = _.currentSlide;
                if (dontAnimate !== true && _.slideCount > _.options.slidesToShow) {
                    _.animateSlide(slideLeft, function() {
                        _.postSlide(targetSlide);
                    });
                } else {
                    _.postSlide(targetSlide);
                }
            }
            return;
        }

        if ( _.options.autoplay ) {
            clearInterval(_.autoPlayTimer);
        }

        if (targetSlide < 0) {
            if (_.slideCount % _.options.slidesToScroll !== 0) {
                animSlide = _.slideCount - (_.slideCount % _.options.slidesToScroll);
            } else {
                animSlide = _.slideCount + targetSlide;
            }
        } else if (targetSlide >= _.slideCount) {
            if (_.slideCount % _.options.slidesToScroll !== 0) {
                animSlide = 0;
            } else {
                animSlide = targetSlide - _.slideCount;
            }
        } else {
            animSlide = targetSlide;
        }

        _.animating = true;

        _.$slider.trigger('beforeChange', [_, _.currentSlide, animSlide]);

        oldSlide = _.currentSlide;
        _.currentSlide = animSlide;

        _.setSlideClasses(_.currentSlide);

        if ( _.options.asNavFor ) {

            navTarget = _.getNavTarget();
            navTarget = navTarget.slick('getSlick');

            if ( navTarget.slideCount <= navTarget.options.slidesToShow ) {
                navTarget.setSlideClasses(_.currentSlide);
            }

        }

        _.updateDots();
        _.updateArrows();

        if (_.options.fade === true) {
            if (dontAnimate !== true) {

                _.fadeSlideOut(oldSlide);

                _.fadeSlide(animSlide, function() {
                    _.postSlide(animSlide);
                });

            } else {
                _.postSlide(animSlide);
            }
            _.animateHeight();
            return;
        }

        if (dontAnimate !== true && _.slideCount > _.options.slidesToShow) {
            _.animateSlide(targetLeft, function() {
                _.postSlide(animSlide);
            });
        } else {
            _.postSlide(animSlide);
        }

    };

    Slick.prototype.startLoad = function() {

        var _ = this;

        if (_.options.arrows === true && _.slideCount > _.options.slidesToShow) {

            _.$prevArrow.hide();
            _.$nextArrow.hide();

        }

        if (_.options.dots === true && _.slideCount > _.options.slidesToShow) {

            _.$dots.hide();

        }

        _.$slider.addClass('slick-loading');

    };

    Slick.prototype.swipeDirection = function() {

        var xDist, yDist, r, swipeAngle, _ = this;

        xDist = _.touchObject.startX - _.touchObject.curX;
        yDist = _.touchObject.startY - _.touchObject.curY;
        r = Math.atan2(yDist, xDist);

        swipeAngle = Math.round(r * 180 / Math.PI);
        if (swipeAngle < 0) {
            swipeAngle = 360 - Math.abs(swipeAngle);
        }

        if ((swipeAngle <= 45) && (swipeAngle >= 0)) {
            return (_.options.rtl === false ? 'left' : 'right');
        }
        if ((swipeAngle <= 360) && (swipeAngle >= 315)) {
            return (_.options.rtl === false ? 'left' : 'right');
        }
        if ((swipeAngle >= 135) && (swipeAngle <= 225)) {
            return (_.options.rtl === false ? 'right' : 'left');
        }
        if (_.options.verticalSwiping === true) {
            if ((swipeAngle >= 35) && (swipeAngle <= 135)) {
                return 'down';
            } else {
                return 'up';
            }
        }

        return 'vertical';

    };

    Slick.prototype.swipeEnd = function(event) {

        var _ = this,
            slideCount,
            direction;

        _.dragging = false;
        _.swiping = false;

        if (_.scrolling) {
            _.scrolling = false;
            return false;
        }

        _.interrupted = false;
        _.shouldClick = ( _.touchObject.swipeLength > 10 ) ? false : true;

        if ( _.touchObject.curX === undefined ) {
            return false;
        }

        if ( _.touchObject.edgeHit === true ) {
            _.$slider.trigger('edge', [_, _.swipeDirection() ]);
        }

        if ( _.touchObject.swipeLength >= _.touchObject.minSwipe ) {

            direction = _.swipeDirection();

            switch ( direction ) {

                case 'left':
                case 'down':

                    slideCount =
                        _.options.swipeToSlide ?
                            _.checkNavigable( _.currentSlide + _.getSlideCount() ) :
                            _.currentSlide + _.getSlideCount();

                    _.currentDirection = 0;

                    break;

                case 'right':
                case 'up':

                    slideCount =
                        _.options.swipeToSlide ?
                            _.checkNavigable( _.currentSlide - _.getSlideCount() ) :
                            _.currentSlide - _.getSlideCount();

                    _.currentDirection = 1;

                    break;

                default:


            }

            if( direction != 'vertical' ) {

                _.slideHandler( slideCount );
                _.touchObject = {};
                _.$slider.trigger('swipe', [_, direction ]);

            }

        } else {

            if ( _.touchObject.startX !== _.touchObject.curX ) {

                _.slideHandler( _.currentSlide );
                _.touchObject = {};

            }

        }

    };

    Slick.prototype.swipeHandler = function(event) {

        var _ = this;

        if ((_.options.swipe === false) || ('ontouchend' in document && _.options.swipe === false)) {
            return;
        } else if (_.options.draggable === false && event.type.indexOf('mouse') !== -1) {
            return;
        }

        _.touchObject.fingerCount = event.originalEvent && event.originalEvent.touches !== undefined ?
            event.originalEvent.touches.length : 1;

        _.touchObject.minSwipe = _.listWidth / _.options
            .touchThreshold;

        if (_.options.verticalSwiping === true) {
            _.touchObject.minSwipe = _.listHeight / _.options
                .touchThreshold;
        }

        switch (event.data.action) {

            case 'start':
                _.swipeStart(event);
                break;

            case 'move':
                _.swipeMove(event);
                break;

            case 'end':
                _.swipeEnd(event);
                break;

        }

    };

    Slick.prototype.swipeMove = function(event) {

        var _ = this,
            edgeWasHit = false,
            curLeft, swipeDirection, swipeLength, positionOffset, touches, verticalSwipeLength;

        touches = event.originalEvent !== undefined ? event.originalEvent.touches : null;

        if (!_.dragging || _.scrolling || touches && touches.length !== 1) {
            return false;
        }

        curLeft = _.getLeft(_.currentSlide);

        _.touchObject.curX = touches !== undefined ? touches[0].pageX : event.clientX;
        _.touchObject.curY = touches !== undefined ? touches[0].pageY : event.clientY;

        _.touchObject.swipeLength = Math.round(Math.sqrt(
            Math.pow(_.touchObject.curX - _.touchObject.startX, 2)));

        verticalSwipeLength = Math.round(Math.sqrt(
            Math.pow(_.touchObject.curY - _.touchObject.startY, 2)));

        if (!_.options.verticalSwiping && !_.swiping && verticalSwipeLength > 4) {
            _.scrolling = true;
            return false;
        }

        if (_.options.verticalSwiping === true) {
            _.touchObject.swipeLength = verticalSwipeLength;
        }

        swipeDirection = _.swipeDirection();

        if (event.originalEvent !== undefined && _.touchObject.swipeLength > 4) {
            _.swiping = true;
            event.preventDefault();
        }

        positionOffset = (_.options.rtl === false ? 1 : -1) * (_.touchObject.curX > _.touchObject.startX ? 1 : -1);
        if (_.options.verticalSwiping === true) {
            positionOffset = _.touchObject.curY > _.touchObject.startY ? 1 : -1;
        }


        swipeLength = _.touchObject.swipeLength;

        _.touchObject.edgeHit = false;

        if (_.options.infinite === false) {
            if ((_.currentSlide === 0 && swipeDirection === 'right') || (_.currentSlide >= _.getDotCount() && swipeDirection === 'left')) {
                swipeLength = _.touchObject.swipeLength * _.options.edgeFriction;
                _.touchObject.edgeHit = true;
            }
        }

        if (_.options.vertical === false) {
            _.swipeLeft = curLeft + swipeLength * positionOffset;
        } else {
            _.swipeLeft = curLeft + (swipeLength * (_.$list.height() / _.listWidth)) * positionOffset;
        }
        if (_.options.verticalSwiping === true) {
            _.swipeLeft = curLeft + swipeLength * positionOffset;
        }

        if (_.options.fade === true || _.options.touchMove === false) {
            return false;
        }

        if (_.animating === true) {
            _.swipeLeft = null;
            return false;
        }

        _.setCSS(_.swipeLeft);

    };

    Slick.prototype.swipeStart = function(event) {

        var _ = this,
            touches;

        _.interrupted = true;

        if (_.touchObject.fingerCount !== 1 || _.slideCount <= _.options.slidesToShow) {
            _.touchObject = {};
            return false;
        }

        if (event.originalEvent !== undefined && event.originalEvent.touches !== undefined) {
            touches = event.originalEvent.touches[0];
        }

        _.touchObject.startX = _.touchObject.curX = touches !== undefined ? touches.pageX : event.clientX;
        _.touchObject.startY = _.touchObject.curY = touches !== undefined ? touches.pageY : event.clientY;

        _.dragging = true;

    };

    Slick.prototype.unfilterSlides = Slick.prototype.slickUnfilter = function() {

        var _ = this;

        if (_.$slidesCache !== null) {

            _.unload();

            _.$slideTrack.children(this.options.slide).detach();

            _.$slidesCache.appendTo(_.$slideTrack);

            _.reinit();

        }

    };

    Slick.prototype.unload = function() {

        var _ = this;

        $('.slick-cloned', _.$slider).remove();

        if (_.$dots) {
            _.$dots.remove();
        }

        if (_.$prevArrow && _.htmlExpr.test(_.options.prevArrow)) {
            _.$prevArrow.remove();
        }

        if (_.$nextArrow && _.htmlExpr.test(_.options.nextArrow)) {
            _.$nextArrow.remove();
        }

        _.$slides
            .removeClass('slick-slide slick-active slick-visible slick-current')
            .attr('aria-hidden', 'true')
            .css('width', '');

    };

    Slick.prototype.unslick = function(fromBreakpoint) {

        var _ = this;
        _.$slider.trigger('unslick', [_, fromBreakpoint]);
        _.destroy();

    };

    Slick.prototype.updateArrows = function() {

        var _ = this,
            centerOffset;

        centerOffset = Math.floor(_.options.slidesToShow / 2);

        if ( _.options.arrows === true &&
            _.slideCount > _.options.slidesToShow &&
            !_.options.infinite ) {

            _.$prevArrow.removeClass('slick-disabled').attr('aria-disabled', 'false');
            _.$nextArrow.removeClass('slick-disabled').attr('aria-disabled', 'false');

            if (_.currentSlide === 0) {

                _.$prevArrow.addClass('slick-disabled').attr('aria-disabled', 'true');
                _.$nextArrow.removeClass('slick-disabled').attr('aria-disabled', 'false');

            } else if (_.currentSlide >= _.slideCount - _.options.slidesToShow && _.options.centerMode === false) {

                _.$nextArrow.addClass('slick-disabled').attr('aria-disabled', 'true');
                _.$prevArrow.removeClass('slick-disabled').attr('aria-disabled', 'false');

            } else if (_.currentSlide >= _.slideCount - 1 && _.options.centerMode === true) {

                _.$nextArrow.addClass('slick-disabled').attr('aria-disabled', 'true');
                _.$prevArrow.removeClass('slick-disabled').attr('aria-disabled', 'false');

            }

        }

    };

    Slick.prototype.updateDots = function() {

        var _ = this;

        if (_.$dots !== null) {

            _.$dots
                .find('li')
                    .removeClass('slick-active')
                    .end();

            _.$dots
                .find('li')
                .eq(Math.floor(_.currentSlide / _.options.slidesToScroll))
                .addClass('slick-active');

        }

    };

    Slick.prototype.visibility = function() {

        var _ = this;

        if ( _.options.autoplay ) {

            if ( document[_.hidden] ) {

                _.interrupted = true;

            } else {

                _.interrupted = false;

            }

        }

    };

    $.fn.slick = function() {
        var _ = this,
            opt = arguments[0],
            args = Array.prototype.slice.call(arguments, 1),
            l = _.length,
            i,
            ret;
        for (i = 0; i < l; i++) {
            if (typeof opt == 'object' || typeof opt == 'undefined')
                _[i].slick = new Slick(_[i], opt);
            else
                ret = _[i].slick[opt].apply(_[i].slick, args);
            if (typeof ret != 'undefined') return ret;
        }
        return _;
    };

}));

/**
 *  The Virtual Keyboard Detector
 */

var virtualKeyboardDetector = ( function( window, undefined ) {
  var previousViewportWidth;
  var previousViewportHeight;
  var viewportWidthWithoutVirtualKeyboard;
  var viewportHeightWithoutVirtualKeyboard;

  var recentlyFocusedTimeoutDuration = 3000;
  
  var currentViewportWidth = previousViewportWidth = viewportWidthWithoutVirtualKeyboard = window.innerWidth;
  var currentViewportHeight = previousViewportHeight = viewportHeightWithoutVirtualKeyboard = window.innerHeight;

  var virtualKeyboardVisible = false;
  var recentlyFocused = false;
  var recentlyFocusedTimeout = null;
  var validFocusableElements = [ 'INPUT', 'TEXTAREA' ];

  var subscriptions = {};


  /**
   * Public functions
   */

  function init ( options ) {
    if ( typeof options !== 'undefined' ) {
      if ( typeof options.recentlyFocusedTimeoutDuration !== 'undefined' ) recentlyFocusedTimeoutDuration = options.recentlyFocusedTimeoutDuration;
    }

    resetViewportSizes();
    initFocusListener();
    initResizeListener();
  }

  function isVirtualKeyboardVisible () {
    return virtualKeyboardVisible;
  }

  function getVirtualKeyboardSize () {
    if ( !virtualKeyboardVisible ) return false;
    
    return {
      width: currentViewportWidth,
      height: viewportHeightWithoutVirtualKeyboard - currentViewportHeight
    };
  }

  // Subscribe
  function on ( eventName, fn ) {
    if ( typeof subscriptions[eventName] === 'undefined' ) subscriptions[eventName] = [];

    subscriptions[eventName].push(fn);
  }

  // Unsubscribe
  function off ( eventName, fn ) {
    if (typeof subscriptions[eventName] === 'undefined' ) return;

    if (typeof fn === 'undefined') {
      subscriptions[eventName] = [];
    } else {
      var i = subscriptions[eventName].length;
      while ( i-- ) {
        if ( subscriptions[eventName][i] == fn ) subscriptions[eventName].splice(i, 1);
      }
    }
  }

  // Publish
  function trigger ( eventName, args ) {
    for ( i in subscriptions[eventName] ) {
      if ( typeof subscriptions[eventName][i] === 'function' ) subscriptions[eventName][i]( args );
    }   
  }


  /**
   * Private functions
   */

  // Reset all sizes. We presume the virtual keyboard is not visible at this stage.
  // We call this function on initialisation, so make sure you initialise the virtualKeyBoardListener at a moment when the virtual keyboard is likely to be invisible.
  function resetViewportSizes () {
    currentViewportWidth = previousViewportWidth = viewportWidthWithoutVirtualKeyboard = window.innerWidth;
    currentViewportHeight = previousViewportHeight = viewportHeightWithoutVirtualKeyboard = window.innerHeight;
  }

  // Initialise the listener that checks for focus events in the whole document. This way we can also handle dynamically added focusable elements.
  function initFocusListener () {
    document.addEventListener( 'focus', documentFocusHandler, true );
  }

  // Handle the document focus event. We check if the target was a valid focusable element.
  function documentFocusHandler (e) {
    if (typeof e.target !== 'undefined' && typeof e.target.nodeName !== 'undefined') {
      if (validFocusableElements.indexOf(e.target.nodeName) != -1) elementFocusHandler(e);
    }
  }

  // Handle the case when a valid focusable element is focused. We flag that a valid element was recently focused. This flag expires after recentlyFocusedTimeoutDuration.
  function elementFocusHandler (e) {
    if ( recentlyFocusedTimeout != null ) {
      window.clearTimeout( recentlyFocusedTimeout );
      recentlyFocusedTimeout = null;
    }

    recentlyFocused = true;

    recentlyFocusedTimeout = window.setTimeout( expireRecentlyFocused, recentlyFocusedTimeoutDuration );
  }

  function expireRecentlyFocused () {
    recentlyFocused = false;
  }

  function initResizeListener () {
    window.addEventListener( 'resize', resizeHandler );
  }

  function resizeHandler () {
    currentViewportWidth = window.innerWidth;
    currentViewportHeight = window.innerHeight;

    // If the virtual keyboard is tought to be visible, but the viewport height returns to the value before keyboard was visible, we presume the keyboard was hidden.
    if ( virtualKeyboardVisible && currentViewportWidth == previousViewportWidth && currentViewportHeight >= viewportHeightWithoutVirtualKeyboard ) {
      virtualKeyboardHiddenHandler();
    }

    // If the width of the viewport is changed, it's hard to tell wether virtual keyboard is still visible, so we make sure it's not.
    if ( currentViewportWidth != previousViewportWidth ) {
      if ( 'activeElement' in document )
        document.activeElement.blur();
      virtualKeyboardHiddenHandler();
    }

    // If recently focused and viewport height is smaller then previous height, we presume that the virtual keyboard has appeared.
    if ( !virtualKeyboardVisible && recentlyFocused && currentViewportWidth == previousViewportWidth && currentViewportHeight < previousViewportHeight ) {
      virtualKeyboardVisibleHandler();
    }   

    // If the keyboard is presumed not visible, we save the current measurements as values before keyboard was shown.
    if ( virtualKeyboardVisible == false ) {
      viewportWidthWithoutVirtualKeyboard = currentViewportWidth;
      viewportHeightWithoutVirtualKeyboard = currentViewportHeight;
    }

    previousViewportWidth = currentViewportWidth;
    previousViewportHeight = currentViewportHeight;
  }

  function virtualKeyboardVisibleHandler () {
    virtualKeyboardVisible = true;

    var eventData = {
      virtualKeyboardVisible: virtualKeyboardVisible,
      sizes: getSizesData()
    };

    trigger( 'virtualKeyboardVisible', eventData );
  }

  function virtualKeyboardHiddenHandler () {
    virtualKeyboardVisible = false;

    var eventData = {
      virtualKeyboardVisible: virtualKeyboardVisible,
      sizes: getSizesData()
    };

    trigger( 'virtualKeyboardHidden', eventData );
  }

  function getSizesData () {
    return {
      viewportWithoutVirtualKeyboard: {
        width: viewportWidthWithoutVirtualKeyboard,
        height: viewportHeightWithoutVirtualKeyboard
      },
      currentViewport: {
        width: currentViewportWidth,
        height: currentViewportHeight
      },
      virtualKeyboard: {
        width: currentViewportWidth,
        height: viewportHeightWithoutVirtualKeyboard - currentViewportHeight
      }
    };
  }

  // Make public functions available
  return {
    init: init,
    isVirtualKeyboardVisible: isVirtualKeyboardVisible,
    getVirtualKeyboardSize: getVirtualKeyboardSize,
    on: on,
    addEventListener: on,
    subscribe: on,
    off: off,
    removeEventListener: off,
    unsubscribe: off,
    trigger: trigger,
    publish: trigger,
    dispatchEvent: trigger
  };

} )( window );

/*	--------------------------------------------------
    buttonToggleBasic: TEMP: PARA LA CABECERA PUBLICA
-------------------------------------------------- */
$('.js-toggle-basic').click(function (event) {
  //event.preventDefault();
  var idToggle = $(this).attr('data-id-toggle');
  $(this).toggleClass("active");
  //Muestra-oculta
  if ($(idToggle).is(":visible")) {
    $(idToggle).hide();
  } else {
    $(idToggle).show();
  }

});

// Si se hace click fuera del contenedor se oculta el contenedor
$(document).mouseup(function (e) {
  var container = $($('.js-toggle-basic').attr('data-id-toggle'));
  if (!$('.js-toggle-basic').is(e.target) && !container.is(e.target) && container.has(e.target).length === 0 && $('.js-toggle-basic').length) {
    container.hide();
    $('.js-toggle-basic').removeClass('active');
  }
});

/*	--------------------------------------------------
  TEMP:Añade una clase al body que indica que estás logado
-------------------------------------------------- */
$('.header-mob-v2 .btn-ico-user-nav').click(function () {
  $('body').toggleClass('logged');
});

/*	--------------------------------------------------
  TEMP: Comprobamos que el submenu de la clase rewards tiene 'style:none;'
-------------------------------------------------- */
if (!$('.js-rewards-submenu').is(':visible')) {
  $('header.space').addClass('not-logged');
}

//lazyload images
$(function() {
  $('.lazy').Lazy();
});


/*	--------------------------------------------------
  PARA ARREGLAR PROBLEMAS CON IE11
-------------------------------------------------- */
if (!Object.entries){
  Object.entries = function (obj) {
    var ownProps = Object.keys(obj),
      i = ownProps.length,
      resArray = new Array(i); // preallocate the Array
    while (i--)
      resArray[i] = [ownProps[i], obj[ownProps[i]]];

    return resArray;
  };
}

// https://tc39.github.io/ecma262/#sec-array.prototype.find
if (!Array.prototype.find) {
  Object.defineProperty(Array.prototype, 'find', {
    value: function(predicate) {
     // 1. Let O be ? ToObject(this value).
      if (this == null) {
        throw new TypeError('"this" is null or not defined');
      }

      var o = Object(this);

      // 2. Let len be ? ToLength(? Get(O, "length")).
      var len = o.length >>> 0;

      // 3. If IsCallable(predicate) is false, throw a TypeError exception.
      if (typeof predicate !== 'function') {
        throw new TypeError('predicate must be a function');
      }

      // 4. If thisArg was supplied, let T be thisArg; else let T be undefined.
      var thisArg = arguments[1];

      // 5. Let k be 0.
      var k = 0;

      // 6. Repeat, while k < len
      while (k < len) {
        // a. Let Pk be ! ToString(k).
        // b. Let kValue be ? Get(O, Pk).
        // c. Let testResult be ToBoolean(? Call(predicate, T, « kValue, k, O »)).
        // d. If testResult is true, return kValue.
        var kValue = o[k];
        if (predicate.call(thisArg, kValue, k, o)) {
          return kValue;
        }
        // e. Increase k by 1.
        k++;
      }

      // 7. Return undefined.
      return undefined;
    },
    configurable: true,
    writable: true
  });
}
/**
 * EY UTILITIES CRITICAL
 * @type {Module pattern}
 * @author susanahernandezd
 * @include:
 */

//Last search from param url and webservice
// Mantiene los datos de la ultima busqueda
var lastSearch = {
    fini: null,
    fout: null,
    occupancy: [],
    numRooms: null,
    numNights: null,
    numTotalAdults: null,
    numTotalChildren: null,
    numTotalBabies: null,

    // Añadidos del checkdates
    b2b: null,
    busqAutocompleteDestino: null,
    busqId: null,
    comingFromBP: null,
    continueTarget: null,
    finiWeekDay: null,
    foutWeekDay: null,
    groupon: null,
    hotelId: null,
    latitude: null,
    longitude: null,
    pCode: null,
    searchStringID: null,
    urlHotel: null,
    virtualHotel: null,
    voucherCode: null,


    setLastSearch: function setLastSearch(tcm_hotel) {
        var $this = this;
        var param = "";
        var url = "";
        if (tcm_hotel) {
            param += "?tcm=" + tcm_hotel;
        }
        if (Globals.subdomain) {
            url = Globals.subdomain + "/booking/ajax/hotelPage/checkDates.html" + param;
        } else {
            url = "/booking/ajax/hotelPage/checkDates.html" + param;
        }
        var promise = $.ajax({
            dataType: "json",
            url: url,
            cache: false,
            async: false
        });
        return promise.then(function (response) {
            if (typeof response !== "undefined" && response) {
                $this.setValues(response)
            }
        }, function (error) {
            console.log("Fail call checkDates: ", error.status, error.responseText);
        }).always(function () {
            console.log("siempre checkDates")
        });
    },
    setValues: function (result) {
        var $this = this;
        lastSearch.fini = $this.checkValue(result.fini);
        lastSearch.fout = $this.checkValue(result.fout);

        if (typeof result.nAdults1 != 'undefined') {
            lastSearch.occupancy[0] = {
                adults: result.nAdults1,
                children: result.nChilds1,
                babies: result.nBabies1,
            };
        }
        if (typeof result.nAdults2 != 'undefined') {
            lastSearch.occupancy[1] = {
                adults: result.nAdults2,
                children: result.nChilds2,
                babies: result.nBabies2,
            };
        }
        if (typeof result.nAdults3 != 'undefined') {
            lastSearch.occupancy[2] = {
                adults: result.nAdults3,
                children: result.nChilds3,
                babies: result.nBabies3,
            };
        }
        if (typeof result.nAdults4 != 'undefined') {
            lastSearch.occupancy[3] = {
                adults: result.nAdults4,
                children: result.nChilds4,
                babies: result.nBabies4,
            };
        }
        if (typeof result.nAdults5 != 'undefined') {
            lastSearch.occupancy[4] = {
                adults: result.nAdults5,
                children: result.nChilds5,
                babies: result.nBabies5,
            };
        }

        lastSearch.numRooms = lastSearch.occupancy.length;
        if (lastSearch.fini && lastSearch.fout) {
            lastSearch.numNights = $this.getDiffDays(lastSearch.fini, lastSearch.fout);
        }
        if (!$.isEmptyObject(lastSearch.occupancy)) {
            lastSearch.numTotalAdults = 0;
            lastSearch.numTotalChildren = 0;
            lastSearch.numTotalBabies = 0;
            $.each(lastSearch.occupancy, function (i, room) {
                var lazyRoomItem = {
                    numberOfAdults: room.adults,
                    numberOfChildren: room.children,
                    numberOfBabies: room.babies
                };
                lastSearch.numTotalAdults += parseInt(room.adults);
                lastSearch.numTotalChildren += parseInt(room.children);
                lastSearch.numTotalBabies += parseInt(room.babies);
            });
        }
    },
    checkValue: function (val) {
        return (val != null && val != undefined && val != 'undefined' && val != '') ? val : null
    },
    getDiffDays: function getDiffDays(date1, date2) {
        date1 = new Date(date1.split("/")[2], date1.split("/")[1] - 1, date1.split("/")[0]);
        date2 = new Date(date2.split("/")[2], date2.split("/")[1] - 1, date2.split("/")[0]);
        var timeDiff = Math.abs(date1.getTime() - date2.getTime());
        var diffDays = Math.ceil(timeDiff / (1e3 * 3600 * 24));
        return diffDays;
    },
    fillInputSearch: function () {

    }
};


//nedded for currency.js
var actualDivisa = '';
var selectedDivisa = '';
var divisaAnterior2;

var LandingUtag = function () {
    var init = function () {
        if (typeof utag_data != "undefined") {
            getSearchData();
            setUtagData();
        }
    };
    var getSearchData = function () {
        lastSearch.fini = getURLParameter("fini");
        lastSearch.fout = getURLParameter("fout");
        if (getURLParameter("nadults1")) {
            lastSearch.occupancy[0] = {
                adults: getURLParameter("nadults1"),
                children: getURLParameter("nchilds1"),
                babies: getURLParameter("nbabies1") || 0
            };
        }
        if (getURLParameter("nadults2")) {
            lastSearch.occupancy[1] = {
                adults: getURLParameter("nadults2"),
                children: getURLParameter("nchilds2"),
                babies: getURLParameter("nbabies2") || 0
            };
        }
        if (getURLParameter("nadults3")) {
            lastSearch.occupancy[2] = {
                adults: getURLParameter("nadults3"),
                children: getURLParameter("nchilds3"),
                babies: getURLParameter("nbabies3") || 0
            };
        }
        if (getURLParameter("nadults4")) {
            lastSearch.occupancy[3] = {
                adults: getURLParameter("nadults4"),
                children: getURLParameter("nchilds4"),
                babies: getURLParameter("nbabies4") || 0
            };
        }
        if (getURLParameter("nadults5")) {
            lastSearch.occupancy[4] = {
                adults: getURLParameter("nadults5"),
                children: getURLParameter("nchilds5"),
                babies: getURLParameter("nbabies5") || 0
            };
        }
        lastSearch.numRooms = lastSearch.occupancy.length;
        if (lastSearch.fini && lastSearch.fout) {
            lastSearch.numNights = getDiffDays(lastSearch.fini, lastSearch.fout);
        }
        if (!$.isEmptyObject(lastSearch.occupancy)) {
            lastSearch.numTotalAdults = 0;
            lastSearch.numTotalChildren = 0;
            lastSearch.numTotalBabies = 0;
            $.each(lastSearch.occupancy, function (i, room) {
                var lazyRoomItem = {
                    numberOfAdults: room.adults,
                    numberOfChildren: room.children,
                    numberOfBabies: room.babies
                };
                lastSearch.numTotalAdults += parseInt(room.adults);
                lastSearch.numTotalChildren += parseInt(room.children);
                lastSearch.numTotalBabies += parseInt(room.babies);
            });
        }
    };
    var setUtagData = function () {
        if (lastSearch.fini && lastSearch.fout) {
            var dateIniSplit = lastSearch.fini.split("/");
            var dateOutSplit = lastSearch.fout.split("/");
            var dateIni = dateIniSplit[2] + "/" + dateIniSplit[1] + "/" + dateIniSplit[0];
            var dateOut = dateOutSplit[2] + "/" + dateOutSplit[1] + "/" + dateOutSplit[0];
            utag_data.busqFecha = dateIni + " - " + dateOut;
            utag_data.search.date = dateIni + " - " + dateOut;
            if (lastSearch.numRooms && lastSearch.numNights) {
                var products_quantity = parseInt(lastSearch.numRooms) * parseInt(lastSearch.numNights) + "";
                if (products_quantity) {
                    utag_data.products_quantity.push(products_quantity.toString());
                }
            }
            utag_data.search.nights = lastSearch.numNights;
            var occupancy = lastSearch.numRooms + "," + lastSearch.numTotalAdults + "," + lastSearch.numTotalChildren + "," + lastSearch.numTotalBabies;
            utag_data.busqOcupacion = occupancy;
            utag_data.search.occupation = occupancy;
            utag_data.search.adults = lastSearch.numTotalAdults;
            utag_data.search.children = lastSearch.numTotalChildren;
            utag_data.search.babies = lastSearch.numTotalBabies;
        }

        // Añadir en result page los utag data faltantes
        if (lazyDataSend && !$.isEmptyObject(lazyDataSend.hotels) && pageData.destinoCode && JSON.stringify(lazyDataSend)) {
            if(typeof utag_data.products_id == "undefined") utag_data.products_id = [];
            if(typeof utag_data.products_position == "undefined") utag_data.products_position = [];
            if(typeof utag_data.products_list == "undefined") utag_data.products_list = [];
            for (var key in lazyDataSend.hotels) {
                utag_data.products_id.push(key);
                utag_data.products_position.push(Object.keys(lazyDataSend.hotels).indexOf(key) + 1);
                utag_data.products_list.push("search results");
            }
            utag_data.busqNumResult = utag_data.products_id.length;
        }

    };
    var getURLParameter = function (name, url) {
        var urlT = url ? url : window.location.href;
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regexS = "[\\?&]" + name + "=([^&#]*)";
        var regex = new RegExp(regexS);
        var results = regex.exec(urlT);
        if (results == null) {
            return null;
        } else {
            try {
                return decodeURIComponent(results[1].replace(/\+/g, " "));
            } catch (error1) {
                try {
                    return unescape(results[1].replace(/\+/g, " "));
                } catch (error2) {
                    return null;
                }
            }
        }
    };
    var getDiffDays = function (date1, date2) {
        date1 = new Date(date1.split("/")[2], date1.split("/")[1] - 1, date1.split("/")[0]);
        date2 = new Date(date2.split("/")[2], date2.split("/")[1] - 1, date2.split("/")[0]);
        var timeDiff = Math.abs(date1.getTime() - date2.getTime());
        var diffDays = Math.ceil(timeDiff / (1e3 * 3600 * 24));
        return diffDays;
    };
    return {
        init: init,
        getURLParameter: getURLParameter
    };
}();

$(function() {

	validateCard();
	validateCard2();
	

	//Mes
	$('.js-validate-card .js-month').keyup(function(){
		cardInput = $(this);
		cardMonth = $(this).val();

		//añadimos el número en la tarjeta de muestra
		$('.custom-card .expired-date-card .month').text(cardMonth);
		if ($('.custom-card .expired-date-card .month').text() < 1){
			$('.custom-card .expired-date-card .month').text("12");
		}
	});

	//Año
	$('.js-validate-card .js-year').keyup(function(){
		cardInput = $(this);
		cardMonth = $(this).val();

		//añadimos el número en la tarjeta de muestra
		$('.custom-card .expired-date-card .year').text(cardMonth);
		if ($('.custom-card .expired-date-card .year').text() < 1){
			$('.custom-card .expired-date-card .year').text("15");
		}
	});

	//Mes 2
	$('.js-validate-card-2 .js-month').keyup(function(){
		cardInput = $(this);
		cardMonth = $(this).val();

		//añadimos el número en la tarjeta de muestra
		$('.custom-card-2 .expired-date-card .month').text(cardMonth);
		if ($('.custom-card-2 .expired-date-card .month').text() < 1){
			$('.custom-card-2 .expired-date-card .month').text("12");
		}
	});

	//Año 2
	$('.js-validate-card-2 .js-year').keyup(function(){
		cardInput = $(this);
		cardMonth = $(this).val();

		//añadimos el número en la tarjeta de muestra
		$('.custom-card-2 .expired-date-card .year').text(cardMonth);
		if ($('.custom-card-2 .expired-date-card .year').text() < 1){
			$('.custom-card-2 .expired-date-card .year').text("15");
		}
	});


	//CVV

	// $('.js-validate-card .js-cvv').keyup(function(){
	// 	//añadimos el número en la tarjeta de muestra
	// 	$('.custom-card .cvv-number').text($(this).val());
	// 	if ($('.custom-card .cvv-number').text() < 1){
	// 		$('.custom-card .cvv-number').text("000");
	// 	}
	// });



	//Mostramos siempre la primera cara al pulsar en un input excepto cuando....
	$('.js-validate-card input').focus(function(){

		$('.card-container').removeClass('hover');

		if($(this).hasClass('js-cvv') && $(this).hasClass('no-amex')){
			$('.card-container').addClass('hover');
		}

	});



	//Mostramos siempre la primera cara al pulsar en un input excepto cuando.... 2
	$('.js-validate-card-2 input').focus(function(){

		$('.card-container-2').removeClass('hover');

		if($(this).hasClass('js-cvv') && $(this).hasClass('no-amex')){
			$('.card-container-2').addClass('hover');
		}

	});



	//Nombre
	$('.js-validate-card .js-name').keyup(function(){
		cardName = $(this).val();
		//añadimos el número en la tarjeta de muestra
		$('.custom-card .name-card').text(cardName);
		if ($('.custom-card .name-card').text().length < 1){
			$('.custom-card .name-card').text("NOMBRE DEL TITULAR");
		}
	});

	//Apellido
	/*$('.js-validate-card .js-surname').keyup(function(){
		cardSurname = $(this).val();
		//añadimos el número en la tarjeta de muestra
		$('.custom-card .surname-card').text(cardSurname);

	})*/

	//On key up
	$('.js-cvv').keyup(function() {
		if (parseInt($('.js-cvv').val(),10) >= 3 && $('.js-cvv').hasClass('no-amex')) {
			$('.js-cvv').val($('.js-cvv').val().slice(0,3));
		} else {
			$('.js-cvv').val($('.js-cvv').val().slice(0,4));
		}

		$('.custom-card .cvv-number').text($(this).val());
		if ($('.custom-card .cvv-number').text() < 1){
			$('.custom-card .cvv-number').text("000");
	 	}
	});

	//Changes
	$("#booking-step-4-card-9").change(function(){
		$(".month").html($("#booking-step-4-card-9").val());
		$('.month').removeClass("active");
	});

	$("#booking-step-4-card-4").change(function(){
		$(".year").html($("#booking-step-4-card-4").val());
		$('.year').removeClass("active");
	});

	//Changes 2
	$("#garantee-expiration-month").change(function(){
		$(".month-2").html($("#garantee-expiration-month").val());
		$('.month-2').removeClass("active");
	});

	$("#garantee-expiration-year").change(function(){
		$(".year-2").html($("#garantee-expiration-year").val());
		$('.year-2').removeClass("active");
	});


	//Focos
	$("#booking-step-4-card-1").focusin(function() {
		$('.number-card').addClass("active");
	});
	$("#booking-step-4-card-1").focusout(function() {
		$('.number-card').removeClass("active");
	});

	$("#booking-step-4-card-2").focusin(function() {
		$('.name-card').addClass("active");
	});
	$("#booking-step-4-card-2").focusout(function() {
		$('.name-card').removeClass("active");
	});

	//Focos 2
	$("#garantee-payment-method").focusin(function() {
		$('.number-card-2').addClass("active");
	});
	$("#garantee-payment-method").focusout(function() {
		$('.number-card-2').removeClass("active");
	});

//aki
	$("[data-id='booking-step-4-card-9']").click(function() {
		$('.month').addClass("active");
		$('.card-container').removeClass('hover');
	});
	$("[data-id='booking-step-4-card-9']").focusout(function() {
		$('.month').removeClass("active");
	});

	$("[data-id='booking-step-4-card-4']").click(function() {
		$('.year').addClass("active");
		$('.card-container').removeClass('hover');
	});
	$("[data-id='booking-step-4-card-4']").focusout(function() {
		$('.year').removeClass("active");
	});



	$("[data-id='garantee-expiration-month']").click(function() {
		$('.month-2').addClass("active");
		$('.card-container-2').removeClass('hover');
	});
	$("[data-id='garantee-expiration-month']").focusout(function() {
		$('.month-2').removeClass("active");
	});

	$("[data-id='garantee-expiration-year']").click(function() {
		$('.year-2').addClass("active");
		$('.card-container-2').removeClass('hover');
	});
	$("[data-id='garantee-expiration-year']").focusout(function() {
		$('.year-2').removeClass("active");
	});

	$("#booking-step-4-card-5").focusin(function() {
		$('.cvv-number').addClass("active");
	});
	$("#booking-step-4-card-5").focusout(function() {
		$('.cvv-number').removeClass("active");
	});
});

function isNumberKey(evt){
	var charCode = (evt.which) ? evt.which : event.keyCode
	if (charCode > 31 && (charCode < 48 || charCode > 57)) {
		return false;
	}
	return true;
}

function validateCard() {
		/* Validador de tarjeta */
	if ( globalConfig.windowWidth > globalConfig.smBreak ) {
		$('.js-validate-card .js-number-key').removeAttr('pattern inputmode').attr('type', 'text').removeClass('only-phone');
		$('.js-validate-card .js-number-key').keyup(function( ev ){


			// ev.key 			Backspace // Safari undefined
			// ev.keyCode 		8
			// ev.which 		8

			// ev.key 			Delete // Safari undefined
			// ev.keyCode 		46
			// ev.which 		46

			// ev.key 			ArrowLeft // Safari undefined
			// ev.keyCode 		37
			// ev.which 		37

			// ev.key 			ArrowRight // Safari undefined
			// ev.keyCode 		39
			// ev.which 		39


			if( ev.which != 37 && ev.which != 39 ) {


				cardInput = $(this);
				cardNumber = $(this).val();
				cardImg = $('.brand-card span');

				var ccMethods = $(this).data('methods').split(',');
				//validamos si es una u otra
				ccDefinitions = {
					'ic-card-visa': /^4/,
                    'ic-card-disc': /^(6011|65|64[4-9]|622)/,
					'ic-card-american': /^3(4|7)/,
					'ic-card-master': /^(5|2)[1-5]/,
                    'ic-card-unionpay': /^62/,
                    'ic-card-diners': /^(36|38|30[0-5])/

				};

				if ( ccMethods && ccMethods.length > 0 ) {
					ccDefinitionsNew = {};
					for (metodo in ccDefinitions ) {

						if ( ccMethods.indexOf(metodo) > -1 ) {
							ccDefinitionsNew[metodo] = ccDefinitions[metodo];
						}
					}
					ccDefinitions = ccDefinitionsNew;
				}

				//Añadimos el logo segun el tipo de tarjeta
				$.each(ccDefinitions, function( i, value ) {

					if (value.test(cardNumber)){
						cardType = i;
						cardImg.addClass(i);
						cardInput.removeClass('invalidType');
						return false;
					}else{
						cardType = i;
						cardImg.removeClass();
						cardInput.addClass('invalidType');
					}

				});

				//Pintamos los ____ _____ dependiendo del tipo de tarjeta
				if (cardType === 'ic-card-american'){
					if ( ev.which != 8 && ev.which != 46 ) {
						$(this).inputmask("9999 999999 99999",
							{ "oncomplete": function(){
								//Pasamos al campo de nombre
								//$('.js-validate-card .js-name').focus()

							}
						});
					}
					$('.front .custom-card .cvv').removeClass('hide');
					$('.js-validate-card .js-cvv').removeClass('no-amex');
					// var actualCvv = parseInt($('.js-validate-card .js-cvv').attr('data-callback-num'), 10);
					// if ( actualCvv != 4 ) {
					// 	$('.js-validate-card .js-cvv').attr('data-callback-num','4').val('');
					// }

				}else if (cardType === 'ic-card-diners'){
                    if ( ev.which != 8 && ev.which != 46 ) {
                        $(this).inputmask("9999 999999 9999",
                            { "oncomplete": function(){
                                //Pasamos al campo de nombre
                                //$('.js-validate-card .js-name').focus()

                            }
                            });
                    }
                    $('.front .custom-card .cvv').addClass('hide');
                    $('.js-validate-card .js-cvv').addClass('no-amex');
                    // var actualCvv = parseInt($('.js-validate-card .js-cvv').attr('data-callback-num'), 10);
                    // if ( actualCvv != 4 ) {
                    // 	$('.js-validate-card .js-cvv').attr('data-callback-num','4').val('');
                    // }

                }else{
					if ( ev.which != 8 && ev.which != 46 ) {
						$(this).inputmask("9999 9999 9999 9999",
							{
								"oncomplete": function(){
									//Pasamos al campo de nombre
									//$('.js-validate-card .js-name').focus()

								}
							}
						);
					}

					$('.front .custom-card .cvv').addClass('hide');
					$('.js-validate-card .js-cvv').addClass('no-amex');
					// var actualCvv = parseInt($('.js-validate-card .js-cvv').attr('data-callback-num'), 10);
					// if ( actualCvv != 3 ) {
					// 	$('.js-validate-card .js-cvv').attr('data-callback-num','3').val('');
					// }
				}
				//añadimos el número en la tarjeta de muestra
				$('.custom-card .number-card').text($(this).val());

				if ($('.custom-card .number-card').text() < 1){
					$('.custom-card .number-card').text("1234 5678 1234 5678");
				}
			}
		});
	} else {

		$('.js-validate-card .js-number-key').attr({
			'pattern': '[0-9]*',
			'inputmode': 'numeric',
			'maxlength': '16',
			'type': 'number'
		}).keypress(function (e) {
	    	return isNumberKey( e );
		});

		$('.js-validate-card .js-number-key').keyup(function( ev ) {
			if( ev.which != 37 && ev.which != 39 ) {


				cardInput = $(this);
				cardNumber = $(this).val();
				cardImg = $('.brand-card span');

				var ccMethods = $(this).data('methods').split(',');
				//validamos si es una u otra
				ccDefinitions = {
					'ic-card-visa': /^4/,
                    'ic-card-disc': /^(6011|65|64[4-9]|622)/,
					'ic-card-american': /^3(4|7)/,
					'ic-card-master': /^(5|2)[1-5]/,
                    'ic-card-unionpay': /^62/,
                    'ic-card-diners':   /^(36|38|30[0-5])/
				};

				if ( ccMethods && ccMethods.length > 0 ) {
					ccDefinitionsNew = {};
					for (metodo in ccDefinitions ) {

						if ( ccMethods.indexOf(metodo) > -1 ) {
							ccDefinitionsNew[metodo] = ccDefinitions[metodo];
						}
					}
					ccDefinitions = ccDefinitionsNew;
				}



				//Añadimos el logo segun el tipo de tarjeta
				$.each(ccDefinitions, function( i, value ) {

					if (value.test(cardNumber)){
						cardType = i;
						cardImg.addClass(i);
						cardInput.removeClass('invalidType');
						return false;
					}else{
						cardType = i;
						cardImg.removeClass();
						cardInput.addClass('invalidType');
					}

				});

				//Pintamos los ____ _____ dependiendo del tipo de tarjeta
				if (cardType === 'ic-card-american'){

					$('.front .custom-card .cvv').removeClass('hide');
					$('.js-validate-card .js-cvv').removeClass('no-amex');
					var actualCvv = parseInt($('.js-validate-card .js-cvv').attr('data-callback-num'), 10);
					if ( actualCvv != 4 ) {
						$('.js-validate-card .js-cvv').attr('data-callback-num','4').val('');
					}
					$('.js-validate-card .js-number-key').attr({
                        'pattern': '[0-9]*',
                        'inputmode': 'numeric',
                        'maxlength': '15',
                        'type': 'number'
                    }).addClass('only-phone');
                    var max = 15;

                    if ($('.js-number-key').val().length > max) {
                        $('.js-number-key').val($('.js-number-key').val().substr(0, max));
                    }

					$(this).attr('maxlength', '15');
				}
                else if (cardType === 'ic-card-diners') {
                    $('.front .custom-card .cvv').addClass('hide');
                    $('.js-validate-card .js-cvv').addClass('no-amex');
                    var actualCvv = parseInt($('.js-validate-card .js-cvv').attr('data-callback-num'), 10);
                    if ( actualCvv != 3 ) {
                        $('.js-validate-card .js-cvv').attr('data-callback-num','3').val('');
					}
					$('.js-validate-card .js-number-key').attr({
                        'pattern': '[0-9]*',
                        'inputmode': 'numeric',
                        'maxlength': '14',
                        'type': 'number'
                    }).addClass('only-phone');
                    var max = 14;

                    if ($('.js-number-key').val().length > max) {
                        $('.js-number-key').val($('.js-number-key').val().substr(0, max));
                    }

                    $(this).attr('maxlength', '14');
                }
				else{

					$('.front .custom-card .cvv').addClass('hide');
					$('.js-validate-card .js-cvv').addClass('no-amex');
					var actualCvv = parseInt($('.js-validate-card .js-cvv').attr('data-callback-num'), 10);
					if ( actualCvv != 3 ) {
						$('.js-validate-card .js-cvv').attr('data-callback-num','3').val('');
					}
					$('.js-validate-card .js-number-key').attr({
                        'pattern': '[0-9]*',
                        'inputmode': 'numeric',
                        'maxlength': '16',
                        'type': 'number'
                    }).addClass('only-phone');
                    var max = 16;

                    if ($('.js-number-key').val().length > max) {
                        $('.js-number-key').val($('.js-number-key').val().substr(0, max));
                    }

					$(this).attr('maxlength', '16');
				}
				//añadimos el número en la tarjeta de muestra
				$('.custom-card .number-card').text($(this).val());

				if ($('.custom-card .number-card').text() < 1){
					$('.custom-card .number-card').text("1234 5678 1234 5678");
				}
			}
		});
	}
	$(".js-form-checkout input, .js-form-checkout select, .js-form-checkout textarea").not("[type=submit]").jqBootstrapValidation("destroy");
	$(".js-form-checkout input, .js-form-checkout select, .js-form-checkout textarea").not("[type=submit]").jqBootstrapValidation(
		{
			bindEvents: ['change', 'blur', 'focus'],
			filter: function () {
				return $(this).is(":visible") || $(this).is('.callback_date');
			},
			submitError: function($form, event, errors) {
				toggleLoadingButton($form, true);
				scrollToFistError($form);
			},
			submitSuccess: function($form, event) {
				toggleLoadingButton($form, true);
			}
		}
	);
}

function validateCard2() {
		/* Validador de tarjeta */
	if ( globalConfig.windowWidth > globalConfig.smBreak ) {
		$('.js-validate-card-2 .js-number-key').removeAttr('pattern inputmode').attr('type', 'text').removeClass('only-phone');
		$('.js-validate-card-2 .js-number-key').keyup(function( ev ){


			// ev.key 			Backspace // Safari undefined
			// ev.keyCode 		8
			// ev.which 		8

			// ev.key 			Delete // Safari undefined
			// ev.keyCode 		46
			// ev.which 		46

			// ev.key 			ArrowLeft // Safari undefined
			// ev.keyCode 		37
			// ev.which 		37

			// ev.key 			ArrowRight // Safari undefined
			// ev.keyCode 		39
			// ev.which 		39


			if( ev.which != 37 && ev.which != 39 ) {


				cardInput = $(this);
				cardNumber = $(this).val();
				cardImg = $('.brand-card span');


				var ccMethods = $(this).data('methods').split(',');
				//validamos si es una u otra
				ccDefinitions = {
					'ic-card-visa': /^4/,
                    'ic-card-disc': /^(6011|65|64[4-9]|622)/,
					'ic-card-american': /^3(4|7)/,
					'ic-card-master': /^(5|2)[1-5]/,
					'ic-card-unionpay': /^62/,
                    'ic-card-diners': /^(36|38|30[0-5])/
				};

				if ( ccMethods && ccMethods.length > 0 ) {
					ccDefinitionsNew = {};
					for (metodo in ccDefinitions ) {

						if ( ccMethods.indexOf(metodo) > -1 ) {
							ccDefinitionsNew[metodo] = ccDefinitions[metodo];
						}
					}
					ccDefinitions = ccDefinitionsNew;
				}

				//Añadimos el logo segun el tipo de tarjeta
				$.each(ccDefinitions, function( i, value ) {

					if (value.test(cardNumber)){
						cardType = i;
						cardImg.addClass(i);
						cardInput.removeClass('invalidType');
						return false;
					}else{
						cardType = i;
						cardImg.removeClass();
						cardInput.addClass('invalidType');
					}

				});

				//Pintamos los ____ _____ dependiendo del tipo de tarjeta
				if (cardType === 'ic-card-american'){
                        if ( ev.which != 8 && ev.which != 46 ) {
                            $(this).inputmask("9999 999999 99999",
                                { "oncomplete": function(){
                                    //Pasamos al campo de nombre
                                    //$('.js-validate-card .js-name').focus()

                                }
                                });
                        }
                        // $('.front .custom-card .cvv').removeClass('hide');
                        // $('.js-validate-card .js-cvv').removeClass('no-amex');
                        // $('.js-validate-card .js-cvv').attr('maxlength','4').attr('minlength','4').prop('maxlength','4').prop('minlength','4');
                        // $('.js-validate-card .js-cvv').attr('data-callback-num','4');

				}else if(cardType === 'ic-card-diners'){
                    if ( ev.which != 8 && ev.which != 46 ) {
                        $(this).inputmask("9999 999999 9999",
                            {
                                "oncomplete": function(){
                                    //Pasamos al campo de nombre
                                    //$('.js-validate-card .js-name').focus()

                                }
                            }
                        );
                    }

                    // $('.front .custom-card .cvv').addClass('hide');
                    // $('.js-validate-card .js-cvv').addClass('no-amex');
                    // $('.js-validate-card .js-cvv').attr('data-callback-num','4');

                }else{
					if ( ev.which != 8 && ev.which != 46 ) {
						$(this).inputmask("9999 9999 9999 9999",
							{
								"oncomplete": function(){
									//Pasamos al campo de nombre
									//$('.js-validate-card .js-name').focus()

								}
							}
						);
					}

					// $('.front .custom-card .cvv').addClass('hide');
					// $('.js-validate-card .js-cvv').addClass('no-amex');
					// $('.js-validate-card .js-cvv').attr('data-callback-num','4');

				}
				//añadimos el número en la tarjeta de muestra
				$('.custom-card-2 .number-card-2').text($(this).val());

				if ($('.custom-card-2 .number-card-2').text() < 1){
					$('.custom-card-2 .number-card-2').text("1234 5678 1234 5678");
				}
			}
		});
	} else {
		$('.js-validate-card-2 .js-number-key').attr({
			'pattern': '[0-9]*',
			'inputmode': 'numeric',
			'maxlength': '16',
			'type': 'number'
		}).addClass('only-phone');

		$('.js-validate-card-2 .js-number-key').keyup(function( ev ){
			//añadimos el número en la tarjeta de muestra
			$('.custom-card-2 .number-card-2').text($(this).val());

			if ($('.custom-card-2 .number-card-2').text() < 1){
				$('.custom-card-2 .number-card-2').text("1234 5678 1234 5678");
			}

		});
	}
	$(".js-form-checkout input, .js-form-checkout select, .js-form-checkout textarea").not("[type=submit]").jqBootstrapValidation("destroy");
	$(".js-form-checkout input, .js-form-checkout select, .js-form-checkout textarea").not("[type=submit]").jqBootstrapValidation(
		{
			bindEvents: ['change', 'blur', 'focus'],
			filter: function () {
				return $(this).is(":visible") || $(this).is('.callback_date');
			},
			submitError: function($form, event, errors) {
				toggleLoadingButton($form, true);
				scrollToFistError($form);
			},
			submitSuccess: function($form, event) {
				toggleLoadingButton($form, true);
			}
		}
	);
}


$( window ).on('resize', function() {
	validateCard();
	validateCard2();
});



function valida(e){ 
    /*tecla = (document.all) ? e.keyCode : e.which;

    //Tecla de retroceso para borrar, siempre la permite
    if (tecla==8){
        return true;
    }

    // Patron de entrada, en este caso solo acepta letras
	patron = /^[a-zA-ZÀ-ÿ-.\u00f1\u00d1\s]*$/;
    tecla_final = String.fromCharCode(tecla);
    return patron.test(tecla_final);*/
}



class Navigator {
  constructor(viewElement, initState, cssSelector, onNavCompleteCallback) {
    // Properties
    this.$viewElement = $(viewElement);
    this.cssSelector = cssSelector;
    // View states
    this._initState = initState;
    this._actualState;
    this._prevState;
    this._onNavCompleteCallback = onNavCompleteCallback;
    // Init HTML injector
    this.$viewElement.htmlInject();
  }

  getActualState() {
    return this._actualState;
  }

  getPrevState() {
    return this._prevState;
  }

  getViewElement() {
    return this.$viewElement;
  }

  setViewElement(el) {
    this.$viewElement = $(el);
  }

  /**
   * Init navigation status
   */
  initViewElementState(callback) {
    this.navigate(this._initState, callback);
  }

  /**
   * Function to navigate to a state. Injects the html using the html injector widget
   * @param  {[type]} tplUrl [description]
   * @return {[type]}        [description]
   */
  navigate(tplUrl, customCallback) {
    var callback = this._onNavCompleteCallback;
    if(typeof customCallback === 'function') {
      callback = customCallback;
    }
    this.$viewElement.htmlInject('injectHTMLByUrl', this.cssSelector, tplUrl, callback);
    // Update states
    this._prevState =  this._actualState;
    this._actualState = tplUrl;
  }

  /**
   * Return to the previous modal state
   */
  goBackHandler(callback) {
    this.navigate(this._prevState, callback);
  }
}

(function($, window) {
    'use strict';

    var MultiModal = function(element) {
        this.$element = $(element);
        this.modalCount = 0;
    };

    MultiModal.BASE_ZINDEX = 1062;

    MultiModal.prototype.show = function(target) {
        var that = this;
        var $target = $(target);
        var modalIndex = that.modalCount++;
        var $form;

        $target.css('z-index', MultiModal.BASE_ZINDEX + (modalIndex * 20) + 10);

        this.adjustCurrentModalBackdrop($target, modalIndex);

        // Bootstrap triggers the show event at the beginning of the show function and before
        // the modal backdrop element has been created. The timeout here allows the modal
        // show function to complete, after which the modal backdrop will have been created
        // and appended to the DOM.
        window.setTimeout(function() {
            // we only want one backdrop; hide any extras
            //if(modalIndex > 0) {
                //$('.modal-backdrop').not(':first').addClass('hidden toma');
            //}

            that.adjustBackdrop();
        });

        // if the modal contains GDPR content, get the form submit event and set the backdropsize calc the form erros height
        if($target.hasClass("modal-GDPR")) {
            $form = $target.find("form");

            $form.on("submit", function() {
                that.setBackDropSize($target);
            });
        }
    };

    /**
     * @description set the modal backdrop size
     * @param {object} $target the current modal
     */
    MultiModal.prototype.setBackDropSize = function($target) {
        var $modalBackdrop = $target.find(".modal-backdrop");
        var $modalDialog = $target.find(".modal-dialog");
        $modalBackdrop.css("height", $modalDialog.outerHeight(true));
    };

    MultiModal.prototype.adjustCurrentModalBackdrop = function($target, modalIndex) {
        var previousModalBackdrop = $(".modal-backdrop").eq(modalIndex-1);
        var currentModalBackdrop;
        var previousModalBackdropOpacity;
        var actualModalIndex = modalIndex;

        if(previousModalBackdrop.length) {
            setTimeout(function() {
                currentModalBackdrop = $(".modal-backdrop").eq(actualModalIndex);
                previousModalBackdropOpacity = previousModalBackdrop.css("opacity");
                currentModalBackdrop.css({
                    "opacity": (previousModalBackdropOpacity < 1) ? 0 : previousModalBackdropOpacity
                });
            });
        }
    };

    MultiModal.prototype.hidden = function(target) {
        var $target = $(target);
        var $gdprPanels;
        var $gdprPanelsTriggers;

        this.modalCount--;

        if(this.modalCount) {
           this.adjustBackdrop();

            // bootstrap removes the modal-open class when a modal is closed; add it back
            $('body').addClass('modal-open');
        }

        //si la modal tiene panel de gdpr, los ocultamos y quitamos el estado de active
        //a los triggers que muestran los paneles
        if($target.hasClass("modal-GDPR")) {
            $gdprPanels = $target.find(".m-panel-info-GDPR");
            $gdprPanelsTriggers = $target.find('[data-toggle-gdpr-panel]');

            $gdprPanels.addClass("is_close");
            $gdprPanelsTriggers.removeClass("is_active");
        }
    };

    MultiModal.prototype.adjustBackdrop = function() {
        var modalIndex = this.modalCount - 1;
        $('.modal-backdrop').css('z-index', MultiModal.BASE_ZINDEX + (modalIndex * 20));
    };

    function Plugin(method, target) {
        return this.each(function() {
            var $this = $(this);
            var data = $this.data('multi-modal-plugin');

            if(!data)
                $this.data('multi-modal-plugin', (data = new MultiModal(this)));

            if(method)
                data[method](target);
        });
    }

    $.fn.multiModal = Plugin;
    $.fn.multiModal.Constructor = MultiModal;

    $(document).on('show.bs.modal', function(e) {
        $(document).multiModal('show', e.target);
    });

    $(document).on('hidden.bs.modal', function(e) {
        $(document).multiModal('hidden', e.target);
    });
}(jQuery, window));
var login = (function() {
    var defaultErrorMsg = null;
    var $changePasswordSuccesModal = $("#change-password-success");
    var $changePasswordFailedModal = $("#change-password-failed");
  var recaptchaV2Fields = null;
  var recaptchaV3Fields = null;
  var recaptchaTimeout = null;
  var $challenges;
  var checkChallengesTimes = 0;
  
  
    function init() {
      $("#logout, .js-logout").on("click", _logout);
      $("#js-reset-password").on("click", _resetPassword);
    _showLoggedMenu();
      _forgotPassword();
    }
  
    function checkUserLogged() {
      var action = "/auth/consultarUsuarioLogado.do";
      var message = null;
      var isLogged = false;
      var deferred = $.Deferred();
      var promise = $.ajax({
        dataType: "json",
        url: action,
        cache: false
      });
  
      return promise.then(function(response) {
        //para forzar a usuario logado correctamente en desarrollo descomentar esto.
        //response = {"authorities":[{"authority":"ROLE_NHWORLD"}],"allAuthorities":[{"authority":"ROLE_NHWORLD"}],"password":null,"specificRewardsProgram":"REWARDS_HOME","tipousuario":"rewards","partyId":"52736817","dnuser":"cn=ExtUsers,dc=nh-hotels,dc=com","name":"Cris","surname":"Vel","gender":"FEMALE","cardType":"BLUE","totalCredits":"0.0","cardNumber":"527368170000","telephone":"696565843","lastLogin":1533819568354,"customerName":"CRIS VEL","customerFirstName":"Cris","customerLastName":"Vel","customerEmail":"velmorcris@gmail.com","customerCardNumber":"527368170000","customerCardDate":1510704000000,"customerCategory":"BLUE","customerCategoryDescription":"BLUE","customerCategoryClass":"blue","customerProgramImage":null,"customerProgram":"NH_REWARDS","customerExpirationPoints":0.0,"customerExpirationDate":null,"customerTotal":0.0,"customerMaxTransf":0.0,"customerMaxDonat":0.0,"customerCurrency":"EUR","customerLowerLimitTransf":30,"customerUpperLimitTransf":999999999,"customerLowerLimitDonat":30,"customerUpperLimitDonat":999999999,"bonusAmount":null,"cookieMetadata":null,"programs":["REWARDS"],"cptpType":null,"partyIdClient":null,"nhUserType":null,"employeeNumber":null,"agentPartyId":null,"department":null,"nhNombre":null,"nhApellido1":null,"nhApellido2":null,"emailSalesUser":null,"nameSalesUser":null,"surnameSalesUSer":null,"employeeIdSalesUser":null,"crmClientPartyId":null,"nhjob":null,"agentRol":null,"logoName":null,"bpc":false,"b2b":false,"b2bType":null,"subprogram":null,"discount":null,"mainCustomerCode":"","contractId":"","companyId":"","companyType":null,"loginPage":"https://www.nh-hotels.com/booking/step2-personal-data?reservationId=U80IFCL8","email":"velmorcris@gmail.com","checkoutLogin":true,"homeLogin":false,"b2bAgentAgencyLogin":false,"b2bAgentBusinessLogin":false,"type":"B2C","username":"velmorcris@gmail.com", "street": "CALLE","city": "BARCELONA","postalCode": "08022","nationality": "ES","taxNumber": "05222333B","documentType": "passport","dateOfBirth": "05/12/1991"};
        //para forzar a usuario logado correctamente.
        isLogged = (response.username && response.username !== "anonymous");
          if(isLogged) {
            return {
              'isLogged': isLogged,
              'userData' : response,
              'message' : message
            };
          } else {
            _removeLoginCookies();
            message = "Username is anonymous /auth/consultarUsuarioLogado.do";
            response = null;
            return deferred.reject({
              'isLogged': isLogged,
              'userData' : response,
              'message' : message
            });
          }
      }, function(error) {
        _removeLoginCookies();
        return {
          'isLogged': isLogged,
          'userData' : null,
          'message' : error
        };
      });
    }
  
    function handleLoginAnalytics(rol, user, action) {
      var eventCategory = _getLoginForm(user);
      var eventLabel = _getUserType(rol, user);
      trackLogin(eventCategory, eventLabel, action);
    }
  
    // TODO: esto parece que no se usa, confirmar con EY
    function handleLoginErrorAnalytics(page, action) {
      var eventCategory = _getLoginPage(page);
      var eventLabel = "userName/pass";
      trackLogin(eventCategory, eventLabel, "form analysys error");
    }
  
    function loginSSO(loginData) {
      var ssoUrl = (typeof Globals.ssoUrl !== "undefined") ? Globals.ssoUrl : null;
      var ssoService = (typeof Globals.ssoService !== "undefined") ? Globals.ssoService : null;
      var url;
      var deferred = $.Deferred();
      var errorMessage;
      var promise;
  
      defaultErrorMsg = loginData.defaultErrorMsg;
  
      //url = ssoUrl + "?service=" + ssoService + "&username=" + loginData.user + "&password=" + encodeURIComponent(loginData.password);
  
      var ssoData = {
        service: ssoService,
        username: loginData.user,
        password: loginData.password
      };
      if (loginData.user && loginData.password && ssoService && ssoUrl) {
        promise = $.ajax({
          method:"POST",
          contentType: 'application/json',
          data: JSON.stringify( ssoData ),
          url: ssoUrl,
          async: false,
          dataType: 'json'         
        });
  
        return promise.then(function(res) {
          //delete res.data.ticketGrantingTicket; -> descomentar para probar el error del login
          if (res.data && res.data.ticketGrantingTicket) {      
            var result = $.ajax({
              method : "POST",
              url: ssoUrl + "validate/?ticketGrantingTicket=" + res.data.ticketGrantingTicket + "&service=" + ssoService,
              dataType: 'jsonp',
              async: false
            });    
            return _checkLoginTicket(res.data.ticketGrantingTicket);
          } else if(res.response.resultCode){
            //LOGIN KO!
            return $.ajax({
              method:"GET",
              url:  "/auth/loginErrorMessage.do?resultCode=" + res.response.resultCode
            }).then(function(response) {
              return deferred.reject({"message":response});
            }, function() {
              return {"message":"Login Error"};
            });
          }
        }, function(jqXHR, exception) {
          //LOGIN KO!
          if (jqXHR.status === 0) {
            errorMessage = 'Not connect.\n Verify Network.';
          } else if (jqXHR.status == 404) {
            errorMessage = 'Requested page not found. [404]';
          } else if (jqXHR.status == 500) {
            errorMessage = 'Internal Server Error [500].';
          } else if (exception === 'parsererror') {
            errorMessage = 'Requested JSON parse failed.';
          } else if (exception === 'timeout') {
            errorMessage = 'Time out error.';
          } else if (exception === 'abort') {
            errorMessage = 'Ajax request aborted.';
          } else {
            errorMessage = 'Login Error';
          }
  
          return {"message":errorMessage};
        });
      } else {
        console.log("One of this params are empty: user, password, Globals.ssoService or Globals.ssoUrl");
        errorMessage = (loginData.user && loginData.password) ? defaultErrorMsg : "One of this fields are empty: user, password";
        deferred.reject({"message": errorMessage});
        return deferred.promise();
      }
    }
  
  function submitRecoverPasswordEmail() {
    var $form = $(this);
    var url =  urlGlobalConfig.host + urlGlobalConfig.resetPassword;
    var errorMessage;
    var promise = $.ajax(
      {
        type: "POST",
        url: url,
        data: "email=" + $form.find("#email").val() + "&cmp=" + $form.find("#cmp").val() +  + "&cmpView=" + $form.find("#cmpView").val(),
        async: true,
        dataType: "json"
      }
    );

    return promise.then(function(response) {
      //mModalLogin.getNavigator().navigate(mModalLogin.RECOVER_PASSWORD_CONFIRMATION);
      return response;
    }, function(error) {
      errorMessage =`<ul class="list-unstyled"><li>${error.response}</li></ul>`;
      $email.val("");
      $email.closest('.form-group').addClass('has-error');
      $email.closest('.help-block').html(errorMessage);
    });
  }

  /**
   * @description - generar los recaptchas de google en las modales de login y recuperar contraseña
   * @param {object} form - elemento jquery del formulario en el que trabajar (login o recuperar contraseña)
   */
  function initLoginRecaptcha(form) {
    recaptchaV2Fields = form.find('.g-recaptcha');
    recaptchaV3Fields = form.find(".response-recaptcha");

    if(recaptchaV2Fields.length) {
      _loginV2OnloadCallback();
    }

    if(recaptchaV3Fields.length) {
      _loginV3OnloadCallback();
    }
  }

  /**
   * @description - generar los recaptchas de google en las modales de login y recuperar contraseña
   * @param {object} form - elemento jquery del formulario en el que trabajar (login o recuperar contraseña)
   */
  function removeLoginRecaptcha(form) {
    var recaptchaId;
    recaptchaV2Fields = form.find('.g-recaptcha');


    if(recaptchaV2Fields.length) {
      recaptchaId = recaptchaV2Fields.eq(0).data("widget-index");
      grecaptcha.reset(recaptchaId);
    }
  }

    /*** PRIVATE ***/
  function _loginV2OnloadCallback() {
    if(grecaptcha.render) {
      //console.log('grecaptcha v2 in login is ready!');
      recaptchaV2Fields.each(function(index, el) {
        var widgetId = grecaptcha.render(el, {
          'sitekey' : recaptchaV2Key
        });
  
        $(this).attr({
          'data-widget-id': 'g-recaptcha-' + widgetId,
          'data-widget-index': widgetId
        });

        if($("body").hasClass("right") || $("body").hasClass("left")) {
          $challenges = $("[title='recaptcha challenge']");
          $("body").data("challenges", $challenges.length);
          recaptchaTimeout = setInterval(fixCaptchaPosition, 1000);
        }
      });
    }
  }

  function fixCaptchaPosition() {
    //console.log("ponemos clases al captcha");
    var $challenges = $("[title='recaptcha challenge']");
    var $currentChallenge = $challenges.eq($challenges.length-1);
    var $parent = $currentChallenge.parent();
    checkChallengesTimes++;
    if($challenges.length > $("body").data("challenges")) {
      $parent.addClass("center-img-challenge pFixed");
      clearInterval(recaptchaTimeout);
    } else if(checkChallengesTimes === 10) {
      clearInterval(recaptchaTimeout);
    }
  }

  function _loginV3OnloadCallback() {
    //console.log('grecaptcha login v3 is ready!');
    $('body').addClass('show-grecaptcha-badge');
    recaptchaV3Fields.each(function() {
      var $this = $(this);
      grecaptcha.ready(function() {
        grecaptcha.execute(recaptchaV3Key, { action: 'login' }).then(function(token) {
          $this.val(token);
        });
      });
    });
  }
  
    function _checkLoginTicket(ticket) {
      var action = "/j_spring_cas_security_check?ticket=" + ticket;
      var deferred = $.Deferred();
      var targetUrl = location.href;
      var date;
      var promise = $.post(action);
  
      promise.then(function(res) {
        if(res && res.user) {
        	delete res.user;
      	}
      	if(res && res.user) {
          //LOGIN OK!
          targetUrl = (res.targetUrl) ? res.targetUrl : targetUrl;
          if(targetUrl.search("roldispacher") !== -1) {
            date = new Date();
            targetUrl = targetUrl + '&_=' + date.getTime();
          }
          return {
            targetUrl: targetUrl
          };
        } else if (res.response && res.response.resultCode === "KO") {
          //LOGIN KO!
          return deferred.reject({
          "message": defaultErrorMsg,
          "type": (res.response.result === "RESTORE-PASS") ? "blocked-user": "login-failed"
          });
        }
      }, function(error) {
        //LOGIN KO!
        if(error.responseText === '') {
          //Is 404
          return deferred.reject({"message": defaultErrorMsg});
        } else {
          var errorResponse = JSON.parse(error.responseText);
          //Show error message
          var messageError = errorResponse.errorCode || defaultErrorMsg;
          return deferred.reject({"message": messageError});
        }
      });
      return promise;
    }
  
    // TODO: Revisar. Desde donde se envia el forgotPassword? donde esta el formulario?
    function _forgotPassword() {
      var $forgotPasswordForm = $("#recoverPasswordForm");
      $forgotPasswordForm.validator({
        disable: false
      }).on('submit', _onForgotFormSubmit)
      .off('input.bs.validator focusout.bs.validator');
      /*
        comentado porque la modal de recuperar contraseña es la misma que la de login al cambiar de una a otra o al cerrarse aparecen los form reseteados
      $("#recover-password").on("hidden.bs.modal", function(event) {
        var button = $(event.relatedTarget);
        var modal = $(this);
        $("#recover-content").show();
        modal.find("#emailRecover").val("");
        modal.find("#confirmation-msg").addClass("hide");
        modal.find(".form-group").removeClass("has-error");
        modal.find(".help-block").empty();
        modal.find(".js-error-message").empty();
        modal.find('[type="submit"]').prop("disabled", false);
      });*/
  
    }
  
    function _getB2bClientType(b2bType) {
      if (!b2bType) {
          return "agency|business";
      }
      return b2bType == "AG" ? "agency" : "business";
    }
  
    function _getLoginForm(user) {
      var loginForm = (user.b2bAgentAgencyLogin || user.b2bAgentBusinessLogin) ? "loginb2bForm" : "loginRewardsForm";
      return loginForm;
    }
  
    function _getLoginPage(page) {
      var loginPage = "";
      var pageName = (page) ? page.toLowerCase() : "";
      switch (pageName) {
        case "home":
          loginPage = "loginRewardsForm";
          break;
        case "travel guides":
        case "agencies":
        case "business":
          loginPage = "loginb2bForm";
          break;
        default:
          break;
      }
      return loginPage;
    }
  
    function _getUserType(rol, user) {
      var userType = "";
      switch (rol) {
        case "B2B_HOME":
          userType = _getB2bClientType(user.b2bType);
          break;
  
        case "B2B_ADMIN":
          userType = "b2bAdmin";
          break;
  
        case "B2E_EMPLEADO":
        case "B2E_FRIENDS":
          userType = "employee";
          break;
  
        case "REWARDS_HOME":
        case "CORPORATE":
        case "NH_MEDIA":
        case "TRAVEL_PARTNER":
        case "PLATINUM_VIP":
          userType = "rewards";
          break;
  
        default:
          break;
      }
      return userType;
    }
  
    function _logout(ev) {
      var action = "/j_spring_security_logout";
      ev.preventDefault();
      $.ajaxSetup({
          cache: false
      });
      $.getJSON(action, null, function(data) {
        if (typeof data.exitCode !== "undefined") {
          //@EY arobles: Cambio body por main, ya que la clase se define en el main y actualizo el nombre de la clase utilizada
          if ($("main").hasClass("p-landings")) {
              window.location.reload();
          } else {
              window.location = location.protocol + "//" + location.host;
          }
        }
      });
      _removeLoginCookies();
    }
  
    function _onForgotFormSubmit(ev) {
      var $form = $(this);
      var defaultProtocol = location.host.search("webint") !== -1 ? "http://" : "https://";
      var secureDomain = defaultProtocol + location.host;
      var formData = {
        email: $form.find("#emailRecover").val(),
        cmp: $form.find("#cmp").val(),
        cmpView: $form.find("#cmpView").val(),
        url: secureDomain + "/nhrewards/reset-password"
      };
  
      toggleLoadingButton($form, true);
      if (ev.isDefaultPrevented()) {
        // Invalid Form
        toggleLoadingButton($form, false);
      } else {
        // Valid Form
        ev.preventDefault();
        _sendForgotPasswordForm($form, formData);
      }
    }
  
    function _resetPassword(ev) {
      var defaultProtocol = location.host.search("webint") != -1 ? "http://" : "https://";
      var secureDomain = defaultProtocol + location.host;
      var url = secureDomain + "/nhrewards/reset-password-user";
      ev.preventDefault();
      $.ajax({
        type: "POST",
        url: url,
        data: "email=" + $("#email").val(),
        async: true,
        dataType: "json"
      }).done(function(data) {
          if(data && data.success === "true") {
            $changePasswordSuccesModal.modal("show");
          } else {
            $changePasswordFailedModal.modal("show");
          }
      }).fail(function(jqXHR, textStatus) {
          console.log("fail reset password: ", jqXHR, textStatus);
          $changePasswordFailedModal.modal("show");
      });
    }
  
    // TODO: Revisar. Desde donde se envia el forgotPassword? donde esta el formulario?
    function _sendForgotPasswordForm($form, formData) {
      $("#recover-password").find(".js-error-message").empty();
  
      $.ajax({
        type: "POST",
        url: formData.url,
        data: "email=" + formData.email + "&cmp=" + formData.cmp + "&cmpView=" + formData.cmpView,
        async: true,
        dataType: "json"
      }).done(function(data) {
          if (data && data.success == "true") {
              $("#recover-content").hide();
              $("#recover-password").find("#confirmation-msg").removeClass("hide");
          } else {
              $(".js-error-message").text(data.response);
          }
      }).fail(function(data) {
          $(".js-error-message").text(data.response);
      }).always(function() {
        toggleLoadingButton($form, false);
      });
    }
  
    function _showLoggedMenu() {
     
    }
  
    function _removeLoginCookies() {
      sessionStorage.removeItem("userLoggedData"); // remove
      $.cookie("rememberme", null, { path: '/' }); // remove
    }
  
    return {
      checkUserLogged: checkUserLogged,
      init:init,
      loginSSO: loginSSO,
    handleLoginAnalytics: handleLoginAnalytics,
    submitRecoverPasswordEmail: submitRecoverPasswordEmail,
    initLoginRecaptcha: initLoginRecaptcha,
    removeLoginRecaptcha: removeLoginRecaptcha
    };
  })();
  
  $(() => {
    login.init();
});

/**
 * JQuery plugin for the three selector datepicker/calendar
 * Options:
 *  - format: Date format for momentJS plugin
 *  - initYear: First year for the year selector
 *  - Month translations: Array ordered with the translations for every month (Following the 0-11 javascript month index)
 *  - Invalid Date Message: Translate the invalid date message
 * @param  {[type]} $ [JQuery reference]
 * @return {[type]}   [description]
 */

$.widget('nh.selectorDatepicker', {
  // Default options
  // EY
  options: {
    format: 'DD/MM/YYYY',
    initYear: '1920',
    monthTranslations: monthsArray,
    invalidDateMessage: Labels.lblInvalidDate,
    underAgeMessage: 'You must be 18 and up',
    allowUnderAge: true,
    fillZeros: false, // Ey añadir 0 a enteros
    dateDefault: false // Ey, fechas por defecto 
  },

  _create: function () {
    // EY
    this.options.allowUnderAge = (this.element.data("forbide-under-age")) ? false : true;
    this.options.fillZeros = (this.element.data("fill-zeros")) ? true : false;
    this.options.dateDefault = this.element.data("date-default") ? this.element.data("date-default") : false; // Ey, fechas por defecto 
    this.daySelector = this.element.find('select.js-day-selector');
    this.monthSelector = this.element.find('select.js-month-selector');
    this.yearSelector = this.element.find('select.js-year-selector');

    //recojo los div que envuelven a los selectores (esto es por el bootstrapSelect, si se quita hay que revisarlo)
    this.daySelectorWrapper = this.element.find('div.js-day-selector');
    this.monthSelectorWrapper = this.element.find('div.js-month-selector');
    this.yearSelectorWrapper = this.element.find('div.js-year-selector');

    this.invalidDateBlock = this.element.find('.js-selector-datepicker-invalid-date');
    // Avoid multiple inits
    if (this.element.hasClass('widget-initialized')) {
      return;
    }
    // Listeners
    this._on(this.daySelector, { 'change': this._onDateChange });
    this._on(this.monthSelector, { 'change': this._onDateChange });
    this._on(this.yearSelector, { 'change': this._onDateChange });

    // Listeners
    this._on(this.daySelectorWrapper, { 'click': this._onDateTouch });
    this._on(this.monthSelectorWrapper, { 'click': this._onDateTouch });
    this._on(this.yearSelectorWrapper, { 'click': this._onDateTouch });

    // Init selectors options
    this._initDays();
    this._initYears();
    this._initMonth();
    // Sets the invalid date message
    this._initInvalidDateBlock();
    // Widget initialized
    this._addClass('widget-initialized');
  },

  /**
   * Init the day selector options
   * @return {[type]} [description]
   */
  _initDays: function () {
    for (var i = 1; i < 32; i++) {
      // EY    
      var value = this.options.fillZeros ? this._fillZero(i) : i;
      var selected = (this.options.dateDefault) ? this._dateDefault(0, value) : ""; // Ey, fechas por defecto 
      var option = '<option role="option" value="' + value + '" ' + selected + '>' + value + "</option>"; // Ey, fechas por defecto 
      this.daySelector.append(option);
    }
    // Refresh the selectpicker
    if (this.daySelector.hasClass('selectpicker')) {
      this.daySelector.selectpicker('refresh');
    }
  },

  /**
   * Init the month selector options
   * @return {[type]} [description]
   */
  _initMonth: function () {
    for (var i = 1; i < 13; i++) {
      // var value = i;
      var value = this.options.fillZeros ? this._fillZero(i) : i;
      var monthTranslation = this.options.monthTranslations[i-1];
      var selected = (this.options.dateDefault) ? this._dateDefault(1, value) : ""; // Ey, fechas por defecto 
      var option = '<option role="option" value="' + value + '" ' + selected + '>' + monthTranslation + "</option>"; // Ey, fechas por defecto 
      this.monthSelector.append(option);
    }
    // Refresh the selectpicker
    if (this.monthSelector.hasClass('selectpicker')) {
      this.monthSelector.selectpicker('refresh');
    }
  },

  /**
   * Init the year selector options
   * @return {[type]} [description]
   */
  _initYears: function () {
    var numberOfYears = new Date().getFullYear() - this.options.initYear;
    if (this.element.data("forbiden-under-age")) {
      numberOfYears = numberOfYears - 18;
    }

    for (var i = numberOfYears; i >= 0; i--) {
      var value = parseInt(this.options.initYear) + i;
      var selected = (this.options.dateDefault) ? this._dateDefault(2, value) : ""; // Ey, fechas por defecto 
      var option = '<option role="option" value="' + value + '" ' + selected + '>' + value + "</option>"; // Ey, fechas por defecto 
      this.yearSelector.append(option);
    }
    // Refresh the selectpicker
    if (this.yearSelector.hasClass('selectpicker')) {
      this.yearSelector.selectpicker('refresh');
    }
  },

  /**
   * Initialize the invalid date block
   * @return {[type]} [description]
   */
  _initInvalidDateBlock: function () {
    this._toggleInvalidDate(false);
    var invalidMessage = '<ul role="alert"><li>' + this.options.invalidDateMessage + '</li></ul>';
    this.invalidDateBlock.append(invalidMessage);
  },

  /**
   * Check if person is under 18 only when changing value in year
   * @return {Boolean}
   */

  isUnderAge: function () {

    const birthday = this.getMomentDate(),
      now = moment(),
      difference = now.diff(birthday, 'years');

    return (difference < 18) ? true : false;

  },

  /**

   * Handler when the input changes. it triggers the event when every selector has a value
   * @param  {[type]} e [description]
   * @return {[type]}   [description]
   */
  _onDateChange: function (e) {
    var formattedDate = this.getDate();
    // Trigger the change event
    this._trigger('change', e, {
      value: formattedDate
    });

    this._toggleInvalidDate(!this.checkIsValidDate());
  },

  /**
   * Check if all of birth date fields are touched (the user works with them- click, focus,...)
   * @returns if the all of birth date fields are touched
   */
  _isDateTouched: function () {
    return (this.daySelectorWrapper.data("touched") === true && this.monthSelectorWrapper.data("touched") === true && this.yearSelectorWrapper.data("touched") === true);
  },

  /**
   * Check if all of birth date fields are a value selected
   * @returns if all of birth date fields are a value selected
   */
  _isFieldsFilled: function () {
    return (!!this.daySelector.val() && !!this.monthSelector.val() && !!this.yearSelector.val());
  },

  /**
   * set the date field as touched
   */
  _onDateTouch: function (e) {
    var $selector = $(e.currentTarget);
    if (!$selector.data("touched")) {
      $selector.data("touched", true);
    }
  },

  /**
   * Returns the date selected in a momentJS object
   * @return {[type]} [description]
   */
  getMomentDate: function () {
    var dayValue = this.daySelector.val();
    var monthValue = this.monthSelector.val();
    var yearValue = this.yearSelector.val();
    return moment({ year: yearValue, month: monthValue, day: dayValue });
  },

  /**
   * Returns the formatted value of the selected date. If the selected date is invalid,
   * it returns an invalid date
   * @return {[type]} [description]
   */
  getDate: function () {
    var momentDate = this.getMomentDate();
    return momentDate.format(this.options.format);
  },

  /**
   * Sets a date on the selector datepicker. If the date is invalid, empty the selectors
   * @param  {[string]} date [Date to set]
   */
  setDate: function (date) {
    var momentDate = moment(date, this.options.format);
    if (momentDate.isValid()) {
      this.daySelector.selectpicker('val', momentDate.date());
      this.monthSelector.selectpicker('val', momentDate.month());
      this.yearSelector.selectpicker('val', momentDate.year());
    } else {
      this.daySelector.selectpicker('val', '');
      this.monthSelector.selectpicker('val', '');
      this.yearSelector.selectpicker('val', '');
    }
    // Trigger the change event
    //this.daySelector.trigger('change');
  },

  /**
   * Checks if the three inputs has a value selected
   * @return {[type]} [description]
   */
  hasValue: function () {
    var hasValue = true;
    if (!this.yearSelector.val() || !this.monthSelector.val() || !this.daySelector.val()) {
      hasValue = false;
    }
    return hasValue;
  },

  /**
   * Checks the birth date when the form is submitted
   * @returns returns if the date is valid or not
   */
  validateOnSubmit: function () {
    if (this.element.data('validate') === false) {
      return true;
    }
    this._toggleInvalidDate(!this.checkIsValidDate(true));
    return this.checkIsValidDate(true);
  },

  /**
   * Checks if the selected date is a valid date
   * @returns returns if the date is valid or not
   */
  checkIsValidDate: function (submitForm) {
    var validateDate;
    var isValid;
    var date = this.daySelector.val() + "/" + (parseInt(this.monthSelector.val()) + 1) + "/" + this.yearSelector.val();

    if (!submitForm) {
      validateDate = (this._isDateTouched() && this._isFieldsFilled());
    } else {
      validateDate = this._isFieldsFilled();
    }

    if (validateDate) {
      isValid = moment(date, 'DD/MM/YYYY').isValid();

      if (this.element.data('forbidenUnderAge') === true) {
        const isUnderAge = this.isUnderAge();

        isValid = !isUnderAge;
        if (isUnderAge) {
          this.invalidDateBlock.find('ul').html(`<li>${this.options.underAgeMessage}</li>`);
        } else {
          this.invalidDateBlock.find('ul').html(`<li>${this.options.invalidDateMessage}</li>`);
        }
      }
      return isValid;
    } else if (this._isDateTouched() && !this._isFieldsFilled()) {
      return false;
    } else if (submitForm && !this._isFieldsFilled()) {
      return false;
    } else if (!submitForm) {
      return true;
    }
  },

  /**
   * Checks if the date is past, equal or future
   * @return {[timeline]} [Returns -1 if it is past, 0 if it is today and 1 if
   * it is future]
   */
  checkTimelineDate: function () {
    var selectedDate = this.getMomentDate();
    var now = moment();
    var timeline;
    var difference = selectedDate.diff(now, 'days');
    if (difference < 0) {
      // Past date
      timeline = -1;
    } else if (difference === 0) {
      timeline = 0;
    } else if (difference > 0) {
      // Future date
      timeline = 1;
    }
    return timeline;
  },

  /**
   * Show/hide the invalid date message
   * @return {[type]} [description]
   */
  _toggleInvalidDate: function (visible) {
    if (visible) {
      this.invalidDateBlock.show();
      this._addClass('has-invalid-datepicker-error');
      this._addClass('has-error');
      this._removeClass('has-success');
    } else {
      this.invalidDateBlock.hide();
      this._removeClass('has-invalid-datepicker-error');
      this._removeClass('has-error');
      if ($(this.element).hasClass('has-error')) this._addClass('has-success');
    }
  },
  /**
  * // EY  fill zero
  * @return {[type]} [integer]
  */
  // Ey, fechas por defecto 
  _fillZero: function _fillZero(value) {
    return value > 0 && value < 10 ? "0" + value : value;
  },
  // Ey, fechas por defecto 
  _dateDefault: function _dateDefault(type, value) {
    var date = moment(this.options.dateDefault, 'DD/MM/YYYY', true);
    return (date.isValid()) ? ((this.options.dateDefault).split("/")[type] == value) ? "selected" : "" : ""
  },
  /**
   * Destroy function
   * @return {[type]} [description]
   */
  _destroy: function () {
    this._removeClass('widget-initialized');
  }
});

var headerLoginForm = (function() {
  var headerLoginFormView = $('.boxLogin');
  var loginFormMobView = $('.boxLoginMob');

  function init() {
    // JQ bootstrap config
    var jqBootstrapConfig = {
      bindEvents: ['blur','change'],
      preventSubmit: true,
      submitError: function($form, event, errors) {
        validationError($form, event, errors);
      },
      submitSuccess: function($form, event) {
		// EY, Cambiamos errors que no se utilizaba en succss
        validationSuccess($form, event);
      },
      filter: function() {
        return (!$(this).is(":visible") && $(this).hasClass('force-validation')) || $(this).is(":visible") || $(this).hasClass('force-validation')|| (!$(this).is('.no-validation')) || $(this).is('.callback_date');
      },
    };
    // INIT JQ BOOTSTRAP VALIDATION
    headerLoginFormView.find("input, textarea, select, button").not("[type=submit]").jqBootstrapValidation(jqBootstrapConfig);
    loginFormMobView.find("input, textarea, select, button").not("[type=submit]").jqBootstrapValidation(jqBootstrapConfig);
  }


  function validationError($form, event, errors) {
  	var bottonsubmit = $form.find("button[type=submit]");
  	var koModal = $form.attr("data-ko-modal");
  	bottonsubmit.prop("disabled", true);

  	if(koModal){
  		$(koModal).modal('show');
  	}
  	// Here I do nothing, but you could do something like display
  	// the error messages to the user, log, etc.
  	if ( $form.find("div.has-error:not(.js-no-scroll):visible").length > 0 ) {
  		moveToOffset = $form.find("div.has-error:not(.js-no-scroll):visible").eq(0).offset().top - 90;

  		$("html, body").animate({
  			scrollTop: moveToOffset,
  			useTranslate3d:true
  		}, 200, "linear", function() {
  			bottonsubmit.prop("disabled", false);
  		});

  	}
  }

  function validationSuccess($form, event) {
  	var okModal = $form.attr("data-ok-modal");
  	var currentModal = $form.attr("data-target-modal");
  	var okMsg = $form.attr("data-ok-msg");
  	var hideInputs = $form.attr("data-hide-inputs");

  	if(okModal){
  		if(!$form.hasClass("ready-to-submit")) {
  			event.preventDefault();
  			$(okModal).modal('show');
  			$form.addClass("ready-to-submit");
  			$(okModal).on('hidden.bs.modal', function () {
  				$form.submit();
  			});
  		}
  	}

  	if(okMsg){
  		if(!$form.hasClass("ready-to-submit")) {
  			event.preventDefault();
  			$(okMsg).removeClass('hide');
  			$(hideInputs).addClass('hide');
  			$form.addClass("ready-to-submit");
  			$(currentModal).on('hidden.bs.modal', function () {
  				$form.submit();
  			});
  		}
  	}
  }

  // PUBLIC API
  return {
    init: init
  };

})();


$(function() {
    headerLoginForm.init();
});

var GDPR = (() => {
  var gdprTogglers;
  var gdprHelpPanels;
  var gdprHelpPanelCloseBtn;
  //var gdprModalAnchorTriggers;
  //var gdprModals;

  // Constants
  var IS_ACTIVE_TOGGLER_CLASS = 'is_active';
  var IS_CLOSE_PANEL_CLASS = 'is_close';

  function init() {
    gdprTogglers = $('[data-toggle-gdpr-panel]');
    gdprHelpPanels = $('.m-panel-info-GDPR');
    gdprHelpPanelCloseBtn = gdprHelpPanels.find('.js-close-gdpr-panel');
    //gdprModalAnchorTriggers = $('[data-gdpr-modal-target]');
    //gdprModals = $('.m-modal-GDPR-more-info');
    // Listeners
    gdprTogglers.on('click', _toggleGDPRPanel);
    gdprHelpPanelCloseBtn.on('click', _handlerCloseGDPRPanel);
    
    /*gdprModals.on('shown.bs.modal', _handlerGDPRModalShown);
    gdprModals.on('show.bs.modal', _handlerGDPRModalShow);
    gdprModals.on('hidden.bs.modal', _handlerGDPRModalHide);*/

    //EY arobles: Link a página condiciones legales con ancla
    gdprPageWithAnchor();

    //EY arobles: Cambiar valor de input hidden "subscriberewards" con el flag GDPR_flag_5
    $('#GDPR_flag_5').change(function() {
      if($('#GDPR_flag_5').is(':checked')){
        $('#subscribeRewards').attr('value',true);
      }else{
        $('#subscribeRewards').attr('value',false);
      }
    });
  }

  /**
   * Show/Hide the gdpr help panel
   */
  function _toggleGDPRPanel() {
    var panelVisibility = _toggleActive(this);
    gdprHelpPanels.addClass(IS_CLOSE_PANEL_CLASS);
    _toggleHelpPanelVisibility(panelVisibility, this);
  }

  /**
   * Toggles the active class visibility
   * @param       {[object]} toggleElement [clicked element]
   * @return      {[boolean]} [Returns if there's an active element]
   */
  function _toggleActive(toggleElement) {
    var $this = $(toggleElement);
    var panelVisible = true;
    gdprTogglers.each(function(index, toggle){
      var $toggle = $(toggle);
      if(!$toggle.is($this)) {
        $toggle.removeClass(IS_ACTIVE_TOGGLER_CLASS);
      }
    });
    if($this.hasClass(IS_ACTIVE_TOGGLER_CLASS)){
      $this.removeClass(IS_ACTIVE_TOGGLER_CLASS);
      panelVisible = false;
    } else {
      $this.addClass(IS_ACTIVE_TOGGLER_CLASS);
    }
    return panelVisible;
  }

  /**
   * Toggle the help panel visibility
   * @param       {[boolean]} panelVisibility [Show/Hide the panel]
   */
  function _toggleHelpPanelVisibility(panelVisibility, toggleElement) {
    var $toggleElement = $(toggleElement);
    var helpPanelSelector = $toggleElement.data('toggle-gdpr-panel');
    var helpPanel = $(helpPanelSelector);
    if(panelVisibility) {
      helpPanel.removeClass(IS_CLOSE_PANEL_CLASS);
    } else {
      helpPanel.addClass(IS_CLOSE_PANEL_CLASS);
    }
  }

  /**
   * Click handler for closing the gdpr panel
   * @param       {[object]} e [Javascript Event]
   */
  function _handlerCloseGDPRPanel(e) {
    gdprHelpPanels.addClass(IS_CLOSE_PANEL_CLASS);
    gdprTogglers.removeClass(IS_ACTIVE_TOGGLER_CLASS);
  }

  /**
   * Handler when the GDPR modal is shown. Scroll to a selected anchor if the anchor is set
   * @param       {[object]} e [Javascript Event]
   */
  /*function _handlerGDPRModalShown(e) {
    var triggerElement = $(e.relatedTarget);
    var $modal = $(this);
    //var anchorSelector = triggerElement.data('gdpr-modal-target');
    var anchorSelector = triggerElement.data('gdpr-modal-target') || $modal.data('content-target');
    if (anchorSelector) {
      var anchorElement = $modal.find(anchorSelector);
      _scrollGDPRModal(anchorElement, $modal);
    }
  }*/

  /**
   * Scroll on GDPR Modal to a selected element
   * @param       {[object]} anchorElement [Anchor element to scroll to]
   */
  /*function _scrollGDPRModal(anchorElement, $modal) {
    //cambiado el scrollTop por animate para arreblar issue en iOS
    //$modal.scrollTop(anchorElement.offset().top);
    $modal.animate({
      scrollTop: anchorElement.offset().top,
    }, 800);
  }*/

  /*function _handlerGDPRModalShow(e) {
    var scrollWidth = getScrollBarWidth();
    if(scrollWidth > 0) {
      gdprHelpPanels.css({
        'padding-right': scrollWidth
      });
    }
  }*/

  /*function _handlerGDPRModalHide(e) {
    gdprHelpPanels.css({
      'padding-right': 0
    });
  }*/

  function getGDPRPanels() {
    return gdprHelpPanels;
  }
 //EY arobles: Funció a página condiciones legales con ancla
  function gdprPageWithAnchor(){
    
    $('.js-gdpr-anchor-page').each(function() {

      //Creamos el link con la url de la página más el ancla
      var linkHref = $(this).find('a').attr('href');
      var anchor = $(this).data('page-anchor');
      var finalLink = linkHref + '#' + anchor;

      //Remplazamos el href del a por el nuevo que incluye el ancla 
      $(this).find('a').attr('href', finalLink);
    });
  }


  // Public API
  return {
    init: init,
    getGDPRPanels: getGDPRPanels
  };
})();

$(() => {
  GDPR.init();
});

var mModals = (function() {

  const MODAL_UPDATE_CONTENT_EVENT = 'modal.update.content';
  var gdprHelpPanels;
  var $recoverPasswordModal;

  function init() {
    var modals = $('.modal');
    $recoverPasswordModal = modals.filter("#m-modal-login");

    /*
    TODO: Si se consigue cambiar el footer de V2 sutituir por esta linea
    var $externalModalsTriggers = $('[data-toggle="external-modal"]');
    */
    var $externalModalsTriggers = $('[data-toggle="external-modal"], [data-href][data-toggle="modal"]');
    //var $headerRecoverPassTrigger = $(".header-mob-v2 #drop-menu-rewards .contentBoxLogin .btn-modal-iframe");

    gdprHelpPanels = GDPR.getGDPRPanels();

    /*modals.each((index, modalView) => {
      var $modalView = $(modalView);
      attachModalEventsBehaviour($modalView);
    }).on('show.bs.modal', _handlerModalShow)
    .on('shown.bs.modal', _handlerModalShown)
    .on('hidden.bs.modal', _handlerModalHide);*/

    modals.each((index, modalView) => {
      var $modalView = $(modalView);
      attachModalEventsBehaviour($modalView);
    });


    $externalModalsTriggers.on("click", _loadExternalModal);
  }

  /**
   * @description - handle the behaviours of the app when a modal begin to be shown
   */
  function _handlerModalShow() {
    /*var scrollWidth = getScrollBarWidth();
    if(scrollWidth > 0) {
      gdprHelpPanels.css({
        'padding-right': scrollWidth
      });
    }*/
  }

   /**
   * @description - handle the behaviours of the app when a modal is shown
   */
  function _handlerModalShown() {
   /* var $modal = $(this);
    var anchorSelector = $modal.data('scrollto');
    var anchorElement;
    if (anchorSelector) {
      anchorElement = $modal.find(anchorSelector);
      _scrollToModalElement(anchorElement, $modal);
    }*/
  }

   /**
   * @description - handle the behaviours of the app when a modal is closed
   */
  function _handlerModalHide() {
    /*gdprHelpPanels.css({
      'padding-right': 0
    });*/
  }

  /**
   * Scroll on Modal to a selected element
   * @param {object} anchorElement - Anchor element to scroll to
   * @param {object} $modal        - modal opened
   */
  function _scrollToModalElement(anchorElement, $modal) {
    var modalOffsetTop;
    var targetOffsetTop;
    if(anchorElement.length) {
      modalOffsetTop = $modal.offset().top;
      targetOffsetTop = anchorElement.offset().top;
      $modal.animate({
        scrollTop: (targetOffsetTop - modalOffsetTop)
      });
    }
  }

  /**
   * @description - load a external modal. Set its config, get its content...
   * @param {object} ev - object with the event paramentes
   */
  function _loadExternalModal(ev) {
    var $modalTrigger = $(this); //elemento que va a lanzar la apertura de la modal.
    var modalContentPath = $modalTrigger.data('href'); //ruta del fichero html que se va a cargar dentro del elemento .modal-content de la modal
    var modalTargetId = $modalTrigger.data('target'); //id de la modal que se va a mostrar
    var modalScrollTo = $modalTrigger.data('modal-scrollto');//elemento del cuerpo de la modal al que se hace scroll
    var $modal; //modal que se va a abrir.
    var $modalContent;// elemento .modal-content de la modal

    /*
    TODO: Si se consigue cambiar el footer de V2 se puede eliminar el stropPropagation
    */
    ev.preventDefault();
    ev.stopPropagation();

    //si no tenemos id de la modal a abrir, no hacemos nada.
    if(!modalTargetId) {
      return;
    }

    $modal = $(modalTargetId);
    $modalContent = $modal.find('.modal-content');
    
    //si tenemos un path de un archivo a cargar como contenido de la modal la abrimos.
    if(modalContentPath) {
      $modal.data("scrollto", modalScrollTo);
      $modalContent.html("").load(modalContentPath, () => {
        $modal.modal('show');
      });
    }
  }

  /**
   * @description - attache events for before show modal, show modal and hide modal to each modal to add behaviours to app
   * @param {object} $modal - jquery modal object
   */
  function attachModalEventsBehaviour($modal) {
    var eventData = {
      windowScroll: null
    };
    //hacemos el off por si hay mas de un botón que abra una modal y evitar que se lance varias veces el evento
    $modal.on('show.bs.modal', eventData, _handleShowModal)
    .on("shown.bs.modal", _handleShownModal)
    .on(MODAL_UPDATE_CONTENT_EVENT, _setModalPosition)
    .on("hidden.bs.modal", eventData, _handleHiddenModal);
  }

  function handleDinamicModals($modals) {
    $modals.each(function() {
      var $this = $(this);
      var $modal =  $($this.data("target"));
      attachModalEventsBehaviour($modal);
    });
  }


  /**
  * @description - Avoid show the modal content, config the modal body to avoid page scroll in iOs when the modal is shown, and give padding-right to gdpr panels equal to scroll bar
  * @param {object} ev - Objeto con el evento lanzado.
  */
  function _handleShowModal(ev) {
    var $this = $(this);
    var $modalContent = $this.find(".modal-content");
    var scrollWidth = getScrollBarWidth();

    ev.data.windowScroll = $(window).scrollTop();
    //TODO: buscar solucion para todas las modales para quitar eso de modal de login
    //aÃ±adir clase dinamicamente a capas de challenge del capcha y forzar position fixed.

    if($this.attr("id") !== "m-modal-login") {
    $("body").css({
        "position": "fixed",
        "margin-top": (ev.data.windowScroll * -1)
    });
    $modalContent.parent(".modal-dialog").addClass("prevent-show");
    }

    if(scrollWidth > 0 && gdprHelpPanels) {
      gdprHelpPanels.css({
        'padding-right': scrollWidth
      });
    }
  }

  /**
   * @description set the modal position and scroll to a specific elemento into modal body
   */
  function _handleShownModal() {
    var $modal = $(this);
    var anchorSelector = $modal.data('scrollto');
    var anchorElement;

    _setModalPosition($modal);
    if (anchorSelector) {
      anchorElement = $modal.find(anchorSelector);
      _scrollToModalElement(anchorElement, $modal);
    }
    if($modal.attr("id") === "modal-iframe") {
      var $modalIframe = $modal.find("iframe");
      $modalIframe.css({
        "width": "100%",
        "height": $modalIframe.contents().height() + "px"
      });
    }
  }

 /**
  * @description set the position of the modal (centered in the page or 20px below the top of the page)
  */
 function _setModalPosition($modal) {
    var $this = ($modal.length) ? $modal : $(this);
    var $modalContent = $this.find(".modal-content");
    var $modalContentParent = $modalContent.parent(".modal-dialog");

    setTimeout(function() {
      if($modalContent.outerHeight() < globalConfig.windowHeight) {
        $modalContentParent.addClass("center-modal");
      } else {
        $modalContentParent.removeClass("center-modal");
      }
      $modalContentParent.removeClass("prevent-show");
    },100);
  }

  /**
  * @description - config the modal body to show correctly when the modal is closed and remove the padding right of the gdpr panels
  * @param {object} ev - Objeto con el evento lanzado.
  */
  function _handleHiddenModal(ev) {
    var $this = $(this);
    var position = "static";
    //if($this.attr("id") !== "m-modal-login") {
      if($("body").hasClass("right") || $("body").hasClass("left")) { 
        position = "relative";
      }
    $("body").css({
        "position": position,
      "margin-top": 0,
    });
    $(window).scrollTop(ev.data.windowScroll);
    //}

    gdprHelpPanels.css({
      'padding-right': 0
    });
  }

  // Public API
  return {
    init: init,
    attachModalEventsBehaviour: attachModalEventsBehaviour,
    handleDinamicModals:handleDinamicModals,
    MODAL_UPDATE_CONTENT_EVENT: MODAL_UPDATE_CONTENT_EVENT
  };
})();

$(function() {
  if(globalConfig.elements.$openModal.length) {
    mModals.init();
  }
});




var collapsePanel = (() => {
  var collapsePanelModule;
  var collapseLink;

  function init() {
    collapsePanelModule = $('.js-collapse-panel');
    collapseLink = collapsePanelModule.find('.panel-heading');
    collapsePanelModule.on('show.bs.collapse', _onExpandPanel);
    collapsePanelModule.on('hide.bs.collapse', _onCollapsePanel);
  }

  function _onExpandPanel() {
    var $this = $(this);
    var toggleElement = $this.find('a[data-toggle="collapse"]');
    var openText = toggleElement.data('open-header-text');
    if(openText && openText.length > 0) {
      toggleElement.html(openText);
    }
  }

  function _onCollapsePanel() {
    var $this = $(this);
    var toggleElement = $this.find('a[data-toggle="collapse"]');
    var closeText = toggleElement.data('closed-header-text');
    if(closeText && closeText.length > 0) {
      toggleElement.html(closeText);
    }
  }

  return {
    init: init
  }
})();

$(() => {
  collapsePanel.init();
});

$.widget('nh.floorSelector', {
  options: {
    hotelInfo: {},
    floorTranslation:  (typeof pageData !== 'undefined') ? pageData.labelFloor : '',
    buildingLabel: (typeof pageData !== 'undefined') ? pageData.labelBuilding + ' ' : ''
  },

  // Selected floor
  selectedFloor: {},

  /**
   * Create Function
   * @return {[type]} [description]
   */
  _create: function() {
    this.floorList = this.element.find('.m-floor-selector-list');
    this.selectedFloorDescription = this.element.find('.js-selected-floor');
    this.selectedBuildingDescription = this.element.find('.js-selected-building');
    this.selectedFloorAvailableRooms = this.element.find('.js-selected-floor-available-rooms');
    this.selectedFloorUpsellingRooms = this.element.find('.js-selected-floor-upselling-rooms');
    this._renderFloorList();

    //listeners
    this._on(this.element.find('.dropdown'),  {
      'shown.bs.dropdown': this._onDropdownShown
    });
  },

  /**
   * Render the floor list elements
   * @return {[type]} [description]
   */
  _renderFloorList: function() {
    var hotelInfo = this.options.hotelInfo;
    var buildings = hotelInfo.buildings;
    if (!buildings || buildings.length === 0) {
      return;
    }
    // Buildings for loop
    buildings.forEach((buildingInfo) => {
      let buildName=(isNaN(parseInt(buildingInfo.name))) ? buildingInfo.name : parseInt(buildingInfo.name);

      this.floorList.append(this._renderLineSeparator(this.options.buildingLabel + buildName ));
      var buildingFloors = buildingInfo.floors.sort(this._sortByFloor);
      buildingFloors.forEach((floorInfo) => {
        this.floorList.append(this._renderFloorLine(floorInfo, this.options.buildingLabel + buildName, buildingInfo.name));
        // Default selected
        if(floorInfo.selected) {
          this.setSelectedFloor(floorInfo, buildName, buildingFloors);
        }
      });
    });
    // Listeners
    this._addFloorLineListeners();
  },

  /**
   * HTML to render a building separator on the list
   * @param  {[string]} separatorText [Building ID/name]
   */
  _renderLineSeparator: function(separatorText) {
    return (`
      <li class="floor-selector-separator">
        <span>${separatorText}</span>
      </li>
    `);
  },

  /**
   * HTML to render a floor line
   * @param  {[object]} floorInfo [Information of the floor to render]
   * @param  {[string]} building [Building ID/Name]
   */

  ///////////////////////////
  // EY CAMBIO
  // LINEA - 84
  _renderFloorLine: function(floorInfo, building, buildingName) {

    let floorInfoIdFloor=(isNaN(parseInt(floorInfo.idFloor))) ? floorInfo.idFloor : parseInt(floorInfo.idFloor);
    // Use an id with floor-building to know which has been selected
    return (`
      <li class="floor-selector-item" id="#${floorInfo.idFloor}-${building}" data-id="#${floorInfo.idFloor}-${buildingName}">
        <div class="floor-selector-item-text">
          <span>${this.options.floorTranslation} ${floorInfoIdFloor}</span>
        </div>
        <div class="floor-selector-item-rooms">
        ${floorInfo.upsellings !== null && floorInfo.upsellings > 0? 
          `<div class="floor-room room-upselling">
          <div class="room-content"><span>${floorInfo.upsellings}</span></div>
          </div>` 
      : ''}
          <div class="floor-room room-available">
            <div class="room-content"><span>${floorInfo.rooms}</span></div>
          </div>
        </div>
      </li>
    `);
  },

  _addFloorLineListeners: function() {
    // Listeners
    this._on(this.floorList.find('.floor-selector-item'), {'click': this._onFloorClick});
  },

  /**
   * Sorting fn for a building.
   * @return {[type]} [description]
   */
  _sortByFloor : function(a,b) {
    if (a.idFloor < b.idFloor)
      return 1;
    if (a.idFloor > b.idFloor)
     return -1;
    return 0;
  },

  /**
   * Trigger the render again when the floor list is updated
   * @param  {[type]} key   [description]
   * @param  {[type]} value [description]
   */
  _setOption: function(key, value) {
    this._super(key,value);
    if (key === 'hotelInfo') {
      this.floorList.empty();
      this._renderFloorList();
    }
  },

  /**
   * Click handler selecting a floor of the list
   * @param  {[object]} e [JS event]
   */
  _onFloorClick: function(e) {
    var $selectedFloorId = $(e.currentTarget).attr('data-id');
    //var floorNumber = $selectedFloorId.slice(1, $selectedFloorId.indexOf('-'));
    var floorNumber = this._getFloorNumber($selectedFloorId);
    var split =  $selectedFloorId.split("-")
    var buildingName = split[split.length -1]
    var buildingFloors;
    var selectedFloorInfo;
    this.options.hotelInfo.buildings.some((buildingInfo) => {
      if(buildingInfo.name == buildingName) {
        buildingFloors = buildingInfo;
      }
    });
    buildingFloors.floors.some((info) => {
      if (info.idFloor == floorNumber) {
        selectedFloorInfo = info;
      }
    });
    this.setSelectedFloor(selectedFloorInfo, buildingName, buildingFloors);
  },

  _getFloorNumber: function(id) {
    // EY, cambio funcion planta
    var floorId = id.slice(1, id.length); //eliminamos el #;
    //var regex = (floorId.slice(0,1) === "-") ? /^[(-\d\d)]{2}/g : /[/[\d\d]{1}/g;
    if((floorId.slice(0,1) === "-")){
      floorId = floorId.slice(1, floorId.length);
      floor=floorId.split("-");
      return "-"+floor[0];
    }else{
      floor=floorId.split("-");
      return floor[0];
    }

    //return floorId.match(regex)[0];
  },

  /**
   * Sets the selected floor taking the info from the object past as a parameter
   * @param  {[object]} selectedFloorInfo [Selected floor information]
   * @param  {[object]} buildingDescription [Building ID/Name]
   * @param  {[object]} buildingFloors [Floors of the building]
   */
  setSelectedFloor: function(selectedFloorInfo, buildingDescription, buildingFloors) {
    if (!selectedFloorInfo) {
      return;
    }


    let selectedFloorInfoIdFloor=(isNaN(parseInt(selectedFloorInfo.idFloor))) ? selectedFloorInfo.idFloor : parseInt(selectedFloorInfo.idFloor);
    
    this.selectedFloorDescription.html(`${this.options.floorTranslation} ${selectedFloorInfoIdFloor}`);

    let buildingDescriptiontext=(isNaN(parseInt(buildingDescription))) ? buildingDescription : parseInt(buildingDescription);

    this.selectedBuildingDescription.html(this.options.buildingLabel + buildingDescriptiontext );
    this.selectedFloorAvailableRooms.html(selectedFloorInfo.rooms ? selectedFloorInfo.rooms : 0);
    // ey  
    if(selectedFloorInfo.upsellings && selectedFloorInfo.upsellings > 0){
      this.selectedFloorUpsellingRooms.html(selectedFloorInfo.upsellings ? selectedFloorInfo.upsellings : 0);
    }else{
      $(this.selectedFloorUpsellingRooms).parent().parent().hide();
    }
    //room-content
    
    // Set selected floor object
    this.selectedFloor = {
      selectedFloorInfo,
      buildingDescription,
      buildingFloors
    };
    // Trigger the change event
    this._trigger('change', {}, this.selectedFloor);
  },

  /**
   * Sets the height to the floor ul list
   * @param  {[number]} height [Height to set]
   */
  setFloorListHeight: function(height) {
    this.floorList.css('max-height', height);
  },

  /**
   * Callback when the dropdown list is shown
   * @param  {[type]} e [description]
   * @return {[type]}   [description]
   */
  _onDropdownShown: function(e) {
    this.floorList.focus();
  },

  /**
   * Destroy function
   * @return {[type]} [description]
   */
  _destroy: function() {

  }
});

(function () {
  $.widget('nh.autocompleteGroup', {
    options: {
      timeout: 300,
      timer: null
    },
    types: {
      '0': 'nearme',
      '1': 'destination',
      '2': 'airport',
      '3': 'poi',
      '4': 'hotel'
    },
    results: {
      nearme: {
        label: [Labels.autocompleteResultsHotel, Labels.autocompleteResultsHotels],
        html: "",
        items: [],
        count: 0,
        iconClass: 'nh-ic-compass'
      },
      destination: {
        label: [Labels.autocompleteResultsHotel, Labels.autocompleteResultsHotels],
        html: "",
        items: [],
        count: 0,
        iconClass: 'nh-ic-building'
      },
      hotel: {
        label: [Labels.autocompleteResultsHotel, Labels.autocompleteResultsHotels],
        html: "",
        items: [],
        count: 0,
        iconClass: 'nh-ic-hotel'
      },
      airport: {
        label: [Labels.autocompleteResultsHotel, Labels.autocompleteResultsHotels],
        html: "",
        items: [],
        count: 0,
        iconClass: 'nh-ic-airport'
      },
      poi: {
        label: [Labels.autocompleteResultsHotel, Labels.autocompleteResultsHotels],
        html: "",
        items: [],
        count: 0,
        iconClass: 'nh-ic-position'
      },
    },
    isMobile: null, // Almacena si estamos en mobile (ni desktop ni tablet),
    emptyResult: {
      "df": "",
      "code": "",
      "CountryName": "",
      "locality": "",
      "City": "",
      "url": "",
      "Name": Labels.autocompleteNearme,
      "Type": 0,
      "vh": "",
      "ebp": false,
      "num_hotels": "",
      "typeSearch": "",
      "tcm": ""
    },

    _create: function () {
      let widget = this;
      this.config = {
        sourceFile: null,
        $resultsElement: null,
        showPoisResults: true,
        minTexSearchLength: (typeof Globals.autocompleteParam !== "undefined") ? Globals.autocompleteParam : 3,
        $hiddenFields: null,
        $parentForm: null,
        initialValue: null,
        labels: {
          destination: Labels.autocompleteCities,
          hotel: Labels.autocompleteHotels,
          noMatches: Labels.autocompleteNoMatches,
          airport: Labels.autocompleteAirports,
          poi: Labels.autocompletePois,
          results: [Labels.autocompleteResult, Labels.autocompleteResults],
          serverProblem: Labels.autocompleteServerProblem
        }
      };

      this._setWidgetConfig(widget);

      if (this.config.isPromoForm && this.config.formActionData) {
        this.config.$parentForm.attr("action", this.config.formActionData.current);
      }

      if (this.config.initialValue) {
        this.element.data("selected", this.emptyResult);
      }

      // Listeners
      this._on(this.element, {
        'keyup': this._eventKeyup
      });

      this._on(this.element, {
        'focusin': this._onInputFocus
      });

      this._on(this.config.$resultsElement, {
        'click li': this._onResultsItemClick
      });

      this._on(document, {
        'mouseup': this._onDocumentMouseup
      });

      this._on(this.element.closest('.location').find('.js-input-clear'), {
        'click': function () {
          this.config.$resultsElement.hide();
          this.element.data('selected', this.emptyResult);
        }
      });

      this.element.data("selected", this.emptyResult);

      this.config.$resultsElement.hide();

      // Controlar si estamos en mobile
      this._setMobile();
      $(window).resize(function () { widget._setMobile(); });
    },


    /**
     * @description Comprobar a trav�s de un atributo que estamos en mobile
     */
    _setMobile: function () {
      (window.matchMedia('(max-width: 767px)').matches)
        ? this.isMobile = true
        : this.isMobile = false;
    },


    /**
     * @description Posiciona el desplegable arriba o abajo del input disparador
     */
    _positionResults: function () {

      // Solo posicionar cuando est� en barra buscadora y no sea mobile
      let searchBar = $(this.element).closest('.m-search-bar');
      (searchBar.length && !this.isMobile)
        ? dropdownPosition($(this.element), this.config.$resultsElement, 20)
        : $(this.config.$resultsElement).removeAttr('style');

      // Quitar alerta lenguaje
      let alertLanguage = $('.m-language-edition');
      if (searchBar.length && alertLanguage.length) $(alertLanguage).hide();
    },

    _onDocumentMouseup: function (e) {
      if (!this.config.$resultsElement.is(e.target) && this.config.$resultsElement.has(e.target).length === 0) {
        this.config.$resultsElement.hide();
      }
    },

    // Si el valor es close to me, quitarlo al hacer focus
    _onInputFocus: function (e) {
      if (this.config.$resultsElement.find(`[data-type='nearme']`).data('value') === this.element.val()) {
        this.config.$resultsElement.hide();
        this.element.val('');
        this.element.data('selected', this.emptyResult);
      }
    },

    _onResultsItemClick: function (e) {
      var widget = this;
      var $this = $(e.currentTarget);
      var eleIndex = $this.data("index");
      var eleType = $this.data("type");
      var eleGroupType = $this.data("group-type");
      var item = this.results[eleGroupType].items[eleIndex];
      var target;
      var inputs = this.config.$hiddenFields.filter("[data-target]");
      var $searchType = $("[data-id='tipoBuscador']");

      var value = $this.data("value").replace(/\b(NH Collection |NH )\b/g, "");
      this.element.val(value).data({
        "selected": item,
        "search": value
      });
      sessionStorage.setItem("listSearch", JSON.stringify(item));


      // Scroll hasta input si se oculta al elegir una opci�n (s�lo en barra buscadora)
      if (this.element.closest('.m-search-bar').length) {
        let inputOffset = $(this.element).offset().top;
        if (window.scrollY > inputOffset) {
          $('html, body').animate({ scrollTop: inputOffset - 10 }, 200);
        }
      }


      $.each(inputs, function () {
        var $this = $(this);
        var inputId = $this.attr("id") || $this.data("id");
        target = $this.data("target");
        value = (target) ? item[target] : null;

        if (inputId === "locationLcv") {
          $this.val(`${(value && eleType === "destination") ? value : (value) ? "true" : "false"}`);
        } else if (inputId === "name") {
          value = utils.decodeHtmlEntities(value);
          $this.val(`${(value) ? value : ''}`);
        } else {
          $this.val(`${(value) ? value : ''}`);
        }

        if ($searchType.length > 0 && inputId === "code") {
          if (eleType === "destination" || eleType === "hotel" || eleType === "poi") {
            $this.attr("name", `${eleType}Id`);
          } else if (eleType === "nearme") {
            $this.attr("name", "nearMe");
          } else {
            $this.removeAttr("name");
          }

          if (eleType === "destination") {
            if (widget.config.isPromoForm && widget.config.formActionData) {
              widget.config.$parentForm.attr("action", widget.config.formActionData.promodestino);
            }
          }
        }

        if (inputId === "locationCode" || inputId === "locationCodeMobile") {
          $this.attr("name", "");
          if (eleType === "destination" || eleType === "hotel" || eleType === "poi") {
            $this.attr("name", `${eleType}Id`);
          }
        }
      });

      this.config.$resultsElement.hide();
    },

    _resetData: function () {
      this.config.$resultsElement.empty();
      $.each(this.results, (key, value) => {
        value.html = "";
        value.items = [];
        value.count = 0;
      });
    },
    _eventKeyup: function _eventKeyup(e) {
      var query = this.element.val();
      clearTimeout(this.options.timer);
      this.options.timer = setTimeout(() => {
        if (query.length >= this.config.minTexSearchLength) {
          this._getData();
        } else if (query.length === 0) {
          this.config.$resultsElement.hide();
          this.element.data('selected', this.emptyResult);
          this.element.val('');
        }

        // Fake a quitar para mostrar distintos resultados
        /*if (query === 'mad') {
          this._getData();

        } else if (query === 'notfound') {
          this._resetData();
          this._buildSimpleResults(this.config.labels.noMatches);
          this.config.$resultsElement.show();

        } else if (query === 'server') {
          this._resetData();
          this._buildSimpleResults(this.config.labels.serverProblem);
          this.config.$resultsElement.show();

        } else if (query.length === 0) {
          this.config.$resultsElement.hide();
          this.element.data('selected', this.emptyResult);
        }*/
      }, this.options.timeout);
    },
    _getData: function () {
      var query = this.element.val();
      var language = typeof Globals.lang != "undefined" && Globals.lang != "" ? Globals.lang : "en";
      var widget = this;
      var promise;
      var url = `${widget.config.sourceFile}${query}`;
      var ajaxConfig = {
        type: "GET",
        url: url,
        async: true,
        dataType: "json",
        crossDomain: true,
        cache: true
      };

      if (this.config.dataObj) {
        ajaxConfig.type = "POST";
        //@EY arobles: configurar url
        ajaxConfig.url = widget.config.sourceFile;
        ajaxConfig.data = {
          idioma: language,
          //@EY arobles: Pasamos el JSON a cadena
          json: JSON.stringify(this.config.dataObj),
          term: query
        };
      }

      this._resetData();
      if (query.length >= this.config.minTexSearchLength) {
        promise = $.ajax(ajaxConfig);
        promise.then(function (response) {
          widget._getFilteredResults(response[0]);
        }, function () {
          widget._buildSimpleResults(widget.config.labels.serverProblem);

        }).always(function () {
          widget.config.$resultsElement.show();

          // Posicionar desplegable si se encuentra en la barra buscadora
          widget._positionResults();
        });
      }
    },

    _getFilteredResults: function (response) {
      var widget = this;
      var type;
      response.push(this.emptyResult); //a�adimos la opci�n vacia para close to me
      if (response.length > 0) {
        $.each(response, (index, value) => {
          type = widget.types[value.Type];
          widget.results[type].items.push(value);
          widget.results[type].count++;
        });

        if (!widget.config.showPoisResults) {
          delete widget.results.poi;
        }

        this._buildResults();
      } else {
        this._buildSimpleResults(widget.config.labels.noMatches);
      }

      this.config.$resultsElement.show();

      // Posicionar desplegable si se encuentra en la barra buscadora
      this._positionResults();
    },

    _buildSimpleResults: function (msg) {

      // Si se han reseteado los datos o no han tomado valor
      if (!this.results['nearme'].items.length)
        this.results['nearme'].items.push(this.emptyResult);

      // html de close to me y el mensaje oportuno de error (server o not match)
      var html = `<div class="autocomplete-results-group nearme">
                      <ul class="autocomplete-results-list">
                      <li data-value="${Labels.autocompleteNearme}" data-type="nearme" data-index="0">
                        <span class="result-icon nh-ic-compass"></span>
                        <span class="result-name">${Labels.autocompleteNearme}</span>
                      </li>
                      </ul>
                  </div>

                  <div class="autocomplete-results-group">
                    <ul class="autocomplete-results-list">
                      <li>${msg}</li>
                    </ul>
                  </div>`;

      // Agregar html al dom de la lista de resultados
      this.config.$resultsElement.append(html);
    },

    _buildResults: function () {
      var widget = this;
      $.each(this.results, (key, value) => {
        widget._buildResultsGroups(key, value);
        widget.config.$resultsElement.append(value.html);
      });
    },

    _buildResultsGroups: function (name, results) {
      var widget = this;
      var html = "";
      var data = null;
      if (results.items.length > 0) {
        /*results.html += `<div class="autocomplete-results-group ${name}">
                        <p>${this.config.labels[name]} (${results.count} ${this.config.labels.results})</p>
                          <ul class="autocomplete-results-list">`;*/

        results.html += `<div class="autocomplete-results-group ${name}">`;
        if (name !== "nearme") {
          results.html += `<p>${this.config.labels[name]} (${results.count} ${(results.count > 1) ? this.config.labels.results[1] : this.config.labels.results[0]})</p>`;
        }
        results.html += `<ul class="autocomplete-results-list">`;

        $.each(results.items, (index, value) => {
          data = {
            results: results,
            item: value,
            index: index
          };
          html += widget._getResultsItem(data);
        });

        results.html += `${html}</ul></div>`;
      }

    },

    _getResultsItem: function (data) {
      let numHotels = (data.item.typeSearch && data.item.typeSearch !== 'hotel') ? `<span>${data.item.num_hotels} ${(data.item.num_hotels > 1) ? data.results.label[1] : data.results.label[0]}</span>` : '';
      let locality = data.item.locality.replace(data.item.Name + ",", "");
      let finalValue = (data.item.typeSearch === 'destination') ? `${locality}` : `${data.item.Name}, ${locality}`;
      return `<li data-value="${finalValue}" data-type="${(data.item.typeSearch) ? data.item.typeSearch : 'nearme'}" data-group-type="${this._getItemGroupType(data.item)}" data-index="${data.index}"><span class="result-icon ${data.results.iconClass}"></span><span class="result-name">${data.item.Name}, ${locality}</span>${numHotels}</li>`;
    },

    _getItemGroupType(item) {
      var type = "nearme";
      if (item.typeSearch) {
        type = (item.Type === 2) ? "airport" : item.typeSearch;
      }
      return type;
    },

    _setWidgetConfig: function (widget) {
      this.config.hotelLabels = this.element.data("hotel-label");
      this.config.sourceFile = this.element.data("source");
      this.config.dataObj = this.element.data("obj");
      this.config.$resultsElement = this.element.siblings(".autocomplete-results");
      this.config.showPoisResults = (this.element.data("poi")) ? this.element.data("poi") : true;
      this.config.filteredItems = this.config.$resultsElement.find('li');
      this.config.$parentForm = this.element.parents("form");
      this.config.isPromoForm = this.config.$parentForm.hasClass("js-promo-form");
      this.config.formActionData = this.config.$parentForm.data("action");
      this.config.$hiddenFields = this.config.$parentForm.find('input[type="hidden"]');
      this.config.initialValue = this.element.data("initial-value");
    },



    _destroy: function () {

    }
  });
})();
$.widget('nh.calendarBooking', {
  // Default options. this options can be configured by js when the widget is created
  // can be configured by data attributes if it exits in this.element
  options: {
    classes: {},
    bookingModal: null,
    elements: {
      $triggerContainer: null,
      $dropdown: null,
      $monthsContainer: null,
      $allDays: null,
      $days: null,
      $provRangeSelected: null,
      $rangeSelected: null,
    },
    // datas para configurar rango maximo y minimo
    maxNights: 15,
    minNights: 1,
    // datas para configurar primera fecha valida, ultima fecha valida y primer día de la semana valido
    firstValidDate: null,
    lastValidDate: null,
    firstWeeklyDay: null,
    // datas de traducciones de meses y días
    translateMonths: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
    translateDays: ["Monday", "Tuesday", "Wednesday", "Thusday", "Friday", "Saturday", "Sunday"],
    // Datas de fechas
    checkinDate: null,
    checkoutDate: null,
    // Datas de mensaje informativos
    msgCheckin: "Choose checkin date",
    msgCheckout: "Choose checkout date",
    msgNovalid: "Invalid dates",
    msgNight: "Selected night",
    msgNights: "Selected nights",
    msgMaxmonths: "Sorry, you cannot book more than 18 months in advance",
    validDates: {
      first: null,
      last: null
    }
  },

  //global config for all instances of the widget
  config: {
    monthsNames: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
    daysNames: ["Monday", "Tuesday", "Wednesday", "Thusday", "Friday", "Saturday", "Sunday"],
    monthsToShow: 18,
    blackOuts: {
      data: (typeof dateString !== "undefined") ? dateString : "", //variable global con las fechas blackouts "2018-6-7*2018-6-15*2018-7-23";
      get stringList() {
        var list = [];
        if (this.data) {
          return this.data.split("*");
        }
        return list;
      },
      get dateList() {
        var list = [];
        var date;
        if (this.stringList) {
          for (var x = 0; x < this.stringList.length; x++) {
            date = this.stringList[x].split("-");
            list.push(moment({ year: parseInt(date[0]), month: (parseInt(date[1]) - 1), day: parseInt(date[2]) }));
          }
        }
        return list;
      }
    },
    startDay: 1
  },
  created: false, // flag to get if the plugin is create or not to avoid create again.
  selectedDate: {
    checkin: {
      date: null,
      day: null,
      month: null,
      year: null,
      setDate: function (date) {
        this.date = date;
        this.day = date.getDate();
        this.month = date.getMonth();
        this.year = date.getFullYear();
      },
      initDate: function () {
        this.date = null;
        this.day = null;
        this.month = null;
        this.year = null;
      }
    },
    checkout: {
      date: null,
      day: null,
      month: null,
      year: null,
      setDate: function (date) {
        this.date = date;
        this.day = date.getDate();
        this.month = date.getMonth();
        this.year = date.getFullYear();
      },
      initDate: function () {
        this.date = null;
        this.day = null;
        this.month = null;
        this.year = null;
      }
    }
  },
  currentDate: {
    date: new Date(new Date().setHours(0, 0, 0, 0)),
    get day() {
      return this.date.getDate(); //número de dia 21, 13,...
    },
    get month() {
      return this.date.getMonth(); //numero de mes (-1) 4 = mayo
    },
    get year() {
      return this.date.getFullYear(); //numero de año 2019
    }
  },
  action: "checkin",
  initialDayIndex: null, // Día inicial de selección
  isMobile: null, // Almacena si estamos en mobile (ni desktop ni tablet)
  msgInfo: null, // Almacena el mensaje a pintar en el div de mensajes informativos

  _create: function () {
    const calendar = this;

    // Obtenemos la configuracion externa a traves de atributos data y la guardamos en this.config
    //this._getExternalConfig();

    this._setCustomOptions();

    //si hay inicio valio o fin valido generamos estas fechas como objeto fecha
    if (this.options.firstValidDate || this.options.lastValidDate) {
      if (this.options.firstValidDate && !this.options.lastValidDate) this._setInitiallastValidDate();
      this._setValidDates();
    }

    this._setInitialDates();

    // Almacenar en atributos de elementos
    this.options.elements.$dropdown = this.element.find('.js-calendar-booking-dropdown');
    this.options.elements.$triggerContainer = this.element.find('.js-calendar-booking-input');
    this.options.elements.$dropdown = this.element.find('.js-calendar-booking-dropdown');
    this.options.elements.$monthsContainer = this.element.find('.calendar-booking-months');
    this.options.elements.$selectedDateHeader = {
      $container: this.element.find('.calendar-booking-header'),
      get $checkin() {
        return this.$container.find('.calendar-booking-checkin');
      },
      get $checkout() {
        return this.$container.find('.calendar-booking-checkout');
      }
    };


    // Creamos la cabecera estática para el fake modal
    this._createWeekDaysHeader();

    // Creamos los meses
    this._createMonths();

    // Almacenamos el número de días en el atributo inicial y activamos escuchador
    this.options.elements.$allDays = this.element.find(".day");
    this.options.elements.$days = this.element.find(".day").not(".empty");

    this._on(this.options.elements.$days, {
      "click": this._onClickInDay
    });

    // Setear y seleccionar días iniciales si están definidas
    let infoDropdown = $(this.options.elements.$dropdown).find('.calendar-booking-info');
    if (this.options.checkinDate && this.options.checkoutDate) {
      let rangeDate = moment(this.options.checkoutDate).diff(moment(this.options.checkinDate), 'days');
      let msg = null;
      let firstDate;
      let lastDate;

      // si el día del checkin es anterior al dia actual recalculamos las fechas iniciales
      if (moment(this.options.checkinDate).isBefore(this.currentDate.date)) {
        this.options.checkinDate = this.currentDate.date;
        this.options.checkoutDate = moment(this.options.checkinDate).add(rangeDate, 'days');
      }

      if (this.options.firstValidDate) {
        firstDate = (moment(this.options.checkinDate).isBefore(this.options.validDates.first.date)) ? this.options.validDates.first.date : this.options.checkinDate;
        lastDate = moment(firstDate).add(rangeDate, 'days');
        this._selectDate(firstDate);
        this._selectDate(lastDate);
      } else {
        this._selectDate(this.options.checkinDate);
        this._selectDate(this.options.checkoutDate);
      }

      //this._selectDate (this.config.checkinDate);
      //this._selectDate (this.config.checkoutDate);
      $(this.options.elements.$triggerContainer).find('.form-group').addClass('is-active');
      $(this.options.elements.$dropdown).find('.js-calendar-booking-button').prop('disabled', false);

      // Rellenar mensaje informativo
      msg = (rangeDate < 2) ? this.options.msgNight : this.options.msgNights;
      $(infoDropdown).html(`${rangeDate} ${msg}`);
      this.msgInfo = `${rangeDate} ${msg}`;

    } else {
      $(infoDropdown).html(this.options.msgCheckin);
      this.msgInfo = this.options.msgCheckin;
    }


    // Controlar que esté en mobile
    this._setMobile();

    $(window).on("resize", function () {
      calendar._setMobile();
      calendar._mobileBottom();

      // Posición del dropdown
      (!calendar.isMobile)
        ? dropdownPosition(calendar.element.find('.js-calendar-booking-input'), calendar.options.elements.$dropdown, 20)
        : $(calendar.options.elements.$dropdown).css('top', '0');

      // Controlar navegación de flechas cuando se redimensiona
      if (!calendar.isMobile) {
        calendar._arrowNavigation();

      } else {
        let monthsHidden = calendar.options.elements.$monthsContainer.find('.calendar-booking-month.is-hidden');
        if (monthsHidden.length > 0) $(monthsHidden).removeClass('is-hidden');
      }
    });


    // Desplegar/plegar dropdown
    $(this.options.elements.$triggerContainer)
      .add(this.element.find('.js-calendar-booking-input input'))
      .on('click', function (e) {
        let isOpen = $(calendar.options.elements.$dropdown).hasClass('is-open');
        let alertLanguage = $('.m-language-edition');
        let targetElement = $(calendar.options.elements.$dropdown)[0].querySelector('.calendar-booking-months');

        // Ocultar todos los dropdowns y mostrar el que nos interesa
        $('.js-calendar-booking-dropdown').removeClass('is-open');
        if (!isOpen) {
          $(calendar.options.elements.$dropdown).addClass('is-open');

          // Cerrar alerta de lenguaje
          if (alertLanguage.length) $(alertLanguage).hide();
          if (calendar.isMobile) {
            // remove cursor in the background when modal opens [iOs]
            $(this).trigger("blur");
            // Block scroll in Body when fake modal is open and user scrolls in the modal

            bodyScrollLock.disableBodyScroll(targetElement);
          }

          // Añadir padding bottom mobile
          calendar._mobileBottom();

          if (this.bookingModal && this.bookingModal.length) {
            this.bookingModal.trigger(mModals.MODAL_UPDATE_CONTENT_EVENT);
          } else {

            // Colocar el dropdown dependiendo del espacio disponible (solo si no es mobile)
            (!calendar.isMobile)
              ? dropdownPosition(calendar.element.find('.js-calendar-booking-input'), calendar.options.elements.$dropdown, 20)
              : $(calendar.options.elements.$dropdown).css('top', '0');
          }
        } else {
          if (calendar.isMobile) {
            // Unblocks scroll in Body when fake modal is open and user scrolls in the modal
            bodyScrollLock.enableBodyScroll(targetElement);
          }
        }
      });


    // Plegar dropdown al clicar fuera del dropdown (en document)
    $(document).on('click', function (e) {
      let isOpen = $(calendar.options.elements.$dropdown).hasClass('is-open');

      // Comprobar si pinchas input o dropdown
      let inDropdown = $(e.target).closest('.js-calendar-booking-dropdown').length;
      let inTrigger = $(e.target).closest('.js-calendar-booking-input').length;

      // Comprobar si pinchas modales de error de calendar
      let idModalError = ['modal-max-days', 'modal-range-error'];
      let isErrorModal = idModalError.includes($(e.target).closest('.modal').attr('id'));

      // Cerrar dropdown y resetear valores de fechas a las de un paso anterior
      if (isOpen && !inTrigger && !inDropdown && !isErrorModal) {
        calendar._returnDates();
      }

      // Cuando el click salga del modal comprobar de que el checkin se visualiza
      if (isErrorModal) {

        // Selectores de día y mes del checkin
        let checkinButton = calendar.element.find(`button.day[data-day=${calendar.selectedDate.checkin.day}][data-month=${calendar.selectedDate.checkin.month}][data-year=${calendar.selectedDate.checkin.year}]`);
        let checkinMonth = $(checkinButton).closest('.calendar-booking-month');

        // Ir al mes de checkin cuando está oculto en desktop
        if (!calendar.isMobile && $(checkinMonth).hasClass('is-hidden')) {

          // Ocultamos todos los meses y mostramos solo los que nos interesan
          $(calendar.element).find('.calendar-booking-month').addClass('is-hidden');
          $(checkinMonth).removeClass('is-hidden');
          $(checkinMonth).next().removeClass('is-hidden');

          // Ir al mes de checkin cuando está oculto en mobile
        } else if (calendar.isMobile && $(checkinMonth).offset().top < 0) {

          // Desplazar el scroll hasta el mes del checkin
          let checkinText = $(checkinMonth).find('.month-name').text() + ' ' + $(checkinMonth).find('.year-name').text();
          $(checkinMonth).find('.month-content')[0].scrollIntoView();
          setTimeout(() => {
            $(calendar.element).find('.calendar-booking-month-fixed').text(checkinText);
          }, 0);
        }
      }
    });


    // Clic en cerrar fake modal
    $(this.options.elements.$dropdown.find('.nh-ic-close')).on("click", function (e) {
      let dropdownButton = $(calendar.options.elements.$dropdown).find('.js-calendar-booking-button');
      let targetElement = $(calendar.options.elements.$dropdown)[0].querySelector('.calendar-booking-months');

      // Unblocks body scroll in background
      bodyScrollLock.enableBodyScroll(targetElement);

      // Regresar a las fechas anteriores
      calendar._returnDates();

      // Deshabilitar/habilitar el botón de mobile
      (calendar.options.checkinDate)
        ? $(dropdownButton).attr('disabled', false)
        : $(dropdownButton).attr('disabled', true);
    });


    // Clic en aplicar fake modal
    $(this.options.elements.$dropdown.find('.js-calendar-booking-button')).on("click", function () {
      let targetElement = $(calendar.options.elements.$dropdown)[0].querySelector('.calendar-booking-months');

      $(calendar.options.elements.$dropdown).removeClass('is-open');
      bodyScrollLock.enableBodyScroll(targetElement);

      // Actualizamos el options de la fecha inicial
      calendar.options.checkinDate = calendar.selectedDate.checkin.date;
      calendar.options.checkoutDate = calendar.selectedDate.checkout.date;
    });


    // Actualizar el mes fixed de mobile al hacer scroll
    let monthFixed = $(this.options.elements.$dropdown).find('.calendar-booking-month-fixed');

    $(this.options.elements.$dropdown).find('.calendar-booking-months').on("scroll", function (e) {
      let monthHeaders = $(calendar.options.elements.$monthsContainer).find('.month-header');
      let lastMonthDay = null; // Posición del último día del mes
      let firstMonthDay = $(calendar.options.elements.$monthsContainer).find('.calendar-booking-month[data-index=0]').find('.month-content .month-day').last();
      let nextMonth = $(calendar.options.elements.$monthsContainer).find('.calendar-booking-month[data-index=1]');

      $(monthHeaders).each(function () {
        lastMonthDay = $(this).closest('.calendar-booking-month').find('.month-content .month-day').last();
        nextMonth = $(this).closest('.calendar-booking-month').next().find('.month-header');

        // Scroll hacia abajo next salvo el primer mes
        if ($(monthFixed).position().top + $(lastMonthDay).innerHeight() > $(lastMonthDay).position().top) {
          let month = $(nextMonth).find('.month-name').html();
          let year = $(nextMonth).find('.year-name').html();
          $(nextMonth).fadeOut();
          $(monthFixed).html(`${month} ${year}`);

          // Scroll hacia arriba al volver al primer scroll
        } else {
          $(nextMonth).fadeIn();
          if ($(monthFixed).position().top < $(firstMonthDay).position().top - $(firstMonthDay).innerHeight()) {
            let month = $(firstMonthDay).closest('.calendar-booking-month').find('.month-name').html();
            let year = $(firstMonthDay).closest('.calendar-booking-month').find('.year-name').html();
            $(monthFixed).html(`${month} ${year}`);
          }
        }
      });

      // Detectar si el scroll ha legado hasta el final para cambiar mensaje informativo
      ($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight)
        ? $(infoDropdown).html(calendar.options.msgMaxmonths)
        : $(infoDropdown).html(calendar.msgInfo);
    });


    // Navegación de flechas del calendario desktop & tablet
    if (!this.isMobile) this._arrowNavigation();
  },


  /**
   * @description - Resetear valores de fechas a las de un paso anterior
   */
  _returnDates() {
    let trigger = this.options.elements.$triggerContainer;
    let dropdown = this.options.elements.$dropdown;
    let rangeDate = moment(this.options.checkoutDate).diff(moment(this.options.checkinDate), 'days');
    let checkinDate = (this.options.firstValidDate) ? this.options.validDates.first.date : (this.options.checkinDate) ? this.options.checkinDate : null;
    let checkoutDate = moment(checkinDate).add(rangeDate, 'days');

    // Con fechas iniciales o anteriores búsquedas
    //if ( this.options.checkinDate ) {
    if (checkinDate) {
      // Dejar las fechas iniciales marcadas
      //this._selectDate (this.options.checkinDate);
      this._selectDate(checkinDate);
      //this._selectDate (this.options.checkoutDate);
      this._selectDate(checkoutDate);
      $(this.options.elements.$triggerContainer).find('.form-group').addClass('is-active');

      // Sin valor inicial almacenado (resetear calendar)
    } else {

      // Reseteamos los valores de los atributos selects
      this.selectedDate.checkin.initDate();
      this.selectedDate.checkout.initDate();

      // Resetear valores inputs y quitar foco
      $(trigger).find('.js-selected-checkin').val('').trigger('blur');
      $(trigger).find('.js-selected-checkout').val('').trigger('blur');

      // Resetear valores headers
      $(dropdown).find('.js-selected-checkin').html('-');
      $(dropdown).find('.js-selected-checkout').html('-');

      // Resetear rango seleccionado
      this.options.elements.$provRangeSelected = null;
      this.options.elements.$rangeSelected = null;
      $('.day').removeClass("checkin checkout provisional selected");

      // Resetear info
      $(dropdown).find('.calendar-booking-info').html(this.options.msgCheckin);
      this.msgInfo = this.options.msgCheckin;
    }

    $(dropdown).removeClass('is-open');
  },



  /**
   * @description - Añade un padding bottom al contenedor de todos los meses para que en mobile no se oculte el último mes
   */
  _mobileBottom() {

    // Calculamos las alturas de un mes y el footer de mobile (fijo en bottom)
    let heightMonth = $(this.options.elements.$monthsContainer).find('.calendar-booking-month').last().innerHeight();
    let heightMobileFooter = $(this.options.elements.$dropdown).find('.calendar-booking-footer').innerHeight();

    (this.isMobile)
      ? $(this.options.elements.$monthsContainer).css('paddingBottom', heightMonth + heightMobileFooter)
      : $(this.options.elements.$monthsContainer).css('paddingBottom', '0');
  },



  /**
   * @description - Controlamos a través de un atributo si estamos o no en mobile
   */
  _setMobile() {
    (window.matchMedia('(max-width: 767px)').matches)
      ? this.isMobile = true
      : this.isMobile = false;
  },



  /**
   * @description - Comportamiento de navegación de meses en desktop a través de iconos flecha
   */
  _arrowNavigation() {
    const calendar = this;

    // -----------------------------------------------------------------------
    // Inicializar los meses mostrados

    // Ocultar todos los meses salvo los dos primeros
    let months = $(this.options.elements.$monthsContainer).find('.calendar-booking-month');
    let arrowBefore = $(this.options.elements.$dropdown).find('.calendar-booking-arrow.is-before');
    let arrowAfter = $(this.options.elements.$dropdown).find('.calendar-booking-arrow.is-after');
    $(months).addClass('is-hidden');

    // Controlamos si hay días preseleccionadas
    let firstMonth = null;
    if (this.options.checkinDate) firstMonth = parseInt(moment(this.options.checkinDate).format('MM'));
    else if (this.options.firstValidDate) firstMonth = parseInt(moment(this.options.firstValidDate).format('MM'));

    // Mostrar los meses que nos interesan
    if (firstMonth) {
      let firstMonthContainer = $(this.options.elements.$monthsContainer).find(`[data-month=${firstMonth - 1}]`).first().closest('.calendar-booking-month');
      $(firstMonthContainer).removeClass('is-hidden');
      $(firstMonthContainer).next().removeClass('is-hidden');

    } else {
      $(this.options.elements.$monthsContainer).find('.calendar-booking-month').slice(0, 2).removeClass('is-hidden');
    }

    //  Ocultar/mostrar arrow navigations
    this._hideArrowNavigation(arrowBefore, arrowAfter);

    // -----------------------------------------------------------------------
    // Pinchar flecha before
    $(arrowBefore).on("click", function (e) {
      let shownMonths = calendar._shownMonths(months);
      let beforeCurrentIndex = shownMonths[0] - 1;
      if (beforeCurrentIndex !== -1) {
        $(calendar.options.elements.$monthsContainer).find(`.calendar-booking-month:eq( ${beforeCurrentIndex} )`).removeClass('is-hidden');
        $(calendar.options.elements.$monthsContainer).find(`.calendar-booking-month:eq( ${shownMonths[1]} )`).addClass('is-hidden');
      }
      calendar._hideArrowNavigation(arrowBefore, arrowAfter);
    });

    // -----------------------------------------------------------------------
    // Pinchar flecha after
    $(arrowAfter).on("click", function (e) {
      let shownMonths = calendar._shownMonths(months);
      let afterCurrentIndex = shownMonths[1] + 1;
      if (afterCurrentIndex !== calendar.config.monthsToShow) {
        $(calendar.options.elements.$monthsContainer).find(`.calendar-booking-month:eq( ${shownMonths[0]} )`).addClass('is-hidden');
        $(calendar.options.elements.$monthsContainer).find(`.calendar-booking-month:eq( ${afterCurrentIndex} )`).removeClass('is-hidden');
      }
      calendar._hideArrowNavigation(arrowBefore, arrowAfter);
    });
  },

  /**
   * @description - Controla los indices de los meses actualmente mostrados
   * @param - Array de elementos de mes en el calendario
   * @return - Indices de los meses actualmente mostrados
   */
  _shownMonths(months) {
    let shownMonths = [];
    $(months).each(function (index, month) {
      if (!$(month).hasClass('is-hidden')) shownMonths.push(index);
    });
    return shownMonths;
  },



  /**
   * @description - Controla cuando mostrar/ocultar flechas navegación
   * @param - Flecha anterior mes
   * @param - Flecha posteior mes
   */
  _hideArrowNavigation(arrowBefore, arrowAfter) {
    (!$(this.options.elements.$monthsContainer).find('.calendar-booking-month').first().hasClass('is-hidden'))
      ? $(arrowBefore).addClass('is-hidden')
      : $(arrowBefore).removeClass('is-hidden');

    (!$(this.options.elements.$monthsContainer).find('.calendar-booking-month').last().hasClass('is-hidden'))
      ? $(arrowAfter).addClass('is-hidden')
      : $(arrowAfter).removeClass('is-hidden');
  },



  /**
   * @description - Setear el checkin/checkout con una fecha
   * @param {date} date - fecha a seleccionar
   */
  _selectDate(date) {

    // Aislamos los datos que necesitamos
    let day = parseInt(moment(date).format('DD'));
    let month = parseInt(moment(date).format('MM'));
    let year = parseInt(moment(date).format('YYYY'));

    // Buscamos el botón por el data
    let button = this.element.find(`button.day[data-day=${day}][data-month=${month - 1}][data-year=${year}]`);

    // Simulamos que clickamos el button controlando si la fecha es pasada
    if (button.hasClass('past')) {
      this.msgInfo = this.options.msgNovalid;
      $(this.options.elements.$dropdown).find('.calendar-booking-info').html(this.options.msgNovalid);

    } else {
      $(button).trigger('click');
    }
  },



  /**
   * @description - Función constructora de div de días de la semana (Mo, Tu, We...)
   */
  _createWeekDaysHeader: function () {
    var $weekDaysHeader = this.element.find(".calendar-booking-weeks");
    var dayName = null;
    for (let x = 0; x < 7; x++) {
      dayName = this.options.translateDays[x].substr(0, 2);
      $weekDaysHeader.append(`<div class="calendar-booking-week">${dayName}</div>`);
    }
  },



  /**
   * @description - Función constructora que recorre los meses y los manda contruir uno por uno
   */
  _createMonths: function () {
    var dateToShow = (this.options.firstValidDate) ? this._getDateToShow() : this.currentDate;
    //var yearToShow = this.currentDate.year;
    //var monthToShow = this.currentDate.month;
    var yearToShow = (dateToShow.date.year) ? dateToShow.date.year() : dateToShow.year;
    var monthToShow = (dateToShow.date.month) ? dateToShow.date.month() : dateToShow.month;

    // Creamos los meses
    for (let i = 0; i < this.config.monthsToShow; i++) {
      if (monthToShow >= 12) {
        monthToShow = 0;
        yearToShow++;
      }

      this._createMonth(monthToShow, yearToShow, i);
      monthToShow++;
    }


    // Setear month fixed (solo se ve en mobile)
    let fixedMonth = `${this.options.translateMonths[dateToShow.month]} ${dateToShow.year}`;
    $(this.options.elements.$dropdown).find('.calendar-booking-month-fixed').html(fixedMonth);
  },



  /**
   * @description - Función constructora de unidad contenedora del mes
   * @param {number} month - Mes seleccionado
   * @param {number} year - Año seleccionado
   * @param {number} index - Index de numeración de cada mes
   */
  _createMonth: function (month, year, index) {
    let monthTemplate = '';
    monthTemplate += `<div class="calendar-booking-month" data-index=${index}>
                        ${this._getWeekDaysHeaderTpl()}
                        ${this._getMonthHeaderTpl(month, year)}
                        ${this._getMonthContentTpl(month, year)}
                      </div>`;
    this.options.elements.$monthsContainer.append(monthTemplate);
  },


  /**
   * @description - Función que te devuelve el template de la cabecera de días para el desplegable
   * @returns {string} - Template con la estructura de los días de la semana
   */
  _getWeekDaysHeaderTpl: function () {
    var dayName = null;
    var template = '<div class="calendar-booking-weeks">';

    for (let x = 0; x < 7; x++) {
      dayName = this.options.translateDays[x].substr(0, 2);
      template += `<div class="calendar-booking-week">${dayName}</div>`;
    }

    template += '</div>';
    return template;
  },



  /**
    * @description - Template del header de cada contenedor de mes
    * @param {number} monthIndex - Índice del array de mes
    * @param {number} year - Año del mes actual
    * @returns {string} - Estructura a añadir en el DOM
    */
  _getMonthHeaderTpl: function (monthIndex, year) {
    var template = `<div class="month-header">
        <span class="month-name">${this.options.translateMonths[monthIndex]}</span>
        <span class="year-name">${year}</span>
      </div>`;
    return template;
  },



  /**
    * @description - Template del contenido de cada contenedor de mes
    * @param {number} month - Mes actual del mes a construir
    * @param {number} year - Año actual del mes a construir
    * @returns {string} - Estructura a añadir en el DOM
    */
  _getMonthContentTpl: function (month, year) {
    var template = '<div class="month-content">';
    var firstDay = this._getDayWeek(year, month, 1);
    var lastDay = this._lastDay(month, year);
    var today = this.currentDate.date.getDate();
    var dayDate = {
      day: null,
      month: month,
      year: year,
      date: null
    };
    var isValidDay = true;
    var isPastDay = true;

    // Construir celdas vacías cuando el mes no empieza el lunes
    for (let x = 0; x < firstDay; x++) {
      template += `<div class="month-day"><button class="day empty"><span></span></button></div>`;
    }

    // Construir celdas de cada día del mes
    for (let x = 1; x <= lastDay; x++) {
      dayDate.day = x;
      dayDate.date = moment({ year: parseInt(year), month: (parseInt(month)), day: parseInt(x) });
      isValidDay = this._isValidDay(dayDate);
      template += `<div class="month-day">
                    <button class="day${isValidDay.past ? " past" : ""}${(x === today && month === this.currentDate.month && year === this.currentDate.year) ? " today" : ""}${isValidDay.blackOut ? " blackOut" : ""}${!isValidDay.valid ? " disabled" : ""}" type="button" data-day="${x}" data-month="${month}" data-year="${year}" ${!isValidDay.valid ? "disabled" : ""}>
                      <span>${x}</span>
                    </button>
                  </div>`;
    }

    template += '</div>';
    return template;
  },



  /**
   * @description - Listener de click de los días no vacíos de cada mes
   * @param {object} e - Descripción del evento lanzado
   */
  _onClickInDay(e) {
    var $this = $(e.currentTarget);
    var dayIndex = this.options.elements.$days.index($this);
    var day = $this.data("day");
    var month = {
      number: $this.data("month"),
      text: this.config.monthsNames[$this.data("month")]
    };
    var year = $this.data("year");
    var selectedDate = new Date(year, month.number, day);

    // si es día pasado
    if (selectedDate < this.currentDate.date) {
      return;
    }

    // Si tenemos que seleccionar fecha checkin o la fecha pulsada es menor que la fecha checkin seleccionada, seleccionamos checkin
    if (this.action === "checkin" || selectedDate < this.selectedDate.checkin.date) {
      this._setCheckIn(dayIndex, selectedDate);

      // Vigilar que el checkin y checkout sean diferentes
    } else if (this.action === "checkout" && !moment(this.selectedDate.checkin.date).isSame(selectedDate)) {
      this._setCheckOut(dayIndex, selectedDate);
    }
  },

  /**
    * @description - Devuelve el último día disponible del calendario
    * @return {date} - Último día disponible del calendario
    */
  _getLastDayAvailable() {
    let lastDayButton = $(this.options.elements.$monthsContainer).find('.day').last();
    return moment(`${$(lastDayButton).attr('data-year')} / ${$(lastDayButton).attr('data-month') + 1} / ${$(lastDayButton).attr('data-day')}`, "DD/MM/YYYY");
  },

  /**
    * @description - Check in: actualizamos atributos y clases de rangos de selección
    * @param {number} dayIndex - Indice de array de días
    * @param {object} selectedDate - Fecha seleccionada para setear checkin
    */
  _setCheckIn: function (dayIndex, selectedDate) {
    var provCheckoutDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate() + this.options.minNights);
    if (!this._isValidRange(selectedDate, provCheckoutDate)) {
      return false;
    }

    // Poner texto check in en el trigger
    let triggerText = moment(selectedDate).format("DD/MM/YYYY");
    let triggerCheckin = this.options.elements.$triggerContainer.find('.js-selected-checkin');
    let triggerCheckout = this.options.elements.$triggerContainer.find('.js-selected-checkout');
    $(triggerCheckin).val(triggerText).trigger('focus');
    $(triggerCheckin).closest('.form-group').addClass('is-active');
    $(triggerCheckout).val('').trigger('blur');
    $(triggerCheckout).closest('.form-group').removeClass('is-active');


    // Poner texto check in en la cabecera y activar/desactivar headers
    let headerText = moment(selectedDate).format("dd, DD MMM YY");
    let headerCheckin = this.options.elements.$selectedDateHeader.$checkin;
    let headerCheckout = this.options.elements.$selectedDateHeader.$checkout;
    $(headerCheckin).find('.js-selected-checkin').html(headerText);
    $(headerCheckout).find('.js-selected-checkout').html('');


    // Quitar clases de rango de selección para actualizarlo
    if (this.options.elements.$provRangeSelected) {
      this.options.elements.$provRangeSelected.removeClass("checkin checkout provisional selected");
    }

    if (this.options.elements.$rangeSelected) {
      this.options.elements.$rangeSelected.removeClass("checkin checkout provisional selected");
    }

    // Atributo que almacena día inicial de selección
    this.initialDayIndex = dayIndex;


    // Clases del rango de selección
    this.options.elements.$provRangeSelected = this.options.elements.$days.slice(dayIndex, (dayIndex + this.options.minNights + 1)).addClass("selected");
    this.options.elements.$provRangeSelected.eq(0).addClass("checkin initial");
    this.options.elements.$provRangeSelected.slice(1, this.options.elements.$provRangeSelected.length).addClass("provisional");

    // Evitar clase checkout si el checkin es el ultimo dia disponible de todo el calendario
    let lastDate = this._getLastDayAvailable();
    if (!moment(selectedDate).isSame(lastDate)) {
      this.options.elements.$provRangeSelected.eq(this.options.elements.$provRangeSelected.length - 1).addClass("checkout");
    }

    // Establecer la fecha de checkin y cambiar próximo flag de acción
    this.selectedDate.checkin.setDate(selectedDate);
    $(this.options.elements.$dropdown).find('.js-calendar-booking-button').attr('disabled', true);
    this.action = "checkout";

    // Cambiar mensajes informativos
    let msgInfo = this.options.msgCheckout;
    if (moment(selectedDate).isSame(lastDate)) {
      msgInfo = this.options.msgMaxmonths;
    }
    this.msgInfo = msgInfo;
    $(this.options.elements.$dropdown).find('.calendar-booking-info').html(msgInfo);
  },



  /**
    * @description -   Check out: actualizamos atributos y clases de rangos de selección
    * @param {number} dayIndex - Indice de array de días
    * @param {object} selectedDate - Fecha seleccionada para setear checkout
    */
  _setCheckOut: function (dayIndex, selectedDate) {
    var $checkOutDay = this.options.elements.$days.eq(dayIndex);

    if (!this._isValidRange(this.selectedDate.checkin.date, selectedDate)) {
      return false;
    }

    // Poner texto check in en el trigger
    let triggerText = moment(selectedDate).format("DD/MM/YYYY");
    let triggerCheckin = this.options.elements.$triggerContainer.find('.js-selected-checkin');
    let triggerCheckout = this.options.elements.$triggerContainer.find('.js-selected-checkout');
    $(triggerCheckout).val(triggerText).trigger('focus');
    $(triggerCheckin).closest('.form-group').removeClass('is-active');
    $(triggerCheckout).closest('.form-group').addClass('is-active');


    // Poner texto check in en la cabecera y activar/desactivar headers
    let headerText = moment(selectedDate).format("dd, DD MMM YY");
    let headerCheckout = this.options.elements.$selectedDateHeader.$checkout;
    $(headerCheckout).find('.js-selected-checkout').html(headerText);


    // Actualizar clases del rango de selección
    this.options.elements.$provRangeSelected = null;
    this.options.elements.$rangeSelected = this.options.elements.$days.slice(this.initialDayIndex, dayIndex + 1).addClass("selected").removeClass("provisional checkout");
    this.options.elements.$rangeSelected.eq(this.options.elements.$rangeSelected.length - 1).addClass("checkout");
    this.options.elements.$rangeSelected.eq(0).removeClass("initial");


    // Establecer la fecha de checkout y cambiar próximo flag de acción
    this.selectedDate.checkout.setDate(selectedDate);
    this.action = "checkin";

    // Rellenar mensaje informativo
    let contNights = moment(this.selectedDate.checkout.date).diff(moment(this.selectedDate.checkin.date), 'days');
    let msg = (contNights < 2) ? this.options.msgNight : this.options.msgNights;
    $(this.options.elements.$dropdown).find('.calendar-booking-info').html(`${contNights} ${msg}`);
    this.msgInfo = `${contNights} ${msg}`;

    // Activar el botón de aplicar de mobile
    $(this.options.elements.$dropdown).find('.js-calendar-booking-button').prop('disabled', false);



    // Cerrar el dropdown si no es mobile
    if (!this.isMobile) {
      this.options.elements.$triggerContainer.trigger('click');
      $(triggerCheckout).closest('.calendar-group').removeClass('is-active');
      $(headerCheckout).closest('.selected-checkout').removeClass('is-active');
    }
  },



  /**
    * @description - Calcular la posición del primer día de cada mes
    * @param {number} year -
    * @param {number} month -
    * @param {number} day -
    * @returns {number} -
    */
  _getDayWeek: function (year, month, day) {
    var paramDay = new Date(year, month, day);
    var dayNumber = paramDay.getDay();

    if (this.config.startDay === 1) {
      (dayNumber === 0) ? dayNumber = 6 : dayNumber--; // El corresponde a la última posición (Domingo)
    }
    return dayNumber;
  },



  /**
  * @description - Calcular el último días del mes (13)
  */
  _lastDay: function (month, year) {
    var lastDay = 28;
    while (this._checkdate(year, month + 1, lastDay + 1)) {
      lastDay++;
    }
    return lastDay;
  },



  /**
  * @description - Comprobar si es el último día de cada mes (14)
  */
  _checkdate: function (year, month, day) {
    return month > 0 && month < 13 && year > 0 && year < 32768 && day > 0 && day <= (new Date(year, month, 0)).getDate();
  },



  /**
  * @description - vamos a optener la configuracion del calendario que nos proporcionan de forma externa a traves de datas
  */
  _getExternalConfig: function () {
    var $self = this;
    var data = this.element.data();

    $.each(this.config, function (key, value) {
      $self.config[key] = data[key] ? data[key] : $self.config[key];
    });

    // Formatear los atributos de días iniciales
    if (this.options.checkinDate) {
      this.options.checkinDate = moment(this.options.checkinDate, 'DD/MM/YYYY')._d;
    }
    if (this.options.checkoutDate) {
      this.options.checkoutDate = moment(this.options.checkoutDate, 'DD/MM/YYYY')._d;
    }
  },

  /**
  * @description - vamos a optener la configuracion del calendario que nos proporcionan de forma externa a traves de datas
  */
  _setCustomOptions: function () {
    var $self = this;
    var data = this.element.data();

    $.each(this.options, function (key) {
      $self.options[key] = data[key] ? data[key] : $self.options[key];
    });

    // Formatear los atributos de días iniciales
    /*if( this.options.checkinDate ) {
      this.options.checkinDate = moment(this.options.checkinDate, 'DD/MM/YYYY')._d;
    }

    if( this.options.checkoutDate ) {
      this.options.checkoutDate = moment(this.options.checkoutDate,'DD/MM/YYYY')._d;
    }*/
  },

  /**
  * @description - setemaos las fechas iniciales predefinidas dependiento si vienen informadas, is hay primera fecha valida,...
  */
  _setInitialDates: function () {
    if (this.options.checkinDate && !this.options.firstValidDate) {
      this.options.checkinDate = moment(this.options.checkinDate, 'DD/MM/YYYY')._d;
      this.options.checkoutDate = moment(this.options.checkoutDate, 'DD/MM/YYYY')._d;
    } else if (!this.options.checkinDate && this.options.firstValidDate) {
      this.options.checkinDate = this.options.validDates.first.date._d;
      this.options.checkoutDate = this.options.validDates.first.date.clone().add(this.options.minNights, 'days')._d;
    } else if (this.options.checkinDate && this.options.firstValidDate) {
      if (this.options.validDates.first.date.isAfter(moment(this.options.checkinDate, 'DD/MM/YYYY'))) {
        this.options.checkinDate = this.options.validDates.first.date._d;
        this.options.checkoutDate = this.options.validDates.first.date.clone().add(this.options.minNights, 'days')._d;
      } else {
        this.options.checkinDate = moment(this.options.checkinDate, 'DD/MM/YYYY')._d;
        this.options.checkoutDate = moment(this.options.checkoutDate, 'DD/MM/YYYY')._d;
      }
    }
  },
  /**
  * Ey, FUNCTION
  * @description - vamos a setear el final last valid si el el first valid date no es null y no nos de fallo
  */
  _setInitiallastValidDate: function _setInitiallastValidDate() {
    const calendar = this;      
    this.options.lastValidDate  = (moment(moment(new Date()).utc().format()).add(calendar.config.monthsToShow, 'M')).format('DD/MM/YYYY');
  },

  /**
   * @description - vamos a setear todos los datos de las fechas validas para acotar dias validos
   */
  _setValidDates: function () {
    this.options.validDates.first = this._getValidDate(this.options.firstValidDate, this.options.firstWeeklyDay);
    this.options.validDates.last = this._getValidDate(this.options.lastValidDate);
  },

  _getValidDate: function (date, firstWeeklyDay) {
    //let validDate = moment(date,'DD/MM/YYYY').format('DD/MM/YYYY');
    let validDate = moment(date, 'DD/MM/YYYY');
    if (!date && firstWeeklyDay) {
      validDate = this._setFirstWeekAvailableDay(firstWeeklyDay, moment().format('DD/MM/YYYY'));
    } else if (date && firstWeeklyDay) {
      //validDate = this._setFirstWeekAvailableDay(firstWeeklyDay, date).split("/");
      validDate = this._setFirstWeekAvailableDay(firstWeeklyDay, date);
    }
    return {
      date: validDate,
      stringDate: validDate.format('DD/MM/YYYY'),
      get day() {
        return this.date.day();
      },
      get month() {
        return this.date.month();
      },
      get year() {
        return this.date.year();
      }
    };
  },

  // -----------------------------------------------------------------------------
  // Determina el primer dia de la semana a partir del cual se puede seleccionar
  // una fecha
  // -----------------------------------------------------------------------------
  //function setFirstWeekAvailableDay(firstWeeklyDay, date) {
  _setFirstWeekAvailableDay: function (firstWeeklyDay, date) {
    let dateMoment = moment(date, 'DD/MM/YYYY');
    let firstWeeklyDayNumber = this.config.daysNames.indexOf(firstWeeklyDay) + 1
      ;
    //  Si la fecha actual es posterior, se pasa el primer dia seleccionable
    // a la semana siguiente
    if (firstWeeklyDayNumber > dateMoment.day()) {
      dateMoment.day(firstWeeklyDayNumber);
    } else if (firstWeeklyDayNumber < dateMoment.day()) {
      dateMoment.day(firstWeeklyDayNumber + 7);
    }
    //return dateMoment.format('DD/MM/YYYY');
    return dateMoment;
  },

  /**
   * @description - compobar si un rango de fechas es valido o no
   * @param {object} checkinDate  - objeto date de fecha checkin
   * @param {object} checkoutDate - objeto date de fecha checkout
   */

  _isValidRange: function (checkinDate, checkoutDate) {
    var checkindate = moment(checkinDate);
    var checkoutdate = moment(checkoutDate);
    var rangeDays = checkoutdate.diff(checkindate, 'days');
    var isValidInitDate = true;
    var isValidEndDate = true;

    isValidInitDate = this._isValidDay({ date: checkindate }).valid;
    isValidEndDate = this._isValidDay({ date: checkoutdate }).valid;

    //var isValidInitDate = checkindate.isBetween(this.config.validDates.first.date, this.config.validDates.last.date, null, '[]');
    //var isValidEndDate = checkoutdate.isBetween(this.config.validDates.first.date, this.config.validDates.last.date, null, '[]');

    // entra dentro del dia minimos y máximos de rango
    var isValidRangeDays = (this.options.minNights <= rangeDays && rangeDays <= this.options.maxNights);

    //tiene blackouts entre medias
    var hasBlackOuts = this.config.blackOuts.dateList.some(function (blackDate) {
      //if (blackDate.isBetween(checkindate,checkoutdate) || blackDate.isSame(checkindate) || blackDate.isSame(checkoutdate)){

      if (blackDate.isBetween(checkindate, checkoutdate) || blackDate.isSame(checkindate)) {
        return true;
      }
    });

    // Modales de error
    if (!isValidInitDate || !isValidEndDate) {
      $('#modal-range-error').modal();
    } else if (rangeDays > this.options.maxNights) {
      $('#modal-max-days').modal();
    } else if (rangeDays < this.options.minNights) {
      $('#modal-range-error').modal();
    }

    return (isValidRangeDays && !hasBlackOuts && isValidInitDate && isValidEndDate);
  },



  /**
   * @description - comprobamos si es un día valido (esta dentro del rango valido, no es blackout, no es pasado)
   * @param {object} dayDate - objeto con los datos de la fecha de un dia concreto.
   * @returns {object} devolvemos un objeto diciendo si es dia valido, blackout y pasado
   */
  _isValidDay: function (dayDate) {
    var isPast = dayDate.date.isBefore(this.currentDate.date);
    var isBlackOutDay = this._isBlackOutDay(dayDate);
    var isValidDate = true;
    var isValid = {
      valid: true,
      past: isPast,
      blackOut: this._isBlackOutDay(dayDate)
    };

    if (this.options.validDates.first && this.options.validDates.last) {
      isValidDate = dayDate.date.isBetween(this.options.validDates.first.date, this.options.validDates.last.date, null, '[]');

    } else if (this.options.validDates.first && !this.options.validDates.last) {
      isValidDate = dayDate.date.isSameOrAfter(this.options.validDates.first.date);

    } else if (this.options.validDates.first && !this.options.validDates.first) {
      isValidDate = dayDate.date.isSameOrBefore(this.options.validDates.last.date);
    }



    isValid.valid = (isValidDate && !isPast && !isBlackOutDay);
    return isValid;
  },



  /**
   * @description - obtenemos la fecha inicial a pintar en el calendario
   * @returns {object} devolvemos la fecha inicial a mostra en el calendario
   */
  _getDateToShow: function () {
    var date = this.currentDate;
    if (this.options.validDates.first.date.isAfter(this.currentDate.date)) {
      date = this.options.validDates.first;
    }
    return date;
  },



  /**
   * @description - comprobamos si un dia es blackout o no
   * @param {object} dayDate - objeto con la fecha de un dia concreto
   * @returns {boolean} devolvemos si es blackout o no.
   */
  _isBlackOutDay: function (dayDate) {
    var isBlackDay = this.config.blackOuts.dateList.some(function (blackDate) {
      if (dayDate.date.isSame(blackDate)) {
        return true;
      }
    });
    return isBlackDay;
  },

  close: function () {
    if (this.element.hasClass('is-open')) {
      this.element.removeClass('is-open');
    }
  }
});

$.widget('nh.customSelector', {
  options: {
    multipleChoice: false
  },

  _create: function() {
    this.inputElements = this.element.find("input");
    this.inputElementsWrapper = this.inputElements.parent();

    $.each(this.inputElementsWrapper, function() {
      var $this = $(this);
      var $input =$this.find("input");
      if($input.prop("disabled")) {
        $this.addClass("is_disabled");
      }
    });

    if(this.element.attr('data-multiple-choice') !== undefined) {
      this.options.multipleChoice = this.element.attr('data-multiple-choice') == 'true';
    }
    //  EY
    //  reset values
    this.element.find(".is_checked").addClass('temp_is_checked');
    this.element.removeClass("is_checked");
    (this.inputElements.not("input[type='hidden']")).each((index, el) => {
        let $el = $(el);
        let $div = $el.parent();
        if ($el.prop("checked") || $div.hasClass("temp_is_checked")) {
            $div.addClass("is_checked");
        }else{
            $div.removeClass("is_checked");
        }
        $div.removeClass("temp_is_checked");
    });
    // Listeners
    this._on(this.inputElements, {
      'change' : this._onInputChange
    });
    this._on(this.element.find('.custom-selector-item'), {
      'mouseup' : this._onInputFocusout
    });
  },

  /**
   * Handler when the input changes
   * @param  {[type]} e [description]
   * @return {[type]}   [description]
   */
  _onInputChange: function(e) {
    var $radio = $(e.currentTarget);
    var containerRadio=$radio.parent();

    if(!$radio.prop("disabled")) {
      if ($radio.prop("checked")) {
        containerRadio.addClass("is_checked");
        if (!this.options.multipleChoice) {
          containerRadio.siblings('.is_checked').removeClass("is_checked");
        }
      }
    }
  },

  /**
   * Handler when the user clicks on other element
   * @param  {[type]} e [description]
   * @return {[type]}   [description]
   */
  _onInputFocusout: function(e) {
    var $this = $(e.currentTarget);
    var inputRadio = $this.find('input');
    if(!inputRadio.prop("disabled")) {
      if ($this.hasClass('is_checked')) {
        $this.removeClass('is_checked');
        inputRadio.prop('checked', false);
        inputRadio.trigger('change');
      }
    }
  },

  /**
   * Returns the value (array of values if its multiple choice) of the checked
   * @return {[type]} [description]
   */
  getValue: function() {
    var checkedValue = null;
    this.inputElements.each((index, el) => {
      let $el = $(el);
      if ($el.prop('checked')) {
        if (!this.options.multipleChoice) {
          checkedValue = $el.val();
        }else if($el.val()){
          if(!checkedValue) {
            checkedValue = [];
          }
          checkedValue.push($el.val());
        }
      }
    });
    return checkedValue;
  },

  _destroy: function() {

  }
});

$.widget('nh.formSteps', {
  options: {
    initStep: 0,
    validateStep: null,
  },

  activeStep: 0,

  _create: function() {
    this.formSteps = this.element.find('[data-step]');
    this.stepIndicators = this.element.find('[data-active-step]');
    this.nextStepNavigators = this.element.find('[data-next-step]');
    this.prevStepNavigators = this.element.find('[data-prev-step]');
    this.form = this.element.find('form');
    this._initSteps();
    // Listeners
    this._on(this.stepIndicators, {
      'click' : this._onStepIndicatorClick
    });
    this._on(this.nextStepNavigators, {
      'click' : this._onNextStepNavigatorClick
    });
    this._on(this.prevStepNavigators, {
      'click' : this._onPrevStepNavigatorClick
    });
  },

  /**
   * Nav to the initial step
   */
  _initSteps: function() {
    this._navigateStep(this.options.initStep);
  },

  /**
   * Navigation handler. Triggers form validation before performing the navigation to the step param.
   * @param  {[type]} stepToNav Step to navigate
   */
  navTo: function(stepToNav) {
    if(this.form.validator) {
      // Validate when moving forward
      if(stepToNav > this.activeStep) {
        // Trigger validation
        this.form.validator('validate');
        var errorElements = this.form.find('.has-error');
        if(errorElements.length === 0 ) {
          this._navigateStep(stepToNav);
        }
      }else {
        this._navigateStep(stepToNav);
      }
    }
  },

  /**
  * Hide all steps except the active step
  */
  _navigateStep: function(stepToNav) {
    this.formSteps.each((index, step) => {
      let $step = $(step);
      if($step.data('step') == stepToNav) {
        $step.removeClass('hide');
        this._setInputValidate($step, true);
        this._setStepIndicator($step.data('step'));
        this.activeStep = $step.data('step');
      } else {
        $step.addClass('hide');
        this._setInputValidate($step, false);
      }
    });
    this.form.validator('update');
  },

  /**
   * Enable/disable all the step's inputs validation
   * @param  {[type]} $step    [Step element to enable/disable validation]
   * @param  {[boolean]} validate [Enable validation]
   */
  _setInputValidate: function($step, validate) {
    var stepInputs = $step.find(':input:not(button)').add(":input[type='radio']:not(:visible)").add(".bootstrap-select button:visible");
    stepInputs.attr('data-validate', validate);
  },

  /**
   * Add an active class to the active step indicator
   * @param  {[string]} activeStep [Active step to set.]
   */
  _setStepIndicator: function(activeStep) {
    this.stepIndicators.removeClass('is_active');
    this.stepIndicators.each((index, stepIndicator) => {
      let $stepIndicator = $(stepIndicator);
      if($stepIndicator.data('active-step') == activeStep) {
        $stepIndicator.addClass('is_active');
      }
    });
  },

  /**
   * Handler step indicator click to navigate to a step
   */
  _onStepIndicatorClick: function(e) {
    let $clickedStep = $(e.currentTarget);
    let stepToNav = $clickedStep.data('active-step');
    this.navTo(stepToNav);
  },

  /**
   * Handler next step click
   */
  _onNextStepNavigatorClick: function(e) {
    this.navTo(this.activeStep + 1);
  },

  /**
   * Handler previous step click
   */
  _onPrevStepNavigatorClick: function(e) {
    if (this.activeStep - 1 >= 0) {
      this.navTo(this.activeStep - 1);
    }
  },

  _destroy: function() {

  }
});

$.widget('nh.htmlInject', {
  options: {

  },

  // Const
  HTML_INJECTED_EVENT: 'html_injected_event',

  /**
   * Create Fn
   * @return {[type]} [description]
   */
  _create: function() {
  
  },

  /**
   * Injects the template located at the url param in the selected container.
   * @param  {[string]}   containerSelector [JQuery selector of the container]
   * @param  {[string]}   tplUrl            [Template Url location]
   * @param  {Function} callback          [Custom callback to execute when injected]
   */
  injectHTMLByUrl: function(containerSelector, tplUrl, callback) {
    var $containerElement = this.element.find(containerSelector);
    if ($containerElement) {
      this.toggleLoading(true);
      $containerElement.load(`${tplUrl}`, (response, status, xhr) => {
        //console.log("template", response);
        this.toggleLoading(false);
        // Widget trigger the injected event
        this._trigger(this.HTML_INJECTED_EVENT, {}, {
          response: response,
          status:status,
          xhr: xhr
        });
        // Private callback
        this._onLoadComplete(response,status,xhr, callback);
      });
    }
  },
  injectHTMLByJson: function(containerSelector, tplUrl, callback) {
    var $containerElement = this.element.find(containerSelector);
    if ($containerElement) {
      //this.toggleLoading(true);
      $containerElement.html(tplUrl);
      this.toggleLoading(false);
      this._trigger(this.HTML_INJECTED_EVENT, {}, {});
     
      if (typeof callback === 'function') {
        // Public callback
        callback();
      }
      /*$containerElement.load(`${tplUrl}`, (response, status, xhr) => {
        //console.log("template", response);
        this.toggleLoading(false);
        // Widget trigger the injected event
        this._trigger(this.HTML_INJECTED_EVENT, {}, {
          response: response,
          status:status,
          xhr: xhr
        });
        // Private callback
        this._onLoadComplete(response,status,xhr, callback);
      });*/



    }
  },

  /**
   * Callback when a jquery load injection has finished.
   * @param  {[object]}   response [description]
   * @param  {[string]}   status   [description]
   * @param  {[object]}   xhr      [description]
   * @param  {Function} callback [Custom callback]
   */
  _onLoadComplete: function(response, status, xhr, callback) {
    if (status === "error") {
      this._onLoadError();
    } else {
      if (typeof callback === 'function') {
        // Public callback
        callback(response, status, xhr);
      }
    }
  },

  toggleLoading: function(loadingVisible, capa = false) {
    
    if (loadingVisible && capa) {
      var $capa = capa ;      
      $(".spinnerPanel").remove();
      var $spinner = $('.spinner:first').clone();
      $spinner.css({'padding':'20%', 'text-align':'center'}).addClass("spinnerPanel");
      $capa.html('').html($spinner);
      $(".spinnerPanel").show();
    } else {     
      $(".spinnerPanel").remove();
    }
  },
  _onLoadError: function() {
  },

  /**
   * Destroy Fn
   * @return {[type]} [description]
   */
  _destroy: function() {

  }
});

/*	--------------------------------------------------
        Input maxlenght
       -------------------------------------------------- */
    /*if($(".js-count-maxlength").length) {
        $(".js-count-maxlength").val('');
        $(".js-count-maxlength").on("keyup change", function() {
            var $inputText = $(this);
            var value = $inputText.val();
            var boxContador = $inputText.closest(".form-group").find('.rest-caracters');
            //to avoid issues if the html textarea element doesn't have data-max-length attribute
            var max = ($inputText.data("max-length")) ? parseInt($inputText.data("max-length")) : 250;
            var remainingCharacters = max - (value.length);
            var remainingCaracteresLabel = boxContador.data('label') || '';

            var totalChars = 0;

            if(value.length < max) {
                boxContador.html(remainingCharacters + " " + remainingCaracteresLabel);
            } else {
                $inputText.val(value.substring(0, max));
                boxContador.html(0 + " " + remainingCaracteresLabel);
            }
        });
    }*/

    $.widget('nh.limitCharacters', {
      options: {
        maxLenght: 250
      },
    
      _create: function() {
        this.counterBox = this.element.closest(".form-group").find('.rest-caracters');
        this.max = (!this.element.data('maxlength')) ? this.options.maxLenght : parseInt(this.element.data('maxlength'));
    
        this._countCharacters();
    
        // Listeners
        this._on(this.element, {
          'change': this._countCharacters,
          'keyup': this._countCharacters
        });
      },
    
      /**
       * @description to count the characters of the element to limit the number of them
       * @param  {[object]} e object with javaScript event data
       */
      _countCharacters: function(e) {
        var value = this.element.val();
        var remainingCharacters = this.max - (value.length);
        var remainingCaracteresLabel = this.counterBox.data('label') || '';
    
        if(value && (value.length > this.max)) {
          this.element.val(value.substring(0, this.max));
          remainingCharacters = 0;
        }
    
        if(this.counterBox.length) {
          this.counterBox.html(remainingCharacters + " " + remainingCaracteresLabel);
        }
      },
    
      _destroy: function() {
    
      }
    });
$.widget('nh.selectDestinations', {
  fields: null,
  querys: {
    data: null,
    country: "$..CountryList[*].name",
    city: "",
    hotel: "",
    setCity: function (country) {
      this.city = `$..CountryList[?(@.name=='${country}')]..CityList[*].name`;
    },
    setHotel: function (city) {
      this.hotel = `$..CityList[?(@.name=='${city}')].HotelList[*].name`;
    }
  },
  countryData: {
    $field: null,
    $wrapper: null,
    query: null,
    data: null
  },
  cityData: {
    $field: null,
    $wrapper: null,
    query: null,
    data: null
  },
  hotelData: {
    $field: null,
    $wrapper: null,
    query: null,
    data: null
  },



  _create: function () {
    const destination = this;
    destination.fields = {
      country: {
        $field: destination.element.find("select.country"),
        get $wrapper() { return this.$field.parents(".form-group"); }
      },
      city:{
        $field: destination.element.find("select.city"),
        get $wrapper() { return this.$field.parents(".form-group"); }
      },
      hotel: {
        $field: destination.element.find("select.hotel"),
        get $wrapper() { return this.$field.parents(".form-group"); }
      }
    }


    if ( destination.fields.country.$field.length )
      destination._initializeCountries();


    // Listener cambio de país
    destination.fields.country.$field.on('change', function() {
      let value = $(this).val().replace(/_/g," ");
      destination.querys.setCity(value);
      destination._initializeCities();

      destination.fields.hotel.$field.find('option').remove();
      destination.fields.hotel.$field.selectpicker("refresh");
    });


    // Listener cambio de ciudad
    destination.fields.city.$field.on('change', function() {
      let value = $(this).val().replace(/_/g," ");
      destination.querys.setHotel(value);
      if (value) destination._initializeHotels();
    });
  },



  /**
    * @description Inicializar select países
    */
  _initializeCountries () {
    const destination = this;

    //EY: Change mockup URL to PRO URL
    let promise = $.getJSON('/resources/jsonDestinations.txt');
    this.countryData = {
      $field: this.fields.country.$field,
      $wrapper: this.fields.country.$wrapper,
      query: this.querys.country,
      data: this.querys.data
    };

    promise.then( (response) => {
      destination.querys.data = response;
      destination.countryData.data = response;
      destination._generateSelect(destination.countryData);
    });
  },




  /**
    * @description Inicializar select ciudades
    */
  _initializeCities () {
    this.cityData = {
      $field: this.fields.city.$field,
      $wrapper: this.fields.city.$wrapper,
      query: this.querys.city,
      data: this.querys.data
    };
    this._generateSelect(this.cityData);
  },




  /**
    * @description Inicializar select hoteles
    */
  _initializeHotels () {
    this.hotelData = {
      $field: this.fields.hotel.$field,
      $wrapper: this.fields.hotel.$wrapper,
      query: this.querys.hotel,
      data: this.querys.data
    };
    this._generateSelect(this.hotelData);
  },



  /**
    * @description Generar selects
    */
   _generateSelect (selectData) {
    let optionValue = null;
    let optionsValues = jsonPath(selectData.data, selectData.query).sort(
      function (a, b) {
        let aName = utils.removeDiacritics(a.toLowerCase());
        let bName = utils.removeDiacritics(b.toLowerCase());
        return ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));
      }
    );

    selectData.$wrapper.removeClass("has-error has-success has-danger");

    selectData.$field.find('option').remove().append('<option value="">');
    $.each(optionsValues, function(index , value){
      optionValue = value.replace(/\s+/g,"_");
      selectData.$field.append(`<option value="${optionValue}">${value}</option>`);
    });

    //refresh selectpicker
    selectData.$field.prop('disabled', false).selectpicker("refresh");
  },
});

//  1. Select autocomplete
//  2. Funciones de animación del label en select
//  3. Select nativo en movil
//  4. Boton limpiar input
//  5. Custom selector (interaction)
//  6. Selector Calendar initialization
//  7. contador caracteres en input/textarea
//  8. Funciones de animación del label
//  9. Funcion para hacer scroll hacia el primer error encontrado en el formulario
//  10. Functon to disable/enabled button to show/hide loading
//  11. Validacion DNI y NIE
//  12. Override Validator scroll function

var commonFormSetup = (() => {
  function init() {
    virtualKeyboardDetector.init( { recentlyFocusedTimeoutDuration: 3000 } );
    /*** 1. Select autocomplete init ***/
    //initialize the autocomplete selects if they have the data-await === "true" if it is set to "false" if beacause the options will be filled by ajax call and then 
    //the select will be initialized after ajax call ends in other js file.
    //$('.ui-autocomplete-input').selectToAutocomplete();
    $('.ui-autocomplete-input[data-await="false"]').selectToAutocomplete();

    //inicializamos los autocompletados especiales de grupos
    if($('.ui-autocomplete-group').length> 0) {
      $('.ui-autocomplete-group').autocompleteGroup();
    }

    /*** 2. Funciones de animación del label en select ***/
    $('.labelup-select').on('change', _labelUpSelect);

    /*** 3. Funciones de animación del label en select ***/
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)) {
      $('.selectpicker').not("[data-live-search='true']").selectpicker('mobile');
    }

    /***
     * 4. Boton limpiar input
     * SOLO para pantallas menores de 992. Sería para mobile solo
     ***/
    if (globalConfig.windowWidth < 992) {//usamos globalConfig que esta en critical/main.js
      _initClearButton();
      _initToggleInputIcons();
     }

    /*** 5. Custom selector (interaction) ***/
    $('.custom-selector').customSelector();

    /*** 6. Selector Calendar initialization ***/
    $('.js-selector-datepicker').selectorDatepicker({
      format: 'DD/MM/YYYY',
      initYear: '1920',
      monthTranslations: monthsArray,
      invalidDateMessage: Labels.lblInvalidDate
    });

    /*** 7. contador caracteres textarea ***/
    $(".js-count-maxlength").limitCharacters();

    /***
     * 8. Funciones de animación del label
     * version: 2
     * NOTA:  Mirar si se puede sacar a un módulo e inicializarlo en las páginas que lo necesiten solamente
     ***/
    $('.form-control').each(_labelAnimation);
    $('select.form-control-select').each(_labelAnimation);

  }

  function _labelUpSelect() {
     var selected = $(this).find("option:selected").val();
     if (selected) {
         $('.relative').addClass("labelup");
     }
  }

  function _labelAnimation() {
    var $this = $(this);
    if ($this.val()) { // Si tiene texto subimos el label s
        $this.closest(".form-group").find('.labelup-control').addClass('focus');
    }

    $this.on("focus change keyup", function() { // Subimos el label al hacer FOCUS
        $(this).closest(".form-group").find('.labelup-control').addClass('focus');
        //$this.closest(".form-group").children('.labelup-control').addClass('focus');
    }).on("focusout blur", function() { // Bajamos el label al perder el foco
        var $this = $(this);
        // Added exception on autocomplete input. It should not remove the focus to keep the label up
        // if($this.closest('div.form-group').hasClass('ui-autocomplete-input')){
        //   return;
        // }
        // Type numeric, avoid remove focus on invalid number
        if ($this.is('input[type="number"]') && $this[0].validity && !$this[0].validity.valid) {
          return;
        }
        ( !$this.val() && !$this.attr("placeholder"))

          ? $this.closest(".form-group").find('.labelup-control').removeClass('focus')
          : $this.closest(".form-group").find('.labelup-control').addClass('focus');
    });
  }

  function _initToggleInputIcons() {
    var $inputIcon = $(".container-icon");
    var $inputs = $inputIcon.siblings("input, textarea");
    $inputs.each(function(index, input) {
      var $icon = $(input).siblings('.container-icon');
      if ($(input).val()) {
        $icon.hide();
      }else{
        $icon.show();
      }
    });

    $inputs.on('keyup blur', function() {
      var $this = $(this);
      var $icon = $this.siblings('.container-icon');
      if ($this.val() !== '') {
        $icon.hide();
      } else {
        $icon.show();
      }
    });
  }

  function _initClearButton() {
    var $inputClearBtns = $(".js-input-clear");
    var $clearElements = $inputClearBtns.siblings("input, textarea");

    $clearElements.each(function(index, clearEl) {
      var clearBtn = $(clearEl).siblings('.js-input-clear');
      if ($(clearEl).val()) {
        clearBtn.show();
      }else{
        clearBtn.hide();
      }
    });

    $clearElements.on('keyup blur', function() {
      var $this = $(this);
      var clearBtn = $this.siblings('.js-input-clear');
      if ($this.val() !== '') {
          clearBtn.show();
      } else {
          clearBtn.hide();
      }
    });

    $inputClearBtns.on('click',function () {
      var $this = $(this);
      $this.siblings('textarea, input').val('').trigger("change"); 
      $this.siblings('textarea, input').trigger('blur');

      $this.hide();
      //devolver el label a su posición natural si se elimina el texto y no hay placeholder
      if(!$this.closest('.form-group.labelup').find('input').attr("placeholder")) {
      $this.closest('.form-group.labelup').find('label').removeClass("focus");
      }
    });
  }

  function validateNumberDocument(docType, docuNumber) {
  var isValid = false;
  var numero;
  var letter;
  var letra;
  var docTypeLowerCase = docType.toLowerCase();
  if(docTypeLowerCase === "dni" || docTypeLowerCase === "nie") {
    numero = docuNumber.substr(0,docuNumber.length-1);
    numero = numero.replace('X', 0);
    numero = numero.replace('Y', 1);
    numero = numero.replace('Z', 2);
    letter = docuNumber.substr(docuNumber.length-1, 1).toUpperCase();
    numero = numero % 23;
    letra = 'TRWAGMYFPDXBNJZSQVHLCKET';
    letra = letra.substring(numero, numero+1);
    isValid = (letra !== letter) ? false : true;
  } else {
    isValid = true;
  }
  return isValid;
}

  /*** Validacion mayoría de edad ***/
  /**
   * Validate day, month and year to check if user is under 18 years old
   * @param  {Object}  jQuery selector containing the birthday date
   * @return {Boolean} true if user is Under 18 years old
   */

  function customCheckUnderAge($datepickerSelector){
    return $datepickerSelector.selectorDatepicker('isUnderAge');
  }


  // Public API
  return {
    init: init,
    validateNumberDocument: validateNumberDocument,
    customCheckUnderAge: customCheckUnderAge
  };
})();

// Document Ready
$(document).ready(function () {
  commonFormSetup.init();
}); // FIN del document.ready


/*** 9. Funcion para hacer scroll hacia el primer error encontrado en el formulario ***/
function scrollToFistError($form) {
  var moveToOffset;
  if ( $form.find("div.has-error:not(.js-no-scroll):visible").length > 0 ) {
    moveToOffset = $form.find("div.has-error:not(.js-no-scroll):visible").eq(0).offset().top - 90;

    $("html, body").animate({
        scrollTop: moveToOffset,
        useTranslate3d:true
    }, 200, "linear", function() {
        toggleLoadingButton($form, false);
    });
  }
}

/*** 10. Functon to disable/enabled button to show/hide loading ***/
function toggleLoadingButton($form, isDisabled) {
    var $bottonSubmit = $form.find("button[type=submit]");
    $bottonSubmit.prop("disabled", isDisabled);
}

/*** 11. Validacion DNI y NIE ***/
/**
 * Validate a document number regarding the doc type
 * @param  {[string]} docType    [Tipe of document (DNI, NIE...)]
 * @param  {[string]} docuNumber [Document number to evaluate]
 * @return {[boolean]} isValid [Is o not a valid document]
 */


function validateDate($el) {
  var $calendar = $el.parent().siblings(".responsive-calendar-wrap");
  var isValid;

  //si el campo fecha no esta listo para validar
  //ha perdido el foco pero estamos 'jugando' con el datepicker
  //hacemos un delay de 200ms para que de tiempo al datepicker a ocultarse (si es el caso)
  // y entonces añadimos la clase y lanzamos el evento focusout que lanza la validación
  //si esta preparado para validarse, eliminamos la clase que lo indica y validamos.
  if(!$el.hasClass("readyValidate")) {
    setTimeout(function() {
      $el.addClass("readyValidate");
      if($el.val().length < 1 && !$calendar.hasClass("active")) {
        $el.trigger('focusout');
      }
    }, 200);
  } else {
    $el.removeClass("readyValidate");
    isValid = $el.val() ? null : "error";
    return isValid;
  }
}


/**
 * Custom validator for a group of checkboxes. Select at least a
 * number of checkboxes. It requires a fieldset to group the checkboxes
 * @param  {[type]} $el [description]
 * @return {[type]}     [description]
 */
function validateMinCheckbox($el){
  var fieldsetName = $el.data('fieldset');
  var fieldset = this.$element.find(`[name="${fieldsetName}"]`);
  var minCheckbox = parseInt($el.data("mincheckbox"));
  var checkedCheckboxes = fieldset.find('input[type="checkbox"]:checked:visible');
  if(isNaN(minCheckbox)){
    return;
  }
  if(checkedCheckboxes.length < minCheckbox) {
    return 'error';
  }
}

/*** 12. Override Validator scroll function ***/
$.fn.validator.Constructor.prototype.focusError = function () {
  if (!this.options.focus) return;

  var $input = this.$element.find(".has-error :input:visible:not(button):first")
  .add(".has-error :input[type='radio']:not(:visible):first")
  .add(".has-invalid-datepicker-error:first")
  .add(".has-error .bootstrap-select button:visible:first").first();

  if ($input.length === 0) return;

  $('html, body').animate({scrollTop: $input.offset().top - $.fn.validator.Constructor.FOCUS_OFFSET}, 250, function() {
    $input.focus();
  });
};

/**
 * Custom validator for an input of multiple emails separated by ','
 * @param  {[type]} $el [description]
 * @return {[type]}     [description]
 */
function validateMultipleEmails($el) {
  var isValid;
  var emailStrings = $el.val().split(',');
  var emailRegExp = new RegExp('[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,4}$');

  emailStrings.forEach((emailString) => {
    if (!emailRegExp.test(emailString)) {
      isValid = 'error';
    }
  });

  return isValid;
}

function validateBookingRange($form) {
  let $checkin = $form.find("input.js-selected-checkin");
  let $checkout = $form.find("input.js-selected-checkout");
  let $rangeWrapper = $form.find(".js-calendar-booking-input");
  let $errorMessage = $rangeWrapper.siblings(".help-block");
  const isValidDate = ($input) => {
    let date = $input.val();
    let isValid = true;
    if(!date) {
      isValid = false;
    } else {
      isValid =  moment(date,'DD/MM/YYYY').isValid();
    }
    return isValid;
  };
  let isValidInitialDate = isValidDate($checkin);
  let isValidFinalDate = isValidDate($checkout);
  let isError;

  if(isValidInitialDate && isValidFinalDate) {
    $errorMessage.hide();
    $rangeWrapper.removeClass('has-error').addClass("has-success");
    isError = false;
  } else {
    $errorMessage.show();
    $rangeWrapper.addClass('has-error has-warning').removeClass("has-success");
    isError = true;
  }

  return isError;

  //return (isValidInitialDate && isValidFinalDate);
}

function validateLocation($el) {
  let isError = false;
  let matchValue = $el.data("search"); // foo
  let $locationWrapper = $el.parents('.form-group');
  let $errorMessage = $el.siblings(".help-block");
  let errorHtml = `<ul class="list-unstyled"><li>${$el.data('search-error')}</li></ul>`;

  if ($el.val() && ($el.val() !== matchValue)) {
    if(!$errorMessage.length) {
      $errorMessage = $('<div class="help-block with-errors side">');
      $locationWrapper.append($errorMessage);
    }
    $errorMessage.html(errorHtml).show();
    $locationWrapper.addClass('has-error has-warning').removeClass("has-success");
    isError = true;
    
  } else {
    $errorMessage.html('').hide();
    $locationWrapper.removeClass('has-error').addClass("has-success");
    isError = false;
  }

  return isError;

}



/*** 12. Override Validator function ***/
/**
 * @description required fieldas will be validated only on focus event unless the field has "data-validate-all-events" attribute set to true
 *              If the field touched is a fake select(selectpicker) we will get the select element instead the trigger dropdown
 * @param {object} e - javascript object with the event data
 */
$.fn.validator.Constructor.prototype.onInput = function(e) {
  var self = this;
  var $el = $(e.target);
  var deferErrors = e.type !== 'focusout';

  if($el.hasClass("dropdown-toggle")) {
    $el = $('#' + $el.data("id"));
  }

  if (!this.$inputs.is($el)) {
    return;
  }

  if(e.type === 'focusout' || $el.data("validate-all-events")) {
    this.validateInput($el, deferErrors).done(function () {
      self.toggleSubmit();
    });
  }
};

$.fn.validator.Constructor.prototype.focusError = function(e) {
  var $modal;
  if($('body').hasClass("modal-open")) {
    $modal = this.$element.parents(".modal");
  }


  //var $input = this.$element.find(".has-error :input:first");
  var $inputWrapper = this.$element.find(".has-error:visible:first");
  var $input = $inputWrapper.find("input:not(.js-no-scroll):first");

  if (!this.options.focus) {
    return;
  }

  if (!$input || ($input.length && $input.length) === 0) {
    return;
  }

  //$('html, body').animate({scrollTop: $input.offset().top - Validator.FOCUS_OFFSET}, 250);
  if($input && $input.length > 0) {
    if($modal && $modal.length) {
      $modal.animate({
        scrollTop: {scrollTop: $input.offset().top - 20}
      }, 250);
    } else {
    $('html, body').animate({scrollTop: $input.offset().top - 20}, 250);
    }
    if(!virtualKeyboardDetector.isVirtualKeyboardVisible()) {
    $input.focus();
  }
  }
};

/**
 * EY
 * TEMPLATE INJECT 
 * @type {Module pattern}
 * @include: 
 * 		getTemplate()
 */
var templatesRoom = (() => {
    var _template = function (template, data) {
        var cursor = 0,
            code = "var r=[];\n",
            stack = [],
            re = /\{\{(.*?)\}\}/gmi;
        var tpl = _parseTemplate(template); // reemplazo las comillas dobles por simples
        var variable = function (line, obj) {
            return line == '.' ? obj : eval("try{obj." + line + ";} catch(e){try{this." + line + ";} catch(e){}}");
        };
        var block = function (obj) {
            var args = Array.prototype.slice.call(arguments, 1),
                out = '';

            if (Array.isArray(obj)) {
                for (var i = 0, len = obj.length; i < len; i++) {
                    var el = obj[i];
                    for (var i2 = 0, len2 = args.length; i2 < len2; i2++) {
                        out += typeof args[i2] === 'function' ? args[i2].call(null, el) : args[i2];
                    }
                }
            } else if (obj) {
                for (var i = 0, len = args.length; i < len; i++) {
                    out += typeof args[i] === 'function' ? args[i].call(null, obj) : args[i];
                }
            }

            return out;
        };
        var add = function (line, tag) {
            if (tag) {
                if (line.charAt(0) === '#') {
                    code += stack.length ? ", block(data." + stack + "." + line.slice(1) : "r.push(block(data." + line.slice(1);
                    stack.push(line.slice(1));
                } else if (line.charAt(0) === '/') {
                    stack.pop();
                    code += stack.length ? ")" : "));\n";
                } else {
                    if (stack.length)
                        code += ', variable.bind(data, "' + line + '")';
                    else
                        code += line === '.' ? "r.push(el || data);\n" : "r.push(data." + line + ");\n";
                }
            } else {
                if (stack.length)
                    code += ', "' + line.replace(/"/g, '"') + '"';
                else
                    code += line != '' ? 'r.push("' + line.replace(/"/g, '"') + "\");\n" : '';
            }
        };

        while (match = re.exec(tpl)) {
            add(tpl.slice(cursor, match.index));
            add(match[1], true);
            cursor = match.index + match[0].length;
        }

        add(tpl.substr(cursor, tpl.length - cursor));
        code += 'return r.join("");';
        try {
            result = eval('(function(data){' + code + '})');
        } catch (err) {
            console.error("'" + err.message + "'", " in \n\nCode:\n", code, "\n");
        }
        return result;
    };
    var _parseTemplate = function(template) {
        // quito comentarios maqueta
        tpl = template.replace(new RegExp(
            '<!--[\\s\\S]*?(?:-->)?' +
            '<!---+>?' +
            '|<!(?![dD][oO][cC][tT][yY][pP][eE]|\\[CDATA\\[)[^>]*>?' +
            '|<[?][^>]*>?',
            'g'), "");
        // remplazo comillas dobles por simples
        tpl = tpl.replace(new RegExp("\"", "g"), "'");
        // Quito salos de linea
        tpl = tpl.replace(new RegExp(/\r?\n|\r/g, "g"), "");
        return tpl;
    }
    var getTemplate = function (tpl, data) {
        return _template(tpl)(data);
    };
    return {
        getTemplate: getTemplate
    };
})();
/**
 * Arrival Module
 * @return {[type]} [description]
 */
var mArrival = (function () {
  var mArrivalView = $('.m-arrival');

  /**
   * Init Fn
   * @return {[type]} [description]
   */
  function init() {
    mArrivalView.find('form').validator({
      disable: false
    }).on('submit', function(e) {
        var $form = $(this);
        toggleLoadingButton($form, true);
      if (e.isDefaultPrevented()) {
        toggleLoadingButton($form, false);
      } else {
        // Invalid Form
      }
    });
  }

  // Public API
  return {
    init: init
  };  

})();

$(function() {
  mArrival.init();
});

// JS object
var mCioRoomSelected = (function(){
    // Elements
  var mCioRoomSelectedModal = $('#modal-room-selected');
  var mCioRoomModalHeader = mCioRoomSelectedModal.find('.modal-header');
  var mCioRoomBackButton = mCioRoomSelectedModal.find('a.btn-back');

  // Consts
  // capturo plantilla slide
  const ROOM_TEMPLATE_SELECTOR = $(".sidebar-panel").find(".sidebar-panel-body");
  const ROOM_TEMPLATE = ROOM_TEMPLATE_SELECTOR.html();
  ROOM_TEMPLATE_SELECTOR.html(''); // Vacio el contenido despues de recuperar el tpl

  // capturo plantilla modal
  const ROOM_TEMPLATE_SELECTOR_MODAL = $("#modal-room-selected").find(".modal-body");
  const ROOM_TEMPLATE_MODAL= ROOM_TEMPLATE_SELECTOR_MODAL.html();
  ROOM_TEMPLATE_SELECTOR_MODAL.html(''); // Vacio el contenido despues de recuperar el tpl

  var hotelBackCode, reservationId;



  // Template URLS
  var ROOM_INFO_URL = 'i-cio-room-selected.html';
  var ROOM_UPSELLING_INFO_URL = 'i-cio-room-selected-upselling.html';
  var ROOM_MORE_INFO_URL = 'i-cio-room-selected-info.html';

  // Consts
  const BTN_PREV_CLS = 'with-btn-black';
  const MODAL_TITLE_CLS = 'modal-title';
  const MODAL_BODY_CLS = 'modal-body';
  const MORE_INFO_BUTTON_CLS = 'js-more-info-button';
  const DEFAULT_MODAL_TITLE = mCioRoomModalHeader.find('.' + MODAL_TITLE_CLS).html();

  // Events
  const MODAL_CLOSE_EVENT = 'modal.close';

  // Room data
  var roomData = {
    description: ''
  };

  // View states
  var modalState;
  var prevState;

  // Default room
  var roomDefault = null;


  //selected modal template
  var selectedModalTemplate = ROOM_INFO_URL;

  /**
   * Init Fn
   * @return {[type]} [description]
   */
  function init() {

    hotelBackCode = displayObj.hotelBackCode;
    reservationId = displayObj.reservationId;


    // Init HTML injector
    mCioRoomSelectedModal.htmlInject();
    // Listeners
    mCioRoomSelectedModal.on('shown.bs.modal', _initialRoomModalState);
    mCioRoomSelectedModal.on('hide.bs.modal', _onCloseSelectedRoomModal);
    mCioRoomBackButton.on('click', goBackHandler);
  }

  function setModalSelectedTemplate(roomType, tplUrl) {
    //selectedModalTemplate = (roomType === "upselling") ? ROOM_UPSELLING_INFO_URL : ROOM_INFO_URL;
    selectedModalTemplate = (roomType) ? ((roomType === "upselling") ? ROOM_UPSELLING_INFO_URL : ROOM_INFO_URL) : ROOM_MORE_INFO_URL;
  }

  function setModalSelectedTemplateByTpl(tplUrl) {
    selectedModalTemplate = tplUrl;
  }

  /**
   * Set initial view
   * @constructor
   * @return      {[type]} [description]
   */
  function _initialRoomModalState() {
    navigate(selectedModalTemplate);
  }

  /**
   * Use html inject to perform a view navigation
   * @param  {[string]} tplUrl [Template url to navigate]
   * @return {[type]}        [description]
   */
  
   function navigate(tplUrl) {
      // loading
      mCioRoomSelectedModal.htmlInject('toggleLoading', true, $("#modal-room-selected").find(".modal-body"))
      // busco la habitación seleccionada
      let roomSelect = $(".is-selected").find('.room-content').data("room");   
      mChooseRoom.hiddenForm.val(roomSelect);     
      // call api con 
      let url = apiUrlPath+"/OCI/"+reservationId+"/"+hotelBackCode+"/room/"+roomSelect + "?origin=" + ((isMobile.any()) ? "" : "desktop") + "&language=" + language;
     
      promise = $.ajax({  
        type: "GET",
        url: url,    
        crosdomain: false,   
        async:true,
        dataType: "json"     
      });

      promise.then(function (response) {
        // Creo el json para parsear la plantilla
        var floorbuilding = mChooseRoom.getFloorBuilding(); // saco la planta y el edificio

        let txtFloor=(isNaN(parseInt(floorbuilding[1]))) ? floorbuilding[1] : parseInt(floorbuilding[1]);
        let txyBuilding=(isNaN(parseInt(floorbuilding[0]))) ? floorbuilding[0] : parseInt(floorbuilding[0]);
        var data = {
          lblOCIYSAltRoomImage: "<img src='" + response.image + "?output-quality=70&resize=1000:*&composite-to=center,center|1000:402&background-color=white' >",
          roomNumber: roomSelect,
          roomName: response.roomName,
          lblOCIYSFloor: txtFloor,
          lblOCIYSBuilding: txyBuilding,
          lblOCIYSAltPeople: response.features[0].description,
          lblOCIYSAltRoomSize: response.features[1].description,
          lblOCIYSAltBedType: response.features[2].description
        };
   
        var templateSel = ROOM_TEMPLATE;
        if(tplUrl=="i-cio-room-selected-info.html") {
          var tplroomicon = $(ROOM_TEMPLATE_MODAL);
          var lista = tplroomicon.find(".room-detail-features").find('.room-icons');
          var src = tplroomicon.find(".room-detail-features").find('.room-icons').attr("data-src");
          var listbullet = tplroomicon.find(".room-detail-more-features").find('.list-bullets');
          
          $.each(response.featuresHighlighted, function(index, value)
          {
           lista.append(`<li class="item-room-icons">
            <div class="container-icon"><img src="${src}${value.iconFileName}.svg"></div><span>${value.description}</span>
            </li>`);     
          });
          $.each(response.services, function(index, value)
          {
            listbullet.append(`<li>${value.text}</li>`);     
          });
          templateSel = "<div class='m-cio-room-selected-info'>"+ tplroomicon.html() + "</div>";
        } 
        // parseo la plantilla
        var output = templatesRoom.getTemplate(templateSel, data);
        //inyecto el html
        mCioRoomSelectedModal.htmlInject('injectHTMLByJson', '.' + MODAL_BODY_CLS, output, _onNavigationComplete);            
      }, function (error) {
        //console.log("promesa incorrecta", error);
      }).always(function () {
        //console.log("esto se ejecuta falle o no la promesa");
        //loading = false;
      });

        // Update states
        prevState =  modalState;
        modalState = tplUrl;
   }



  /**
   * Callback when a navigation by html injection is complete
   */
  function _onNavigationComplete() {
    // Trigger update content
    mCioRoomSelectedModal.trigger(mModals.MODAL_UPDATE_CONTENT_EVENT);
    switch (modalState) {
      case ROOM_INFO_URL:
        _onRoomInfoShow();
      break;
      case ROOM_UPSELLING_INFO_URL:
        mCioRoomSelectedUpgrade.init();
        _onRoomInfoShow();
      break;
      case ROOM_MORE_INFO_URL:
        _onMoreInfoShow();
      break;
    }
  }

  /**
   * Click handler for the more info button
   * @param  {[object]} e [JS event]
   */
  function _handlerMoreInfoButton() {
    navigate(ROOM_MORE_INFO_URL);
  }

  /**
   * Callback when performing navigation to the room info view
   * @constructor
   * @return      {[type]} [description]
   */
  function _onRoomInfoShow() {
    toggleNavigationHeader(DEFAULT_MODAL_TITLE, false);
    roomData.description = mCioRoomSelectedModal.find('.js-room-description').html();
    // More info listener
    mCioRoomSelectedModal.find('.'+ MORE_INFO_BUTTON_CLS).on('click', _handlerMoreInfoButton);
  }

  /**
   * Callback when performing navigation to the more info view
   * @constructor
   * @return      {[type]} [description]
   */
  function _onMoreInfoShow() {
    let roomDescription
    toggleNavigationHeader(roomData.description, true);
  }

  /**
   * Change the modal header to a navigation header with prev button
   */
  function toggleNavigationHeader(headerText, prevButton) {
    // Previous button
    if (prevButton) {
      mCioRoomModalHeader.addClass(BTN_PREV_CLS);
    } else {
      mCioRoomModalHeader.removeClass(BTN_PREV_CLS);
    }
    // Header text
    if (headerText && headerText.length > 0) {
      mCioRoomModalHeader.find('.' + MODAL_TITLE_CLS).html(headerText);
    }
  }

  /**
   * Set the room data information
   * @param {[object]} roomData [Room object with the information]
   */
  function setRoomData(room) {
    roomData = room;
  }

  /**
   * Get the room data
   * @return {[object]} [Room object with the information]
   */
  function getRoomData() {
    return roomData;
  }

  /**
   * Return to the previous modal state
   */
  function goBackHandler() {
    navigate(prevState);
  }

  /**
   * Handler when the modal is closed. Trigger the custom event
   * @param       {[type]} e [description]
   * @constructor
   * @return      {[type]}   [description]
   */
  function _onCloseSelectedRoomModal(e) {
    roomData = {};
    mCioRoomSelectedModal.trigger(MODAL_CLOSE_EVENT);
  }
  /**
   * Return template slide for m-panel-cio-room-selected
   */
  function getSlideTpl(){
    return ROOM_TEMPLATE;
  }
  
  // Public API
  return {
    init: init,
    getRoomData: getRoomData,
    setRoomData: setRoomData,
    goBackHandler: goBackHandler,
    toggleNavigationHeader: toggleNavigationHeader,
    setModalSelectedTemplate: setModalSelectedTemplate,
    navigate: navigate,
    selectedModalTemplate:selectedModalTemplate,
    MODAL_CLOSE_EVENT: MODAL_CLOSE_EVENT,
    ROOM_MORE_INFO_URL: ROOM_MORE_INFO_URL,
    setModalSelectedTemplateByTpl: setModalSelectedTemplateByTpl,
    mCioRoomBackButton: mCioRoomBackButton,
    getSlideTpl: getSlideTpl
  };
})();

$(()=> {
  if(typeof displayObj !== 'undefined' && displayObj){
    //mCioRoomSelected.init();
  } 
});

var selectedRoomPanel = (function () {
  // Elements
  var panel = $('#sidebar-panel');
  var panelHeader = panel.find('.sidebar-panel-header');
  var togglePanelElement = $('[data-toggle="sidebar-panel"]');
  var togglePanelButton = $('.sidebar-panel-toggle[data-toggle="sidebar-panel"]');
  var closePanelButton = $('#sidebar-panel .btn-ico');
  var mCioRoomSelectedModal = $('#modal-room-selected');
  var chooseOtherRoomButton = panel.find('button.js-choose-other-room');

  var hotelBackCode, reservationId;


  //translations
  var panelTexts = {
    header: {
      preselected: panel.data('room-preselected-translation'),
      selected: panel.data('room-selected-translation')
    }
  };
  //status of the room (preselected or selected);
  var roomStatus = "preselected";

  // View states
  var panelState;
  var prevState;

  // Consts

  const ROOM_TEMPLATE = mCioRoomSelected.getSlideTpl();

  // Template URLS
  const ROOM_INFO_URL = 'i-cio-room-selected.html';
  const ROOM_UPSELLING_INFO_URL = 'i-cio-room-selected-upselling.html';
  const PANEL_TITLE_CLS = 'sidebar-panel-header-title';
  const PANEL_BODY_CLS = 'sidebar-panel-body';
  const MORE_INFO_BUTTON_CLS = 'js-more-info-button';

  //panel custom event
  const PANEL_UPDATE_CONTENT_EVENT = 'panel.update.content';
  const PANEL_CLOSE_EVENT = 'panel.close';


  //selected modal template
  var selectedPanelTemplate = ROOM_INFO_URL;

  function init() {
    hotelBackCode = displayObj.hotelBackCode;
    reservationId = displayObj.reservationId;
    // Init HTML injector
    panel.htmlInject();
    mCioRoomSelectedModal.htmlInject();
    // Listeners
    panel.on(PANEL_UPDATE_CONTENT_EVENT, _loadRoomPanel);
    togglePanelElement.on('click', _togglePanel);
    closePanelButton.on("click", closePanel);
    chooseOtherRoomButton.on("click", closePanel);
  }

  /**
   * @description method to toggle the side-panel
   */
  function _togglePanel() {
    panel.toggleClass('is-hidden');
  }


  /**
   * @description method to toggle the side-panel
   */
  function hidePanel() {
    panel.addClass('is-hidden');
  }

  /**
   * @description method to close the side-panel
   */
  function closePanel() {
    mChooseRoom.hiddenForm.val('');
    // panel.addClass('off').removeClass('on');
    panel.addClass('is-hidden');
    togglePanelButton.addClass('hidden');
    panel.trigger(PANEL_CLOSE_EVENT);
  }

  /**
   * @description method to show the panel with the correct content
   * @param {string} roomType - the type of the room (room or upselling)
   * @param {string} status      - the estatus of the room (preselected or selected)
   */
  function showPanel(roomType, status) {
    roomStatus = status;
    _setPanelSelectedTemplate(roomType);
    panel.trigger(PANEL_UPDATE_CONTENT_EVENT);
    togglePanelButton.removeClass('hidden');
  }

  //private methods
  /**
   * @description load the content of the side-panel with the correct template for the room type
   */
  function _loadRoomPanel() {
    // loading
    panel.htmlInject('toggleLoading', true, $(".sidebar-panel").find(".sidebar-panel-body"))
    // busco la habitación seleccionada
    let roomSelect = $(".is-selected").find('.room-content').data("room");
    mChooseRoom.hiddenForm.val(roomSelect);
    // call api con   
    let url = apiUrlPath + "/OCI/" + reservationId + "/" + hotelBackCode + "/room/" + roomSelect  + "?origin=" + ((isMobile.any()) ? "" : "desktop") + "&language=" + language;
    promise = $.ajax({  
      type: "GET",
      url: url,    
      crosdomain: false,   
      async:true,
      dataType: "json"    
    });

    promise.then(function (response) {
      // Creo el json para parsear la plantilla
      var floorbuilding = mChooseRoom.getFloorBuilding(); // saco la planta y el edificio
      let txtFloor = (isNaN(parseInt(floorbuilding[1]))) ? floorbuilding[1] : parseInt(floorbuilding[1]);
      let txyBuilding = (isNaN(parseInt(floorbuilding[0]))) ? floorbuilding[0] : parseInt(floorbuilding[0]);
      var data = {
        lblOCIYSAltRoomImage: "<img src='" + response.image + "?output-quality=70&amp;resize=870:*&amp;composite-to=center,center|870:350&amp;background-color=white'>",
        roomNumber: roomSelect,
        roomName: response.roomName,
        lblOCIYSFloor: txtFloor,
        lblOCIYSBuilding: txyBuilding,
        lblOCIYSAltPeople: response.features[0].description,
        lblOCIYSAltRoomSize: response.features[1].description,
        lblOCIYSAltBedType: response.features[2].description
      };

      // parseo la plantilla
      var output = templatesRoom.getTemplate(ROOM_TEMPLATE, data);
      //inyecto el html    
      panel.htmlInject('injectHTMLByJson', '.' + PANEL_BODY_CLS, output, _onNavigationComplete);
      // Update states
    }, function (error) {
      //console.log("promesa incorrecta", error);
    }).always(function () {
      //console.log("esto se ejecuta falle o no la promesa");
      //loading = false;
    });
    prevState = panelState;
    panelState = selectedPanelTemplate;
  }

  /**
   * Callback when a navigation by html injection is complete
   */
  function _onNavigationComplete() {
    // Trigger update content
    mCioRoomSelectedModal.trigger(mModals.MODAL_UPDATE_CONTENT_EVENT);
    switch (panelState) {
      case ROOM_INFO_URL:
        _onRoomInfoShow();
        break;
      case ROOM_UPSELLING_INFO_URL:
        mCioRoomSelectedUpgrade.init();
        _onRoomInfoShow();
        break;
    }
  }

  /**
   * Callback when performing navigation to the room info view
   * @constructor
   * @return      {[type]} [description]
   */
  function _onRoomInfoShow() {
    panel.find('.' + PANEL_TITLE_CLS).html(panelTexts.header[roomStatus]);
    // More info listener
    panel.find('.' + MORE_INFO_BUTTON_CLS).on('click', _handlerMoreInfoButton);
    panel.removeClass('is-hidden');
  }

  /**
   * @description handle the behaviour of the show more information button
   */
  function _handlerMoreInfoButton() {
    mCioRoomSelected.setModalSelectedTemplate();
    mCioRoomSelectedModal.modal('show');
    trackOCIZoomMoreAbout(Globals.page_section, reservationIdOci);
  }

  /**
   * @description set the correct template for each type of room
   * @param {string} roomType
   */
  function _setPanelSelectedTemplate(roomType) {
    selectedPanelTemplate = (roomType === "upselling") ? ROOM_UPSELLING_INFO_URL : ROOM_INFO_URL;
  }

  return {
    init: init,
    closePanel: closePanel,
    showPanel: showPanel,
    hidePanel: hidePanel,
    PANEL_CLOSE_EVENT: PANEL_CLOSE_EVENT
  };
})();


$(function () {
  if ($('[data-toggle="sidebar-panel"]').length && (typeof displayObj !== 'undefined' && displayObj)) {
    // selectedRoomPanel.init();
  }
});
/**
 * JQuery plugin for the floor map in choose your room pages
 * Options:
 *  - data: json data with the floor map data
 * @param  {[type]} $ [JQuery reference]
 * @return {[type]}   [description]
 */

 //TODO: el zoom out no esta centrando en el mapa

$.widget('nh.floorMap', {
  // Default options
  //data - el json de la planta
  //streetSize - el tamaño de las calles
  //defaultMargin - margen por defecto del elemento mapa
  //ratio - el ratio por el que se va a multiplicar el tamaño de habitaciones y estructura
  //adjustWindow - si el contenedor del mapa se va a ajustar a la altura de la ventana o no
  //offsetHeight - si el contenedor del mapa se va a ajustar a la altura de la ventana y hay que restarle altura, aquí se indica
  //maxScreenWidth - Anchura de la ventana en la que el contenedor del mapa se va a ajustar a la altura de la ventana, por encima no se ajustará
  //showRoomDetail - funcion a la que llamar si se ha pasado una function para mostrar el detalle de la habitación al pulsar sobre ella
  //scaleZoomOut - La escala del zoom out. Los tamaños del los elementos del mapa se multiplicaran por esta escala para generar su tamaño
  //scaleZoomIn - La escala del zoom In. Los tamaños del los elementos del mapa se multiplicaran por esta escala para generar su tamaño
  //zoomType - El tipo de zoom aplicado al mapa
  //initial - Si el renderizado del mapa es inicial o no
  options: {
    "data": null,
    "streetsSize": 140,
    "defaultMargin": 150,
    "ratio": 8,
    "adjustWindow": false,
    "offsetHeight": null,
    "maxScreenWidth": null,
    "showRoomDetail": null,
    "scaleZoomOut": 0.5,
    "scaleZoomIn": 1,
    "zoomType": "In",
    "initial": true
  },
  previousSelectedRoom: null,
  selectedRoomData: null,
  preselectedRoomInfo: null,
  mapContentMargin: {
    leftRight: 0,
    topBottom: 0
  },
  preferencesCoor: {"x": null, "y": null}, //coordenadas de la habitación con preferencias
  centered: { "top": 0, "left": 0}, //coordenadas de centrado del mapa
  //flag para saber si tenemos que centrar el mapa en la habitación preseleccionada o no y si tenemos que cargar sus datos o no
  //cuando generamos el plano. Solo será true si no hemos seleccionado otra habitación.
  keepPreselectedRoom: false,
  centerToPoint: false, //flag para saber si tenemos que centrar el mapa en un punto pulsado (zoomOut to zoomIn)
  newMapFetched: false, //flag para saber si se ha pedido una nueva planta a traves del selector de planta;
  /**
   * @description deselect  the current selected room
   */
  deselectRoom: function() {
    if(this.previousSelectedRoom) {
      this.previousSelectedRoom.removeClass('is-selected');
      this.previousSelectedRoom = null;
      this.selectedRoomData = null;
      this.preselectedRoomInfo.preselected = false;
      this.keepPreselectedRoom = false;
    }
  },
   /**
   * @description Return the selected room object
   * @return {object} json data of the selected room
   */
  getSelectedRoomData: function() {
    return this.selectedRoomData;
  },
  /**
   * @description render the map in the view
   */
  renderMap: function() {
    var structureData;
    var zoomClass = this.options.zoomType.toLowerCase();

    //dependiendo del zoom aplicado al mapa, calculamos los tamaños de estructura, habitaciones
    this.setZoomMapSize(this.options.zoomType);

    //obtenemos los datos de la estructura del mapa y la creamos como objeto html añadiendola al mapa
    structureData = this._getStructureData(this.options.data.floor.structure);
    this.floorMapCanvas = $(this._getMapStructure(structureData)).show();
    this.floorMap.css({
      height: structureData.height
    }).empty().append(this.floorMapCanvas);

    //dibujamos las calles
    this._drawStreets(this.options.data.streets);
    //dibujamos las habitaciones
    this._drawRooms(this.options.data.rooms);

    //seteamos el tamaño del mapa y del contenedor del mapa
    this._setMapSize();

    //aplicamos interacción al mapa
    this._applyInteractions();

    //cargamos los datos de la habitación seleccionada en el panel lateral (si se deben cargar) y lo mostramos (si se debe mostar)
    //si hemos jugado con el zoom (in-out) y el panel está oculto, lo seguimos manteniendo oculto
    //si el panel debe ser mostrado, mantenemos el titulo del panel actualizado (seleccionada, preseleccinada.)
    this.floorMap.trigger("onMapLoaded", [this.keepPreselectedRoom]);

    this.element.toggleClass(this._getZoomClass, zoomClass);
    this.newMapFetched = false;
    this.mapMoved = false;

    //vamos a guardarnos las coordenadas antiguas del zoom out y zoom in
    if(this.options.zoomType === "In") {
      this.floorMapContent.data("zoom-in-top", this.preferencesCoor.y);
      this.floorMapContent.data("zoom-in-left", this.preferencesCoor.x);
      this.floorMapContent.data("zoom-out-top", this.preferencesCoor.y * this.options.scaleZoomOut);
      this.floorMapContent.data("zoom-out-left", this.preferencesCoor.x * this.options.scaleZoomOut);
    } else {
      this.floorMapContent.data("zoom-in-top", this.preferencesCoor.y / this.options.scaleZoomOut);
      this.floorMapContent.data("zoom-in-left", this.preferencesCoor.x / this.options.scaleZoomOut);
      this.floorMapContent.data("zoom-out-top", this.preferencesCoor.y);
      this.floorMapContent.data("zoom-out-left", this.preferencesCoor.x);
    }

    this.preferencesCoor = {};
  },

  /**
   * @description set the clicked room as seleccted
   */
  selectRoom: function(ev) {
    var $this = $(ev.currentTarget);
    var isSelected = $this.hasClass("is-selected");
    if(this.selectedRoomData) {
      this.selectedRoomData.selected = false;
    }
    this.options.data.rooms.some((room) => {
      //if(room.tcm === $this.data("tcm")) {
      if(room.id === $this.data("number") && !$this.hasClass("prevent-click")) {
        this.selectedRoomData = room;
        return true;
      }
    });
    //this.keepPreselectedRoom = ($this.hasClass("preselected") && this.keepPreselectedRoom) ? true : false;
    this.keepPreselectedRoom = true;
    this.preselectedRoomInfo.preselected = false;

    if($this.hasClass("prevent-click")) {
      ev.preventDefault();
      ev.stopPropagation();
      $this.removeClass("prevent-click");
      return;
    } else {
      if(!isSelected) {
        $this.addClass("is-selected");
        this.selectedRoomData.selected = true;
        if(this.previousSelectedRoom) {
          this.previousSelectedRoom.removeClass("is-selected");
        }
      }
      this.previousSelectedRoom = $this;
      this._trigger("onRoomSelected", ev, {
        // Pass additional information unique to this event, tcm of the room, room number, is is selected and room type (standard or upselling)
        roomTcm: $this.data("tcm"),
        roomNumber: $this.data("number"),
        isSelected: isSelected,
        type: $this.attr('class').indexOf("upselling") >=0 ? "upselling" : "room"
      });
    }
  },

  /**
   * @description set the correct size of the map elements due the map zoom applied
   * @param {string} zoomType - the type of the zoom of the map
   */
  setZoomMapSize: function(zoomType) {
    this._setSize(this.options.data.floor.structure, zoomType, "structure");
    this._setSize(this.options.data.rooms, zoomType, "room");
  },

  /*** PRIVATE METHODS ***/

  /**
   * @description apply the drag interaction to the map
   */
  _applyInteractions: function() {
    //constrainTo: this._getMapPosition(),
    var widget = this;
    $.pep.unbind(this.floorMapContent);
    if( (this.element.width() < this.floorMapContent.outerWidth(true)) || (this.element.height() < this.floorMapContent.outerHeight(true))) {
      this.floorMapContent.pep({
        constrainTo: this._getMapPosition(),
        startPos: this.centered,
        useCSSTranslation: false,
        shouldEase: false,
        debug: false,
        removeMargins: false,
        startThreshold: [10, 10],
        stop: this._endTouch,
        start: this._preventClickWhenDragging,
        drag: this._preventClickWhenDragging,
        widget: widget
      });
    } else {
      this.floorMapContent.css({
        top:this.centered.top,
        left: this.centered.left
      });
    }
  },

  /**
   * @description center map in the middle of the map
   * @param {object} - object with data necesary to center the map
   */
  _centerMap: function(positionData) {
    positionData.top = positionData.topAvailable / 2;
    positionData.left = (positionData.leftAvailable !== 0) ? positionData.leftAvailable / 2 : positionData.leftAvailable;
    this.centered = { 
      "top": (positionData.top * -1), 
      "left": (positionData.left * -1)
    };
  },

  /** 
   * @description center map in a specific point (room or point clicked)
   * @param {object} - object with data necesary to center the map
   */
  _centerMapInPoint: function(positionData) {
    positionData.centeredX += this.preferencesCoor.x;
    positionData.centeredY += this.preferencesCoor.y;
    positionData.left =  positionData.centeredX - (this.element.width() / 2);
    positionData.top = positionData.centeredY - (this.element.height() / 2);

    if(positionData.left < 0) {
      positionData.left = 0;
    } else if(positionData.left > positionData.leftAvailable) {
      this._setLeftMapPosition(positionData);
    }

    if (positionData.top < 0) {
      positionData.top = 0;
    } else if(positionData.top > positionData.topAvailable) {
      this._setTopMapPosition(positionData);
    }

    this.centered = { "top": (positionData.top * -1), "left": (positionData.left * -1)};
  },

  /**
   * @description remove the interactios of the map (drag events)
   */
  _clearInteractions: function() {
    $.pep.unbind(this.floorMapContent);
    this.element.css({
      "height": this.floorMapContent.height()
    });
  },

  /**
   * @description method that initialize the widget
   */
  _create: function() {
    this.floorMapContent = this.element.find('.map-content');
    this.floorMap = this.floorMapContent.find(".map");
    this.floorMapCanvas = this.floorMap.find(".maps-canvas");
    this.zoomButton = this.element.find('.zoom-button');
    this.isDrag = 0
    // Avoid multiple inits
    if (this.element.hasClass('widget-initialized')) {
      return;
    }

    this._on(this.zoomButton, {
      "click": this._toggleZoom
    });

    // Widget initialized
    this._addClass('widget-initialized');
  },

  
  /**
   * @description method to destroy the widget
   */
  _destroy: function() {
    this._removeClass('widget-initialized');
  },

  /**
   * @description method to draw the floor strees
   * @param [object] streetsData - json with the streets data
   */
  _drawStreets: function(streetsData) {
    let $floorMapContent = this.floorMapContent;
    let $streets = $floorMapContent.find("div.street");
    let $currentStreet;
    let streetHtml;

    $.each(streetsData, (key, value) => {
      $currentStreet = $streets.filter(".street-" + key);
      
      streetHtml = `<div class="street-info info-${(value.type === "city" && value.name) ? 'poi' : value.type}">
                      <p class="street-name">
                        <span>${(value.name && value.name.length > 0 && value.name !== 'null') ? value.name : "" }</span>
                      </p>
                      <span class="street-orientation ${(value.type === "city" && value.name) ? 'poi' : value.type}"></span>
                    </div>`;
      
      $currentStreet.html(streetHtml);
    });
  },

  /**
   * @description build the html of each room and add this into the map
   * @param {object} roomsData - json with the rooms data
   */
  _drawRooms: function(roomsData) {
    var roomData; //json con los datos de la habitación
    var roomContainer; //contenedor de la habitación
    var roomContent; // contenido de la habitación
    var roomClass; //clases a aplicar al contenedor de la habitación
    var selectableRoomsList = ["none", "room", "upselling", "duplex", "duplex-upsell", "duplex-upselling"];//lista de habitaciones seleccionables. No son elementos comunes

    this.keepPreselectedRoom = false;

    for(let x = 0; x < roomsData.length; x++) {
      roomContainer = $("<div></div>"); 
      roomContent = null; 
      roomClass = "room ";
      roomData = roomsData[x];

      this._setUpRoomContainer(roomData, roomContainer);

      if(selectableRoomsList.indexOf(roomData.special) >= 0) { //si no es un elemento comun -> habitación estandar o upselling
        //si la habitación esta disponible le damos el compotamiento del click sobre ella y guardamos su clase
        //si no no tiene click y otra clase para indicar que no esta disponible
        if(roomData.available) {
          roomClass += "room-available";
          roomContainer.off("click touchend");
          if(this.options.zoomType === "In") {
            roomContainer.on("click touchend", this.selectRoom.bind(this));
          }
        } else {
          roomClass += "room-noavailable";
        }

        //si es habitacion preferencias
        roomClass += (roomData.preferences) ? "-preferences" : "";

        //si es upselling o no
        roomClass += (roomData.special.indexOf("upselling") >=0) ? "-upselling" : "";

        //si es duplex o no
        roomClass += (roomData.special.indexOf("duplex") >=0) ? " room-duplex" : "";

        //room doors
        if(roomData.door) {
          roomClass += " door door-" + roomData.door;
        }
      


        if(this._isSelectedRoom(roomData)) {
          //seteamos la habitación como seleccionada ¿hace falta?
          roomData.selected = true;

          //marcamos esta variable para centrar mapa sobre seleccionada.
          this.keepPreselectedRoom = true;

          //añadimo la clase is-selected a la lista de clases de la habitación para identificarla con estilos
          roomClass += " is-selected";

          //Guardamos los datos necesarios para dibujar la habitación en variables globales del widget
          this._saveRoomData(roomData, roomContainer);
        }

        //generamos el contenido de la habitación
        ///////////////////////////
        // EY CAMBIO LINEA 378
        //roomContent = `<div class='room-content'><span>${roomData.id || ""}</span><i></i></div>`;
        roomContent = `<div data-room='${roomData.id || ""}' class='room-content'><span>${roomData.id || ""}</span><i></i></div>`;


      } else {//si es un elmemento común
        roomClass += "room-" + roomData.special.toLowerCase();

        //generamos el contenido del elemento común
        roomContent = `<div class='room-content'><span>${roomData.description || ""}</span></div>`;
      }
      roomContainer.html(roomContent).addClass(roomClass);
      this.floorMap.append(roomContainer);
    }
  },

  /**
   * @description actions to do when the interaction with the map is finished. Save the mouse position in the page and update the init position of the map
   *              with the current position of the map
   *              If the map is in zoom-out and the user click over the map, change to zoom-in and center the map over the point clicked
   * @param {object} ev - object with the browser event data
   */
  _endTouch: function(ev) {
    var pointerCoordinates = {
      top: ev.pageY || this.ev.y,
      left:ev.pageX || this.ev.x
    };

    if(!this.initPosition) {
      this.initPosition = {
        x: this.initialPosition.left,
        y: this.initialPosition.top
      };
    }

    if(this.options.widget._isClickEvent(this)) {
      this.options.widget._goToSelectedPointInZoomInMap(pointerCoordinates);
    }

    // Ey, control de drag y evitar el prevent mobile
    if(this.isDrag < 8) $(".prevent-click").removeClass("prevent-click") // si es un click y no arrastra reseto los prevent
    this.isDrag = 0 // devuelvo su estado

    this.initPosition = {
      x: this.pos.x,
      y: this.pos.y
    };
  },

  /** 
   * @description get the correct area positon focused in the map due the zoom applied
   * @return the top and left position of the map due the zoom applied
   */
  _getAreaPosition() {
    var previousZoom = (this.options.zoomType === "In") ? "out" : "in";
    var zoomType =  (this.mapMoved) ? previousZoom : this.options.zoomType.toLowerCase();
    var zoomTypePosition = {
      left: this.floorMapContent.data("zoom-" + zoomType + "-left"),
      top: this.floorMapContent.data("zoom-" + zoomType + "-top")
    };

    if(this.mapMoved) {
      zoomTypePosition = {
        top: (this.options.zoomType === "In") ? (zoomTypePosition.top / this.options.scaleZoomOut) : (zoomTypePosition.top * this.options.scaleZoomOut),
        left: (this.options.zoomType === "In") ? (zoomTypePosition.left / this.options.scaleZoomOut) : (zoomTypePosition.left * this.options.scaleZoomOut)
      };
    }

    return zoomTypePosition;
  },

  /**
   * @description get the coordinates of the clicked point in zoom-out and move to zoom-in
   * @param {object} pointerCoordinates - object with the coordinates of the pointer clicked on the map
   */
  _goToSelectedPointInZoomInMap: function(pointerCoordinates) {
    var mapOffset = this.floorMap.offset();
    this.preferencesCoor.x = (pointerCoordinates.left - mapOffset.left) / this.options.scaleZoomOut;
    this.preferencesCoor.y = (pointerCoordinates.top - mapOffset.top) / this.options.scaleZoomOut;
    this.centerToPoint = true;
   
    this._toggleZoom();
  },

  /** 
   * @description check if the event over the map is a click and if the mapzoom is zoom-out
   * @param {object} data - object with the drag plugin data
   * @return if the event over the map is a click or not
  */
  _isClickEvent: function(data) {
    data.options.widget.mapMoved = true;
    if($.isEmptyObject(data.pos) || (data.pos.x === data.initPosition.x && data.pos.y === data.initPosition.y)) {
      data.options.widget.mapMoved = false;
      if(data.options.widget.options.zoomType === "Out") {
        return true;
      }
    }
    return false;
  },

  /** 
   * @description check if the room is selected
   * @param {object} - object with the room data
   * @return if the room is selected or not
  */
  _isSelectedRoom: function(roomData) {
    var isSelected = false;
    var isPreselected = roomData.hasOwnProperty("preselected") && roomData.preselected && this.options.initial;

    if(this.options.zoomType === "Out") {
      return false;
    }

    if(isPreselected || (this.selectedRoomData && this.selectedRoomData.id === roomData.id)) {
      isSelected = true;
    }
    return isSelected;
  },

  /**
   * @description get the map container size to avoid move map outer of these dimensions
   * @return the coordinates to constraint the map
   */
  _getMapPosition: function() {
    var wDiff = this.floorMapContent.outerWidth(true) - this.element.width(),
    hDiff = this.floorMapContent.outerHeight(true) - this.element.height();
    
    wDiff = (wDiff < 0) ? 0 : -wDiff;
    hDiff = (hDiff < 0) ? 0 : -hDiff;
 
    return [  hDiff, 0, 0, wDiff];
  },

  /**
   * @description get the map svg element with the map structure
   * @param {object} shapeData - object with the map structure svg shape data
   * @returns {string} the html code with the svg element with the map structure
   */
  _getMapStructure: function(shapeData) {
    return (`
      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" mlns:xlink="http://www.w3.org/1999/xlink" class="maps-canvas" width="${shapeData.width}" height="${shapeData.height}">
        <polyline points="${shapeData.points}" fill="#fff" stroke="#fff" stroke-width="1"></polyline>
      </svg>
    `);
  },

  /**
   * @description get the coordinates of the mouse pointer
   * @returns 
   */
  _getPointerCoordinates: function() {
    var mapContainerOffset = this.element.offset();
    var pointerCoordinates = {
      top: mapContainerOffset.top + (this.element.height() / 2),
      left: mapContainerOffset.left + (this.element.width() / 2)
    };

    return pointerCoordinates;
  },

  /**
   * @description 
   * @returns 
   */
  _getPreferencesCoordenates: function() {
    var pointerCoordinates = this._getPointerCoordinates();
    var mapOffset = this.floorMap.offset();
    return {
      x: (this.options.zoomType === "In") ? (pointerCoordinates.left - mapOffset.left) / this.options.scaleZoomOut : (pointerCoordinates.left - mapOffset.left) * this.options.scaleZoomOut,
      y: (this.options.zoomType === "In") ? (pointerCoordinates.top - mapOffset.top) / this.options.scaleZoomOut : (pointerCoordinates.top - mapOffset.top) * this.options.scaleZoomOut
    };
  },

  /**
   * @description get the data necesary to draw the floor structure
   * @param {object} structureData - json with the structure data
   * @returns a object with the coordinates to draw the floor structure and the height a width of the floor structure
   */
  _getStructureData: function(structureData) {
    var canvasWidth = 0;
    var canvasHeight = 0;
    var coor = "";
    var data;
    for(var x = 0; x < structureData.length; x++) {
        data = structureData[x];
        canvasWidth = (data.endX * this.options.ratio > canvasWidth) ? data.endX * this.options.ratio : canvasWidth;
        canvasHeight = (data.endY * this.options.ratio > canvasHeight) ? data.endY * this.options.ratio : canvasHeight;
        coor += (data.initX * this.options.ratio) + "," + (data.initY * this.options.ratio) + " " + (data.endX * this.options.ratio) + "," + (data.endY * this.options.ratio) + " ";
    }

    return {
      points: coor,
      width: canvasWidth,
      height: canvasHeight
    };
  },

  /**
   * @description get the correct zoom class due the current map zoom
   * @param {number} index - index of the element
   * @param {string} className - classList of the element
   * @param {string} state - state of the curren zoom (in or out)
   * @returns the name of the css class related with the curren map zoom
   */
  _getZoomClass: function(index, className, state) {
    var $this = $(this);
    var classList = this.classList;
    if(!classList.contains("zoom-" + state)) {
      if(!$this.hasClass("zoom-in") && !$this.hasClass("zoom-out")) {
        return "zoom-" + state;
      } else if($this.hasClass("zoom-out") && !$this.hasClass("zoom-in")) {
        $this.removeClass("zoom-out");
        return "zoom-in";
      } else if($this.hasClass("zoom-in")) {
        $this.removeClass("zoom-in");
        return "zoom-out";
      }
    } else {
      return classList;
    }
  },

  /** 
   * @description Check if the map should be centered in a specific point or in it's center coordinates
   * @return if the map have to be centered in a specific point
   */
  _hasToCenterMapInPoint: function() {
    //var centerInPoint = (this.options.zoomType === "In") ? ((this.centerToPoint || this.keepPreselectedRoom) ? true : false) : false;
    //return centerInPoint;

    if(this.options.initial || !this.newMapFetched) {
      return true;
    } else {
      return false;
    }
    
  },

  /**
   * @description add class to prevent click in a room if the map is being dragged
   * @param {object} ev - objeto con los datos del evento
   */
  _preventClickWhenDragging: function(ev) {
    // EY  
    this.isDrag = (this.isDrag + 1) || 1 ; // EY, Incremento el contador de drag

    var target = $(ev.target);
    var targetParent = target.parents(".room");
    if(targetParent.length && !targetParent.hasClass("prevent-click")) {
      targetParent.addClass("prevent-click");
    }
  },

  /** 
   * @description save some roomData in widget variables to have them available form future behaviours
   * @param {object} roomData       - object with the data of a room
   * @param {object} roomContainer  - jquery object with the room container element (html, event,...)
   */
 _saveRoomData: function(roomData,roomContainer) {
    //nos guardamos sus coordenadas para centrar el mapa
    if(!this.centerToPoint) {
      this.preferencesCoor = {
        "x": (roomData.x * this.options.ratio) + (roomData.hsize/2 * this.options.ratio),
        "y": (roomData.y * this.options.ratio) + (roomData.vsize/2 * this.options.ratio)
      };
    }
    
    //nos guardamos su html y sus datos en variables para tenerlos disponibles
    this.previousSelectedRoom = roomContainer;
    this.preselectedRoomInfo = roomData;
    this.selectedRoomData = roomData;
  },

  /** 
   * @description set the size attributes of the element related with the zoomType selected
  */
  _setElementSize: function(elementData, zoomType, type) {
    var zoomSize = {};
    var test = {
      "structure": {
        "initX": "xst",
        "initY": "yst",
        "endX": "xend",
        "endY": "yend"
      },
      "room": {
        "initX": "x",
        "initY": "y",
        "sizeX": "hsize",
        "sizeY": "vsize"
      }
    };

    $.each(test[type], (key, value) => {
      zoomSize[key] = parseInt(elementData[value]) * this.options["scaleZoom" + zoomType];
    });

    $.extend(elementData, zoomSize);
  },

  /**
   * @description set the final map size
   * TODO: crear function para dar tamaño al contenedor
   * TODO: ver si en el zoomout en vez de comparar el tamaño del mapa más los margenes, comparar el tamaño del mapa con las calles y si entra en el contenedor, añadirle
   *       margenes top y left. Así evitamos que tenga scroll si mapa y calles entran en el contenedor
   */
  _setMapSize: function() {
    var mapMargin = null;
    var initialMapSize = {
      outherHeight: (this.floorMapCanvas.height() + (this.options.streetsSize * 2)) + (this.options.defaultMargin * 2),
      outherWidth: (this.floorMapCanvas.width() + (this.options.streetsSize * 2)) + (this.options.defaultMargin * 2),
      height: (this.floorMapCanvas.height() + (this.options.streetsSize * 2)),
      width: (this.floorMapCanvas.width() + (this.options.streetsSize * 2))
    };
    
    this.mapContentMargin.leftRight = (initialMapSize.outherWidth < this.element.width()) ? ((this.element.width() - initialMapSize.width) / 2) : this.options.defaultMargin;
    this.mapContentMargin.topBottom = (initialMapSize.outherHeight < this.element.height()) ? ((this.element.height() - initialMapSize.height) / 2) : this.options.defaultMargin;
    
    /*var initialMapSize = {
      outherHeightIn: (this.floorMapCanvas.height() + (this.options.streetsSize * 2)) + (this.options.defaultMargin * 2),
      outherWidthIn: (this.floorMapCanvas.width() + (this.options.streetsSize * 2)) + (this.options.defaultMargin * 2),
      outherHeightOut: (this.floorMapCanvas.height() + (this.options.streetsSize * 2)),
      outherWidthOut: (this.floorMapCanvas.width() + (this.options.streetsSize * 2)),
      height: (this.floorMapCanvas.height() + (this.options.streetsSize * 2)),
      width: (this.floorMapCanvas.width() + (this.options.streetsSize * 2))
    };

    this.mapContentMargin.leftRight = (initialMapSize["outherWidth" + this.options.zoomType] < this.element.width()) ? ((this.element.width() - initialMapSize.width) / 2) : this.options.defaultMargin;
    this.mapContentMargin.topBottom = (initialMapSize["outherHeight" + this.options.zoomType] < this.element.height()) ? ((this.element.height() - initialMapSize.height) / 2) : this.options.defaultMargin;
    */

    mapMargin = (this.mapContentMargin.topBottom === this.mapContentMargin.leftRight) ? this.mapContentMargin.leftRight + "px" : this.mapContentMargin.topBottom + "px " + this.mapContentMargin.leftRight + "px";

    this.floorMapContent.css({
      "width": (this.floorMapCanvas.width() + (this.options.streetsSize * 2)),
      "height": (this.floorMapCanvas.height() + (this.options.streetsSize * 2)),
      "margin": mapMargin
    });

    this._setMapContainerSize();
  },

  /**
   * @description se the map container size
   * TODO: la llamada al centrado sacar fuera
   */
  _setMapContainerSize: function() {
    var hasAdjustToWindow = false;
    var height = window.innerHeight ? window.innerHeight : $(window).height();

    if( ($(window).width() > this.options.maxScreenWidth) && this.options.adjustWindow && !isMobile.any()) {
      hasAdjustToWindow = true;
    }

    this.element.css({
      "height": hasAdjustToWindow ? "580px" : (height - this.options.offsetHeight - 5) + "px"
    });

    //centramos el mapa en la posición correcta
    this._setMapPosition();
  },

  /** 
   * @description set the map container size and apply interactions over the map
   * TODO: check if it is necesary
  */
  _setMapSizeAndInteraction: function(ev) {
    ev.data.widget._setMapContainerSize();
    ev.data.widget._applyInteractions();
  },

  /** 
   * @description set the size of the specific elements of the map
  */
  _setSize: function(data, zoomType, type) {
    for(let x = 0; x < data.length; x++) {
      this._setElementSize(data[x], zoomType, type);
    }
  },

  /** 
   * @description set the map position -> center map in it's center, center map in selected room or center map to selected point
  */
  _setMapPosition: function() {
    var positionData = {
      leftAvailable: this.floorMapContent.outerWidth(true) - this.element.width(),
      topAvailable: this.floorMapContent.outerHeight(true) - this.element.height(),
      centeredX: this.options.streetsSize + this.options.defaultMargin,
      centeredY: this.options.streetsSize + this.options.defaultMargin,
      left: null,
      top: null
    };

    if(this.floorMapContent.outerWidth(true) <= this.element.width()) {
      positionData.centeredX = this.options.streetsSize + this.mapContentMargin.leftRight;
    }

    //gestionamos el centrado del mapa en un punto o en el centro del mapa
    if(this._hasToCenterMapInPoint()) { //centrado del mapa en un punto o en una habitación
      this._centerMapInPoint(positionData);
    } else if(this.newMapFetched) {//centrado del mapa en su centro
      this._centerMap(positionData);
    }
  },

  /** 
   * @description set the lef position of the map
  */
  _setLeftMapPosition: function(positionData) {
    if(this.floorMapContent.outerWidth(true) < this.element.width()) {
      positionData.left = positionData.left / 2;
    } else {
      positionData.left = positionData.leftAvailable;
    }
  },

  /** 
   * @description set the top position of the map
  */
  _setTopMapPosition: function(positionData) {
    if(this.floorMapContent.outerHeight(true) < this.element.height()) {
      positionData.top = positionData.top / 2;
    } else {
      positionData.top = positionData.topAvailable;
    }
  },

  /** 
   * @description set the styles to the roomContaint to place it into the map an save some data as data attributes
   * @param {object} - object with the data of a room
   * @param {object} - jquery object with the room container element (html, event,...)
  */
 _setUpRoomContainer: function(roomData, roomContainer) {
    roomContainer.css({
      width: (roomData.sizeX * this.options.ratio),
      height: (roomData.sizeY * this.options.ratio),
      position: "absolute",
      top: (roomData.initY * this.options.ratio),
      left: (roomData.initX * this.options.ratio)
    }).data("tcm", roomData.tcm).data("number", roomData.id);
  },

  _toggleZoom: function() {
    this.options.zoomType = (this.options.zoomType === "In") ? "Out" : "In";
    if(this.mapMoved) { 
      this.preferencesCoor = this._getPreferencesCoordenates();
    } else {
      this.preferencesCoor = {
        y: (!this.preferencesCoor.y) ? this.floorMapContent.data("zoom-" + this.options.zoomType.toLowerCase() + "-top") : this.preferencesCoor.y,
        x: (!this.preferencesCoor.x) ? this.floorMapContent.data("zoom-" + this.options.zoomType.toLowerCase() + "-left") : this.preferencesCoor.x
      };
    }
    
    this.renderMap();
    this.floorMap.trigger("toggleZoom", [this.options.zoomType]);
    if(this.options.zoomType === 'In'){
      trackOCIZoomOutRoom(Globals.page_section,reservationIdOci)
    }else{
      trackOCIZoomInRoom(Globals.page_section,reservationIdOci)
    }
  },

  /**
   * @description method called when a widget options change and re-render the map
   */
  _setOption: function( key, value ) {
    this._super(key,value);//actualizamos valor propiedad
    if(key === "data") { //para las peticiones de obtención del mapa
      this.newMapFetched = true;
      this.renderMap();
    } else if(key !== "initial") {
      //para el resize de la pantalla
      //TODO: juntar en una sola que llame a estas dos
      this._setMapSize();
      this._applyInteractions();
    }
  }
});

/**
 * Choose room module
 * @return {[type]} [description]
 */
var mChooseRoom = (function (window) {
    var $header = $(".header-mob-v2");
    var $headerTitle = $(".nh-header");
    var $pCioRoomMap = $(".p-cio-roommap");
    var $introText = $pCioRoomMap.find(".text-intro");
    var $mFloorMap = $pCioRoomMap.find(".m-floor-map");
    var $floorMapHeader = $mFloorMap.find(".floor-map-header");
    var $floorMapContainer = $mFloorMap.find(".maps-container");
    var $floorMapContent = $floorMapContainer.find(".map-content");
    var $floorMapCanvas = $floorMapContent.find(".maps-canvas");
    var $floorSelectorDropdown = $mFloorMap.find(".m-floor-selector-dropdown");
    var $floorLegend = $mFloorMap.find(".m-floor-legend");
    var $sidebarPanel = $("#sidebar-panel");
    var $modalRoomSelected = $('#modal-room-selected');
    var $preselectedRoomPanel = $mFloorMap.find(".m-cio-room-preselected");
    var $preselectedCloseButton = $preselectedRoomPanel.find("button.js-room-preselected-close");

    var $form = $("#roomNumber");
    var $hiddenForm = $form.find("input#hidden_roomNumber");

    var $loading = $mFloorMap.find('.spinner');
    var $footerMobile = $(".footer-mob");
    var isBigScreen; //si la pantalla es grande
    var isMobileDevice = isMobile.any(); //si estamos en un movil
    var initialFloor = true; //renderizado de la primera planta pedida
    var selectedFloor = null; //numero de planta seleccionada;
    var onceLoad = true;

    var hotelBackCode, reservationId, JsonBean, roomPreAssignedBean, floorPlanta, dataBuild, dataPreasigned, roomCategoryCode, roomPreferences;
    /**
     * Init Fn
     * @return {[type]} [description]
     */
    function init(building, floor, room) {

        hotelBackCode = displayObj.hotelBackCode;
        reservationId = displayObj.reservationId;
        // datos servicio

        // Cargo datos plantas del edificio seleccionado
        JsonBean = displayObj.buildingAndFloorDataResponse;
        var buildings = JsonBean.buildings;
        roomPreAssignedBean = JsonBean.preAssignedRoom.roomPreAssigned;
        var roomPreAssigned = roomPreAssignedBean.floor;
        var buildingPreAssigned = roomPreAssignedBean.building
        roomCategoryCode = roomPreAssignedBean.roomCategoryCode
        roomPreferences = displayObj.preferences;
        var buildPre = buildings.filter(el => el.idBuilding == buildingPreAssigned);
        var floorPre = (roomPreAssigned, buildPre[0].floors).filter(el => el.idFloor == roomPreAssigned);
        floorPlanta = floorPre[0].jsonplanta;

        dataPreasigned = [buildPre[0].idBuilding, floorPre[0].idFloor];
        dataBuild = [buildPre[0].idBuilding, floorPre[0].idFloor];

        //show map loading
        $loading.show();
        //hide footer mobile for this page
        $footerMobile.hide();
        //event to load the preselected room data if there is preselected room;
        $mFloorMap.on("onMapLoaded", _loadPreselectedRoomData).on("toggleZoom", _toggleZoom);
        // Request building info
        requestBuildingInfo();
        //inicializamos el widget del mapa para que este preparado a recibir los datos, con las opciones desadas
        //se va a ajustar al alto de la ventana cuando la ventana tenga un ancho maximo de globalConfig.xsBreak
        // y vamos a restarle el offsetHeight a esa altura
        // "offsetHeight": $headerTitle.outerHeight(),
        $floorMapContainer.floorMap({
            "adjustWindow": true,
            "offsetHeight": _getOffsetHeight(),
            "maxScreenWidth": globalConfig.smBreak
        }).on("floormaponroomselected", _showRoomDetail);
        //preparamos la vista (movil /tablet-desktop)
        _setViewContent();
        //listeners
        //cuando redimensionemos la ventana debemos preparar la vista
        $(window).on("resize", _setViewContent);
        $floorSelectorDropdown.on('floorselectorchange', _onSelectedFloor);
        $sidebarPanel.on(selectedRoomPanel.PANEL_CLOSE_EVENT, _onRoomInfoCloseHandler);
        $modalRoomSelected.on(mCioRoomSelected.MODAL_CLOSE_EVENT, _onRoomInfoCloseHandler);
        $preselectedCloseButton.on('click', _onClosePreselectedRoom);
        //  event submit
        $(document).on('click', '.submitMap', _submitForm);
    }
    function _getOffsetHeight() {
        var offsetHeight = $headerTitle.outerHeight(true);
        isBigScreen = globalConfig.windowWidth > globalConfig.xsBreak;
        if (isBigScreen && isMobileDevice) {
            offsetHeight += $floorMapHeader.outerHeight() + 5;
        }
        if ($header.is(':visible')) {
            offsetHeight += $header.outerHeight();
        }
        return offsetHeight;
    }
    /**
     * Building info request to render the floor selector and the map
     * @return {[type]} [description]
     */
    function requestBuildingInfo() {
        // TEMP: Peticion de datos de planta
        //var promise = $.getJSON(urlGlobalConfig.domain + 'mocks/hotel_info.json');
        // TEMP: Peticiones de datos del mapa
        var promise = new Promise(function (resolve, reject) {
            resolve();
        });
        promise.then(function (response) {
            $floorSelectorDropdown.floorSelector('option', 'hotelInfo', JsonBean);
        });
        $floorSelectorDropdown.floorSelector();
    }
    /**
     * @description metodo para pedir el json del plano de una planta para pintarlo
     * @param {number} floorNumber - el numero de planta del edificio a pedir
     */
    function getFloor(floorInfo, buildingDescription) {
        dataBuild[0] = buildingDescription;
        dataBuild[1] = floorInfo.idFloor;
        //loading = true;
        var url = apiUrlPath + "/OCI/" + reservationId + "/" + hotelBackCode + "/select/blueprint/" + buildingDescription + "/" + floorInfo.idFloor 
        url = url + "?language=" + language + "&origin=" + ((isMobile.any()) ? "" : "desktop");
        var promise = null;
       
        var data = roomPreferences;
        $floorMapCanvas.hide();
       
        $loading.show();
        if (onceLoad || (JSON.stringify(dataPreasigned) === JSON.stringify(dataBuild))) {
            //console.log("promesa defautl");
            promise = new Promise(function (resolve, reject) {
                resolve(floorPlanta);
            });
            onceLoad = false;
        } else {
            promise = $.ajax({
                type: "POST",
                url: url,
                data: JSON.stringify(data),
                processData: false,
                async: true,
                dataType: "json",
                contentType: 'application/json'
            });
        }
        promise.then(function (response) {
            $floorMapContainer.floorMap("option", "data", response);
            _setFloatElementsHeight();
            /** EY 
             *  DISPLAY LEGEN MAP
            */
            _displayLegend(response,roomPreferences);
            // TEMP: LOADING TIMEOUT
            $loading.hide();
            trackOCIChangeFloor(Globals.page_section,hotelBackCode,dataBuild[1]);
        }, function (error) {
            $loading.hide();
            console.log("promesa incorrecta", error);
        });
    }
    /** EY      
     *  DISPLAY LEGEND MAP
    */
    function _displayLegend(dataFloor,roomPreferences){
       
        let rooms = $floorMapContent.find("div.map").find(".room");        
        let roomstype=[];
        var upselling = {           
            "-preferences":".room-available-preferences", 
            "-upselling":".room-upselling",
            "-duplex":".room-duplex",
            "-lift":".room-lift",
            "-stairs":".room-stairs",            
            "-gym":".room-gym",
            "-spa":".room-spa",
            "-swimming":".room-swimming",
            "-breakfast":".room-breakfast",
            "-courtyard":".room-courtyard"
        };
        // filtrar habitaciones
        rooms.each(function(index, value) {
            roomClass = $(value).attr("class");
            if(roomClass.indexOf("-noavailable") >= 0){
                roomstype.push(".room-noavailable");
            } 
            else{
                if(roomClass.indexOf("-available") >= 0) roomstype.push(".room-available");
                Object.entries(upselling).forEach(([key, value]) => {
                    if(roomClass.indexOf(key) >= 0){
                        roomstype.push(value);
                    } 
                });
            }
        });
        // filtrar calles
        let calles = ["poi","monument", "sea", "park"]
        calles.forEach(function(element) {
            var cl =  ("."+element);
            if($floorMapContent.find(cl).length)  roomstype.push("."+element);
        });
        // total de clases
        let lista = [...new Set(roomstype)];
        // poner corazon todo el mapa si no hay preferencias pero si disponibles
        let preferences=(typeof roomPreferences !== 'undefined' && roomPreferences.features !== null ) ? roomPreferences.features.length : 0;
        if(preferences == 0){
            if(!lista.includes('.room-available-preferences') && lista.includes('.room-available')){
                $floorMapContent.find('div.map .room-available').toggleClass( "room-available-preferences" )
                lista.push('.room-available-preferences')
            }
        }        
        // pongo hide
        $element = $(".legend-room > li");
        $element.addClass('hide');
        lista.forEach(function(element) {
            if(element == '.room-available'){
                $element.find(element).not('.room-duplex').closest("li").removeClass('hide').addClass('legendtrue');
            } else $element.find(element).closest("li").removeClass('hide').addClass('legendtrue');
        });
        // mostrar titulares
        let legend = $("ul.legend-room");
        legend.each(function() {
            if($(this).find(".legendtrue").length > 0){
                $(this).find('li').first().removeClass('hide');
            } 
        });

        
    }
    function _loadPreselectedRoomData(ev, loadPreselectedRoomData) {
        if (initialFloor) {
            if (loadPreselectedRoomData) {
                var selectorPreselect = $(".m-cio-room-preselected");
                selectorPreselect.find(".room-content span").html(roomPreAssignedBean.roomNumber);
                selectorPreselect.find('.info-room').find(".h5").html(roomPreAssignedBean.roomName);
               
                let txtFloor=(isNaN(parseInt(roomPreAssignedBean.floor))) ? roomPreAssignedBean.floor : parseInt(roomPreAssignedBean.floor);
                selectorPreselect.find("#txtFloor").html(txtFloor);
                
                let txyBuilding=(isNaN(parseInt(roomPreAssignedBean.building))) ? roomPreAssignedBean.building : parseInt(roomPreAssignedBean.building);
                selectorPreselect.find("#txtBuilding").html(txyBuilding);
                
                selectedRoomPanel.showPanel("room", "preselected");
                $preselectedRoomPanel.removeClass("close");
            }
        }
        initialFloor = false;
    }

    function _toggleZoom() {
        selectedRoomPanel.hidePanel();
    }

    function _showRoomDetail(ev, data) {
        if (data.isSelected) {
            if (isBigScreen) {
                //mostramos el panel lateral
                selectedRoomPanel.showPanel(data.type, "selected");
            } else {
                $preselectedRoomPanel.addClass("close");
                mCioRoomSelected.setModalSelectedTemplate(data.type);
                $('#modal-room-selected').modal('show');
            }
        } else {
            //TODO: esto se elimina para hacer la petición y traer los datos del back
            if (isBigScreen) {
                //mostramos el panel lateral
                selectedRoomPanel.showPanel(data.type, "selected");
            } else {
                $preselectedRoomPanel.addClass("close");
                mCioRoomSelected.setModalSelectedTemplate(data.type);
                $('#modal-room-selected').modal('show');
                //ocultamos panel de habitación preseleccionada

            }
        }
    }
    function _setViewContent() {
        isBigScreen = globalConfig.windowWidth > globalConfig.xsBreak;

        //si la pantalla es pequeña
        //oculto el texto de introducción "Selecciona tu habitación en el plano"
        //oculto cabecera azul (header de la página)
        //oculto el panel lateral (habría que hacerlo por css)
        //quito margen inferior del mapa
        //quito margen inferior del titulo de página.

        //si es movil//tablet
        //oculto cabecera azul (header de la página)


        $introText.toggle((isBigScreen && !isMobileDevice)); //muestro el texto de entrada para pantallas grandes que no sean dispositivos moviles
        //$header.toggle((isBigScreen && !isMobileDevice)); //muestro el header de la pagina para pantallas grandes que no sean dispositivos moviles
        //$sidebarPanel.toggle(isBigScreen); //oculto o muestro el panel lateral de la página
        //quito o pongo el margin de elemento .map-container
        $mFloorMap.css({
            "margin-bottom": (isBigScreen) ? "40px" : 0
        });

        $headerTitle.css({
            "margin-bottom": (isBigScreen) ? "30px" : 0
        });

        $floorMapContainer.floorMap("option", "offsetHeight", _getOffsetHeight());

        _setFloatElementsHeight();
    }

    /**
     * Set the map container height to the map float elements
     * @constructor
     */
    function _setFloatElementsHeight() {
        if ($(window).outerWidth() >= 768) {
            // Desktop: Take the map container width
            var mapContainerHeight = $floorMapContainer.outerHeight();
            $floorSelectorDropdown.floorSelector('setFloorListHeight', mapContainerHeight);
            // Floor legend dropdown
            $floorLegend.find('.m-cio-room-legend').css('max-height', mapContainerHeight);
        } else {
            var floorSelectorDropdownHeight = $floorSelectorDropdown.outerHeight();
            // Take the viewport width without the header and the panel
            //var headerHeight = $headerTitle.outerHeight();
            var viewportHeight = $(window).outerHeight();
            $floorSelectorDropdown.floorSelector('setFloorListHeight', viewportHeight - floorSelectorDropdownHeight);
        }
    }

    /**
     * Callback when a floor is selected
     * @param       {[type]} e             [description]
     * @param       {[type]} selectedFloor [description]
     * @constructor
     * @return      {[type]}               [description]
     */
    function _onSelectedFloor(e, selectedFloor) {
        //console.log("planta seleccionada");
        // Request the floor data
        $floorMapContainer.floorMap("option", "initial", initialFloor);
        selectedRoomPanel.closePanel();
        getFloor(selectedFloor.selectedFloorInfo, selectedFloor.buildingDescription);
        window.scrollTo(0, 0);
    }

    /**
     * Handler when the panel is closed. Deselect the selected room
     * @param       {[type]} e [description]
     * @return      {[type]}   [description]
     */
    function _onRoomInfoCloseHandler(e) {
       
        if($(".m-cio-room-selected-info").length && isBigScreen){

        }else    $floorMapContainer.floorMap('deselectRoom');

        $("#modal-room-selected").find(".modal-body").html('');
    }

    /**
     * Handler for the close preselected room panel
     * @param       {[type]} e [description]
     * @constructor
     * @return      {[type]}   [description]
     */
    function _onClosePreselectedRoom(e) {
        $preselectedRoomPanel.addClass("close");
        $floorMapContainer.floorMap('deselectRoom');
    }
    /**
     * Send Form
     */
    function _submitForm(e) {
        var roomSelected = mChooseRoom.hiddenForm.val();
        if (roomSelected.length) {
            $(".submitMap").prop("disabled", true);
            $form.submit();
        }
        // else console.log('Seleccionar Habitación')
    }
    
    
    // Public API
    return {
        init: init,
        getFloor: getFloor,
        getFloorBuilding() { return dataBuild; },
        hiddenForm: $hiddenForm
    };

})(window);

$(function () {
    if ($(".p-cio-roommap").length && (typeof displayObj !== 'undefined' && displayObj)) {
        mChooseRoom.init();
        mCioRoomSelected.init();
        selectedRoomPanel.init();
    }
});
var mCioRoomSelectedUpgrade = (() => {
  var mCioUpgradeView;
  var mCioCurrencyChangeModal;
  var currencyConfirmationModal;
  var upsellingCurrencyChangeInfo;
  var currencySelect;
  var currencyChangeBtn;
  var isVisibleUpsellingCurrencyChangeInfo = false;

  /**
   * Init Fn
   * @return {[type]} [description]
   */
  function init() {
    mCioUpgradeView = $('.m-cio-room-selected-upgrade');
    mCioCurrencyChangeModal = $('#m-modal-cio-currency-selected');
    currencyConfirmationModal = $('#m-modal-cio-currency-confirmation');
    upsellingCurrencyChangeInfo = mCioUpgradeView.find('.js-currency-change-info');
    currencySelect = mCioUpgradeView.find('select.js-select-currency');
    currencyChangeBtn = mCioCurrencyChangeModal.find('.js-change-currency-btn');
    // Listeners
    currencySelect.on('change', _onCurrencyChange);
    currencyChangeBtn.on('click', _onCurrencyChange);
    //apply events to modals
    mModals.attachModalEventsBehaviour(mCioCurrencyChangeModal);
    mModals.attachModalEventsBehaviour(currencyConfirmationModal);

    if(isMobileTest()) {
      currencySelect.selectpicker('mobile');
    } else {
      currencySelect.selectpicker();
    }
    if (isVisibleUpsellingCurrencyChangeInfo) {
      upsellingCurrencyChangeInfo.show();
    } else {
      upsellingCurrencyChangeInfo.hide();
    }
  }

  /**
   * Handler when the currency is changed. Show the currency information panel
   * @param       {[type]} e [description]
   * @constructor
   * @return      {[type]}   [description]
   */
  function _onCurrencyChange(e) {
    if (globalConfig.windowWidth < globalConfig.smBreak){
      $('#modal-room-selected').modal('hide');
      currencyConfirmationModal.modal('show');
      currencyConfirmationModal.on('hidden.bs.modal', () => {
        if (globalConfig.windowWidth < globalConfig.xsBreak) {
          $('#modal-room-selected').modal('show');
        }
      });
    }
    isVisibleUpsellingCurrencyChangeInfo = true;
    upsellingCurrencyChangeInfo.show();
  }

  return {
    init: init
  };
})();


$(() => {
  mCioRoomSelectedUpgrade.init();
});

var mCioPreferences = (() => {
  var mCioPreferencesView = $('.m-cio-preferences');
  var warningTooMuchOptions = mCioPreferencesView.find('.js-warning-chosen-options');
  var chooseWarningCounter = parseInt(mCioPreferencesView.attr('data-choose-warning-counter'));

  /**
   * Init Fn
   */
  function init() {
    
    // Listeners
    mCioPreferencesView.find('input').on('change', _onChooseInputChange);

    // -- INI. Nuevo rellenar hidden elements  
    $("#btn-preferences").on('click', _submitForm);
     // -- END. Nuevo rellenar hidden elements
  }

  /**
   * Handler when a input changes. Check if the choose warning text should be visible
   * @param       {[type]} e [description]
   * @constructor
   * @return      {[type]}   [description]
   */
  function _onChooseInputChange(e) {
    if (getChoosenOptionsValue() >= chooseWarningCounter) {
      warningTooMuchOptions.show();
    } else {
      warningTooMuchOptions.hide();
    }
  }

  /**
   * Calculate the total chosen count value finding the selected options and their
   * ponderation
   * @return {[type]} [description]
   */
  function getChoosenOptionsValue() {
    let inputs = mCioPreferencesView.find('input');
    let totalChosenCount = 0;
    inputs.each((index, input) => {
      let $input = $(input);
      if ($input.is('checked') || $input.prop('checked') === true) {
        let inputCountValue = parseInt($input.attr('data-count-value')) > 0 ? parseInt($input.attr('data-count-value')) : 0;
        totalChosenCount += inputCountValue;
      }
    });
    return totalChosenCount;
  }


  // -- INI. Nuevo rellenar hidden elements  
  function _submitForm(event)  {
    event.preventDefault()
    var $selectedSimple = $('input[type=radio]').filter(':checked');
    var $selectedMultiple = $('input[type=checkbox]').filter(':checked');
    _fillSimpleHiddenElements($selectedSimple);
    _fillMultipleHiddenElements($selectedMultiple);
    $("button:submit").prop("disabled", true);
    $('#preferences').submit();
    trackOCIPreferences(Globals.page_section,reservationIdOci);
  }

  function _fillSimpleHiddenElements ($element) {
    $element.each(function() {
      var $hiddenElement = $('#hidden-' + this.name);		
      $hiddenElement.val(this.value);
      //console.log('Hidden (simple) name : ' + this.name + '\nid : ' + this.id  + '\nvalue : ' + this.value);
    });
  }
  
  function _fillMultipleHiddenElements ($element) {
    $element.each(function() {
      $hiddenElement = $('#hidden-' + this.id);
      $hiddenElement.val(this.value);
      //console.log('Hidden (simple) name : ' + this.name + '\nid : ' + this.id  + '\nvalue : ' + this.value);
    });
  }
  // -- END. Nuevo rellenar hidden elements

  // Public API
  return {
    init: init
  }
})();

$(() => {
  if($('.m-cio-preferences').length){
    mCioPreferences.init();
  }  
});
var mModalLogin = (() => {
  var modalLoginView = $('#m-modal-login');
  var modalLoginHeader = modalLoginView.find('.modal-header');

  // Navigator object controller
  var navigator;

  // Template URLS
  var LOGIN_FORM = (typeof pageData !== 'undefined') ? pageData.loginForm : "";
  var RECOVER_PASSWORD = (typeof pageData !== 'undefined') ?  pageData.recoverPassword : "";
  var RECOVER_PASSWORD_CONFIRMATION = (typeof pageData !== 'undefined') ? pageData.confirmationPassword : "";
  var LOGIN_SIGNUP_FORM = 'i-login-form-signup.html';
  // Consts
  const MODAL_BODY_CLS = 'modal-body'; 
  const MODAL_DIALOG = 'modal-dialog';
  const MODAL_TITLE_CLS = 'modal-title';
  const headerTranslations = {
    LOGIN_FORM: modalLoginView.attr('data-login-header-translation'),
    RECOVER_PASSWORD: modalLoginView.attr('data-login-recover-password-translation')
  };
  const modalStatus = {
    login: LOGIN_FORM,
    recover: RECOVER_PASSWORD,
    recoverConfirmation: RECOVER_PASSWORD_CONFIRMATION,
    signup:  LOGIN_SIGNUP_FORM
  };

  var initStateView;
  var currentStateView;
  var nextStateView;

  // Init Fn
  function init() {
      navigator = new Navigator(modalLoginView, LOGIN_FORM, '.' + MODAL_BODY_CLS, _onNavigationComplete);
    // Listeners
    modalLoginView.on('shown.bs.modal', _setIntialModalState);
    modalLoginView.on('hide.bs.modal', _handleHideModal);
  }

  function _handleHideModal(ev) {
    var $form = $(this).find("form");
    login.removeLoginRecaptcha($form);
  }

  function getNavigator() {
    return navigator;
  }

  function _setIntialModalState(ev) {
    var $trigger = $(ev.relatedTarget);
    initStateView = $trigger.data("state") ? $trigger.data("state") : "login";
    currentStateView = initStateView;
    if(currentStateView !== nextStateView) {
      navigator.navigate(modalStatus[initStateView]);
      _initialLoginModalState();
    }
  }

  /**
   * @description - Load the initial state of the modal (login) if it is the current state
   * @param {object} ev - object with the event data
   */
  function _initialLoginModalState() {
    //var $trigger = $(ev.relatedTarget);
    //initStateView = $trigger.data("state") ? $trigger.data("state") : "login";
    if(!initStateView || initStateView === "login") {
    navigator.initViewElementState();
  }
  }

  /**
   * Callback when a navigation by html injection is complete
   */
  function _onNavigationComplete() {
    // Trigger update content
    modalLoginView.trigger(mModals.MODAL_UPDATE_CONTENT_EVENT);
    switch (navigator.getActualState()) {
      case LOGIN_FORM:
        currentStateView = "login";
        mLoginForm.init();
        _setModalSize('modal-xs');
        toggleNavigationHeader(headerTranslations.LOGIN_FORM);
        // Reset form setup
        commonFormSetup.init();
      break;
      case RECOVER_PASSWORD:
        currentStateView = "recover";
        _setModalSize('modal-xs');
        mLoginRecoverPassword.init();
        toggleNavigationHeader(headerTranslations.RECOVER_PASSWORD);
        // Reset form setup
        commonFormSetup.init();
      break;
      case RECOVER_PASSWORD_CONFIRMATION:
        currentStateView = "recover_confirmation";
        _setModalSize('modal-xs');
        mLoginRecoverPasswordConfirmation.init();
      break;
      case LOGIN_SIGNUP_FORM:
        currentStateView = "signup";
        mLoginForm.init();
        _setModalSize('modal-xs');
        toggleNavigationHeader(headerTranslations.LOGIN_FORM);
        // Reset form setup
        commonFormSetup.init();
      break;
    }
  }

  /**
   * Change the modal header to a navigation header with prev button
   */
  function toggleNavigationHeader(headerText) {
    // Header text
    if (headerText && headerText.length > 0) {
      modalLoginHeader.find('.' + MODAL_TITLE_CLS).html(headerText);
    }
  }

  function _setModalSize(modalSizeCls) {
    var modalDialog = modalLoginView.find('.' + MODAL_DIALOG);
    modalDialog.removeClass('modal-xs modal-sm modal-lg');
    modalDialog.addClass(modalSizeCls);
  }

  function getModalView() {
    if(modalLoginView != "undefined")  return modalLoginView;
  }

  function getInitialStateView() {
    return initStateView;
  }

  function setNextStateView(state) {
    nextStateView = state;
  }

  // Public Api
  return {
    init: init,
    LOGIN_FORM: LOGIN_FORM,
    RECOVER_PASSWORD: RECOVER_PASSWORD,
    RECOVER_PASSWORD_CONFIRMATION: RECOVER_PASSWORD_CONFIRMATION,
    LOGIN_SIGNUP_FORM: LOGIN_SIGNUP_FORM,
    getNavigator: getNavigator,
    getModalView: getModalView,
    getInitialStateView: getInitialStateView,
    setNextStateView: setNextStateView
  };
})();

$(() => {
  if($("#m-modal-login").length) {
    mModalLogin.init();
  }
});

var mLoginForm = (() => {
  var mLoginFormView;
  var forgottenPassword;
  var wrongCredentials;
  var $loginForm;
  var $userInput;
  var $passwordInput;
  var $modalLogin;
  var $loginForm;
  var formInputs;
  var blockedUser;
  var unblockedUser;
  var selectedUser = {
    isBlocked: false,
    value: null
  };

  function init() {
    mLoginFormView = $('.m-login-form');
    forgottenPassword = mLoginFormView.find('.js-forgotten-password');
    wrongCredentials = mLoginFormView.find('.js-wrong-credentials');
    blockedUser = mLoginFormView.find('.blocked-user');
    unblockedUser = mLoginFormView.find('.unblocked-user');
    $loginForm = mLoginFormView.find('form');
    $userInput = $loginForm.find('input#username');
    $passwordInput = $loginForm.find('input#password');
    $modalLogin = mModalLogin.getModalView(); //recuperamos el elemento modal donde está introducido el formulario (si lo está)

    _setupForm();

    // Listeners
    forgottenPassword.on('click', _handlerForgottenPassword);
    // Init form validation
    /*$loginForm.validator({
      disable: false
    }).on('submit', _onLoginFormSubmit)
    .off('input.bs.validator focusout.bs.validator');*/

    $loginForm.validator({
      disable: false
    }).on('submit', _onLoginFormSubmit);

    $userInput.add($passwordInput).on("invalid.bs.validator", function() {
      wrongCredentials.addClass("hidden");
    });

    $userInput.on('change', _checkUserBlocked);
  }

  function _checkUserBlocked() {
    if(selectedUser.isBlocked && selectedUser.value !== $(this).val()) {
      blockedUser.hide();
      unblockedUser.show();
    } else if(selectedUser.isBlocked && selectedUser.value === $(this).val()) {
      blockedUser.show();
      unblockedUser.hide();
    }
  }

  /**
   * @description - setup data attribures of login form which are necessaries in the behaviour of the form
   */
  function _setupForm() {
    var loginMessage;
    var loginCallback;
    if($modalLogin.length) {
      loginMessage = $modalLogin.data("login-message-error");
      loginCallback = $modalLogin.data("login-callback");
      $loginForm.attr("data-login-message-error", loginMessage);
      $loginForm.attr("data-callback", loginCallback);
      //login.initLoginRecaptcha($loginForm);
    }
  }

  /**
   * @description - Handler for the forgotten password link
   */
  function _handlerForgottenPassword(ev) {
    ev.preventDefault();
    if($modalLogin.length && mModalLogin.getInitialStateView() !== "recover") {
    mLoginRecoverPassword.setDefaultEmail(getUsername());
      //debemos borrar el recaptcha antiguo si lo hay y luego crear el nuevo para no acumular recaptchas perdidos
      //login.removeLoginRecaptcha($loginForm);
    mModalLogin.getNavigator().navigate(mModalLogin.RECOVER_PASSWORD);
      mModalLogin.setNextStateView("recover");
  }
  }

  /**
   * @description - actions to do when the form is submit
   * @param {object} ev - event data
   */
  function _onLoginFormSubmit(ev) {
    var $form = $(this);
    var loginData = {
      user: $userInput.val(),
      password: $passwordInput.val(),
      defaultErrorMsg: $form.data('login-message-error') || ""
    };
    toggleLoadingButton($form, true);
    if (ev.isDefaultPrevented()) {
      // Invalid Form
      toggleLoadingButton($form, false);
    } else {
      // Valid Form
      ev.preventDefault();
      ///////////////////////////
      // EY CAMBIO LINEA 72
      if($(".p-cio-guest-data").length){
        Globals.ssoUrl = '/ci-online/guest-form/access';
        loginSSO(loginData).then(_onSubmitLoginSuccess_guest_form, _onSubmitLoginFailure);
      } else login.loginSSO(loginData).then(_onSubmitLoginSuccess, _onSubmitLoginFailure);
      window.onbeforeunload = null;
    }
  }
  // DUPLICO LOGIN PARA SEPARAR EL GUEST DATA FORM
  function loginSSO(loginData) {
    var ssoUrl = (typeof Globals.ssoUrl !== "undefined") ? Globals.ssoUrl : null;
    var ssoService = (typeof Globals.ssoService !== "undefined") ? Globals.ssoService : null;
    var url;
    var deferred = $.Deferred();
    var errorMessage;
    var promise;

    defaultErrorMsg = loginData.defaultErrorMsg;

    //url = ssoUrl + "?service=" + ssoService + "&username=" + loginData.user + "&password=" + encodeURIComponent(loginData.password);
    url = ssoUrl;
    var params = {
      service: ssoService,
      username: loginData.user,
      password:  encodeURIComponent(loginData.password)
  }
    if (loginData.user && loginData.password && ssoService && ssoUrl) {
      promise = $.ajax({
        method:"POST",
        url: url,
        data: JSON.stringify(params),
        async: false,
        dataType: 'json',
        contentType: 'application/json'
      });

      return promise.then(function(res) {
        //delete res.data.ticketGrantingTicket; -> descomentar para probar el error del login
        if (res) {
          return res;
        } else{
          return {"message":"Login Error"};
        }
      }, function(jqXHR, exception) {
        //LOGIN KO!
        if (jqXHR.status === 0) {
          errorMessage = 'Not connect.\n Verify Network.';
        } else if (jqXHR.status == 404) {
          errorMessage = 'Requested page not found. [404]';
        } else if (jqXHR.status == 500) {
          errorMessage = 'Internal Server Error [500].';
        } else if (exception === 'parsererror') {
          errorMessage = 'Requested JSON parse failed.';
        } else if (exception === 'timeout') {
          errorMessage = 'Time out error.';
        } else if (exception === 'abort') {
          errorMessage = 'Ajax request aborted.';
        } else {
          errorMessage = 'Login Error';
        }
        return {"message":errorMessage};
      });
    } else {
      console.log("One of this params are empty: user, password, Globals.ssoService or Globals.ssoUrl");
      errorMessage = (loginData.user && loginData.password) ? defaultErrorMsg : "One of this fields are empty: user, password";
      deferred.reject({"message": errorMessage});
      return deferred.promise();
    }
  }


   /**
   * @description handle the user login successfully response
   * @param {*} response - data of user login succesffuly
   */
  function _onSubmitLoginSuccess(response) {
    var loginSuccessCallbackName = $loginForm.data('callback');
    var loginSuccessCallback = (loginSuccessCallbackName) ? getFunctionByName(loginSuccessCallbackName) : null;
    var isFunction = (typeof loginSuccessCallback) === "function";
    utils.callTrackForms("success", "loginRewardsForm", "success");
    if(isFunction) {
      loginSuccessCallback(response.targetUrl)
      .then(function() {
        if($modalLogin.length) {
          //$modalLogin.modal("hide");
          window.location = response.targetUrl;
        }
      }, function(error) {
        _onSubmitLoginFailure(error);
      });
    } else {
      window.location = response.targetUrl;
    }
  }

  /**
   * @description handle the user login successfully response para el login form de guest form
   * @param {*} response - data of user login succesffuly
   */
  function _onSubmitLoginSuccess_guest_form(response) {
    var loginSuccessCallbackName = $loginForm.data('callback');
    var loginSuccessCallback = getFunctionByName(loginSuccessCallbackName);
    var isFunction = (typeof loginSuccessCallback) === "function";
    utils.callTrackForms("success", "loginRewardsForm", "success");
    if(isFunction) {
      loginSuccessCallback(response)
      .then(function() {
        if($modalLogin.length) {
          // EY: TRACKING OCI
          if (typeof reservationIdOci !== 'undefined') {
            trackOCILogin(Globals.page_section, reservationIdOci);           
          }       
          // ocultamos modal de oci
          $modalLogin.modal("hide");   
        }
      }, function(error) {
        _onSubmitLoginFailure(error);
      });
    } else {
      window.location = response.targetUrl;
    }
  } 

  /**
   * @description handle the user login error response
   * @param {*} error - data of user login failure
   */
  function _onSubmitLoginFailure(error) {
    toggleLoadingButton($loginForm, false);
    $userInput.closest('.form-group').addClass('has-error');
    $passwordInput.closest('.form-group').addClass('has-error');
    $userInput.closest('.form-group').removeClass('has-success');
    $passwordInput.closest('.form-group').removeClass('has-success');
    selectedUser.value = $userInput.val();
    if(error.type === "blocked") {
      blockedUser.show();
      unblockedUser.hide();
      selectedUser.isBlocked = true;
    } else {
    wrongCredentials.find("p").html(error.message);
    wrongCredentials.removeClass('hidden');
      selectedUser.isBlocked = false;
    }
  }

  /**
   * Show/hide the non existent email text
   * @param  {[boolean]} visibility [Show/Hide the text]
   * TODO: revisar si esto se va a usar o no
   */
  function _toggleWrongCredentials(visibility) {
    var userInput = mLoginFormView.find('form input#username');
    var passwordInput = mLoginFormView.find('form input#password');
    if (visibility) {
      userInput.closest('.form-group').addClass('has-error');
      passwordInput.closest('.form-group').addClass('has-error');
      // Add listeners to hide the wrong credentials text
      userInput.on('change', _onWrongInputChanges);
      passwordInput.on('change', _onWrongInputChanges);
      wrongCredentials.removeClass('hidden');
    } else {
      wrongCredentials.addClass('hidden');
    }
  }

  /**
   * @description Hide the form error message if one of the form input(user and password) has changed
   * @param {object} e object with the event properties
   */
  function _onWrongInputChanges(e) {
    var $this = $(this);
    wrongCredentials.addClass('hidden');
    $this.off('change', _onWrongInputChanges);
  }

  /**
   * Returns the entered mail, checking if it is a valid email
   * @return {[string]} [email value]
   */
  function getUsername() {
    return mLoginFormView.find('form input#username').val();
  }

   /**
   * AJAX to submit Login
   * return      {[type]}       [description]

  function _submitLogin($form) {
    // TODO: @EY BUILD AJAX REQUEST
    var user = $form.find('input#username').val();
    var password = $form.find('input#password').val();
    return $.ajax({
      method: 'POST',
      url: urlGlobalConfig.domain + 'recoverPassword',
      data: {
        user: user,
        password: password
      }
    });
  }*/

  // Public API
  return {
    init: init,
    getUsername: getUsername
  };
})();

$(() => {
  if($('.m-login-form').length) {
  mLoginForm.init();
  }
});

var mLoginRecoverPassword = (() => {
  var mLoginRecoverPasswordView;
  var backButton;
  //var emailNonExistent;
  var errorBlock;
  var errorMessage;
  var defaultEmail;
  var $recoverPasswordForm;
  var $email;
  var modalLoginView = null;

  /**
   * Init Fn
   * @return {[type]} [description]
   */
  function init() {
    modalLoginView = $('#m-modal-login');
    mLoginRecoverPasswordView = $('.m-login-recover-password');
    $recoverPasswordForm = mLoginRecoverPasswordView.find('form');
    $email = $recoverPasswordForm.find('#mail');
    backButton = mLoginRecoverPasswordView.find('.js-back-login-form');
    //emailNonExistent = mLoginRecoverPasswordView.find('.js-email-dont-exist');
    errorBlock = mLoginRecoverPasswordView.find('.help-block');
    errorMessage = errorBlock.find("li").eq(0);
    //login.initLoginRecaptcha($recoverPasswordForm);
    // Default email
    _setEmailValue();
    // Listeners
    backButton.on('click', _backButtonHandler);
    // Init form validation
    mLoginRecoverPasswordView.find('form').validator({
      disable: false
    }).on('submit', _onRecoverPasswordFormSubmit);
  }

  function _setEmailValue() {
    // Set the default email
    if(defaultEmail && defaultEmail.length > 0) {
      var pattern = /[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;
      if (pattern.test(defaultEmail)) {
        mLoginRecoverPasswordView.find('form input#mail').val(defaultEmail);
        defaultEmail = '';
      }
    }
  }

  /**
   * Handler for the backbutton click
   */
  function _backButtonHandler() {
    //debemos borrar el recaptcha antiguo si lo hay y luego crear el nuevo para no acumular recaptchas perdidos
    //login.removeLoginRecaptcha($recoverPasswordForm);
    if(mModalLogin.getInitialStateView() === "login") {
      mModalLogin.getNavigator().navigate(mModalLogin.LOGIN_FORM);
      mModalLogin.setNextStateView("login");
    } else if(mModalLogin.getInitialStateView() === "signup") {
      mModalLogin.getNavigator().navigate(mModalLogin.LOGIN_SIGNUP_FORM);
      mModalLogin.setNextStateView("signup");
    } else {
      mModalLogin.getModalView().modal('hide');
    }
  }

  /**
   * Show/hide the non existent email text
   * @param  {[boolean]} visibility [Show/Hide the text]
   */
  function toggleEmailNonExistent(visibility) {
    var mailInput = mLoginRecoverPasswordView.find('form input#mail');
    if (visibility) {
      //emailNonExistent.show();
      mailInput.closest('.form-group').addClass('has-error');
    } else {
      //emailNonExistent.hide();
    }
  }

  /**
   * Login form Submit.
   * @param       {[type]} e [description]
   */
  function _onRecoverPasswordFormSubmit(e) {
    var $form = $(this);
    toggleLoadingButton($form, true);
    if (e.isDefaultPrevented()) {
      // Invalid Form
      toggleLoadingButton($form, false);
    } else {
      // Valid Form: Perform AJAX
      e.preventDefault();
      _submitRecoverPasswordEmail();
    }
  }

  /**
   * AJAX to recover the password
   * @param       {[object]} $form [Jquery form object]
   */
  function _submitRecoverPasswordEmail() {
    var url =  "/nhrewards/reset-password";
    var errorMessage;

    $.ajax({
      type: "POST",
      url: url,
      data: "email=" + $email.val() + "&cmp=" + $recoverPasswordForm.find("#cmp").val() + "&cmpView=" + $recoverPasswordForm.find("#cmpView").val(),
      async: true,
      dataType: "json"}
    ).then(function(response) {
      mModalLogin.getNavigator().navigate(mModalLogin.RECOVER_PASSWORD_CONFIRMATION);
      mModalLogin.setNextStateView("recover_confirmation");
    }, function(error) {
      errorMessage =`<ul class="list-unstyled"><li>${error.response}</li></ul>`;
      $email.val("");
      $email.closest('.form-group').addClass('has-error');
      $email.closest('.help-block').html(errorMessage);
      toggleLoadingButton($recoverPasswordForm, false);
    });
  }

  /**
   * Set the default email
   * @param {[type]} email [description]
   */
  function setDefaultEmail(email) {
    defaultEmail = email;
  }

  // Public API
  return {
    init: init,
    setDefaultEmail: setDefaultEmail
  };
})();

$(() => {
  if($(".m-login-recover-password").length) {
  mLoginRecoverPassword.init();
  }
});

var mLoginRecoverPasswordConfirmation = (() => {
  var mLoginRecoverPasswordConfirmationView;
  var goBackLoginCTA;
  var goBackCTA;

  function init() {
    mLoginRecoverPasswordConfirmationView = $('.m-login-recover-password-confirmation');
    goBackLoginCTA = mLoginRecoverPasswordConfirmationView.find('.js-go-back-login');
    goBackCTA = mLoginRecoverPasswordConfirmationView.find('.js-go-back');
    // Listeners
    goBackLoginCTA.on('click', _goBackLoginCTAHandler);
    goBackCTA.on('click', _goBackCTAHandler);
  }

  /**
   * @description - back to the previous state of the login form (recover password form)
   * @param {object} ev - object with the event data
   */
  function _goBackCTAHandler(ev) {
    ev.preventDefault();
    mModalLogin.getNavigator().goBackHandler();
    mModalLogin.setNextStateView("recover");
  }

  /**
   * @description - back to the login state of the login modal or hide the recover password modal
   * @param {object} ev - object with the event data
   */
  function _goBackLoginCTAHandler(ev) {
    ev.preventDefault();
    if(mModalLogin.getInitialStateView() === "login") {
      mModalLogin.getNavigator().navigate(mModalLogin.LOGIN_FORM);
      mModalLogin.setNextStateView("login");
    } else if(mModalLogin.getInitialStateView() === "signup") {
      mModalLogin.getNavigator().navigate(mModalLogin.LOGIN_SIGNUP_FORM);
      mModalLogin.setNextStateView("signup");
    } else {
      mModalLogin.getModalView().modal('hide');
    }
  }

  // Public API
  return {
    init: init
  };
})();

$(() => {
  if($('.m-login-recover-password-confirmation').length) {
    mLoginRecoverPasswordConfirmation.init();
  }
});

var modalSendReservation = (() => {
  var modalSendReservationView = $('#modal-send-reservation');
  var modalSendReservationForm = modalSendReservationView.find('form');
  var modalSendReservationSuccess = modalSendReservationView.find('.modal-send-reservation-success-content');

  function init() {
    // Bootstrap Validator
    modalSendReservationForm.validator({
      disable: false,
      custom: {
        'multipleemails': validateMultipleEmails
      }
    }).on('submit', function(e) {
      if (e.isDefaultPrevented()) {
        // Invalid Form
        modalSendReservationSuccess.addClass('hide');
      } else {
        modalSendReservationForm.addClass('hide');
        modalSendReservationSuccess.removeClass('hide');
        // TEMP: Prevent navigation (Quit this when sending the form)
        e.preventDefault();
      }
    });

    // Listeners
    modalSendReservationView.on('show.bs.modal', _onShowSendReservationModal);
    modalSendReservationView.on('hide.bs.modal', _onHideSendReservationModal)
  }

  function _onShowSendReservationModal(e) {
    modalSendReservationForm.removeClass('hide');
    modalSendReservationSuccess.addClass('hide');
  }

  function _onHideSendReservationModal(e) {
    modalSendReservationForm.addClass('hide');
    modalSendReservationSuccess.removeClass('hide');
  }

  // Public Api
  return {
    init: init
  };
})();

$(() => {
  modalSendReservation.init();
});

class CustomizeRoom {
  constructor($room) {
    this.$room = $room;
    this.hostsAmount = 1;
  }

  init() {
    this.$addHostBtn = this.$room.find(".js-add-person");
    this.maxHostsAllowed = this.$addHostBtn.data("max-add");
    this.$hostData = this.$room.find(".host-data-new");
    this.$hosts = this.$hostData.find(".data");
    this.$removeHostBtn = this.$hostData.find(".btn-ico");

    this.$removeHostBtn.hide();
    this.$addHostBtn.on("click", {room: this}, this._addNewHost);
    this.$removeHostBtn.on("click",{room: this}, this._removeNewHost);
  }

  _addNewHost(ev) {
    var room = ev.data.room;
    var currentHost;

    if(room.hostsAmount < room.maxHostsAllowed) {
      currentHost = room.$hosts.eq(room.hostsAmount);
      currentHost.show();
      room.hostsAmount++;

      if(room.hostsAmount == room.maxHostsAllowed) {
        room.$addHostBtn.hide();
      }

      currentHost.prev().find(".btn-ico").hide();
      currentHost.find(".btn-ico").show();
    }
  }

  _removeNewHost(ev) {
    var room = ev.data.room;
    var currentHost = room.$hosts.eq(room.hostsAmount-1);

    if(room.hostsAmount > 1) {
      currentHost.hide();
      currentHost.find('input').val('');
      room.$addHostBtn.show();
      currentHost.prev().find(".btn-ico").show();
      room.hostsAmount--;

      if(room.hostsAmount === 1) {
        currentHost.prev().find(".btn-ico").hide();
      }
    }
  }
}

/**
 * Arrival Module
 * @return {[type]} [description]
 */

var mCustomizeRoomDetail = (function () {
  var $roomsContainer = $("#rooms-detail");
  var $rooms = $roomsContainer.find(".panel");
  var rooms = [];

  /**
   * Init Fn
   * @return {[type]} [description]
   */
  function init() {
    var $room;
    var room;
    $.each($rooms, function(index, element) {
      $room = $(this);
      room = new CustomizeRoom($room);
      room.init();

    });
  }



  // Public API
  return {
    init: init
  };

})();

$(function() {
  mCustomizeRoomDetail.init();
});




var mPaymentMethods = (() => {
  var $paymentMethods = $('.m-payment-methods');
  var $paymentMethodsSelectsContainter = $paymentMethods.find(".js-payment-selector");
  var $paymentMethodOption = $paymentMethods.find('.payment-method-option');
  var $paymentMethodsSelects = $paymentMethodsSelectsContainter.find("select");
  var $needBillContainer = $paymentMethods.find("#info-bill");
  var infoBillElements = {
    $billTypeSelectors: $needBillContainer.find("input[type=radio]"),
    $copyReservationInfoCheck: $needBillContainer.find('#copy-info'),
    $companyFields: $needBillContainer.find('#company-name'),
    $personalFields: $('#name-surname-bill').add('#name-bill').add('#last-name-bill')
  };

  function init() {
    // Listeners
    $paymentMethodsSelects.on('changed.bs.select', _onChangePaymentMethodOption);//change payment method selector
    infoBillElements.$billTypeSelectors.on("change", _onBillTypeChange);
  }

  /**
   * @description handle the change event of the payment options select
   */
  function _onChangePaymentMethodOption() {
    // var $selectedOption= $(e.target.options[e.target.selectedIndex]);
    var  $selectedOption= $(this).find('option:selected');
    _showPaymentMethodOptions($selectedOption);
  }

  /**
   * @description - handle the change event of bill type radio buttons, hidding and showing the correct fields.
   */
  function _onBillTypeChange() {
    var $this = $(this);
    var isPersonalChoice = true;
    if($this.is(':checked')) {
      isPersonalChoice = $this.attr("id") === "personalInvoice";
      infoBillElements.$copyReservationInfoCheck.attr('checked', false);
      infoBillElements.$copyReservationInfoCheck.closest('.checkbox').toggle(isPersonalChoice);
      _toggleBillCompanyNameVisibility(!isPersonalChoice);
      _toggleBillUserNameVisiblity(isPersonalChoice);
    }
  }

  /**
   * @description show the correct payment method and clean the payment method options
   * @param {object} $selectedOption - jquery element which is the payment method option selected
   */
  function _showPaymentMethodOptions($selectedOption) {
    $paymentMethodOption.hide();
    var $collapsibleTarget = $selectedOption.data('collapsible-target');
    var $parent = $selectedOption.parents(".m-payment-methods");
    var $collapsedOptions =  $parent.find($collapsibleTarget);

    // Limpia check's
    //$collapsedOptions.find('input[type="checkbox"]:checked').prop('checked', false);
    $collapsedOptions.find('input:checked').not("#need-bill, .type-invoice").prop('checked', false);
    
    $collapsedOptions.find('.payment-method-info').hide();
    $collapsedOptions.show();
  }

  /**
   * @description show or hide the fields related with company bill type
   * @param {boolean} isVisible - if the fields have to be showed or hidden
   */
  function _toggleBillCompanyNameVisibility(isVisible) {
    infoBillElements.$companyFields.closest('.js-company-name-wrapper').toggle(isVisible);
    infoBillElements.$companyFields.attr('data-validation', isVisible).val('');
  }

  /**
   * @description show or hide the fields related with personal bill type
   * @param {boolean} isVisible - if the fields have to be showed or hidden
   */
  function _toggleBillUserNameVisiblity(isVisible) {
    infoBillElements.$personalFields.closest('.js-bill-user').toggle(isVisible);
    infoBillElements.$personalFields.attr('data-validation', isVisible).val('');
  }

  // PUBLIC API
  return {
    init: init
  };
})();

$(() => {
  mPaymentMethods.init();
});

var landingCarousel = (() => {
  let carouselsData = {};
  let landingCarouselModules = $('.m-landing-carousel');
  const defaultCarouselConfig = {
    items: 1,
    margin:0,
    nav:false,
    loop:true,
    dots:false,
    autoHeight:false,
    responsive: {
      0: { items: 1, autoHeight: false, mouseDrag: false, touchDrag: true },
      600: { items: 1, autoHeight: false, mouseDrag: false, touchDrag: true }
    }
  };

   /**
    * @description Initialize module
    */
  function init() {
    carouselsData = {
      $carousels: $('.m-landing-carousel'),
      carouselObj: {},
    };

    //cada modulo carrusel se inicializa
    landingCarouselModules.each((index, landingCarousel) => {
      let $carousel = $(landingCarousel);
      _initOwlCarousel(index,  $carousel);
    });
  }

  function _getCarouselData($carousel) {
    let carouselData = {
      $carousel: $carousel,
      get $videos() {
        return this.$carousel.find("iframe");
      },
      get $slides() {
        return this.$carousel.find(".aspect-ratio-img-carousel");
      },
      currentSlide: 0
    };
    return carouselData;
  }

  /**
   * @description - get the carousel config when it has multiples slides
   * @param {object} carouselCustomOptions - object with the carousel custom options
   * @returns - the final caroulse config
   */
  function _getMultipleSlideCarouselConfig(carouselCustomOptions) {
    var carouselConfig = $.extend({}, defaultCarouselConfig, {
      nav: true,
      navText: [
        `<span class="owl-prev-icon nh-ic-chevron"></span>`,
        `<span class="owl-next-icon nh-ic-chevron"></span>`
      ]
    }, carouselCustomOptions);

    return carouselConfig;
  }

  /**
   * @description - get the carousel config when it has a single slide
   * @param {object} carouselCustomOptions - object with the carousel custom options
   * @returns - the final caroulse config
   */
  function _getSingleSlideCarouselConfig(carouselCustomOptions) {
    var carouselConfig = $.extend({}, defaultCarouselConfig, {
      nav:false,
      loop:true,
      dots:false,
      mouseDrag: false,
      touchDrag: false
    }, carouselCustomOptions);
    return carouselConfig;
  }

  /**
   * @description - initialize each carousel
   * @param {*} index - the index of the carousel in the page carousel array
   * @param {*} $carousel - the jquery object of the current carousel
   */
  function _initOwlCarousel(index, $carousel) {
    let carouselChildren = $carousel.find('.carousel-slide');
    let carouselCustomOptions = $carousel.data('owl-carousel-options') ? $carousel.data('owl-carousel-options') : {};
    let carouselConfig = _getMultipleSlideCarouselConfig(carouselCustomOptions);
    let carousel = null;
    let carouselData = null;
    if(carouselChildren.length === 1) {
      carouselConfig = _getSingleSlideCarouselConfig(carouselCustomOptions);
    }
    if(carouselChildren && carouselChildren.length > 0) {
      $carousel.on('initialized.owl.carousel', function(event) {
        carouselData = carouselsData.carouselObj[`c${index}`] = _getCarouselData($carousel);
        carouselData.currentSlide = event.item.index;
      });
      carousel = $carousel.owlCarousel(carouselConfig);
      carousel.on('changed.owl.carousel', function(event) {
        carouselData.previousSlide = carouselData.currentSlide;
        carouselData.currentSlide = event.item.index;
        setTimeout(_toggleCarouselVideos.bind(carouselData), 0);
      });
    }
  }

  /**
   * @description - stop the video of the previous slide carousel
   */
  function _toggleCarouselVideos() {
    let prevSlide = this.$slides.eq(this.previousSlide);
    let $video = prevSlide.find("iframe");
    let src = null;
    if($video.length) {
      src = $video.attr("src");
      $video.attr("src", "");
      $video.attr("src", src);
    }
  }

  // PUBLIC API
  return {
    init: init
  };
})();

$(() => {
  landingCarousel.init();
});

const commonBookingHotel = ( () => {

	const formConstants = {
    CODE: 'code',
    LOCALITY: 'locality',
    LOCATION2: 'location2',
    LOCATION_LCV: 'locationLcv',
    LOCATION_TCM: 'locationTCM',
    TIPO_BUSCADOR:'tipoBuscador',
    TYPE: 'type',
    URL_HOTEL:'urlHotel',
    VIRTUAL_HOTEL: 'virtualHotel',
    START_DATE: 'start-date',
    END_DATE: "end-date",
    START_DATE_CALENDAR: 'start-date-calendar',
    END_DATE_CALENDAR: 'end-date-calendar',

  };
  let constantsWithHash = [];

  // Add Hash # to string values: 'code' -> '#code'
  for (var i in formConstants) {
    constantsWithHash[i] = `#${formConstants[i]}`;
  };


  let initialVars = {
      initialSearch: {},
      initialTypeSearch: null,
      fields: {
        ids: [formConstants.CODE, formConstants.LOCALITY, formConstants.LOCATION2, formConstants.LOCATION_LCV, formConstants.LOCATION_TCM, formConstants.TIPO_BUSCADOR, formConstants.TYPE, formConstants.URL_HOTEL, formConstants.VIRTUAL_HOTEL, formConstants.START_DATE, formConstants.END_DATE],
        elements: {}
      },
      constants: formConstants,
      constantsWithHash: constantsWithHash
    },
    $reservationForm = null,
    occupancyRange ={};


  /**
    * @description - validate a date of range input
    * @param {object} $input - jquery object of a range date input
    */

  const isValidDate = ($input) => {
    let date = $input.val();
      let isValid = true;
      if(!date) {
        isValid = false;
      } else {
        isValid =  moment(date,'DD/MM/YYYY').isValid();
      }
      return isValid;
  };

  /**
   * @description show/hide the range dates errors
   * @param {object} $wrapper - jquery object with the wrapper of the range date input
   * @param {boolean} isError - if the date is valid or not
   */

    function _toggleInvalidRangeError($wrapper, isError) {
      const $helpBlock = $wrapper.find(".help-block");
      if (isError) {
        $helpBlock.show();
        $wrapper.addClass('has-invalid-datepicker-error has-error').removeClass("has-success-datepicker");
      } else {
        $helpBlock.hide();
        $wrapper.removeClass('has-invalid-datepicker-error has-error').addClass("has-success-datepicker");
      }
    }


  /**
   * @description get the fields id-reference (as jquery selectors) in a object to access them later on
   */

  function _getFields() {
    let id;
    for (let x = 0; x < initialVars.fields.ids.length; x++) {
      id = `#${initialVars.fields.ids[x]}`;
      initialVars.fields.elements[id] = $reservationForm.find(id);
    }
  }


  /**
   * @description - validate a range dates
   */

  function _isValidRange(){
    let isValidInitialDate = isValidDate(occupancyRange.$initRangeInput);
    let isValidFinalDate = isValidDate(occupancyRange.$endRangeInput);

    _toggleInvalidRangeError(occupancyRange.$initRangeWrapper, !isValidInitialDate);
    _toggleInvalidRangeError(occupancyRange.$endRangeWrapper, !isValidFinalDate);

    return (isValidInitialDate && isValidFinalDate);
  }

  /**
    * @description - Validate a range date
    * @param {*} $input -jquery object with the range date iniput
    * @param {object} $wrapper - jquery object with the wrapper of the range date input
    */

    function _validateRangeDate($input, $wrapper) {
      const isError = validateDate($input);
      _toggleInvalidRangeError($wrapper, isError);
      return isError;
    }


  /**
    * @description initialize the validation of range fields
    */

  function _initValidateRange() {
    occupancyRange.$initRangeErrorBlock.append(`<ul role="alert"><li>${occupancyRange.$initRangeInput.data("error")}</li></ul>`);
    occupancyRange.$endRangeErrorBlock.append(`<ul role="alert"><li>${occupancyRange.$endRangeInput.data("error")}</li></ul>`);
    occupancyRange.$initRangeInput.add(occupancyRange.$endRangeInput).on("focusout", function(ev) {
      var $this = $(this);
      var $wrapper = (this.id === "end-date") ? occupancyRange.$endRangeWrapper : occupancyRange.$initRangeWrapper;
      _validateRangeDate($this, $wrapper);
    });

    occupancyRange.$initRangeInput.on("change", function() {
      occupancyRange.$initRangeInput.trigger("focusout");
      occupancyRange.$endRangeInput.trigger("focusout");
    });

    occupancyRange.$endRangeInput.on("change", function() {
      occupancyRange.$endRangeInput.trigger("focusout");
    });
  }

  function _setFormSelectors($formSelector){
    $reservationForm = $formSelector;
    occupancyRange = {
      $rangeSelector: $formSelector.find(".range-calendar"),
      get $initRangeWrapper() {
        return this.$rangeSelector.find(".init-range-calendar .js-input-wrapper");
      },
      get $endRangeWrapper() {
        return this.$rangeSelector.find(".end-range-calendar .js-input-wrapper");
      },
      get $initRangeInput() {
        return this.$initRangeWrapper.find("input.date-select");
      },
      get $endRangeInput() {
        return this.$endRangeWrapper.find("input.date-select");
      },
      get $initRangeErrorBlock() {
        return this.$initRangeWrapper.find(".help-block");
      },
      get $endRangeErrorBlock() {
        return this.$endRangeWrapper.find(".help-block");
      }
    };
  }

  function _getSelectors(){
    return {
      initialVars: initialVars,
      occupancyRange: occupancyRange
    };
  }

  function init($formSelector){
    _setFormSelectors($formSelector);
    _getFields();
  }

  return {
    init: init,
    getSelectors: _getSelectors,
    isValidRange: _isValidRange,
    initValidateRange: _initValidateRange
  };

})();


// NEWER
const reservationOccupancy = (() => {

  var $reservationOccupancyView = $('.m-occupancy'),
      $roomsAmmountCounter = $reservationOccupancyView.find(".add-room-link"),
      $occupancyContainer = $reservationOccupancyView.find(".occupancy-content"),
      $roomMessage = $reservationOccupancyView.find(".room-message"),
      $ocupancyRooms = $occupancyContainer.find(".option-list"),
      $parentModal,
      $acceptOccupancyButton = $occupancyContainer.find("#acceptOccupancy");


  // Resumen de Pax de TODAS las habitaciones
  var occupancyInfoData = {
    adults: 0,
    children: 0,
    babies: 0
  };

  var roomsData = {
    $container: $ocupancyRooms,
    $rooms: null,
    $visibleRooms: [],
    roomsList: [],
    visibleRoomsList: [],
    $roomsInfo: null
  };

  var labelsData = $occupancyContainer.data('labels') || {rooms:"rooms",room:"room",adults:"adults", adult:"adult", children: "children", child: "child", babies: "babies", baby: "baby"}

  var $roomMessage = $reservationOccupancyView.find(".room-message");

  var roomsAllowed = {
    max: ($roomsAmmountCounter.data("maxRooms")) ? $roomsAmmountCounter.data("maxRooms") : 5,
    min: ($roomsAmmountCounter.data("minRooms")) ? $roomsAmmountCounter.data("minRooms") : 1
  };

  // Number of rooms to display initially
  var visibleRooms = 1;

  function init(parentModal = null) {

    var $currentRoom = null;
    var availableRoom = null;
    var $currentRoomInfo = null;
    var isVisibleRoom = true;


    $parentModal = parentModal;


    // Extend the controlling option with the Subject class
    extend(this, new Subject());

    roomsData.$rooms = roomsData.$container.find(".option");//colección de objetos jQuery de habitaciones (con sus selectores,...)

    if(roomsData.$rooms.length) { //$rooms 5

      roomsData.$rooms.each(function(index) {

        //FIELDSET
        $currentRoom = $(this);

        isVisibleRoom = (index < visibleRooms);

        $currentRoom.toggleClass("hidden", !isVisibleRoom);

        /*$currentRoom.toggleClass(function(){
          return (!isVisibleRoom)? "hidden" : "";
        });*/

        // Crea cada instancia de habitación hasta el max de habitaciones permitidas
        availableRoom = new Room(index);

        roomsData.roomsList.push(availableRoom);
        // roomsData
          // roomsList = Array de Todas las habitaciones, instancia de new Room

          // visibleRoomList = Array de instancias new Room Activas/Visibles
          // $visibleRooms = Array de nodos DOM de jquery de Room Activas/Visibles

        availableRoom.init($currentRoom);
        reservationOccupancy.addObserver(availableRoom);

        if(isVisibleRoom) {
          roomsData.$visibleRooms.push($currentRoom);
          roomsData.visibleRoomsList.push(availableRoom);
        }
      });
    }

    $($roomsAmmountCounter).on("click", _onAddRoom);

    //$acceptOccupancyButton.on("click", onClickAcceptOcuppancy); // antiguo "aceptar" de "Mas Opciones"
  }

  /**
   * @description - update the global ocuppancy of the reservation
   * @param {number} roomIndex el indice de la habitación que se está modificando
   * @param {string} paxType  el tipo de ocupación modificada (adultos, niños, bebés)
   */
  function update(roomIndex, paxType) {
    occupancyInfoData[paxType] = (occupancyInfoData[paxType] - roomsData.roomsList[roomIndex].oldPax[paxType] + roomsData.roomsList[roomIndex].pax[paxType]);

    this.notify(); //lanzo los updates de las rooms
  }

  function getRoomData(){
    return roomsData;
  }
  function getMaxRooms(){
    return roomsAllowed;
  }

  /***********************/
  /*** PRIVATE METHODS ***/
  /***********************/

  /**
   * @description - add new rooms
   * @param {number} roomsNumberSelected - number of rooms selected
   */
  function _addRooms() {

    let index = roomsData.visibleRoomsList.length;

    if(index >= 12) {

      return false;

    }

    roomsData.$rooms.eq(index).removeClass('hidden').css('display', 'flex');
    roomsData.$visibleRooms.push(roomsData.$rooms.eq(index));
    roomsData.visibleRoomsList.push(roomsData.roomsList[index]);

    roomsData.roomsList[index].setUpRoom();
  }

  function _onAddRoom(ev) {

    ev.preventDefault();
    const value =  roomsData.visibleRoomsList.length;

    if(value < roomsAllowed.max) {
      //_addRooms();

      console.log("habitaciones visibles: " + roomsData.visibleRoomsList);

      const summaryText =calculateOcuppancyText();
      $('.room-resume').html(summaryText.longSummary);
    }

    $roomMessage.toggle(value > roomsAllowed.max);
    $ocupancyRooms.toggle(value <= roomsAllowed.max);

  }

  function removeRoom(roomIndex) {
      let i;

      const hasRemovedRoom = roomsData.visibleRoomsList.some(function(element, index) {
        if(element.index === roomIndex) {
          i = index;
          return true;
        }
      });

      if (hasRemovedRoom) {
        for (let x = i +1; x < roomsData.visibleRoomsList.length; x++) {
          roomsData.visibleRoomsList[x - 1].copyRoomPax(roomsData.visibleRoomsList[x]);
        }

        roomsData.visibleRoomsList[roomsData.visibleRoomsList.length-1].resetRoom();
        roomsData.$visibleRooms[roomsData.$visibleRooms.length-1].addClass('hidden');
        roomsData.$visibleRooms.pop();
        roomsData.visibleRoomsList.pop();
      }
  }


  /**
   * @description - handle click over accept occupancy button
   */

  function calculateOcuppancyText() {
    var roomsNumber = roomsData.visibleRoomsList.length;
    var occupancyText = null,
        occupancyTextShort;

    var occupancyLabels = {
      get rooms() {
        var tag = (roomsNumber > 1) ? "rooms" : "room";
        var label = (labelsData[tag]) ? labelsData[tag] : tag;
        return label;
      },
      get adults() {
        var tag = (occupancyInfoData.adults > 1) ? "adults" : "adult";
        var label = (labelsData[tag]) ? labelsData[tag] : tag;
        return label;
      },
      get children() {
        var tag = (occupancyInfoData.children > 1) ? "children" : "child";
        var label = (labelsData[tag]) ? labelsData[tag] : tag;
        return label;
      },
      get babies() {
        var tag = (occupancyInfoData.babies > 1) ? "babies" : "baby";
        var label = (labelsData[tag]) ? labelsData[tag] : tag;
        return label;
      }
    };

    occupancyText = `${roomsNumber} ${occupancyLabels.rooms}, ${occupancyInfoData.adults} ${occupancyLabels.adults}, ${occupancyInfoData.children} ${occupancyLabels.children}, ${occupancyInfoData.babies} ${occupancyLabels.babies}`;
    occupancyTextShort = `${roomsNumber} ${occupancyLabels.rooms}, ${occupancyInfoData.adults} ${occupancyLabels.adults}${(occupancyInfoData.children > 0) ? `, ${occupancyInfoData.children} ${occupancyLabels.children}` : ''}${(occupancyInfoData.babies > 0) ? `, ${occupancyInfoData.babies} ${occupancyLabels.babies}` : ''}`;

    return {
      longSummary: occupancyText,
      shortSummary: occupancyTextShort
    };

  }

  function createInfoInput($currentInfoInput) {


    // TO DO Método invocado desde fuera para Pintar input hiddens con el formato:
    //<input class="adults-info" id="adults-info-room-1" type="hidden" name="nadults1" value="2">

  }


  // Public Api
  return {
    init: init,
    update: update,
    getRoomData: getRoomData,
    getMaxRooms: getMaxRooms,
    removeRoom: removeRoom,
    calculateOcuppancyText: calculateOcuppancyText
  };
})();

const reservationOccupancyNew = (() => {
  var $reservationOccupancyViews = null;
  var reservationOccupacies = [];
  var initialized = false;

  function init(parentModal) {
    var $currentOccupancy;
    var occupancy;
    $reservationOccupancyViews = $('.m-occupancy');

    if($reservationOccupancyViews.length && !initialized) {
      $reservationOccupancyViews.each(function(index) {
        $currentOccupancy = $(this);
        occupancy = new Occupancy(index);
        reservationOccupacies.push(occupancy);
        occupancy.init($currentOccupancy, parentModal);
        initialized = true;
      });
    }
  }

  function getOccupancies() {
    return reservationOccupacies;
  }

  function getOccupancy(index) {
    return reservationOccupacies[index];
  }

  return {
    init: init,
    getOccupancies: getOccupancies,
    getOccupancy: getOccupancy
  };
})();


/***************************************/
/* CONSTRUCTOR OCCUPANCY */
/***************************************/
class Occupancy {
  constructor(ocupancyIndex) {
    this.index = ocupancyIndex;
    this.$element;
    this.$roomsAmmountCounter;
    this.$occupancyContainer;
    this.$roomMessage;
    this.$ocupancyRooms;
    this.$parentModal;
    this.$acceptOccupancyButton;
    this.$infoInput;
    this.$maxRoomsModal = null;
    this.occupancyInfoData = {
      adults: 0,
      children: 0,
      babies: 0
    };

    this.roomsData = {
      $container: null,
      $rooms: null,
      $visibleRooms: [],
      roomsList: [],
      visibleRoomsList: [],
      $roomsInfo: null
    };

    this.labelsData = {rooms:"rooms",room:"room",adults:"adults", adult:"adult", children: "children", child: "child", babies: "babies", baby: "baby"};

    this.$roomMessage;

    this.roomsAllowed = {};

    // Number of rooms to display initially
    this.visibleRooms = 1;
  }

  init($element, parentModal) {
    var $currentRoom;
    var self = this;
    var isVisibleRoom;
    var availableRoom;

    this.$element = $element;
    this.$roomsAmmountCounter = this.$element.find(".add-room-link");
    this.$occupancyContainer = this.$element.find(".occupancy-content");
    this.$roomMessage = this.$element.find(".room-message");
    this.$ocupancyRooms = this.$element.find(".option-list");
    this.$acceptOccupancyButton = this.$element.find(".room-apply");
    this.$roomMessage = this.$element.find(".room-message");
    this.labelsData = this.$element.data('labels') || this.labelsData;
    this.$infoInput = this.$element.find("input.optionRooms");
    this.$infoInputLabel = this.$infoInput.siblings(".labelup-control");
    this.$maxRoomsModal = $("#modal-max-rooms");
    this.$parentModal = parentModal;
    this.roomsAllowed = {
      max: (self.$roomsAmmountCounter.data("maxRooms")) ? self.$roomsAmmountCounter.data("maxRooms") : 5,
      min: (self.$roomsAmmountCounter.data("minRooms")) ? self.$roomsAmmountCounter.data("minRooms") : 1
    };

    this.roomsData.$container = this.$ocupancyRooms;
    this.targetElement = $(this.$element)[0].querySelector(".option-list");

    // Extend the controlling option with the Subject class
    extend(this, new Subject());

    this.roomsData.$rooms = this.roomsData.$container.find(".option");//colección de objetos jQuery de habitaciones (con sus selectores,...)

    if(this.roomsData.$rooms.length) {

      this.roomsData.$rooms.each(function(index) {


        $currentRoom = $(this);

        isVisibleRoom = (index < self.visibleRooms);

        $currentRoom.toggleClass("hidden", !isVisibleRoom);

        // Crea cada instancia de habitación hasta el max de habitaciones permitidas
        availableRoom = new Room(index);

        self.roomsData.roomsList.push(availableRoom);

        availableRoom.init($currentRoom, self);
        self.addObserver(availableRoom);

        if(isVisibleRoom) {
          self.roomsData.$visibleRooms.push($currentRoom);
          self.roomsData.visibleRoomsList.push(availableRoom);
        }
      });
      this.hideCloseIconInFirstRoom({remove: null});
    }

    self.$roomsAmmountCounter.on("click", {self: self}, this._onAddRoom);

    this.$element.data("occupancy-index", this.index);
    this.$infoInput.val(this.calculateOcuppancyText().shortSummary);

    this.$infoInputLabel.addClass("focus");

    this.$acceptOccupancyButton.on("click", function(ev) {
      const summaryText = self.calculateOcuppancyText();
      $('.room-resume').html(summaryText.longSummary);
      self.$infoInput.data("info",summaryText.shortSummary);
    });



    // ------------------------------------------------------------
    // Cerrar modal fake de occupancy

    const $occupancyWrapper = $(self.roomsData.$container).parents('.m-occupancy-wrapper');

    $(this.roomsData.$container).parents('.m-occupancy').find('.room-close.nh-ic-close').click(function (e) {

      var $this = $(this);
      var parent = $this.parents(".room-close");

      if(!parent.hasClass("delete-room")) {
        $occupancyWrapper.removeClass('is-open');
        bodyScrollLock.enableBodyScroll(self.targetElement);
      }
    });
  }

  hideCloseIconInFirstRoom(action) {

    if(this.roomsData.$visibleRooms.length === 1 || this.roomsData.$visibleRooms.length + 1 < 2 && action.remove) {
        this.roomsData.$visibleRooms[0].find('.option-box.title button').prop('disabled', true).addClass('hidden');
      } else {
        this.roomsData.$visibleRooms[0].find('.option-box.title button').prop('disabled', false).removeClass('hidden');
      }
  }

  generateInputsFields(){
    let htmlTemplate = '';
    this.roomsData.visibleRoomsList.forEach((element,index) => {
      htmlTemplate +=`<input type="hidden" name="nbabies${index+1}" value="${element.paxSelects[0].value}">
                      <input type="hidden" name="nchilds${index+1}" value="${element.paxSelects[1].value}">
                      <input type="hidden" name="nadults${index+1}" value="${element.paxSelects[2].value}">`;
    });
    return htmlTemplate;
  }

  generateOccupancyInfo() {
    let self = this;
    let info = {
      inputs:"",
      pax: this.occupancyInfoData,
      ages:"",
      rooms: this.roomsData.visibleRoomsList.length,
      get roomsField() {
        return `<input type="hidden" name="rooms" value="${this.rooms}">`;
      }
    };
    this.roomsData.visibleRoomsList.forEach((element,index) => {
      info.inputs +=`<input type="hidden" name="nbabies${index+1}" value="${element.paxSelects[0].value}"><input type="hidden" name="nchilds${index+1}" value="${element.paxSelects[1].value}"><input type="hidden" name="nadults${index+1}" value="${element.paxSelects[2].value}">`;
      info.ages += self.getPaxAges("children", element.pax.children) + self.getPaxAges("babies", element.pax.babies);
    });

    info.ages = info.ages.slice(0, -1);
    return info;
  }

  getPaxAges(type, paxNumber) {
    var age = (type === "children") ? "7|" : "1|";
    var text = "";
    for (let x=1; x <= paxNumber; x++){
      text += age;
    }
    return text;
  }

  /**
   * @description - update the global ocuppancy of the reservation
   * @param {number} roomIndex el indice de la habitación que se está modificando
   * @param {string} paxType  el tipo de ocupación modificada (adultos, niños, bebés)
   */
  update(roomIndex, paxType) {
    this.occupancyInfoData[paxType] = (this.occupancyInfoData[paxType] - this.roomsData.roomsList[roomIndex].oldPax[paxType] + this.roomsData.roomsList[roomIndex].pax[paxType]);
    this.notify(); //lanzo los updates de las rooms
  }
  getRoomData(){
    return this.roomsData;
  }
  getMaxRooms(){
    return this.roomsAllowed;
  }

  _scrollToElement($el, $container) {
    $($el)[0].scrollIntoView();
  }
  _scrollToElementjQuery($el, $container) {

  const moveToOffset = $el.position().top;
  $($container).animate({
    scrollTop: moveToOffset,
    useTranslate3d:true
  }, 200, "linear");
}

  _isMobile () {
    return ( window.matchMedia('(max-width: 767px)').matches );
}

  /**
   * @description - add new rooms
   * @param {number} roomsNumberSelected - number of rooms selected
   */
  _addRooms() {

    let index = this.roomsData.visibleRoomsList.length;
    this.roomsData.$rooms.eq(index).removeClass('hidden').css('display', 'flex');
    this.roomsData.$visibleRooms.push(this.roomsData.$rooms.eq(index));
    this.roomsData.visibleRoomsList.push(this.roomsData.roomsList[index]);

    this.roomsData.roomsList[index].setUpRoom();
  }

  _onAddRoom(ev) {
    const _this = ev.data.self;
    const value =  _this.roomsData.visibleRoomsList.length;
    const $container = _this.$occupancyContainer.find('.option-list');
    let summaryText = null;

    ev.preventDefault();

    $(_this.$ocupancyRooms).find('.option').eq(0).css({'pointer-events': 'auto'})

    if(value >= _this.roomsAllowed.max) {
      _this.$maxRoomsModal.modal("show");
      return false;
    }

    if(value < _this.roomsAllowed.max) {
      _this._addRooms();

      if (_this._isMobile()) {
        _this._scrollToElement(_this.roomsData.$visibleRooms[value], $container);
      } else {
        _this._scrollToElementjQuery(_this.roomsData.$visibleRooms[value], $container);
      }

      _this.hideCloseIconInFirstRoom({remove: false});

      summaryText = _this.calculateOcuppancyText();

      $('.room-resume').html(summaryText.longSummary);
      _this.$infoInput.data("info", summaryText.shortSummary);
    }

    _this.$roomMessage.toggle(value > _this.roomsAllowed.max);
    _this.$ocupancyRooms.toggle(value <= _this.roomsAllowed.max);

  }

  removeRoom(roomIndex) {
    let i;

    const hasRemovedRoom = this.roomsData.visibleRoomsList.some(function(element, index) {
      if(element.index === roomIndex) {
        i = index;
        return true;
      }
    });

    if (hasRemovedRoom) {
      for (let x = i +1; x < this.roomsData.visibleRoomsList.length; x++) {
        this.roomsData.visibleRoomsList[x - 1].copyRoomPax(this.roomsData.visibleRoomsList[x]);
      }

      this.roomsData.visibleRoomsList[this.roomsData.visibleRoomsList.length-1].resetRoom();
      this.roomsData.$visibleRooms[this.roomsData.$visibleRooms.length-1].addClass('hidden');



      this.roomsData.$visibleRooms.pop();
      this.roomsData.visibleRoomsList.pop();
    }
  }

  /**
   * @description - handle click over accept occupancy button
   */

  calculateOcuppancyText() {
    var roomsNumber = (this.roomsData.visibleRoomsList.length === 0)? 1 : this.roomsData.visibleRoomsList.length;
    var occupancyText = null,
        occupancyTextShort;
    var self = this;

    var occupancyLabels = {
      get rooms() {
        var tag = (roomsNumber > 1) ? "rooms" : "room";
        var label = (self.labelsData[tag]) ? self.labelsData[tag] : tag;
        return label;
      },
      get adults() {
        var tag = (self.occupancyInfoData.adults > 1) ? "adults" : "adult";
        var label = (self.labelsData[tag]) ? self.labelsData[tag] : tag;
        return label;
      },
      get children() {
        var tag = (self.occupancyInfoData.children > 1) ? "children" : "child";
        var label = (self.labelsData[tag]) ? self.labelsData[tag] : tag;
        return label;
      },
      get babies() {
        var tag = (self.occupancyInfoData.babies > 1) ? "babies" : "baby";
        var label = (self.labelsData[tag]) ? self.labelsData[tag] : tag;
        return label;
      }
    };

    occupancyText = `${roomsNumber} ${occupancyLabels.rooms}, ${this.occupancyInfoData.adults} ${occupancyLabels.adults}, ${this.occupancyInfoData.children} ${occupancyLabels.children}, ${this.occupancyInfoData.babies} ${occupancyLabels.babies}`;
    occupancyTextShort = `${roomsNumber} ${occupancyLabels.rooms}, ${this.occupancyInfoData.adults} ${occupancyLabels.adults}${(this.occupancyInfoData.children > 0) ? `, ${this.occupancyInfoData.children} ${occupancyLabels.children}` : ''}${(this.occupancyInfoData.babies > 0) ? `, ${this.occupancyInfoData.babies} ${occupancyLabels.babies}` : ''}`;

    return {
      longSummary: occupancyText,
      shortSummary: occupancyTextShort
    };

  }
}

/***************************************/
/* CONSTRUCTOR ROOM */
/***************************************/

class Room {
  constructor(roomIndex) {
    this.index = roomIndex;
    this.roomNumber =  (roomIndex + 1);
    this.id = "room" + this.roomNumber;
    this.occupancy;

    this.$roomSelectors = null;
    this.pax = {
        "adults": 0,
        "children": 0,
        "babies": 0,
        "totalAllowed": 12
    };
    this.oldPax = $.extend({}, this.pax);
    this.paxSelects = [];
    this.selectUpdated = null;

    this.$removeRoomIcon = null;
  }

  init($room, occupancy) {
    var currentRoom = this;
    var $currentSelect;
    var paxSelect = null;

    this.occupancy = occupancy;
    this.$removeRoomIcon = $(`.room-close[data-close = ${this.index}]`);

    $(this.$removeRoomIcon).on("click", {room: this}, this._removeRooms);


    this.roomSelectors = $room.find(".fields .controls[data-type]").get().reverse(); //get the selects in reverse order to calculate pax starting by babies
    this.$roomSelectors = $(this.roomSelectors);

    this.visible = (this.index > 0) ? false : true;

    // Extend the controlling option with the Subject class
    extend(this, new Subject());

    if(this.$roomSelectors.length) {

      // INIT EACH SELECT IN EACH ROOM
      this.$roomSelectors.each(function() {
        $currentSelect = $(this);

        paxSelect = new PaxSelect(currentRoom);
        currentRoom.paxSelects.push(paxSelect);

        currentRoom.addObserver(paxSelect);
        // paxSelect listens to currentRoom changes

        paxSelect.init($currentSelect);
      });
    }
  }

  /**
   * @description - remove rooms rooms
   * @param {ev} Clicked element to remove room - Event
   */
  _removeRooms(ev) {
    const _this = ev.data.room.occupancy;

    const rooms = _this.getRoomData(),
          $container = _this.$occupancyContainer.find('.option-list');

    // Don't allow remove the room if there's only 1
    if(rooms.visibleRoomsList.length -1 < 1 ){
      return false;
    } else {
      let value;
      let summaryText;
      $(ev.target).parents('.option').addClass("removing");

      // Blocks click on closing icon to prevent closing the First room when we have 2 rooms and close #1 during removal of #2 (animation lasts 1 sec)
      // $(_this.$ocupancyRooms).find('.option').eq(0).css({'pointer-events': 'none'})

      var $this = $(this);

      setTimeout(function() {

        _this.removeRoom(ev.data.room.index);

        value = _this.roomsData.visibleRoomsList.length;

        summaryText = _this.calculateOcuppancyText();
        $('.room-resume').html(summaryText.longSummary);
        _this.$infoInput.data("info",summaryText.shortSummary);

        if (_this._isMobile()) {
          _this._scrollToElement(_this.roomsData.$visibleRooms[value - 1], $container);
        } else {
          _this._scrollToElementjQuery(_this.roomsData.$visibleRooms[value - 1], $container);
        }
        $(ev.target).parents('.option').removeClass("removing");
        _this.hideCloseIconInFirstRoom({remove: true});

        // Unblocks the click to allow closing again in room #1
        if (value > 1) {
          $(_this.$ocupancyRooms).find('.option').eq(0).css({'pointer-events': 'auto'});
        }

      }, 500);
    }
  }

  /**
   * @description - set up the elements of the room
   * @memberof Room
   */
  setUpRoom() {

    var currentRoom = this;
    var $currentSelect;
    var $currentInfoInput = null;
    currentRoom.visible = true;


    // remove this.$roomInfo = $roomInfo;

    this.$roomSelectors.each(function(index) {
      $currentSelect = $(this);
      currentRoom.paxSelects[index].setPax($currentSelect);
    });
  }

  /**
   * @description - reset the room when it is deleted
   * @memberof Room
   */
  resetRoom() {
    var currentRoom = this;
    var $currentSelect;
    currentRoom.visible = false;
    this.$roomSelectors.each(function(index) {
      $currentSelect = $(this);
      currentRoom.paxSelects[index].resetPax($currentSelect);
    });
  }

  /**
   * @description - update the rooom data
   * @memberof Room
   */
  update() {
    this.pax.total = 0;
    for(var x = 0; x < this.paxSelects.length; x++) {
      this.pax[this.paxSelects[x].type] = this.paxSelects[x].value;
      this.pax.total += this.paxSelects[x].value;
    }

    this.oldPax.totalAllowed = this.pax.totalAllowed;
    this.pax.totalAllowed = ( this.pax.babies > 1) ? 13 : 12;
  }

  /**
   * @description update the pax occupancy of the room
   * @param {string} type type of pax updated (adults, childre, babies)
   * @param {text} value  value of the pax type
   * @memberof Room
   */
  updatePax(type, value) {
    this.oldPax[type] = this.pax[type];
    this.pax[type] = value;
    this.selectUpdated = type;
    this.occupancy.update(this.index, type);
    this.notify();
  }

  /**
   * @description update the pax of the room
   * @param {object} ocuppancy - object with the occupancy of the room by pax type (adults, children, babies)
   * @memberof Room
   */
  updateRoomPax(ocuppancy) {
    var paxSelect = null;
    var paxValue = null;
    for(let x = 0; x < this.paxSelects.length; x++) {
      paxSelect = this.paxSelects[x];
      paxValue = ocuppancy[paxSelect.type];
      paxSelect.$select.val(paxValue).trigger("change");
      paxSelect.value = paxValue;
    }
  }

  copyRoomPax(copyRoom) {
    $.each(this.paxSelects, function(index, paxSelect) {
      paxSelect.copyPax(copyRoom);
    });
  }
}

/***************************************/
/* CONSTRUCTOR SELECTOR PAX */
/***************************************/

class PaxSelect {
  constructor(room) {
    this.value = 0;
    this.type;
    this.room = room;
    this.maxValueAllowed = null;
  }

  init($currentSelect) {
    var currentPaxSelect = this;
    var preselectedValue = null;
    var type;
    this.type = $currentSelect.data("type");
    this.$select = $currentSelect;

    type = (this.type === "children") ? "childs": this.type;
    preselectedValue = utils.getUrlParameters()[`n${type}${this.room.roomNumber}`];
    $currentSelect.find('.minus, .plus').on("click", {currentPaxSelect: currentPaxSelect}, currentPaxSelect.updatePax);

    // Set the data('max') to the ammount defined in the HTML
    $(this.$select).data('max', $(this.$select).attr('data-max'));
    this.maxValueAllowed = this.$select.data('max');

    if(preselectedValue) {
      for(var x =0; x < preselectedValue; x++) {
        $currentSelect.find(".plus").trigger("click"); // Force click in + button to init adults in 2.
      }
    } else {
      if(this.type === "adults" && this.room.index === 0) {
        this.value = 1;
        $currentSelect.find(".ammount").val(this.value);
        $currentSelect.find(".plus").trigger("click"); // Force click in + button to init adults in 2.
      }
    }
  }



  /**
   * @description - disable the options of the current pax selector
   * @memberof PaxSelect
   */
  disableOptions() {
    var isDisabled;
    var $option;
    var optionValue;
    var maxValue = this.maxValueAllowed;
    var selectType = this.type;

    $(this.$select).find('.ammount').val(this.value);
    $(this.$select).data('max', maxValue);

    // Si son adultos el menor valor permitido es 1 no 0
    let minValueAllowed = 0;
    if ( selectType === 'adults' ) minValueAllowed = 1;

    (this.value === minValueAllowed )
      ? $(this.$select).find('.minus').attr('disabled', true).prop('disabled',true)
      : $(this.$select).find('.minus').attr('disabled', false).prop('disabled',false);

    (this.value === this.maxValueAllowed)
      ? $(this.$select).find('.plus').attr('disabled', true).prop('disabled',true)
      : $(this.$select).find('.plus').attr('disabled', false).prop('disabled',false);
  }




  /**
   * @description disable the selector options that can't be selected
   * @returns the number of max pax that can be select in the room
   * @memberof PaxSelect
   */
  getMaxValueAllowed() {
    var babiesValue = (this.room.pax.babies > 1) ? this.room.pax.babies : 0;
    var totalPaxSelected = this.room.pax.adults + this.room.pax.children + babiesValue;
    var totalPax = this.room.pax.totalAllowed - totalPaxSelected;

    if (this.type === "babies") {
        return  ((this.room.pax.adults + this.room.pax.children) >= 12) ? 1 : 2;
    } else {
        return (totalPax +this.room.pax[this.type]);
    }
  }

  /**
   * @description - reset the value of the pax selector to set the initial value
   * @param {object} $currentInfoInput - jquery object with the pax selector
   * @memberof PaxSelect
   */


  resetPax($currentSelect) {

    this.value = 0;
    this.room.updatePax(this.type, this.value);


    //var value = (this.type === "adults") ? "2" : "0";
    //this.value = (this.type === "adults") ? 0 : parseInt(value);
    //$currentInfoInput.val(value).trigger("change");

  }

  /**
   * @description - set the initial value of the pax selector
   * @param {object} $currentInfoInput - jquery object with the pax selector
   * @memberof PaxSelect
   */
  setPax($currentSelect) {

    if(this.type === "adults") {
      this.value = 1;

      $currentSelect.find(".ammount").html(this.value); // display the value. Move this after updatedPax function
      $currentSelect.find(".plus").trigger("click"); // Force click in + button to init adults in 2.
    } else {
      this.value = 0;
    }
  }


  /**
   * @description update the PaxSelect object
   * @memberof PaxSelect
   */
  update() {
    this.maxValueAllowed = this.getMaxValueAllowed();

    this.disableOptions();
  }

  /**
   * @description update the value of the PaxSelect object and occupancy value of the room
   * @param {object} ev event triggered
   * @memberof PaxSelect
   */
  updatePax(ev) {
    ev.preventDefault(); // Remove from code if clicked element has no default action associated (button/a ...)
    let valorActual = ev.data.currentPaxSelect.value;
    let value;
    let summaryText;
    const $data = $(ev.data.currentPaxSelect.$select);

    let maxAllowedValueInSelect = $data.data('max');
    let minAllowedValueInSelect = $data.data('min');

    if( $(ev.target).hasClass('plus') ) {

      if(valorActual == maxAllowedValueInSelect) {
        return false;
      } else {
        ++valorActual;
      }
    }

    if($(ev.target).hasClass('minus') ) {

      if(valorActual == minAllowedValueInSelect){
        return false;
      } else {
        --valorActual;
      }
    }

    value = (ev.data.currentPaxSelect.room.visible) ? valorActual : ev.data.currentPaxSelect.value;
    ev.data.currentPaxSelect.value = value;
    ev.data.currentPaxSelect.room.updatePax(ev.data.currentPaxSelect.type, value);
    summaryText = ev.data.currentPaxSelect.room.occupancy.calculateOcuppancyText();
    $('.room-resume').html(summaryText.longSummary);
    ev.data.currentPaxSelect.room.occupancy.$infoInput.data("info",summaryText.shortSummary);
  }


  copyPax(copyRoom) {
    this.value = copyRoom.pax[this.type];
    this.room.updatePax(this.type, this.value);
  }
}

var reservationOccupancyLanding = (() => {
  var $reservationOccupancyView = $('#m-reservation-occupancy');
  var $optionsRoomsSelector = $reservationOccupancyView.find("#optionRooms");
  var $optionsRoomsSelectorFake = null;
  var $occupancyContainer = $reservationOccupancyView.find(".occupancy");
  var $roomSelector = $reservationOccupancyView.find("#habs");
  var $roomMessage = $reservationOccupancyView.find(".room-message");
  var $ocupancyRooms = $occupancyContainer.find(".occupancy-rooms");
  var $roomsInfoData = $reservationOccupancyView.find("#rooms-info-data");
  var $acceptOccupancyButton = $occupancyContainer.find("#acceptOccupancy");
  var $parentModal = null;
  var occupancyInfoData = {
    adults: 0,
    children: 0,
    babies: 0
  };

  var roomsData = {
    $container: $occupancyContainer.find(".occupancy-rooms"),
    $rooms: null,
    $visibleRooms: [],
    roomsList: [],
    visibleRoomsList: [],
    $roomsInfo: null
  };

  var $roomMessage = $reservationOccupancyView.find(".room-message");

  var roomsAllowed = {
    max: ($reservationOccupancyView.data("max")) ? $reservationOccupancyView.data("max") : 5,
    min: ($reservationOccupancyView.data("min")) ? $reservationOccupancyView.data("min") : 1
  };

  var visibleRooms = 1;

  var test = {};

  function init(parentModal) {
    var $currentRoom = null;
    var availableRoom = null;
    var $currentRoomInfo = null;
    var isVisibleRoom = true;
    $parentModal = parentModal;
    $optionsRoomsSelectorFake = $reservationOccupancyView.find("[data-id='optionRooms']");


    // Extend the controlling option with the Subject class
    extend(this, new Subject());

    roomsData.$rooms = roomsData.$container.find(".occupancy-room");//colección de objetos jQuery de habitaciones (con sus selectores,...)
    roomsData.$roomsInfo = $roomsInfoData.find(".room-info");//colección de objetos jQuery con la info de cada habitación

    if(roomsData.$rooms.length) {
      roomsData.$rooms.each(function(index) {
        $currentRoom = $(this);
        isVisibleRoom = (index < visibleRooms);
        $currentRoom.toggle(isVisibleRoom);
        $currentRoomInfo = roomsData.$roomsInfo.eq(index);
        availableRoom = new RoomL(index);
        roomsData.roomsList.push(availableRoom);
        availableRoom.init($currentRoom, $currentRoomInfo);
        reservationOccupancyLanding.addObserver(availableRoom);
        if(isVisibleRoom) {
          roomsData.$visibleRooms.push($currentRoom);
          roomsData.visibleRoomsList.push(availableRoom);
        }
      });
    }

    $optionsRoomsSelector.on("change", _onChangeRoomsOptions);
    $roomSelector.on("change", _onChangeRoomsSelector);
    $acceptOccupancyButton.on("click", _onClickAcceptOcuppancy);
  }

  /**
   * @description - update the global ocuppancy of the reservation
   * @param {number} roomIndex el indice de la habitación que se está modificando
   * @param {string} paxType  el tipo de ocupación modificada (adultos, niños, bebés)
   */
  function update(roomIndex, paxType) {
    occupancyInfoData[paxType] = (occupancyInfoData[paxType] - roomsData.roomsList[roomIndex].oldPax[paxType] + roomsData.roomsList[roomIndex].pax[paxType]);
    
    //test[paxType] = (test[paxType] - roomsData.visibleRoomsList [roomIndex].oldPax[paxType] + roomsData.roomsList[roomIndex].pax[paxType]);
    this.notify(); //lanzo los updates de las rooms
  }

  /***********************/
  /*** PRIVATE METHODS ***/
  /***********************/

  /**
   * @description - add new rooms
   * @param {number} roomsNumberSelected - number of rooms selected
   */
  function _addRooms(roomsNumberSelected) {
    var index;
    var visibleRooms = roomsData.visibleRoomsList.length;
    
    for(let x = visibleRooms; x < roomsNumberSelected; x++) {
      index = x + 1;
      roomsData.$rooms.eq(x).show();
      roomsData.$visibleRooms.push(roomsData.$rooms.eq(x));
      roomsData.visibleRoomsList.push(roomsData.roomsList[x]);
      if(index > roomsData.$roomsInfo.length) {
        _setupNewRoomData(index);
        //roomsData.roomsList[x].setRoomInfo(roomsData.$roomsInfo.eq(x));
        roomsData.roomsList[x].setUpRoom(roomsData.$roomsInfo.eq(x));
      }
    }
  }

  /**
   * @description - handle change event of the number of rooms selector
   */
  function _onChangeRoomsOptions() {
    var $this = $(this);
    var optionData = {
      adults: $this.val(),
      children: 0,
      babies: 0
    };

    if($this.val() === "more") {
      $occupancyContainer.show();
    } else if($this.val()) {
      $occupancyContainer.hide();
      $roomSelector.val(1).trigger("change");
      roomsData.roomsList[0].updateRoomPax(optionData);
    }

    //controlamos la posicion de la modal al redimensionar su contenido
    if($parentModal.length) {
      $parentModal.trigger(mModals.MODAL_UPDATE_CONTENT_EVENT);
    }
  }

  /**
   * @description - handle change event of the reservation options selector
   */
  function _onChangeRoomsSelector() {
    var $this = $(this);
    var value = parseInt($this.val());
    if(value > roomsData.visibleRoomsList.length && value <= roomsAllowed.max) {
      _addRooms(value);
    } else if (value < roomsData.visibleRoomsList.length && value >= roomsAllowed.min) {
      _removeRooms(value);
    }

    $roomMessage.toggle(value > roomsAllowed.max);
    $ocupancyRooms.toggle(value <= roomsAllowed.max);
    
  }

  /**
   * @description - handle click over accept occupancy button
   */
  function _onClickAcceptOcuppancy() {
    var roomsNumber = roomsData.visibleRoomsList.length;
    var occupancyText = null;
    var labelsData = $(this).data("labels");
    var occupancyLabels = {
      get rooms() {
        var tag = (roomsNumber > 1) ? "rooms" : "room";
        var label = (labelsData[tag]) ? labelsData[tag] : tag;
        return label;
      },
      get adults() {
        var tag = (occupancyInfoData.adults > 1) ? "adults" : "adult";
        var label = (labelsData[tag]) ? labelsData[tag] : tag;
        return label;
      },
      get children() {
        var tag = (occupancyInfoData.children > 1) ? "children" : "child";
        var label = (labelsData[tag]) ? labelsData[tag] : tag;
        return label;
      },
      get babies() {
        var tag = (occupancyInfoData.babies > 1) ? "babies" : "baby";
        var label = (labelsData[tag]) ? labelsData[tag] : tag;
        return label;
      }
    };

    occupancyText = `${roomsNumber} ${occupancyLabels.rooms}, ${occupancyInfoData.adults} ${occupancyLabels.adults}, ${occupancyInfoData.children} ${occupancyLabels.children}, ${occupancyInfoData.babies} ${occupancyLabels.babies}`;

    $occupancyContainer.hide();
    $optionsRoomsSelector.find("option:first").text(occupancyText).prop("selected", true);
    $optionsRoomsSelector.selectpicker("refresh").trigger("change");
    $optionsRoomsSelectorFake.find(".filter-option").text(occupancyText);
  }

  /**
   * @description - remove rooms info data elements
   * @param {number} roomsNumberSelected - number of rooms selected
   * @param {number} numberOfRoomsToRemove - number of rooms to be removed
   */
  function _removeRoomData(roomsNumberSelected, numberOfRoomsToRemove) {
    var roomsInfoToRemove = roomsData.$roomsInfo.slice(roomsNumberSelected, roomsData.$roomsInfo.length); //ok
    roomsData.$roomsInfo.splice(roomsNumberSelected, numberOfRoomsToRemove);
    roomsInfoToRemove.remove();
  }

  /**
   * @description - remove rooms rooms
   * @param {number} roomsNumberSelected - number of rooms selected
   */
  function _removeRooms(roomsNumberSelected) {
    var totalRooms = roomsData.$visibleRooms.length;
    var numberOfRoomsToRemove = roomsData.$visibleRooms.length - roomsNumberSelected;

    roomsData.$visibleRooms.splice(roomsNumberSelected, roomsData.$visibleRooms.length);
    roomsData.visibleRoomsList.splice(roomsNumberSelected, roomsData.visibleRoomsList.length);

    for(let x = roomsNumberSelected; x < totalRooms; x++) {
      roomsData.$rooms.eq(x).hide();
      roomsData.roomsList[x].resetRoom();
    }
    
    _removeRoomData(roomsNumberSelected, numberOfRoomsToRemove);
  }

  /**
   * @description create the html elements to save the occupancy data for the new room and append it in the page
   * @param {number} index el indice de la habitación
   */
  function _setupNewRoomData(index) {
    var roomInfo = `<div class="room-info">
                      <input id="adults-info-room-${index}" type="hidden" class="adults-info" name="nadults${index}" value="2">
                      <input id="children-info-room-${index}" type="hidden" class="children-info" name="nchilds${index}" value="0">
                      <input id="babies-info-room-${index}" type="hidden" class="babies-info" name="babies${index}" value="0">
                    </div>`;

    $roomsInfoData.append(roomInfo);

    roomsData.$roomsInfo = $roomsInfoData.find(".room-info");
  }

  // Public Api
  return {
    init: init,
    update: update
  };
})();

/***************************************/
/* CONSTRUCTOR ROOM */
/***************************************/

class RoomL {
  constructor(roomIndex) {
    this.index = roomIndex;
    this.roomNumber =  (roomIndex + 1);
    this.id = "room" + this.roomNumber;
    this.$roomSelectors = null;
    this.pax = {
        "adults": 0,
        "children": 0,
        "babies": 0,
        "totalAllowed": 12
    };
    this.oldPax = $.extend({}, this.pax);
    this.paxSelects = [];
    this.selectUpdated = null;
    this.$infoRoom = null;
  }

  init($room, $roomInfo) {
    var currentRoom = this;
    var $currentSelect;
    var paxSelect = null;
    var $currentInfoInput = null;
    this.roomSelectors = $room.find("select").get().reverse(); //get the selects in reverse order
    this.$roomSelectors = $(this.roomSelectors);
    this.$roomInfo = $roomInfo;
    this.visible = (this.index > 0) ? false : true;

    // Extend the controlling option with the Subject class
    extend(this, new Subject());

    if(this.$roomSelectors.length) {
      this.$roomSelectors.each(function() {
        $currentSelect = $(this);
        $currentInfoInput = currentRoom.$roomInfo.find(`#${$currentSelect.data("type")}-info-room-${currentRoom.roomNumber}`);
        paxSelect = new PaxSelectL(currentRoom);
        currentRoom.paxSelects.push(paxSelect);
        currentRoom.addObserver(paxSelect);
        paxSelect.init($currentSelect, $currentInfoInput);
      });
    }
  }

  /**
   * @description - set up the elements of the room
   * @memberof Room
   */
  setUpRoom($roomInfo) {
    var currentRoom = this;
    var $currentSelect;
    var $currentInfoInput = null;
    currentRoom.visible = true;
    this.$roomInfo = $roomInfo;
    this.$roomSelectors.each(function(index) {
      $currentSelect = $(this);
      $currentInfoInput = currentRoom.$roomInfo.find(`#${$currentSelect.data("type")}-info-room-${currentRoom.roomNumber}`);
      currentRoom.paxSelects[index].setPax($currentSelect);
      currentRoom.paxSelects[index].setInfoInput($currentInfoInput);
    });
  }

  /**
   * @description - reset the room when it is deleted
   * @memberof Room
   */
  resetRoom() {
    var currentRoom = this;
    var $currentSelect;
    currentRoom.visible = false;
    this.$roomSelectors.each(function(index) {
      $currentSelect = $(this);
      currentRoom.paxSelects[index].resetPax($currentSelect);
    });
  }

  /**
   * @description - setup the room info elements of the room
   * @param {object} $roomInfo - jquery object with the element that contains the elements with the room info
   * @memberof Room
   */
  setRoomInfo($roomInfo) {
    var currentRoom = this;
    var $currentInfoInput = null;
    var $currentSelect;
    this.$roomInfo = $roomInfo;
    this.$roomSelectors.each(function(index) {
      $currentSelect = $(this);
      $currentInfoInput = currentRoom.$roomInfo.find(`#${$currentSelect.data("type")}-info-room-${currentRoom.roomNumber}`);
      currentRoom.paxSelects[index].setInfoInput($currentInfoInput);
    });
  }

  /**
   * @description - update the rooom data 
   * @memberof Room
   */
  update() {
    this.pax.total = 0;
    for(var x = 0; x < this.paxSelects.length; x++) {
      this.pax[this.paxSelects[x].type] = this.paxSelects[x].value;
      this.pax.total += this.paxSelects[x].value;
    }

    this.oldPax.totalAllowed = this.pax.totalAllowed;
    this.pax.totalAllowed = ( this.pax.babies > 1) ? 13 : 12;
  }

  /**
   * @description update the pax occupancy of the room
   * @param {string} type type of pax updated (adults, childre, babies)
   * @param {text} value  value of the pax type
   * @memberof Room
   */
  updatePax(type, value) {
    this.oldPax[type] = this.pax[type];
    this.pax[type] = value;
    this.selectUpdated = type;
    reservationOccupancyLanding.update(this.index, type);
    this.notify();
  }

  /**
   * @description update the pax of the room
   * @param {object} ocuppancy - object with the occupancy of the room by pax type (adults, children, babies)
   * @memberof Room
   */
  updateRoomPax(ocuppancy) {
    var paxSelect = null;
    var paxValue = null; 
    for(let x = 0; x < this.paxSelects.length; x++) {
      paxSelect = this.paxSelects[x];
      paxValue = ocuppancy[paxSelect.type];
      paxSelect.$select.val(paxValue).trigger("change");
      paxSelect.value = paxValue;
    }
  }
}

/***************************************/
/* CONSTRUCTOR SELECTOR PAX */
/***************************************/

class PaxSelectL {
  constructor(room) {
    this.value = 0;
    this.type;
    this.room = room;
    this.maxValueAllowed = null;
  }

  init($currentSelect, $currentInfoInput) {
    var currentPaxSelect = this;
    this.type = $currentSelect.data("type");
    this.$select = $currentSelect;
    this.$infoInput = $currentInfoInput;
    this.$selectPicker = $currentSelect.parents(".bootstrap-select");
    this.$options = $currentSelect.find("option");
    this.$fakeOptions = this.$selectPicker.find('li');

    $currentSelect.on("change",{currentPaxSelect: currentPaxSelect}, currentPaxSelect.updatePax);

    if(this.type === "adults" && this.room.index === 0) {
      this.value = 2;
      $currentSelect.val("2").trigger("change");
    }
  }

  /**
   * @description - disable the options of the current pax selector
   * @memberof PaxSelect
   */
  disableOptions() {
    var isDisabled;
    var $option;
    var optionValue;
    var maxValue = this.maxValueAllowed;
    var selectType = this.type;
    if(this.type !== this.room.selectUpdated) {
      this.$options.each(function() {
          $option =  $(this);
          isDisabled = parseInt($option.val()) > maxValue;
          $option.prop("disabled", isDisabled);
      });
      this.$fakeOptions.each(function() {
          $option = $(this);
          optionValue = (selectType === "adults") ? parseInt($option.data("original-index")) + 1 : parseInt($option.data("original-index"));
          isDisabled = optionValue > maxValue;
          $option.toggle(!isDisabled).toggleClass("disabled", isDisabled );
      });
    }
  }

  /**
   * @description disable the selector options that can't be selected
   * @returns the number of max pax that can be select in the room
   * @memberof PaxSelect
   */
  getMaxValueAllowed() {
    var babiesValue = (this.room.pax.babies > 1) ? this.room.pax.babies : 0;
    var totalPaxSelected = this.room.pax.adults + this.room.pax.children + babiesValue;
    var totalPax = this.room.pax.totalAllowed - totalPaxSelected;
  
    if (this.type === "babies") {
        return  ((this.room.pax.adults + this.room.pax.children) >= 12) ? 1 : 2;
    } else {
        return (totalPax +this.room.pax[this.type]);
    }
  }

  /**
   * @description - reset the value of the pax selector to set the initial value
   * @param {object} $currentInfoInput - jquery object with the pax selector
   * @memberof PaxSelect
   */
  resetPax($currentInfoInput) {
    var value = (this.type === "adults") ? "2" : "0";
    this.value = (this.type === "adults") ? 0 : parseInt(value);
    $currentInfoInput.val(value).trigger("change");
  }

  /**
   * @description - set the room info input of this pax
   * @param {object} $currentInfoInput - jquery object with the info input
   * @memberof PaxSelect
   */
  setInfoInput($currentInfoInput) {
    this.$infoInput = $currentInfoInput;
  }
  
  /**
   * @description - set the initial value of the pax selector
   * @param {object} $currentInfoInput - jquery object with the pax selector
   * @memberof PaxSelect
   */
  setPax($currentInfoInput) {
    var value = (this.type === "adults") ? "2" : "0";
    this.value = parseInt(value);
    $currentInfoInput.val(value).trigger("change");
  }

  /**
   * @description update the PaxSelect object
   * @memberof PaxSelect
   */
  update() {
    this.maxValueAllowed = this.getMaxValueAllowed();
    this.disableOptions();
  }

  /**
   * @description update the value of the PaxSelect object and occupancy value of the room
   * @param {object} ev event triggered
   * @memberof PaxSelect
   */
  updatePax(ev) {
    var value = (ev.data.currentPaxSelect.room.visible) ? parseInt(this.value) : ev.data.currentPaxSelect.value;
    //ev.data.currentPaxSelect.oldValue = ev.data.currentPaxSelect.value
    ev.data.currentPaxSelect.value = value;
    ev.data.currentPaxSelect.$infoInput.val(value);
    ev.data.currentPaxSelect.room.updatePax(ev.data.currentPaxSelect.type, value);
  }
}



const modalBookingHotelNew = ((reservationOccupancyNew) => {
  let $modalView = null;
  let $modalTrigger = null;
  let $modalSendReservationForm = null;
  let initialSearch = {};
  let initialTypeSearch;
  let fields = {
    ids: ["code", "locality", "location2", "locationLcv", "locationTCM", "tipoBuscador", "type", "urlHotel", "virtualHotel", "pcode"],
    elements: {}
  };
  let $datesTrigger = null;
  let $calendarBooking = null;
  let occupancy = null;
  let location = {
    $field: null,
    selected: null
  };
  let $occupancies = null;
  let modals = null;

  function init() {
    $modalView = $('#modal-hotel-booking');
    $modalTrigger = $('[data-target="#modal-hotel-booking"]');
    $modalSendReservationForm = $modalView.find('form');
    $modalSendReservationForm.attr("action","/");
    $datesTrigger = $modalSendReservationForm.find('.js-calendar-booking-input');
    $calendarBooking = $modalSendReservationForm.find('.m-calendar-booking');
    location.$field = $modalSendReservationForm.find("#location2");
   
    modals = {
      $loading: $("#loading-modal-results"),
      $matchError: $("#modal-search-no-result"),
      $geolocationError: $("#modal-geolocation-error")
    };
    //aquí habrá que ver como se inicializa la ocupación cuando haya busqueda realizada (check-out pages)
    reservationOccupancyNew.init($modalView);

    $occupancies = $modalSendReservationForm.find(".m-occupancy");
    occupancy = {
      obj: reservationOccupancyNew.getOccupancy($occupancies.data("occupancy-index")),
      $container: $modalSendReservationForm.find(".m-occupancy"),
      get $input() {
        return this.$container.find('.form-group');
      },
      get $dropdown() {
        return this.$container.find('.m-occupancy-wrapper');
      },
      isMobile: false
    };

    _getFields();



    //aquí habrá que pasar las fechas para inicializar los data de los calendarios a través del botón de apertura de la modal
    $calendarBooking.each(function (index, calendar) {
      let triggerData = $modalTrigger.data();
      if (triggerData.checkinDate && triggerData.checkoutDate) {
        $(calendar).data('checkinDate', triggerData.checkinDate);
        $(calendar).data('checkoutDate', triggerData.checkoutDate);
      }
      $(calendar).calendarBooking({ bookingModal: $modalView });
    });

    $modalSendReservationForm.validator({
      disable: false,
    }).on('submit', function (e) {
      var validForm = true;
      const $form = $(this);

      toggleLoadingButton($form, true);

      if (e.isDefaultPrevented()) {
        // Invalid Form
        validateBookingRange($form);
        //commonBookingHotel.isValidRange();
        toggleLoadingButton($form, false);
      } else {
        validForm = validateBookingRange($form);
        if (!$form.data("validate")) {
          e.preventDefault();
          if (!validForm) {
            _handleSubmitForm(e);
          }
        }
        toggleLoadingButton($form, false);
      }
    });

    occupancy.$input.on('click', function (e) {
      let isOpen = $(occupancy.$dropdown).hasClass('is-open');
      let alertLanguage = $('.m-language-edition');

      // Ocultar todos los dropdowns y mostrar el que nos interesa
      //$('.m-occupancy').removeClass('is-open');
      if (!isOpen) {
        $(occupancy.$dropdown).addClass('is-open');
        $modalView.trigger(mModals.MODAL_UPDATE_CONTENT_EVENT);

        // Cerrar alerta de lenguaje
        if (alertLanguage.length) $(alertLanguage).hide();

        // Colocar el dropdown dependiendo del espacio disponible (solo si no es mobile)
        //dropdownPosition(occupancy.$input, occupancy.$dropdown, 20);
      }

      // Cerrar los calendarios
      $calendarBooking.calendarBooking("close");
    });

    $datesTrigger.on('click', function (e) {
      if (occupancy.$dropdown.hasClass('is-open')) {
        occupancy.$dropdown.removeClass('is-open');
      }
    });

    // Plegar occupancy al clicar en document
    $(document).on('click', function (ev) {
      let $target = $(ev.target);
      let isOpen = occupancy.$dropdown.hasClass('is-open');
      let inDropdown = $target.closest('.m-occupancy-wrapper').length;
      let inTrigger = $target.closest('.form-group').length;
      let isCloseModal = $target.is(".modal-backdrop");
      let infoInput = occupancy.$input.find("input.optionRooms");

      if ((isOpen && !inTrigger && !inDropdown) || (isOpen && isCloseModal)) {
        $(occupancy.$dropdown).removeClass('is-open');
        infoInput.val(infoInput.data("info"));
        occupancy.$input.find('label').addClass("focus");
      }
    });


    occupancy.$dropdown.find('.room-apply').on("click", function (e) {
      let infoInput = occupancy.$input.find("input.optionRooms");
      e.preventDefault();

      if ( occupancy.isMobile ) {
        bodyScrollLock.enableBodyScroll(targetElement);
      }
      occupancy.$dropdown.removeClass('is-open');
      infoInput.val(infoInput.data("info"));
      occupancy.$input.find('label').addClass("focus");
    });

    // Listeners
    $modalView.on('show.bs.modal', _onShowModal);
    $modalView.on('hide.bs.modal', _onHideModal);
  }

  /**
   * @description behaviour of the modal before it will be showed
   * @param {object} ev - object with the event data
   */
  function _onShowModal(ev) {
    $modalTrigger = $(ev.relatedTarget);
    _setInitialData($modalTrigger.data());
  }

  /**
   * @description behaviour of the modal after it will be hidden
   */
  function _onHideModal() {
    if (initialTypeSearch) {
      fields.elements["code"].attr("name", initialTypeSearch);
    }
    if (!$.isEmptyObject(initialSearch)) {
      _fillFormFields(initialSearch);
    }
  }

  /**
   * @description - set the initial values of the modal form fields
   * @param {object} dataset object with the inital values of the fields
   */
  function _setInitialInputsValues(dataset) {
    var typesSearch = ["hotel", "poi", "destination"];
    var fieldsData = {
      "urlHotel": dataset["locationUrl"] || "",
      "virtualHotel": dataset["locationVh"] || "",
      "locationTCM": dataset["locationTcm"] || "",
      "tipoBuscador": dataset["tipoBuscador"] || "",
      "code": dataset["locationCode"] || "",
      "locality": dataset.locality || "",
      "location2": dataset.value || "",
      "pcode": dataset.pcode || "",
      "type": dataset.typesearch,
      get locationLcv() {
        var value;
        if (dataset.typesearch === "destination") {
          value = dataset["locationLcv"] || "";
        } else {
          value = dataset["locationLcv"] ? "true" : "false";
        }
        return value;
      }
    };

    if (dataset.typesearch && typesSearch.indexOf(dataset.typesearch) >= 0) {
      fields.elements["code"].attr("name", `${dataset.typesearch}Id`);
    } else {
      fields.elements["code"].removeAttr("name");
    }

    _fillFormFields(fieldsData);
    fields.elements["location2"].trigger("change");

    // Si no tiene valor location quitamos clase focus del label de location
    if (!fields.elements["location2"].val()) {
      fields.elements["location2"].closest('.input-group').find('.labelup-control').removeClass('focus');
    }

    //var deferred = $.Deferred();
    //return deferred.resolve(initialGuest);
  }

  /**
   * @description set the values of the initial search of the modal
   */
  function _setInitialSearchValues() {
    var initialSearchKeys = ["code", "location2", "locationLcv", "locationTCM", "type", "urlHotel", "virtualHotel", "pcode"];
    var key;
    for (let x = 0; x < initialSearchKeys.length; x++) {
      key = initialSearchKeys[x];
      initialSearch[key] = fields.elements[key].val();
    }
    initialTypeSearch = fields.elements.code.attr("name");
  }

  /**
   * @description set the initial values of the form inputs and initial search
   * @param {object} dataset object with the inital values of the fields
   */
  function _setInitialData(dataset) {
    _setInitialInputsValues(dataset);
    _setInitialSearchValues(dataset);
  }

  /**
   * @description - fill the form fields to be send
   * @param {object} fieldsData - object with filedId and field value
   */
  function _fillFormFields(fieldsData) {
    //var $field;
    $.each(fieldsData, function (fieldId, value) {
      fields.elements[fieldId].val(value);
    });

    if($modalTrigger.data("value") && !$modalTrigger.data("selected")) {
      _setPreselectedHotel();
    }
  }

  function _setPreselectedHotel() {
    _getPreselectedHotel().then(function(response) {
      $modalTrigger.data("selected", response);
      location.$field.data("selected", response);
    }, function(error) {
      alert(error.Message);
    });
  }

  function _getPreselectedHotel() {
    let promise; 
    promise = $.ajax({
      type: "GET",
      url:  Globals.subdomain + '/rest/auto/autocomplete/' + $modalTrigger.data("name"),
      dataType: "json",
      cache: true
    });

    return promise.then(function(response) {
      return response[0][0];
    }, function(error) {
      return error;
    });
  }

  /**
   * @description save the fileds id reference in a object to have access to them
   */
  function _getFields() {
    var id;
    for (let x = 0; x < fields.ids.length; x++) {
      //id = `.${fields.ids[x]}`;
      id = `[data-id='${fields.ids[x]}']`;
      fields.elements[fields.ids[x]] = $modalSendReservationForm.find(id);
    }
  }

  function _handleSubmitForm() {
    location.selected = location.$field.data("selected") || JSON.parse(sessionStorage.getItem("listSearch"));
    modals.$loading.modal({
      show: true,
      backdrop: "static",
      keyboard: false
    });
    _onFormSubmit();
  }

  function _onFormSubmit(ev) {
    let occupancyInfo = occupancy.obj.generateOccupancyInfo();
    let formData = {};
    let dataUrl = null;
    let checkin;
    let checkout;

    $modalSendReservationForm.append(occupancyInfo.inputs).append(occupancyInfo.roomsField);

    if (location.selected) {
      $.each($modalSendReservationForm.serializeArray(), function (index, obj) {
        formData[obj.name] = obj.value;
      });

      formData.fini = (formData.fini) ? formData.fini : moment().format("DD/MM/YYYY");
      formData.fout = (formData.fout) ? formData.fout : moment().add(1, 'day').format("DD/MM/YYYY");

      checkin = moment(formData.fini, location.selected.df);
      checkout = moment(formData.fout, location.selected.df);

      if (location.selected.ebp && location.selected.url) {
        ev.preventDefault();
        dataUrl = {
          hotelID: formData.hotelId,
          checkinDate: checkin.format(location.selected.df),
          checkoutDate: checkout.format(location.selected.df),
          get nights() {
            return checkout.diff(checkin, 'days');
          },
          adults: occupancyInfo.pax.adults,
          children: occupancyInfo.pax.children + occupancyInfo.pax.babies,
          roomsNumber: occupancyInfo.rooms,
          childages: (occupancyInfo.ages.length > 1) ? occupancyInfo.ages : ""
        };

        window.location.href = _getRedirectUrl(location.selected.url, dataUrl);
        return;
      } else {
        if($("main").hasClass("p-hotel")){
         if (location.selected.typeSearch == "destination") {      
            action = Globals.subdomain + "/booking/hotels/" + location.selected.lcv;        
         }else{
            action = Globals.subdomain + "/booking/step1-rates";      
         }
         $modalSendReservationForm.attr("action",action);
         modifyPAramForm()
        }else{
          $modalSendReservationForm.data("validate", true).trigger("submit");
        }      
      }
    }
  }

  // EY, añadimos los parametros en el form para enviar por Get
  function modifyPAramForm() {
    $modalSendReservationForm.find("input[name='fini']").val(decodeURIComponent($modalSendReservationForm.find("input[name='fini']").val()))
    $modalSendReservationForm.find("input[name='fout']").val(decodeURIComponent($modalSendReservationForm.find("input[name='fout']").val()))
    $modalSendReservationForm.find("input[name='searchStringID']").attr('disabled', 'disabled');
    $modalSendReservationForm.find("input[name='divisa']").attr('disabled', 'disabled');
    $modalSendReservationForm.find("input[name='occupancy']").attr('disabled', 'disabled');
    var dataArray = $modalSendReservationForm.serializeArray(),
      dataObj = {};
    $(dataArray).each(function (i, field) {
      dataObj[field.name] = field.value;
    });
    ruta = $modalSendReservationForm.attr('action') + "?" + serialize(dataObj);
    window.location.href = ruta;
    return;
  }
  function serialize(obj) {
    var str = [];
    for (var p in obj)
      if (obj.hasOwnProperty(p)) {
        str.push(encodeURIComponent(p) + "=" + obj[p]);
      }
    return str.join("&");
  }

  // parsed url
  function _getRedirectUrl(tpl, data) {
    return tpl.replace(/\[(.*?)\]/gmi, function (match, p1) {
      var prop = p1.trim();
      return data.hasOwnProperty(prop) ? data[prop] : '';
    });
  }

  return {
    init: init
  };

})(reservationOccupancyNew);


$(() => {

  // Only init this module if the Form is not already rendered in screen:
  //  Will be opened in Modal (there's a data-target = #modal-hotel-booking in any element of the page)

  if ($('[data-target = #modal-hotel-booking]').length) {
    modalBookingHotelNew.init();
  }
});



var modalBookingHotelLanding = ((reservationOccupancy) => {
  var $modalReservation = $('#modal-hotel-booking-landing');
  var $modalSendReservationForm =  $modalReservation.find('form');
  var initialSearch = {};
  var initialTypeSearch;
  var fields = {
    ids: ["code", "locality", "location2", "locationLcv", "locationTCM", "tipoBuscador", "type", "urlHotel", "virtualHotel"],
    elements: {}
  };
  var occupancyRange = {
    $rangeSelector: $modalSendReservationForm.find(".range-calendar"),
    get $initRangeWrapper() {
      return this.$rangeSelector.find(".init-range-calendar .js-input-wrapper");
    },
    get $endRangeWrapper() {
      return this.$rangeSelector.find(".end-range-calendar .js-input-wrapper");
    },
    get $initRangeInput() {
      return this.$initRangeWrapper.find("input.date-select");
    },
    get $endRangeInput() {
      return this.$endRangeWrapper.find("input.date-select");
    },
    get $initRangeErrorBlock() {
      return this.$initRangeWrapper.find(".help-block");
    },
    get $endRangeErrorBlock() {
      return this.$endRangeWrapper.find(".help-block");
    }
  };

  
  function init() {
    reservationOccupancy.init($modalReservation);
    _getFields();

    $modalSendReservationForm.validator({
      disable: false,
    }).on('submit', function(e) {
      var validForm = true;
      var $form = $(this);
      toggleLoadingButton($form, true);
      if (e.isDefaultPrevented()) {
        // Invalid Form
        _isValidRange();
        toggleLoadingButton($form, false);
      } else {
        validForm = _isValidRange();
        if(!validForm) {
          e.preventDefault();
        }
        toggleLoadingButton($form, false);
      }
    });

    if(occupancyRange.$rangeSelector.data("range-required")) {
      _initValidateRange();
    }

    // Listeners
    $modalReservation.on('show.bs.modal', _onShowModal);
    $modalReservation.on('hide.bs.modal', _onHideModal);
  }


  /**
   * @description - fill the form fields to be send
   * @param {object} fieldsData - object with filedId and field value
   */
  function _fillFormFields(fieldsData) {
    //var $field;
    $.each(fieldsData, function(fieldId, value) {
      fields.elements[fieldId].val(value);
    });
  }

  /**
   * @description save the fileds id reference in a object to have access to them
   */
  function _getFields() {
    var id;
    for (let x = 0; x < fields.ids.length; x++) {
      id = `[data-id='${fields.ids[x]}']`;
      fields.elements[fields.ids[x]] = $modalSendReservationForm.find(id);
    }
  }

  /**
   * @description initialize the validation of range fields
   */
  function _initValidateRange() {
    occupancyRange.$initRangeErrorBlock.append(`<ul role="alert"><li>${occupancyRange.$initRangeInput.data("error")}</li></ul>`);
    occupancyRange.$endRangeErrorBlock.append(`<ul role="alert"><li>${occupancyRange.$endRangeInput.data("error")}</li></ul>`);

    occupancyRange.$initRangeInput.add(occupancyRange.$endRangeInput).on("focusout", function(ev) {
      console.log("ev focusout range", ev);
      var $this = $(this);
      var $wrapper = (this.id === "end-date") ? occupancyRange.$endRangeWrapper : occupancyRange.$initRangeWrapper;
      _validateRangeDate($this, $wrapper);
    });

    occupancyRange.$initRangeInput.on("change", function() {
      occupancyRange.$initRangeInput.trigger("focusout");
      occupancyRange.$endRangeInput.trigger("focusout");
    });

    occupancyRange.$endRangeInput.on("change", function() {
      occupancyRange.$endRangeInput.trigger("focusout");
    });
  }

  /**
   * @description - validate a date of range input
   * @param {object} $input - jquery object of a range date input
   */
  function _isValidDate($input) {
    var date = $input.val();
    var isValid = true;
    if(!date) {
      isValid = false;
    } else {
      isValid =  moment(date,'DD/MM/YYYY').isValid();
    }
    return isValid;
  }

  /**
   * @description - validate a range dates
   */
  function _isValidRange() {
    var isValidInitialDate = _isValidDate(occupancyRange.$initRangeInput);
    var isValidFinalDate = _isValidDate(occupancyRange.$endRangeInput);

    _toggleInvalidRangeError(occupancyRange.$initRangeWrapper, !isValidInitialDate);
    _toggleInvalidRangeError(occupancyRange.$endRangeWrapper, !isValidFinalDate);

    return (isValidInitialDate && isValidFinalDate);
  }

  /**
   * @description behaviour of the modal before it will be showed
   * @param {object} ev - object with the event data
   */
  function _onShowModal(ev) {
    var $modalTrigger = $(ev.relatedTarget);
    var dataset = $modalTrigger.data();
    _setInitialData($modalTrigger.data());
  }

  /**
   * @description behaviour of the modal after it will be hidden
   */
  function _onHideModal() {
    if (initialTypeSearch) {
      fields.elements["#code"].attr("name", initialTypeSearch);
    }
    if (!$.isEmptyObject(initialSearch)) {
      _fillFormFields(initialSearch);
    }
  }

  /**
   * @description - set the initial values of the modal form fields
   * @param {object} dataset object with the inital values of the fields
   */
  function _setInitialInputsValues(dataset) {
    var typesSearch = ["hotel", "poi", "destination"];
    var fieldsData = {
      "urlHotel": dataset["locationUrl"] || "",
      "virtualHotel": dataset["locationVh"] || "",
      "locationTCM": dataset["locationTcm"] || "",
      "tipoBuscador": dataset["tipoBuscador"] || "",
      "code": dataset["locationCode"] || "",
      "locality": dataset.locality || "",
      "location2": dataset.value || "",
      "type": dataset.typesearch,
      get locationLcv() {
        var value;
        if(dataset.typesearch === "destination") {
          value = dataset["locationLcv"] || "";
        } else {
          value = dataset["locationLcv"] ? "true" : "false";
        }
        return value;
      }
    };

    if (dataset.typesearch && typesSearch.indexOf( dataset.typesearch) >= 0) {
      fields.elements["code"].attr("name", `${dataset.typesearch}Id`);
    } else {
      fields.elements["code"].removeAttr("name");
    }

    _fillFormFields(fieldsData);
    fields.elements["location2"].trigger("change");

    //var deferred = $.Deferred();
    //return deferred.resolve(initialGuest);
  }

  /**
   * @description set the values of the initial search of the modal
   */
  function _setInitialSearchValues() {
    var initialSearchKeys = ["code", "location2", "locationLcv", "locationTCM", "type", "urlHotel", "virtualHotel"];
    var key;
    for(let x = 0; x < initialSearchKeys.length; x++) {
      key = initialSearchKeys[x];
      initialSearch[key] = fields.elements[key].val();
    }
    initialTypeSearch = fields.elements["code"].attr("name");
  }

  /**
   * @description set the initial values of the form inputs and initial search
   * @param {object} dataset object with the inital values of the fields
   */
  function _setInitialData(dataset) {
    _setInitialInputsValues(dataset);
    _setInitialSearchValues(dataset);
  }

  /**
   * @description show/hide the range dates errors
   * @param {object} $wrapper - jquery object with the wrapper of the range date input
   * @param {boolean} isError - if the date is valid or not
   */
  function _toggleInvalidRangeError($wrapper, isError) {
    var $helpBlock = $wrapper.find(".help-block");
    if (isError) {
      $helpBlock.show();
      $wrapper.addClass('has-invalid-datepicker-error has-error').removeClass("has-success-datepicker");
    } else {
      $helpBlock.hide();
      $wrapper.removeClass('has-invalid-datepicker-error has-error').addClass("has-success-datepicker");
    }
  }

  /**
   * @description - Validate a range date
   * @param {*} $input -jquery object with the range date iniput
   * @param {object} $wrapper - jquery object with the wrapper of the range date input
   */
  function _validateRangeDate($input, $wrapper) {
    var isError = validateDate($input);
    _toggleInvalidRangeError($wrapper, isError);

    return isError;
  }

  // Public Api
  return {
    init: init
  };
})(reservationOccupancyLanding);

$(() => {
  if($('[data-target = #modal-hotel-booking-landing]').length) {
    modalBookingHotelLanding.init();
  }
});

const formBookingHotel = ( (reservationOccupancy, commonBookingHotel) => {

  const $formWrapper = $('.m-hotel-booking');
  const $reservationForm =  $formWrapper.find('form');

  let initialSearch,
    initialTypeSearch,
    fields,
    constants,
    constantsWithHash,
    occupancyRange;

  function init() {

    // Init common stuff
    commonBookingHotel.init($reservationForm);
    ({initialSearch, initialTypeSearch, fields, constants, constantsWithHash} = commonBookingHotel.getSelectors().initialVars);

    let occupancyRange = commonBookingHotel.getSelectors().occupancyRange;

    reservationOccupancy.init($formWrapper);

    $reservationForm.validator({
      disable: false,
    }).on('submit', function(e) {

      var validForm = true;
      const $form = $(this);

      toggleLoadingButton($form, true);

      if (e.isDefaultPrevented()) {
        // Invalid Form
        commonBookingHotel.isValidRange();
        toggleLoadingButton($form, false);
        } else {
            validForm = commonBookingHotel.isValidRange();
            if(!validForm) {
                e.preventDefault();
            }
            toggleLoadingButton($form, false);
        }
    });

      if(occupancyRange.$rangeSelector.data("range-required")) {
        commonBookingHotel.initValidateRange();
      }
  }

  // Public Api
  return {
    init: init
    };

})(reservationOccupancy, commonBookingHotel);

$(() => {
  // Only init this module if the Form is already rendered in screen (not modal)
  if($(".m-hotel-booking").length) {
    formBookingHotel.init();
  }
});


const locationAndDateBookForm = ( (reservationOccupancy) => {
	const $reservation = $('.m-hotel-booking');
	const $sendReservationForm =  $reservation.find('form');
	
})(reservationOccupancy);

/*let initialSearch = {},
		initialTypeSearch;

	const fields = {
		ids: ["code", "locality", "location2", "locationLcv", "locationTCM", "tipoBuscador", "type", "urlHotel", "virtualHotel"],
		elements: {}
	},
	occupancyRange = {
	    $rangeSelector: $modalSendReservationForm.find(".range-calendar"),
	    get $initRangeWrapper() {
	      return this.$rangeSelector.find(".init-range-calendar .js-input-wrapper");
	    },
	    get $endRangeWrapper() {
	      return this.$rangeSelector.find(".end-range-calendar .js-input-wrapper");
	    },
	    get $initRangeInput() {
	      return this.$initRangeWrapper.find("input.date-select");
	    },
	    get $endRangeInput() {
	      return this.$endRangeWrapper.find("input.date-select");
	    },
	    get $initRangeErrorBlock() {
	      return this.$initRangeWrapper.find(".help-block");
	    },
	    get $endRangeErrorBlock() {
	      return this.$endRangeWrapper.find(".help-block");
	    }
  	};*/
var modalNewsletterSigup = (() => {
  var modalNewsletterSigupView = $('.modal-newsletter-signup');
  var modalNewsletterSigupForm = modalNewsletterSigupView.find('form');
  var syncElements = null;
  var $errorMessage = modalNewsletterSigupView.find("#subscribe-error-message");
  var $modalTitle = modalNewsletterSigupView.find(".modal-title");
  var $successMessage = modalNewsletterSigupView.find("#subscribe-success-message");
  var $formSelects = modalNewsletterSigupForm.find('select.selectpicker');
  var $fakeFormSelects = null;

  function init() {
    $fakeFormSelects = modalNewsletterSigupForm.find('.dropdown-toggle');

    modalNewsletterSigupForm.validator({
      disable: false
    }).on('submit', function(e) {
      var $form = $(this);
      toggleLoadingButton($form, true);
      if (e.isDefaultPrevented()) {
        // Invalid Form
        toggleLoadingButton($form, false);
      } else {
        e.preventDefault();
        _onSubmitForm();
      }
    });

    // Listeners
    modalNewsletterSigupView.on('show.bs.modal', _onShowModal);
    modalNewsletterSigupView.on('hidden.bs.modal', _onHiddenModal);
  }

  /*******************/
  /* PRIVATE METHODS */
  /*******************/

  /**
   * @description - clear form fiels and hide error message;
   */
  function _clearForm() {
    modalNewsletterSigupForm.trigger("reset");
    $errorMessage.addClass("hidden");
    $.each($fakeFormSelects, function(index, element) {
      var $this = $(element);
      $this.find(".filter-option").text($formSelects.eq(index).find("option:first").text());
    });
  }

  /**
   * @description behaviour when the newsletter subscribe is successfuly
   */
  function _newsletterSubscribeSuccess() {
    $modalTitle.addClass("hidden");
    modalNewsletterSigupForm.addClass("hidden");
    $successMessage.removeClass("hidden");
    _clearForm();
  }

  /**
   * @description behaviour before the modal show
   */
  function _onShowModal(ev) {
    var $modalTriggerElement = $(ev.relatedTarget);
    var syncToElements;
    syncElements = $modalTriggerElement.data('sync-elements');

    if(syncElements && syncElements.length) {
      $.each(syncElements, (index, elem) => {
        var $this = $(elem);
        syncToElements = $this.data("sync-to-elements").join();
        $(syncToElements).val($this.val()).trigger("change");
      });
    }
  }

  /**
   * @description behaviour when the form is submitted
   */
  function _onSubmitForm() {
    $errorMessage.addClass("hidden");
    $errorMessage.addClass("hidden");
    
    var promise = $.ajax({
      type: "POST",
      url: "/newsletter/subscribeAjax",
      data: modalNewsletterSigupForm.serialize(),
      cache: false,
      async: false
    });

    promise.then((response) => {
      if(response === true) {
        _newsletterSubscribeSuccess();
      } else {
        _showErrorMessage();
      }
    }, () => {
      _showErrorMessage();
    }).always(() => {
      //habilitamos el bottom;
      toggleLoadingButton(modalNewsletterSigupForm, false);
    });
  }

  /**
   * @description behaviour after the modal is hidden
   */
  function _onHiddenModal() {
    $modalTitle.removeClass("hidden");
    modalNewsletterSigupForm.removeClass("hidden");
    $successMessage.addClass("hidden");
    _clearForm();
  }

  /**
   * @description show the error message
   */
  function _showErrorMessage() {
    $errorMessage.removeClass("hidden");
    modalNewsletterSigupView.scrollTop($errorMessage.offset().top);
    /*
    
    $modal.animate({
      scrollTop: anchorElement.offset().top,
    }, 800);
    */
  }

  // Public Api
  return {
    init: init
  };
})();

$(() => {
  if($(".modal-newsletter-signup").length) {
    modalNewsletterSigup.init();
  }
});


/**
 * Arrival Module
 * @return {[type]} [description]
 */
var mTotalPrice = (function () {
  var $priceSummary = $('#price-summary');
  var $collapseTriggers = $priceSummary.find("[data-toggle='collapse']");
  var $collapsePanels = $priceSummary.find(".panel-collapse");

  /**
   * Init Fn
   * @return {[type]} [description]
   */
  function init() {
    $collapsePanels.on("show.bs.collapse",{state: 'open'}, _togglePriceSummaryCollapseHeaderText)
    .on('hide.bs.collapse',{state: 'close'}, _togglePriceSummaryCollapseHeaderText);
  }

  function _togglePriceSummaryCollapseHeaderText(ev) {
    $collapseTriggers.html($(this).data("text-" + ev.data.state));
  }

  // Public API
  return {
    init: init
  };

})();

$(function() {
  mTotalPrice.init();
});

/**
  Modulo para gestionar el seguimiento de formularios
*/

/*var TrackForms = (() => {
  var formulary;
  var lblFilledInput = "No data entered";

  var trackedForms = {};

  function init() => {
      formulary = $("form.track-form");
      validations();
      events();
  };
  
  function setTrackedForms(formName, value) {
      if (formName && value) {
          trackedForms[formName] = value;
      }
  };

  ** PRIVATE **
  function callTrackFunctions() {
      $.each(trackedForms, function(formName, eventLeave) {
          if (formName && eventLeave) {
              var formElement = $('form[name="' + formName + '"]').length ? $('form[name="' + formName + '"]') : $("form#" + formName);
              var formLastInput = formElement.find('input[type!="hidden"][type!="submit"][type!="checkbox"]').filter(function() {
                  return $(this).val() != "";
              });
              var formLastInputId = formLastInput.last().attr("id") || lblFilledInput;
              console.log("formAbandon: ", formName, formLastInputId);
              formAbandon(formName, formLastInputId);
          }
      });
  };

  function events() {
      formulary.find("input,textarea,select").on("keydown change", function() {
          var $f = $(this).parents("form");
          var name = $f.attr("name") || $f.attr("id");
          trackedForms[name] = true;
      });
      window.onbeforeunload = function() {
          console.log("eventLeave onbeforeunload:", trackedForms);
          if (!$.isEmptyObject(trackedForms)) {
              callTrackFunctions();
          }
      };
  }

  function validations() {
      formulary.find("input,textarea,select,button").not("[type=submit]").jqBootstrapValidation({
          bindEvents: [ "blur", "change" ],
          submitError: function($form, event, errors) {
              var name = $($form).attr("name") || $($form).attr("id");
              if (name) {
                  trackedForms[name] = true;
              }
          },
          submitSuccess: function($form, event) {
              var name = $($form).attr("name") || $($form).attr("id");
              if (name) {
                  trackedForms[name] = false;
              }
          },
          filter: function() {
              return $(this).is(":visible");
          }
      });
  };


  return {
      init: init,
      setTrackedForms: setTrackedForms,
      trackedForms: trackedForms
  };
}();*/

/**
  Modulo para gestionar todas las variables, funciones de seguimiento de datos a traves de uatag,...
*/
const trackData = (() => {
  function sendUtagData() {
    (function(a, b, c, d) {
        a = "//tags.tiqcdn.com/utag/nh-hoteles/es-main-2014/prod/utag.js";
        b = document;
        c = "script";
        d = b.createElement(c);
        d.src = a;
        d.type = "text/java" + c;
        d.async = true;
        a = b.getElementsByTagName(c)[0];
        a.parentNode.insertBefore(d, a);
    })();
  }

  function trackMiceSearch(page, name, nrooms, nasistentes, nsalones, eventType) {
    try {
      utag.link({
        'eventCategory': page,
        'eventAction': 'search a meeting',
        'eventLabel': _createLabelMiceSearchData(name, nrooms, nasistentes, nsalones, eventType),
        'event': 'mice | search'});
    } catch(err) {
      utagError = err;
    }
  }
  
  function trackMiceSearchInResult(page, name, nrooms, nasistentes, nsalones, eventType) {
    try {
      utag.link({
        'eventCategory': page,
        'eventAction': 'search  a meeting',
        'eventLabel': _createLabelMiceSearchData(name,nrooms, nasistentes, nsalones, eventType),
        'event': 'mice | search results'});
    } catch(err) {
      utagError = err;
    }
  }
  
  function trackMiceSearchInDestiny(page, name, nrooms, nasistentes, nsalones, eventType) {
    try{
      utag.link({
        'eventCategory': page,
        'eventAction': 'search a meeting',
        'eventLabel': _createLabelMiceSearchData(name,nrooms, nasistentes, nsalones, eventType),
        'event': 'mice | search'});
    } catch(err) {
      utagError=err;
    }
  }

  function _createLabelMiceSearchData(name, nrooms, nasistentes, nsalones, eventType) {
    var eventLabelTrack = name + '|' + nrooms  + '|' + nasistentes + '|' + nsalones + '|' + eventType;
    return eventLabelTrack;
  }

  return {
    sendUtagData: sendUtagData,
    trackMiceSearch: trackMiceSearch,
    trackMiceSearchInResult: trackMiceSearchInResult,
    trackMiceSearchInDestiny: trackMiceSearchInDestiny
  };

})();


/*var trackData = (() => {

  function init() {
    $("#languageLinks >.dropdown-menu >li").on("click", function() {
      trackChangeLanguage(Globals.page_section, $(this).text().trim());
    });
    $(document).on("click", ".track-show-key", function(e) {
        var $this = $(this);
        if ($this.data("track")) {
            var trackData = $this.data("track");
            var hotelId = trackData.hotelId;
            var totalRooms = trackData.totalRooms;
            var totalAdults = trackData.totalAdults;
            var totalChildren = trackData.totalChildren;
            var endDate = trackData.endDate;
            var startDate = trackData.startDate;
            if (trackData.key == "rewards") {
                trackShowRewardsRate(Globals.page_section, hotelId, totalRooms, totalAdults, totalChildren, endDate, startDate);
            } else if (trackData.key == "corporate") {
                trackShowCorporateRate(Globals.page_section, hotelId, totalRooms, totalAdults, totalChildren, endDate, startDate);
            } else if (trackData.key == "platinum_vip") {
                trackShowPlatinumVipRate(Globals.page_section, hotelId, totalRooms, totalAdults, totalChildren, endDate, startDate);
            } else if (trackData.key == "nh_media") {
                trackShowNHMediaRate(Globals.page_section, hotelId, totalRooms, totalAdults, totalChildren, endDate, startDate);
            } else if (trackData.key == "travel_partner") {
                trackShowTravelPartnerRate(Globals.page_section, hotelId, totalRooms, totalAdults, totalChildren, endDate, startDate);
            } else if (trackData.key == "package") {
                trackShowPackageRate(Globals.page_section);
            }
        }
    });
    $(document).on("click", ".track-select-room", function(e) {
        var $this = $(this);
        if ($this.data("track")) {
            var trackData = $this.data("track");
            var hotelId = trackData.hotelId;
            var roomBackCodeSelected = trackData.roomTypeFrontCode;
            var startDate = trackData.startDate;
            var endDate = trackData.endDate;
            var totalRooms = trackData.totalRooms;
            var totalAdults = trackData.totalAdults;
            var totalChildren = trackData.totalChildren;
            var ratePlan = trackData.ratePlan;
            var totalBabies = trackData.totalBabies;
            if ($this.parents(".tab-pane").data("track") == "standard") {
                trackSelectRoom(Globals.page_section, hotelId, roomBackCodeSelected, startDate, endDate, totalRooms, totalAdults, totalChildren, ratePlan, totalBabies);
            } else {
                trackSelectRoomRewards(Globals.page_section, hotelId, roomBackCodeSelected, startDate, endDate, totalRooms, totalAdults, totalChildren, ratePlan, totalBabies);
            }
        }
    });
    $(".track-more-about").on("click", function() {
        var $this = $(this);
        if ($this.data("track")) {
            var trackData = $this.data("track");
            var hotelId = trackData.hotelId;
            trackMoreAbout(Globals.page_section, hotelId);
        }
    });
    $(".track-best-price,.LPMbutton").on("click", function() {
        var $this = $(this);
        if ($this.data("track")) {
            var trackData = $this.data("track");
            var hotelId = trackData.hotelId;
            trackBestPrice(Globals.page_section, hotelId);
        }
    });
    $(".track-login-box").on("click", function() {
        trackLoginBox(Globals.page_section);
    });
    $(".track-sign-up").on("click", function() {
        trackSignUp(Globals.page_section);
    });
    $(".track-book-nearby-hotels").on("click", function() {
        var $this = $(this);
        if ($this.data("track")) {
            var trackData = $this.data("track");
            var hotelId = trackData.hotelId;
            trackBookNearbyHotels(Globals.page_section, hotelId);
        }
    });
    $(".track-nearby-hotels").on("click", function() {
        var $this = $(this);
        var num = true;
        if (typeof LazyNearbyData != "undefined" && typeof LazyNearbyData.hotels != "undefined" && !$.isEmptyObject(LazyNearbyData.hotels)) {
            var result = "";
            $.each(LazyNearbyData.hotels, function(key, value) {
                if (num) {
                    result += key;
                    num = false;
                } else {
                    result += "|" + key;
                }
            });
            trackNearbyHotels(Globals.page_section, result);
        }
    });
    $(".track-modify-search").on("click", function() {
        var $this = $(this);
        if ($this.data("track")) {
            var trackData = $this.data("track");
            var hotelId = trackData.hotelId;
            var destino = $("#location2").val();
            var startDate = $("#modal-check-in").val();
            var endDate = $("#modal-check-out").val();
            var totalRooms = $("#habs").val();
            var aa = $("#modal-check-in").val();
            totalAdults = 0;
            var se = $(".js-adults-count");
            $.each(se, function(i, e) {
                var name = $(e).attr("name");
                var valor = $(e).val();
                totalAdults += parseInt($(e).val());
            });
            totalChildren = 0;
            var se = $(".js-childs-count");
            $.each(se, function(i, e) {
                var name = $(e).attr("name");
                var valor = $(e).val();
                totalChildren += parseInt($(e).val());
            });
            if ($this.parents(".modal").hasClass("modify-search")) {
                trackModifySearch(Globals.page_section, hotelId, destino, startDate, endDate, totalRooms, totalAdults, totalChildren);
            } else if ($this.parents(".modal").hasClass("modify-search-box")) {
                trackModifySearchBox(Globals.page_section, hotelId, destino, startDate, endDate, totalRooms, totalAdults, totalChildren);
            }
        }
    });
    $(".track-book").on("click", function() {
        var $this = $(this);
        if ($this.data("track")) {
            var trackData = $this.data("track");
            var hotelId = trackData.hotelId;
            var startDate = trackData.startDate;
            var endDate = trackData.endDate;
            var totalRooms = trackData.totalRooms;
            var totalAdults = trackData.totalAdults;
            var totalChildren = trackData.totalChildren;
            var ratecode = trackData.ratecode;
            var totalBabies = trackData.totalBabies;
            trackProceedToBook(Globals.page_section, hotelId, startDate, endDate, totalRooms, totalAdults, totalChildren, totalBabies, ratecode);
        }
    });
    $(".track-change-payment").click(function() {
        var $this = $(this);
        if ($this.data("track")) {
            var trackData = $this.data("track");
            var paymentMethods = trackData.paymentMethods;
            trackChangePaymentMethod(Globals.page_section, paymentMethods);
        }
    });
    $(".track-change-currency").click(function() {
        var currency = $(".track-currency").val();
        trackChangecCurrency(Globals.page_section, currency);
    });
    $(".track-add-cot").click(function() {
        trackAddCot(Globals.page_section);
    });
    $(".track-book-other-guest").click(function() {
        trackBookOtherGuest(Globals.page_section);
    });
    $("#modal-session-expire").on("show.bs.modal", function(e) {
        trackExpireBooking(Globals.page_section);
    });
    $(".track-another-book").click(function() {
        trackConfirmationOtraReserva(Globals.page_section);
    });
    $(".track-download-pdf").on("click", function() {
        trackConfirmationDownloadPdf(Globals.page_section);
    });
    $(".track-coe-modificar").click(function() {
        trackCOEModifyBill(Globals.page_section);
    });
    $(".track-coe-desacuerdo").click(function() {
        trackCOEDisagree(Globals.page_section);
    });
    $(".track-coe-cambio-hora").click(function() {
        trackCOEChangeHour(Globals.page_section);
    });
    $(".track-coe-realizado").click(function() {
        trackCOESuccess(Globals.page_section);
    });
    $(".track-coe-cancelar").click(function() {
        trackCOECancel(Globals.page_section);
    });
    $(".track-coe-abandon").click(function() {
        trackCOEAbandon(Globals.page_section);
    });
  }

  function trackClickDetectIPOrigin(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "click availability pop up",
            event: "availability | click"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackShowDetectIPOrigin(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "impression availability pop up",
            event: "availability | impression"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackChangeLanguage(page, language) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "change language",
            eventLabel: language,
            event: "header | language"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackGeneralSearch(page, name, startDate, endDate, nrooms, nadults, nchild) {
    try {
        var nights = calculateNumNights(startDate, endDate);
        utag.link({
            eventCategory: page,
            eventAction: "search",
            eventLabel: createLabelSearchData(name, startDate, endDate, nrooms, nadults, nchild),
            eventValue: nights,
            event: "home | searchbox"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackSignupNewsletter(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "sign up newsletter",
            eventLabel: "",
            event: "home | newsletter"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackSignupRewardsHome(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "sign up nh rewards",
            eventLabel: "",
            event: "home | nh rewards"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackNewGeneralSearch(page, name, startDate, endDate, nrooms, nadults, nchild) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "new search",
            eventLabel: createLabelSearchData(name, startDate, endDate, nrooms, nadults, nchild),
            eventValue: calculateNumNights(startDate, endDate),
            event: "SRP | newSearch"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackSelectHotel(page, hotelsearch, checkin, checkout, price, position, numHabis) {
    try {
        var numNights = calculateNumNights(checkin, checkout);
        var quantity = parseInt(numNights) * parseInt(numHabis);
        utag.link({
            eventCategory: page,
            eventAction: "select hotel",
            eventLabel: createLabelHotelSearchData(hotelsearch, checkin, checkout),
            eventValue: numNights,
            event: "SRP | select hotel",
            ecommerce_action: "add",
            ecommerce_actionField_list: "search results",
            products_id: [ hotelsearch ],
            products_price: [ price ],
            products_position: [ position ],
            products_quantity: [ quantity ]
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackBookHotelPage(page, hotelsearch, checkin, checkout, price, numHabis) {
    try {
        var numNights = calculateNumNights(checkin, checkout);
        var quantity = parseInt(numNights) * parseInt(numHabis);
        utag.link({
            eventCategory: page,
            eventAction: "book now",
            eventLabel: hotelsearch,
            event: "PDP | book",
            ecommerce_action: "add",
            ecommerce_actionField_list: "Hotel Page",
            products_id: [ hotelsearch ],
            products_price: [ price ],
            products_quantity: [ quantity ]
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackViewHotelPage(page, name, price, position) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "view hotel page",
            eventLabel: name,
            event: "SRP | view hotel",
            ecommerce_action: "product_click",
            ecommerce_actionField_list: "Search Results",
            products_id: [ name ],
            products_position: [ position ],
            products_price: [ price ]
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackHotelSearch(page, hotelsearch, checkin, checkout) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "search",
            eventLabel: createLabelHotelSearchData(hotelsearch, checkin, checkout),
            eventValue: calculateNumNights(checkin, checkout),
            event: "PDP | search"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackSignupRewards(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "sign up nh rewards",
            eventLabel: "",
            event: "PDP | nh rewards"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceSearch(page, name, nrooms, nasistentes, nsalones, eventType) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "search a meeting",
            eventLabel: createLabelMiceSearchData(name, nrooms, nasistentes, nsalones, eventType),
            event: "mice | search"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceSearchInResult(page, name, nrooms, nasistentes, nsalones, eventType) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "search  a meeting",
            eventLabel: createLabelMiceSearchData(name, nrooms, nasistentes, nsalones, eventType),
            event: "mice | search results"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceSearchInDestiny(page, name, nrooms, nasistentes, nsalones, eventType) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "search a meeting",
            eventLabel: createLabelMiceSearchData(name, nrooms, nasistentes, nsalones, eventType),
            event: "mice | search"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceRequestQuote(page, where, name, nrooms) {
    try {
        var eventTrack = "request a quote | " + where;
        utag.link({
            eventCategory: page,
            eventAction: eventTrack,
            eventLabel: createLabelMiceSearchDataQuote(name, nrooms),
            event: "mice | search results"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceRequestQuotePopup(page, hotel, nrooms) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "request a quote | pop up",
            eventLabel: createLabelMiceSearchDataHeader(hotel, nrooms),
            event: "micesearch | quote"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMicePersonalize(page, hotels) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "personalize event",
            eventLabel: hotels,
            event: "Micefunnel | step1"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceSendEnquiry(page, hotels) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "send enquiry",
            eventLabel: hotels,
            event: "Micefunnel | step1"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackDealsSearch(page, country, city, startDate, endDate) {
    try {
        var eventLabelTrack = country + "|" + city + "|" + startDate + "-" + endDate;
        utag.link({
            eventCategory: page,
            eventAction: "search an offer",
            eventLabel: eventLabelTrack,
            eventValue: calculateNumNights(startDate, endDate),
            event: "offers | search"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackDealsBook(page, tabName, offerName, id, position) {
    try {
        var eventLabelTrack = tabName + "|" + offerName;
        utag.link({
            eventCategory: page,
            eventAction: "book an offer",
            eventLabel: eventLabelTrack,
            event: "offers | book",
            ecommerce_action: "promo_click",
            promotions_id: [ id ],
            promotions_name: [ offerName ],
            promotions_position: [ position ],
            promotions_creative: [ tabName ]
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackShowCorporateRate(page, hotelID, roomsNumber, numberofadults, numberofchildren, endDate, startDate) {
    try {
        var eventLabelTrack = hotelID + "|" + startDate + "-" + endDate + "|" + roomsNumber + "|" + numberofadults + "|" + numberofchildren;
        utag.link({
            eventCategory: page,
            eventAction: "select Corporate rates tab",
            eventLabel: eventLabelTrack,
            event: "funnel | step1 | Corporatetab"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackShowRewardsRate(page, hotelID, roomsNumber, numberofadults, numberofchildren, endDate, startDate) {
    try {
        var eventLabelTrack = hotelID + "|" + startDate + "-" + endDate + "|" + roomsNumber + "|" + numberofadults + "|" + numberofchildren;
        utag.link({
            eventCategory: page,
            eventAction: "select nh rewards rates tab",
            eventLabel: eventLabelTrack,
            event: "funnel | step1 | nhrewtab"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackShowPlatinumVipRate(page, hotelID, roomsNumber, numberofadults, numberofchildren, endDate, startDate) {
    try {
        var eventLabelTrack = hotelID + "|" + startDate + "-" + endDate + "|" + roomsNumber + "|" + numberofadults + "|" + numberofchildren;
        utag.link({
            eventCategory: page,
            eventAction: "select PlatinumVip rates tab",
            eventLabel: eventLabelTrack,
            event: "funnel | step1 | PlatinumViptab"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackShowNHMediaRate(page, hotelID, roomsNumber, numberofadults, numberofchildren, endDate, startDate) {
    try {
        var eventLabelTrack = hotelID + "|" + startDate + "-" + endDate + "|" + roomsNumber + "|" + numberofadults + "|" + numberofchildren;
        utag.link({
            eventCategory: page,
            eventAction: "select NHMedia rates tab",
            eventLabel: eventLabelTrack,
            event: "funnel | step1 | NHMediatab"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackShowTravelPartnerRate(page, hotelID, roomsNumber, numberofadults, numberofchildren, endDate, startDate) {
    try {
        var eventLabelTrack = hotelID + "|" + startDate + "-" + endDate + "|" + roomsNumber + "|" + numberofadults + "|" + numberofchildren;
        utag.link({
            eventCategory: page,
            eventAction: "select Travel Partner rates tab",
            eventLabel: eventLabelTrack,
            event: "funnel | step1 | TravelPartnertab"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackShowPackageRate(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "select packages tab",
            event: "funnel1 | step1 | packagestab"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMoreAbout(page, name) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "clic more about",
            eventLabel: name,
            event: "funnel | Step1 | moreabout"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackBestPrice(page, name) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "claim best price",
            eventLabel: name,
            event: "funnel | Step1 | bestprice"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackBookNearbyHotels(page, name) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "book nearly hotels",
            eventLabel: "Hotel Id seleccionado de la lista de nearly:" + name,
            event: "funnel | Step1 | book nearly hotels"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackNearbyHotels(page, name) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "click nearly hotels",
            eventLabel: "Listado de hoteles cercanos: " + name,
            event: "funnel | Step1 | nearly hotels"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackLoginBox(page, name) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "login rewards box",
            event: "funnel | Step1 | login box"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackSignUp(page, name) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "sign up rewards box",
            event: "funnel | Step1 | sign up box"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackSelectRoom(page, name, roomType, startDate, endDate, nrooms, nadults, nchild, ratePlan, nbabis) {
    try {
        var eventLabelTrack = page + "|" + name + "|" + startDate + "-" + endDate + "|" + nrooms + "|" + nadults + "|" + nchild + "|" + nbabis + "|" + ratePlan;
        utag.link({
            eventCategory: page,
            eventAction: "room display",
            eventLabel: eventLabelTrack,
            eventValue: calculateNumNights(startDate, endDate),
            event: "funnel | step1 | book"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackSelectRoomRewards(page, name, roomType, startDate, endDate, nrooms, nadults, nchild, ratePlan, nbabis) {
    try {
        var eventLabelTrack = page + "|" + name + "|" + startDate + "-" + endDate + "|" + nrooms + "|" + nadults + "|" + nchild + "|" + nbabis + "|" + ratePlan;
        utag.link({
            eventCategory: page,
            eventAction: "room display| NH Rewards",
            eventLabel: eventLabelTrack,
            eventValue: calculateNumNights(startDate, endDate),
            event: "funnel | step1 | booknhrew"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackModifySearchBox(page, name, destino, startDate, endDate, nrooms, nadults, nchild) {
    try {
        var eventLabelTrack = name + "|" + destino + "|" + startDate + "-" + endDate + "|" + nrooms + "|" + nadults + "|" + nchild;
        utag.link({
            eventCategory: eventLabelTrack,
            eventAction: "modify search box",
            eventLabel: createLabelSearchData(name, startDate, endDate, nrooms, nadults, nchild),
            event: "funnel | step1 | modify box"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackModifySearch(page, name, destino, startDate, endDate, nadults, nrooms, nchild) {
    try {
        var eventLabelTrack = name + "|" + destino + "|" + startDate + "-" + endDate + "|" + nrooms + "|" + nadults + "|" + nchild;
        utag.link({
            eventCategory: page,
            eventAction: "modify search",
            eventLabel: eventLabelTrack,
            eventValue: calculateNumNights(startDate, endDate),
            event: "funnel | step1 | modify"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackProceedToBook(page, name, roomsNumber, numberofadults, numberofchildren, endDate, startDate) {
    try {
        var eventLabelTrack = name + "|" + startDate + "|" + endDate + "|" + nrooms + "|" + nadults + "|" + numberofchildren;
        utag.link({
            eventCategory: page,
            eventAction: "proceed to book",
            eventLabel: eventLabelTrack,
            eventValue: calculateNumNights(startDate, endDate),
            event: "funnel | step2"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackChangecCurrency(page, currency) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "change currency",
            eventLabel: currency,
            event: "funnel | Step1 | change currecy"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackChangePaymentMethod(page, payment) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "change paymend method",
            eventLabel: payment,
            event: "funnel | step1 | payment"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackExpireBooking(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "Expire Booking",
            event: "funnel | stept2 | Expire"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackBookOtherGuest(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "book other guest",
            event: "funnel | step2 | other guest"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackAddCot(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "add cot",
            event: "funnel | stept2 | add cot"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackProceedToBook(page, name, startDate, endDate, nrooms, nadults, nchild, nbabies, rate) {
    try {
        var eventLabelTrack = name + "|" + startDate + "-" + endDate + "|" + nrooms + "|" + nadults + "|" + nchild + "|" + nbabies + "|" + rate;
        utag.link({
            eventCategory: page,
            eventAction: "proceed to book",
            eventLabel: eventLabelTrack,
            eventValue: calculateNumNights(startDate, endDate),
            event: "funnel | step2"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackFilterAvail(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "filters use | select only available hotels",
            event: "SRP | filtersAvailability"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackFilterStars(page, stars) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "filters use | select stars",
            eventLabel: stars,
            event: "SRP | filtersStars"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackFilterPrice(page, minPrice, maxPrice) {
    try {
        var priceRange = minPrice + "-" + maxPrice;
        utag.link({
            eventCategory: page,
            eventAction: "filters use | select price range",
            eventLabel: priceRange,
            event: "SRP | filtersPrice"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackFilterServices(page, service) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "filters use | select services",
            eventLabel: service,
            event: "SRP | filterServices"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackFilterBrand(page, brand) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "filters use | select brand",
            eventLabel: brand,
            event: "SRP | filterBrand"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackFilterNearTo(page, nearTo) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "filters use | select near to",
            eventLabel: nearTo,
            event: "SRP | filterNext"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackChangeOrder(page, orderBy) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "order by",
            eventLabel: orderBy,
            event: "SRP | order"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackHotelPageCheckAvail(page, name, startDate, endDate, nrooms, nadults, nchild) {
    try {
        var nights = calculateNumNights(startDate, endDate);
        utag.link({
            eventCategory: page,
            eventAction: "search",
            eventLabel: createLabelSearchData(name, startDate, endDate, nrooms, nadults, nchild),
            eventValue: nights,
            event: "PDP | search"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackHotelPageWeather(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "see weather prediction",
            event: "PDP | weather"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackHotelPageAll(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "see all hotels in destination",
            event: "PDP | all"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceComercial(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "contact comercial team",
            event: "mice | comercial"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceNewsletter(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "sign up newsletter",
            event: "mice | newsletter"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceRequestQuoteBuscador(page, name, nrooms) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "request a quote | header",
            eventLabel: createLabelMiceSearchDataHeader(name, nrooms),
            event: "mice | search results"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceFilterStars(page, stars) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "filters use | select stars",
            eventLabel: stars,
            event: "mice | search | filtersStars"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceFilterServices(page, service) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "filters use | select services",
            eventLabel: service,
            event: "mice | search | filterServices"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceFilterBrand(page, brand) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "filters use | select brand",
            eventLabel: brand,
            event: "mice | search | filterBrand"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceFilterNearTo(page, nearTo) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "filters use | select near to",
            eventLabel: nearTo,
            event: "mice | search | filterNext"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceSalones(page, minSalones, maxSalones) {
    try {
        var salones = minSalones + "-" + maxSalones;
        utag.link({
            eventCategory: page,
            eventAction: "filters use | select meeting rooms",
            eventLabel: salones,
            event: "mice | search | filterMeetingRooms"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceRooms(page, minRooms, maxRooms) {
    try {
        var rooms = minRooms + "-" + maxRooms;
        utag.link({
            eventCategory: page,
            eventAction: "filters use | select rooms",
            eventLabel: rooms,
            event: "mice | search | filterRooms"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceCapacidad(page, minCap, maxCap) {
    try {
        var cap = minCap + "-" + maxCap;
        utag.link({
            eventCategory: page,
            eventAction: "filters use | select max capacity",
            eventLabel: cap,
            event: "mice | search | filterCapacity"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackMiceChangeOrder(page, orderBy) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "order by",
            eventLabel: orderBy,
            event: "mice | search | order"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackSelectHotelMice(page, name) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "select hotel",
            eventLabel: name,
            event: "mice | search | selecthotel"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackViewHotelMice(page, name) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "view hotel page",
            eventLabel: name,
            event: "mice | search | view hotel"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackAdvanceSearch(page, name, startDate, endDate, nrooms, nadults, nchild) {
    try {
        var nights = "";
        if (startDate != undefined && endDate != undefined) {
            nights = calculateNumNights(startDate, endDate);
        }
        utag.link({
            eventCategory: page,
            eventAction: "advanced search",
            eventLabel: createLabelSearchData(name, startDate, endDate, nrooms, nadults, nchild),
            eventValue: nights,
            event: "advsearch"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackCallBook(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "call to book",
            event: "call | book"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackCancel(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "cancel booking",
            event: "mybookings"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackModify(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "modify booking",
            event: "mybookings"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackConfirm(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "confirm booking",
            event: "mybookings"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackChat(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "chat online",
            event: "chat"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackCalendarSearch(page, name, startDate, endDate) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "book",
            eventLabel: createLabelCalendar(name, startDate, endDate),
            event: "calendar | check availability"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackTripAdvisor(page, hotel) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "read Tripadvisor reviews",
            eventLabel: hotel,
            event: "PDP | ta"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackConfirmationOtraReserva(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "book another stay",
            event: "mybookings"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function formAbandon(form, campo) {
    try {
        utag.link({
            eventCategory: form,
            eventAction: "form analysys abandon",
            eventLabel: campo,
            event: "form"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function formSuccess(form) {
    try {
        utag.link({
            eventCategory: form,
            eventAction: "form analysys success",
            event: "form"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function formError(form, campo) {
    try {
        utag.link({
            eventCategory: form,
            eventAction: "form analysys error",
            eventLabel: campo,
            event: "form"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function createLabelSearchData(name, startDate, endDate, nrooms, nadults, nchild) {
    var eventLabelTrack = name + "|" + startDate + "-" + endDate + "|" + nrooms + "|" + nadults + "|" + nchild;
    return eventLabelTrack;
  }

  function createLabelHotelSearchData(hotelsearch, checkin, checkout) {
    var eventLabelTrack = hotelsearch + "|" + checkin + "|" + checkout;
    return eventLabelTrack;
  }

  function createLabelMiceSearchDataHeader(name, nrooms) {
    var eventLabelTrack = "";
    name.each(function(hotel) {
        eventLabelTrack += $(this).attr("id") + "|" + nrooms + ",";
    });
    eventLabelTrack = eventLabelTrack.substring(0, eventLabelTrack.length - 1);
    return eventLabelTrack;
  }

  function createLabelMiceSearchData(name, nrooms, nasistentes, nsalones, fieldSearch) {
    var eventLabelTrack = name + "|" + nrooms + "," + "|" + nasistentes + "," + "|" + nsalones + "," + "|" + fieldSearch + ",";
    return eventLabelTrack;
  }

  function createLabelMiceSearchDataQuote(name, nrooms) {
    var eventLabelTrack = name + "|" + nrooms + ",";
    return eventLabelTrack;
  }

  function createLabelRoomData(name, roomType, startDate, endDate, nrooms, nadults, nchild) {
    var eventLabelTrack = name + "|" + roomType + "|" + startDate + "-" + endDate + "|" + nrooms + "|" + nadults + "|" + nchild;
    return eventLabelTrack;
  }

  function createLabelBook(name, startDate, endDate, nrooms, nadults, nchild, rate) {
    var eventLabelTrack = name + "|" + startDate + "-" + endDate + "|" + nrooms + "|" + nadults + "|" + nchild + "|" + rate;
    return eventLabelTrack;
  }

  function createLabelCalendar(name, startDate, endDate) {
    var eventLabelTrack = name + "|" + startDate + "-" + endDate;
    return eventLabelTrack;
  }

  function calculateNumNights(start, end) {
    dpg = $.fn.datepicker.DPGlobal;
    date_format = "dd/mm/yy";
    var dateFin = dpg.parseDate(end, dpg.parseFormat(date_format));
    var dateIni = dpg.parseDate(start, dpg.parseFormat(date_format));
    var diffDays = Math.floor((dateFin - dateIni) / 1e3 / 60 / 60 / 24);
    return diffDays;
  }

  var formsAnalysys = [ "flexiblePaymentForm", "flexiblePaymentPersonalForm", "flexiblePaymentRoomForm", "flexiblePaymentGarantizaForm", "prepaymentPersonalForm", "prepaymentRoomForm", "prepaymentPagoForm", "prepaymentFacturaForm", "prepaymentForm", "loginRewardsForm", "rewardsForm", "newsletterSubscribeForm", "loginb2tForm", "loginb2bForm", "b2bForm", "b2tForm", "miceOrganizeForm", "micePersonalizeForm", "signupRewardsForm" ];

  function trackPromoClick(page, promoId, promoName, promoCreative, promoPosition) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "promotion click",
            ecommerce_action: "promo_click",
            promotions_id: [ promoId ],
            promotions_name: [ promoName ],
            promotions_creative: [ promoCreative ],
            promotions_position: [ promoPosition ]
        });
    } catch (err) {
        console.log(err);
        utagError = err;
    }
  }

  function trackVirtualTourClick(page, hotel) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "virtual tour",
            eventLabel: hotel
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackTravelGuideAccede(page, guideName) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "accede to guides",
            eventLabel: guideName
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackTravelGuideAccedeFooter(page, guideName) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "accede to guides footer",
            eventLabel: guideName
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackTravelGuideBookNow(hotel) {
    try {
        utag.link({
            eventCategory: "travel guides",
            eventAction: "click in book now",
            eventLabel: hotel
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackTravelGuideSearch(page, name, startDate, endDate, nrooms, nadults, nchild) {
    try {
        var nights = calculateNumNights(startDate, endDate);
        utag.link({
            eventCategory: page,
            eventAction: "Search from guides",
            eventLabel: createLabelSearchData(name, startDate, endDate, nrooms, nadults, nchild),
            eventValue: nights,
            event: "Guides | search"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackTripAdvisorLanding(page, hotel) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "read Tripadvisor reviews",
            eventLabel: hotel,
            event: "SRP | ta"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function viewHotelGallery(page, hotel) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "view hotel gallery",
            eventLabel: hotel,
            event: "SRP | gallery"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function viewHotelsInMap(page, destination) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "view hotels in map",
            eventLabel: destination,
            event: "SRP | map"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function createLabelClickShare(name, socialName) {
    var eventLabelTrack = name + "|" + socialName;
    return eventLabelTrack;
  }

  function trackClickShare(page, name, socialName) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "share social",
            eventLabel: createLabelClickShare(name, socialName),
            event: "clickShare"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackCloseFollowUs(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "close follow us",
            event: "closeFollowUs"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackFollowUs(page, destination) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "follow us",
            eventLabel: destination,
            event: "followUs"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackSuscribirseFooter(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "subs Footer",
            event: "suscribirseFooter"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackSuscribirseModal(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "subs Modal",
            event: "suscribirseModal"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackClickDownload(page, name) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "click download",
            eventLabel: name,
            event: "clickDownload"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickHomePrintCard(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR printcard",
            eventLabel: "n/a",
            event: "home | printcard"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickHomePassBook(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR passbook",
            eventLabel: "n/a",
            event: "home | passbook"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickAppUp(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR app up",
            eventLabel: "n/a",
            event: "app"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickAppLeft(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR app left",
            eventLabel: "n/a",
            event: "app"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickAddCoholder(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR add a co holder",
            eventLabel: "n/a",
            event: "co holder"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickGoTransfer(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR go to transfer points",
            eventLabel: "n/a",
            event: "points | transfer"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickGoDonate(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR go to donate points",
            eventLabel: "n/a",
            event: "points | donate"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickTransferPoints(page, party, mail, points) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR transfer points",
            eventLabel: party + "|" + mail,
            eventValue: points,
            event: "points | transfer"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickDonatePoints(page, organization, points) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR donate points",
            eventLabel: organization,
            eventValue: points,
            event: "points | donate"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickSocial(page, social) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR social media",
            eventLabel: social,
            eventValue: "n/a",
            event: "profile | social media"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickModify(page, hotelId, localizer) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR modify",
            eventLabel: hotelId + "|" + localizer,
            eventValue: "n/a",
            event: "modify"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickReadTripAdvisor(page, hotelId) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR read Tripadvisor reviews",
            eventLabel: hotelId,
            eventValue: "n/a",
            event: "bookigns | TripAdvisor"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickRepeatStay(page, hotelId, localizer) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR repeat stay",
            eventLabel: hotelId + "|" + localizer,
            eventValue: "n/a",
            event: "bookigns | repeat stay"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickFilterFaq(page, filterUsed) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR filter FAQs",
            eventLabel: filterUsed,
            eventValue: "n/a",
            event: "customer care"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickContactUsLeft(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR contact us left",
            eventLabel: "n/a",
            eventValue: "n/a",
            event: "contact"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackRWClickMissinPoints(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "NHR missing points",
            eventLabel: "n/a",
            eventValue: "n/a",
            event: "points | missing"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackConfirmationDownloadPdf(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "download pdf",
            eventLabel: "n/a",
            event: "funnel | stept3 | pdf"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackCOEModifyBill(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "modificate bill",
            eventLabel: "n/a",
            event: "Checkout Express | Modify bill"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackCOEDisagree(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "disagree",
            eventLabel: "n/a",
            event: "Checkout Express | disagree"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackCOEChangeHour(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "change checkout hour",
            eventLabel: "n/a",
            event: "Checkout Express | Change Hour"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackCOESuccess(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "success",
            eventLabel: "n/a",
            event: "Checkout Express | Success"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackCOECancel(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "Cancel",
            eventLabel: "n/a",
            event: "Checkout Express | Cancel"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackCOEAbandon(page) {
    try {
        utag.link({
            eventCategory: page,
            eventAction: "Abandom",
            eventLabel: "n/a",
            event: "Checkout Express | Abandom"
        });
    } catch (err) {
        utagError = err;
    }
  }

  function trackLogin(eventCategory, eventLabel, eventAction) {
    try {
        utag.link({
            eventCategory: eventCategory,
            eventAction: eventAction,
            eventLabel: eventLabel,
            event: "event"
        });
    } catch (err) {
        utagError = err;
    }
  }


})();

$(() => {
 trackData.init();
});*/
var mHotelMapInline = (function() {
  var hotelMapsView = $(".m-hotel-map");
  var $mapsView;
  var markersData;
  var hotelMaps = [];
  var hotelMapsMarkers = [];
  var config;
  var $autocompleteInputs;

  var mapsData = [];
  
  function init(maps) {
    var map;
    $mapsView = maps;
    config = hotelMapModule.getDefaultConfig();

    $mapsView.each((index, mapContainer) => {
      var $this = $(mapContainer);
      var customZoom = $this.data("zoom") ? $this.data("zoom") : 13;
      var mapData = null;
      var center

      $autocompleteInputs = $(`.${$this.data("autocomplete")}`);
      markersData = MapsData.data[index].filter(Boolean);

      
      markersData.some(function(element, index) {
        if(element) {
          center = {lat: element.location[0], lng: element.location[1]};
          return true;
        }
      });

      $this.data("initial-zoom", customZoom);
      $this.data("initial-position", center);
      $this.data("map-index", index);
      config.center = center;
      config.zoom = customZoom;
      map = new google.maps.Map(mapContainer, config);
      hotelMaps.push(map);
      mapData = {
        index: index,
        map: map,
        type: "inline",
        markersInfo: markersData,
        markers: [],
        originLocation: center
      };

      hotelMapModule.setMapMarkers(mapData);
      hotelMapModule.initAutocompletes($autocompleteInputs, mapData.map);


      mapsData.push(mapData);
      hotelMapsMarkers.push(mapData.markers);
      //_initAutocompetes(mapData.map);
    });
  }

  function getMap(index) {
    //return hotelMaps[index];
    return mapsData[index].map;
  }

  function getMarkers(index) {
    //return hotelMapsMarkers[index];
    return mapsData[index].markers;
  }

  function getMapInfo(index) {
    return mapsData[index];
  }

  function toggleMarkers(visibleHotels) {
    var info = mapsData[0];
    var markerInfo;
    var isVisible = true;
    for(var x =0; x < info.markersInfo.length; x++) {
      markerInfo = info.markersInfo[x];
      if(markerInfo) {
        isVisible = visibleHotels.indexOf(markerInfo.hotelBackcode) >= 0;
        //if(visibleHotels.indexOf(markerInfo.hotelBackcode) < 0) {
          info.markers[x].setVisible(isVisible);
        //} else
      }
    }
  }

  function _initAutocompetes(currentMap) {
    if($autocompleteInputs.length) {
      $.each($autocompleteInputs, (index, input) => {
        var autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo('bounds', currentMap);
      });
    }
  }

  /*function _resetInitalMapConfig() {
    var $this = $(this);
    var mapContainer = $this.find('.m-hotel-map');
    var mapIndex = mapContainer.data("map-index");
    var map = hotelMapModule.getMap(mapIndex);
    map.setZoom(mapContainer.data("initial-zoom"));
    map.setCenter(mapContainer.data("initial-position"));
  }*/

  // PUBLIC API
  return {
    init: init,
    getMap: getMap,
    getMarkers: getMarkers,
    getMapInfo: getMapInfo,
    toggleMarkers: toggleMarkers
  };
})();

/*$(function() {
  if($(".modal-hotel-map").length) {
    hotelMapModalModule.init();
  }
});*/


var mHotelMapModal = (function() {
  var hotelMapsView = $(".modal-hotel-map");
  var $mapTriggers = $("[data-target='#modal-hotel-map']");
  var $mapView;
  var markersData;
  var config;
  var mapData;
  var $autocompleteInputs;
  var geocoder;
  var map;
  
  function init(map) {
    $mapView = map;
    config = hotelMapModule.getDefaultConfig();
    $autocompleteInputs = $(`.${$mapView.data("autocomplete")}`);

    //ver si esto se hace directamente en maqueta o por aquí
    $mapTriggers.each((index, mapTrigger) => {
      $(mapTrigger).data("map-index", index);
    });

    hotelMapsView.on('show.bs.modal', _initializeMap);

    //hotelMapsView.on('hidden.bs.modal', _resetInitalMapConfig);
  }

  function _initializeMap(ev) {
    var $modalTrigger = $(ev.relatedTarget);
    var mapIndex = $modalTrigger.data("map-index") || 0;
    var customZoom = $modalTrigger.attr("zoom") ? $modalTrigger.data("zoom") : 13;
    var location = null;
    markersData = MapsModalData.data[mapIndex];

    if(markersData[0].location) {
      location = {lat: markersData[0].location[0], lng: markersData[0].location[1]};
    } else {
      location =  {lat: 0, lng: 0};
    }
    $mapView.html();
    $mapView.data("initial-zoom", customZoom);
    $mapView.data("initial-position", location);
    $mapView.data("map-index", mapIndex);

    config.center = location;
    config.zoom = customZoom;
    map = new google.maps.Map($mapView[0], config);
   
    mapData = {
      index: mapIndex,
      map: map,
      markersInfo: markersData,
      markers: [],
      originLocation: location,
      type: "modal"
    };

    hotelMapModule.initAutocompletes($autocompleteInputs, mapData.map);
    hotelMapModule.setMapMarkers(mapData);
  }

  /*function _resetInitalMapConfig() {
    var $this = $(this);
    var mapContainer = $this.find('.m-hotel-map');
    var mapIndex = mapContainer.data("map-index");
    var map = hotelMapModule.getMap(mapIndex);
    map.setZoom(mapContainer.data("initial-zoom"));
    map.setCenter(mapContainer.data("initial-position"));
  }*/

  // PUBLIC API
  return {
    init: init
  };
})();

/*$(function() {
  if($(".modal-hotel-map").length) {
    hotelMapModalModule.init();
  }
});*/


var hotelMapModule = (function(mHotelMapInline, mHotelMapModal) {
  var hotelMapInlineView = $('.m-hotel-map.inline-map .hotel-map'); //contenedor del mapa
  var hotelMapModalView = $('.m-hotel-map.modal-map .hotel-map'); //contenedor del mapa

  var hotelMaps = [];
  var geocoder;

  

  function init() {
    _loadGoogleMap();
  }

  function getDefaultConfig() {
    /*const mapConfig = {
      center: {lat: 40.3233764, lng: -3.845045},
      mapTypeId:google.maps.MapTypeId.ROADMAP,
      mapTypeControl:true,
      navigationControl: true,
      panControl: true,
      zoomControl: true,
      scaleControl: true,
      streetViewControl: false,
      zoom: 13,
      minZoom: 5,
      maxZoom: 20,
      scrollwheel: false,
      draggable: true,
      gestureHandling: 'cooperative'
    };*/
    const mapConfig = {
      center: {lat: 40.3233764, lng: -3.845045},
      mapTypeId:google.maps.MapTypeId.ROADMAP,
      minZoom: 1,
      maxZoom: 20,
      streetViewControl: false,
      zoom: 13
    };
    return mapConfig;
  }

  function _loadGoogleMap() {
    utils.loadGoogleMapScript().done(_onLoadGooglepMap);
  }

  function _onLoadGooglepMap(script, textStatus) {
    var map;
    var defaultConfig = getDefaultConfig();
    var markersData;

    if(hotelMapInlineView.length) {
      mHotelMapInline.init(hotelMapInlineView);
    }

    if(hotelMapModalView.length) {
      mHotelMapModal.init(hotelMapModalView);
    }



    /*hotelMapInlineView.each((index, mapContainer) => {
      var $this = $(mapContainer);
      var customZoom = $this.data("zoom") ? $this.data("zoom") : 13;
      markersData = MapsModalData.data[index];

      $this.data("initial-zoom", customZoom);
      $this.data("initial-position", {lat: markersData[0].location[0], lng: markersData[0].location[1]});
      $this.data("map-index", index);
      defaultConfig.center = {lat: markersData[0].location[0], lng: markersData[0].location[1]};
      defaultConfig.zoom = customZoom;
      map = new google.maps.Map(mapContainer, defaultConfig);
      hotelMaps.push(map);

     _setMapMarkers(map, index);
    });*/
  }

  function setMapMarkers(mapInfo) {
    var infowindow;
    var markers = mapInfo.markersInfo;
    var regex = /{{([distance}]+)\}}/;
    var marker;
    var markerContent;
    
    geocoder = new google.maps.Geocoder();

    infowindow = new google.maps.InfoWindow();

    $.each(markers, (index, data) => {
      if(data) {
      marker = null;
      markerContent = $(data.info);
      if(regex.test(data.info)) {
        data.distance = utils.getDistanceBetweenCoords(mapInfo.originLocation, {"lat": data.location[0], "lng": data.location[1]}) + " km";
        data.info = data.info.replace(regex, data.distance);
      }
      if(data.location) {
        marker = new google.maps.Marker({
          position: {lat: data.location[0], lng: data.location[1]},
          map: mapInfo.map,
          icon: data.icon
        });

          marker.addListener('click', function(e) {
          var content = data.info.replace(/data-src/g, "src");
          //infowindow.setContent(data.info);
          infowindow.setContent(content);
          //infowindow.open(mapInfo.map, marker);
          infowindow.open(mapInfo.map, this);
        });

        mapInfo.markers.push(marker);
      } else {
        codeAddress(mapInfo, index);
      }
      }
    });
  }

  function codeAddress(mapInfo, markerInfoIndex) {
    var address = `${mapInfo.markersInfo[markerInfoIndex].address}, ${mapInfo.markersInfo[markerInfoIndex].city}${mapInfo.markersInfo[markerInfoIndex].country ? ", " + mapInfo.markersInfo[markerInfoIndex].country: ""}`;
    geocoder.geocode({ 'address': address }, function (results, status) {
        console.log(results);
        var latLng = {lat: results[0].geometry.location.lat(), lng: results[0].geometry.location.lng()};
        console.log (latLng);
        if (status ==='OK') {
            var marker = new google.maps.Marker({
                position: latLng,
                map: mapInfo.map,
                icon: mapInfo.markersInfo[markerInfoIndex].icon,
                info: mapInfo.markersInfo[markerInfoIndex].info
            });
            if(markerInfoIndex === 0) {
              mapInfo.map.setCenter(latLng);
            }
            console.log(mapInfo.map);
        } else {
            alert('Geocode was not successful for the following reason: ' + status);
        }
    });
  }

  function setMapMarkers2(mapInfo) {
    var infowindow;
    var mapsType = (mapInfo.type === "inline") ? MapsData : MapsModalData;
    var mapData = mapsType.data[mapInfo.index];

    infowindow = new google.maps.InfoWindow();

    $.each(mapData, (index, data) => {
      var marker = new google.maps.Marker({
        position: {lat: data.location[0], lng: data.location[1]},
        map: mapInfo.map,
        icon: data.icon
      });

      marker.addListener('click', function() {
        var content = data.info.replace(/data-src/g, "src");
        infowindow.setContent(content);
        //infowindow.setContent(data.info);
        infowindow.open(mapInfo.map, marker);
      });

      mapInfo.markers.push(marker);
    });
  }

  function _setMapMarkers(map, index) {
    var infowindow;
    var mapData = MapsModalData.data[index];

    infowindow = new google.maps.InfoWindow();

    $.each(mapData, (index, data) => {
      var marker = new google.maps.Marker({
        position: {lat: data.location[0], lng: data.location[1]},
        map: map,
        icon: data.icon
      });

      marker.addListener('click', function() {
        var content = data.info.replace(/data-src/g, "src");
        //infowindow.setContent(data.info);
        infowindow.setContent(content);
        infowindow.open(map, marker);
      });
    });
  }

  function getMap(index) {
    return hotelMaps[index];
  }

  function initializeMap(map, data) {
    map.setZoom(data.zoom);
    map.setCenter(data.position);
  }

  function initAutocompletes($autocompleteInputs, currentMap) {
    if($autocompleteInputs.length) {
      $.each($autocompleteInputs, (index, input) => {
        var autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo('bounds', currentMap);
      });
    }
  }

  // PUBLIC API
  return {
    init: init,
    getMap: getMap,
    getDefaultConfig: getDefaultConfig,
    setMapMarkers: setMapMarkers,
    initAutocompletes: initAutocompletes
  };
})(mHotelMapInline, mHotelMapModal);

$(function() {
  if($('.m-hotel-map').length ) hotelMapModule.init();
});


var yourRoomChoose = (() => {
    var yourRoomChooseView = $('.m-room-card-choose');
    var yourRoomImage = yourRoomChooseView.find('.js-room-card-image');

    function init() {
        yourRoomImage.on('click', _onRoomImageClick);
        $("button:submit").on('click', function(){
            var btn=$(this);
            btn.prop("disabled", true);
            btn.closest("form").submit();
        });
    }

    function _onRoomImageClick(e) {
        var form = $(this).siblings('form');
        form.find("button:submit").prop("disabled", true);
        form.submit();
    }
    // PUBLIC API
    return {
        init: init
    };
})();
$(() => {
    if($('.m-room-card-choose').length){
        yourRoomChoose.init();
    }
});

// EY, FICHERO MODIFICADO POR CONTROLA LOS TIEMPOS DE CARGA
var mGridLandings = (function () {
  var gridView = $(".m-grid")
  var gridLanding = gridView.find('.grid');

  gridLanding.on('layoutComplete',
    function (event, laidOutItems) {
      console.log('Masonry layout completed on ' +
        laidOutItems.length + ' items');
    }
  );

  function _initGridLandings() {
    gridLanding.masonry({
      itemSelector: '.grid-item',
      columnWidth: '.grid-sizer',
      percentPosition: true,
      // horizontalOrder: true
    });

  }
  function _reloadGrid() {
    console.log("grid reload");
    gridLanding.masonry('reloadItems')
  }

  function init() {
    setTimeout(function () {
      _initGridLandings();
    }, 300);
  }

  // Public API
  return {
    init: init,
    reloadGrid: _reloadGrid
  };
})();

$(() => {
  if ($(".m-grid").length) {
    var countML = 0;
    $.doTimeout('cargaGrid', 100, function () {
      var elem = countML++; // cotrolamos que lo lanze por si acaso
      if ($("body > main").css('opacity') == 1 || elem == 90) {
        mGridLandings.init();
        console.log("lanza el grid")
        return false;
      }
      console.log("espera grid")
      return true;
    });
  }
});
// EY, FICHERO MODIFICADO POR CONTROLA LOS TIEMPOS DE CARGA
var mGridGroupBlock = (function () {
  var gridView = $(".m-group-block");
  var gridGroupBlock = gridView.find('.group-block');

  //pasar a fichero exclusivo de tabs
  /*var tabs = $(".submenu-item");

  tabs.on("show.bs.tab", function() {
    
  });

  tabs.on("shown.bs.tab", function() {
    var $this = $(this);
    var $tab = $($this.attr("href"));
    var grid = $tab.find('.group-block');
    grid.masonry();
  });*/

  function _initGridLandings() {
    $.each(gridGroupBlock, function () {
      var $this = $(this);
      $this.masonry({
        itemSelector: '.grid-item',
        columnWidth: '.grid-sizer',
        gutter: '.gutter-sizer',
        percentPosition: true,
        // horizontalOrder: true
      });
    });
  }

  function init() {
    setTimeout(function () {
      _initGridLandings();
    }, 300);
  }

  // Public API
  return {
    init: init
  };
})();

$(() => {
  if ($(".m-group-block").length) {
    var countMG = 0;
    $.doTimeout('MG', 100, function () {
      var elem = countMG++; // cotrolamos que lo lanze por si acaso
      if ($("body > main").css('opacity') == 1 || elem == 90) {
        mGridGroupBlock.init();
        return false;
      }
      return true;
    });
  }
});


var mGroupQuotes = (function () {
  var gridView = $(".m-group-quotes");
  var $linkSeeMore = gridView.find('.link-primary');
  function init() {
    _initTipAdvisorWidgets();
    $linkSeeMore.on("click", _toggleQuoteReview);
    $('[data-url-tripadvisor]').click(function () {
      var urlTripadvisor = $(this).attr('data-url-tripadvisor');
      $('.js-tripavisor-modal').find('iframe').attr('src', urlTripadvisor);
    });
  }
  /**
   * @description get the tripadvisor data of a hotel given by its tripadvisor id
   * @param {string} tripId  - id hotel tripadvisor id
   * @param {object} $widget - jquery object of tripadvisor widget container
   */
  function _getTripAdvisordData(tripId, $widget) {
    // EY: Verificar -> Añadir comentarios
    let addComments = "",
      $contentquotes = gridView.find(".group-quotes"),
      parsed = null;
    if (typeof $contentquotes.data('comments') !== 'undefined') {
      parsed = parseInt($contentquotes.data('comments'), 10);
      addComments = (isNaN(parsed)) ? "" : `/${parsed}/3/true`;
    }
    // call api
    var promise = $.ajax({
      url: `https://www.nh-hotels.com/rest/trip/tripadvisorhotelrate/${tripId}${addComments}`,
      dataType: "json",
      cache: true,
      async: true
    });
    return promise.then(function (response) {
      if (response && response !== "null") {
        if (typeof globalHttpProtocol !== "undefined") {
          response.ratingImageLink = response.ratingImageLink.replace("location.protocol", globalHttpProtocol);
        }
        // EY: si hay comentarios
        if (addComments != "") _createReviews($contentquotes, parsed, response);
        $widget.find(".rating").html(`<img src="${response.ratingImageLink}" alt="${response.rate}">`);
        $widget.find(".comments span").text(response.numComents);
        $widget.parents(".hotel-card").attr("data-hotel-tripadvisor", Math.floor(response.rate));
        $widget.show();
        return response;
      } else {
        return Promise.reject(parsed, response);
      }
    }, function (error) {
      return $.when("error").then(function () {
        return {
          rate: null
        };
      });
    });
  }
  // EY: Crear comentarios 
  /**
   * @description Create commnents inline
   */
  function _createReviews(container, comments, dataReviews) {
    if (dataReviews.reviews.length) {
      // TEMPLATE DE REVIWES
      var template = [
        '<article class="m-quote">',
        '<h4>{{title}}</h4>',
        '<div class="stars">{{stairs}}</span>',
        '</div>',
        '<div class="review multiline-ellipsis">',
        '  <p>{{text}}</p>',
        '</div>',
        '<a class="link-primary is_collapsed" data-closed-header-text="{{llbShoinfo}}" data-open-header-text="{{lblHidehinfo}}">{{llbShoinfo}}</a>',
        '<div class="author">',
        '  <p class="not-highlighted">{{name}}. <span>{{location}}</span></p>',
        '  <p class="not-highlighted">{{date}}</p>',
        '</div>',
        '</article>'
      ].join("\n");
      // recorremos las review y parseo con template los valores
      $.each(dataReviews.reviews, function (index, review) {
        let data = {
          title: review.title,
          text: review.text,
          name: review.user,
          llbShoinfo: (typeof container.data("showInfo") !== 'undefined') ? container.data("showInfo") : 'Show info' ,
          lblHidehinfo: (typeof container.data("hideInfo") !== 'undefined') ? container.data("hideInfo") : 'Hide info' ,
          location: (review.location != null) ? review.location : "",
          date: review.date,
          stairs: '<span class="nh-ic-star"></span>'.repeat(Math.floor(review.userRate))
        };
        // parseo la plantilla y la inserto 
        var output = templatesRoom.getTemplate(template, data);
        $(output).insertBefore(container.find(".wrapper-rates"));
      });
      // Activo los link
      (container.find('.link-primary')).on("click", _toggleQuoteReview);
    }
  }
  /**
   * @description Initialize the trip advisor widget of each hotel card
   */
  function _initTipAdvisorWidgets() {
    var $widgets = $(".js-widget-trip");
    $widgets.hide();
    var promises = [];
    $.each($widgets, function (i, widget) {
      var $widget = $(widget);
      var idtrip = $widget.data("idtrip");
      if (typeof idtrip != "undefined" && idtrip) {
        promises.push(_getTripAdvisordData(idtrip, $widget));
      }
    });
    return Promise.all(promises).then(response => {
      return response;
    }, error => {
      return error;
    });
  }
  /**
   * @description Toggle the hotel card more info data and change the text of the link that toggle de info
   * @param {object} ev - object with the evenet data
   */
  function _toggleQuoteReview(ev) {
    var $this = $(this);
    var isCollapsed = $this.hasClass("is_collapsed");
    var $review = $this.siblings('.review ');
    var text = (isCollapsed) ? $this.data("open-header-text") : $this.data("closed-header-text");
    ev.preventDefault();
    $this.toggleClass('is_collapsed');
    $review.toggleClass("multiline-ellipsis");
    $this.text(text);
  }
  // Public API
  return {
    init: init
  };
})();
$(() => {
  if ($(".m-group-quotes").length) {
    mGroupQuotes.init();
  }
});
var mGuesData = (() => {
  var $mGuesDataView = $('.m-guest-data');
  var $frequentUser =  $mGuesDataView.find('#frequent-user');
  var initialGuest = {};
  var $userFields = $mGuesDataView.find("input:not([type='checkbox']), select:not([id='frequent-user'])");
  var frequentUserCheckbox = {
    "addFrequentUser":  $mGuesDataView.find("#frequent-user-checkbox"),
    "removeFrequentUser":  $mGuesDataView.find("#remove-frequent-user-checkbox")
  };

  var $nationality = $("#nationality-checkout");

  function init() {
    _setInitialGuest(); //guardo los datos del usuario que estan ya rellenos
    $frequentUser.on('change', _onFrequentUserChange);
    $userFields.on('change', _onGuestDataChange);
  }

  /**
   * @description fill the fields with the user/guest data.
   * @param {object} data - object with the user/guest data
   */
  function _fillUserData(data) {
    var isFrequentUser = ($frequentUser.val() && $frequentUser.val() !== "");

    $userFields.each(function() {
      var $this = $(this);
      var fieldId = $this.attr("id");
      var altId = (fieldId.indexOf('-checkout')) ? fieldId.substring(0, fieldId.indexOf('-checkout')) : fieldId;
      var value = data[fieldId] || data[altId];
      var selectedOption = null;
      var fakeSelect = null;

      if(fieldId === "nationality-checkout") {
        selectedOption = $this.find("option[value=" + value + "]");
        $this.val(value).change();
        fakeSelect = $("#" + fieldId + "-clone");
        fakeSelect.val(selectedOption.text()).prop("disabled", (isFrequentUser && value));
      }

      $this.val(value).prop("disabled", (isFrequentUser && value));
    });
  }

  /**
   * @description - get the frequent user data
   * @returns {object} - return a promise object
   */
  function _getFrequentUser() {
    var promise = $.ajax({
      dataType: "json",
      url: urlGlobalConfig.domain + "mocks/frequent-user.json",
      cache: false
    });

    return promise.then(function(response) {
      if(response.email) {
        response["confirm-email"] = response.email;
      }
      return response;
    }, function(error) {
      return error;
    });
  }

  /**
   * @description - get the intial guest data
   * @returns {object} - return a promise object
   */
  function _getInitialGuest() {
    var deferred = $.Deferred();
    return deferred.resolve(initialGuest);
  }


  /**
   * @description handle the behaviout when the frequent user select changes
   */
  function _onFrequentUserChange() {
    var $this = $(this);
    var isFrequentUser = $this.val() && $this.val() !== "";
    if(!isFrequentUser) {
      //mostramos los datos de usuario previos
      //mostramos checkbox de añadir a usuarios frecuentes
      //ocultamos checkbos de eleiminar de usuarios frecuentes
      _getInitialGuest().then(function(response) {
        console.log("usuario anterior", response);
        _fillUserData(response);
        _toggleFrequentUserCheckbox(isFrequentUser);
      });
    } else {
      //pedimos los datos de usuario frequente
        //datos correctos
          //rellenamos los datos
          //ocultamos checkbox de añadir a usuarios frecuentes
          //mostramos checkbos de eleiminar de usuarios frecuentes

        //datos incorrectos
          //que hacemos si son incorrectos?
      _getFrequentUser().then(function(response) {
        console.log("usuario frecuente", response);
        _fillUserData(response);
        _toggleFrequentUserCheckbox(isFrequentUser);
      }, function(){
      });
    }
  }

  /**
   * @description handle the behaviout when the user fields change
   */
  function _onGuestDataChange() {
    var $this = $(this);
    var fieldId = $this.attr("id");
    if(!$frequentUser.val() || $frequentUser.val() === "") {
      initialGuest[fieldId] = $this.val();
    }
  }

  /**
   * @description - hide/show the checkbox to add a new frequent user and the checkbox to remove a frequent user
   * @param {boolean} isFrequentUser - if the user selectec is frequent user or not
   */
  function _toggleFrequentUserCheckbox(isFrequentUser) {
    frequentUserCheckbox.addFrequentUser.parent('.checkbox').toggleClass('hide', isFrequentUser);
    frequentUserCheckbox.removeFrequentUser.parent('.checkbox').toggleClass('hide', !isFrequentUser);
    frequentUserCheckbox.addFrequentUser[0].checked = false;
    frequentUserCheckbox.removeFrequentUser[0].checked = false;
  }

  /**
   * @description - save the data of the initial guest/user
   */
  function _setInitialGuest() {
    $userFields.each(function() {
      var $this = $(this);
      var fieldId = $this.attr("id");
      initialGuest[fieldId] = $this.val();
    });
  }

  // Public Api
  return {
    init: init
  };
})();

$(() => {
  if($(".m-guest-data").length) {
    mGuesData.init();
  }
});

var mGridResultHotels=(function() {
  var mHotelSearch = $(".m-hotel-search");
  var gridView = $(".result-hotels");
  var gridLanding = gridView.find('.grid');
  var $panel = gridView.find('.hotel-card-footer a');
  var $showMoreResultsBtn = $("#see-more-results");
  var hotelCards = {
    cards: gridLanding.find(".grid-item"),
    visible: null,
    visibleNumber: 4,
    get leyend() {
      return mHotelSearch.find(".results-leyend");
    }
  };


  function init() {
    hotelCards.visibleNumber = gridView.data("cards-show");
    _initHotelResults();
    //_initGridHotelsCards();
    $panel.on("click", _toggleHotelInfo);
    $showMoreResultsBtn.on("click", _showMoreResults);

    $('[data-url-tripadvisor]').click(function () {
      var urlTripadvisor = $(this).attr('data-url-tripadvisor');
      $('.js-tripavisor-modal').find('iframe').attr('src', urlTripadvisor);
    });

  }

  function _initHotelResults() {
    hotelCards.cards.hide();
    hotelCards.visible = hotelCards.cards.slice(0, hotelCards.visibleNumber);
    hotelCards.visible.show();
    hotelCards.leyend.find(".visible-results").html(hotelCards.visible.length);
    hotelCards.leyend.find(".total-results").html(hotelCards.cards.length);
    
    // EY, FICHERO MODIFICADO POR CONTROLA LOS TIEMPOS DE CARGA
    var countIH = 0;
    $.doTimeout('IH', 100, function () {
      var elem = countIH++; // cotrolamos que lo lanze por si acaso
      if ($("body > main").css('opacity') == 1 || elem == 90) {
        _initGridHotelsCards();
        return false;
      }
      return true;
    });
    
   
  }

  function _showMoreResults() {
    hotelCards.visible = hotelCards.cards.slice(0, (hotelCards.visibleNumber + hotelCards.visible.length));
    hotelCards.visible.show();
    hotelCards.leyend.find(".visible-results").html(hotelCards.visible.length);
    if(hotelCards.visible.length === hotelCards.cards.length) {
      $(this).hide();
    }
    gridLanding.masonry();




    /*var visibleResults = $(".js-hotels-results .js-card:visible").length + x;
      x = x + x <= howManyResults ? x + x : howManyResults;
      $(".js-hotels-results .js-card:lt(" + x + ")").show();
      $(".js-visible-results").html(visibleResults);
      if ($(".js-hotels-results .js-card").length == x) {
          $(".js-load-more-results").hide();
          $(".js-visible-results").html(howManyResults);
      }
      $(".card-columns").masonry();
      sameHeight();*/
    //});
  }

  /**
   * @description initialize the hotel cards data and behaviour
   */
  function _initGridHotelsCards() {
    // console.log('Inicializamos Grid result hotels');
    //inicializamos los widgets de tripAdvisor para cada hotel
    _initTipAdvisorWidgets().then(function() {
      setTimeout(function() {
        gridLanding.masonry({
          itemSelector: '.grid-item',
          columnWidth: '.grid-sizer',
          gutter: '.gutter-sizer',
          percentPosition: true,
        });
      }, 200);
    });
  }



  /**
   * @description get the tripadvisor data of a hotel given by its tripadvisor id
   * @param {string} tripId  - id hotel tripadvisor id
   * @param {object} $widget - jquery object of tripadvisor widget container
   */
  function _getTripAdvisordData(tripId, $widget) {
    var promise = $.ajax({
      url: `https://www.nh-hotels.com/rest/trip/tripadvisorhotelrate/${tripId}`,
      dataType: "json",
      cache: true,
      async: true
    });

    return promise.then(function(response) {
      if (response && response !== "null") {
        if (typeof globalHttpProtocol !== "undefined") {
          response.ratingImageLink = response.ratingImageLink.replace("location.protocol", globalHttpProtocol);
        }

        $widget.find(".rating").html(`<img src="${response.ratingImageLink}" alt="${response.rate}">`);
        $widget.find(".comments span").text(response.numComents);
        $widget.parents(".hotel-card").attr("data-hotel-tripadvisor", Math.floor(response.rate));
        $widget.show();
        return response;
      } else {
          return Promise.reject(response);
      }

    }, function(error) {
      return $.when("error").then(function() {
        return {rate: null};
      });
    });
  }

  /**
   * @description Initialize the trip advisor widget of each hotel card
   */
  function _initTipAdvisorWidgets() {
    var $widgets = $(".js-widget-trip");
    var promises = [];

    $.each($widgets, function(i, widget) {
      var $widget = $(widget);
      var idtrip = $widget.data("idtrip");
      if (typeof idtrip != "undefined" && idtrip) {
          promises.push(_getTripAdvisordData(idtrip, $widget));
      }
    });

    return Promise.all(promises).then(response => {
      return response;
    }, error => {
      return error;
    });
  }

  /**
   * @description Toggle the hotel card more info data and change the text of the link that toggle de info
   * @param {object} ev - object with the evenet data
   */
  function _toggleHotelInfo(ev) {
    var $this = $(this);
    var panel = $($this.attr("href"));
    var isClosed = panel.hasClass("is_closed");
    var $ellipsis = panel.parent().find('.hotel-info');

    var text = (isClosed) ? $this.data("open-header-text") : $this.data("closed-header-text");

    ev.preventDefault();
    $this.toggleClass('is_collapsed');
    panel.toggleClass("is_closed");
    $ellipsis.toggleClass("multiline-ellipsis");
    $this.text(text);
    gridLanding.masonry();
  }

  // Public API
  return {
    init: init
  };

})();

$(() => {
  if($(".result-hotels").length) {
    mGridResultHotels.init();
  }
});


// SHOW / HIDE hotel info

$('a[data-show]').click(function() {

  $(this).toggleClass('is_collapsed');

  $($(this).attr('data-show')).slideToggle('fast');

  if($(this).hasClass('is_collapsed')) {
    $(this).html($(this).attr('data-closed-header-text'));
  } else {
    $(this).html($(this).attr('data-open-header-text'));
  }

});

/**
 * Arrival Module
 * @return {[type]} [description]
 */
var mHorizontalMenu = (function () {
  var SETTINGS = {
    navBarTravelling: false,
    navBarTravelDirection: "",
    navBarTravelDistance: 150
  };

  var $menu = $(".m-submenu-h");
  var $menuContainer = $menu.find(".submenu-container");
  var $menuContent = $menuContainer.find(".submenu-content");
  var $menuItems = $menuContent.find(".submenu-item");
  var $menuContetWithGrid = [];

  var navButtons = {
    left: $menu.find(".btn-left"),
    right: $menu.find(".btn-right"),
    both: $menu.find(".btn-move")
  };

   // Handle the scroll of the horizontal container
   var last_known_scroll_position = 0;
   var ticking = false;

  /**
   * Init Fn
   * @return {[type]} [description]
   */
  function init() {
    _setOverflowData();
    /*$($menuItems).filter(function() {
      var $this = $(this);
      var $tabContent;
      if($this.is("[role='tab']")) {
        $tabContent = $($this.attr("href"));
        return $tabContent.find(".grid-item").length > 0 ;
      }
    }).data("grid-content", true).on("shown.bs.tab", function() {
      var $this = $(this);
      var $tabContent = $($this.attr("href"));
      var $gridElements = null;
      if(!$tabContent.data("loaded")) {
        $gridElements = $tabContent.find('.group-block');
        $gridElements.masonry();
      }
    });*/

    $menuItems.each((index, item) => {
      var $this = $(item);
      var $tabContent = null;
      var hasGridElements = false;
      if($this.is("[role='tab']")) {
        $tabContent = $($this.attr("href"));
        hasGridElements = $tabContent.find(".grid-item").length > 0;
        if(hasGridElements) {
          $tabContent.data("loaded", false);
          $menuContetWithGrid.push($tabContent);
        }
        $this.on("shown.bs.tab", {$tabContent: $tabContent}, _onShowMenuTabContent);
      }
    });



    //bind events
    $menuItems.on("click", _onClickInMenuItem);
    $menuContainer.on("scroll", _onScrollMenuContainer);
    navButtons.both.on("click", _onClickInNavButtons);
    $menuContent.on("transitionend", _onTransitionEnd);
    $(window).on('resize', _onWindowResize);
  }

  /***********************/
  /*** PRIVATE METHODS ***/
  /***********************/

  /**
   * @description set the type of overflow of the menu
   * @param {object} content - jquery object with the content element of menu
   * @param {objecdt} container - jquery object with the container element of menu
   * @returns the overflow type left, right, both sides or without overflow
   */
  function _determineOverflow(content, container) {
    var contentMetrics = _getElementMetrics(content);
    var containerMetrics = _getElementMetrics(container);
    if (containerMetrics.left > contentMetrics.left && Math.floor(containerMetrics.right) < Math.floor(contentMetrics.right)) {
      return "both";
    } else if (contentMetrics.left < containerMetrics.left) {
        return "left";
    } else if (contentMetrics.right > containerMetrics.right) {
        return "right";
    } else {
        return "none";
    }
  }

  /**
   * @description get the metrics of the specific element
   * @param {object} element - jquery object with the element to get its metrics
   * @returns the elment metrics
   */
  function _getElementMetrics(element) {
    var metrics = {
      global: element[0].getBoundingClientRect(),
      get right() {
        return this.global.right;
      },
      get left() {
        return this.global.left;
      }
    };

    return metrics;
  }

  /**
   * @description handle the movement of the meno to left
   */
  function _moveToLeft() {
    // Find how far this panel has been scrolled
    var availableScrollLeft = $menuContainer.scrollLeft;
    // If the space available is less than two lots of our desired distance, just move the whole amount
    // otherwise, move by the amount in the settings
    if (availableScrollLeft < SETTINGS.navBarTravelDistance * 2) {
        $menuContent.css("transform", "translateX(" + availableScrollLeft + "px)");
    } else {
        $menuContent.css("transform", "translateX(" + SETTINGS.navBarTravelDistance + "px)");
    }
  }

  /**
   * @description handle the movement of the meno to right
   */
  function _moveToRight() {
    // Get the right edge of the container and content
    var navBarRightEdge = $menuContent[0].getBoundingClientRect().right;
    var navBarScrollerRightEdge = $menuContainer[0].getBoundingClientRect().right;
    // Now we know how much space we have available to scroll
    var availableScrollRight = Math.floor(navBarRightEdge - navBarScrollerRightEdge);
    // If the space available is less than two lots of our desired distance, just move the whole amount
    // otherwise, move by the amount in the settings
    if (availableScrollRight < SETTINGS.navBarTravelDistance * 2) {
      $menuContent.css("transform", "translateX(-" + availableScrollRight + "px)");
    } else {
      $menuContent.css("transform", "translateX(-" + SETTINGS.navBarTravelDistance + "px)");
    }
  }

  /**
   * @description - handle the click over the navs buttons
   * @returns - false if the transition o movement of the menu is working
   */
  function _onClickInNavButtons() {
    var overflowType = null;
    var direction = $(this).hasClass("btn-left") ? "left" : "right";
    var callback = (direction === "left") ? _moveToLeft : _moveToRight;
    var availableDirections = ["right", "left", "both"];
    // If in the middle of a move return
    if (SETTINGS.navBarTravelling === true) {
      return;
    }
    
    overflowType = _determineOverflow($menuContent, $menuContainer);

    if (availableDirections.indexOf(overflowType) >=0) {
      callback();
      // We do want a transition (this is set in CSS) when moving so remove the class that would prevent that
      $menuContent.removeClass("pn-ProductNav_Contents-no-transition");
      // Update our settings
      SETTINGS.navBarTravelDirection = direction;
      SETTINGS.navBarTravelling = true;
    } 
    _setOverflowData();
  }

  /**
   * @description - handle the click over the menu item
   * @param {object} ev - object with the event object
   */
  function _onClickInMenuItem(ev) {
    var $this = $(this);

    if($menuContainer.attr("data-scrolling") === "true") {
      ev.preventDefault();
      $menuContainer.attr("data-scrolling", "false");
    } else {
      if($this.attr("role") === "tab") {
        ev.preventDefault();
        _triggerClickInMenuTabItem($this);
      }
    }
  }

  /**
   * @description - handle the scroll event of the menu container
   */
  function _onScrollMenuContainer() {
    last_known_scroll_position = window.scrollY;
    if (!ticking) {
        window.requestAnimationFrame(function() {
          _setOverflowData(last_known_scroll_position);
          ticking = false;
        });
    }
    ticking = true;
  }

  /**
   * @description - reload de grid content of the menu tab if is necesary
   * @param {object} ev - object with the event data
   */
  function _onShowMenuTabContent(ev) {
    var $gridElements;
    if(!ev.data.$tabContent.data("loaded")) {
      $gridElements = ev.data.$tabContent.find('.group-block');
      $gridElements.masonry();
      ev.data.$tabContent.data("loaded", true);
    }
  }

  /**
   * @description - handle the browser event when a transition is ended.
   */
  function _onTransitionEnd() {
    // get the value of the transform, apply that to the current scroll position (so get the scroll pos first) and then remove the transform
    var styleOfTransform = window.getComputedStyle($menuContent[0], null);
    var tr = styleOfTransform.getPropertyValue("-webkit-transform") || styleOfTransform.getPropertyValue("transform");
    // If there is no transition we want to default to 0 and not null
    var amount = Math.abs(parseInt(tr.split(",")[4]) || 0);
    $menuContent[0].style.transform = "none";
    $menuContent[0].classList.add("pn-ProductNav_Contents-no-transition");
    // Now lets set the scroll position
    if (SETTINGS.navBarTravelDirection === "left") {
      $menuContainer[0].scrollLeft = $menuContainer[0].scrollLeft - amount;
    } else {
      $menuContainer[0].scrollLeft = $menuContainer[0].scrollLeft + amount;
    }
    SETTINGS.navBarTravelling = false;
  }

  /**
   * @description - handle the window resize event. Control the oveflow of the menu and control if the grid contens of the menu tabs have to be loaded again
   */
  function _onWindowResize() {
    _setOverflowData();
    $.each($menuContetWithGrid, (index, item) => {
      var $this = $(item);
      $this.data("loaded", false);
    });
  }

  /**
   * @description - trigger the event click over a menu item
   * @param {object} $element jquery object with the element clicked
   * @returns stop the click if the item is active
   */
  function _triggerClickInMenuTabItem($element) {
    
    
    
    var $previous = $menuContent.find('> .is_active');
    if($element.hasClass("is_active")) {
      return;
    }
    $previous.removeClass("is_active");
    $element.addClass("is_active");
  }

  /**
   * @description - set the menu overflow type
   */
  function _setOverflowData() {
    $menuContainer.attr("data-overflowing", _determineOverflow($menuContent, $menuContainer));
  }

  // Public API
  return {
    init: init
  };  

})();

$(function() {
  if($(".m-submenu-h").length) {
    mHorizontalMenu.init();
  }
});
var mFaq = (function () {

  /**
   *  la clase que tiene el nombre de los filtros ha de ser .m-faqs y la clase que contiene los acordeones .faq-accordion
   */

  /*filtros aplicables*/
  var $listFilters = $(".m-faqs").find("[data-type]");
  var $faqSections = $(".faq-accordion");

  function init() {
    //attach click behavior hover the filters links
    $listFilters.on("click",_filterBy);
  }

  /*******************/
  /* PRIVATE METHODS */
  /*******************/
  
  /**
   * @description - show and hide the correct elements due the filter type selected
   */
  function _filterBy() {
    var filterSelected = $(this).data("type");
    $faqSections.filter(function() {
      var $faqSection = $(this);
      var isVisible = ($faqSection.attr("data-type") === filterSelected) || (filterSelected === "all");
      $faqSection.toggle(isVisible);
    });
  }

  // Public API
  return {
    init: init,
  };
})();

$(function () {
  if($(".m-faqs").length && $(".faq-accordion").length) {
    mFaq.init();
  }
});

/*
  1. Constructor -> Constructor del filtro inicial

  2. Funciones de inicialización del filtro
    2.A init -> Inicializar el filtro (selectores, contador de hoteles, escuchadores de eventos)
    2.B maxRange -> Inicializar dinámicamente los range (precio y distancia)
    2.C initSelectPois -> Inicializar dinámicamente los selectores de localización
    2.D initCurrencyMobile -> Inicializar currency de header de EY (mobile & tablet)
    2.E showRating -> Muestra los rating disponibles pasados en un array
    2.F getCurrencyData -> Almacenar el array de conversiones de divisas
    2.G initRange -> Inicialización de los range (librería noUiSlider)

  3. Funciones escuchadoras para recoger valores de filtros (mobile & desktop)
    3.A. listenerDesktop -> Listener filtro desktop (activar filtro uno a uno)
    3.B listenerMobile -> Listener filtro mobile (activar todos los filtros al pulsar botón modal)

  4. Setters -> Cambiar atributos del filtro global y sincronizar valor con filtro oculto
    4.A setRange -> Cambia el atributo de elementos de rango (precio y distancia)
    4.B setServiceMobile -> Cambia el atributo de services (desde mobile)
    4.C setServiceDesktop -> Cambia el atributo de services (desde desktop)
    4.D setRatingMobile -> Cambia el atributo de rating (desde mobile)
    4.E setRatingDesktop -> Cambia el atributo de rating (desde desktop)
    4.F setSorted -> Cambia el atributo de ordenar
    4.G setCurrency -> Cambia el atributo de selected de currency
    4.H setLocation -> Cambiar atributo localizacion (caso especial demasiado específico)

  5. Funcionalidad de filtrar hoteles tras conseguir valores de filtrado
    5.A filterHotels -> Recoger todos los datos relacionados con los hoteles
    5.B canShowHotel -> Comparar datos de hotel y filtro para saber si mostrar u ocultar
    5.C canShowHotelsGroup -> Contar hoteles visibles para saber si mostrar/ocultar grupo
    5.D getShowPois -> Devuelve el backcode de los hoteles que se mostrarán en el mapa al filtrar

  6. Funcionalidad de ordenar hoteles
    6.A sortedGroups -> Según el valor del select se tienen que ordenar en unos grupos u otros
    6.B sortedHotels -> Pasamos el grupo para que ordene según el valor seleccionado

  7. Funcionalidad de cambio de moneda
    7.A currencyModal -> Controlar cambio de moneda (modal currency)
    7.B changeHotelsCurrency -> Cambiar la moneda en todos los hotel cards

  8. Funcionalidad tags de filtros (mobile & desktop)
    8.A CreateTag -> Genera un tag de un elemento (precio) o grupos de elementos (servicios) filtrados
    8.B updateTag -> Modificar tags existentes cuando cambia su valor de filtro
    8.C removeTag -> Eliminar tags existentes y volver a filtrar

  9. Funcionalidad complementaria
    9.A formatRange -> Función auxiliar que recoge el valor numérico de un string (p.e. '12 EUR')
    9.B loadingHotels -> Deshabilita los filtros desktop hasta que termine todo el filtrado de hoteles

  10. Reset -> Reiniciar el filtro (p.e. cuando se busca otra ciudad)
*/

class FilterHotels {

  // --------------------------------------------------------------------------------
  // 1. Constructor
  // --------------------------------------------------------------------------------
  constructor (page) {

    // Atributos generales de la página
    this.page = page; // clase descriptiva del main de la página
    this.containers = { mobile: null, desktop: null, result: null };
    this.cont = 0; // contador de hoteles mostrados

    // Atributos de ordenación
    this.sortedBy = null;
    this.groups = [];

    // Atributos moneda
    this.currency = { origin: 'EUR', selected: 'EUR', aux: null };
    this.currencyConversions = []; // array de conversiones con euro de origen

    // Atributos de formulario del filtro
    this.price = null;
    this.services = [];
    this.nearTo = { location: { value: null, text: null }, distance: null };
    this.locationCenter = { value: null, text: null};
    this.ratings = [];

    // Geolocalización solo para móviles
    this.geolocation = { latitude: null, longitude: null };

    // Array que almacena los backcode de los pois que tras filtrar son visibles
    this.showPois = [];
  }



  // --------------------------------------------------------------------------------
  // 2.A Init global
  // --------------------------------------------------------------------------------
  init (filterContainerMobile, filterContainerDesktop, resultContainer) {
    const filter = this;

    // -------------------------------------------
    // Inicialización de atributos del filtro

    // Almacenamos contenedores de filtros
    this.containers.mobile = filterContainerMobile;
    this.containers.desktop = filterContainerDesktop;
    this.containers.result = resultContainer;

    // Inicializar grupos
    $(this.containers.result).find('.m-hotel-list').each(function (index, list) {
      filter.groups.push($(list).data('hotels-group'));
    });

    // Inicialización contadores de hoteles mostrados (desktop y mobile)
    //const hotelCont = document.querySelectorAll('.js-filter-hotels-number');
    //this.cont = this.containers.result.querySelectorAll('.m-hotel-box').length;
    //hotelCont.forEach(hotelCont => hotelCont.textContent = this.cont);

    // Almacenar el array de conversiones de divisas
    this.getCurrencyData();


    // -------------------------------------------
    // Activar/desactivar servicios (desktop y mobile)
    const filterServices = document.querySelectorAll('[data-service]');
    filterServices.forEach(link => {
        link.addEventListener('click',() => { $(link).toggleClass('is-active'); });
    });


    // -------------------------------------------
    // Mostrar/ocultar distancia del Cerca de.. (desktop y mobile)
    const filterLocation = document.querySelectorAll('.js-filter-location');
    filterLocation.forEach(select => {
      select.addEventListener('change', e => {
        let distance = $(e.target).closest('.filter-hotels-group').find('.filter-hotels-distance')[0];
        e.target.value === 'invalid'
          ? $(distance).addClass('is-hidden')
          : $(distance).removeClass('is-hidden');
      });
    });


    // -------------------------------------------
    // Deshabilitar el option de ordenar por poi (inicialmente no tenemos valor)
    const filterSort = $('.js-filter-sort');
    $(filterSort).find("option[value^='poi-']").attr("disabled", "disabled");
    $(filterSort).selectpicker('render');


    // -------------------------------------------
    // Escuchadores cambio monedas
    let modalCurrency = $('#modal-filter-currency');

    // Captura el rechazo de cambio de moneda
    $(modalCurrency).find('.btn-ico').click(function () {
      filter.setCurrency(false);
    });
    $(modalCurrency).find('.js-filter-currency-origin').click(function () {
      filter.setCurrency(false);
    });

    // Captura el cambio de moneda
    $(modalCurrency).find('.js-filter-currency-change').click(function () {
      filter.setCurrency(true);
      filter.loadingHotels(true);
      setTimeout(() => { filter.loadingHotels(false); }, 1000);
    });



    // -------------------------------------------
    // Sólo para dispositivo móvil
    if( isMobile.any() ) {

      // Habilitar options ordenar cerca de mi...
      $(this.containers.mobile).find("option[value='close-to-me']").removeAttr('disabled');
      $(this.containers.mobile).find('.js-filter-sort.selectpicker').selectpicker('render');

      // Conseguimos y almacenamos geolocalización
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          filter.geolocation.latitude = position.coords.latitude;
          filter.geolocation.longitude = position.coords.longitude;
        });
      }
    }


    // -------------------------------------------
    // Init currency (mobile & tablet)
    this.initCurrencyMobile();

    // -------------------------------------------
    // Escuchadores según dispositivo (desktop o mobile)
    this.listenerDesktop ();
    this.listenerMobile ();
  }



  // --------------------------------------------------------------------------------
  // 2.B Inicializar dinámicamente los range (precio y distancia)
  // --------------------------------------------------------------------------------
  maxRange (type, value) {

    // Hacer visible el grupo de price y la ordenación por precio (inicialmente oculto)
    if ( type === 'price' ) {
      const mobilePrice = $(this.containers.mobile).find('.js-filter-price')[0];
      const desktopPrice = $(this.containers.desktop).find('.js-filter-price')[0];
      $(mobilePrice).closest('.filter-hotels-group').removeClass('is-hidden');
      $(desktopPrice).closest('.filter-hotels-group').removeClass('is-hidden');

      const sortMobile = $(this.containers.mobile).find('.js-filter-sort.selectpicker');
      const sortDesktop = $(this.containers.desktop).find('.js-filter-sort.selectpicker');
      $(sortMobile).find("option[value^='price-']").removeAttr('disabled');
      $(sortDesktop).find("option[value^='price-']").removeAttr('disabled');
      $(sortMobile).selectpicker('render');
      $(sortDesktop).selectpicker('render');
    }

    // Inicializar los range
    let filterSelector = null;
    if ( type === 'price' ) filterSelector = document.querySelectorAll('.js-filter-price');
    else if ( type === 'distance' ) filterSelector = document.querySelectorAll('.js-filter-distance');
    filterSelector.forEach(range => this.initRange (range, value) );
  }



  // --------------------------------------------------------------------------------
  // 2.C Inicializar dinámicamente los selectores de localización
  // --------------------------------------------------------------------------------
  initSelectLocation (arrayPois) {
    const filter = this;

    // Selector de los selects de location
    let locationMobile = $(this.containers.mobile).find('.js-filter-location.selectpicker');
    let locationDesktop = $(this.containers.desktop).find('.js-filter-location.selectpicker');
    let sortMobile = $(this.containers.mobile).find('.js-filter-sort.selectpicker');


    // Montamos el html de los select e inicializamos locationCenter (atributo)
    let htmlOptions = '<option value="invalid">Choose an option</option>';
    arrayPois.forEach(option => {

      // Iniciar atributo de filtro localización centro y pintar la opción
      if ( option.isCenter ) {
        filter.locationCenter.value = option.value;
        filter.locationCenter.text = option.text;
        htmlOptions += `<option value=${option.value} data-center>${option.text}</option>`;

      } else {
        htmlOptions += `<option value=${option.value}>${option.text}</option>`;
      }
    });


    // Agregamos html y actualizamos
    $(locationMobile).html(htmlOptions).selectpicker('refresh');
    $(locationDesktop).html(htmlOptions).selectpicker('refresh');


    // Escuchador de móvil para actualizar el sort en tiempo real (no esperar a dar el botón)
    $(locationMobile).change(function (e) {
      let value = e.target.value;
      ( value === filter.locationCenter.value || value === 'invalid' )
        ? $(sortMobile).find("option[value^='poi-']").attr("disabled", "disabled")
        : $(sortMobile).find("option[value^='poi-']").removeAttr('disabled');
      $(sortMobile).selectpicker('render');
    });
  }



  // --------------------------------------------------------------------------------
  // 2.D initCurrencyMobile -> Inicializar currency de header de EY (mobile & tablet)
  // --------------------------------------------------------------------------------
  initCurrencyMobile() {
    const filter = this;

    // Opciones de moneda
    var currencyOptions = [
      { value: 'ARS', text: 'Argentine Peso ($a)'},
      { value: 'AUD', text: 'Australian Dollar ($)'},
      { value: 'BRL', text: 'Brazilian Real (R$)'},
      { value: 'GBP', text: 'British Pound (£)'},
      { value: 'CAD', text: 'Canadian Dollar (C$)'},
      { value: 'CLP', text: 'Chilean peso'},
      { value: 'COP', text: 'Colombian Peso'},
      { value: 'DKK', text: 'Danish Krone (kr)'},
      { value: 'EUR', text: 'Euro (€)' },
      { value: 'HUF', text: 'Hungarian Forint (Ft)'},
      { value: 'INR', text: 'Indian Rupee (₹)'},
      { value: 'ILS', text: 'Israeli New Shekel (₪)'},
      { value: 'MXN', text: 'Mexican Peso ($)'},
      { value: 'NOK', text: 'Norwegian Krone (kr)'},
      { value: 'PEN', text: 'Peruvian Sol (S/)'},
      { value: 'PLN', text: 'Polish Zloty (zł)'},
      { value: 'RON', text: 'Romanian Leu (RON)'},
      { value: 'RUB', text: 'Russian Ruble (₽)'},
      { value: 'SEK', text: 'Swedish krona (kr)'},
      { value: 'CHF', text: 'Swiss Franc (Fr)'},
      { value: 'USD', text: 'US Dollar (US $)'},
      { value: 'UYU', text: 'Uruguayan peso'}
    ];


    // -----------------------------------------
    // Selectores de currency headers mobile & tablet
    const mobileCurrency = $('#off-canvas-left-mob').find('#currency');
    const tabletCurrency = $('#off-canvas-menuLeft').find('.navMob .dropdown')[1];


    // -----------------------------------------
    // Vaciar las opciones de los header de EY
    $(mobileCurrency).find('option').remove();
    $(tabletCurrency).find('li').remove();


    // -----------------------------------------
    // Meter las opciones en el select de mobile y seleccionar el EUR
    let htmlOptionsMobile = '';
    currencyOptions.forEach(option => {
      ( option.value === 'EUR' )
        ? htmlOptionsMobile += `<option value=${option.value} selected>${option.text}</option>`
        : htmlOptionsMobile += `<option value=${option.value}>${option.text}</option>`;
    });
    $(mobileCurrency).append(htmlOptionsMobile);


    // -----------------------------------------
    // Meter las opciones en el select de tablet
    let htmlOptionsTablet = '';
    currencyOptions.forEach(option => {
      ( option.value === 'EUR' )
        ? htmlOptionsTablet += `<li class='is-selected' data-currency=${option.value}>${option.text}</li>`
        : htmlOptionsTablet += `<li data-currency=${option.value}>${option.text}</li>`;
    });
    $(tabletCurrency).find('.dropdown-menu').append(htmlOptionsTablet);


    // -----------------------------------------
    // Listener de select de mobile
    $(mobileCurrency).change(function (e) {

      // Cerrar menú mobile y llamar a cambiar moneda
      $('#header-mob').find('.navbar-toggle.btn-ico-menu').trigger('click');
      filter.currencyModal(e.target.value);
    });




    // -----------------------------------------
    // Listener de dropdown de tablet
    $(tabletCurrency).find('li').click(function (e) {

      // Cambiar valor seleccionado y llamar a cambiar moneda
      $(tabletCurrency).find('a').html(e.target.textContent + '<b class="caret"></b>');
      filter.currencyModal(e.target.dataset.currency);
    });
  }



  // --------------------------------------------------------------------------------
  // 2.E showRating -> Muestra los rating disponibles pasados en un array
  // --------------------------------------------------------------------------------
  showRating (arrayRating) {

    // Si hay ratings disponibles
    if ( arrayRating.length > 0 ) {

      // Contenedores del rating (desktop & mobile)
      let containerMobile = $(this.containers.mobile).find('.filter-hotels-rating');
      let containerDesktop = $(this.containers.desktop).find('.filter-hotels-rating');

      // Mostrar todo el gurpoo de ratings
      $(containerMobile).closest('.filter-hotels-group').removeClass('is-hidden');
      $(containerDesktop).closest('.filter-hotels-group').removeClass('is-hidden');

      // Recorrer el array de rating para mostrar los rating disponibles
      arrayRating.forEach(rating => {
        $(containerMobile).find(`.tripadvisor.rating-${rating}`).closest('.trip').addClass('is-show');
        $(containerDesktop).find(`.tripadvisor.rating-${rating}`).closest('.trip').addClass('is-show');
      });
    }
  }



  // --------------------------------------------------------------------------------
  // 2.F getCurrencyData -> Almacenar el array de conversiones de divisas
  // --------------------------------------------------------------------------------
  getCurrencyData () {
    // let filter = this;
    // $.ajax({
    //   url: 'https://www.nh-hotels.com/rest/jsonCurrency',
    //   dataType: 'json',
    //   async: false,
    //   cache: true,
    //   success: function (data) {
    //     filter.currencyConversions = data;
    //   }
    // });

    let euroConversions = [
      { "cur_dest": "ARS", "rate": "48.64116" },
      { "cur_dest": "CHF", "rate": "1.11090" },
      { "cur_dest": "CLP", "rate": "778.50770" },
      { "cur_dest": "COP", "rate": "3612.28402" },
      { "cur_dest": "EUR", "rate": "1.00000" },
      { "cur_dest": "GBP", "rate": "0.89291" },
      { "cur_dest": "MXN", "rate": "21.74450" },
      { "cur_dest": "USD", "rate": "1.13850" },
      { "cur_dest": "UYU", "rate": "39.96246" },
      { "cur_dest": "SEK", "rate": "10.63338" },
      { "cur_dest": "DKK", "rate": "7.46621" },
      { "cur_dest": "PLN", "rate": "4.25351" },
      { "cur_dest": "RUB", "rate": "71.83058" },
      { "cur_dest": "ILS", "rate": "4.12336" },
      { "cur_dest": "BRL", "rate": "4.34218" },
      { "cur_dest": "CAD", "rate": "1.50269" },
      { "cur_dest": "RON", "rate": "4.73507" },
      { "cur_dest": "HUF", "rate": "324.23065" },
      { "cur_dest": "AUD", "rate": "1.63766" },
      { "cur_dest": "PEN", "rate": "3.74583" },
      { "cur_dest": "NOK", "rate": "9.66434" },
      { "cur_dest": "INR", "rate": "79.21782" }
    ];
    this.currencyConversions = euroConversions;
  }



  // --------------------------------------------------------------------------------
  // 2.G initRange -> Inicialización de range (librería noUiSlider)
  // --------------------------------------------------------------------------------
  initRange (rangeElement, rangeValue) {
    let filterContainer = $(rangeElement).closest('.m-filter-hotels');
    let filter = this;

    // Establecer las unidades según precio o distancia
    let unit = null;
    if ( $(rangeElement).hasClass('js-filter-price') ) unit = this.currency.selected;
    else if ( $(rangeElement).hasClass('js-filter-distance') ) unit = 'km';

    // Inicializar el range
    noUiSlider.create(rangeElement, {
      start: rangeValue,
      connect: [true, false],
      // tooltips: true,
      range: {
        'min': 0,
        'max': rangeValue
      },
      format: {
        from: Number,
        to: function (value) { return Math.round(parseInt(value)) + ' ' + unit; }
      }
    });


    // Inicializar marcador estático de valores
    let spanValue = $(rangeElement).closest('.range').find('.js-filter-range-end')[0];
    rangeElement.noUiSlider.on('update', function (values, handle) {
      spanValue.innerHTML = values[handle];
    });


    // Llamar al setter correspondiente si el filtro es de desktop
    if ( !filterContainer.hasClass('is-mobile') ) {
      rangeElement.noUiSlider.on('change', value => {

        // quitar las unidades de los range
        let formatValue = filter.formatRange(value);

        // Setar valor de range
        ( $(rangeElement).hasClass('js-filter-price') )
          ? filter.setRange(formatValue, 'js-filter-price')
          : filter.setRange(formatValue, 'js-filter-distance');

        // Deshabilitar filtro desktop
        this.loadingHotels(true);
      });
    }

    // Asignar valores iniciales de range al filtro
    if ( $(rangeElement).hasClass('js-filter-distance') ) {
      this.nearTo.distance = rangeValue;

    } else if ( $(rangeElement).hasClass('js-filter-price') ) {
      this.price = rangeValue;
    }
  }

  // --------------------------------------------------------------------------------
  // 2.H toggleCurrency -> Si el filtro currency debe estar oculto o visible
  // --------------------------------------------------------------------------------
  toggleCurrency (visible) {
   // Selectores de todos los selects de moneda
   const mobileCurrency = $('#off-canvas-left-mob').find('#currency');
   const tabletCurrency = $('#off-canvas-menuLeft').find('.navMob .dropdown').eq(1);
   const desktopCurrency = $(this.containers.desktop).find('.filter-currency-wrapper');

   mobileCurrency.parents(".language-select").toggle(visible);
   $(tabletCurrency).toggle(visible);
   desktopCurrency.toggle(visible);
  }

  // --------------------------------------------------------------------------------
  // 3.A. listenerDesktop -> Listener filtro desktop (activar filtro uno a uno)
  // --------------------------------------------------------------------------------
  listenerDesktop () {

    // -------------------------------------------
    // Selectores elementos desktop
    const filterSort = this.containers.desktop.querySelector('.js-filter-sort.selectpicker');
    const filterCurrency = this.containers.desktop.querySelector('.js-filter-currency.selectpicker');
    const filterServices = this.containers.desktop.querySelectorAll('[data-service]');
    const filterLocation = this.containers.desktop.querySelector('.js-filter-location');
    const filterRatings = this.containers.desktop.querySelectorAll('[data-rating]');


    // -------------------------------------------
    // Escuchadores de eventos

    // captura el orden
    filterSort.addEventListener('change', e => {
      this.setSorted(e.target.value);
      this.loadingHotels(true);
    });


    // Captura el cambio del select de moneda
    filterCurrency.addEventListener('change', e => {
      this.currencyModal(e.target.value);
    });

    // captura que link de servicios se ha activado/desactivado
    // nos ayudamos de la clase modificadora 'is-active'
    filterServices.forEach(link => {
      link.addEventListener('click', e => {
        let parent = $(e.target).closest('[data-service]')[0];
        this.setServiceDesktop(parent.dataset.service, $(link).hasClass('is-active'));
        this.loadingHotels(true);
      });
    });

    // captura el select de localización cercana
    filterLocation.addEventListener('change', e => {
      this.setLocation(e.target.value);
      this.loadingHotels(true);
    });

    // captura que check de rating has clickado
    filterRatings.forEach(check => {
      check.addEventListener('change', e => {
        this.setRatingDesktop(e.target.dataset.rating, e.target.checked);
        this.loadingHotels(true);
      });
    });
  }



  // --------------------------------------------------------------------------------
  // 3.B listenerMobile -> Listener filtro mobile (activar todos los filtros al pulsar botón modal)
  // --------------------------------------------------------------------------------
  listenerMobile () {
    const mobileButton = $(this.containers.mobile).find('.js-filter-hotels-button');
    const $modalFilter = $(this.containers.mobile).find('.modal');
    const filter = this;

    // --------------------------------------------------------------------------------
    // Cambiar todos los valores del filtro desde móvil
    $(mobileButton).click(function () {

      // ----------------------------------------------------
      // Selectores campos filtro mobile
      const mobileSorted = $(filter.containers.mobile).find('.js-filter-sort.selectpicker')[0];
      const mobilePrice = $(filter.containers.mobile).find('.js-filter-price')[0];
      const mobileServices = $(filter.containers.mobile).find('.is-active[data-service]');
      const mobileLocation = $(filter.containers.mobile).find('.js-filter-location.selectpicker')[0];
      const mobileDistance = $(filter.containers.mobile).find('.js-filter-distance')[0];
      const mobileRatings = $(filter.containers.mobile).find('[data-rating]:checked');


      // ----------------------------------------------------
      // Llamadas a los setters para cambiar atributos de filtro y campos desktop -> ordenador por tipos (range, check, select)

      // Setear precio (formateamos para quitar moneda)
      let priceValue = null;
      if ( !$(mobilePrice).closest('.filter-hotels-group').hasClass('is-hidden') ) {
        priceValue = mobilePrice.noUiSlider.get();
        filter.setRange(filter.formatRange(priceValue, true), 'js-filter-price');
      }

      // Setear distancia (formateamos para quitar km)
      let distanceValue = mobileDistance.noUiSlider.get();
      filter.setRange(filter.formatRange(distanceValue, true), 'js-filter-distance', false, true);

      // Setear servicios
      let arrayServices = [];
      $(mobileServices).each(function (index, element) {
        arrayServices.push(element.dataset.service);
      });
      filter.setServiceMobile(arrayServices);

      // Setear ratings
      let arrayRatings = [];
      $(mobileRatings).each(function (index, value) {
        let ratingValue = $(value).data('rating');
        arrayRatings.push(ratingValue.toString());
      });
      filter.setRatingMobile(arrayRatings);

      

      // Setear localización
      filter.setLocation($(mobileLocation).val());

      // Setear orden y ordenar solo si el valor seleccionado es diferente al actual
      filter.setSorted($(mobileSorted).val());

      // Ocultar modal
      $modalFilter.modal('hide');
    });
  }



  // ---------------------------------------------------
  // 4.A setRange -> Cambia el atributo de elementos de rango (precio y distancia)
  // ---------------------------------------------------
  setRange (value, rangeClass, isRemoved, isMobile) {
    let containerTags = $(this.containers.mobile).find('.m-filter-tags');

    // Cambiar valores filtros
    $(this.containers.mobile).find(`.${rangeClass}`)[0].noUiSlider.set(value);
    $(this.containers.desktop).find(`.${rangeClass}`)[0].noUiSlider.set(value);

    // Precio: actualizar atributo filtro
    if ( rangeClass === 'js-filter-price') {
      this.price = value;

      // Si no estamos eliminando el tag
      if ( !isRemoved ) {
        // Generamos o actualimos el tag
        ( !$(containerTags).find('[data-price]').length )
          ? this.createTag('price', value)
          : this.updateTag ('price', value);
      }
    }

    // Distancia: actualizar atributo filtro
    if ( rangeClass === 'js-filter-distance') {
      this.nearTo.distance = value;

      // La referencia a location es diferente en desktop y mobile
      let actualLocation = this.nearTo.location.value;
      ( isMobile )
        ? actualLocation = $(this.containers.mobile).find('.js-filter-location.selectpicker').val()
        : actualLocation = this.nearTo.location.value;

      // Si no estamos eliminando el tag
      if ( !isRemoved ) {

        // Generamos o actualimos el tag
        ( !$(containerTags).find('[data-distance]').length && actualLocation && actualLocation !== 'invalid' )
          ? this.createTag('distance', value)
          : this.updateTag ('distance', value);
      }
    }

    // Filtrar hoteles
    this.filterHotels();
  }



  // ---------------------------------------------------
  // 4.B setServiceMobile -> Cambia el atributo de services (desde mobile)
  // ---------------------------------------------------
  setServiceMobile (values) {
    let filter = this;

    // -----------------------------------------
    // Actualización atributo servicios
    this.services = values;


    // -----------------------------------------
    // Actualización de filtro oculto
    $(this.containers.desktop).find('[data-service]').each(function (index, service) {
      let data = $(service).data('service');
      ( filter.services.includes(data) )
        ? $(service).addClass('is-active')
        : $(service).removeClass('is-active');
    });


    // -----------------------------------------
    // Generación de tags
    let containerTags = $(this.containers.desktop).find('.m-filter-tags')[0];
    let serviceTags = $(containerTags).find('[data-service]');
    let allServices =  $(this.containers.mobile).find('.filter-hotels-services [data-service]');

    if ( !serviceTags.length ) {
      this.services.forEach(value => this.createTag('service', value) );

    } else {

      $(allServices).each(function (index, service) {
        let isActive = $(service).hasClass('is-active');
        let data = $(service).data('service');
        let hasTag = $(containerTags).find(`[data-service=${data}]`);

        if ( isActive && (hasTag.length === 0) ) filter.createTag('service', data);
        else if ( !isActive && (hasTag.length > 0) ) filter.removeTag('service', data, true);
      });
    }

    this.filterHotels();
  }



  // ---------------------------------------------------
  // 4.C setServiceDesktop -> Cambia el atributo de services (desde desktop)
  // ---------------------------------------------------
  setServiceDesktop (value, isActive) {
    let filter = this;

    // -----------------------------------------
    // Actualización atributo servicios
    if ( isActive ) {
      if ( !this.services.includes(value) ) this.services.push(value);

    } else {
      if ( this.services.includes(value) ) {
        let index = this.services.indexOf(value);
        this.services.splice(index, 1);
      }
    }


    // -----------------------------------------
    // Actualización de filtro oculto
    $(this.containers.mobile).find('[data-service]').each(function (index, service) {
      let data = $(service).data('service');
      ( filter.services.includes(data) )
        ? $(service).addClass('is-active')
        : $(service).removeClass('is-active');
    });


    // -----------------------------------------
    // Generación de tags
    let containerTags = $(this.containers.desktop).find('.m-filter-tags')[0];
    let serviceTags = $(containerTags).find('[data-service]');

    // Si no hay tags de servicio lo creamos
    if ( !serviceTags.length ) {
      this.createTag('service', value);

    // Si hay tags de servicio se crea/elimina tag
    } else {
      ( isActive )
        ? this.createTag('service', value)
        : this.removeTag ('service', value, true);
    }

    this.filterHotels();
  }


  // ---------------------------------------------------
  // 4.D setRatingMobile -> Cambia el atributo de rating (desde mobile)
  // ---------------------------------------------------
  setRatingMobile (values) {
    let filter = this;

    // -----------------------------------------
    // Actualización atributo rating
    this.ratings = []; // Array con datos medios
    let simpleRatings = []; // Array auxiliar sin datos medios
    values.forEach(rating => {
      simpleRatings.push(rating);
      ( parseInt(rating) < 5 )
        ? this.ratings.push( rating.concat('.0'), rating.concat('.5') )
        : this.ratings.push(rating);
    });



    // -----------------------------------------
    // Actualización de filtro oculto
    $(this.containers.desktop).find('[data-rating]').each(function (index, rating) {
      let data = $(rating).data('rating');
      ( simpleRatings.includes(data.toString() ) )
        ? $(rating).prop('checked', true)
        : $(rating).prop('checked', false);
    });


    // -----------------------------------------
    // Generación de tags
    let containerTags = $(this.containers.desktop).find('.m-filter-tags')[0];
    let ratingTags = $(containerTags).find('[data-rating]');
    let allRatings =  $(this.containers.mobile).find('.trip.is-show [data-rating]');

    if ( !ratingTags.length ) {
      simpleRatings.forEach(value => this.createTag('rating', value) );

    } else {
      // Recorremos todas los rating para actualizarlas
      $(allRatings).each(function (index, rating) {

        // Está checkado, valor de rating y si tiene ya un tag con ese valor
        let isChecked = $(rating).prop('checked') ;
        let data = $(rating).data('rating');
        let hasTag = $(containerTags).find(`[data-rating=${data}]`);

        // Si está checkeado y no hay tag del valor lo creamos
        if ( isChecked && (hasTag.length === 0) ) filter.createTag('rating', data);

        // Si no está checkeado y hay tag del valor lo eliminamos
        else if ( !isChecked && (hasTag.length > 0) ) filter.removeTag('rating', data, true);
      });
    }

    this.filterHotels();
  }


  // ---------------------------------------------------
  // 4.E setRatingDesktop -> Cambia el atributo de rating (desde desktop)
  // ---------------------------------------------------
  setRatingDesktop (value, isChecked) {

    // Posibles valores dobles de ratings
    let ratingArray = value;
    if ( value === '4' ) ratingArray = ['4.0', '4.5'];
    else if ( value === '3' ) ratingArray = ['3.0', '3.5'];


    // Función auxiliar para eliminar un index de un array
    const deleteIndex = val => {
      let index = this.ratings.indexOf(val);
      this.ratings.splice(index, 1);
    }


    // -----------------------------------------
    // Actualización atributo ratings

    // Caso checkeado: comprobamos si está en el atributo y añadimos uno o dos valores
    if ( isChecked ) {
      if ( !this.ratings.includes(ratingArray) ) {
        ( ratingArray.length > 1 )
          ? ratingArray.forEach(rating => { this.ratings.push(rating) })
          : this.ratings.push(ratingArray);
      }

    // Caso no checkeado: si está incluído en el atributo quitamos uno o dos valores
    } else {

      if ( ratingArray.length > 1 ) {
        ratingArray.forEach(rating => {
          if ( this.ratings.includes(rating) ) deleteIndex(rating);
        });

      } else {
        if ( this.ratings.includes(ratingArray) ) deleteIndex(ratingArray);
      }
    }


    // -----------------------------------------
    // Actualización de filtro oculto
    let simpleRating = this.ratings.map(rating => parseInt(rating));
    $(this.containers.mobile).find('[data-rating]').each(function (index, rating) {
      let data = $(rating).data('rating');
      ( simpleRating.includes(data) )
        ? $(rating).prop('checked', true)
        : $(rating).prop('checked', false);
    });


    // -----------------------------------------
    // Generación de tags
    let containerTags = $(this.containers.desktop).find('.m-filter-tags')[0];
    let ratingTags = $(containerTags).find('[data-rating]');

    // Si no hay tags de rating lo creamos
    if ( !ratingTags.length ) {
      this.createTag('rating', value);

    // Si hay tags de servicio se crea/elimina tag
    } else {
      ( isChecked )
        ? this.createTag('rating', value)
        : this.removeTag('rating', value, true);
    }

    this.filterHotels();
  }


  // ---------------------------------------------------
  // 4.F setSorted -> Cambia el atributo de ordenar
  // ---------------------------------------------------
  setSorted (value) {
    let mobileSorted = $(this.containers.mobile).find('.js-filter-sort.selectpicker')[0];
    let desktopSorted = $(this.containers.desktop).find('.js-filter-sort.selectpicker')[0];

    // Actualizamos ambos filtros
    $(mobileSorted).val(value);
    $(mobileSorted).change();
    $(desktopSorted).val(value);
    $(desktopSorted).change();

    // Cambiamos valor y mandamos ordenar
    this.sortedBy = value;
    this.sortedGroups();
  }


  // ---------------------------------------------------
  // 4.G setCurrency -> Cambia el atributo de selected de currency
  // ---------------------------------------------------
  setCurrency (isChange) {

    // Selectores de todos los selects de moneda
    const mobileCurrency = $('#off-canvas-left-mob').find('#currency');
    const tabletCurrency = $('#off-canvas-menuLeft').find('.navMob .dropdown')[1];
    const desktopCurrency = $(this.containers.desktop).find('.js-filter-currency.selectpicker')[0];

    // Averiguar el value en cada caso de confirmación
    let value = null;
    ( isChange ) ? value = this.currency.aux : value = this.currency.selected;

    // cambiar valores de filtro mobile
    $(mobileCurrency).val(value);

    // cambiar valores de filtro tablet
    let optionValue = $(tabletCurrency).find(`[data-currency=${value}]`);
    $(tabletCurrency).find('.is-selected').removeClass('is-selected');
    $(optionValue).addClass('is-selected');
    $(tabletCurrency).find('a').html($(optionValue).text() + '<b class="caret"></b>');

    // cambiar valores de filtro desktop
    $(desktopCurrency).val(value);
    $(desktopCurrency).change();

    // Cambiamos valor de atributos moneda
    if ( isChange ) this.currency.origin = this.currency.selected;
    this.currency.selected = value;
    this.currency.aux = null;

    // Si cambia la divisa llamamos a cambiar precio
    if ( isChange ) this.changeHotelsCurrency();
  }


  // ---------------------------------------------------
  // 4.H setLocation -> Cambiar atributo localizacion (caso especial demasiado específico)
  // ---------------------------------------------------
  setLocation (value) {
    let mobileLocation = $(this.containers.mobile).find('.js-filter-location.selectpicker')[0];
    let desktopLocation = $(this.containers.desktop).find('.js-filter-location.selectpicker')[0];
    let mobileDistance = $(this.containers.mobile).find('.filter-hotels-distance')[0];
    let desktopDistance = $(this.containers.desktop).find('.filter-hotels-distance')[0];
    const filterSort = $('.js-filter-sort');

    // -------------------------------------------------
    // cambiar valores location
    $(mobileLocation).val(value);
    $(mobileLocation).change();
    $(desktopLocation).val(value);
    $(desktopLocation).change();


    // -------------------------------------------------
    // mostrar/ocultar distancia
    if ( value === 'invalid' ) {
      const filterSort = $('.js-filter-sort.selectpicker');
      $(mobileDistance).addClass('is-hidden');
      $(desktopDistance).addClass('is-hidden');

      // deshabilitar en el ordenar por poi
      $(filterSort).find("option[value^='poi-']").attr('disabled', 'disabled');

    } else {
      $(mobileDistance).removeClass('is-hidden');
      $(desktopDistance).removeClass('is-hidden');

      if ( value === this.locationCenter.value ) {
        $(filterSort).find("option[value^='poi-']").attr('disabled', 'disabled');

      } else {
        $(filterSort).find("option[value^='poi-']").removeAttr('disabled')
      }

    }

    // actualizar atributo filtro y selects de ordenar
    this.nearTo.location.value = value;
    this.nearTo.location.text = $(mobileLocation).find(`option[value=${value}]`).text();
    $(filterSort).selectpicker('render');


    // -------------------------------------------------
    // Generación de tags
    let containerTags = $(this.containers.mobile).find('.m-filter-tags');

    // Si no hay tags y el valor es válido
    if ( !$(containerTags).find('[data-location]').length ) {
      if ( value !== 'invalid' ) this.createTag('location', value, this.nearTo.location.text);

    } else {
      ( value === 'invalid' )
        ? this.removeTag ('location', value, true)
        : this.updateTag ('location', this.nearTo.location.text);
    }

    // Filtrar hoteles
    this.filterHotels();
  }



  // --------------------------------------------------------------------------------
  // 5.A filterHotels -> Recoger todos los datos relacionados con los hoteles
  // --------------------------------------------------------------------------------
  filterHotels () {
    let totalHotels = $(this.containers.result).find('.m-hotel-box').length;

    // Reiniciamos el contador de hoteles y los pois mostrados
    this.cont = 0;
    this.showPois = [];

    // Recorremos cada hotel
    this.containers.result.querySelectorAll('.m-hotel-box').forEach( (hotel, index) => {

      // ---------------------------------------------------
      // Objeto que almacena el data de cada hotel
      let hotelData = {
        price: hotel.dataset.price,
        services: hotel.dataset.services,
        pois: hotel.dataset.pois,
        rating: hotel.dataset.rating
      };


      // ---------------------------------------------------
      // Para saber si se muestra o no el hotel
      if ( this.canShowHotel (hotelData) ) {
        $(hotel).removeClass('is-hidden');
        this.cont++;
        this.showPois.push(hotel.dataset.backcode); // Almacenamos los backcode (actúan como ids)

      } else {
        $(hotel).addClass('is-hidden');
      }


      // ---------------------------------------------------
      // Actualizar el poi de cada card
      let poiHotel = $(hotel).find('.js-contact-poi');
      let templatePoi = { location: null, distance: null };


      // La localización no está definida (ponemos el poi center)
      if ( this.nearTo.location.value === 'invalid' || this.nearTo.location.value === null ) {
        templatePoi.location = JSON.parse(hotelData.pois)[0].location;
        templatePoi.distance = JSON.parse(hotelData.pois)[0].distance;
        $(poiHotel).html(`<strong>${templatePoi.distance} km</strong> ${templatePoi.location}`);


      // La localización ha cambiado respecto al card de hotel
      } else if ( $(poiHotel).val() !== this.nearTo.location.text ) {
        // Buscar poi seleccionado en el data del hotel
        let poiValue = JSON.parse(hotelData.pois).find(x => x.location === this.nearTo.location.text);

        // Si está el poi del select definido en el hotel refrescamos html
        if ( poiValue ) {
          templatePoi.location = poiValue.location;
          templatePoi.distance = poiValue.distance;
          $(poiHotel).html(`<strong>${templatePoi.distance} km</strong> ${templatePoi.location}`);

        // Si no tiene ese poi ocultamos el hotel
        } else {
          this.cont = this.cont--;
          $(hotel).addClass('is-hidden');
        }
      }

      // Hacer saltar el evento para filtrar los pois del mapa
      if ( index === (totalHotels-1) ) {
        $(this.containers.result).trigger("filterHotelsDone");
      }
    });

    //$(this.containers.result).trigger("filterHotelsDone");


    // ---------------------------------------------------
    // Actualizar contador de hoteles mostrados
    document.querySelectorAll(`.${this.page} .js-filter-hotels-number`).forEach(hotelCont => {
      return hotelCont.textContent = this.cont;
    });

    // Mostar div de no resultados si no hay hoteles
    ( !this.cont )
      ? $(this.containers.result).find('.m-alert').removeClass('is-hidden')
      : $(this.containers.result).find('.m-alert').addClass('is-hidden');

    // Comprobar si hay que mostrar/ocultar grupos de hoteles
    this.canShowHotelsGroup();
  }



  // --------------------------------------------------------------------------------
  // 5.B canShowHotel -> Comparar datos de hotel y filtro para saber si mostrar u ocultar
  // --------------------------------------------------------------------------------
  canShowHotel (hotelData) {

    // -------------------------------------------
    // Variables que guardan las comparaciones entre filtro y hotel
    let isPrice = false;
    let isServices = false;
    let isNearTo = false;
    let isRating = false;


    // -------------------------------------------
    // Comprobaciones de atributos

    // Comprobamos precio
    let parsePrice = Math.round(parseFloat(hotelData.price));
    if ( this.price >= parsePrice ) isPrice = true;

    // Comparamos servicios
    let communServices = this.services.filter(x => JSON.parse(hotelData.services).includes(x));
    if ( this.services.length === 0 ) isServices = true;
    else if ( this.services.length === communServices.length ) isServices = true;

    // Comparamos pois
    let parseDistance = null;

    let isLocation = JSON.parse(hotelData.pois).find(x => x.location === this.nearTo.location.text);
    if ( isLocation !== undefined ) parseDistance = Math.round(parseFloat(isLocation.distance));

    if ( this.nearTo.location.value === 'invalid' || this.nearTo.location.value === null ) isNearTo = true;
    else if ( isLocation !== undefined && parseDistance <= this.nearTo.distance ) isNearTo = true;

    // Comparamos ratings
    if ( this.ratings.length === 0 ) isRating = true;
    else if ( this.ratings.includes(hotelData.rating) ) isRating = true;


    // -------------------------------------------
    // Si es todo true podremos visualizarlo
    if ( isPrice && isServices && isNearTo && isRating ) return true;
    else return false;
  }




  // --------------------------------------------------------------------------------
  // 5.C canShowHotelsGroup -> Contar hoteles visibles para saber si mostrar/ocultar grupo
  // --------------------------------------------------------------------------------
  canShowHotelsGroup () {
    let filter = this;

    $(this.groups).each(function (index, hotelGroupData) {
      let groupContainer = $(filter.containers.result).find(`[data-hotels-group=${hotelGroupData}]`);
      let totalHotels = 0;
      let hiddenHotels = 0;

      $(groupContainer).find('.m-hotel-box').each(function (index, hotel) {
        totalHotels++;
        if ( $(hotel).hasClass('is-hidden') ) hiddenHotels++;
      });

      ( totalHotels === hiddenHotels )
        ? $(groupContainer).addClass('is-hidden')
        : $(groupContainer).removeClass('is-hidden');
    });

    // Quitar disabled filtros
    setTimeout(() => { this.loadingHotels(false); }, 1000);
  }



  // --------------------------------------------------------------------------------
  // 5.D getShowPois -> Devuelve el backcode de los hoteles que se mostrarán en el mapa al filtrar
  // --------------------------------------------------------------------------------
  getShowPois () {
    return this.showPois;
  }



  // --------------------------------------------------------------------------------
  // 6.A sortedGroups -> Según el valor del select se tienen que ordenar en unos grupos u otros
  // --------------------------------------------------------------------------------
  sortedGroups () {
    let sortedGroups = this.groups;

    // Ordenar por precios solo ordena los disponibles
    if ( this.sortedBy === 'price-asc' || this.sortedBy === 'price-desc' ) {
      sortedGroups = ["promo", "promo-near", "stock", "stock-near"];

    // Ordenar por distancia al centro cambia el valor de distancia de filtros desktop y mobile
    } else if ( this.sortedBy === 'center-asc' || this.sortedBy === 'center-desc' ) {

      let mobileLocation = $(this.containers.mobile).find('.js-filter-location.selectpicker')[0];
      let desktopLocation = $(this.containers.desktop).find('.js-filter-location.selectpicker')[0];

      $(mobileLocation).val(this.locationCenter.value);
      $(mobileLocation).change();

      $(desktopLocation).val(this.locationCenter.value);
      $(desktopLocation).change();

      // Volvemos a setear de centro
      this.setLocation(this.locationCenter.value);
      this.loadingHotels(true);

      // Mostrar distancia en los dos filtros
      $(this.containers.mobile).find('.filter-hotels-distance').removeClass('is-hidden');
      $(this.containers.desktop).find('.filter-hotels-distance').removeClass('is-hidden');
    }

    // Ordenamos los hoteles de cada grupo
    sortedGroups.forEach(group => this.sortedHotels(group));
  }



  // --------------------------------------------------------------------------------
  // 6.B sortedHotels -> Pasamos el grupo para que ordene según el valor seleccionado
  // --------------------------------------------------------------------------------
  sortedHotels (group) {
    let filter = this;
    let sortResult = null;

    let listsGroup = $(this.containers.result).find(`[data-hotels-group=${group}]`);
    let hotelsGroup = $(listsGroup).find('.m-hotel-box').detach();
    hotelsGroup = Array.prototype.slice.call(hotelsGroup, 0);


    // Función de comparación para ordenar en la mayoría de los casos
    const genericCompare = (filterValue, paramA, paramB) => {
      ( filter.sortedBy === filterValue )
        ? sortResult = paramA > paramB ? 1 : -1
        : sortResult = paramA < paramB ? 1 : -1;
    };


    // Evitar los grupos de hoteles que están vacíos
    if ( hotelsGroup.length > 0 ) {

      hotelsGroup.sort(function (hotelA, hotelB) {
        switch (filter.sortedBy) {

          // ----------------------------------------------------------
          // Ordenar por nh recomendaciones
          case 'nh-recommends':
            var recommendA = parseInt($(hotelA).data('recommend'));
            var recommendB = parseInt($(hotelB).data('recommend'));
            sortResult = recommendA > recommendB ? 1 : -1;
            break;


          // ----------------------------------------------------------
          // Ordenar por precios
          case 'price-asc':
          case 'price-desc':
            var priceA = parseFloat($(hotelA).data('price'));
            var priceB = parseFloat($(hotelB).data('price'));
            genericCompare('price-asc', priceA, priceB);
            break;


          // ----------------------------------------------------------
          // Ordenar por nombre de hotel
          case 'name-asc':
          case 'name-desc':
            var titleA = $.trim($(hotelA).data('title'));
            var titleB = $.trim($(hotelB).data('title'));
            genericCompare('name-asc', titleA, titleB);
            break;


          // ----------------------------------------------------------
          // Ordenar por rating de hotel
          case 'rating-asc':
          case 'rating-desc':
            var ratingA = parseFloat($(hotelA).data('rating'));
            var ratingB = parseFloat($(hotelB).data('rating'));
            genericCompare('rating-asc', ratingA, ratingB);
            break;



          // ----------------------------------------------------------
          // Ordenar por distancia al poi
          case 'poi-asc':
          case 'poi-desc':
            // Asegurarnos que tienen data del poi seleccionado
            let dataA = $(hotelA).data('pois').filter(poi => poi.location === filter.nearTo.location.text);
            let dataB = $(hotelB).data('pois').filter(poi => poi.location === filter.nearTo.location.text);

            // Asegurarnos que el nearto esté inicializado
            if ( !filter.nearTo.location.value ) {
              let mobileLocation = $(filter.containers.mobile).find('.js-filter-location.selectpicker option:selected');
              filter.nearTo.location.text = mobileLocation.text();
              filter.nearTo.location.value = mobileLocation.val();
            }

            if ( !$.isEmptyObject(dataA) && !$.isEmptyObject(dataB) ) {

              // Calculamos la distancia para ordenar
              let distanceA =  parseFloat(dataA[0].distance);
              let distanceB =  parseFloat(dataB[0].distance);
              genericCompare( 'poi-asc', distanceA, distanceB );

            } else if ( $.isEmptyObject(dataA) || $.isEmptyObject(dataB) ) {
              if ( $.isEmptyObject(dataA) ) sortResult = 1;
              if ( $.isEmptyObject(dataB) ) sortResult = -1;
            }
            break;



          // ----------------------------------------------------------
          // Ordenar por distancia al centro de la ciudad
          case 'center-asc':
          case 'center-desc':
            // Cogemos de cada hotel la distancia del array de pois en data que corresponda al centro
            var centerA = parseFloat($(hotelA).data('pois').filter(poi => poi.location === filter.locationCenter.text)[0].distance);
            var centerB = parseFloat($(hotelB).data('pois').filter(poi => poi.location === filter.locationCenter.text)[0].distance);
            genericCompare('center-asc', centerA, centerB);
            break;



          // ----------------------------------------------------------
          // Ordenar por ubicación actual (solo móvil)
          case 'close-to-me':
            var origin = { lat: filter.geolocation.latitude, lng: filter.geolocation.longitude};

            // Calcular distancia del geolocation al hotelA
            var latitudeA = $(hotelA).data('coordinates').latitude;
            var longitudeA = $(hotelA).data('coordinates').longitude;
            var distanceA = utils.getDistanceBetweenCoords ( origin, { lat: latitudeA, lng: longitudeA });

            // Calcular distancia del geolocation al hotelB
            var latitudeB = $(hotelB).data('coordinates').latitude;
            var longitudeB = $(hotelB).data('coordinates').longitude;
            var distanceB = utils.getDistanceBetweenCoords ( origin, { lat: latitudeB, lng: longitudeB });

            // Función comparadora de distancias de menor a mayor
            sortResult = parseFloat(distanceA) > parseFloat(distanceB) ? 1 : -1;
            break;
        }

        return sortResult;
      });
    }


    // Repintar los hoteles en los divs de los grupos
    for (let i = 0; i < hotelsGroup.length; i++) {
      $(listsGroup).append(hotelsGroup[i]);
    }


    // Quitar disabled filtros
    setTimeout(() => { this.loadingHotels(false); }, 1000);
  }





  // --------------------------------------------------------------
  // 7.A currencyModal -> Controlar cambio de moneda (modal currency)
  // --------------------------------------------------------------
  currencyModal (value) {
    let filter = this;

    // si la moneda cambia abrimos la modal de confirmación de cambio de moneda
    if ( value !==  this.currency.selected ) {
      $('#modal-filter-currency').modal('show');

      // Almacenamos en auxiliar hasta confirmación de cambio de moneda
      filter.currency.aux = value;
    }
  }


  // --------------------------------------------------------------------------------
  // 7.B changeHotelsCurrency -> Cambiar la moneda en todos los hotel cards
  // --------------------------------------------------------------------------------
  changeHotelsCurrency () {
    let filter = this;

    // ------------------------------------------------------------
    // Obtener el rate adecuado para cambiar la divisa

    // Con array de conversión de todas las monedas
    // let arrayConversionOrigin = this.currencyConversions.currencies.filter(currency => currency.cur_origin === this.currency.origin);
    // let conversionDestination = arrayConversionOrigin[0].conversions.filter(currency => currency.cur_dest === this.currency.selected);
    // let conversionRate = parseFloat(conversionDestination[0].rate);

    // Con array de conversión solo de EUR
    let conversionDestination = this.currencyConversions.filter(currency => currency.cur_dest === this.currency.selected);
    let conversionRate = parseFloat(conversionDestination[0].rate);


    // ------------------------------------------------------------
    // Cambiar precio y divisa en cada hotel

    // Solo cogemos los grupos de hoteles con precio
    let hotelGroupsPrices = ["promo", "promo-near", "stock", "stock-near"];

    // Recorremos los grupos
    $(hotelGroupsPrices).each(function (index, hotelGroupData) {
      let groupContainer = $(filter.containers.result).find(`[data-hotels-group=${hotelGroupData}]`);

      // Recorremos los hoteles de cada grupo
      $(groupContainer).find('.m-hotel-box').each(function (index, hotel) {
        let newCurrency = filter.currency.selected;

        // Calcular nuevo precio
        let newPrice = parseFloat($(hotel).data('euro')) * conversionRate;
        newPrice = (Math.round(newPrice * 100) / 100).toFixed(2);

        // Cambiar data de hotel
        $(hotel).attr('data-price', newPrice);
        $(hotel).attr('data-currency', newCurrency);

        // Cambiar info de hotel
        $(hotel).find('.js-price').text(newPrice);
        $(hotel).find('.js-currency').text(newCurrency);
      });
    });



    // ------------------------------------------------------------
    // Actualizar slider de precios con el precio más alto

    // Conseguir array de precios en promo, promo-near, stock y stock-near
    let pricesPromo = [];
    let pricesPromoNear = [];
    let pricesStock = [];
    let pricesStockNear = [];

    $('[data-hotels-group=promo]').find('.totalPrice').each(function (index, price) {
      pricesPromo.push(parseFloat($(price).text()));
    });
    $('[data-hotels-group=promo-near]').find('.totalPrice').each(function (index, price) {
      pricesPromoNear.push(parseFloat($(price).text()));
    });
    $('[data-hotels-group=stock]').find('.totalPrice').each(function (index, price) {
      pricesStock.push(parseFloat($(price).text()));
    });
    $('[data-hotels-group=stock-near]').find('.totalPrice').each(function (index, price) {
      pricesStockNear.push(parseFloat($(price).text()));
    });

    // Fusionar los dos arrays y ordenarlos de mayor a menor
    let arrayPrices = [...pricesPromo, ...pricesPromoNear, ...pricesStock, ...pricesStockNear];
    arrayPrices.sort(function(a, b) { return b - a; });

    // Cambiar los rangos de filtros de precio y setearlos al máximo valor
    let rangeMobile = $(this.containers.mobile).find('.js-filter-price')[0];
    let rangeDesktop = $(this.containers.desktop).find('.js-filter-price')[0];
    let finalPrice = Math.round(arrayPrices[0]) + 1;

    // Opciones comunes de ambos range (resetear format para actualizar moneda)
    let rangeOptions = {
      range: { 'min': 0, 'max': finalPrice },
      format: {
        from: Number,
        to: function (value) { return Math.round(parseInt(value)) + ' ' + filter.currency.selected; }
      }
    };

    // Range price de móvil -> cambiar opciones y máximo
    rangeMobile.noUiSlider.updateOptions(rangeOptions);
    rangeMobile.noUiSlider.set(finalPrice);

    // Range desktop de móvil -> cambiar opciones y máximo
    rangeDesktop.noUiSlider.updateOptions(rangeOptions);
    rangeDesktop.noUiSlider.set(finalPrice);


    // Actualizar el tag de precio si hay alguno creado
    // Cambiar tag asociado al precio
    let containerTags = $(this.containers.mobile).find('.m-filter-tags');
    if ( $(containerTags).find('[data-price]').length ) {
      this.updateTag ('price', finalPrice);
    }


    // Quitar disabled filtros
    setTimeout(() => { this.loadingHotels(false); }, 1000);
  }



  // --------------------------------------------------------------------------------
  // 8.A CreateTag -> Genera un tag de un elemento (precio) o grupos de elementos (servicios) filtrados
  // --------------------------------------------------------------------------------
  createTag (data, value, text) {
    let filter = this;

    // Texto extra de tags específicos
    let templateText = value;
    if ( data === 'price' ) templateText = `${value} ${this.currency.selected}`;
    if ( data === 'rating' ) templateText = `<div class='tripadvisor rating-${value}'></div>`;
    if ( data === 'location' ) templateText = text;
    let labelFiltersLessThan = (typeof pageData.labelFiltersLessThan != "undefined") ? pageData.labelFiltersLessThan : ""
    if ( data === 'distance' ) templateText = `${labelFiltersLessThan} ${value} km`;

    // Estructura básica de un tag
    let tagTemplate = `<div class='filter-tag' data-${data}=${value}>
                        <span class="js-filter-tag-value">${templateText}</span>
                        <button class="btn-ico js-filter-tag-remove" type="button" aria-label="Close">
                          <span class="nh-ic-close" aria-hidden="true"></span>
                        </button>
                      </div>`;

    // Agregar el tag en los contenedores (desktop & mobile)
    $(this.containers.mobile).find('.m-filter-tags').append(tagTemplate);
    $(this.containers.desktop).find('.m-filter-tags').append(tagTemplate);

    // Crear escuchador del remove (desktop & mobile)
    $(`.filter-tag[data-${data}=${value}]`).find('.js-filter-tag-remove').each(function (index, element) {
      $(element).click(function (e) {
        e.preventDefault();
        filter.removeTag(data, value); });
    });
  }



  // --------------------------------------------------------------------------------
  // 8.B updateTag -> Modificar tags existentes cuando cambia su valor de filtro
  // --------------------------------------------------------------------------------
  updateTag (data, text) {

    // Textos personalizados de ciertos tags
    let tagText = text;
    if ( data === 'price' ) tagText = `${text} ${this.currency.selected}`;
    let labelFiltersLessThan = (typeof pageData.labelFiltersLessThan != "undefined") ? pageData.labelFiltersLessThan : ""
    if ( data === 'distance' ) tagText = `${labelFiltersLessThan} ${text} km`;

    // Actualización de tags en ambos dispositivos
    $(this.containers.mobile).find(`.m-filter-tags [data-${data}] .js-filter-tag-value`).text(tagText);
    $(this.containers.desktop).find(`.m-filter-tags [data-${data}] .js-filter-tag-value`).text(tagText);
  }



  // --------------------------------------------------------------------------------
  // 8.C removeTag -> Eliminar tags existentes y volver a filtrar
  // --------------------------------------------------------------------------------

  // controlTag -> parametro que se lanza para evitar acumulación en pila de llamadas (services)
  removeTag (data, value, controlTag) {
    const filter = this;

    // ----------------------------------------------------
    // Selectores que difieren en campos múltiples (service y rating)
    let dataSelector = $(`.filter-tag[data-${data}]`);
    if ( data === 'service' || data === 'rating' )
      dataSelector = $(`.filter-tag[data-${data}=${value}]`);


    // ----------------------------------------------------
    // Quitamos eventos y eliminamos tag (desktop & mobile)
    $(dataSelector).each(function (index, element) {
      $(element).find('.js-filter-tag-remove').off();
      $(element).remove();
      filter.loadingHotels(true);
    });


    // ----------------------------------------------------
    // Seteamos los atributos dependiendo del data
    switch (data) {

      // Actualizar precio
      case 'price':
        // Recuperamos el valor máximo del range de precio
        var newValue = $(this.containers.desktop).find('.js-filter-price')[0].noUiSlider.options.range.max;
        this.setRange([newValue], 'js-filter-price', true);
        break;

      // Actualizar atributo servicio y desactivar del filtro
      case 'service':
        if ( !controlTag ) {
          this.services.splice(this.services.indexOf(value), 1);
          $(this.containers.mobile).find(`[data-service=${value}]`).removeClass('is-active');
          $(this.containers.desktop).find(`[data-service=${value}]`).removeClass('is-active');
          this.filterHotels();
        }
        break;

      // Actualizar atributo ratings y desactivar del filtro
      case 'rating':
        if ( !controlTag ) {

          // Controlar si es valor sencillo o múltiple
          let ratingArray = value;
          if ( value === '4' ) ratingArray = ['4.0', '4.5'];
          else if ( value === '3' ) ratingArray = ['3.0', '3.5'];

          // Eliminar ratings
          const deleteIndex = val => {
            let index = this.ratings.indexOf(val);
            this.ratings.splice(index, 1);
          }

          // Eliminar valor sencillo o múltiple del atributo
          ( ratingArray.length > 1 )
            ? ratingArray.forEach(rating => deleteIndex(rating) )
            : deleteIndex(ratingArray);

          // Actualizar filtros y filtrar hoteles
          $(this.containers.mobile).find(`[data-rating=${value}]`).prop('checked', false);
          $(this.containers.desktop).find(`[data-rating=${value}]`).prop('checked', false);
          this.filterHotels();
        }
        break;

      // Actualizar location
      case 'location':
        // Solo si se invoca el borrar desde el cierre del tag (X)
        if ( !controlTag ) this.setLocation('invalid');

        // Si hay un tag de distancia, lo quitamos
        var tagDistance = $(this.containers.desktop).find('.m-filter-tags [data-distance]') ;
        if ( tagDistance ) $(tagDistance).find('.js-filter-tag-remove').trigger('click');
        break;

      // Actualizar distancia
      case 'distance':
        // Recuperamos el valor máximo del range
        var maxValue = $(this.containers.desktop).find('.js-filter-distance')[0].noUiSlider.options.range.max;
        this.setRange([maxValue], 'js-filter-distance', true);
        break;

      default:
        break;
    }
  }



  // --------------------------------------------------------------------------------
  // 9.A formatRange -> Función auxiliar que recoge el valor numérico de un string (p.e. '12 EUR')
  // --------------------------------------------------------------------------------
  formatRange (rangeValue, filter) {
    if ( !filter ) rangeValue = rangeValue[0];
    let splitRange = rangeValue.split(' ');
    return parseInt(splitRange[0]);
  }



  // --------------------------------------------------------------------------------
  // 9.B loadingHotels -> Deshabilita los filtros desktop hasta que termine todo el proceso
  // --------------------------------------------------------------------------------
  loadingHotels (isDisabled) {
    ( isDisabled )
      ? $(this.containers.desktop).addClass('is-disabled')
      : $(this.containers.desktop).removeClass('is-disabled');
  }


  // --------------------------------------------------------------------------------
  // 10. Reset -> Reiniciar el filtro (p.e. cuando se busca otra ciudad)
  // --------------------------------------------------------------------------------
  reset (page) {
    // Atributos generales de la página
    this.page = page; // clase descriptiva del main de la página
    this.containers = { mobile: null, desktop: null, result: null };
    this.cont = 0; // contador de hoteles mostrados

    // Atributos de ordenación
    this.sortedBy = null;
    this.groups = [];

    // Atributos moneda
    this.currency = { origin: 'EUR', selected: 'EUR', aux: null };
    this.currencyConversions = []; // array de conversiones con euro de origen

    // Atributos de formulario del filtro
    this.price = null;
    this.services = [];
    this.nearTo = { location: { value: null, text: null }, distance: null };
    this.locationCenter = { value: null, text: null};
    this.ratings = [];

    // Geolocalización solo para móviles
    this.geolocation = { latitude: null, longitude: null };
    this.showPois = [];
  }
}

const pHotelPage = function () {
  let pHotelView = null;
  let modalTimeout = null;

  let $bookingModalTrigger = null;
  /**
   * @description - init module
   */
  function init(view) {
    pHotelView = view;

    $bookingModalTrigger = pHotelView.find(".m-book-now [data-target='#modal-hotel-booking']").eq(0);

    // BUSQUEDA DE FECHAS GUARDADAS
    lastSearch.setLastSearch().then(function () {
      console.log("datos search")
      console.log(lastSearch)
      // Si la ultima busqueda no contiene total adultos, no hay nada guardado y hacemos modal
      $buttons = $(".m-book-now .btn");
      if ((lastSearch.numTotalAdults == "" || lastSearch.numTotalAdults == null)) {
        $buttons.each(function (index) {
          $(this).text($(".btn-secondary-invert").data("title-check"))
        });
        _getHotelSelectedData();
      } else {
        $buttons.on("click", function (event) {
          event.preventDefault();
          event.stopPropagation();
          _sendForm(this);
        });
      }
    }, function (error) {     
      _getHotelSelectedData();
    });
  }

  /*******************/
  /* PRIVATE METHODS */
  /*******************/



  function _sendForm(button) {

    // basadoe en el mobile
    // C:\dev\old_code\nh-mobile\systemMobile\WebContent\nhGroup\js\ey\critical\helpers\search-data.js
    /*
    <button class="btn btn-secondary-invert" 
    data-toggle="modal" 
    data-target="#modal-hotel-booking"
     data-locality="Barcelona, Spain" 
     data-location-url="/hotel/nh-collection-barcelona-gran-hotel-calderon" 
     data-location-vh="false" 
     data-location-tcm="tcm:41-9195" 
     data-name="NH Collection Barcelona Gran Hotel Calderón" 
     data-typesearch="hotel" data-location-code="ESBA.CALDE" 
     data-pcode="" data-value="NH Collection Barcelona Gran Hotel Calderón, Barcelona, Spain" 
     type="button" data-title-check="Check Availability">
    
    // ejemplo de envio
    https://m.cppreas.nh-hotels.com/booking/step1-rates?
    fini=01/12/2019&fout=02/12/2019&idioma=m-com&nadults1=2&nchilds1=0&nbabies1=0&hotelId=ESMD.PARLA&virtualHotel=false&urlHotel=https://m.cppreas.nh-hotels.com/hotel/nh-parla&tipoBuscador=Hotel%20Page&gvoucher=false
    */
    $modalSendReservationForm = $('#modal-hotel-booking').find('form');
    $btn = $(button);

    // Desactivamos campos que no necesitamos
    $modalSendReservationForm.find("input[name='searchStringID']").attr('disabled', 'disabled');
    $modalSendReservationForm.find("input[name='divisa']").attr('disabled', 'disabled');
    $modalSendReservationForm.find("input[name='occupancy']").attr('disabled', 'disabled');

    // Rellenamos los hidden
    let htmlTemplate = '';
    var campos = {
      'fini': lastSearch.fini,
      'fout': lastSearch.fout,
      'voucherCode': (lastSearch.promoCode != null) ? lastSearch.promoCode : "",
      'gvoucher': (lastSearch.gvoucher != null) ? lastSearch.gvoucher : "false",
      'hotelId': $btn.data("location-code"),
      'urlHotel': $btn.data("location-url"),
      'tcm': $btn.data("location-tcm"),
      'tipoBuscador': $btn.data("typesearch")
    };

    // campos hidden
    $.each(campos, function (key, value) {
      $field = $modalSendReservationForm.find("input[name=" + key + "]");
      $field.length ? $field.val(value) : htmlTemplate += ' <input type="hidden" name="' + key + '" value="' + value + '">'
    });

    // Creamos la ocupación guardada
    lastSearch.occupancy.forEach((element, index) => {
      htmlTemplate += ` <input type="hidden" name="nadults${index + 1}" value="${element["adults"]}">
                        <input type="hidden" name="nchilds${index + 1}" value="${element["children"]}">
                        <input type="hidden" name="nbabies${index + 1}" value="${element["babies"]}">`;
    });

    $modalSendReservationForm.append(htmlTemplate);

    // preparamos el envio
    var dataArray = $modalSendReservationForm.serializeArray(),  dataObj = {};
    $(dataArray).each(function (i, field) {
      dataObj[field.name] = field.value;
    });
    
    ruta =  Globals.subdomain + "/booking/step1-rates" + "?" + serialize(dataObj);
    window.location.href = ruta;
    return;
  }
  // función para serializar los input del form
  function serialize(obj) {
    var str = [];
    for (var p in obj)
      if (obj.hasOwnProperty(p)) {
        str.push(encodeURIComponent(p) + "=" + obj[p]);
      }
    return str.join("&");
  }


  function _getHotelSelectedData() {
    $(document).on("click", function () {
      if (modalTimeout) {
        clearTimeout(modalTimeout);
      }
    });

    let promise;
    promise = $.ajax({
      type: "GET",
      url: Globals.subdomain + '/rest/auto/autocomplete/' + $bookingModalTrigger.data("name"),
      dataType: "json",
      cache: true
    });

    promise.then(function (response) {
      var finalResponse = response[0][0];
      sessionStorage.setItem("listSearch", JSON.stringify(finalResponse));
      $bookingModalTrigger.data("selected", finalResponse);
      _initModalBookingCountDown();
    }, function (error) {
      console.log(error.Message);
    });
  }

  function _initModalBookingCountDown() {
    modalTimeout = setTimeout(function () {
      $bookingModalTrigger.trigger("click");
    }, 9000);
  }

  // Public API
  return {
    init: init
  };
}();

$(function () {
  if ($(".p-hotel").length) {
    pHotelPage.init($(".p-hotel"));
  }
});
const myPoints = (function(){

    function init(){

        $('.bar-graph').each(function(){

            const dataMax = $(this).attr('data-max-price');
            const barHeight = 150; // matches the height in css: div.my-points-container ul.bar-graph { height: 150px; }
            const paddingTop = 30; // matches div.my-points-container ul.bar-graph.upper li span::before { height: 30px }
            const reScale = (paddingTop/barHeight);

            $(this).find('.bar-container').each(function(){

                let dataHeight = $(this).attr('data-price');
                let barHeight = (dataHeight * 100) / dataMax;
                barHeight = (1 - reScale) * barHeight;

                $(this).css({
                  'height': `${barHeight}%`,
                });
            });
        });
        $('.bar-graph').parent().css({'opacity': 1});
  }

    return {
        init: init
  };
})();

$(function() {
    if ($('.bar-graph.upper').length){
        myPoints.init();
    }

});

/**
 * Arrival Module
 * @return {[type]} [description]
 */
var mDestinations = (function () {
  var $destinationsView = $(".mDestinations");
  var fields = null;
  const querys = {
    data: null,
    country: "$..CountryList[*].name",
    city: "",
    hotel: "",
    set queryCity(country) {
      this.city = `$..CountryList[?(@.name=='${country}')]..CityList[*].name`;
    },
    set queryHotel(city) {
      this.hotel = `$..CityList[?(@.name=='${city}')].HotelList[*].name`;
    }
  };

  /**
   * Init Fn
   * @return {[type]} [description]
   */
  function init(view) {
    $destinationsView = view;
    fields = {
      $country: $destinationsView.find("select.country"),
      $city: $destinationsView.find("select.city"),
      $hotel: $destinationsView.find("select.hotel")
    };

    fields = {
      country: {
        $field: $destinationsView.find("select.country"),
        get $wrapper() {
          return this.$field.parents(".form-group");
        }
      },
      city:{
        $field: $destinationsView.find("select.city"),
        get $wrapper() {
          return this.$field.parents(".form-group");
        }
      },
      hotel: {
        $field: $destinationsView.find("select.hotel"),
        get $wrapper() {
          return this.$field.parents(".form-group");
        }
      }
    };

    //if(fields.$country.length) {
    if(fields.country.$field.length) {
      _initializeCountries();
    }

    fields.country.$field.on("change", function() {
      var value = $(this).val().replace(/_/g," ");
      querys.queryCity = value;
      _initializeCities();

      fields.hotel.$field.find('option').remove();
      fields.hotel.$field.selectpicker("refresh");

      //fields.$city.trigger("change");

      //fields.$hotel.find('option').remove();
      //fields.$hotel.selectpicker("refresh").trigger("change");
    });

    fields.city.$field.on("change", function() {
      var value = $(this).val().replace(/_/g," ");
      querys.queryHotel = value;
      if(value) {
        _initializeHotels();
      }
    });
  }

  function _initializeCountries() {
    var promise = $.getJSON('/resources/jsonDestinations.txt');
    var countryData = {
      $field: fields.country.$field,
      $wrapper: fields.country.$wrapper,
      query: querys.country,
      data: querys.data
    };
    

    promise.then((response) => {
      querys.data = response;
      countryData.data = response;
      _generateSelect(countryData);
    });
  }

  function _initializeCities() {
    var cityData = {
      $field: fields.city.$field,
      $wrapper: fields.city.$wrapper,
      query: querys.city,
      data: querys.data
    };
    _generateSelect(cityData);
  }

  function _initializeHotels() {
    var hotelData = {
      $field: fields.hotel.$field,
      $wrapper: fields.hotel.$wrapper,
      query: querys.hotel,
      data: querys.data
    };
    _generateSelect(hotelData);
  }

  function _generateSelect(selectData) {
    var optionValue = null;
    var optionsValues = jsonPath(selectData.data, selectData.query).sort(
      function (a, b) {
        var aName = utils.removeDiacritics(a.toLowerCase());
        var bName = utils.removeDiacritics(b.toLowerCase()); 
        return ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));
      }
    );

    selectData.$wrapper.removeClass("has-error has-success has-danger");

    selectData.$field.find('option').remove().append('<option value="">');
    $.each(optionsValues, function(index , value){
      optionValue = value.replace(/\s+/g,"_");
      selectData.$field.append(`<option value="${optionValue}">${value}</option>`);
    });
    //refresh selectpicker
    selectData.$field.prop('disabled', false).selectpicker("refresh");
  }

  // Public API
  return {
    init: init
  };  

})();

$(function() {
  if($('.mDestinations').length) {
    mDestinations.init($(".mDestinations"));
  }
});

const landingServices = (function() {
  
  
  function callTrustYouReviews() {

  }
  function callTripAdvisorReviews() {

  }

  function getLastSearch() {
    var extendLastSearch = {
      voucherCode: globalConfig.urlParameters.voucherCode,
      selectedDivisa: globalConfig.urlParameters.divisa,
      groupon: globalConfig.urlParameters.gvoucher === "false" ? false : true,
      isPOI: globalConfig.urlParameters.poiId,
      pcode: globalConfig.urlParameters.pcode,
      b2b: globalConfig.urlParameters.b2b,
      b2bData: null,
      contracts: [ "NHWEB" ],
      rates: null,
      searchLandingExpress: null,
      isB2EEmployee: null,
      isB2EFamily: null,
      filterStars: null,
      filterServices: null,
      isPromo: false
    };

    //url: "https://www.nh-hotels.com/booking/ajax/landing/getFlowInformation.html",
    var promise = $.ajax({
      type: "GET",
      url: "/booking/ajax/landing/getFlowInformation.html",
      headers: {
          Accept: "application/json",
          "Content-Type": "application/json"
      },
      dataType: "json",
      cache: false,
      async: false
    });

    $.extend(lastSearch, extendLastSearch);
    selectedDivisa = lastSearch.selectedDivisa ? lastSearch.selectedDivisa : "";
    
    if (lastSearch.b2b) {
      lastSearch.b2BData = {
        branch: globalConfig.urlParameters["b2bData.branch"],
        branchId: globalConfig.urlParameters["b2bData.branchId"],
        company: globalConfig.urlParameters["b2bData.company"],
        customer: globalConfig.urlParameters["b2bData.customer"],
        partyIdCompany: globalConfig.urlParameters["b2bData.partyIdCompany"],
        partyIdCustomer: globalConfig.urlParameters["b2bData.partyIdCustomer"],
        bpc: globalConfig.urlParameters["b2bData.bpc"],
        favouriteHotels: globalConfig.urlParameters["b2bData.favouriteHotels"],
        frequentHotels: globalConfig.urlParameters["b2bData.frequentHotels"],
        username: globalConfig.urlParameters["b2bData.username"],
        ccgType: globalConfig.urlParameters["b2bData.ccgType"],
        type: globalConfig.urlParameters["b2bData.type"]
      };
    }
    //EY arobles: Fill vouchercode box if informed
    if (lastSearch.voucherCode){
        if($(".m-search-bar").length) {
           showVoucherCode($(".m-search-bar"));
        }
        if ($("#modal-hotel-booking").length) {
            showVoucherCode($("#modal-hotel-booking"));
        }
    }
    return promise.then(function(response) {
      if (typeof response !== "undefined" && response) {
        if (response.displayBean) {
          lastSearch.contracts = (response.displayBean.contracts) ? response.displayBean.contracts : lastSearch.contracts;
          lastSearch.searchLandingExpress = (response.displayBean.isSearchLandingExpress !== '') ? response.displayBean.isSearchLandingExpress : lastSearch.searchLandingExpress;
          lastSearch.isB2EEmployee = (response.displayBean.isB2EEmployee !== '') ? $.parseJSON(response.displayBean.isB2EEmployee) : lastSearch.isB2EEmployee;
          lastSearch.isB2EFamily = (response.displayBean.isB2EFamily !== '') ? $.parseJSON(response.displayBean.isB2EFamily) : lastSearch.isB2EFamily;
        }

        if (response.backingBean) {
          lastSearch.rates = (response.backingBean.ratePlansPromo) ? response.backingBean.ratePlansPromo : lastSearch.rates;
          lastSearch.tipoBuscador = (response.backingBean.tipoBuscador) ? response.backingBean.tipoBuscador : ""
        
          utag_data.search.loc =  lastSearch.tipoBuscador;
          utag_data.search.keyword = pageData.destino + "," + pageData.pais;
        }       
        
      }
    }, function(error) {
      console.log("Fail call getFlowInformation: ", error.status, error.responseText);
    }).always(function() {
      LandingUtag.init();
      _fillLazyDataAndLastSearchData();
    });
  }

    //EY
    function showVoucherCode($searchBox){
        $searchBox.find(".voucher-code").find("input").val(lastSearch.voucherCode);
        $searchBox.find(".voucher-code").find(".labelup-control").addClass("focus");
    }

  function callLoading() {

  }

  function getNoPromoUrl() {
    var pcodeParam = window.location.search.match(/pcode\=([0-9]+)/i);
    var current = window.location.href;
    return pcodeParam ? current.replace(pcodeParam[0], "") : null;
  }




  /*******************/
  /* PRIVATE METHODS */
  /*******************/

  function _fillLazyDataAndLastSearchData() {
    var deferred = $.Deferred();
    lazyDataSend.fini = lastSearch.fini || null;
    lazyDataSend.fout = lastSearch.fout || null;
    lazyDataSend.voucherCode = lastSearch.voucherCode || null;
    lazyDataSend.pCode = lastSearch.pcode || null;
    lazyDataSend.b2b = lastSearch.b2b || null;
    lazyDataSend.roomRequest = [];
    lazyDataSend.b2BData = lastSearch.b2BData || null;
    lazyDataSend.destinationtype = "destination";
    lazyDataSend.contracts = lastSearch.contracts;
    lazyDataSend.rates = lastSearch.rates;
    lazyDataSend.searchLandingExpress = lastSearch.searchLandingExpress;
    lazyDataSend.b2eEmployee = lastSearch.isB2EEmployee || null;
    lazyDataSend.b2eFriends = lastSearch.isB2EFamily || null;
    lastSearch.isPromo = lastSearch.pcode ? true : false;

    if (!$.isEmptyObject(lastSearch.occupancy)) {
      lastSearch.numTotalAdults = 0;
      lastSearch.numTotalChildren = 0;
      lastSearch.numTotalBabies = 0;
      $.each(lastSearch.occupancy, function(i, room) {
        var lazyRoomItem = {
            numberOfAdults: room.adults,
            numberOfChildren: room.children,
            numberOfBabies: room.babies
        };
        lazyDataSend.roomRequest.push(lazyRoomItem);
        lastSearch.numTotalAdults += parseInt(room.adults);
        lastSearch.numTotalChildren += parseInt(room.children);
        lastSearch.numTotalBabies += parseInt(room.babies);
      });
    }
    //$(document).trigger( "ls.getLastSearchEnd");    
    return deferred.resolve();
  }

  return {
    callTrustYouReviews: callTrustYouReviews,
    callTripAdvisorReviews: callTripAdvisorReviews,
    getLastSearch: getLastSearch,
    callLoading: callLoading,
    getNoPromoUrl: getNoPromoUrl
};
})();
const mResultsHotelCards = (function () {
  let $resultsView = null;
  let messageModals = null;
  let hotelLists = null;
  let $bookingModal = null;
  let $bookingModalTrigger = null;
  let availableHotels = null;
  let noPromoUrl = null;
  let $togglemapBtns = null;
  let $mapWrapper = null;
  let $hotelListWrapper = null;
  let Filter = null;
  let maxPrice = 0;
  let maxDistance = null;

  let hotelsData = null;

  function init(view, filter) {
    $resultsView = view;
    Filter = filter;
    $bookingModal = $resultsView.find("#modal-hotel-booking");
    $bookingModalTrigger = $resultsView.find(".single-banner [data-target='#modal-hotel-booking']");
    $togglemapBtns = $resultsView.find(".toggleMap");
    $mapWrapper = $resultsView.find(".m-hotel-map.inline-map");
    $hotelListWrapper = $resultsView.find(".m-hotel-list ");
    messageModals = {
      modals: {
        $error: $resultsView.find("#modal-error"),
        $success: $resultsView.find("#modal-success"),
        $loading: $resultsView.find("#loading-modal-results"),
      },
      messages: {
        "errorJava": "Ha ocurrido un error, consulte con su administrador"
      }
    };

    hotelsData = {
      $view: $resultsView.find(".m-hotel-search"),
      get $hotels() {
        return this.$view.find(".m-hotel-box");
      },
      get $availablePromoHotels() {
        return this.lists.$availablePromo.find(".m-hotel-box");
      },
      get $nearbyPromoHotels() {
        return this.lists.$nearbyPromo.find(".m-hotel-box");
      },
      get $availableHotels() {
        return this.lists.$available.find(".m-hotel-box");
      },
      get $nearbyHotels() {
        return this.lists.$nearby.find(".m-hotel-box");
      },
      get $notAvailableHotels() {
        return this.lists.$notAvailable.find(".m-hotel-box");
      },
      get $notAvailableNearbyHotels() {
        return this.lists.$notAvailableNearby.find(".m-hotel-box");
      },
      lists: {
        get $availablePromo() {
          return hotelsData.$view.find('[data-hotels-group="promo"]');
        },
        get $nearbyPromo() {
          return hotelsData.$view.find('[data-hotels-group="promo-near"]');
        },
        get $available() {
          return hotelsData.$view.find('[data-hotels-group="stock"]');
        },
        get $nearby() {
          return hotelsData.$view.find('[data-hotels-group="stock-near"]');
        },
        get $notAvailable() {
          return hotelsData.$view.find('[data-hotels-group="no-stock"]');
        },
        get $notAvailableNearby() {
          return hotelsData.$view.find('[data-hotels-group="no-stock-near"]');
        }
      }
    };

    if (typeof pageData.javaError !== "undefined" && pageData.javaError === "true") {
      _showJavaError();
      return;
    }

    $resultsView.on("setHotelsDone", function (ev, type) {
      $(this).addClass(`loaded ${type}`);
    });

    hotelsData.$view.on('filterHotelsDone', function () {
      var visibleHotels = Filter.getShowPois();
      mHotelMapInline.toggleMarkers(visibleHotels);
    });

    if (utils.isValidDates()) {
      console.log("fechas validas");
      _initializePage();
    } else {
      _showError("bookingDatesError");
    }

    messageModals.modals.$error.on("hidden.bs.modal", function () {
      window.location.href = "/";
    });


    $togglemapBtns.on("click", _onClickToggleMap);

    /*groupResults["#hotelesDispo"] = 0;
    groupResults["#hotelesNoDispo"] = 0;
    groupResults["#hotelesNearby"] = 0;
    groupResults["#hotelesNearbyNoDispo"] = 0;
    groupResults["#hotelesDispoPromo"] = 0;
    groupResults["#hotelesNearbyPromo"] = 0;
    if (invalidDates()) {
        noAvailabilityPageActions();
        $sv.showErrorLighbox(pageData.tcmDatesError);
    } else {
        $sv.getLastSearch(function(search) {
            console.log("lastSearch:", search);
            fillLastSearch();
            callLazyAjax();
            $sv.callTripAdvisorReviews();
            $sv.callTrustYouReviews();
            $sv.callLoading();
        });
    }*/
  }
  /*******************/
  /* PRIVATE METHODS */
  /*******************/

  function _initializeFilterRange() {
    var data = {
      pois: [],
      poisData: [],
      hotelPois: null,
      maxRange: 0
    };
    var filtros = {
      "rooms": { maxRange: 0 },
      "meetingrooms": { maxRange: 0 },
      "capacity": { maxRange: 0 },
      "distance": data
    };
    $.each($(".m-hotel-box"), function (index, hotel) {
      var $hotel = $(hotel);
      Object.keys(filtros).map(function (objectKey, index) {

        
        var filterValue = filtros[objectKey]["maxRange"];
        if (objectKey != "distance") {
          var dataValue = $hotel.data(objectKey);
          if (dataValue != "undefined" && dataValue > filterValue) {
            filtros[objectKey]["maxRange"] = dataValue
          }
        } else {         
          data.hotelPois = $hotel.data("pois");
          _setAvailablePois(data);
        }
      });
    });

    Filter.initSelectLocation(data.poisData);

    Object.keys(filtros).map(function (objectKey, index) {
      Filter.maxRange(objectKey, filtros[objectKey]["maxRange"]);
    });
  }


  function _initializePoiFilter() {
    var data = {
      pois: [],
      poisData: [],
      hotelPois: null,
      maxRange: 0
    };
    $.each(hotelsData.$hotels, function (index, hotel) {
      var $hotel = $(hotel);
      data.hotelPois = $hotel.data("pois");
      _setAvailablePois(data);
    });

    Filter.initSelectLocation(data.poisData);
    Filter.maxRange('distance', data.maxRange);

    /*let selectPois = [
      { text: 'Sol (City center)', value: 'sol_city_center', isCenter: true },
      { text: 'Madrid airport', value: 'madrid_airport', isCenter: false },
      { text: 'Parla', value: 'parla', isCenter: false }
      ];
      Filter.initSelectLocation(selectPois);*/
  }

  function _setAvailablePois(data) {
    var distance;
    data.hotelPois.map(function (obj) {
      distance = Math.round(obj.distance) + 1;
      if (data.pois.indexOf(obj.value) < 0) {
        data.pois.push(obj.value);
        data.poisData.push({
          text: obj.location,
          value: obj.value,
          isCenter: obj.isCityCenter
        });
      }
      if (distance > data.maxRange) {
        data.maxRange = distance;
      }
    });
  }

  /**
   * @description - Handle the click over the toggleMaps buttons
   */
  function _onClickToggleMap() {
    var $this = $(this);
    var isActive = !$this.hasClass("collapsed");
    /*var data = {
      currentText: null,
      nextText: null,
      text: null,
      regex: null
    };

    if(isActive) {
      data.currentText = $this.data("text-list");
      data.nextText = $this.data("text-map");
    } else {
      data.currentText = $this.data("text-map");
      data.nextText = $this.data("text-list");
    }

    data.regex = new RegExp(data.currentText,"g");*/
    $mapWrapper.toggle(!isActive);
    //$hotelListWrapper.toggle(isActive);
    //_setToogleMapsText(data);
    _setToogleMapsText();
  }

  /**
   * @description - set the text of the toggleMaps buttons
   * @param {object} data - the data with the new text
   */
  function _setToogleMapsText(data) {
    //var text;
    $.each($togglemapBtns, function (index, elem) {
      var $this = $(elem);
      //text = $this.html().replace(data.regex, data.nextText);
      $this.toggleClass("collapsed");
      //.html(text);
    });
  }

  function _initializePage() {
    if (typeof bookingUtag !== "undefined") {
      console.log("inicializamos booking utag ");
      bookingUtag.init();
    }
    // Ey, lo desactivamos para Meetings al no haber get param
    if ($("main.me").length) {
      _initializeFilterRange();
      _setHotelsInfo();
      $("main").addClass("loaded");      
    } else {
      landingServices.getLastSearch().then(function () {
        servicios();
      }, function () {
        console.log("Falla el getflowinformation, añadir desenlace");
        servicios();
      });
    }

    function servicios(){
     
      _fillLastSearch();
      _getAvailableHotelsData();
      _initializePoiFilter();
      _setHotelsInfo();

      var availableRatings = [];
      utils.initTipAdvisorWidgets().then(function (response) {
        availableRatings = _getAvailableRatings(response);
        Filter.showRating(availableRatings);
      }, function (error) {
        console.log("error trip", error);
        Filter.showRating(availableRatings);
      });
    }
  }
    
  function _setHotelsInfo() {
    $.each(hotelsData.lists, function (index, list) {
      list.on("setHotelDone", function () {
        var $this = $(this);
        $this.toggle($this.find(".m-hotel-box").length > 0);
      });
    });

    $.each(hotelsData.$hotels, function (index, hotel) {
      var $hotel = $(hotel);
      var $btn = $hotel.find(".check-availability");
      if (lastSearch.voucherCode) {
        $btn.data("voucherCode", lastSearch.voucherCode).attr("data-voucherCode", lastSearch.voucherCode);
      }
    });
  }

  function _getAvailableRatings(ratings) {
    var availableRatings = [];
    var rating;
    for (let x = 0; x < ratings.length; x++) {
      rating = Math.floor(ratings[x].rate);
      if (availableRatings.indexOf(rating) < 0) {
        availableRatings.push(rating);
      }
    }
    return availableRatings;
  }

  function _fillLastSearch() {
    var finiOutput = null;
    var foutOutput = null;
    if (!$.isEmptyObject(lastSearch)) {
      if (lastSearch.fini && lastSearch.fout) {
        finiOutput = lastSearch.fini;
        foutOutput = lastSearch.fout;

        if (typeof Dates != "undefined" && Dates.isChinese) {
          finiOutput = moment(lastSearch.fini, Dates.pattern).format(Dates.patternCn);
          foutOutput = moment(lastSearch.fout, Dates.pattern).format(Dates.patternCn);
        }

        lastSearch.finiParsed = finiOutput;
        lastSearch.foutParsed = foutOutput;


        //TODO:
        //rellenamos los campos de la modal del buscador.
        //hay que modificar el reservation-occupancy para que se inicialize bien;
        /*$bookingModalTrigger.data({
          'startDate': finiOutput,
          'endDate': foutOutput,
          'locationCode': pageData.keySearch,
        });*/


        pageData.filterStars = lastSearch.filterStars;
        pageData.filterServices = lastSearch.filterServices;
      }
    }
  }

  function _getAvailableHotelsData() {
    var url;
    var promise;
    if (lazyDataSend && !$.isEmptyObject(lazyDataSend.hotels) && pageData.destinoCode && JSON.stringify(lazyDataSend)) {
      /**SOLO PARA DESARROLLO */
      /*url = lastSearch.isPromo ? "mocks/landing-avail-promo.json" : "mocks/landing-avail.json";
      promise = $.ajax({
        type: "GET", //cambiar a post en live
        url: urlGlobalConfig.domain + url, //poner url correcta
        headers: {
            Accept: "application/json",
            "Content-Type": "application/json"
        },
        data: JSON.stringify(lazyDataSend),
        dataType: "json",
        cache: false
      });*/
      /** SOLO PARA DESAROLLO */
      /** SOLO PARA PRODUCCIÓN ***/
      promise = $.ajax({
        type: "POST",
        url: "/rest/landing/avail/" + pageData.destinoCode,
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json"
        },
        data: JSON.stringify(lazyDataSend),
        dataType: "json",
        cache: false
      });
      /** SOLO PARA PRODUCCIÓN ***/

      promise.then(function (response) {
        try {
          if (!$.isEmptyObject(response)) {
            availableHotels = response;
            pageData.availData = true;
            _setAvailableHotelsData();
          } else {
            pageData.availData = false;
            _setHotelsAsNoAvailables();
            console.log("resturn Ajax: No Availability page");
            //noAvailabilityPageActions();
          }
        } catch (error) {
          console.log("Ajax done but error: ", error);
          _showError("tcmInternalError");
        }

      }, function (error) {
        try {
          var responseParsed = JSON.parse(error.responseText);
          console.log("Fail call: ", error.status, error.responseText, typeof error.responseText);
          if (typeof responseParsed === "object" && responseParsed.message) {
            _showError(null, responseParsed.message);
          } else {
            _showError("tcmInternalError");
          }
        } catch (error) {
          console.log("Ajax fail but error on the code: ", error);
          _showError("tcmInternalError");
        }
      });
    } else {
      if (!pageData.withDates) {
        console.log("Landing without dates");
        _setPageAsNoDates();
      } else {
        console.log("Error: There is no hotels to send");
        _showError("tcmInternalError");
      }
    }
  }

  function _setPageAsNoDates() {
    //$resultsView.trigger("setHotelsDone", "noDates");
    $.each(hotelsData.$hotels, function (index, hotel) {
      var $hotel = $(hotel);
      _setupHotelMarker($hotel);
    });

    _pageInitActions();
  }

  function _setHotelsAsNoAvailables() {
    //LandingPage.isNoAvailabilityPage = true;
    var hotelGroups = hotelsData.lists.$available.find(".m-hotel-box").add(hotelsData.lists.$nearby.find(".m-hotel-box"));
    $.each(hotelGroups, function (index, hotel) {
      var $hotel = $(hotel);
      var hotelElements = {
        $hotel: $hotel,
        $btn: $hotel.find(".btn-loader"),
        $availableData: $hotel.find(".availableData"),
        $noAvailableData: $hotel.find(".noAvailableData")
      };
      setNoAvailabilityHotel(hotelElements);
    });

    _pageInitActions();

    //$(document).trigger("noAvailableHotelsDone");
    //hotelsData.lists.$notAvailable.add(hotelsData.lists.$notAvailableNearby).trigger("noAvailableHotelsDone");



    //TODO: modificamos los filtros
    /*$('#selectSort option[value="precioAsc"]').remove();
    $('#selectSort option[value="precioDes"]').remove();
    $("#selectSort").selectpicker("refresh");
    $(".filters .prices").hide();*/
    //pageInitActions();
  }

  function _setAvailableHotelsData() {
    var hotelGroups = null;
    if (availableHotels) {
      hotelGroups = hotelsData.lists.$available.find(".m-hotel-box").add(hotelsData.lists.$nearby.find(".m-hotel-box"));
      if (lastSearch.isPromo) {
        noPromoUrl = landingServices.getNoPromoUrl();
      }

      $.each(hotelGroups, function (index, hotel) {
        var $hotel = $(hotel);
        _setHotelData($hotel);
      });

      //inicializamos el filtro de precio
      Filter.maxRange('price', maxPrice + 1);

      //hotelsData.lists.$available.trigger("availableHotelsDone");
      $.each(hotelsData.lists, function (index, list) {
        list.trigger("setHotelDone");
      });

      _pageInitActions();
      // EY RECARGO LO PINES DEL MAPA            
      mHotelMapInline.init($(".m-hotel-map.inline-map .hotel-map"));
    }
  }

  function _pageInitActions() {
    // var availClass = (pageData.availData) ? " avail" : " no-avail";
    var availClass = (pageData.availData) ? " avail" : "";
    var dateClass = (pageData.withDates) ? " withDates" : " withoutDates";
    var promoClass = "";
    var servarDayClass = (lastSearch.numNights > 1) ? " severalDays" : "";
    if (lastSearch.isPromo) {
      promoClass = " promo";
      hotelsData.lists.$nearby.remove();
      hotelsData.lists.$notAvailableNearby.remove();
    }

    // Asegurarse de que se ocultan los grupos vacios de hoteles
    $.each(hotelsData.lists, function (index, hotelGroup) {
      let visibleHotels = hotelGroup.find('.m-hotel-box').not('is-hidden').length;
      (visibleHotels > 0) ? hotelGroup.show() : hotelGroup.hide();
    });

    $resultsView.trigger("setHotelsDone", [`${availClass}${dateClass}${promoClass}${servarDayClass}`, hotelsData]);

    _setLazyAnalyticsData();

  }

  function _setLazyAnalyticsData() {
    var $hotel;
    var $hotelsWrapper;
    var availInfo;
    var noAvailableData = (hotelsData.$availableHotels.length <= 0 && hotelsData.$nearbyHotels.length <= 0);

    console.log("hoteles disponibles", hotelsData.$availableHotels);

    if (typeof utag_data !== "undefined") {
      $.each(hotelsData.$hotels, function (index, hotel) {
        $hotel = $(hotel);
        $hotelsWrapper = $hotel.parents(".m-hotel-list ");
        availInfo = ($hotelsWrapper.data("hotels-group").indexOf("no-stock") >= 0) ? "-no available" : "-available";
        utag_data.busqListado += `${utag_data.busqListado ? "," : ""}${$hotel.data("backcode")}${availInfo}`;
        utag_data.busqHSinDispo = (hotelsData.$notAvailableHotels.length === 0) ? "" : hotelsData.$notAvailableHotels.length + "";
        utag_data.busqSinDispo = noAvailableData ? "No availability" : "";
        utag_data.search.hotelsList += `${utag_data.search.hotelsList ? "," : ""}${$hotel.data("backcode")}${availInfo}`;
        utag_data.search.results = pageData.totalHotels;
        utag_data.search.hWithoutAvailability = utag_data.busqHSinDispo;
        utag_data.search.withoutAvailability = utag_data.busqSinDispo;

        if ($hotel.find("[data-preciodia]").length > 0) {
          var precioDia = $hotel.data("price-night");
          if (parseFloat(precioDia)) {
            utag_data.products_price.push(parseFloat(precioDia).toFixed(2));
          } else {
            utag_data.products_price.push("no-avail");
          }
        }
      });

      trackData.sendUtagData();
    }
  }

  function _setHotelData($hotel) {
    var backcode = $hotel.data("backcode");
    var hotelData = null;
    //var capacityLabel = null;
    var price = null;
    var hotelElements = {
      $hotel: $hotel,
      $priceNightWrapper: $hotel.find(".night"),
      $priceNight: $hotel.find(".night-amount"),
      $price: $hotel.find(".totalPrice"),
      $currency: $hotel.find(".currency"),
      $meanplan: $hotel.find(".meanplan"),
      $roomname: $hotel.find(".roomtype"),
      $capacity: $hotel.find(".roomcapacity"),
      $btn: $hotel.find(".btn"),
      $form: $hotel.find("form"),
      $availableData: $hotel.find(".availableData"),
      $noAvailableData: $hotel.find(".noAvailableData"),
      $loading: $hotel.find(".m-hotel-box-loading"),
      $info: $hotel.find(".m-hotel-box-info-actions"),
      $moreInfo: $hotel.find(".m-hotel-box-show"),
      $features: $hotel.find(".features"),
      get $priceCurrency() {
        return this.$price.siblings(".currency");
      }
    };

    if (availableHotels[backcode]) {

      hotelData = availableHotels[backcode];
      hotelData.available = true;
      hotelData.$hotel = $hotel;
      price = Math.round(hotelData.price.priceTotal);

      if (hotelData.price) {
        actualDivisa = hotelData.currency || "EUR";
      }
      //if(hotelData.roomCapacity) {
      //capacityLabel = hotelElements.$capacity.data("capacity");
      //hotelElements.$capacity.find(".capacity").html(`${hotelData.roomCapacity} ${(hotelData.roomCapacity ===1) ? capacityLabel.singular : capacityLabel.plural}`);
      //hotelElements.$capacity.show();
      //}

      hotelElements.$priceNight.html(hotelData.price.pricePerDay); //elemento que contiene el precio por noche
      hotelElements.$price.html(hotelData.price.priceTotal); //elemento que contiene el precio total
      hotelElements.$currency.html(hotelData.price.currency); //elemento que contiene el tipo de moneda EUR,...
      hotelElements.$meanplan.html(hotelData.mealRatePlanTitle); //elemento que contiene tipo de servicio "Room only", "Breakfast included",...
      hotelElements.$roomname.html(hotelData.roomTitle);//elemento que contiene el tipo de habitación "Family room", "Superior Room"...
      hotelElements.$form.on("submit", { hotelData: hotelData }, function (ev) {
        //EY arobles: fix error. Add .modal to where the modal is storaged
        messageModals.modals.$loading.modal({
          show: true,
          backdrop: "static",
          keyboard: false
        });
      });

      if (hotelData.promo) {
        _setPromoHotel(hotelElements);
      } else {
        if (lastSearch.isPromo && noPromoUrl) {
          hotelElements.$form.attr("action", noPromoUrl);
        }
      }

      //set filter values
      hotelElements.$hotel.data("price", hotelData.price.priceTotal).attr("data-price", hotelData.price.priceTotal);
      hotelElements.$hotel.data("price-night", hotelData.price.pricePerDay).attr("price-night", hotelData.price.pricePerDay);
      hotelElements.$hotel.data("euro", hotelData.price.priceTotal).attr("data-euro", hotelData.price.priceTotal);
      hotelElements.$hotel.data("currency", hotelData.price.currency).attr("data-currency", hotelData.price.currency);
      maxPrice = (price > maxPrice) ? price : maxPrice;
      _setupHotelMarker($hotel, hotelData);
    } else {
      setNoAvailabilityHotel(hotelElements);
    }

    if (lastSearch.groupon) {
      hotelElements.$features.hide();
      hotelElements.$priceCurrency.hide();
      hotelElements.$price.hide();
    }
  }

  function _setupHotelMarker($hotel, hotelData) {
    var markerIndex = $hotel.data("recommend");
    var markers = MapsData.data[0];
    var marker = markers[markerIndex];
    var regex;
    var hotelIconsType = (hotelData && hotelData.available) ? Pines.hotel : Pines.hotelNoDispo;

    if (marker) {

      if (hotelData) {

        if (hotelData.price.priceTotal && !hotelData.price.pricePerDay) {
          hotelData.price.pricePerDay = hotelData.price.priceTotal;
        } else if (!hotelData.price.priceTotal && hotelData.price.pricePerDay) {
          hotelData.price.priceTotal = hotelData.price.pricePerDay;
        }
      }

      regex = /{{([priceTotal}]+)\}}/;
      if (hotelData && hotelData.price.priceTotal) {
        marker.info = marker.info.replace(regex, `${hotelData.price.priceTotal} ${hotelData.price.currency}`);
      } else {
        marker.info = marker.info.replace(regex, "");
        marker.info = marker.info.replace(/class="price-total"/, 'class="price-total hidden"');
      }

      //seteamos precio por día si lo tiene
      regex = /{{([priceDay}]+)\}}/;
      if (hotelData && hotelData.price.pricePerDay && hotelData.price.pricePerDay !== hotelData.price.priceTotal) {
        marker.info = marker.info.replace(regex, `${hotelData.price.pricePerDay} ${hotelData.price.currency}`);
      } else {
        marker.info = marker.info.replace(regex, "");
        marker.info = marker.info.replace(/class="price-day"/, 'class="price-day hidden"');

      }

      if (lastSearch.groupon) {
        marker.info = marker.info.replace(/class="price-total"/, 'class="price-total hidden"');
      }

      if (lastSearch.numNights <= 1) {
        marker.info = marker.info.replace(/class="price-day"/, 'class="price-day hidden"');
      }

      //ponemos como icono del poi el icono disponible
      marker.icon = (hotelIconsType[marker.iconKey]) ? hotelIconsType[marker.iconKey] : marker.icon;
    }

  }

  function _setPromoHotel(hotelElements) {
    var $hotelsGroup = (hotelElements.$hotel.data("group") === "nearby") ? hotelsData.lists.$nearbyPromo : hotelsData.lists.$availablePromo;
    var $hotelDetached = hotelElements.$hotel.detach();
    $hotelsGroup.append($hotelDetached);
    if ($hotelsGroup.is(":hidden")) {
      $hotelsGroup.show();
    }
  }

  function setNoAvailabilityHotel(hotelElements) {
    var $hotelDetached;
    var $hotelsGroup = (hotelElements.$hotel.data("group") === "nearby") ? hotelsData.lists.$notAvailableNearby : hotelsData.lists.$notAvailable;
    hotelElements.$noAvailableData.show();
    hotelElements.$availableData.hide();
    if (!hotelElements.$hotel.data("virtual")) {
      $hotelDetached = hotelElements.$hotel.detach();
      $hotelsGroup.append($hotelDetached);
    }

    _setupHotelMarker(hotelElements.$hotel);
  }


  function _showError(msgType, message) {
    if (msgType && Labels[msgType]) {
      messageModals.modals.$error.find(".symbol-text p").text(Labels[msgType]);
    } else if (message) {
      messageModals.modals.$error.find(".symbol-text p").text(message);
    }
    messageModals.modals.$error.modal("show");
  }
  /**
   * @description - show modal with a error message related with java code
   */
  function _showJavaError() {
    messageModals.modals.$error.find(".symbol-text p").text(Labels.javaError);
    if (pageData.urlError && typeof pageData.urlError !== "undefined") {
      //Abro el modal sin posibilidad de cerrarlo. Solo se podrá hacer clic en el boton que redirigirá a la urlError
      messageModals.modals.$error.modal({
        backdrop: 'static',
        keyboard: true,
        show: true
      });
    } else {
      //abro modal de error normal
      messageModals.modals.$error.modal("show");
    }
  }

  return {
    init: init
  };
})();

/*$(function() {
  if ($('.p-results-page').length){
    mResultsHotelCards.init($('.p-results-page'));
  }
});*/

var mMESearchBar = (() => {
  var $mMESearchBarView = null;
  var $formData = null;
  var fieldSearchValueList = null;


  /**
   * Init Fn
   */
  function init(view) {
    $mMESearchBarView = view;
    $formData = {
      $form: $mMESearchBarView.find("#form_datos"),
      get $fieldSearch() {
        return this.$form.find("#fieldSearch");
      },
      get $meetingsNumber() {
        return this.$form.find("#nsalones");
      },
      get $assistansNumber() {
        return this.$form.find("#nasistentes");
      },
      get $roomsNumber() {
        return this.$form.find("#nhabitaciones");
      },
      get $eventType() {
        return this.$form.find("#eventType");
      },
      get $locationCode() {
        return this.$form.find("#locationCode");
      },
      get $searchStringID() {
        return $("input[name='searchStringID']");
      }
    };

    $formData.$form.validator({
      disable: false
    }).on('submit', function (e) {
      var $form = $(this);
      toggleLoadingButton($form, true);
      if (e.isDefaultPrevented()) {
        // Invalid Form
        toggleLoadingButton($form, false);
      } else {
        fieldSearchValueList = $formData.$fieldSearch.val().split(" ");
        if(typeof $formData.searchStringID != "undefined") $formData.searchStringID.val($formData.$fieldSearch.val());
        utils.callTrackForms("success", "miceHomeForm", "success");

        if ($formData.$locationCode.attr("name") === "") {
          $formData.$locationCode.attr("name", fieldSearchValueList[fieldSearchValueList.length - 1] + "Id");
        }

        if ($('main').hasClass("me-hotel-page")) {
          trackData.trackMiceSearchInResult(Globals.page_section, $formData.$fieldSearch.val(), $formData.$roomsNumber.val(), $formData.$assistansNumber.val(), $formData.$meetingsNumber.val(), $formData.$eventType.val());
        } else if ($('main').hasClass("p-results-page")) {
          trackData.trackMiceSearchInDestiny(Globals.page_section, $formData.$fieldSearch.val(), $formData.$fieldSearch.val(), $formData.$roomsNumber.val(), $formData.$assistansNumber.val(), $formData.$meetingsNumber.val(), $formData.$eventType.val());
        } else if ($('main').hasClass("p-me")) {
          trackData.trackMiceSearch(Globals.page_section, $formData.$fieldSearch.val(), $formData.$roomsNumber.val(), $formData.$assistansNumber.val(), $formData.$meetingsNumber.val(), $formData.$eventType.val());
        }
      }
    });
  }

  return {
    init: init
  };
})();

$(() => {
  if ($("#me-search-bar").length) {
    mMESearchBar.init($("#me-search-bar"));
  }
});

/**
 * init (view) -> Inicializa el buscador
 * _summaryOpen (state) -> Pliega/despliega el summary asociado a buscador mobile
 * _fillSummaryData (_callback) -> Rellenar el summary con la info de los campos del buscador
 * _initAffix() -> Fija la barra buscadora en el top de la página
 * _resetAffix() -> Reinicia la posicón fija de la barra buscadora
 * _searchBarLocation() -> Comportamiento de location
 * _searchBarCalendar() -> Comportamiento de calendar
 *_searchBarOccupancy() -> Comportamiento de occupancy
 *
 */


var mSearchBar = (() => {
  let $mSearchBarView = null;
  let $searchForm = null;
  let targetElement = null;

  let $summaryLink = null;
  let $summaryContainer = null;
  let $formContent = null;



  /**
   *  Inicializa el buscador
   */
  function init(view) {
    $mSearchBarView = view;
    $searchForm = $mSearchBarView.find("#searchBarModifyForm");
    targetElement = $($mSearchBarView)[0].querySelector('.option-list');

    $summaryLink = $mSearchBarView.find('.search-bar-content.summary').find('.summary-link');
    $summaryContainer = $mSearchBarView.find('.search-bar-content.summary');
    $formContent = $mSearchBarView.find('.search-bar-content:not(".summary")');

    _searchBarLocation();
    _searchBarCalendar();
    _searchBarOccupancy();


    // Comprobar si existe el resumen del buscador
    if ($summaryContainer) {

      // Mostrar info y ocultar spinner
      _fillSummaryData(function () {
        $($summaryContainer).find('.summary-content').addClass('is-show');
        $($summaryContainer).find('.spinner').hide();
      });

      // Hace fallar desplegable en mobile (revisar)
      // $(window).on("resize", function () {
      //   if ( window.matchMedia('only screen and (max-width: 767px)').matches ) {
      //     _summaryOpen (false);
      //   }
      // });
    }


    // Controlar sticky
    if ($mSearchBarView.length && $mSearchBarView.hasClass('sticky-top')) {
      _initAffix();

      $(window).on("resize", function () {
        _resetAffix();
      });
    }


    // Listener de colapsar summary en mobile
    $($summaryLink).click(function (e) {
      let positionTop = null;
      $($formContent).toggleClass('is-open');

      if ($($formContent).hasClass('is-open')) {
        _summaryOpen(true);
        positionTop = $summaryLink.offset().top;

      } else {
        _summaryOpen(false);
        positionTop = $summaryContainer.offset().top - 10;
      }

      // Hacer scroll hasta la altura que deseemos
      $('html, body').animate({ scrollTop: positionTop }, 250);
    });
  }



  /**
   *  Pliega/despliega el summary asociado a buscador mobile
   */
  function _summaryOpen(state) {
    if (!state) {
      $($summaryLink).removeClass('is-open');
      $($formContent).removeClass('is-open');

    } else {
      $($summaryLink).addClass('is-open');
      $($formContent).addClass('is-open');
    }
  }



  /**
   *  Rellenar el summary con la info de los campos del buscador
   */
  function _fillSummaryData(_callback) {
    // Obtener datos buscador form
    let data = {
      location: $($formContent).find('.location .ui-autocomplete-group').val(),
      checkin: $($formContent).find('.js-selected-checkin').val(),
      checkout: $($formContent).find('.js-selected-checkout').val(),
      occupancy: $($formContent).find('.m-occupancy .optionRooms').val(),
      promoCode: $($formContent).find('.voucher-code input').val()
    }

    // Aseguramos que los días están en estado focus y calcular las noches
    let nigth = moment(data.checkout, 'DD/MM/YYYY').diff(moment(data.checkin, 'DD/MM/YYYY'), 'days');
    if (data.checkin) {
      $($formContent).find('.js-selected-checkin').prev().addClass('focus');
      $($formContent).find('.js-selected-checkout').prev().addClass('focus');
    }

    // Rellenar datos summary
    $($summaryContainer).find('.summary-location').text(data.location);
    $($summaryContainer).find('.summary-checkin').text(data.checkin);
    $($summaryContainer).find('.summary-checkout').text(data.checkout);
    $($summaryContainer).find('.summary-night').text((nigth > 1) ? nigth + ' noches' : nigth + ' noche');
    $($summaryContainer).find('.summary-occupancy').text(data.occupancy);
    $($summaryContainer).find('.summary-promocode').text(data.promoCode);

    _callback();
  }



  /**
   *  Fija la barra buscadora en el top de la página
   */
  function _initAffix() {
    var offsetTop = $mSearchBarView.offset().top;
    $mSearchBarView.affix({offset: {top: offsetTop} });
  }



  /**
   *  Reinicia la posicón fija de la barra buscadora
   */
  function _resetAffix() {
    $(window).off('.affix');
    $mSearchBarView.removeData('bs.affix').removeClass('affix affix-top affix-bottom');
    _initAffix();
  }



  // --------------------------------------------------------------
  // Comportamiento de location
  // --------------------------------------------------------------
  function _searchBarLocation() {
    $($mSearchBarView).find('.location').each(function (index, element) {
      let location = {
        container: $(this),
        input: $(this).find('.input-group input'),
        dropdown: $(this).find('.autocomplete-results'),
        isMobile: false
      };

      // ------------------------------------------------------------
      // Controlar si estamos en mobile
      setMobile();
      $(window).resize(function () { setMobile(); });

      function setMobile() {
        ( window.matchMedia('(max-width: 767px)').matches )
          ? location.isMobile = true
          : location.isMobile = false;
      }

      // ------------------------------------------------------------
      // Colocar el dropdown dependiendo del espacio disponible (solo si no es mobile)
      $(window).scroll(function () { locationPosition (); });

      // Colocar dropdown por si cambia el contenido del desplegable
      $(location.input).on('keyup', function () {
        setTimeout(function () {
          locationPosition();
        }, 500)
      })

      function locationPosition() {
        ( !location.isMobile )
          ? dropdownPosition ( location.input, location.dropdown, 20 )
          : $(location.dropdown).css("top", "auto");
      }
    });
  }



  // --------------------------------------------------------------
  // Comportamiento de calendar
  // --------------------------------------------------------------
  function _searchBarCalendar() {

    // Inicializar el widget del calendario de booking
    $($mSearchBarView).find('.m-calendar-booking').each(function (index, calendar) {
      $(calendar).calendarBooking();
    });

    // Cerrar occupancy al abrir calendario del buscador
    $('.js-calendar-booking-input, .js-calendar-booking-input input')
      .on('click', function (e) {
        let dropdownOccupancy = $(this).closest('.m-search-bar').find('.m-occupancy-wrapper');
        if ($(dropdownOccupancy).hasClass('is-open')) {
          $(dropdownOccupancy).removeClass('is-open')
        }
      });

    $($mSearchBarView).find('.m-calendar-booking').each(function (index, element) {
      let calendar = {
        container: $(this),
        input: $(this).find('.js-calendar-booking-input'),
        dropdown: $(this).find('.js-calendar-booking-dropdown'),
        isMobile: false
      };


      // ------------------------------------------------------------
      // Controlar si estamos en mobile
      setMobile();
      $(window).resize(function () { setMobile(); });

      function setMobile() {
        ( window.matchMedia('(max-width: 767px)').matches )
          ? calendar.isMobile = true
          : calendar.isMobile = false;
      }


      // ------------------------------------------------------------
      // Colocar el dropdown dependiendo del espacio disponible (solo si no es mobile)
      $(window).scroll(function () { calendarPosition (); });

      function calendarPosition() {
        ( !calendar.isMobile )
          ? dropdownPosition ( calendar.input, calendar.dropdown, 20 )
          : $(calendar.dropdown).removeAttr('style');
      }
    });
  }



  // --------------------------------------------------------------
  // Comportamiento de occupancy
  // --------------------------------------------------------------
  function _searchBarOccupancy() {
    var occupancy = $($mSearchBarView).find('.m-occupancy');

    if (occupancy.length) {
      reservationOccupancyNew.init();
    }


    $($mSearchBarView).find('.m-occupancy').each(function (index, element) {
      let occupancy = {
        container: $(this),
        input: $(this).find('.form-group'),
        dropdown: $(this).find('.m-occupancy-wrapper'),
        isMobile: false
      };
      let infoInput = occupancy.input.find("input.optionRooms");

      // ------------------------------------------------------------
      // Controlar si estamos en mobile
      setMobile();
      $(window).resize(function () { setMobile(); });

      function setMobile() {
        ( window.matchMedia('(max-width: 767px)').matches )
          ? occupancy.isMobile = true
          : occupancy.isMobile = false;
      }


      // ------------------------------------------------------------
      // Posicionar dropdown occupancy
      function positionOccupancy() {
        ( !occupancy.isMobile )
          ? dropdownPosition ( occupancy.input, occupancy.dropdown, 20 )
          : $(occupancy.dropdown).removeAttr('style');
      }


      // ------------------------------------------------------------
      // Plegar/desplegar dropdown occupancy
      $(occupancy.input).on('click', function (e) {
        let isOpen = $(occupancy.dropdown).hasClass('is-open');
        let alertLanguage = $('.m-language-edition');

        // Ocultar todos los dropdowns y mostrar el que nos interesa
        $('.m-occupancy-wrapper').removeClass('is-open');
        if (!isOpen) {
          $(occupancy.dropdown).addClass('is-open');

          if (occupancy.isMobile) {

            // remove focus from INPUT where we click when modal opens(mobile)
            this.blur();
            let headerMobile = $mSearchBarView.find('.option-header').innerHeight();
            let footerMobile = $mSearchBarView.find('.occupancy-footer').innerHeight();
            let ammount = headerMobile + footerMobile + 60;
            $mSearchBarView.find('.option-list').css({height: `calc(100vh - ${ammount}px`});

            // Block scroll in Body when fake modal is open and user scrolls in the modal
            bodyScrollLock.disableBodyScroll(targetElement);
          }

          // Cerrar alerta de lenguaje
          if (alertLanguage.length) $(alertLanguage).hide();

          // Colocar el dropdown dependiendo del espacio disponible (solo si no es mobile)
          positionOccupancy();

        } else {
          // Actualizar el input al cerrar dropdown
          infoInput.val(infoInput.data('info'));
          occupancy.input.find('label').addClass('focus');
        }

        // Cerrar los calendarios
        let dropdownCalendar = $(this).closest('.m-search-bar').find('.js-calendar-booking-dropdown');
        if ($(dropdownCalendar).hasClass('is-open')) {
          $(dropdownCalendar).removeClass('is-open');
        }
      });

      $(window).scroll(function () { positionOccupancy (); });


      // ------------------------------------------------------------
      // Plegar occupancy al clicar en document
      $(document).on('click', function (e) {
        let isOpen = $(occupancy.dropdown).hasClass('is-open');
        let inDropdown = $(e.target).closest('.m-occupancy-wrapper').length;
        let inTrigger = $(e.target).closest('.m-occupancy').find('.form-group').length;

        // Comprobar si pinchas modales de error de calendar
        let idModalError = ['modal-max-rooms']; // Poner los ids de las modales
        let isErrorModal = idModalError.includes($(e.target).closest('.modal').attr('id'));

        if (isOpen && !inTrigger && !inDropdown && !isErrorModal) {
          $(occupancy.dropdown).removeClass('is-open');
          infoInput.val(infoInput.data("info"));
          occupancy.input.find('label').addClass("focus");
        }
      });

      $(occupancy.dropdown).find('.room-apply').click(function (e) {
        e.preventDefault();

        if (occupancy.isMobile) {
          bodyScrollLock.enableBodyScroll(targetElement);
        }
        $(occupancy.dropdown).removeClass('is-open');
        infoInput.val(infoInput.data("info"));
        occupancy.input.find('label').addClass("focus");
      });


      // ------------------------------------------------------------
      // Controlar posicionamiento al añadir/eliminar habitaciones
      $(occupancy.dropdown).find('.add-room-link').click(function (e) {
        positionOccupancy();
      });

      $(occupancy.dropdown).find('.delete-room .nh-ic-close').click(function (e) {
        setTimeout(() => {
          positionOccupancy();
        }, 505);
      });
    });
  }


  return {
    init: init
  };
})();


$(() => {
  if ($('.m-search-bar').length) {
    mSearchBar.init($('.m-search-bar'));
  }
});

// var mRecaptcha = (function() {
//   var siteKeyLocal = '6LcxGLAUAAAAAB4qQw9VKED9XMGmZn35myJLVhz2';


//   var v2OnloadCallback = function() {
//     var siteKeyLocal = '6Lf_gLAUAAAAAKZwLtibYytotyU0EbPUXPGoDHkD';
//     var recaptchas = $('.g-recaptcha');
//     console.log('grecaptcha v2 is ready!');

//     recaptchas.each(function(index, el) {
//       var widgetId = grecaptcha.render(el, {
//         'sitekey' : siteKeyLocal
//       });

//       $(this).attr('data-widget-id', 'g-recaptcha-' + widgetId);
//     });
//   };

//   var v3OnloadCallback = function() {
//     var recaptchaV3fields = $(".response-recaptcha");
//     $.each(recaptchaV3fields, function() {
//       var $this = $(this);
//       grecaptcha.ready(function() {
//         grecaptcha.execute(siteKeyLocal, { action: 'HomePage' }).then(function(token) {
//           $this.val(token);
//         });
//       });
//     });
//   };

//   // Public API
//   return {
//     v2OnloadCallback: v2OnloadCallback,
//     v3OnloadCallback :v3OnloadCallback
//   };
// })();


var v2OnloadCallback = function() {
  //var siteKeyLocal = '6Lf_gLAUAAAAAKZwLtibYytotyU0EbPUXPGoDHkD';
  var recaptchas = $('.g-recaptcha');


  if(recaptchas.length) {
    console.log('grecaptcha v2 is ready!');

    recaptchas.each(function(index, el) {
      var widgetId = grecaptcha.render(el, {
        'sitekey' : recaptchaV2Key
      });

      $(this).attr({
        'data-widget-id': 'g-recaptcha-' + widgetId,
        'data-widget-index': widgetId
      });
    });
  }
};

var v3OnloadCallback = function() {
  //var siteKeyLocal = '6LcxGLAUAAAAAB4qQw9VKED9XMGmZn35myJLVhz2';
  var recaptchaV3fields = $(".response-recaptcha");
  if(recaptchaV3fields.length) {
    console.log('grecaptcha v3 is ready!');

    $('body').addClass('show-grecaptcha-badge');

    recaptchaV3fields.each(function() {
      var $this = $(this);
      grecaptcha.ready(function() {
        grecaptcha.execute(recaptchaV3Key, { action: 'HomePage' }).then(function(token) {
          $this.val(token);
        });
      });
    });
  }
};


/*(function(){
  var cookies = document.cookie.split(";");
  var captchaLangCookie = ["USER_CT_COUNTRY", "en"];
  var recaptchaV3fields = $(".response-recaptcha");
  var recaptchaV2fields = $('.g-recaptcha');

  cookies.some(function(element) {
    if(element.indexOf("USER_CT_COUNTRY") >= 0) {
      captchaLangCookie = element.split("=");
      return true;
    }
  });

  if(recaptchaV2fields.length) {
    createRecaptchaV2Script(captchaLangCookie);
  }

  if(recaptchaV3fields.length) {
    createRecaptchaV3Script(captchaLangCookie);
  }

  function createRecaptchaV2Script(langCookie) {
    var captchaScript=document.createElement('script');
    captchaScript.src = "https://www.google.com/recaptcha/api.js?onload=v2OnloadCallback&render=explicit&hl=" + langCookie[1];
    captchaScript.type="text/javascript";
    captchaScript.async=true;
    captchaScript.defer=true;
    $("body").append(captchaScript);
  }
  
  function createRecaptchaV3Script(langCookie) {
    var captchaScript=document.createElement('script');
    captchaScript.src = "https://www.google.com/recaptcha/api.js?onload=v3OnloadCallback&hl=" + langCookie[1] + "&render=" + recaptchaV3Key;
    captchaScript.type="text/javascript";
    $("body").append(captchaScript);
  }
  
})();*/

const mGroupCardsNew = (() => {
  var $mGroupCardView = null;
  var $groupCardsSlide = null;
  var $groupCards = null;
  var $groupCardsSlide = null;
  var $card = null;
  var $photoCard = null;
  var $photoCardSlide = null;
  var $moreInfo = null;
  var defaultSliderConfig = {
    dots: false,
    infinite: true,
    fade: false,
    draggable: false,
    prevArrow: '<span class="slick-arrow slick-prev nh-ic-chevron"></span>',
    nextArrow: '<span class="slick-arrow slick-next nh-ic-chevron"></span>',
    lazyLoad: "ondemand"
  };
  
  function init(view) {
    $mGroupCardView = view;
    $groupCards = $mGroupCardView.find('.group-cards');
    $groupCardsSlide = $mGroupCardView.find('.group-cards-slick');
    $card = $mGroupCardView.find('.card');
    $photoCard = $card.find('.card-header');
    $photoCardSlide = $card.find('.card-header-slide');
    $moreInfo = $card.find('.card-body .more-info');

    // console.log('Inicializamos slick slider in card header');
    $moreInfo.on("click", _toggleMorelInfo);

    $.each($photoCard, function(index, header) {
      var $header = $(header);
      var sliderConfig = null;
      var isParentSlider = $header.parents(".group-cards-slick").length;
      if(isParentSlider) {
        sliderConfig = $.extend({}, defaultSliderConfig, {touchMove: false});
      } else {
        sliderConfig = defaultSliderConfig;
      }
      $header.slick(sliderConfig);
    });


    if($groupCardsSlide.length) {
      //console.log('Inicializamos slick slider in group cards');
      $groupCardsSlide.slick({
        centerMode: true,
        centerPadding: '20px',
        slidesToShow: 1,
        dots: true,
        infinite: false,
        fade: false,
        arrows: false,
        lazyLoad: "ondemand"
      });
    }
  }


  function _toggleMorelInfo(ev) {
    var $this = $(this);
    var panel = $($this.attr("href"));
    var isOpen = panel.is(".collapse.in");
    var text = (isOpen) ? $this.data("closed-header-text") : $this.data("open-header-text");

    ev.preventDefault();
    $this.text(text);
  }

  // Public API
  return {
    init: init,
  };
})();


$(function() {
  if($('.m-group-cards').length) {
    mGroupCardsNew.init($('.m-group-cards'));
  }
  // One Slider
  /*if($('.m-group-cards .group-cards').length) {
    mGroupCards.init();
  }

  // Two Sliders
  if($('.m-group-cards .group-cards-slick').length) {
    mGroupCardsSlick.init();
  }

  // Two Sliders
  if($('.card-header').length) {
    $('.card-header').slick({
      dots: false,
      infinite: true,
      fade: false,
      draggable: true,
      touchMove: true,
      prevArrow: '<span class="slick-arrow slick-prev nh-ic-chevron"></span>',
      nextArrow: '<span class="slick-arrow slick-next nh-ic-chevron"></span>',
    })
  }*/



});

const mHotelBox = (() => {
  var $mHotelBoxView = null;
  var $card = null;
  var $photoCardSlide = null;
  var defaultSliderConfig = {
    dots: false,
    infinite: true,
    fade: false,
    draggable: true,
    touchMove: true,
    prevArrow: '<span class="slick-arrow slick-prev nh-ic-chevron"></span>',
    nextArrow: '<span class="slick-arrow slick-next nh-ic-chevron"></span>',
    lazyLoad: "ondemand"
  };
  
  function init(view) {
    $mHotelBoxView = view;
    $card = $mHotelBoxView.find('.card');
    $photoCardSlide = $card.find('.card-header-slide');
    //$moreInfo = $card.find('.card-body .more-info');

    // console.log('Inicializamos slick slider in card header');
    //$moreInfo.on("click", _toggleMorelInfo);

    $photoCardSlide.slick(defaultSliderConfig);
  }

  // Public API
  return {
    init: init,
  };
})();


$(function() {
  if($('.m-hotel-box').length) {
    mHotelBox.init($('.m-hotel-box'));
  }
});

var mLoginFormHeader = (() => {
  var $loginForms;

  function init() {
    var formsData = {
      "loginFormV2": {
        $userInput: "#login-email",
        $passwordInput: "#login-password",
        $userBlockedContent: ".blocked-user",
        $userUnblockedContent: ".unblocked-user",
        $errorLogin: ".js-error-login"
      },
      "loginFormMobv2": {
        $userInput: "#emailMob",
        $passwordInput: "#passwordMob",
        $userBlockedContent: ".blocked-user",
        $userUnblockedContent: ".unblocked-user",
        $errorLogin: ".js-error-login"
      }
    };

    $loginForms = $("#loginFormV2, #loginFormMobv2");

    $.each($loginForms, function() {
      var $this = $(this);
      var formId = this.id;
      var formData = {
        $form: $this,
        $userInput: $this.find(formsData[formId].$userInput),
        $passwordInput: $this.find(formsData[formId].$passwordInput),
        $userBlockedContent: $this.find(formsData[formId].$userBlockedContent),
        $userUnblockedContent: $this.find(formsData[formId].$userUnblockedContent),
        $errorMessage: $this.data("login-message-error") || "There was han error during login process",
        $errorLogin: $this.find(formsData[formId].$errorLogin),
      };

      $this.find(".js-recorverpass-modal-trigger").attr({
        "data-state": "recover",
        "data-toggle":"modal",
        "data-target":"#m-modal-login"
      });

      $this.validator({
        disable: false
      }).on('submit', {formData: formData}, _onLoginFormSubmit);

      formData.$userInput.on('change', {formData: formData}, _checkUserBlocked);

    });
  }

  function _checkUserBlocked(ev) {
    var $this = $(this);
    var $form = ev.data.formData.$form;
    var selectedUser = $form.data("selected-user");
    if(selectedUser) {
      if(selectedUser.isBlocked && selectedUser.value !== $this.val()) {
        ev.data.formData.$userBlockedContent.hide();
        ev.data.formData.$userUnblockedContent.show();
      } else if(selectedUser.isBlocked && selectedUser.value === $this.val()) {
        ev.data.formData.$userBlockedContent.show();
        ev.data.formData.$userUnblockedContent.hide();
      }
    }
  }

  /**
   * @description - actions to do when the form is submit
   * @param {object} ev - event data
   */
  function _onLoginFormSubmit(ev) {
    var $form = $(this);
    var formData = ev.data.formData;
    var loginData = {
      user: formData.$userInput.val(),
      password: formData.$passwordInput.val(),
      defaultErrorMsg: formData.$errorMessage
    };

    $form.data("selected-user", {isBlocked: false, value: loginData.user});

    toggleLoadingButton($form, true);
    if (ev.isDefaultPrevented()) {
      // Invalid Form
      toggleLoadingButton($form, false);
    } else {
      // Valid Form
      ev.preventDefault();
      //login.loginSSO(formData).then(_onSubmitLoginSuccess, _onSubmitLoginFailure);
      login.loginSSO(loginData).then(data => _onSubmitLoginSuccess(formData, data), data => _onSubmitLoginFailure(formData, data));
      
      //_fakelogin();
      window.onbeforeunload = null;
    }
  }

  /**
   * @description handle the user login successfully response
   * @param {*} response - data of user login succesffuly
   */
  function _onSubmitLoginSuccess(formData, response) {
    formData.$form.data("selected-user", null);
    utils.callTrackForms("success", "loginRewardsForm", "success");
    window.location = response.targetUrl;
  }

  /**
   * @description handle the user login error response
   * @param {*} error - data of user login failure
   */
  function _onSubmitLoginFailure(formData, error) {
    console.log("data", formData, error);
    toggleLoadingButton(formData.$form, false);
    formData.$userInput.closest('.form-group').addClass('has-error');
    formData.$passwordInput.closest('.form-group').addClass('has-error');
    formData.$userInput.closest('.form-group').removeClass('has-success');
    formData.$passwordInput.closest('.form-group').removeClass('has-success');
    if(error.type === "blocked") {
      formData.$userBlockedContent.show();
      formData.$userUnblockedContent.hide();
      formData.$errorLogin.hide();
      formData.$form.data("selected-user").isBlocked = true;
    } else {
      //formData.$errorLogin.find("p").html(error.message);
      formData.$errorLogin.show();
      formData.$form.data("selected-user").isBlocked = false;
    }
  }
  
  
  // Public API
  return {
    init: init
  };

})();

$(() => {
  if($('#loginFormV2').length || $("#loginFormMobv2").length) {
    mLoginFormHeader.init();
  }
});


/*
1. Constructor -> Constructor del filtro inicial

2. Funciones de inicialización del filtro
2.A init -> Inicializar el filtro (selectores, contador de hoteles, escuchadores de eventos)
2.B maxRange -> Inicializar dinámicamente los range (precio y distancia)
2.C initSelectPois -> Inicializar dinámicamente los selectores de localización
2.D initCurrencyMobile -> Inicializar currency de header de EY (mobile & tablet)
2.E showRating -> Muestra los rating disponibles pasados en un array
2.F getCurrencyData -> Almacenar el array de conversiones de divisas
2.G initRange -> Inicialización de los range (librería noUiSlider)

3. Funciones escuchadoras para recoger valores de filtros (mobile & desktop)
3.A. listenerDesktop -> Listener filtro desktop (activar filtro uno a uno)
3.B listenerMobile -> Listener filtro mobile (activar todos los filtros al pulsar botón modal)

4. Setters -> Cambiar atributos del filtro global y sincronizar valor con filtro oculto
4.A setRange -> Cambia el atributo de elementos de rango (precio y distancia)
4.B setServiceMobile -> Cambia el atributo de services (desde mobile)
4.C setServiceDesktop -> Cambia el atributo de services (desde desktop)
4.D setRatingMobile -> Cambia el atributo de rating (desde mobile)
4.E setRatingDesktop -> Cambia el atributo de rating (desde desktop)
4.F setSorted -> Cambia el atributo de ordenar
4.G setCurrency -> Cambia el atributo de selected de currency
4.H setLocation -> Cambiar atributo localizacion (caso especial demasiado específico)

5. Funcionalidad de filtrar hoteles tras conseguir valores de filtrado
5.A filterHotels -> Recoger todos los datos relacionados con los hoteles
5.B canShowHotel -> Comparar datos de hotel y filtro para saber si mostrar u ocultar
5.C canShowHotelsGroup -> Contar hoteles visibles para saber si mostrar/ocultar grupo
5.D getShowPois -> Devuelve el backcode de los hoteles que se mostrarán en el mapa al filtrar

6. Funcionalidad de ordenar hoteles
6.A sortedGroups -> Según el valor del select se tienen que ordenar en unos grupos u otros
6.B sortedHotels -> Pasamos el grupo para que ordene según el valor seleccionado

7. Funcionalidad de cambio de moneda
7.A currencyModal -> Controlar cambio de moneda (modal currency)
7.B changeHotelsCurrency -> Cambiar la moneda en todos los hotel cards

8. Funcionalidad tags de filtros (mobile & desktop)
8.A CreateTag -> Genera un tag de un elemento (precio) o grupos de elementos (servicios) filtrados
8.B updateTag -> Modificar tags existentes cuando cambia su valor de filtro
8.C removeTag -> Eliminar tags existentes y volver a filtrar

9. Funcionalidad complementaria
9.A formatRange -> Función auxiliar que recoge el valor numérico de un string (p.e. '12 EUR')
9.B loadingHotels -> Deshabilita los filtros desktop hasta que termine todo el filtrado de hoteles

10. Reset -> Reiniciar el filtro (p.e. cuando se busca otra ciudad)
*/


class MeFilterHotels {

  // --------------------------------------------------------------------------------
  // 1. Constructor
  // --------------------------------------------------------------------------------
  constructor (page) {

    // Atributos generales de la página
    this.page = page; // clase descriptiva del main de la página
    this.containers = { mobile: null, desktop: null, result: null };
    this.cont = 0; // contador de hoteles mostrados

    // Atributos de ordenación
    this.sortedBy = null;
    this.groups = [];

    // Atributos moneda
    this.currency = { origin: 'EUR', selected: 'EUR', aux: null };
    this.currencyConversions = []; // array de conversiones con euro de origen

    // Atributos de formulario del filtro
    this.price = null;
    this.services = [];
    this.nearTo = { location: { value: null, text: null }, distance: null };
    this.locationCenter = { value: null, text: null};
    this.ratings = [];

    // Geolocalización solo para móviles
    this.geolocation = { latitude: null, longitude: null };

    // Array que almacena los backcode de los pois que tras filtrar son visibles
    this.showPois = [];

    // EY
    this.rooms = null;
    this.meetingrooms = null;
    this.capacity = null;

  }



  // --------------------------------------------------------------------------------
  // 2.A Init global
  // --------------------------------------------------------------------------------
  init (filterContainerMobile, filterContainerDesktop, resultContainer) {
    const filter = this;

    // -------------------------------------------
    // Inicialización de atributos del filtro

    // Almacenamos contenedores de filtros
    this.containers.mobile = filterContainerMobile;
    this.containers.desktop = filterContainerDesktop;
    this.containers.result = resultContainer;

    // Inicializar grupos
    $(this.containers.result).find('.m-hotel-list').each(function (index, list) {
      filter.groups.push($(list).data('hotels-group'));
    });

    // Inicialización contadores de hoteles mostrados (desktop y mobile)
    //const hotelCont = document.querySelectorAll('.js-filter-hotels-number');
    //this.cont = this.containers.result.querySelectorAll('.m-hotel-box').length;
    //hotelCont.forEach(hotelCont => hotelCont.textContent = this.cont);

    // Almacenar el array de conversiones de divisas
    this.getCurrencyData();


    // -------------------------------------------
    // Activar/desactivar servicios (desktop y mobile)
    const filterServices = document.querySelectorAll('[data-service]');
    filterServices.forEach(link => {
      link.addEventListener('click',() => { $(link).toggleClass('is-active'); });
    });


    // -------------------------------------------
    // Mostrar/ocultar distancia del Cerca de.. (desktop y mobile)
    const filterLocation = document.querySelectorAll('.js-filter-location');
    filterLocation.forEach(select => {
      select.addEventListener('change', e => {
        let distance = $(e.target).closest('.filter-hotels-group').find('.filter-hotels-distance')[0];
        e.target.value === 'invalid'
        ? $(distance).addClass('is-hidden')
        : $(distance).removeClass('is-hidden');
      });
    });

    // -------------------------------------------
    // Deshabilitar el option de ordenar por poi (inicialmente no tenemos valor)
    const filterSort = $('.js-filter-sort');
    $(filterSort).find("option[value^='poi-']").attr("disabled", "disabled");
    $(filterSort).selectpicker('render');


    // -------------------------------------------
    // Escuchadores cambio monedas
    let modalCurrency = $('#modal-filter-currency');

    // Captura el rechazo de cambio de moneda
    $(modalCurrency).find('.btn-ico').click(function () {
      filter.setCurrency(false);
    });
    $(modalCurrency).find('.js-filter-currency-origin').click(function () {
      filter.setCurrency(false);
    });

    // Captura el cambio de moneda
    $(modalCurrency).find('.js-filter-currency-change').click(function () {
      filter.setCurrency(true);
      filter.loadingHotels(true);
      setTimeout(() => { filter.loadingHotels(false); }, 1000);
    });



    // -------------------------------------------
    // Sólo para dispositivo móvil
    if( isMobile.any() ) {

      // Habilitar options ordenar cerca de mi...
      $(this.containers.mobile).find("option[value='close-to-me']").removeAttr('disabled');
      $(this.containers.mobile).find('.js-filter-sort.selectpicker').selectpicker('render');

      // Conseguimos y almacenamos geolocalización
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          filter.geolocation.latitude = position.coords.latitude;
          filter.geolocation.longitude = position.coords.longitude;
        });
      }
    }


    // -------------------------------------------
    // Init currency (mobile & tablet)
    this.initCurrencyMobile();

    // -------------------------------------------
    // Escuchadores según dispositivo (desktop o mobile)
    this.listenerDesktop ();
    this.listenerMobile ();
  }



  // --------------------------------------------------------------------------------
  // 2.B Inicializar dinámicamente los range (precio y distancia)
  // --------------------------------------------------------------------------------
  maxRange (type, value) {
    // Hacer visible el grupo de price y la ordenación por precio (inicialmente oculto)
    if ( type === 'price' ) {
      const mobilePrice = $(this.containers.mobile).find('.js-filter-price')[0];
      const desktopPrice = $(this.containers.desktop).find('.js-filter-price')[0];
      $(mobilePrice).closest('.filter-hotels-group').removeClass('is-hidden');
      $(desktopPrice).closest('.filter-hotels-group').removeClass('is-hidden');

      const sortMobile = $(this.containers.mobile).find('.js-filter-sort.selectpicker');
      const sortDesktop = $(this.containers.desktop).find('.js-filter-sort.selectpicker');
      $(sortMobile).find("option[value^='price-']").removeAttr('disabled');
      $(sortDesktop).find("option[value^='price-']").removeAttr('disabled');
      $(sortMobile).selectpicker('render');
      $(sortDesktop).selectpicker('render');
    }

    // Inicializar los range
    let filterSelector = null;
    if ( type === 'price' ) filterSelector = document.querySelectorAll('.js-filter-price');
    else if ( type === 'distance' ) filterSelector = document.querySelectorAll('.js-filter-distance');
    else if ( type === 'rooms' ) filterSelector = document.querySelectorAll('.js-filter-rooms');
    else if ( type === 'meetingrooms' ) filterSelector = document.querySelectorAll('.js-filter-meetingrooms');
    else if ( type === 'capacity' ) filterSelector = document.querySelectorAll('.js-filter-capacity');   
       
    filterSelector.forEach(range => this.initRange (range, value) ); 
  


  }


  // --------------------------------------------------------------------------------
  // 2.C Inicializar dinámicamente los selectores de localización
  // --------------------------------------------------------------------------------
  initSelectLocation (arrayPois) {
    const filter = this;

    // Selector de los selects de location
    let locationMobile = $(this.containers.mobile).find('.js-filter-location.selectpicker');
    let locationDesktop = $(this.containers.desktop).find('.js-filter-location.selectpicker');
    let sortMobile = $(this.containers.mobile).find('.js-filter-sort.selectpicker');


    // Montamos el html de los select e inicializamos locationCenter (atributo)
    let htmlOptions = '<option value="invalid">Choose an option</option>';
    arrayPois.forEach(option => {

      // Iniciar atributo de filtro localización centro y pintar la opción
      if ( option.isCenter ) {
        filter.locationCenter.value = option.value;
        filter.locationCenter.text = option.text;
        htmlOptions += `<option value=${option.value} data-center>${option.text}</option>`;

      } else {
        htmlOptions += `<option value=${option.value}>${option.text}</option>`;
      }
    });


    // Agregamos html y actualizamos
    $(locationMobile).html(htmlOptions).selectpicker('refresh');
    $(locationDesktop).html(htmlOptions).selectpicker('refresh');


    // Escuchador de móvil para actualizar el sort en tiempo real (no esperar a dar el botón)
    $(locationMobile).change(function (e) {
      let value = e.target.value;
      ( value === filter.locationCenter.value || value === 'invalid' )
      ? $(sortMobile).find("option[value^='poi-']").attr("disabled", "disabled")
      : $(sortMobile).find("option[value^='poi-']").removeAttr('disabled');
      $(sortMobile).selectpicker('render');
    });
  }



  // --------------------------------------------------------------------------------
  // 2.D initCurrencyMobile -> Inicializar currency de header de EY (mobile & tablet)
  // --------------------------------------------------------------------------------
  initCurrencyMobile() {
    const filter = this;

    // Opciones de moneda
    var currencyOptions = [
      { value: 'ARS', text: 'Argentine Peso ($a)'},
      { value: 'AUD', text: 'Australian Dollar ($)'},
      { value: 'BRL', text: 'Brazilian Real (R$)'},
      { value: 'GBP', text: 'British Pound (£)'},
      { value: 'CAD', text: 'Canadian Dollar (C$)'},
      { value: 'CLP', text: 'Chilean peso'},
      { value: 'COP', text: 'Colombian Peso'},
      { value: 'DKK', text: 'Danish Krone (kr)'},
      { value: 'EUR', text: 'Euro (€)' },
      { value: 'HUF', text: 'Hungarian Forint (Ft)'},
      { value: 'INR', text: 'Indian Rupee (₹)'},
      { value: 'ILS', text: 'Israeli New Shekel (₪)'},
      { value: 'MXN', text: 'Mexican Peso ($)'},
      { value: 'NOK', text: 'Norwegian Krone (kr)'},
      { value: 'PEN', text: 'Peruvian Sol (S/)'},
      { value: 'PLN', text: 'Polish Zloty (zł)'},
      { value: 'RON', text: 'Romanian Leu (RON)'},
      { value: 'RUB', text: 'Russian Ruble (₽)'},
      { value: 'SEK', text: 'Swedish krona (kr)'},
      { value: 'CHF', text: 'Swiss Franc (Fr)'},
      { value: 'USD', text: 'US Dollar (US $)'},
      { value: 'UYU', text: 'Uruguayan peso'}
    ];


    // -----------------------------------------
    // Selectores de currency headers mobile & tablet
    const mobileCurrency = $('#off-canvas-left-mob').find('#currency');
    const tabletCurrency = $('#off-canvas-menuLeft').find('.navMob .dropdown')[1];


    // -----------------------------------------
    // Vaciar las opciones de los header de EY
    $(mobileCurrency).find('option').remove();
    $(tabletCurrency).find('li').remove();


    // -----------------------------------------
    // Meter las opciones en el select de mobile y seleccionar el EUR
    let htmlOptionsMobile = '';
    currencyOptions.forEach(option => {
      ( option.value === 'EUR' )
      ? htmlOptionsMobile += `<option value=${option.value} selected>${option.text}</option>`
      : htmlOptionsMobile += `<option value=${option.value}>${option.text}</option>`;
    });
    $(mobileCurrency).append(htmlOptionsMobile);


    // -----------------------------------------
    // Meter las opciones en el select de tablet
    let htmlOptionsTablet = '';
    currencyOptions.forEach(option => {
      ( option.value === 'EUR' )
      ? htmlOptionsTablet += `<li class='is-selected' data-currency=${option.value}>${option.text}</li>`
      : htmlOptionsTablet += `<li data-currency=${option.value}>${option.text}</li>`;
    });
    $(tabletCurrency).find('.dropdown-menu').append(htmlOptionsTablet);


    // -----------------------------------------
    // Listener de select de mobile
    $(mobileCurrency).change(function (e) {

      // Cerrar menú mobile y llamar a cambiar moneda
      $('#header-mob').find('.navbar-toggle.btn-ico-menu').trigger('click');
      filter.currencyModal(e.target.value);
    });




    // -----------------------------------------
    // Listener de dropdown de tablet
    $(tabletCurrency).find('li').click(function (e) {

      // Cambiar valor seleccionado y llamar a cambiar moneda
      $(tabletCurrency).find('a').html(e.target.textContent + '<b class="caret"></b>');
      filter.currencyModal(e.target.dataset.currency);
    });
  }



  // --------------------------------------------------------------------------------
  // 2.E showRating -> Muestra los rating disponibles pasados en un array
  // --------------------------------------------------------------------------------
  showRating (arrayRating) {

    // Si hay ratings disponibles
    if ( arrayRating.length > 0 ) {

      // Contenedores del rating (desktop & mobile)
      let containerMobile = $(this.containers.mobile).find('.filter-hotels-rating');
      let containerDesktop = $(this.containers.desktop).find('.filter-hotels-rating');

      // Mostrar todo el gurpoo de ratings
      $(containerMobile).closest('.filter-hotels-group').removeClass('is-hidden');
      $(containerDesktop).closest('.filter-hotels-group').removeClass('is-hidden');

      // Recorrer el array de rating para mostrar los rating disponibles
      arrayRating.forEach(rating => {
        $(containerMobile).find(`.tripadvisor.rating-${rating}`).closest('.trip').addClass('is-show');
        $(containerDesktop).find(`.tripadvisor.rating-${rating}`).closest('.trip').addClass('is-show');
      });
    }
  }



  // --------------------------------------------------------------------------------
  // 2.F getCurrencyData -> Almacenar el array de conversiones de divisas
  // --------------------------------------------------------------------------------
  getCurrencyData () {
    // let filter = this;
    // $.ajax({
    //   url: 'https://www.nh-hotels.com/rest/jsonCurrency',
    //   dataType: 'json',
    //   async: false,
    //   cache: true,
    //   success: function (data) {
    //     filter.currencyConversions = data;
    //   }
    // });

    let euroConversions = [
      { "cur_dest": "ARS", "rate": "48.64116" },
      { "cur_dest": "CHF", "rate": "1.11090" },
      { "cur_dest": "CLP", "rate": "778.50770" },
      { "cur_dest": "COP", "rate": "3612.28402" },
      { "cur_dest": "EUR", "rate": "1.00000" },
      { "cur_dest": "GBP", "rate": "0.89291" },
      { "cur_dest": "MXN", "rate": "21.74450" },
      { "cur_dest": "USD", "rate": "1.13850" },
      { "cur_dest": "UYU", "rate": "39.96246" },
      { "cur_dest": "SEK", "rate": "10.63338" },
      { "cur_dest": "DKK", "rate": "7.46621" },
      { "cur_dest": "PLN", "rate": "4.25351" },
      { "cur_dest": "RUB", "rate": "71.83058" },
      { "cur_dest": "ILS", "rate": "4.12336" },
      { "cur_dest": "BRL", "rate": "4.34218" },
      { "cur_dest": "CAD", "rate": "1.50269" },
      { "cur_dest": "RON", "rate": "4.73507" },
      { "cur_dest": "HUF", "rate": "324.23065" },
      { "cur_dest": "AUD", "rate": "1.63766" },
      { "cur_dest": "PEN", "rate": "3.74583" },
      { "cur_dest": "NOK", "rate": "9.66434" },
      { "cur_dest": "INR", "rate": "79.21782" }
    ];
    this.currencyConversions = euroConversions;
  }



  // --------------------------------------------------------------------------------
  // 2.G initRange -> Inicialización de range (librería noUiSlider)
  // --------------------------------------------------------------------------------
  initRange (rangeElement, rangeValue) {

    let filterContainer = $(rangeElement).closest('.m-filter-hotels');
    let filter = this;

    // Establecer las unidades según precio o distancia
    let unit = null;
    if ( $(rangeElement).hasClass('js-filter-price') ) unit = this.currency.selected;
    else if ( $(rangeElement).hasClass('js-filter-rooms') ) unit = 'Rooms';
    else if ( $(rangeElement).hasClass('js-filter-distance') ) unit = 'km';
    else if ( $(rangeElement).hasClass('js-filter-meetingrooms') ) unit = 'Meeting Rooms';
    else if ( $(rangeElement).hasClass('js-filter-capacity') ) unit = 'Capacity';

    // Inicializar el range
    noUiSlider.create(rangeElement, {
      start: rangeValue,
      connect: [true, false],
      // tooltips: true,
      range: {
        'min': 0,
        'max': rangeValue
      },
      format: {
        from: Number,
        to: function (value) { return Math.round(parseInt(value)) + ' ' + unit; }
      }
    });


    // Inicializar marcador estático de valores
    let spanValue = $(rangeElement).closest('.range').find('.js-filter-range-end')[0];
    rangeElement.noUiSlider.on('update', function (values, handle) {
      spanValue.innerHTML = values[handle];
    });


    // Llamar al setter correspondiente si el filtro es de desktop
    if ( !filterContainer.hasClass('is-mobile') ) {
      rangeElement.noUiSlider.on('change', value => {

        // quitar las unidades de los range
        let formatValue = filter.formatRange(value);


        if ($(rangeElement).hasClass('js-filter-price')){
          filter.setRange(formatValue, 'js-filter-price')
        } else if ($(rangeElement).hasClass('js-filter-distance')){
          filter.setRange(formatValue, 'js-filter-distance')
        }
        //EY
        else if ($(rangeElement).hasClass('js-filter-rooms')) {
          filter.setRange(formatValue, 'js-filter-rooms')
        }
        else if ($(rangeElement).hasClass('js-filter-meetingrooms')) {
          filter.setRange(formatValue, 'js-filter-meetingrooms')
        }
        else if ($(rangeElement).hasClass('js-filter-capacity')) {
          filter.setRange(formatValue, 'js-filter-capacity')
        }
        // Deshabilitar filtro desktop
        this.loadingHotels(true);
      });
    }

    // Asignar valores iniciales de range al filtro
    if ( $(rangeElement).hasClass('js-filter-distance') ) {
      this.nearTo.distance = rangeValue;

    } else if ( $(rangeElement).hasClass('js-filter-price') ) {
      this.price = rangeValue;
    }
    //EY
    else if ( $(rangeElement).hasClass('js-filter-rooms') ){
      this.rooms = rangeValue;
    }
    else if ( $(rangeElement).hasClass('js-filter-meetingrooms') ){
      this.meetingrooms = rangeValue;
    }
    else if ( $(rangeElement).hasClass('js-filter-capacity') ){
      this.capacity = rangeValue;
    }
  }

  // --------------------------------------------------------------------------------
  // 2.H toggleCurrency -> Si el filtro currency debe estar oculto o visible
  // --------------------------------------------------------------------------------
  toggleCurrency (visible) {
    // Selectores de todos los selects de moneda
    const mobileCurrency = $('#off-canvas-left-mob').find('#currency');
    const tabletCurrency = $('#off-canvas-menuLeft').find('.navMob .dropdown').eq(1);
    const desktopCurrency = $(this.containers.desktop).find('.filter-currency-wrapper');

    mobileCurrency.parents(".language-select").toggle(visible);
    $(tabletCurrency).toggle(visible);
    desktopCurrency.toggle(visible);
  }


  // --------------------------------------------------------------------------------
  // 3.A. listenerDesktop -> Listener filtro desktop (activar filtro uno a uno)
  // --------------------------------------------------------------------------------
  listenerDesktop () {

    // -------------------------------------------
    // Selectores elementos desktop
    const filterSort = this.containers.desktop.querySelector('.js-filter-sort.selectpicker');
    const filterCurrency = this.containers.desktop.querySelector('.js-filter-currency.selectpicker');
    const filterServices = this.containers.desktop.querySelectorAll('[data-service]');
    const filterLocation = this.containers.desktop.querySelector('.js-filter-location');
    const filterRatings = this.containers.desktop.querySelectorAll('[data-rating]');
    //EY
    const filterRooms = this.containers.desktop.querySelector('.js-filter-rooms');
    const filterMeetingRooms = this.containers.desktop.querySelector('.js-filter-meetingrooms');
    const filterCapacity = this.containers.desktop.querySelector('.js-filter-capacity');

    // -------------------------------------------
    // Escuchadores de eventos

    // captura el orden
    filterSort.addEventListener('change', e => {
      this.setSorted(e.target.value);
      this.loadingHotels(true);
    });


    // Captura el cambio del select de moneda
    filterCurrency.addEventListener('change', e => {
      this.currencyModal(e.target.value);
    });

    // captura que link de servicios se ha activado/desactivado
    // nos ayudamos de la clase modificadora 'is-active'
    filterServices.forEach(link => {
      link.addEventListener('click', e => {
        let parent = $(e.target).closest('[data-service]')[0];
        this.setServiceDesktop(parent.dataset.service, $(link).hasClass('is-active'));
        this.loadingHotels(true);
      });
    });

    // captura el select de localización cercana
    filterLocation.addEventListener('change', e => {
      this.setLocation(e.target.value);
      this.loadingHotels(true);
    });

    //EY
    if($('.js-filter-me-hotels').length ){
      filterRooms.addEventListener('change', e => {
        this.setLocation(e.target.value);
        this.loadingHotels(true);
      });
      filterMeetingRooms.addEventListener('change', e => {
        this.setMeetingRooms(e.target.value);
        this.loadingHotels(true);
      });
      filterCapacity.addEventListener('change', e => {
        this.setCapacity(e.target.value);
        this.loadingHotels(true);
      });
    }
    // captura que check de rating has clickado
    filterRatings.forEach(check => {
      check.addEventListener('change', e => {
        this.setRatingDesktop(e.target.dataset.rating, e.target.checked);
        this.loadingHotels(true);
      });
    });
  }



  // --------------------------------------------------------------------------------
  // 3.B listenerMobile -> Listener filtro mobile (activar todos los filtros al pulsar botón modal)
  // --------------------------------------------------------------------------------
  listenerMobile () {
    const mobileButton = $(this.containers.mobile).find('.js-filter-hotels-button');
    const $modalFilter = $(this.containers.mobile).find('.modal');
    const filter = this;

    // --------------------------------------------------------------------------------
    // Cambiar todos los valores del filtro desde móvil
    $(mobileButton).click(function () {

      // ----------------------------------------------------
      // Selectores campos filtro mobile
      const mobileSorted = $(filter.containers.mobile).find('.js-filter-sort.selectpicker')[0];
      const mobilePrice = $(filter.containers.mobile).find('.js-filter-price')[0];
      const mobileServices = $(filter.containers.mobile).find('.is-active[data-service]');
      const mobileLocation = $(filter.containers.mobile).find('.js-filter-location.selectpicker')[0];
      const mobileDistance = $(filter.containers.mobile).find('.js-filter-distance')[0];
      const mobileRatings = $(filter.containers.mobile).find('[data-rating]:checked');
      // EY
      const mobileRooms = $(filter.containers.mobile).find('.js-filter-rooms')[0];
      const mobileMeetingRooms = $(filter.containers.mobile).find('.js-filter-meetingrooms')[0];
      const mobileCapacity = $(filter.containers.mobile).find('.js-filter-capacity')[0];


      // ----------------------------------------------------
      // Llamadas a los setters para cambiar atributos de filtro y campos desktop -> ordenador por tipos (range, check, select)

      // Setear precio (formateamos para quitar moneda)
      let priceValue = null;
      if ( !$(mobilePrice).closest('.filter-hotels-group').hasClass('is-hidden') ) {
        priceValue = mobilePrice.noUiSlider.get();
        filter.setRange(filter.formatRange(priceValue, true), 'js-filter-price');
      }

      // Setear distancia (formateamos para quitar km)
      let distanceValue = mobileDistance.noUiSlider.get();
      filter.setRange(filter.formatRange(distanceValue, true), 'js-filter-distance', false, true);

      // EY Setear rooms
      let roomsValue = mobileRooms.noUiSlider.get();
      filter.setRange(filter.formatRange(roomsValue, true), 'js-filter-rooms', false, true);
      // EY Setear meeting rooms
      let meetingroomsValue = mobileMeetingRooms.noUiSlider.get();
      filter.setRange(filter.formatRange(meetingroomsValue, true), 'js-filter-meetingrooms', false, true);
      // EY Setear capacity
      let capacityValue = mobileCapacity.noUiSlider.get();
      filter.setRange(filter.formatRange(capacityValue, true), 'js-filter-capacity', false, true);


      // Setear servicios
      let arrayServices = [];
      $(mobileServices).each(function (index, element) {
        arrayServices.push(element.dataset.service);
      });
      filter.setServiceMobile(arrayServices);

      // Setear ratings
      let arrayRatings = [];
      $(mobileRatings).each(function (index, value) {
        let ratingValue = $(value).data('rating');
        arrayRatings.push(ratingValue.toString());
      });
      filter.setRatingMobile(arrayRatings);

      // Setear localización
      filter.setLocation($(mobileLocation).val());

      // Setear orden y ordenar solo si el valor seleccionado es diferente al actual
      filter.setSorted($(mobileSorted).val());

      // Ocultar modal
      $modalFilter.modal('hide');
    });
  }

  // ---------------------------------------------------
  // 4.A setRange -> Cambia el atributo de elementos de rango (precio y distancia)
  // ---------------------------------------------------
  setRange (value, rangeClass, isRemoved, isMobile) {
    let containerTags = $(this.containers.mobile).find('.m-filter-tags');

    // Cambiar valores filtros
    $(this.containers.mobile).find(`.${rangeClass}`)[0].noUiSlider.set(value);
    $(this.containers.desktop).find(`.${rangeClass}`)[0].noUiSlider.set(value);

    // EY
    if ( rangeClass === 'js-filter-rooms') {
      this.rooms= value;
      // Si no estamos eliminando el tag
      if ( !isRemoved ) {
        // Generamos o actualimos el tag
        ( !$(containerTags).find('[data-rooms]').length )
        ? this.createTag('rooms', value)
        : this.updateTag ('rooms', value);
      }
    }
    // EY
    if ( rangeClass === 'js-filter-meetingrooms') {
      this.meetingrooms= value;
      // Si no estamos eliminando el tag
      if ( !isRemoved ) {
        // Generamos o actualimos el tag
        ( !$(containerTags).find('[data-meetingrooms]').length )
        ? this.createTag('meetingrooms', value)
        : this.updateTag ('meetingrooms', value);
      }
    }
    // EY
    if ( rangeClass === 'js-filter-capacity') {
      this.capacity= value;
      // Si no estamos eliminando el tag
      if ( !isRemoved ) {
        // Generamos o actualimos el tag
        ( !$(containerTags).find('[data-capacity]').length )
        ? this.createTag('capacity', value)
        : this.updateTag ('capacity', value);
      }
    }
    // Precio: actualizar atributo filtro
    if ( rangeClass === 'js-filter-price') {
      this.price = value;
      // Si no estamos eliminando el tag
      if ( !isRemoved ) {
        // Generamos o actualimos el tag
        ( !$(containerTags).find('[data-price]').length )
        ? this.createTag('price', value)
        : this.updateTag ('price', value);
      }
    }

    // Distancia: actualizar atributo filtro
    if ( rangeClass === 'js-filter-distance') {
      this.nearTo.distance = value;

      // La referencia a location es diferente en desktop y mobile
      let actualLocation = this.nearTo.location.value;
      ( isMobile )
      ? actualLocation = $(this.containers.mobile).find('.js-filter-location.selectpicker').val()
      : actualLocation = this.nearTo.location.value;

      // Si no estamos eliminando el tag
      if ( !isRemoved ) {

        // Generamos o actualimos el tag
        ( !$(containerTags).find('[data-distance]').length && actualLocation && actualLocation !== 'invalid' )
        ? this.createTag('distance', value)
        : this.updateTag ('distance', value);
      }
    }

    // Filtrar hoteles
    this.filterHotels();
  }



  // ---------------------------------------------------
  // 4.B setServiceMobile -> Cambia el atributo de services (desde mobile)
  // ---------------------------------------------------
  setServiceMobile (values) {
    let filter = this;

    // -----------------------------------------
    // Actualización atributo servicios
    this.services = values;


    // -----------------------------------------
    // Actualización de filtro oculto
    $(this.containers.desktop).find('[data-service]').each(function (index, service) {
      let data = $(service).data('service');
      ( filter.services.includes(data) )
      ? $(service).addClass('is-active')
      : $(service).removeClass('is-active');
    });


    // -----------------------------------------
    // Generación de tags
    let containerTags = $(this.containers.desktop).find('.m-filter-tags')[0];
    let serviceTags = $(containerTags).find('[data-service]');
    let allServices =  $(this.containers.mobile).find('.filter-hotels-services [data-service]');

    if ( !serviceTags.length ) {
      this.services.forEach(value => this.createTag('service', value) );

    } else {

      $(allServices).each(function (index, service) {
        let isActive = $(service).hasClass('is-active');
        let data = $(service).data('service');
        let hasTag = $(containerTags).find(`[data-service=${data}]`);

        if ( isActive && (hasTag.length === 0) ) filter.createTag('service', data);
        else if ( !isActive && (hasTag.length > 0) ) filter.removeTag('service', data, true);
      });
    }

    this.filterHotels();
  }



  // ---------------------------------------------------
  // 4.C setServiceDesktop -> Cambia el atributo de services (desde desktop)
  // ---------------------------------------------------
  setServiceDesktop (value, isActive) {
    let filter = this;

    // -----------------------------------------
    // Actualización atributo servicios
    if ( isActive ) {
      if ( !this.services.includes(value) ) this.services.push(value);

    } else {
      if ( this.services.includes(value) ) {
        let index = this.services.indexOf(value);
        this.services.splice(index, 1);
      }
    }


    // -----------------------------------------
    // Actualización de filtro oculto
    $(this.containers.mobile).find('[data-service]').each(function (index, service) {
      let data = $(service).data('service');
      ( filter.services.includes(data) )
      ? $(service).addClass('is-active')
      : $(service).removeClass('is-active');
    });


    // -----------------------------------------
    // Generación de tags
    let containerTags = $(this.containers.desktop).find('.m-filter-tags')[0];
    let serviceTags = $(containerTags).find('[data-service]');

    // Si no hay tags de servicio lo creamos
    if ( !serviceTags.length ) {
      this.createTag('service', value);

      // Si hay tags de servicio se crea/elimina tag
    } else {
      ( isActive )
      ? this.createTag('service', value)
      : this.removeTag ('service', value, true);
    }

    this.filterHotels();
  }


  // ---------------------------------------------------
  // 4.D setRatingMobile -> Cambia el atributo de rating (desde mobile)
  // ---------------------------------------------------
  setRatingMobile (values) {
    let filter = this;

    // -----------------------------------------
    // Actualización atributo rating
    this.ratings = []; // Array con datos medios
    let simpleRatings = []; // Array auxiliar sin datos medios
    values.forEach(rating => {
      simpleRatings.push(rating);
      ( parseInt(rating) < 5 )
      ? this.ratings.push( rating.concat('.0'), rating.concat('.5') )
      : this.ratings.push(rating);
    });



    // -----------------------------------------
    // Actualización de filtro oculto
    $(this.containers.desktop).find('[data-rating]').each(function (index, rating) {
      let data = $(rating).data('rating');
      ( simpleRatings.includes(data.toString() ) )
      ? $(rating).prop('checked', true)
      : $(rating).prop('checked', false);
    });


    // -----------------------------------------
    // Generación de tags
    let containerTags = $(this.containers.desktop).find('.m-filter-tags')[0];
    let ratingTags = $(containerTags).find('[data-rating]');
    let allRatings =  $(this.containers.mobile).find('.trip.is-show [data-rating]');

    if ( !ratingTags.length ) {
      simpleRatings.forEach(value => this.createTag('rating', value) );

    } else {
      // Recorremos todas los rating para actualizarlas
      $(allRatings).each(function (index, rating) {

        // Está checkado, valor de rating y si tiene ya un tag con ese valor
        let isChecked = $(rating).prop('checked') ;
        let data = $(rating).data('rating');
        let hasTag = $(containerTags).find(`[data-rating=${data}]`);

        // Si está checkeado y no hay tag del valor lo creamos
        if ( isChecked && (hasTag.length === 0) ) filter.createTag('rating', data);

        // Si no está checkeado y hay tag del valor lo eliminamos
        else if ( !isChecked && (hasTag.length > 0) ) filter.removeTag('rating', data, true);
      });
    }

    this.filterHotels();
  }


  // ---------------------------------------------------
  // 4.E setRatingDesktop -> Cambia el atributo de rating (desde desktop)
  // ---------------------------------------------------
  setRatingDesktop (value, isChecked) {

    // Posibles valores dobles de ratings
    let ratingArray = value;
    if ( value === '4' ) ratingArray = ['4.0', '4.5'];
    else if ( value === '3' ) ratingArray = ['3.0', '3.5'];


    // Función auxiliar para eliminar un index de un array
    const deleteIndex = val => {
      let index = this.ratings.indexOf(val);
      this.ratings.splice(index, 1);
    }


    // -----------------------------------------
    // Actualización atributo ratings

    // Caso checkeado: comprobamos si está en el atributo y añadimos uno o dos valores
    if ( isChecked ) {
      if ( !this.ratings.includes(ratingArray) ) {
        ( ratingArray.length > 1 )
        ? ratingArray.forEach(rating => { this.ratings.push(rating) })
        : this.ratings.push(ratingArray);
      }

      // Caso no checkeado: si está incluído en el atributo quitamos uno o dos valores
    } else {

      if ( ratingArray.length > 1 ) {
        ratingArray.forEach(rating => {
          if ( this.ratings.includes(rating) ) deleteIndex(rating);
        });

      } else {
        if ( this.ratings.includes(ratingArray) ) deleteIndex(ratingArray);
      }
    }


    // -----------------------------------------
    // Actualización de filtro oculto
    let simpleRating = this.ratings.map(rating => parseInt(rating));
    $(this.containers.mobile).find('[data-rating]').each(function (index, rating) {
      let data = $(rating).data('rating');
      ( simpleRating.includes(data) )
      ? $(rating).prop('checked', true)
      : $(rating).prop('checked', false);
    });


    // -----------------------------------------
    // Generación de tags
    let containerTags = $(this.containers.desktop).find('.m-filter-tags')[0];
    let ratingTags = $(containerTags).find('[data-rating]');

    // Si no hay tags de rating lo creamos
    if ( !ratingTags.length ) {
      this.createTag('rating', value);

      // Si hay tags de servicio se crea/elimina tag
    } else {
      ( isChecked )
      ? this.createTag('rating', value)
      : this.removeTag('rating', value, true);
    }

    this.filterHotels();
  }


  // ---------------------------------------------------
  // 4.F setSorted -> Cambia el atributo de ordenar
  // ---------------------------------------------------
  setSorted (value) {
    let mobileSorted = $(this.containers.mobile).find('.js-filter-sort.selectpicker')[0];
    let desktopSorted = $(this.containers.desktop).find('.js-filter-sort.selectpicker')[0];

    // Actualizamos ambos filtros
    $(mobileSorted).val(value);
    $(mobileSorted).change();
    $(desktopSorted).val(value);
    $(desktopSorted).change();

    // Cambiamos valor y mandamos ordenar
    this.sortedBy = value;
    this.sortedGroups();
  }


  // ---------------------------------------------------
  // 4.G setCurrency -> Cambia el atributo de selected de currency
  // ---------------------------------------------------
  setCurrency (isChange) {

    // Selectores de todos los selects de moneda
    const mobileCurrency = $('#off-canvas-left-mob').find('#currency');
    const tabletCurrency = $('#off-canvas-menuLeft').find('.navMob .dropdown')[1];
    const desktopCurrency = $(this.containers.desktop).find('.js-filter-currency.selectpicker')[0];

    // Averiguar el value en cada caso de confirmación
    let value = null;
    ( isChange ) ? value = this.currency.aux : value = this.currency.selected;

    // cambiar valores de filtro mobile
    $(mobileCurrency).val(value);

    // cambiar valores de filtro tablet
    let optionValue = $(tabletCurrency).find(`[data-currency=${value}]`);
    $(tabletCurrency).find('.is-selected').removeClass('is-selected');
    $(optionValue).addClass('is-selected');
    $(tabletCurrency).find('a').html($(optionValue).text() + '<b class="caret"></b>');

    // cambiar valores de filtro desktop
    $(desktopCurrency).val(value);
    $(desktopCurrency).change();

    // Cambiamos valor de atributos moneda
    if ( isChange ) this.currency.origin = this.currency.selected;
    this.currency.selected = value;
    this.currency.aux = null;

    // Si cambia la divisa llamamos a cambiar precio
    if ( isChange ) this.changeHotelsCurrency();
  }


  // ---------------------------------------------------
  // 4.H setLocation -> Cambiar atributo localizacion (caso especial demasiado específico)
  // ---------------------------------------------------
  setLocation (value) {
    let mobileLocation = $(this.containers.mobile).find('.js-filter-location.selectpicker')[0];
    let desktopLocation = $(this.containers.desktop).find('.js-filter-location.selectpicker')[0];
    let mobileDistance = $(this.containers.mobile).find('.filter-hotels-distance')[0];
    let desktopDistance = $(this.containers.desktop).find('.filter-hotels-distance')[0];
    const filterSort = $('.js-filter-sort');

    // -------------------------------------------------
    // cambiar valores location
    $(mobileLocation).val(value);
    $(mobileLocation).change();
    $(desktopLocation).val(value);
    $(desktopLocation).change();


    // -------------------------------------------------
    // mostrar/ocultar distancia
    if ( value === 'invalid' ) {
      const filterSort = $('.js-filter-sort.selectpicker');
      $(mobileDistance).addClass('is-hidden');
      $(desktopDistance).addClass('is-hidden');

      // deshabilitar en el ordenar por poi
      $(filterSort).find("option[value^='poi-']").attr('disabled', 'disabled');

    } else {
      $(mobileDistance).removeClass('is-hidden');
      $(desktopDistance).removeClass('is-hidden');

      if ( value === this.locationCenter.value ) {
        $(filterSort).find("option[value^='poi-']").attr('disabled', 'disabled');

      } else {
        $(filterSort).find("option[value^='poi-']").removeAttr('disabled')
      }

    }

    // actualizar atributo filtro y selects de ordenar
    this.nearTo.location.value = value;
    this.nearTo.location.text = $(mobileLocation).find(`option[value=${value}]`).text();
    $(filterSort).selectpicker('render');


    // -------------------------------------------------
    // Generación de tags
    let containerTags = $(this.containers.mobile).find('.m-filter-tags');

    // Si no hay tags y el valor es válido
    if ( !$(containerTags).find('[data-location]').length ) {
      if ( value !== 'invalid' ) this.createTag('location', value, this.nearTo.location.text);

    } else {
      ( value === 'invalid' )
      ? this.removeTag ('location', value, true)
      : this.updateTag ('location', this.nearTo.location.text);
    }

    // Filtrar hoteles
    this.filterHotels();
  }



  // --------------------------------------------------------------------------------
  // 5.A filterHotels -> Recoger todos los datos relacionados con los hoteles
  // --------------------------------------------------------------------------------
  filterHotels () {
    let totalHotels = $(this.containers.result).find('.m-hotel-box').length;

    // Reiniciamos el contador de hoteles y los pois mostrados
    this.cont = 0;
    this.showPois = [];

    // Recorremos cada hotel
    this.containers.result.querySelectorAll('.m-hotel-box').forEach( (hotel, index) => {

      // ---------------------------------------------------
      // Objeto que almacena el data de cada hotel
      let hotelData = {
        price: hotel.dataset.price,
        services: hotel.dataset.services,
        pois: hotel.dataset.pois,
        rating: hotel.dataset.rating,
        rooms: hotel.dataset.rooms,
        meetingrooms: hotel.dataset.meetingrooms,
        capacity: hotel.dataset.capacity

      };


      // ---------------------------------------------------
      // Para saber si se muestra o no el hotel
      if ( this.canShowHotel (hotelData) ) {
        $(hotel).removeClass('is-hidden');
        this.cont++;
        this.showPois.push(hotel.dataset.backcode); // Almacenamos los backcode (actúan como ids)
      } else {
        $(hotel).addClass('is-hidden');
      }


      // ---------------------------------------------------
      // Actualizar el poi de cada card
      let poiHotel = $(hotel).find('.js-contact-poi');
      let templatePoi = { location: null, distance: null };


      // La localización no está definida (ponemos el poi center)
      if ( this.nearTo.location.value === 'invalid' || this.nearTo.location.value === null ) {
        templatePoi.location = JSON.parse(hotelData.pois)[0].location;
        templatePoi.distance = JSON.parse(hotelData.pois)[0].distance;
        $(poiHotel).html(`<strong>${templatePoi.distance} km</strong> ${templatePoi.location}`);


        // La localización ha cambiado respecto al card de hotel
      } else if ( $(poiHotel).val() !== this.nearTo.location.text ) {
        // Buscar poi seleccionado en el data del hotel
        let poiValue = JSON.parse(hotelData.pois).find(x => x.location === this.nearTo.location.text);

        // Si está el poi del select definido en el hotel refrescamos html
        if ( poiValue ) {
          templatePoi.location = poiValue.location;
          templatePoi.distance = poiValue.distance;
          $(poiHotel).html(`<strong>${templatePoi.distance} km</strong> ${templatePoi.location}`);

          // Si no tiene ese poi ocultamos el hotel
        } else {
          this.cont = this.cont--;
          $(hotel).addClass('is-hidden');
        }
      }

      // Hacer saltar el evento para filtrar los pois del mapa
      if ( index === (totalHotels-1) ) {
        $(this.containers.result).trigger("filterHotelsDone");
      }
    });

    //$(this.containers.result).trigger("filterHotelsDone");


    // ---------------------------------------------------
    // Actualizar contador de hoteles mostrados
    document.querySelectorAll(`.${this.page} .js-filter-hotels-number`).forEach(hotelCont => {
      return hotelCont.textContent = this.cont;
    });

    // Mostar div de no resultados si no hay hoteles
    ( !this.cont )
    ? $(this.containers.result).find('.m-alert').removeClass('is-hidden')
    : $(this.containers.result).find('.m-alert').addClass('is-hidden');

    // Comprobar si hay que mostrar/ocultar grupos de hoteles
    this.canShowHotelsGroup();
  }



  // --------------------------------------------------------------------------------
  // 5.B canShowHotel -> Comparar datos de hotel y filtro para saber si mostrar u ocultar
  // --------------------------------------------------------------------------------
  canShowHotel (hotelData) {

    // -------------------------------------------
    // Variables que guardan las comparaciones entre filtro y hotel
    let isPrice = false;
    let isServices = false;
    let isNearTo = false;
    let isRating = false;
    let isRooms = false;
    let isMeetingRooms = false;
    let isCapacity = false;

    // -------------------------------------------
    // Comprobaciones de atributos

    // Comprobamos precio
    let parsePrice = Math.round(parseFloat(hotelData.price));
    if ( this.price >= parsePrice ) isPrice = true;

    // Comparamos servicios
    let communServices = this.services.filter(x => JSON.parse(hotelData.services).includes(x));
    if ( this.services.length === 0 ) isServices = true;
    else if ( this.services.length === communServices.length ) isServices = true;

    // Comparamos pois
    let parseDistance = null;

    let isLocation = JSON.parse(hotelData.pois).find(x => x.location === this.nearTo.location.text);
    if ( isLocation !== undefined ) parseDistance = Math.round(parseFloat(isLocation.distance));

    if ( this.nearTo.location.value === 'invalid' || this.nearTo.location.value === null ) isNearTo = true;
    else if ( isLocation !== undefined && parseDistance <= this.nearTo.distance ) isNearTo = true;

    // Comparamos ratings
    if ( this.ratings.length === 0 ) isRating = true;
    else if ( this.ratings.includes(hotelData.rating) ) isRating = true;

    // Comparamos rooms
    let totalRooms = hotelData.rooms
    let numRooms =  this.rooms
    if ( totalRooms <= numRooms ) isRooms = true;

    // Comparamos meetingrooms
    let totalMeetingRooms = hotelData.meetingrooms
    let numMeetingRooms =  this.meetingrooms
    if ( totalMeetingRooms <= numMeetingRooms ) isMeetingRooms = true;

    // Comparamos capacidad
    let totalCapacity = hotelData.capacity
    let numCapacity =  this.capacity
    let filtersMe = $('.js-filter-me-hotels');

    if ( totalCapacity <= numCapacity ) isCapacity = true;

    if(filtersMe.length){
      // Si estamos en MICE y es todo true podremos visualizarlo
      if ( isPrice && isServices && isNearTo && isRating && isRooms && isMeetingRooms && isCapacity ) return true;
      else return false;
    }else {
      // Si es RP General todo true podremos visualizarlo
      if ( isPrice && isServices && isNearTo && isRating ) return true;
      else return false;
    }
    // -------------------------------------------

  }

  // --------------------------------------------------------------------------------
  // 5.C canShowHotelsGroup -> Contar hoteles visibles para saber si mostrar/ocultar grupo
  // --------------------------------------------------------------------------------
  canShowHotelsGroup () {
    let filter = this;

    $(this.groups).each(function (index, hotelGroupData) {
      let groupContainer = $(filter.containers.result).find(`[data-hotels-group=${hotelGroupData}]`);
      let totalHotels = 0;
      let hiddenHotels = 0;

      $(groupContainer).find('.m-hotel-box').each(function (index, hotel) {
        totalHotels++;
        if ( $(hotel).hasClass('is-hidden') ) hiddenHotels++;
      });

      ( totalHotels === hiddenHotels )
      ? $(groupContainer).addClass('is-hidden')
      : $(groupContainer).removeClass('is-hidden');
    });

    // Quitar disabled filtros
    setTimeout(() => { this.loadingHotels(false); }, 1000);
  }



  // --------------------------------------------------------------------------------
  // 5.D getShowPois -> Devuelve el backcode de los hoteles que se mostrarán en el mapa al filtrar
  // --------------------------------------------------------------------------------
  getShowPois () {
    return this.showPois;
  }



  // --------------------------------------------------------------------------------
  // 6.A sortedGroups -> Según el valor del select se tienen que ordenar en unos grupos u otros
  // --------------------------------------------------------------------------------
  sortedGroups () {
    let sortedGroups = this.groups;

    // Ordenar por precios solo ordena los disponibles
    if ( this.sortedBy === 'price-asc' || this.sortedBy === 'price-desc' ) {
      sortedGroups = ["promo", "promo-near", "stock", "stock-near"];

      // Ordenar por distancia al centro cambia el valor de distancia de filtros desktop y mobile
    } else if ( this.sortedBy === 'center-asc' || this.sortedBy === 'center-desc' ) {

      let mobileLocation = $(this.containers.mobile).find('.js-filter-location.selectpicker')[0];
      let desktopLocation = $(this.containers.desktop).find('.js-filter-location.selectpicker')[0];

      $(mobileLocation).val(this.locationCenter.value);
      $(mobileLocation).change();

      $(desktopLocation).val(this.locationCenter.value);
      $(desktopLocation).change();

      // Volvemos a setear de centro
      this.setLocation(this.locationCenter.value);
      this.loadingHotels(true);

      // Mostrar distancia en los dos filtros
      $(this.containers.mobile).find('.filter-hotels-distance').removeClass('is-hidden');
      $(this.containers.desktop).find('.filter-hotels-distance').removeClass('is-hidden');
    }

    // Ordenamos los hoteles de cada grupo
    sortedGroups.forEach(group => this.sortedHotels(group));
  }



  // --------------------------------------------------------------------------------
  // 6.B sortedHotels -> Pasamos el grupo para que ordene según el valor seleccionado
  // --------------------------------------------------------------------------------
  sortedHotels (group) {
    let filter = this;
    let sortResult = null;

    let listsGroup = $(this.containers.result).find(`[data-hotels-group=${group}]`);
    let hotelsGroup = $(listsGroup).find('.m-hotel-box').detach();
    hotelsGroup = Array.prototype.slice.call(hotelsGroup, 0);


    // Función de comparación para ordenar en la mayoría de los casos
    const genericCompare = (filterValue, paramA, paramB) => {
      ( filter.sortedBy === filterValue )
      ? sortResult = paramA > paramB ? 1 : -1
      : sortResult = paramA < paramB ? 1 : -1;
    };


    // Evitar los grupos de hoteles que están vacíos
    if ( hotelsGroup.length > 0 ) {

      hotelsGroup.sort(function (hotelA, hotelB) {
        switch (filter.sortedBy) {

          // ----------------------------------------------------------
          // Ordenar por nh recomendaciones
          case 'nh-recommends':
            var recommendA = parseInt($(hotelA).data('recommend'));
            var recommendB = parseInt($(hotelB).data('recommend'));
            sortResult = recommendA > recommendB ? 1 : -1;
            break;


          // ----------------------------------------------------------
          // Ordenar por precios
          case 'price-asc':
          case 'price-desc':
            var priceA = parseFloat($(hotelA).data('price'));
            var priceB = parseFloat($(hotelB).data('price'));
            genericCompare('price-asc', priceA, priceB);
            break;


          // ----------------------------------------------------------
          // Ordenar por nombre de hotel
          case 'name-asc':
          case 'name-desc':
            var titleA = $.trim($(hotelA).data('title'));
            var titleB = $.trim($(hotelB).data('title'));
            genericCompare('name-asc', titleA, titleB);
            break;


          // ----------------------------------------------------------
          // Ordenar por rating de hotel
          case 'rating-asc':
          case 'rating-desc':
            var ratingA = parseFloat($(hotelA).data('rating'));
            var ratingB = parseFloat($(hotelB).data('rating'));
            genericCompare('rating-asc', ratingA, ratingB);
            break;



          // ----------------------------------------------------------
          // Ordenar por distancia al poi
          case 'poi-asc':
          case 'poi-desc':
            // Asegurarnos que tienen data del poi seleccionado
            let dataA = $(hotelA).data('pois').filter(poi => poi.location === filter.nearTo.location.text);
            let dataB = $(hotelB).data('pois').filter(poi => poi.location === filter.nearTo.location.text);

            // Asegurarnos que el nearto esté inicializado
            if ( !filter.nearTo.location.value ) {
              let mobileLocation = $(filter.containers.mobile).find('.js-filter-location.selectpicker option:selected');
              filter.nearTo.location.text = mobileLocation.text();
              filter.nearTo.location.value = mobileLocation.val();
            }

            if ( !$.isEmptyObject(dataA) && !$.isEmptyObject(dataB) ) {

              // Calculamos la distancia para ordenar
              let distanceA =  parseFloat(dataA[0].distance);
              let distanceB =  parseFloat(dataB[0].distance);
              genericCompare( 'poi-asc', distanceA, distanceB );

            } else if ( $.isEmptyObject(dataA) || $.isEmptyObject(dataB) ) {
              if ( $.isEmptyObject(dataA) ) sortResult = 1;
              if ( $.isEmptyObject(dataB) ) sortResult = -1;
            }
            break;



          // ----------------------------------------------------------
          // Ordenar por distancia al centro de la ciudad
          case 'center-asc':
          case 'center-desc':
            // Cogemos de cada hotel la distancia del array de pois en data que corresponda al centro
            var centerA = parseFloat($(hotelA).data('pois').filter(poi => poi.location === filter.locationCenter.text)[0].distance);
            var centerB = parseFloat($(hotelB).data('pois').filter(poi => poi.location === filter.locationCenter.text)[0].distance);
            genericCompare('center-asc', centerA, centerB);
            break;



          // ----------------------------------------------------------
          // Ordenar por ubicación actual (solo móvil)
          case 'close-to-me':
            var origin = { lat: filter.geolocation.latitude, lng: filter.geolocation.longitude};

            // Calcular distancia del geolocation al hotelA
            var latitudeA = $(hotelA).data('coordinates').latitude;
            var longitudeA = $(hotelA).data('coordinates').longitude;
            var distanceA = utils.getDistanceBetweenCoords ( origin, { lat: latitudeA, lng: longitudeA });

            // Calcular distancia del geolocation al hotelB
            var latitudeB = $(hotelB).data('coordinates').latitude;
            var longitudeB = $(hotelB).data('coordinates').longitude;
            var distanceB = utils.getDistanceBetweenCoords ( origin, { lat: latitudeB, lng: longitudeB });

            // Función comparadora de distancias de menor a mayor
            sortResult = parseFloat(distanceA) > parseFloat(distanceB) ? 1 : -1;
            break;
        }

        return sortResult;
      });
    }


    // Repintar los hoteles en los divs de los grupos
    for (let i = 0; i < hotelsGroup.length; i++) {
      $(listsGroup).append(hotelsGroup[i]);
    }


    // Quitar disabled filtros
    setTimeout(() => { this.loadingHotels(false); }, 1000);
  }




  // --------------------------------------------------------------
  // 7.A currencyModal -> Controlar cambio de moneda (modal currency)
  // --------------------------------------------------------------
  currencyModal (value) {
    let filter = this;

    // si la moneda cambia abrimos la modal de confirmación de cambio de moneda
    if ( value !==  this.currency.selected ) {
      $('#modal-filter-currency').modal('show');

      // Almacenamos en auxiliar hasta confirmación de cambio de moneda
      filter.currency.aux = value;
    }
  }


  // --------------------------------------------------------------------------------
  // 7.B changeHotelsCurrency -> Cambiar la moneda en todos los hotel cards
  // --------------------------------------------------------------------------------
  changeHotelsCurrency () {
    let filter = this;

    // ------------------------------------------------------------
    // Obtener el rate adecuado para cambiar la divisa

    // Con array de conversión de todas las monedas
    // let arrayConversionOrigin = this.currencyConversions.currencies.filter(currency => currency.cur_origin === this.currency.origin);
    // let conversionDestination = arrayConversionOrigin[0].conversions.filter(currency => currency.cur_dest === this.currency.selected);
    // let conversionRate = parseFloat(conversionDestination[0].rate);

    // Con array de conversión solo de EUR
    let conversionDestination = this.currencyConversions.filter(currency => currency.cur_dest === this.currency.selected);
    let conversionRate = parseFloat(conversionDestination[0].rate);


    // ------------------------------------------------------------
    // Cambiar precio y divisa en cada hotel

    // Solo cogemos los grupos de hoteles con precio
    let hotelGroupsPrices = ["promo", "promo-near", "stock", "stock-near"];

    // Recorremos los grupos
    $(hotelGroupsPrices).each(function (index, hotelGroupData) {
      let groupContainer = $(filter.containers.result).find(`[data-hotels-group=${hotelGroupData}]`);

      // Recorremos los hoteles de cada grupo
      $(groupContainer).find('.m-hotel-box').each(function (index, hotel) {
        let newCurrency = filter.currency.selected;

        // Calcular nuevo precio
        let newPrice = parseFloat($(hotel).data('euro')) * conversionRate;
        newPrice = (Math.round(newPrice * 100) / 100).toFixed(2);

        // Cambiar data de hotel
        $(hotel).attr('data-price', newPrice);
        $(hotel).attr('data-currency', newCurrency);

        // Cambiar info de hotel
        $(hotel).find('.js-price').text(newPrice);
        $(hotel).find('.js-currency').text(newCurrency);
      });
    });



    // ------------------------------------------------------------
    // Actualizar slider de precios con el precio más alto

    // Conseguir array de precios en promo, promo-near, stock y stock-near
    let pricesPromo = [];
    let pricesPromoNear = [];
    let pricesStock = [];
    let pricesStockNear = [];

    $('[data-hotels-group=promo]').find('.totalPrice').each(function (index, price) {
      pricesPromo.push(parseFloat($(price).text()));
    });
    $('[data-hotels-group=promo-near]').find('.totalPrice').each(function (index, price) {
      pricesPromoNear.push(parseFloat($(price).text()));
    });
    $('[data-hotels-group=stock]').find('.totalPrice').each(function (index, price) {
      pricesStock.push(parseFloat($(price).text()));
    });
    $('[data-hotels-group=stock-near]').find('.totalPrice').each(function (index, price) {
      pricesStockNear.push(parseFloat($(price).text()));
    });

    // Fusionar los dos arrays y ordenarlos de mayor a menor
    let arrayPrices = [...pricesPromo, ...pricesPromoNear, ...pricesStock, ...pricesStockNear];
    arrayPrices.sort(function(a, b) { return b - a; });

    // Cambiar los rangos de filtros de precio y setearlos al máximo valor
    let rangeMobile = $(this.containers.mobile).find('.js-filter-price')[0];
    let rangeDesktop = $(this.containers.desktop).find('.js-filter-price')[0];
    let finalPrice = Math.round(arrayPrices[0]) + 1;

    // Opciones comunes de ambos range (resetear format para actualizar moneda)
    let rangeOptions = {
      range: { 'min': 0, 'max': finalPrice },
      format: {
        from: Number,
        to: function (value) { return Math.round(parseInt(value)) + ' ' + filter.currency.selected; }
      }
    };

    // Range price de móvil -> cambiar opciones y máximo
    rangeMobile.noUiSlider.updateOptions(rangeOptions);
    rangeMobile.noUiSlider.set(finalPrice);

    // Range desktop de móvil -> cambiar opciones y máximo
    rangeDesktop.noUiSlider.updateOptions(rangeOptions);
    rangeDesktop.noUiSlider.set(finalPrice);


    // Actualizar el tag de precio si hay alguno creado
    // Cambiar tag asociado al precio
    let containerTags = $(this.containers.mobile).find('.m-filter-tags');
    if ( $(containerTags).find('[data-price]').length ) {
      this.updateTag ('price', finalPrice);
    }


    // Quitar disabled filtros
    setTimeout(() => { this.loadingHotels(false); }, 1000);
  }



  // --------------------------------------------------------------------------------
  // 8.A CreateTag -> Genera un tag de un elemento (precio) o grupos de elementos (servicios) filtrados
  // --------------------------------------------------------------------------------
  createTag (data, value, text) {
    let filter = this;

    // Texto extra de tags específicos
    let templateText = value;
    if ( data === 'price' ) templateText = `${value} ${this.currency.selected}`;
    if ( data === 'rating' ) templateText = `<div class='tripadvisor rating-${value}'></div>`;
    if ( data === 'location' ) templateText = text;
    let labelFiltersLessThan = (typeof pageData.labelFiltersLessThan != "undefined") ? pageData.labelFiltersLessThan : ""
    if ( data === 'distance' ) templateText = `${labelFiltersLessThan} ${value} km`;
    if ( data === 'rooms' ) templateText = `Rooms`;
    if ( data === 'meetingrooms' ) templateText = `Meetings rooms`;
    if ( data === 'capacity' ) templateText = `Capacity`;

    // Estructura básica de un tag
    let tagTemplate = `<div class='filter-tag' data-${data}=${value}>
    <span class="js-filter-tag-value">${templateText}</span>
    <button class="btn-ico js-filter-tag-remove" type="button" aria-label="Close">
    <span class="nh-ic-close" aria-hidden="true"></span>
    </button>
    </div>`;

    // Agregar el tag en los contenedores (desktop & mobile)
    $(this.containers.mobile).find('.m-filter-tags').append(tagTemplate);
    $(this.containers.desktop).find('.m-filter-tags').append(tagTemplate);

    // Crear escuchador del remove (desktop & mobile)
    $(`.filter-tag[data-${data}=${value}]`).find('.js-filter-tag-remove').each(function (index, element) {
      $(element).click(function (e) {
        e.preventDefault();
        filter.removeTag(data, value); });
      });
    }



    // --------------------------------------------------------------------------------
    // 8.B updateTag -> Modificar tags existentes cuando cambia su valor de filtro
    // --------------------------------------------------------------------------------
    updateTag (data, text) {

      // Textos personalizados de ciertos tags
      let tagText = text;
      if ( data === 'price' ) tagText = `${text} ${this.currency.selected}`;
      let labelFiltersLessThan = (typeof pageData.labelFiltersLessThan != "undefined") ? pageData.labelFiltersLessThan : ""
      if ( data === 'distance' ) tagText = `${labelFiltersLessThan} ${text} km`;
      if ( data === 'rooms' ) tagText = `Rooms ${text}`;
      if ( data === 'meetingrooms' ) tagText = `Meeting rooms ${text}`;
      if ( data === 'capacity' ) tagText = `Capacity ${text}`;

      // Actualización de tags en ambos dispositivos
      $(this.containers.mobile).find(`.m-filter-tags [data-${data}] .js-filter-tag-value`).text(tagText);
      $(this.containers.desktop).find(`.m-filter-tags [data-${data}] .js-filter-tag-value`).text(tagText);
    }



    // --------------------------------------------------------------------------------
    // 8.C removeTag -> Eliminar tags existentes y volver a filtrar
    // --------------------------------------------------------------------------------

    // controlTag -> parametro que se lanza para evitar acumulación en pila de llamadas (services)
    removeTag (data, value, controlTag) {
      const filter = this;

      // ----------------------------------------------------
      // Selectores que difieren en campos múltiples (service y rating)
      let dataSelector = $(`.filter-tag[data-${data}]`);
      if ( data === 'service' || data === 'rating' )
      dataSelector = $(`.filter-tag[data-${data}=${value}]`);


      // ----------------------------------------------------
      // Quitamos eventos y eliminamos tag (desktop & mobile)
      $(dataSelector).each(function (index, element) {
        $(element).find('.js-filter-tag-remove').off();
        $(element).remove();
        filter.loadingHotels(true);
      });


      // ----------------------------------------------------
      // Seteamos los atributos dependiendo del data
      switch (data) {

        // Actualizar precio
        case 'price':
        // Recuperamos el valor máximo del range de precio
        var newValue = $(this.containers.desktop).find('.js-filter-price')[0].noUiSlider.options.range.max;
        this.setRange([newValue], 'js-filter-price', true);
        break;

        // Actualizar atributo servicio y desactivar del filtro
        case 'service':
        if ( !controlTag ) {
          this.services.splice(this.services.indexOf(value), 1);
          $(this.containers.mobile).find(`[data-service=${value}]`).removeClass('is-active');
          $(this.containers.desktop).find(`[data-service=${value}]`).removeClass('is-active');
          this.filterHotels();
        }
        break;

        // Actualizar atributo ratings y desactivar del filtro
        case 'rating':
        if ( !controlTag ) {

          // Controlar si es valor sencillo o múltiple
          let ratingArray = value;
          if ( value === '4' ) ratingArray = ['4.0', '4.5'];
          else if ( value === '3' ) ratingArray = ['3.0', '3.5'];

          // Eliminar ratings
          const deleteIndex = val => {
            let index = this.ratings.indexOf(val);
            this.ratings.splice(index, 1);
          }

          // Eliminar valor sencillo o múltiple del atributo
          ( ratingArray.length > 1 )
          ? ratingArray.forEach(rating => deleteIndex(rating) )
          : deleteIndex(ratingArray);

          // Actualizar filtros y filtrar hoteles
          $(this.containers.mobile).find(`[data-rating=${value}]`).prop('checked', false);
          $(this.containers.desktop).find(`[data-rating=${value}]`).prop('checked', false);
          this.filterHotels();
        }
        break;

        // Actualizar location
        case 'location':
        // Solo si se invoca el borrar desde el cierre del tag (X)
        if ( !controlTag ) this.setLocation('invalid');

        // Si hay un tag de distancia, lo quitamos
        var tagDistance = $(this.containers.desktop).find('.m-filter-tags [data-distance]') ;
        if ( tagDistance ) $(tagDistance).find('.js-filter-tag-remove').trigger('click');
        break;

        // Actualizar distancia
        case 'distance':
        // Recuperamos el valor máximo del range
        var maxValue = $(this.containers.desktop).find('.js-filter-distance')[0].noUiSlider.options.range.max;
        this.setRange([maxValue], 'js-filter-distance', true);
        break;

        // Actualizar rooms
        case 'rooms':
        // Recuperamos el valor máximo del range
        var maxRooms = $(this.containers.desktop).find('.js-filter-rooms')[0].noUiSlider.options.range.max;
        this.setRange([maxRooms], 'js-filter-rooms', true);
        this.maxRooms.splice(this.maxRooms.indexOf(value), 1);
        $(this.containers.mobile).find(`[data-rooms=${value}]`).removeClass('is-active');
        $(this.containers.desktop).find(`[data-rooms=${value}]`).removeClass('is-active');
        this.filterHotels();

        break;
        // Actualizar rooms
        case 'meetingrooms':
        // Recuperamos el valor máximo del range
        var maxMeetingRooms = $(this.containers.desktop).find('.js-filter-meetingrooms')[0].noUiSlider.options.range.max;
        this.setRange([maxMeetingRooms], 'js-filter-meetingrooms', true);
        break;
        // Actualizar rooms
        case 'capacity':
        // Recuperamos el valor máximo del range
        var maxCapacity = $(this.containers.desktop).find('.js-filter-capacity')[0].noUiSlider.options.range.max;
        this.setRange([maxCapacity], 'js-filter-capacity', true);
        break;



        default:
        break;
      }
    }



    // --------------------------------------------------------------------------------
    // 9.A formatRange -> Función auxiliar que recoge el valor numérico de un string (p.e. '12 EUR')
    // --------------------------------------------------------------------------------
    formatRange (rangeValue, filter) {
      if ( !filter ) rangeValue = rangeValue[0];
      let splitRange = rangeValue.split(' ');
      return parseInt(splitRange[0]);
    }

    // --------------------------------------------------------------------------------
    // 9.B loadingHotels -> Deshabilita los filtros desktop hasta que termine todo el proceso
    // --------------------------------------------------------------------------------
    loadingHotels (isDisabled) {
      ( isDisabled )
      ? $(this.containers.desktop).addClass('is-disabled')
      : $(this.containers.desktop).removeClass('is-disabled');
    }


    // --------------------------------------------------------------------------------
    // 10. Reset -> Reiniciar el filtro (p.e. cuando se busca otra ciudad)
    // --------------------------------------------------------------------------------
    reset (page) {
      // Atributos generales de la página
      this.page = page; // clase descriptiva del main de la página
      this.containers = { mobile: null, desktop: null, result: null };
      this.cont = 0; // contador de hoteles mostrados

      // Atributos de ordenación
      this.sortedBy = null;
      this.groups = [];

      // Atributos moneda
      this.currency = { origin: 'EUR', selected: 'EUR', aux: null };
      this.currencyConversions = []; // array de conversiones con euro de origen

      // Atributos de formulario del filtro
      this.price = null;
      this.services = [];
      this.nearTo = { location: { value: null, text: null }, distance: null };
      this.locationCenter = { value: null, text: null};
      this.ratings = [];

      // Geolocalización solo para móviles
      this.geolocation = { latitude: null, longitude: null };
      this.showPois = [];

      // Atributos de m&e
      this.rooms = null;
      this.meetingrooms = null;
      this.capacity = null;

    }
  }


var mMeetingRoom = (() => {
  /**
  * Init Fn
  */
  function init() {
    if ($('#me-search-bar').length) {
      var stickyStart = $('#me-search-bar').offset();
      var stickyStyked = stickyStart.top;
      $(window).scroll(function () {
        var scrollTop = $(window).scrollTop();
        if (scrollTop > stickyStyked) {
          $('#me-search-bar').addClass('sticked');
        } else {
          $('#me-search-bar').removeClass('sticked');
        }
      });
    }
    // Ey, funcion onEvents
    onEvents();
  }
  function onEvents() {
    //EY force slicer to resize when is in a tab
    $('a[data-toggle="tab"]').on('shown.bs.tab', function () {
      $('.slick-slider').resize();
    });

    //EY track button header

    $('#requestQuoteHeader').click(function(){
      //Ey, Track values
      var page_section= "Mice";
      var fieldSearch = $(".hotelSeleccionadoSpan");
      var nrooms = $("[name = 'nhabitaciones']").val();
      //trackMiceRequestQuoteBuscador(page_section,fieldSearch, nrooms);
    });


    //EY check if two or mere hotels are selected
    function checkHotelsSelected() {
      var numSelectedHotels = $('.m-hotel-box').length;
      if (numSelectedHotels === 1) {
        $('.js-remove-this').addClass('hide');
      } else {
        $('.js-remove-this').removeClass('hide');
      }
    }
    checkHotelsSelected();

    //EY remove cards
    $("body").on(
      'click', '.js-remove-this', function () {
        $(this).closest('.m-hotel-box').remove();
        //--Num of hotels selected
        selectedCountHotels();
        //--Restore Hotel selected
        var restoredHotel = $(this).closest('.m-hotel-box').attr('data-title');
        var $this = $('[data-title="' + restoredHotel + '"]');
        var newText = $this.find('.js-select-hotel').attr('data-default-text');
        var $id =  $this.closest('.m-hotel-box').data('idhotel');
        $this.find('.js-select-hotel').attr('disabled', false);
        $this.find('.js-select-hotel').text(newText);
        //--check how hotels are selected
        checkHotelsSelected();
        //--Remove Selected hotel
        removeSelectedHotel($id);
      });
      //EY meetings js
      $('#every-day').click(function () {
        if ($(this).is(":checked")) {
          $("input:checked").each(function () {
            var sameField = $(this).attr('data-fieldset');
            $('[data-fieldset=' + sameField + ']').attr('checked', true);
          });
        }
      });
      $('input:checkbox').click(function () {
        var inputId = $(this).attr('id');
        if (inputId != 'every-day') {
          $('#every-day').attr('checked', false);
        }
      });
      $("body").on('click', '.js-select-hotel', function () {

        //--Clone card
        var hotelToClone = $(this).closest('.m-hotel-box');
        var hotelCloned = hotelToClone.clone();
        var destinyLayer = hotelCloned.find('.m-hotel-box-name');

        //--Insert card to destiny container
        hotelCloned.appendTo("#selected-hotels").addClass('cloned-hotel');
        hotelCloned.find('.m-hotel-box-info-detail').insertAfter(destinyLayer);

        //--Data Hotel
        var idHotel = hotelToClone.data('idhotel');
        var nameHotel = hotelToClone.data('title');
        var locationHotel = hotelToClone.data('locationhotel');
        var backCodeHotel = hotelToClone.data('backcode');
        var rooms = hotelToClone.data('rooms');
        var mRooms = hotelToClone.data('meetingrooms');
        var capacity = hotelToClone.data('capacity');
        var sMeters = hotelToClone.data('meters');
        var stars = hotelToClone.data('stars');
        var url = hotelToClone.data('url');

        //--Create empty span to track hotel
        $('<span class="hotelSeleccionadoSpan" id="'+idHotel+'"></span>').appendTo(hotelCloned);

        //--Num of hotels selected
        selectedCountHotels();

        //--add Selected hotel
        //console.log(idHotel, nameHotel, locationHotel, backCodeHotel, rooms, mRooms, capacity, sMeters, stars, url);
        addSelectedHotel( idHotel, nameHotel, locationHotel, backCodeHotel, rooms, mRooms, capacity, '0', '4', url);

        //--Disable button
        var newText = $(this).attr('data-selected-text');
        var $this = $(this);
        $(this).text(newText);
        //-- Wait for modal show
        setTimeout(
          function () {
            $this.attr('disabled', true);
          }, 500);
        });
      }
      // Ey, Request Quote form modal
      $('#requestQuoteModal').click(function () {
        //Ey, Track values
        var page_section= "Mice";
        var fieldSearch = $(".hotelSeleccionadoSpan");
        var nrooms = $("[name = 'nhabitaciones']").val();
        //trackMiceRequestQuoteBuscador(page_section,fieldSearch, nrooms);

        $('#solicitar_presupuesto').submit();
      });

      // Ey, funcion add select hotel
      function addSelectedHotel(idHotel, nameHotel, locationHotel, backCodeHotel, rooms, mRooms, capacity, sMeters, stars, url) {
        var postInfo = { id: idHotel, name: nameHotel, location: locationHotel, backCode: backCodeHotel, rooms: rooms, meetingRooms: mRooms, capacity: capacity, sMeters: sMeters, url: url, stars: stars };

        $.ajax({
          type: "POST",
          url: '/booking/meetings/anadirHotelSeleccionado.html',
          data: postInfo,
          success: (function (result) {
            if (result) {
              console.log(postInfo);
              return postInfo;
            } else {
              alert("The hotel is already included in your selected hotel list");
            }
          })
        });

      }

      // Ey, function removeSelectedHotel select hotel

      function removeSelectedHotel(idHotel){
        var postInfo = {id: idHotel};
        $.ajax({
          type: "POST",
          url: '/booking/meetings/eliminarHotelSeleccionado.html',
          data: postInfo,
          success:(function(result){
            if(result){
              console.log(postInfo);
              return postInfo;
            }else{
              alert('Atención, el hotel indicado no se ha podido eliminar de su lista de selección.');
            }
          })
        });
      }


      function selectedCountHotels() {
        var numSelectedHotels = $('.cloned-hotel').length;
        $('.js-selected-hotels').html(numSelectedHotels);
        if (numSelectedHotels > 0) {
          $('.selected-hotels').addClass('visible');
        } else {
          $('.selected-hotels').removeClass('visible');
        }
      }
      return {
        init: init
      };
    })();
    $(() => {
      if ($('main.me').length) {
        mMeetingRoom.init();
      }
    });

var checkout = (() => {
  //se podría añadir una clase común a las páginas de checkout para evitar esto. ver el final del archivo, porque esta la misma problematica
  //var checkoutView = $('.p-bp-checkout').add('.p-bp-checkout-fase-1-b2b-company').add('.p-bp-checkout-fase-1-b2b-agency');
  var checkoutView = $('.p-bp-checkout');
  var $checkoutForm = checkoutView.find('form.form-checkout'); //visible form to be filled by the customer
  var $checkoutFormToSend = checkoutView.find('form.form-checkout-to-send');//hidden form to send
  var $bottonSubmit = $checkoutForm.find("button[type=submit]");
  var $checkAccountRewards = $(".js-account-rewards"); //checkbox aceptar rewards conditions and rewards policy
  var needBillCheckbox = $checkoutForm.find('#need-bill');
  var $otherGuests = checkoutView.find('#other-guests');
  var $otherGuestsCheckbox =  $otherGuests.find('#booking-other'); //checkbox booking for other host
  var infoBillFieldset = $checkoutForm.find('#info-bill');
  var copyReservationInfoCheck = infoBillFieldset.find('#copy-info');
  var finalPrice = checkoutView.find('.js-final-price');
  var garanteeCheck = $checkoutForm.find('.js-garantee-modal');
  var modalGarantee = $("#modal-garantee");

  // Bill Inputs
  var needBillRequiredInputs;
  var billFormCountry = infoBillFieldset.find('#country-bill');
  var cifInput = infoBillFieldset.find('#pc-nif');

  var otherGuestsRequiredInputs = $checkoutForm.find('#other-guests :input[required]');
  var currentPage  = null; //flexible or prepayment
  var $garanteeReservationField = $("input#garantee-reservation");
  var personalizeRooms =  $('.m-customize-room-detail').find(".panel .collapse");
  var $sessionExpireModal = $("#modal-session-expire");
  var $sessionExpireCounter = $sessionExpireModal.find(".js-time-counter");
  var $sessionExpireMessageModal = $("#modal-expired-message");
  var sessionExpired = false;
  var yourSearchSubmitButton = checkoutView.find('#your-search-submit-button');
  //customer data to store current logged user
  var customer = {
    hasCredit : false,
    isB2B: false,
    isAgency : false,
    isB2EFriends : false,
    isTravelAgent : false,
    isB2EEmployee : false
  };

  var timeIntervals = [];
  if(typeof pageData !== "undefined"){
    var userLoggedFields = {
      name: {
        class:".js-logged-name",
        dataKey: "name",
        value: null
      },
      surname: {
        class:".js-logged-surname",
        dataKey: "surname",
        value: null
      },
      mail: {
        class:".js-logged-email",
        dataKey: (pageData.isRewards === "true") ? "customerEmail" : "email",
        value: null
      },
      telephone: {
        class:".js-logged-telephone",
        dataKey: "telephone",
        value: null
      },
      points: {
        class:".js-logged-points",
        dataKey: "customerTotal",
        value: null
      },
      program: {
        class:".js-logged-program",
        dataKey: "customerProgram",
        value: null
      },
      category: {
        class:".js-logged-category",
        dataKey: "customerCategoryDescription",
        value: null
      },
      party: {
        class:"#inputPartyId",
        dataKey: "partyId",
        value: null
      }
    };
  };
  var guestFields;

  function init() {
    if(typeof pageData !== "undefined") {
      //show java error
      if(typeof pageData.javaError !== "undefined" && pageData.javaError === "true") {
        _showJavaError();
      }

      //Set customer logged data
      //usamos parseJSON para convertir "true" en true y "false" en false
      $.each(customer, function(key,value) {
        customer[key] = pageData[key] ? $.parseJSON(pageData[key]) : false;
      });
    }

    //get the current page type
    currentPage = _getCurrentPage();

    //preparamos la validación de los formularios
    $checkoutForm.validator({
      disable: false,
      custom: {
        'docNumber': _customDocumentNumberValidator,
      }
    }).on('submit', _onFormSubmit);
    // .off('input.bs.validator focusout.bs.validator');

    yourSearchSubmitButton.on('click', (e) => {
      $checkoutForm.submit();
    });
    
    // Cargamos los inputs después de haber sido inicializados
    needBillRequiredInputs = infoBillFieldset.find(':input[required]');

    //Submit form from  aside module your search
    //TODO: si el boton de reservar va a desparecer del aside esto no haría falta
    $('.js-submit-form-checkout').on('click', function(){
      $checkoutForm.find('[type="submit"]').trigger('click');
    });

    _beforeUnloadSession();
    _setNationalityField();

    _initializeCounterClock(); //inicializamos la cuenta atras del contador
    _handleSessionExpiredCountdownModal(); //gestionamos la modal de aviso de que expira la sesión(cuenta atrás).
    timeIntervals.push(_initSessionExpiredCountdown()); // inicializamos el contador de sesión para mostra la modal de sesion terminada
    _setSessionExpiredCountdownModalTimeout(); //seteamos el timeout para mostar la modal con la cuenta atras del tiempo de sesión

    $checkAccountRewards.on("change", _toggleNationalityField);
    $garanteeReservationField.on("change", _guaranteeActions);
    //$otherGuestsCheckbox.on("change", _onOtherGuestsChange);
    $otherGuests.on('shown.bs.collapse hidden.bs.collapse', _onOtherGuestsChange);
    needBillCheckbox.on('change', _onNeedBillChange);
    infoBillFieldset.on('shown.bs.collapse hidden.bs.collapse', _onInfoBillToggles);
    //infoBillFieldset.find('#personalInvoice').on('change', _onPersonallBillChange);
    //infoBillFieldset.find('#businessInvoice').on('change', _onBussinessBillChange);
    copyReservationInfoCheck.on('change', _copyReservationData);
    $(".js-update-filter #payment-type").on("change", _toggleGuaranteeCheckbox);
    $checkoutForm.find("#agency-service").on("change", _setupAgencyService);
    billFormCountry.on('change', _onBillCountrySelectorChange);
    garanteeCheck.on('change', _onGaranteeChange);

    guestFields = {
      $otherGuestNameSurname: $checkoutForm.find('#name-surname-guest-checkout'),
      $guestNameSurname: $checkoutForm.find('#name-surname-checkout'),
      get guestNameSurnameFields() {
         var $guestNameSurnameFields = this.$otherGuestNameSurname.add(this.$guestNameSurname);
         return $guestNameSurnameFields;
      },
      $otherGuestName: $checkoutForm.find('#name-guest-checkout'),
      $guestName: $checkoutForm.find('#name-checkout'),
      get guestNameFields() {
        return this.$otherGuestName.add(this.$guestName);
      },
      $otherGuestSurname: $checkoutForm.find('#last-name-guest-checkout'),
      $guestSurname: $checkoutForm.find('#last-name-checkout'),
      get guestSurnameFields() {
        return this.$otherGuestSurname.add(this.$guestSurname);
      },
      $personalizeFirstRoomNameSurname: personalizeRooms.first().find("#room-01-name-surname-01"),
      $personalizeFirstRoomName: personalizeRooms.first().find("#room-01-name-01"),
      $personalizeFirstRoomSurname: personalizeRooms.first().find("#room-01-surname-01"),
      get $personalizeFirstRoomData() {
        return this.$personalizeFirstRoomNameSurname.add(this.$personalizeFirstRoomName).add(this.$personalizeFirstRoomSurname);
      },
    };

    // Disable hidden form validations
    _initIsCifRequired();
    _onNeedBillChange();
    _copyGuestDataInBillData();
    _toggleBillCompanyNameVisibility(false);
    _toggleBillUserNameVisiblity(true);
    // Show/Hide garanteeCheck info text
    _onGaranteeChange();
    _setGaranteeModal();

    guestFields.guestNameSurnameFields.on("focusout", {type: "NameSurname"}, _copyGuestData);
    guestFields.guestNameFields.on("focusout", {type: "Name"}, _copyGuestData);
    guestFields.guestSurnameFields.on("focusout", {type: "Surname"}, _copyGuestData);



    //TODO: Revisar si esto se tiene que seguir haciendo o no
    //fixTabInputValidation()
  }

  /*
    TODO: Revisar si esto se usa
  */
  /*var fixTabInputValidation = function() {
    changeInput($(".js-change-validation"), {
        submitting: false
    });
    $(".js-change-validation").on("shown.bs.tab", function() {
        changeInput(this);
    });
    function changeInput(container, options) {
      var inputChange = $(container).find(".js-change-input");
      $.each(inputChange, function(i, ele) {
          var $ele = $(ele);
          var required = $ele.is(":visible") ? true : false;
          utils.changeInputValidation($ele, required, options);
      });
    }
};*/

  /*
   * @description fill the user logged info into the correct checkout form fields
   */
  function fillLoggedInfo(targetUrl) {
    var $input;
    var inputId;
    var $inputLabel;
    var $element;
    $.ajaxSetup({cache:false, async:false});
    $.ajax({
      method:"GET",
      url: urlGlobalConfig.host + targetUrl
    });
    return login.checkUserLogged()
    .then(function(response) {
      $("body").addClass("logged");//con esto ocultamos los elementos con clase hide-logged y mostramos los elementos con clase show-logged
      $.each(userLoggedFields, function(key, data) {
        $element = $(data.class).not(':input');
        $input = $checkoutForm.find('input' + data.class);
        inputId = $input.attr('id');
        $inputLabel = $checkoutForm.find('label[for="' + inputId + '"]');
        data.value = response.userData[data.dataKey];
        if($input.length > 0 && data.value) {
          $input.val(data.value).trigger("blur");
          $inputLabel.addClass('focus');
        }
        if($element.length > 0 && data.value) {
          $element.text(data.value);
        }
      });

      if (response.userData.name && typeof pageData !== "undefined" && !$.parseJSON(pageData.isB2B) && !$.parseJSON(pageData.isB2EFriends)) {
        $("#name-checkout, #last-name-checkout").prop("disabled", true);
        //$(".js-input-name").prop("disabled", true);
        //$(".js-input-lastname").prop("disabled", true);
      }
      $(".join-rewards-logged-block").addClass("join-rewards-" + userLoggedFields.category.value.toLowerCase());
    }, function(error) {
      return error;
    });
  }

  /*** PRIVATE ***/

  /**
   * @description - added the behaviour before user leaves page
   */
  function _beforeUnloadSession() {
    var fireEvent = true;
    /* codigo final
    var urlSend = (currentPage === "flexible") ? "/booking/save-flexibleform-data" : "/booking/save-prepaidform-data";*/
    /*url cppreas para pruebas
    var urlSend = (currentPage === "flexible") ? "https://cppreas.nh-hotels.com/booking/save-flexibleform-data" : "https://cppreas.nh-hotels.com/booking/save-prepaidform-data";*/
    /*url prod para pruebas*/
    var urlSend = (currentPage === "flexible") ? "https://www.nh-hotels.com/booking/save-flexibleform-data" : "https://www.nh-hotels.com/booking/save-prepaidform-data";


    if(pageData.tcmFromErrorCode){
      var splitt = pageData.tcmFromErrorCode.split('-');

      if(splitt[1]+'-'+splitt[2] === '82579-16'){
        fireEvent = false;
      }
    }

    if(fireEvent) {
      window.onbeforeunload = function() {
      //window.addEventListener("beforeunload", function (event) {
        //event.preventDefault(); hace saltar el alert de aviso en firefox

        //sessionData esta en critical/main.js
        if(typeof sessionDataSend !== "undefined") {
          _getSessionData().then(function(response) {
            sessionDataSend = response;
            $.ajax({
              type: "POST",
              url: urlSend,
              data: sessionDataSend,
              cache: false,
              async: false
            })
            .done(function() {})
            .fail(function(data) {
              if (data.responseText !== 200) {
                return false;
              }
            });
          });
        }
      };
    }
  }

  /**
   * @description copy the guest or other guest data into customize first room data
   */
  function _copyGuestDataInBillData() {
    _copyGuestData({data:{type: "NameSurname"}});
    _copyGuestData({data:{type: "Name"}});
    _copyGuestData({data:{type: "Surname"}});
  }

  /**
   * @description copy the data of a specific field of guest/other guest data into customize first room data field
   * @param {object} ev - data of the event with the type of field to be copied
   */
  function _copyGuestData(ev) {
    var dataType = ev.data.type;
    var value = "";
    var $billField = guestFields["$personalizeFirstRoom" + dataType];
    var isDisabled;
    //other-guests
    //if(guestFields["$otherGuest" + dataType].length && guestFields["$otherGuest" + dataType].val() !== "" && guestFields["$otherGuest" + dataType].is(":visible")) {
    if(guestFields["$otherGuest" + dataType].length && guestFields["$otherGuest" + dataType].is(":visible")) {
      value = guestFields["$otherGuest" + dataType].val();
      //$billField.prop("disabled", true);
    } else {
      value = guestFields["$guest" + dataType].val();
      //$billField.prop("disabled", false);
    }
    isDisabled = (value  && value.length > 0);

    $billField.prop("disabled", isDisabled).val(value);
  }

  /**
   * @description copy the guest data into bill form
   */
  function _copyReservationData() {
    var $this = $(this);
    var $nameSurnameBillInput = infoBillFieldset.find('#name-surname-bill');
    var $nameBillInput = infoBillFieldset.find('#name-bill');
    var $surnameBillInput = infoBillFieldset.find('#last-name-bill');
    var valueNameSurname = '';
    var valueName = '';
    var valueLastName = '';

    if($this.is(":checked")) {
      valueNameSurname = $checkoutForm.find('#name-surname-checkout').val();
      valueName = $checkoutForm.find('#name-checkout').val();
      valueLastName = $checkoutForm.find('#last-name-checkout').val();
    }

    $nameSurnameBillInput.val(valueNameSurname).blur();
    $nameBillInput.val(valueName).blur();
    $surnameBillInput.val(valueLastName).blur();
  }

  /**
   * Custom bootstrap validator function for DNI/NIE inputs
   * @param  {[type]} $el [description]
   * @return {[type]}     [description]
   */
  function _customDocumentNumberValidator($el) {
    var isValid = commonFormSetup.validateNumberDocument('dni', $el.val());
    if (!isValid) {
      return 'error';
    }
  }

  /**
   * @description fill the fields of the form to be send
   * @returns {object} returns a promise to handle the behavior of succes result
   * cambiar el nombre a fillFormToSend
   */
  function _fillInputHidden() {
    //INPUT ID: Foreach formularioSend hidden inputs, add assign value from main form.
    var fields = $checkoutFormToSend.find('input[data-id]');
    var deferred = $.Deferred();

    $.each(fields, function(i, ele){
      var $formInputHidden = $(ele);
      var valueInput = _getFieldToSendValue($formInputHidden);
      if (valueInput) {
        valueInput = ($formInputHidden.attr("name") === "subscribeRewards" && valueInput === "S") ? true : valueInput;
        $formInputHidden.val(valueInput, $formInputHidden);
      }
    });

    _fillCustomPageInputHidden().then(function() {
      deferred.resolve(true);
    });

    return deferred.promise();

  }

  /**
   * @description fill specific fields of the form to send depends of type of page and type of customer
   * @returns {object} returns a promise to handle the behavior of succes result
   */
  function _fillCustomPageInputHidden() {
    var fields = {};
    var $field;
    var deferred = $.Deferred();
    if (currentPage === "flexible" && customer.isB2B && customer.isAgency && customer.hasCredit) {
        if ($(".js-b2b-paymenttype").val() == "NOPAYMENT") {
            fields = {
                paymentType: $checkoutForm.find("input.js-guarantee-paymenttype").val()
            };
        }
    }
    if (!$.isEmptyObject(fields)) {
      $.each(fields, function(ele, value) {
        $field = $checkoutFormToSend.find('input[name="' + ele + '"]');
        if (value && $field.length) {
          $field.val(value);
        }
      });
    }
    deferred.resolve();
    return deferred.promise();
  }

  /**
   * @description - get the current page type checking the class that has the body element
   */
  function _getCurrentPage() {
    //get Current Page
    var bodyclass = $('body').attr('class');
    if( (/prepayment/g).test(bodyclass) ){
      return "prepayment";
    }else{
      return "flexible";
    }
  }

  /**
   * @description get the form to be submit field
   * @param {object} $field - jquery object with the form field
   * @returns {any} the field value
   */
  function _getFieldToSendValue($field) {
    var dataId = $field.data("id");
    var $dataField = _getField(dataId);
    var valueInput = null;
    var fieldType = null;
    var isFieldVisible;
    var dataAltValue = $field.data("alt-value");
    var altValue;

    if($dataField && $dataField.length > 0) {
      fieldType = _getFieldType($dataField);
      isFieldVisible = _isFieldVisible($dataField);
      //if ($dataField.is(":visible") || $dataField.hasClass("selectpicker") && $('.selectpicker[data-id="' + dataId + '"]').is(":visible") || $dataField.hasClass("force-send")) {
      if(isFieldVisible) {
        switch (fieldType) {
          case "checkbox":
            var isChecked = $dataField.is(":checked");
            valueInput = (isChecked) ? "true" : "false";
            if (dataId.indexOf("GDPR") >= 0) {
              valueInput = (isChecked) ? "S" : "N";
              if (dataId.indexOf("GDPR_flag_5") >= 0 && !isChecked) {
                $checkoutFormToSend.find('[name="' + dataId + '"]').remove();
                valueInput = null;
              }
            }
            break;
          case "input":
          case "hidden":
            valueInput = $dataField.val();
            break;
          case "radio":
            valueInput = $dataField.val();
            break;
          case "select":
            valueInput = $dataField.val();
            if ($field.data("format-year")) {
                var format = $field.data("format-year") || "20";
                if (format) {
                    valueInput = format + "" + valueInput;
                }
            }
            break;
          default:
            valueInput = $dataField.val();
        }

        if(dataAltValue) {
          altValue = (fieldType === "select") ? $dataField.find(":selected").data(dataAltValue) : $dataField.data(dataAltValue);
          valueInput = (altValue) ? altValue.toString() : valueInput;
          if(fieldType === "select" && typeof valueInput === "undefined") {
            valueInput = "";
          }
        }
      }
    }


    return valueInput;
  }

  /**
   * @description get the jquery object of a form field specific by it's id or name
   * @param {strong} fieldId - the id or name of the field to be return
   * @returns {object} the jquey objec of the field
   */
  function _getField(fieldId) {
    var $field = null;
    if(fieldId) {
      //$field = $checkoutForm.find("#" + fieldId) || $checkoutForm.find('[name="' + fieldId + '"]:checked');
      $field = $checkoutForm.find("#" + fieldId + ", [name='"+ fieldId + "']:checked" );
    }

    return $field;
  }

  /**
   * @description get the field type (input, select, checkbox, radio,...)
   * @param {object} $field - jquery field object
   * @returns {string} the field type
   */
  function _getFieldType($field) {
    var fieldType = null;
    var type = $field.attr("type");

    if(["select", "radio", "checkbox"].indexOf(type) >= 0) {
      fieldType = type;
    } else {
      fieldType = $field.prop("tagName").toLowerCase();
    }

    return fieldType;
  }

  function _getSessionData() {
    var deferred = $.Deferred();
    _fillInputHidden().then(function() {
      return deferred.resolve($checkoutFormToSend.serialize());
    });

    return deferred.promise();
  }

  /**
   * @description - show guarantee modal if the checkbox of guarantee is checked and set correct the value to input hidden related with guarantee
   */
  function _guaranteeActions() {
    var inputToSend = $("input.js-guarantee-paymenttype");
    var data = inputToSend.data("value");
    var isChecked = $(this).is(":checked");

    if(isChecked) {
      inputToSend.val((data) ? data.guarantee : inputToSend.val());
    } else {
      inputToSend.val((data) ? data.noguarantee : inputToSend.val());
    }
  }

  /**
   * @description - handle the behaviour of the sessionExpiredCoutnDownModal
   */
  function _handleSessionExpiredCountdownModal() {
    var urlSend = (currentPage === "flexible") ? "/booking/hold-prereservation-flexible" : "/booking/hold-prereservation-prepaid";
    if (typeof pageData.reservationId !== "undefined") {
      //$sessionExpireModal
      //$sessionExpireCounter
      $sessionExpireModal.on('hidden.bs.modal', function(ev) {
        if (!sessionExpired) {
          $.ajax({
            type: "POST",
            url: "https://www.nh-hotels.com" +  urlSend + "?merchantReturnData=" + pageData.reservationId,
            headers: {
                Accept: "application/json",
                "Content-Type": "application/json"
            },
            dataType: "json",
            cache: false
          }).done(function(data) {
            if (data) {
                _initializeCounterClock();
                timeIntervals.push(_initSessionExpiredCountdown());
                _setSessionExpiredCountdownModalTimeout();
            }
          }).fail(function(data) {
              console.log("fail", data);
          });
        } else {
          $sessionExpireMessageModal.modal({
            backdrop: "static",
            keyboard: true,
            show: true
          });
        }
      });
    }
  }

    /**
   * @description - Initialize the countdown to show the session expire modal
   */
  function _initSessionExpiredCountdown() {
    var minutes;
    var seconds;
    var now;
    var endTime;
    var timeRemaining;
    var timeinterval;
    if ($sessionExpireCounter.length > 0) {
      minutes = parseInt($sessionExpireCounter.attr("data-mins"), 10);
      seconds = parseInt($sessionExpireCounter.attr("data-secs"), 10);
      now = new Date().getTime();
      endTime = new Date(now + (minutes * 60 * 1000) + (seconds * 1000));

      timeinterval = setInterval(function() {
        timeRemaining = utils.getTimeRemaining(endTime);
        if (timeRemaining.total <= 0) {
          clearInterval(timeinterval);
          sessionExpired = true;
          if(!$sessionExpireModal.is(":visible") || !$sessionExpireModal.hasClass("in")) {
            $sessionExpireMessageModal.modal({
              backdrop: "static",
              keyboard: true,
              show: true
            });
          } else {
            $sessionExpireModal.modal("hide");
          }
        }
      }, 1000);
    }
    return timeinterval;
  }

  /**
   * @description check if a fiel is visible
   * @param {object} $field - jquer object with the field data
   * @returns {boolean} if the field is visible or not
   */
  function _isFieldVisible($field) {
    var $elementToCheck = $field;
    var fieldId = $field.attr("id");

    if($field.hasClass("selectpicker")) {
      $elementToCheck = $('.selectpicker[data-id="' + fieldId + '"]');
    } else if($field.hasClass("ui-autocomplete-input")) {
      $elementToCheck = $("#" + fieldId + "-clone");
    }

    return $elementToCheck.is(":visible") || $elementToCheck.hasClass("force-send");
  }

  /**
   * @description form submit action
   * @param {object} e - object with the form submit event data
   */
  function _onFormSubmit(e) {
    var $form = $(this);
    var moveToOffset;
    toggleLoadingButton($form, true);
    if (e.isDefaultPrevented()) {
      // Invalid Form
      utils.callTrackForms("errors", "prepaymentForm", "errors"); //falta integrar
      /*
        TODO:
        el scroll hacia el primer error encontrado en v2 lo haría hacia el primer error encontrado que no tenga la clase .js-no-scroll
        parece ser que esa clase la tiene los campos de la modal de modificar busqueda para que no haga scroll hacia los errores en ese formulario
        Para hacer esto habría que sobreescribir la funcion onSubmit de validator.js (https://github.com/1000hz/bootstrap-validator/issues/128)
      */
      toggleLoadingButton($form, false);
    } else {
      // Valid Form
      e.preventDefault();

      /*1- validamos el nombre de huesped
          si es valido
            eliminamos los intervals y timeouts(sesion,...)
            mostramos loading (modal o loadind de boton- revisar)
            rellenamos el formulario escondido que se va a envair
            llamamos al trackForms
            enviamos el formulario escondido

          si no es valido
            movemos el formulario a widget de personalizar habitaciones
      */
      var validateGuests = _validateGuestsName();
      if (validateGuests) {
        utils.clearAllIntervals();

        /*
          TODO:
          Si los botones de checkout (normal, agencia, bussines) van a tener todos la clase show-loading, deberiamos llamar directamente a _setupAndShowLoadingModal
          si no lo podemos dejar así. Revisar
        */
        if ($bottonSubmit.hasClass("show-loading")) {
          _setupAndShowLoadingModal();
        }

        //Fill the form to send fields
        _fillInputHidden().then(function() {
          if (currentPage == "prepayment") {
            utils.callTrackForms("success", "prepaymentForm", "success");
          }
          /*
          } else ifif (currentPage == "flexible") {}
          */
          $checkoutFormToSend.submit();
        });
      } else {
        moveToOffset = personalizeRooms.first().eq(0).offset().top - 90;
        $("html, body").animate({
            scrollTop: moveToOffset,
            useTranslate3d: true
        }, 700);
      }
    }
  }

  function _onNeedBillChange() {
    if(needBillCheckbox.is(':checked')) {
      needBillRequiredInputs.attr('data-validate', true);
    } else {
      needBillRequiredInputs.attr('data-validate', false);
    }
    $checkoutForm.validator('update');
  }

  function _onInfoBillToggles() {
    _initIsCifRequired();
    $checkoutForm.validator('update');
  }

  /**
   * @description - open the collapse panel with the details of the first room if the element clicked is checked and update the validations
   */
  function _onOtherGuestsChange() {
    if($otherGuestsCheckbox.is(':checked')) {
      otherGuestsRequiredInputs.attr('data-validate', true);
      personalizeRooms.first().collapse("show");
    } else {
      otherGuestsRequiredInputs.attr('data-validate', false);
      guestFields.$personalizeFirstRoomData.prop("disabled", false);
    }
    
    _copyGuestDataInBillData();
    $checkoutForm.validator('update');
  }


  /**
   * @description - show modal with a error message related with java code
   */
  function _showJavaError() {
    var $modal = $('#modal-java-error');
    if(pageData.urlError && typeof pageData.urlError !== "undefined") {
      //Abro el modal sin posibilidad de cerrarlo. Solo se podrá hacer clic en el boton que redirigirá a la urlError
      $modal.modal({
          backdrop: 'static',
          keyboard: true,
          show: true
      });

      //adn/pages/landing.js -> en v3 no exite este clearinterval all, ver si hay que crearlo
      utils.clearAllIntervals();

    } else {
      //abro modal de error normal
      modal.modal( "show" );
    }
  }

  /**
   * @description - set the value of nationality field
   */
  function _setNationalityField() {
    utils.getGeoIpData()
    .then(function(response) {
      var selectedOption;
      if (response && response.country) {
        selectedOption = $("select.js-country-geoip").find("option[value=" + response.country + "]");
        $("select.js-country-geoip").val(response.country).change();
        $("input.js-country-geoip").val(selectedOption.text());
      }
    });
  }

  function _setupAgencyService() {
    var $this = $(this);
    var valor;
    if ($this.is(":checked")) {
        valor = $this.attr("data-no-text");
        $this.removeAttr("data-no-text");
        $this.attr("data-text", valor);
    } else {
        valor = $this.attr("data-text");
        $this.removeAttr("data-text");
        $this.attr("data-no-text", valor);
    }
  }

  function _toggleBillCompanyNameVisibility(visible) {
    var companyName = infoBillFieldset.find('#company-name');
    companyName.closest('.js-company-name-wrapper').toggle(visible);
    companyName.attr('data-validation', visible);
    companyName.val('');
  }

  function _toggleBillUserNameVisiblity(visible) {
    var nameSurnameInput = infoBillFieldset.find('#name-surname-bill');
    var nameInput = infoBillFieldset.find('#name-bill');
    var surnameInput = infoBillFieldset.find('#last-name-bill');
    nameSurnameInput.closest('.js-bill-user').toggle(visible);
    nameSurnameInput.attr('data-validation', visible);
    nameSurnameInput.val('');
    nameInput.closest('.js-bill-user').toggle(visible);
    nameInput.attr('data-validation', visible);
    nameInput.val('');
    surnameInput.closest('.js-bill-user').toggle(visible);
    surnameInput.attr('data-validation', visible);
    surnameInput.val('');
  }

  function _toggleGuaranteeCheckbox() {
    var value = $(this).val();
    var $wrapGuarantee = $(".js-wrap-guarantee");
    var showGuarantee = ["BONOPAYMENT", "COMPANYCREDIT", "FACTURAPROFORMA", "BONOPAYMENT_"].indexOf(value) < 0;
    $wrapGuarantee.toggle(showGuarantee);
  }

  /**
   * @description - set the timeout to show the sessionExpiredCountdown modal
   */
  function _setSessionExpiredCountdownModalTimeout() {
    var time = $sessionExpireModal.data("timeout") || 3e5;//300000
    setTimeout(function() {
      $sessionExpireModal.modal("show");
    }, parseInt(time));
  }

  /**
   * @description set up the modal body and show the loading-modal-checkout
   */
  function _setupAndShowLoadingModal() {
    var $modal = $("#loading-modal-checkout");
    var $paymentMethod = $checkoutFormToSend.find("#paymentMethod");
    var $externalMethodsWrapper = $modal.find(".method-external");
    var $cardMethodsWrapper = $modal.find(".method-card");
    var paymentMethod = _getFieldToSendValue($paymentMethod);
    var $methodOption = $externalMethodsWrapper.find(".lbl-" + paymentMethod.toLowerCase());

    if(paymentMethod && $methodOption.length) {
      $methodOption.show();
      $externalMethodsWrapper.show();
    } else {
      $cardMethodsWrapper.show();
    }

    $("#loading-modal-checkout").modal({
      backdrop: "static",
      keyboard: true,
      show: true
    });
  }

  /**
   * @description - show or hide the nationality field if the checkbox to accept the rewards contion and rewads policy is checkred or not
   */
  function _toggleNationalityField() {
    var $this = $(this);
    var $nationality = $("#group-nationality-checkout");//wrapper del campo nacionalidad
    var $nationatilyInput = $nationality.find("input");
    if ($this.is(":checked")) {
      $nationality.show().removeClass("hide");
      $nationatilyInput.attr('data-validate', true);
    } else {
      $nationality.hide().addClass("hide");
      $nationatilyInput.attr('data-validate', false);
    }
    $checkoutForm.validator('update');
  }

  /**
   * @description check if the first guest name is valid
   * @returns [boolean] if the first guest name is valid or not
   */
  function _validateGuestsName() {
    var $guestName = $("#room-01-name-01");
    var $formGroup = $guestName.parents(".form-group");
    var labelRequired = $guestName.data("required-error");
    var isValid = true;
    if ($otherGuestsCheckbox.is(":checked")) {
        personalizeRooms.first().collapse("show");
        if ($guestName.val() !== "") {
            $formGroup.removeClass("has-error").find(".help-block").html("");
            isValid = true;
        } else {
            $formGroup.addClass("has-error").find(".help-block").html('<ul role="alert"><li>' + labelRequired + "</li></ul>");
            isValid = false;
        }
    }
    return isValid;
  }

  function _initializeCounterClock() {
    _clearClockIntervals();
    timeIntervals.push(utils.initializeClock($sessionExpireCounter)); //inicializamos la cuenta atras del contador
  }

  function _clearClockIntervals() {
    utils.clearIntervals(timeIntervals);
    timeIntervals = [];
  }

  function _onBillCountrySelectorChange(e) {
    var $selectedOption = $(e.target.options[e.target.selectedIndex]);
    _setBillCIFRequired($selectedOption);
  }

  function _setBillCIFRequired($selectedOption) {
    var isCIFRequiredByCountry = false;
    var isCIFRequiredByPrice = _checkCIFRequiredTotalPrice();
    var isCIFRequired = false;
    if($selectedOption && cifInput.is(':visible')) {
      isCIFRequiredByCountry = $selectedOption.data('required-cif');
    }
    if(cifInput.is(':visible') && (isCIFRequiredByCountry === true || isCIFRequiredByPrice)) {
      isCIFRequired = true;
    }
    _setCifValidationAttr(isCIFRequired);
  }

  function _initIsCifRequired() {
    var billFormCountryElement = billFormCountry[0];
    if(!billFormCountryElement) {
      return;
    }
    var $selectedOption = $(billFormCountryElement[billFormCountryElement.selectedIndex]);
    _setBillCIFRequired($selectedOption);
  }

  function _checkCIFRequiredTotalPrice() {
    var cifRequired = false;
    var finalPriceValue = finalPrice.data('final-price');
    var finalPriceMaxPriceCif = finalPrice.data('max-price-cif');
    if(!finalPriceValue || !finalPriceMaxPriceCif) {
      return cifRequired;
    }
    if(finalPriceValue >= finalPriceMaxPriceCif) {
      cifRequired = true;
    }
    return cifRequired;
  }


  function _setCifValidationAttr(validate) {
    if(validate === undefined || (validate && validate.length === 0)) {
      validate = false;
    }
    cifInput.attr({
      'data-validate': validate,
      'required': validate
    });
    _setRequiredSymbol(cifInput, validate);
    $checkoutForm.validator('update');
  }

  function _setRequiredSymbol(input, validate) {
    var label = input.siblings('label');
    var labelText = label.html();
    var requiredSymbol = '*';
    if(validate === true && labelText.indexOf(requiredSymbol) === -1) {
      label.html(label.html() + requiredSymbol);
    } else if(validate === false && labelText.indexOf(requiredSymbol) > -1){
      labelText = labelText.slice(0, labelText.indexOf(requiredSymbol));
      label.html(labelText);
    }
  }



  function _onGaranteeChange() {
    var infoTarget = $(garanteeCheck.data('target'));
    if(garanteeCheck.is(':checked')) {
      infoTarget.collapse('show');
    } else if(!garanteeCheck.is(':checked') && infoTarget.is(':visible')){
      infoTarget.collapse('hide');
    }
  }

  function _setGaranteeModal() {
    if(garanteeCheck.is(':disabled') && garanteeCheck.is(':checked') ) {
      var $wrapGuarantee = $(".js-wrap-guarantee");
      $wrapGuarantee.on('click', () => {
        modalGarantee.modal("show");
      });
    }
  }

  return {
    init: init,
    fillLoggedInfo: fillLoggedInfo
  };
})();

$(() => { 
  if ($(".p-bp-checkout").length) {
    //page-checkout .logged
      checkout.init();
  }
});

var b2bSignup = (() => {
  var b2bSignupView = $('.p-b2b-signup').add('.p-b2b-signup-agency');
  var signupForm = b2bSignupView.find('form.js-form-steps');
  var intermediaryInput = signupForm.find('[name="input_intermediario"]');
  var affirmativeIntermediaryInput = signupForm.find('#input_intermediario_si');
  var intermediaryTextInput = signupForm.find('#intermediary_text_input');

  /**
   * Init Fn
   */
  function init(){
    b2bSignupView.formSteps({
      initStep: 0
    });

    signupForm.validator({
      disable: false
    }).on('submit', function(e) {
        var $form = $(this);
        toggleLoadingButton($form, true);
      if (e.isDefaultPrevented()) {
        // Invalid Form
        toggleLoadingButton($form, false);
      } else {
      }
    });

    // Listeners
    intermediaryInput.on('change', _onIntermediaryInputChange);
    _onIntermediaryInputChange();
  }

  /**
   * Handler when the intermediary input changes. Show/hide the associated
   * input text.
   */
  function _onIntermediaryInputChange(e) {
    var intermediaryInputTextFormGroup = intermediaryTextInput.closest('.form-group');
    if(affirmativeIntermediaryInput.is(':checked')) {
      intermediaryInputTextFormGroup.closest('.form-group').removeClass('hide');
      intermediaryTextInput.attr('data-validate', true);
    } else {
      intermediaryInputTextFormGroup.addClass('hide')
      intermediaryTextInput.attr('data-validate', false);
    }
    signupForm.validator('update');
  }

  return {
    init: init
  };
})();

$(() => {
  b2bSignup.init();
});

var bridge = (() => {
  var styleGuideView = $('.style-guide');
  var bridgeHeader = $('.bridge-sidebar-header');
  var bridgeSideBarMenu = $('.bridge-sidebar-menu');
  var btnMenu = bridgeHeader.find('.hamburguer');


  var navigationLinks = bridgeSideBarMenu.find('.js-navigation-link');


  const DEFAULT_HASH = '#brand';
  const STICKY = styleGuideView.offset() ? styleGuideView.offset().top : '0';

  function init() {
    // Listeners
    navigationLinks.on('click', _handlerClickNavigationLink);
    btnMenu.on('click', _handlerHamburguerButtonClick);
    if(styleGuideView.length > 0) {
      _initNavigation();
      // $(window).on('scroll', _handlerStickySideBar);
    }
    // INIT SCRIPTS
    _initForms();
  }

  function _handlerHamburguerButtonClick(e) {
    $(this).toggleClass('close-hamburguer');
    bridgeSideBarMenu.toggleClass('is_active');
  }

  function _initNavigation() {
    // Update URL
    var hashUrl = window.location.hash.length > 0 ? window.location.hash : DEFAULT_HASH;
    navigate(hashUrl);
  }

  function navigate(hashUrl) {
    // Add active class to section title
    $(`.js-navigation-link a[href="${hashUrl}"]`).closest('li').addClass('active');
    // Open up the hidden content panel
    $('.accordion-section' + hashUrl + '-view').removeClass('hide').addClass('open');
    // Update URL hash
    window.location.hash = hashUrl;
    $('html, body').animate({
      scrollTop: 0
    }, 200);
  }

  function _handlerClickNavigationLink(e) {
    // Grab current anchor value
    var currentAttrValue = $(this).find('a').attr('href');

    if($(e.target).is('.active')) {
      _close_accordion_section();
      _close_menu_mobile();
    }else {
      _close_accordion_section();
      _close_menu_mobile();
      navigate(currentAttrValue);
    }
    e.preventDefault();
  }

  function _close_accordion_section() {
    navigationLinks.removeClass('active');
    $('.accordion-section').addClass('hide').removeClass('open');
  }

  function _close_menu_mobile() {
    $(this).removeClass('close-hamburguer');
    sideBar.removeClass('is_active');
  };


  function _handlerStickySideBar() {
    var scrollTop = $(this).scrollTop();

    console.log("window-scrollTop", scrollTop);
    console.log("STICKY", STICKY);
    if (scrollTop >= STICKY) {
      styleGuideView.addClass('sg-sticky');
    } else {
      styleGuideView.removeClass('sg-sticky');
    }

  }

  function _initForms() {
    // Steps
    var form = styleGuideView.find('form.js-form-steps');
    var formStepsView = styleGuideView.find('.form-steps');
    formStepsView.formSteps({
      initStep: 0
    });
    form.validator({
      disable: false
    }).on('submit', function(e) {
        var $form = $(this);
        toggleLoadingButton($form, true);
      if (e.isDefaultPrevented()) {
        toggleLoadingButton($form, false);
      } else {
        // Invalid Form
      }
    });
  }

  // Public API
  return {
    init: init
  }
})();

$(() => {
  bridge.init();
});

const pCGWLogin = (function() {
  let $pCGWLoginView = null;
  let $modalError = null;
  let $modalResetPassword = null;
  let $userBlockedResetPassTrigger = null;
  let $loginForm = null;
  let $backButton;

  function init(view) {
    $pCGWLoginView = view;
    $modalError = $pCGWLoginView.find('#modal-login-error');
    mModals.attachModalEventsBehaviour($modalError);
    $modalResetPassword = $pCGWLoginView.find("#m-modal-login"); 
    $loginForm = $pCGWLoginView.find("#loginForm");
    $userBlockedResetPassTrigger = $loginForm.find(".blocked-user .js-forgotten-password");

    

    $(window).on("load", _checkLoginError);

    $modalError.on("hide.bs.modal", _updateURL);
    $userBlockedResetPassTrigger.on("click", _handleResetPassForm);

    /*$("body").on("click touchstart", ".js-go-back-login", function() {
      $loginForm.find(".blocked-user").hide();
      $loginForm.find(".unblocked-user").show();
    });*/

  }


  function _checkLoginError() {
    if(error !== -1) {
      $modalError.modal('show');
    }
  }

  function _handleResetPassForm() {
    setTimeout(function() {
      console.log("$modalResetPassword", $modalResetPassword.html());

    }, 500);
  }

  function _updateURL() {
    var url = "/event-tool/admin/login";
    window.location.replace(url);
  }

  return {
    init: init,
  };

})();


$(function(){
  var $pCGWLoginView = $('.p-cgw-login');
  if($pCGWLoginView.length) {
    pCGWLogin.init($pCGWLoginView);
  }
});
const pRewardsCorporateSignup = (() => {
  let pRewardsCorporateSignupView = null;
  let signupRewardsCorporateForm = null;
  let formError;
  let $modalError;
  let $datepickerSelector;

  function init(view) {
    pRewardsCorporateSignupView = view;
    signupRewardsCorporateForm = pRewardsCorporateSignupView.find('#signup-corporate');
    $datepickerSelector = signupRewardsCorporateForm.find('#birth-date-selector');
    formError = (typeof pageData != "undefined") ? (typeof pageData.javaError != "undefined") ? pageData.javaError : false : false;
    $modalError = $("#modal-error");


    // EY NACIONLIDAD
    var nationalitySelects = {
      $nationality: signupRewardsCorporateForm.find("#nacionalidad"),
      $dniContainer: signupRewardsCorporateForm.find("#cDni"),
      get $dniContent() {
        return this.$dniContainer.find(".form-group");
      },
      $dni: signupRewardsCorporateForm.find("#dni")
    };

    signupRewardsCorporateForm.validator({
      disable: false,
      custom: {
        'birth-date': customBirthDateValidator.bind(this),
        'forbiden-under-age': commonFormSetup.customCheckUnderAge($datepickerSelector)
      }

    }).on('submit', e => {
      toggleLoadingButton(signupRewardsCorporateForm, true);
      if(e.isDefaultPrevented()){
        toggleLoadingButton(signupRewardsCorporateForm, false)
      }else{
        console.log("Eviando form")
        //toggleLoadingButton(signupRewardsCorporateForm, true);
      }
    });


    // EY AÑADIMOS dni al cargar nacionalidad
    nationalitySelects.$nationality.on("change", _onChangeNationality);
    function _onChangeNationality() {
      var nationality = $(this).val();
      if (nationality !== "ES" && nationality !== "IT") {
        nationalitySelects.$dni.val("").attr("data-validate", "false").prop("required", false);
        nationalitySelects.$dniContent.removeClass("has-feedback has-success has-error");
        nationalitySelects.$dniContainer.addClass("hide");
      } else {
        nationalitySelects.$dniContainer.removeClass("hide");
        nationalitySelects.$dniContent.addClass("has-feedback");
        nationalitySelects.$dni.attr("data-validate", "true").prop("required", true);
      }
    }
    //mostramos la modal de error si al enviar el formulario se genera un error
    if (formError) {
      $modalError.modal("show");
    }
  }

  /*******************/
  /* PRIVATE METHODS */
  /*******************/
  /**
   * @description behaviour when the form is submitted
   */

  function customBirthDateValidator() {
    if (this.datepickerSelector.selectorDatepicker('checkIsValidDate', true) === true) {
      if (this.datepickerSelector.selectorDatepicker('checkTimelineDate') === 1) {
        return 'Fecha erronea';
      }
    }
  }

  // Public API
  return {
    init: init
  };
})();

$(() => {
  if ($(".rewards-signup-form").length) {
    pRewardsCorporateSignup.init($(".rewards-signup-form"));
  }
});
var nhRewardsCorporate = (function() {
  var $rewardsCorporateView = null;
  var $mCorporateRegister = null;
  function init() {
    $rewardsCorporateView  = $('.p-rewards-corporate');
    $mCorporateRegister = $rewardsCorporateView.find('.m-corporate-register');
    _initAffix();
    $(window).on("resize", _resetAffix);
  }


  function _initAffix() {
    var offsetTop = $mCorporateRegister.offset().top;
    $mCorporateRegister.affix({offset: {top: offsetTop} });
  }

  function _resetAffix() {
    $(window).off('.affix');
    $mCorporateRegister.removeData('bs.affix').removeClass('affix affix-top affix-bottom');
    _initAffix();
  }

  return {
    init: init,
  };

})();


$(function(){
  if($('.p-rewards-corporate .m-corporate-register').length) {
    nhRewardsCorporate.init();
  }
});
var mBestPrice = (function() {
  var $bestPriceForm = $('#form-best-price');
  var files = {
    container: $bestPriceForm.find(".files-content"),
    get button() {
      return this.container.find(".btn-file");
    },
    get input() {
      return this.container.find("#next");
    },
    get inputList() {
      return this.container.find(".fileInput");
    },
    get list() {
      return this.container.find(".files-list");
    },
    listInputs: [],
    items: 0
  };

  var $errorFileModal = $("#modal-file-error");
  var $gdprChecks =$bestPriceForm.find("input[id*='GDPR_flag']");

  function init() {
    //init form validators
    $bestPriceForm.validator({
        disable: false,
    }).on('submit', function (e) {
        var $form = $(this);
        toggleLoadingButton($form, true);
        if (e.isDefaultPrevented()) {
          // Invalid Form
          toggleLoadingButton($form, false);
        } else {
          toggleLoadingButton($form, false);
        }
    });

    //handle click over attach file button
    files.button.on("click", _onClickAttachFileBtn);

    //handle change event over attach file input
    files.input.on("change", _onChangeFilesAttachedInput);

    //handle click event over remove file attached button
    files.list.on('click','.nh-ic-close', _onClickRemoveFileBtn);

    //handle click event over the gdpt checks inputs
    $gdprChecks.on("change", _onClickGDPRchecbox);
   
  }

  /*******************/
  /* PRIVATE METHODS */
  /*******************/

  /**
   * @description ad new file to the form
   */
  function _addFile() {
    var inputFile = files.input.clone().appendTo(files.container);
    files.listInputs.push(inputFile);
    _setUpFileAttached();
    files.input.val("");
  }

  /**
   * @description - remove specific file to de form
   * @param {number} index - the index of the file to remove
   */
  function _deleteFile(index) {
    var inputToDelete = files.listInputs[index];
    var filesAttached = files.list.find("li");
    var fileToDelete = filesAttached.eq(index);
    files.listInputs.splice(index, 1);
    filesAttached.splice(index, 1);
    fileToDelete.remove();
    inputToDelete.remove();

    $.each(files.listInputs, function(ind) {
      var inputFile = $(this);
      var file = filesAttached.eq(ind);
      var removeBtn = file.find(".nh-ic-close"); 
      inputFile.attr({
        id: `files[${ind}]`,
        "name": `files[${ind}]`
      });
      removeBtn.data("index", ind).attr("data-index", ind);
    });
  }

  /**
   * @description handle change event of the input file to attach files
   */
  function _onChangeFilesAttachedInput() {
    if( (/\.(pdf|doc|docx|png|jpg|tiff|tif|gif)$/i).test($(this).val())){
      _addFile();
    } else {
      $errorFileModal.modal();
    }
  }

  /**
   * @description set up the html with the file attached data
   */
  function _setUpFileAttached() {
    var index = files.listInputs.length - 1;
    var fileInput = files.listInputs[index];
    fileInput.attr({
      id: `files[${index}]`,
      "name": `files[${index}]`
    });

    files.list.append(
      `<li>
        <span class="file-name">${fileInput[0].files[0].name}</span>
        <span class="nh-ic-close" data-index="${index}"></span>
      </li>`
    );
  }

  /**
   * @description handle the click over the gdpr checks
   */
  function _onClickGDPRchecbox() {
    var $this = $(this);
    var value = ($this.prop("checked")) ? 'S' : 'N';
    $this.val(value);
  }
  
  function _onClickAttachFileBtn() {
    files.input.trigger("click");
  }

  /**
   * @description - hadle the click event over the remove file button
   */
  function _onClickRemoveFileBtn(){
    var index = $(this).data("index");
    _deleteFile(index);
  }

  // Public API
  return {
    init: init,
  };
})();

$(function () {
  if($(".p-best-price-form").length) {
    mBestPrice.init();
  }
});



// init () -> Inicializa la funcionalidad de la página
// initOccupancy () -> Inicializar funcionalidad occupancy
// inputsClient () -> Rellena los campos de inputs relacionados con el cliente
// showOptionFieldset (fieldsetID) -> Muestra el fieldset que nos interesa dependiendo de la elección del select de consulta
// _onClickGDPRchecbox () -> Handle the click over the gdpr checks


var pCustomerCare = (function() {

  // Selectores generales
  const $view = $('.p-customer-care');
  const $formCustomerCare = $($view).find('#form-customer-care');
  const $formConsulta = $formCustomerCare.find('#formConsulta');
  const $gdprChecks = $formCustomerCare.find("input[id*='GDPR_flag']");

  // Objetos a tratar
  let occupancy =  null;
  let $occupancies = null;
  let infoClient = null;
  let calendarRange = null;

  let $modalError;
  let formError;


  /**
    * @description Inicializa la funcionalidad de la página
    */
  function init () {

    formError = (typeof pageData != "undefined") ? (typeof pageData.javaError != "undefined") ? pageData.javaError : false : false;
    $modalError = $("#modal-error");
    //mostramos la modal de error si al enviar el formulario se genera un error
    if (formError) {
      $modalError.modal("show");
    }


    // Inicializar select destinations
    $view.find('.mDestinations').each(function (index, destination) {
      $(destination).selectDestinations();
    });

    // Inicializar occupancy
    initOccupancy();

    // Vigilar si el check 6+ está checkeado al cargar
    _moreOccupancy( $formCustomerCare.find('#occupancy-more').is(':checked') );

    // Rellenar inputs relacionados con el cliente (navegador y OS)
    inputsClient();

    // Escuchador de fieldsets de consulta
    $($formConsulta).change(function () {
      showOptionFieldset ( $(this).val() );
    });

    // Handle click event over the gdpr checks inputs
    $gdprChecks.on('change', _onClickGDPRchecbox);

    // Rellenar text de error calendar
    $formCustomerCare.find('.range-calendar .help-block').text('Required field');

    // Listener check de 6+ habitaciones
    $formCustomerCare.find('#occupancy-more').change( function(){
      _moreOccupancy( $(this).is(':checked') );
    });


    // ------------------------------------------------------
    // Validaciones formulario

    $.fn.validator.Constructor.INPUT_SELECTOR = ':input:not([type="hidden"], [type="submit"], [type="reset"], button)';

    // Activar validador formulario
    $formCustomerCare.validator({
      disable: false

    }).on('submit', function (e) {
      let $form = $(this);
      let validForm = true;
      let errors = $formCustomerCare.find('.has-error');
      let isValidateRange = $('.range-calendar').is(":visible");

      toggleLoadingButton($form, true);
      ( isValidateRange ) ? _initRangeSelectors() : calendarRange = null;

      if ( e.isDefaultPrevented() ) {
        // console.log('falla');
        toggleLoadingButton($form, false);
        if (isValidateRange) _isValidRange();
        if (errors.length) $(document).scrollTop(errors.offset().top);

      } else {
        validForm = (isValidateRange) ? _isValidRange() : true;
        if (!validForm) {
          e.preventDefault();
        } else {
          // console.log('no falla');
          _onSubmitCustomerCare();
        }
         toggleLoadingButton($form, false);
      }
    });
}



/**
   * @description - Init range calendar selectors
   */
function _initRangeSelectors() {
  calendarRange = {
    $rangeSelector: $('.range-calendar:visible'),
    get $initRangeWrapper() {
      return this.$rangeSelector.find(".init-range-calendar .js-input-wrapper");
    },
    get $endRangeWrapper() {
      return this.$rangeSelector.find(".end-range-calendar .js-input-wrapper");
    },
    get $initRangeInput() {
      return this.$initRangeWrapper.find("input.date-select");
    },
    get $endRangeInput() {
      return this.$endRangeWrapper.find("input.date-select");
    },
    get $initRangeErrorBlock() {
      return this.$initRangeWrapper.find(".help-block");
    },
    get $endRangeErrorBlock() {
      return this.$endRangeWrapper.find(".help-block");
    }
  };
}



/**
   * @description - validate a range dates
   */
  function _isValidRange() {
    var isValidInitialDate = _isValidDate(calendarRange.$initRangeInput);
    var isValidFinalDate = _isValidDate(calendarRange.$endRangeInput);

    _toggleInvalidRangeError(calendarRange.$initRangeWrapper, !isValidInitialDate);
    _toggleInvalidRangeError(calendarRange.$endRangeWrapper, !isValidFinalDate);

    return (isValidInitialDate && isValidFinalDate);
  }



  /**
   * @description - validate a date of range input
   * @param {object} $input - jquery object of a range date input
   */
  function _isValidDate($input) {
    var date = $input.val();
    var isValid = true;
    if(!date) {
      isValid = false;
    } else {
      isValid =  moment(date,'DD/MM/YYYY').isValid();
    }
    return isValid;
  }



  /**
   * @description show/hide the range dates errors
   * @param {object} $wrapper - jquery object with the wrapper of the range date input
   * @param {boolean} isError - if the date is valid or not
   */
  function _toggleInvalidRangeError($wrapper, isError) {
    var $helpBlock = $wrapper.find(".help-block");
    if (isError) {
      $helpBlock.show();
      $wrapper.addClass('has-invalid-datepicker-error has-error').removeClass("has-success-datepicker");
    } else {
      $helpBlock.hide();
      $wrapper.removeClass('has-invalid-datepicker-error has-error').addClass("has-success-datepicker");
    }
  }



  /**
    * @description Inicializar funcionalidad occupancy
    */
   function initOccupancy () {

    // Crear instancia de occupancy
    reservationOccupancyNew.init($view);

    // ------------------------------------------------------------
    // Objeto inicial
    $occupancies = $formCustomerCare.find('.m-occupancy');
    occupancy = {
      obj: reservationOccupancyNew.getOccupancy($occupancies.data("occupancy-index")),
      $container: $formCustomerCare.find(".m-occupancy"),
      get $input() { return this.$container.find('.form-group'); },
      get $dropdown() { return this.$container.find('.m-occupancy-wrapper'); },
      get $list() { return this.$container.find('.option-list')[0]; },
      isMobile: false
    };


    // ------------------------------------------------------------
    // Controlar si estamos en mobile
    setMobile ();
    $(window).resize(function () { setMobile(); });

    function setMobile () {
      ( window.matchMedia('(max-width: 767px)').matches )
        ? occupancy.isMobile = true
        : occupancy.isMobile = false;
    }


    // ------------------------------------------------------------
    // Mostrar al clickar en input
    occupancy.$input.on('click', function (e) {
      let isOpen = $(occupancy.$dropdown).hasClass('is-open');
      if ( !isOpen ) {
        $(occupancy.$dropdown).addClass('is-open');

        if ( occupancy.isMobile ) {
          // remove focus from INPUT where we click when modal opens(mobile)
          this.blur();

          let headerMobile = occupancy.$container.find('.option-header').innerHeight();
          let footerMobile = occupancy.$container.find('.occupancy-footer').innerHeight();
          let ammount = headerMobile + footerMobile  + 60;
          occupancy.$container.find('.option-list').css({height: `calc(100vh - ${ammount}px`});

          // Block scroll in Body when fake modal is open and user scrolls in the modal
          bodyScrollLock.disableBodyScroll(occupancy.$list);
        }
      }
    });


    // ------------------------------------------------------------
    // Plegar occupancy al clicar en document
    $(document).on('click', function (ev) {
      let $target = $(ev.target);
      let isOpen = occupancy.$dropdown.hasClass('is-open');
      let inDropdown = $target.closest('.m-occupancy-wrapper').length;
      let inTrigger = $target.closest('.form-group').length;
      let infoInput = occupancy.$input.find("input.optionRooms");

      if ( (isOpen && !inTrigger && !inDropdown) ) {
        $(occupancy.$dropdown).removeClass('is-open');
        infoInput.val(infoInput.data('info'));
        occupancy.$input.find('label').addClass('focus');
      }
    });


    // ------------------------------------------------------------
    // Plegar occupancy al clicar en apply
    $(occupancy.$dropdown).find('.room-apply').click(function (e) {
      let infoInput = occupancy.$input.find("input.optionRooms");
      e.preventDefault();

      if ( occupancy.isMobile ) {
        bodyScrollLock.enableBodyScroll(occupancy.$list);
      }

      $(occupancy.$dropdown).removeClass('is-open');
      infoInput.val(infoInput.data('info'));
      occupancy.$input.find('label').addClass('focus');
    });


    // ------------------------------------------------------------
    // Habilitar/deshabilitar occypancy 5/6+ room
    let contRooms = 0;
    $(occupancy.$dropdown).find('.add-room button').click(function (e) {
      if ( $('.option.option-5').is(":visible") ) contRooms++;

      // Si llegamos las 5 habitaciones añadidas
      if ( occupancy.obj.roomsData.visibleRoomsList.length === 5 && contRooms > 1) {
        $(occupancy.$dropdown).removeClass('is-open');
        $formCustomerCare.find("input[name='occupancy-more']").prop( "checked", true ).trigger('change');
      }
    });

    // Resetear contador de rooms
    $(occupancy.$dropdown).find('.delete-room .nh-ic-close').click(function (e) {
      if ( contRooms > 0 ) contRooms = 0;
    });
  }


  /**
    * @description Comportamiento de 6+ habitaciones de occupancy
    */
  function _moreOccupancy (isChecked) {
    let occupancyInput = $formCustomerCare.find("input[name='occupancy']");
    $(occupancyInput).prop( "disabled", isChecked );
    // if (isChecked) console.log('occupancy 6');
    // else console.log('occupancy 5');
  }



  /**
    * @description Rellena los campos de inputs relacionados con el cliente
    */
  function inputsClient () {

    // Inicializar info del cliente
    infoClient = clientDetection();

    // Rellenar inputs de systema operativo, navegador y versión del navegador haciendo foco a sus label
    $formCustomerCare.find('input[name=so]').val(infoClient.os).prev('label').addClass('focus');
    $formCustomerCare.find('input[name=navegador]').val(infoClient.browser).prev('label').addClass('focus');
    $formCustomerCare.find('input[name=version]').val(infoClient.browserMajorVersion).prev('label').addClass('focus');
  }



  /**
    * @description Muestra el fieldset que nos interesa dependiendo de la elección del select de consulta
    */
  function showOptionFieldset (fieldsetID) {

    // Mostrar/ocultar fieldsets
    $formCustomerCare.find("fieldset[id*='info']").addClass('hide');
    $formCustomerCare.find(`fieldset[id=${fieldsetID}]`).removeClass('hide');

    // Cambiar data-validate de los fieldsets
    $formCustomerCare.find("fieldset[id*='info']").each(function (index, fieldset) {
      $(fieldset).find('input,textarea,select').filter('[data-validate]').attr('data-validate', false);
    });
    $formCustomerCare.find(`fieldset[id=${fieldsetID}]`).find('input,textarea,select').filter('[data-validate]').attr('data-validate', true);
    $formCustomerCare.validator('update');
  }



  /**
    * @description Handle the click over the gdpr checks
    */
   function _onClickGDPRchecbox () {
    var $this = $(this);
    var value = $this.prop("checked") ? 'S' : 'N';
    $this.val(value);
  }



  /**
    * @description
    */
  function _onSubmitCustomerCare() {

    // ------------------------------------------------------------
    // Datos de mail a enviar según el tema

    let mailData = JSON.parse('{"topicList":[{"ccList":[],"bccList":[],"name":"infoReservas","subject":"Customer Service: Information about reservations","to":"bookings@nh-hotels.com","fromName":"bookings"},{"ccList":[],"bccList":[],"name":"infoHoteles","subject":"Customer Service: Information about the hotels","to":"bookings@nh-hotels.com","fromName":"bookings"},{"ccList":[],"bccList":[],"name":"infoSugerencias","subject":"Customer Service: Suggestions and opinions about your stay","to":"customercare@nh-hotels.com","fromName":"CustomerCare"},{"ccList":[],"bccList":[],"name":"infoWeb","subject":"Customer Service: Suggestions and opinions about the website","to":"customercare@nh-hotels.com","fromName":"CustomerCare"},{"ccList":[],"bccList":[],"name":"infoTecnicos","subject":"Customer Service: Technical issues","to":"customercare@nh-hotels.com","fromName":"CustomerCare"},{"ccList":[],"bccList":[],"name":"infoNHRewards","subject":"Customer Service: NH Rewards","to":"nhrewards@nh-hotels.com","fromName":"nhworld.app"}]}');
    let to = jsonPath(mailData, "$..topicList[?(@.name=='" + $formConsulta.val() + "')].to");
    let subject = jsonPath(mailData, "$..topicList[?(@.name=='" + $formConsulta.val() + "')].subject");
    let fromName = jsonPath(mailData, "$..topicList[?(@.name=='" + $formConsulta.val() + "')].fromName");
    $formCustomerCare.find("#emailTo").val(to);
    $formCustomerCare.find("#subject").val(subject);
    $formCustomerCare.find("#fromName").val(fromName);


    // ------------------------------------------------------------
    // Generar y rellenar inputs hidden de occupancy

    let valueHabitaciones = null;
    if ( !$formCustomerCare.find('#occupancy-more').is(':checked') ) {
      let occupancyInputs = occupancy.obj.generateInputsFields();
      $formCustomerCare.prepend(occupancyInputs);
      valueHabitaciones = occupancy.obj.roomsData.visibleRoomsList.length;

    } else {
      valueHabitaciones = '6+';
    }
    $formCustomerCare.find("[name='habitaciones']").val(valueHabitaciones);
  }



  // Public API
  return {
    init: init
  };
})(reservationOccupancyNew);


$(function () {
  if ( $('.p-customer-care').length ) {
    pCustomerCare.init( $('.p-customer-care') );
  }
});

var pDonate = (function () {

  let $pDonateView = null;
  let config = {
    lowerLimitDonate: "10",
    maxLimitDonate: "0",
    messages: {
      "error_donate_fields": "The amount of points transferred cannot be less than 30",
      "error_min_max": "The maximum number of points to donate is less than the minimum number of points required.", //El número máximo de puntos a donar es inferior al mínimo 
      "error_donate_exception": 'An error has occured, please contact the Customer Care team.',
      "success_message": "The operation was completed correctly"
    }
  };

  let donateInterval = null;
  let modals = null; //se creará un objeto con las modales de success y error
  let donate = null; //objeto con todos los elementos relacionados con donar puntos (boton de añadir, quitar, mensaje de error, btn guardar puntos,...)
  let remaining = null; //objeto con todos los elementos relacionados con los puntos del usuario que puede donar (cabecera, puntos ,....)

  /**
   * @description - init module
   */
  function init(view) {
    $pDonateView = view;
    _setConfig();
    _setElements();
    _validatePoints();

    //counter.$increaseBtn.on("mousedown touchstart", function(ev) {
    donate.$increaseBtn.on("mousedown touchstart", _addPoints)
      .on("mouseup touchend", function () {
        clearInterval(donateInterval);
      }).on("click", function () {
        _validatePoints(true);
      });

    donate.$decreaseBtn.on("mousedown touchstart", _removePoints)
      .on("mouseup touchend", function () {
        clearInterval(donateInterval);
      }).on("click", function () {
        _validatePoints(true);
      });

    donate.$saveDonateBtn.on("click", _onClickSaveBtn);
  }

  /*******************/
  /* PRIVATE METHODS */
  /*******************/

  /**
   * @description - actualizar datos de la página
   * @param {object} data - objeto con los nuevos datos de la página (puntos a donar,...)
   */
  function _actualizeData(data) {
    config.maxLimitDonate = data.limitDonate;
    config.minLimitDonate = data.minLimitDonate;

    // Actualiza los remaining
    //  en cabecera
    remaining.$userPoints.text(formatPoints(data.points));
    remaining.$userValue.text(formatPoints(data.value));
    //  en seccion 'Points you can donate'
    remaining.$points.text(formatPoints(data.limitDonate));
    remaining.$lowerLimitInfo.text(formatPoints(data.minLimitDonate));
    remaining.$limitDonateInfo.text(formatPoints(data.limitDonate));
    remaining.$totalPointsInfo.text(formatPoints(data.points));

    //actualiza los donate points
    donate.data.points = 0;
    donate.$points.text(0).data({
      "min-points": formatPoints(data.minLimitDonate),
      "max-points": formatPoints(data.limitDonate)
    });
  }

  /**
   * @description - comportamiento al pulsar o mantener pulsado el boton de añadir puntos
   */
  function _addPoints() {
    var incremental = (donate.data.points === 0) ? 30 : 1;
    clearInterval(donateInterval); //eliminamos el set interval para que pare el incremento ya que sucede tan rápido que no salta el mouseup para pararlo

    //EY ericrodriguez: añadir lógica para sumar puntos solo si tenemos más puntos que el mínimo a donar
    if (remaining.data.points >= config.lowerLimitDonate || (incremental == 1 && remaining.data.points > 0)) {
      donate.data.points += incremental;
      remaining.data.points -= incremental;
      donate.$points.html(utils.addThousandsSeparator(donate.data.points));
      remaining.$points.html(utils.addThousandsSeparator(remaining.data.points));
      donateInterval = setInterval(_addPoints, 100);
    } else {
      donate.$increaseBtn.trigger("click");
    }

    donate.$increaseBtn.prop('disabled', (remaining.data.points === 0));
    donate.$decreaseBtn.prop('disabled', (donate.data.points === 0));
  }

  /**
   * @description - Control de la respuesta a la llamada de donar puntos para controlar sucess y error
   * @param {string} errorCode - código de la respuesta (ok o ko y que tipo de ko es)
   * @returns - si el resultado es ok o ko
   */
  function _checkResult(errorCode) {
    var $modal;
    var isSucces = (errorCode === "00000" || !errorCode);
    var errors = {
      "00000": config.messages["success_message"],
      "99999": config.messages["error_donate_exception"],
      "00010": config.messages["error_donate_fields"]
    };

    if (errorCode) {
      $modal = (errorCode === "00000") ? modals.success : modals.error;
      $modal.find(".modal-body p").text(errors[errorCode]);
      $modal.modal('show');
    }

    return isSucces;
  }

  /**
   * @description formateo de un valor introduciendo puntos de miles,...
   * @param {any} value - valor a fomatear
   * @returns - valor formateado
   */
  function formatPoints(value) {
    return value != null && value != "undefined" && !isNaN(value) ? value.formatMoney(0, "", ".", ",") : 0;
  }

  /**
   * @description - Controlar el click sobre el botón de guardar puntos
   */
  function _onClickSaveBtn() {
    var $this = $(this);
    var ongId = $(this).data('ong-id');

    $this.prop('disabled', true);

    if (!_validate(ongId)) {
      $this.prop('disabled', false);
      return;
    }

    _saveDonatePoints(ongId);
  }

  /**
   * @description - comportamiento al pulsar o mantener pulsado el boton de eliminar puntos
   */
  function _removePoints() {
    var incremental = (donate.data.points === 30) ? 30 : 1;
    clearInterval(donateInterval); //eliminamos el set interval para que pare el incremento ya que sucede tan rápido que no salta el mouseup para pararlo

    if (donate.data.points > 0) {
      donate.data.points -= incremental;
      remaining.data.points += incremental;
      donate.$points.html(utils.addThousandsSeparator(donate.data.points));
      remaining.$points.html(utils.addThousandsSeparator(remaining.data.points));
      donateInterval = setInterval(_removePoints, 100);
    } else {
      donate.$decreaseBtn.trigger("click");
    }

    donate.$increaseBtn.prop('disabled', (remaining.data.points === 0));
    donate.$decreaseBtn.prop('disabled', (donate.data.points === 0));
  }

  /**
   * @description - llamada a guardar puntos y control del resultado
   * @param {string} ongId - id de la ong a donar
   */
  function _saveDonatePoints(ongId) {
    var data = {
      ongId: ongId,
      points: donate.data.points
    };

    //INI - SOLO PARA DESARROLLO
    /*var promise = $.Deferred();
    setTimeout(function () {
      promise.resolve({ //cambiar a reject para probar llamada erronea
        points: 3000,
        value: 1500,
        limitDonate: 1000,
        minLimitDonate: 500,
        errorCode: '00000' //cambiar a 99999 o 00010 para probar error sin ser reject
      });
    }, 1000);*/
    //FIN - SOLO PARA DESARROLLO

    //INI - SOLO PARA PRODUCCION
    var url = "/rewards/savedonate";
    var promise = $.ajax({
      url: url,
      type: 'POST',
      data: JSON.stringify(data),
      contentType: 'application/json'
    });
    //FIN - SOLO PARA PRODUCCION

    donate.$saveDonateBtn.prop("disabled", true);

    promise.then(function (response) {
      // Check the result code
      if (!_checkResult(response.errorCode)) { //chequeamos si es error y mostramos modal de error o succes
        return;
      }
      // Refresh page
      _actualizeData(response);
      _validatePoints();
    }, function () {
      modals.error.find(".modal-body p").text(config.messages["error_donate_exception"]);
      modals.error.modal('show');
    }).always(function () {
      donate.$saveDonateBtn.prop('disabled', false);
    });
  }

  /**
   * @description - inicializamos la configuración con la configuración que vaya en el propio html (si lo hay) o nos quedamos con la de por defecto de este fichero
   */
  function _setConfig() {
    if (typeof donateConfig !== "undefined" && donateConfig) {
      $.extend(config, donateConfig);
    }

    config.lowerLimitDonate = (config.lowerLimitDonate !== "") ? parseInt(config.lowerLimitDonate) : 0;
    config.maxLimitDonate = config.maxLimitDonate !== "" ? parseInt(config.maxLimitDonate) : 0;
  }

  /**
   * @description - cacheamos todos los elementos para interactuar con ellos (modales, donate points, remaining points)
   */
  function _setElements() {
    //modales de error
    modals = {
      error: $("#modal-error"),
      success: $("#modal-success")
    };

    //elementos relacionados con donar puntos
    donate = {
      $container: $pDonateView.find(".send-your-points"), //contenedor de puntos a donar
      get errorMessage() {
        return this.$container.find("#error-message");
      },
      get $increaseBtn() {
        return this.$container.find("#maxiMum"); //boton mas
      },
      get $decreaseBtn() {
        return this.$container.find("#miniMum"); //botón menos
      },
      get $saveDonateBtn() {
        return this.$container.find("#saveDonate"); //boton donar
      },
      get $points() {
        return this.$container.find("#pointsId");
      },
      data: { //puntos disponibles para donar y puntos seleccionados a donar
        get points() {
          return donate.$points.data("points") || 0;
        },
        set points(value) {
          donate.$points.data("points", value);
        }
      }
    };

    //elementos relaciones con putos de usuario (los puntos restantes a donar)
    remaining = {
      $container: $pDonateView.find(".your-points"), //contenedor de puntos a donar
      get $userPoints() {
        return $("#nhUser-points");
      },
      get $userValue() {
        return $("#nhUser-value");
      },
      get $points() { //contenedor de puntos disponibles
        return this.$container.find("#pointsLeft");
      },
      get $lowerLimitInfo() {
        return this.$container.find("#lowerLimitDonate");
      },
      get $limitDonateInfo() {
        return this.$container.find("#limitDonate");
      },
      get $totalPointsInfo() {
        return this.$container.find("#totalPoints");
      },
      get value() { //eliminar si no se usa
        return (this.$container.data("points") || 0);
      },
      data: {
        get points() {
          return remaining.$points.data("points") || 0;
        },
        set points(value) {
          remaining.$points.data("points", value);
        }
      }
    };
  }

  /**
   * @description - comprobar que se tiene id de ong a donar y que los puntos son validos
   * @param {string} ongId
   * @returns si hay id de ong y si los puntos son validos
   */
  function _validate(ongId) {
    // Valida que exista ongId
    if (!ongId) {
      modals.error.find(".modal-body p").text(config.messages["error_donate_fields"]);
      modals.error.modal('show');
      return false;
    }

    return _validatePoints(true);
  }

  /**
   * @description - Valida que los puntos cumplen con las condiciones de puntos minimos y maximos para mostrar mensaje de error
   * @param {boolean} showMessage - si se debe o no mostrar el mensaje
   * @returns si los puntos son validos o no
   */
  function _validatePoints(showMessage) {
    var isValidPoints = (donate.data.points >= config.lowerLimitDonate);
    var showError = (!isValidPoints && showMessage);

    if (config.maxLimitDonate < config.lowerLimitDonate) {
      donate.errorMessage.text(config.messages.error_min_max);
      donate.$saveDonateBtn.prop('disabled', true);
      return false;
    }

    donate.errorMessage.toggle(showError);
    donate.$saveDonateBtn.prop('disabled', !isValidPoints);
    return isValidPoints;
  }

  Number.prototype.formatMoney = function (places, symbol, thousand, decimal) {
    places = !isNaN(places = Math.abs(places)) ? places : 2;
    symbol = symbol !== undefined ? symbol : "$";
    thousand = thousand || ",";
    decimal = decimal || ".";
    var number = this,
      negative = number < 0 ? "-" : "",
      i = parseInt(number = Math.abs(+number || 0).toFixed(places), 10) + "",
      j = (j = i.length) > 3 ? j % 3 : 0;
    return symbol + negative + (j ? i.substr(0, j) + thousand : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousand) + (places ? decimal + Math.abs(number - i).toFixed(places).slice(2) : "");
  };
  // Public API
  return {
    init: init
  };
})();

$(function () {
  if ($(".p-rewards-donate").length) {
    pDonate.init($(".p-rewards-donate"));
  }
});

var nhFaqCustomerCare = (function () {

  var $customerCareForm = $('#form-customer-care');


  function init() {
    
      $customerCareForm.validator({
          disable: false,
      }).on('submit', function (e) {
          var $form = $(this);
          toggleLoadingButton($form, true);
          if (e.isDefaultPrevented()) {
            // Invalid Form
            toggleLoadingButton($form, false);
          } else {
            toggleLoadingButton($form, false);
            //_onSubmitForm();
          }
      });
  }

  /*******************/
  /* PRIVATE METHODS */
  /*******************/
  /**
   * @description behaviour when the form is submitted
   */

  /**
   * 
   */
  // Public API
  return {
      init: init
  };
})();


$(function () {

  nhFaqCustomerCare.init();

});


var pHotelMap = (function () {

  var $pHotelMapView = $(".p-hotel-map");

  var map = null;

  var locationData = {
    $mapContainer: $(".m-hotel-map"),
    map: null,
    markers: null,
    $elements: $pHotelMapView.find(".m-how-to-arrive"),
    objects: {},
    $modal: $("#modal-how-to-arrive"),
    $poisContent: $pHotelMapView.find(".m-points-interest"),
    $directionPanel: $pHotelMapView.find(".m-result-maps"),
    get $map() {
      return this.$mapContainer.find(".hotel-map");
    },
    get $goToGoogleMapsBtns() {
      return this.$elements.find(".goto-googlemaps");
    },
    get $showPoiOnMapLinks() {
      return this.$poisContent.find("a");
    },
    get hotelLatLng() {
      return {
        lat: this.$map.data("hotel-latlng")[0],
        lng: this.$map.data("hotel-latlng")[1]
      };
    }

  };

  var mPois = {
    $poisContanier: $pHotelMapView.find(".m-points-interest"),
    get $pois() {
      return this.$poisContanier.find(".item");
    }
  };

  /**
   * @description - init module
   */
  function init() {
    $.each(locationData.$elements, (index, element) => {
      var $this = $(element);
      locationData.objects[index] = _getLocationObject($this);
      locationData.objects[index].$showDirectionBtn.on("click", {index: index}, _getRoute);
      locationData.objects[index].$goToGoogleMapsBtn.on("click", {index: index}, _goToGoogleMaps);
    });

    _setPoisDistance();

    locationData.$modal.on("show.bs.modal", () => {
      $(".pac-container").addClass("inModal");
    }).on("hide.bs.modal", () => {
      $(".pac-container").removeClass("inModal");
    });

    locationData.$showPoiOnMapLinks.on("click", _showPoiOnMap);
  }

  /*******************/
  /* PRIVATE METHODS */
  /*******************/

  function _setPoisDistance() {
    var distance;
    var origin = {
      lat: markersArray[0].location[0],
      lng:  markersArray[0].location[1]
    };
    //the first marker is the hotel. We have to avoid it
    var pois = markersArray.slice(1);
    $.each(pois, function(index, poiInfo) {

      distance = utils.getDistanceBetweenCoords(origin, {"lat": poiInfo.location[0], "lng": poiInfo.location[1]}) + " km";
      if(mPois.$pois[index]) {
        mPois.$pois.eq(index).find("span").text(distance);
      }
    });
  }

  /**
   * @description get the object to get direction with its data
   * @param {object} $element - jquery object with the parent element of form to get direction
   * @returns object to get direction with its data
   */
  function _getLocationObject($element) {
    return {
      $searchInput: $element.find(".inputGoDestiny"),
      $type: $element.find("input:radio"),
      $showDirectionBtn: $element.find(".showdirections"),
      $goToGoogleMapsBtn: $element.find(".goto-googlemaps")
    };
  }

  /**
   * @description get the route form origin to destination of google maps
   * @param {object} ev - event object with its data
   */
  function _getRoute(ev) {
    var $formClicked = locationData.objects[ev.data.index];
    var directionsDisplay = new google.maps.DirectionsRenderer();
    var directionsService = new google.maps.DirectionsService();
    var request = {
      origin: $formClicked.$searchInput.val(),
      destination: new google.maps.LatLng(locationData.hotelLatLng.lat, locationData.hotelLatLng.lng),
      travelMode: google.maps.TravelMode[$formClicked.$type.filter(":checked").val()]
    };

    locationData.map = mHotelMapInline.getMap(0);

    directionsDisplay.setMap(locationData.map);
    directionsDisplay.setPanel(locationData.$directionPanel[0]);

    if(_isValidRequest(request)) {
      directionsService.route(request, function (response, status) {
        locationData.$directionPanel.empty();
        if (status === google.maps.DirectionsStatus.OK) {
          directionsDisplay.setDirections(response);
          locationData.$modal.modal('hide');
        } else {
          locationData.$directionPanel.append("<section class='m-alert' role='alert'><div class='alert alert-warning'><p>No results available</p></div></section>");
        }
      });
    }
  }

  /**
   * @description - opent in new window/tab a google maps with the route
   * @param {object} ev - event object with its data
   */
  function _goToGoogleMaps(ev) {
    var $formClicked = locationData.objects[ev.data.index];
    var data = {
      origin: $formClicked.$searchInput.val().replace(/ /g, "+"),
      destination: new google.maps.LatLng(locationData.hotelLatLng.lat, locationData.hotelLatLng.lng),
      get googleUrl() {
        return "https://maps.google.com?saddr=" + this.origin + "&daddr=" + this.destination.toUrlValue();
      }
    };

    window.open(data.googleUrl, "_blank");
  }

  /**
   * @description - check if the origin o destination selected are valid
   * @param {object} request - object that contains the origin and destination
   * @returns
   */
  function _isValidRequest(request) {
    var isValid = true;
    if(!request.origin || !request.destination) {
      isValid = false;
    }
    return isValid;
  }

  /**
   * @description - scroll to google mapa and show the information of poi selected
   * @param {object} ev - event object with its data
   */
  function _showPoiOnMap(ev){
    var $this = $(this);
    var markerIndex= $this.data("index");
    var markers = mHotelMapInline.getMarkers(0);
    ev.preventDefault();

    locationData.map = (!locationData.map) ? mHotelMapInline.getMap(0) : locationData.map;

    if(locationData.$map.length) {
      locationData.map.panTo(markers[markerIndex].getPosition());
      google.maps.event.trigger(markers[markerIndex], 'click');
      $("html, body").animate({ scrollTop: 90 }, "slow");
    }
  }

  // Public API
  return {
    init: init
  };
})();

$(function () {
  if ($(".p-hotel-map").length) {
    pHotelMap.init();
  }
});
var nhHowToArrive = (function () {

	var directionsDisplay;

	function init() {
		/*Boton=calcRoute(),muestraRoute()*/
		/*TO DO necesita el script <script type="text/javascript" src="https://maps.google.com/maps/api/js?client=gme-nhhotels&v=3&language=es&libraries=places"> */
	}

	/*******************/
	/* PRIVATE METHODS */
	/*******************/


	function _calcRoute() {

		if (directionsDisplay != null) {
			directionsDisplay.setMap(null);
			directionsDisplay.setPanel(null);
			directionsDisplay = null;
		}
		directionsDisplay = new google.maps.DirectionsRenderer();

		directionsDisplay.setMap(map);
		/*necesita div en maqueta <div class="dir-mrgnr" id="directionsPanel"></div>*/
		directionsDisplay.setPanel(document.getElementById("directionsPanel"));

		var start = document.getElementById('mapOrigin').value;
		var end = new google.maps.LatLng(40.427538, -3.685109);
		var request = {
			origin: start,
			destination: end,
			travelMode: google.maps.TravelMode[typeOfTravel]
		};


		directionsService.route(request, function (response, status) {
			if (status == google.maps.DirectionsStatus.OK) {
				$("#directionsPanel").text("");
				$("#directionsPanel").attr("class", "dir-mrgnr");
				directionsDisplay.setDirections(response);
			}
			else {
				$("#directionsPanel").text("");
				$("#directionsPanel").attr("class", "dir-mrgnr alert-danger");
				$("#directionsPanel").append("No results available");
			}
		});

	}


	// Public API
	return {
		init: init
	};
})();

$(function () {
	if($(".how-to-arrive").length)  nhHowToArrive.init();
});


var nhReWardsSignUp = (function () {

  const $nhRewardsSignUpForm = $('#form-rewards-account');
  var $gdprChecks = $nhRewardsSignUpForm.find("input[id*='GDPR_flag']");
  var nationalitySelects = {
    $nationality: $nhRewardsSignUpForm.find("#nacionalidad"),
    $dniContainer: $nhRewardsSignUpForm.find("#cDni"),
    get $dniContent() {
      return this.$dniContainer.find(".form-group");
    },
    $dni: $nhRewardsSignUpForm.find("#dni")
  };

  function init() {
    $nhRewardsSignUpForm.validator({
      disable: false,
      custom: {
        'docNumber': customDocumentNumberValidator,
        'birth-date': customBirthDateValidator.bind(this)
      }
    }).on('submit', function (e) {
      var $form = $(this);
      toggleLoadingButton($form, true);
      if (e.isDefaultPrevented()) {
          // Invalid Form
          toggleLoadingButton($form, false);
      } else {
          toggleLoadingButton($form, false);
      }
    });

    //change
    nationalitySelects.$nationality.on("change", _onChangeNationality);
    //handle click event over the gdpt checks inputs
    $gdprChecks.on("change", _onClickGDPRchecbox);
  }

    /*******************/
    /* PRIVATE METHODS */
    /*******************/

    function _onChangeNationality() {
      var nationality = $(this).val();
      if(nationality !== "ES" && nationality !== "IT") {
        nationalitySelects.$dni.val("").attr('data-validate', "false").prop("required", false);
        nationalitySelects.$dniContent.removeClass("has-feedback has-success has-error");
        nationalitySelects.$dniContainer.addClass("hide");
      } else {
        nationalitySelects.$dniContainer.removeClass("hide");
        nationalitySelects.$dniContent.addClass("has-feedback");
        nationalitySelects.$dni.attr('data-validate', "true").prop("required", true);
      }
    }

    /**
    * @description handle the click over the gdpr checks
    */
    function _onClickGDPRchecbox() {
      var $this = $(this);
      var value = ($this.prop("checked")) ? 'S' : 'N';
      $this.val(value);
    }

    /**
    * Custom validator to check if the birth date is a past date
    * @return {[type]} [description]
    */
    function customBirthDateValidator() {
      if (this.datepickerSelector.selectorDatepicker('checkIsValidDate', true) === true) {
        if (this.datepickerSelector.selectorDatepicker('checkTimelineDate') === 1) {
          return 'error';
        }
      }
    }

    function customDocumentNumberValidator($el) { 

      // whichCountryIsSelected as IT, ES and so  
      const whichCountryIsSelected = $(nationalitySelects.$nationality).find('option:selected').attr('value');
     
      if (!$el.val()) {
        return;
      }

      var isValid = commonFormSetup.validateNumberDocument('dni', $el.val());

      // DNI Validation only applies to SPAIN
      if (!isValid && whichCountryIsSelected === 'ES') {
        return 'error';
      }
  }
    
    // Public API
    return {
      init: init
    };
})();

$(function () {
  nhReWardsSignUp.init();
});


/**
* Guest Data Module
* @return {[type]} [description]
*/
var organizeEvent = (function () {
  var organizeEventView = $('.p-organize-event');
  var organizeEventForm = $("#organizeEventForm");
  var calendarRange = null;

  /*variables necesarias*/
  /*Custom Scrpit 2*/
  var jsonData = JSON.parse('{"emails":[{"email":"nh.groupdesk@nh-hotels.com","country":"tcm:41-693-1024"},{"email":"nh.groupdesk@nh-hotels.com","country":"tcm:41-685-1024"},{"email":"nh.groupdesk@nh-hotels.com","country":"tcm:41-703-1024"},{"email":"nh.groupdesk@nh-hotels.com","country":"tcm:41-700-1024"},{"email":"nh.groupdesk@nh-hotels.com","country":"tcm:41-698-1024"},{"email":"nh.groupdesk@nh-hotels.com","country":"tcm:41-695-1024"},{"email":"nh.groupdesk@nh-hotels.com","country":"tcm:41-690-1024"},{"email":"gruposnh@nh-hotels.com","country":"tcm:41-654-1024"},{"email":"gruposnh@nh-hotels.com","country":"tcm:41-699-1024"},{"email":"groups.it@nh-hotels.com","country":"tcm:41-682-1024"},{"email":"nhmeetingsales.nl@nh-hotels.com","country":"tcm:41-686-1024"},{"email":"nhmeetingsales.nl@nh-hotels.com","country":"tcm:41-696-1024"},{"email":"nhmeetingsales.nl@nh-hotels.com","country":"tcm:41-704-1024"},{"email":"group.mx@nh-hotels.com","country":"tcm:41-697-1024"},{"email":"groups.mercosur@nh-hotels.com","country":"tcm:41-684-1024"},{"email":"groups.mercosur@nh-hotels.com","country":"tcm:41-687-1024"},{"email":"groups.mercosur@nh-hotels.com","country":"tcm:41-707-1024"},{"email":"groups.mercosur@nh-hotels.com","country":"tcm:41-709-1024"}],"emailDefault":"nhinternationalgroupsales@nh-hotels.com","subject":"Your meeting request is being processed"}');
  /*F.Custom Scrpit 2*/


  function init() {

    $('#personalizeEvent').click(function(){
      $('button').removeClass('clicked');
      $(this).addClass('clicked');
    });
    $('#sendRequest').click(function(){
      $('button').removeClass('clicked');
      $(this).addClass('clicked');
    });

    organizeEventForm.validator({
      disable: false,
      custom: {

      }
    }).on('submit', function (e) {
      var $form = $('#organizeEventFormHidden');
      toggleLoadingButton($form, true);
      var $id = $(this).find('button.clicked').attr('id');

      var validForm = true;
      var isValidateRange = $('.range-calendar').is(":visible");
      ( isValidateRange ) ? _initRangeSelectors() : calendarRange = null;

      if (e.isDefaultPrevented()) {
        // Invalid Form
        toggleLoadingButton($form, false);
        _isValidRange();

      } else {
        validForm = (isValidateRange) ? _isValidRange() : true;
        e.preventDefault();
        if (!validForm) {
          e.preventDefault();
        } else {
          // console.log('no falla');
          _onSubmitForm($id);
        }
      }
    });

  }

  /*******************/
  /* PRIVATE METHODS */
  /*******************/

  /**
  * @description - Init range calendar selectors
  */
  function _initRangeSelectors() {
    calendarRange = {
      $rangeSelector: $('.range-calendar:visible'),
      get $initRangeWrapper() {
        return this.$rangeSelector.find(".init-range-calendar .js-input-wrapper");
      },
      get $endRangeWrapper() {
        return this.$rangeSelector.find(".end-range-calendar .js-input-wrapper");
      },
      get $initRangeInput() {
        return this.$initRangeWrapper.find("input.date-select");
      },
      get $endRangeInput() {
        return this.$endRangeWrapper.find("input.date-select");
      },
      get $initRangeErrorBlock() {
        return this.$initRangeWrapper.find(".help-block");
      },
      get $endRangeErrorBlock() {
        return this.$endRangeWrapper.find(".help-block");
      }
    };
  }

  /**
  * @description show/hide the range dates errors
  * @param {object} $wrapper - jquery object with the wrapper of the range date input
  * @param {boolean} isError - if the date is valid or not
  */
  function _toggleInvalidRangeError($wrapper, isError) {
    var $helpBlock = $wrapper.find(".help-block");
    if (isError) {
      $helpBlock.show();
      $wrapper.addClass('has-invalid-datepicker-error has-error').removeClass("has-success-datepicker");
    } else {
      $helpBlock.hide();
      $wrapper.removeClass('has-invalid-datepicker-error has-error').addClass("has-success-datepicker");
    }
  }


  /**
  * @description behaviour when the form is submitted
  */
  function _isValidDate($input) {
    var date = $input.val();
    var isValid = true;
    if(!date) {
      isValid = false;
    } else {
      isValid =  moment(date,'DD/MM/YYYY').isValid();
    }
    return isValid;
  }
  function _isValidRange() {
    var isValidInitialDate = _isValidDate(calendarRange.$initRangeInput);
    var isValidFinalDate = _isValidDate(calendarRange.$endRangeInput);

    _toggleInvalidRangeError(calendarRange.$initRangeWrapper, !isValidInitialDate);
    _toggleInvalidRangeError(calendarRange.$endRangeWrapper, !isValidFinalDate);

    return (isValidInitialDate && isValidFinalDate);
  }

  function _onSubmitForm($id) {

    //fillHiddenInputsOrganize true si paso por personalize
    fillHiddenInputsOrganize ($id);
	
  }

  /*custom Script1*/
  function fillHiddenInputsOrganize($id) {

    let personalize = ($id=='personalizeEvent') ? true : false

    var initDate = $('input[id="start-date"]').val();
    var starDateFormatted = moment(initDate,'DD/MM/YY').format('DD/MM/YYYY');
    var endDate = $('input[id="end-date"]').val();
    var endDateFormatted = moment(endDate,'DD/MM/YY').format('DD/MM/YYYY');

    $('input[name="nAssistants"]').val($('input[id="asistentes"]').val());
    $('input[name="eventType"]').val($('[id="evento"]').val());
    $('input[name="fini"]').val(starDateFormatted);
    $('input[name="fout"]').val(endDateFormatted);
    $('input[name="comments"]').val($('[id="comentarios"]').val());
    $('input[name="contactName"]').val($('input[id="nombre"]').val());
    $('input[name="contactSurname"]').val($('input[id="apellidos"]').val());
    $('input[name="contactEmail"]').val($('input[id="email"]').val());
    $('input[name="contactPhone"]').val($('input[id="phone"]').val());
    $('input[name="company"]').val($('input[id="empresa"]').val());
    $('input[name="contactCountry"]').val($('[id="pais"]').val());
    $('input[name="contactCity"]').val($('[id="ciudad"]').val());
    $('input[name="receiveEventsOffers"]').val($('[id="receiveOffers"]').is(':checked'));
    $('input[name="acceptTermsAndConditions"]').val($('[id="acepto"]').is(':checked'));
    $('input[name="personalize"]').val(personalize);
    $('input[name="helpPhone"]').val($('#helpTelephone').text());

    $('.m-GDPR').find("input[name*='GDPR']").each(function() {
      if($(this).is(':checked')){
        var inputGDPR = '<input name="'+ $(this).attr('name') +'" value="'+ $(this).val() +'"/>';
        $('#organizeEventFormHidden').append(inputGDPR);
      }
    });
    var emailTo = "";
    for (var i = 0; i < jsonData.emails.length; i++) {
      if (jsonData.emails[i].country == $('#pais').val()) {
        emailTo = jsonData.emails[i].email;
        break;
      }
    }
    if (!emailTo.length) {
      emailTo = jsonData.emailDefault;
    }
    $("#emailTo").val(emailTo);
    $("#subject").val(jsonData.subject);
    $('#organizeEventFormHidden').submit();

  }

  /*******************/
  /* PUBLIC API */
  /*******************/
  return {
    init: init
  };

})();


$(function () {
  if($("#organizeEventForm").length) {
    organizeEvent.init();
  }
});

var nhPersonalizeEvent = (function () {

  var nhPersonalizeEventForm = $('#nhPersonalizeEventForm');
  var $gdprChecks = nhPersonalizeEventForm.find("input[id*='GDPR_flag']");

  function init() {

    //Open first collapse
    $('.panel:first-child a.collapsed').click();

    //replicate rooms
    var i=0;
    $('.js-replicate-rooms').click(function(e){
      e.preventDefault();
      //choose layer to clone
      var $thisLayerAppend = $(this).closest('.panel').find('.dynamic');
      var $this = $(this).closest('.panel').find('.oneClone.hide').clone().appendTo($thisLayerAppend).addClass('cloned').removeClass('hide');
      //elimina y recarga selectpicker
      $this.find('.dropdown-menu').remove();
      $this.find('.dropdown-toggle').remove();
      $this.find('select.selectpicker').selectpicker();
      //increase ID and change it
      i++;
      $this.attr('id','clone-0-'+ i + '');

      //write names&for in new fields
      $this.find('[data-field="trooms"]').find('label').attr('for', 'trooms-0-'+ i + '');
      $this.find('[data-field="trooms"]').find('select').attr('id', 'trooms-0-'+ i + '');
      $this.find('[data-field="trooms"]').find('select').attr('name', 'dayCustomEvent[0].roomsInfo[[' + i + '].roomType');

      $this.find('[data-field="enrooms"]').find('label').attr('for', 'enrooms-0-'+ i + '');
      $this.find('[data-field="enrooms"]').find('select').attr('id', 'enrooms-0-'+ i + '');
      $this.find('[data-field="enrooms"]').find('select').attr('name', 'dayCustomEvent[0].roomsInfo[[' + i + '].nRooms');

      $this.find('[data-field="days"]').find('label').attr('for', 'days-0-'+ i + '');
      $this.find('[data-field="days"]').find('select').attr('id', 'days-0-'+ i + '');
      $this.find('[data-field="days"]').find('select').attr('name', 'dayCustomEvent[0].roomsInfo[[' + i + '].roomDays');

    });

    //EY remove rooms
    $("body").on(
      'click', '.js-remove-room', function () {
        $(this).closest('.oneClone').remove();
    });

    $('select , input.form-control').each(function () {
      var $this = $(this);
      var attrId = $(this).attr('id');
      if (typeof attrId !== typeof undefined && attrId !== false) {
        var toRemove=  $this.attr('id');
      }
      //Remove numbers & '-'
      var dataFieldset = toRemove.replace(/\d+/g , '');
      var dataFieldsetClean = dataFieldset.replace('-', '');
      //Add data value to inputs
      $this.attr('data-fieldset', dataFieldsetClean);
      //
      $this.attr('open-collapses','');

    });

    function replicateFields(){
      //reply rooms
      //  var cloneRooms = $('.panel:first-child .dynamic').clone();
      //  var wheretoClone = $('.panel:not(:first-child)').find('.dynamic');
      //  var cloneWrapper = wheretoClone.append('<div class="appendDiv"/>');
      //  cloneWrapper.append(wheretoClone);
      //  cloneRooms.appendTo(cloneWrapper);
      //  wheretoClone.addClass('cloned-rooms');


      //reply checkbox
      $("input:checked").each(function () {
        var sameField = $(this).attr('data-fieldset');
        $('[data-fieldset=' + sameField + ']').attr('checked', true);
      });
      //reply inputs
      $('input.form-control').each(function(){
        var sameField = $(this).attr('data-fieldset');
        var sameValue = $(this).val();
        $('[data-fieldset=' + sameField + ']').val(sameValue);
        if (sameValue !=""){
          $(this).closest('.form-group').find('.labelup-control').addClass('focus');
        }
      });
      //reply selects
      $('select').each(function(){
        var sameField = $(this).attr('data-fieldset');
        var sameValue = $(this).val();
        $('[data-fieldset=' + sameField + ']').val(sameValue);
        $('.selectpicker').selectpicker('refresh');
      });


    }

    function resetFields (){
      $('#every-day').attr('checked', false);
    }
    //function to replicate checks
    $('#every-day').click(function () {
      if ($(this).is(":checked")) {
        replicateFields();
      }
    });
    $('input:checkbox').click(function () {
      var inputId = $(this).attr('id');
      if (inputId != 'every-day') {
        resetFields();
      }
    });

    //function validator
    nhPersonalizeEventForm.validator({
      disable: false,
      custom: {
        'open-collapses' : $('#sendRequestPersonalize').click(function(){
          //wait until validate to open panels if error
          setTimeout(function(){
            $('.has-error').closest('.js-collapse-panel').find('.collapsed').click();
          }, 300);
        })
      }
    }).on('submit', function (e) {
      var $form = $(this);
      toggleLoadingButton($form, true);
      if (e.isDefaultPrevented()) {
        // Invalid Form
        toggleLoadingButton($form, false);
      } else {
        toggleLoadingButton($form, false);
      }
    });


    //handle click event over the gdpt checks inputs
    $gdprChecks.on("change", _onClickGDPRchecbox);
  }

  /*******************/
  /* PRIVATE METHODS */
  /*******************/

  // Public API
  return {
    init: init
  };
})();

$(function () {
  if($("#nhPersonalizeEventForm").length) {
    nhPersonalizeEvent.init();
  }
});


var pResultsPageCity = (function() {

  // Creación e inicialización del filtro de la página asociada
  const filterPage = 'p-results-page-city';
  //EY Conditional to see if you are in ME
  const $pageMe = $('main.me');
  const Filter = $pageMe.length ?
    new MeFilterHotels(filterPage) :  new FilterHotels(filterPage);
  //
  let $pResultsPageCityView = null;
  let $title;
  let $searchBar= null;
  let $searchBarForm = null;
  let occupancy = null;
  let $occupancies = null;
  let location = {
    $field: null,
    selected: null
  };
  let modals = null;
  let hiddenInputs;

  function init(view) {
    $pResultsPageCityView = view;
    $title = $pResultsPageCityView.find(".m-filter-hotels .js-filter-hotels-number");
    $searchBar = $pResultsPageCityView.find(".m-search-bar");
    $searchBarForm = $searchBar.find("form");
    $occupancies = $searchBarForm.find("#m-occupancy-sb");
    modals = {
      $loading: $pResultsPageCityView.find("#loading-modal-results"),
      $matchError: $pResultsPageCityView.find("#modal-search-no-result"),
      $geolocationError: $pResultsPageCityView.find("#modal-geolocation-error")
    };
    occupancy = reservationOccupancyNew.getOccupancy($occupancies.data("occupancy-index"));
    location.$field = $searchBarForm.find("#location2-sb");
    hiddenInputs = {
      $inputs: $searchBarForm.find('input[type="hidden"]'),
      get locationCode() {
        return this.$inputs.filter("[data-id='locationCode']");
      },
      get locationTCM() {
        return this.$inputs.filter("[data-id='locationTCM']");
      },
      get virtualHotel() {
        return this.$inputs.filter("[data-id='virtualHotel']");
      },
      get urlHotel() {
        return this.$inputs.filter("[data-id='urlHotel']");
      },
      get url() {
        return $("#url");
      },
    };
    
    $pResultsPageCityView.on("setHotelsDone", function(ev, type, hotelsData) {
      $title.html(hotelsData.$hotels.length);
      Filter.toggleCurrency(!lastSearch.groupon);
    });

    // Pasamos por parámetro -> contenedor filtro móvil, contenedor filtro desktop y contenedor de resultados
    Filter.init(
      document.querySelector(`.${filterPage} .m-filter-hotels.is-mobile`),
      document.querySelector(`.${filterPage} .m-filter-hotels.is-desktop`),
      document.querySelector(`.${filterPage} .m-hotel-search`)
    );

    //Filter.toggleCurrency(!lastSearch.groupon);

    mResultsHotelCards.init($pResultsPageCityView, Filter);

    // Rellenar modal tripadvisor
    $('[data-url-tripadvisor]').click(function () {
      let urlTripadvisor = $(this).attr('data-url-tripadvisor');
      $('.js-tripavisor-modal').find('iframe').attr('src', urlTripadvisor);
    });

    // EY, no lo validamos si es Meetings
    if($pageMe.length == 0){
      $searchBarForm.validator({
        disable: false,
      }).on('submit', function(e) {
        let validForm = true;
        let rangeInvalid = true;
        let locationInvalid = true;
        const $form = $(this);
  
        toggleLoadingButton($form, true);
  
        if (e.isDefaultPrevented()) {
          // Invalid Form
          validateBookingRange($form);
          //commonBookingHotel.isValidRange();
          toggleLoadingButton($form, false);
          } else {
            rangeInvalid = validateBookingRange($form);
            locationInvalid = validateLocation(location.$field);
            validForm = (!rangeInvalid && !locationInvalid);
            if(!$form.data("validate")) {
              e.preventDefault();
              if(validForm) {
                _handleSubmitForm(e);
              }
            }
            toggleLoadingButton($form, false);
          }
      });
    }

  }

  function _handleSubmitForm(ev) {
    let occupancyInfo = occupancy.generateOccupancyInfo();
    location.selected = location.$field.data("selected") || JSON.parse(sessionStorage.getItem("listSearch"));
    modals.$loading.modal({
      show: true,
      backdrop: "static",
      keyboard: false
    });

    if (hiddenInputs.locationCode.val() === "") {
      hiddenInputs.locationCode.attr("name", "");
    }
    if (location.$field.attr("name") === "searchStringID") {
      hiddenInputs.locationTCM.attr("name", "locationTCM");
    } else {
      hiddenInputs.locationTCM.attr("name", "searchStringID");
    }

    hiddenInputs.locationTCM.val(location.$field.val());

    //callSeguimientoForms("success", "resultPageForm", "success");

    if ( hiddenInputs.virtualHotel.val() !== "" && hiddenInputs.url.val() !== "" && $searchBarForm.find("input[name*='hotelId']").length > 0) {
      hiddenInputs.urlHotel.val(hiddenInputs.url.val());
    }
    _onFormSubmit(ev);
  }


  function _onFormSubmit(ev) {
    let occupancyInfo = occupancy.generateOccupancyInfo();
    let formData = {};
    let dataUrl = null;
    let checkin;
    let checkout;

    $searchBarForm.append(occupancyInfo.inputs);

    if(location.selected) {
      $.each($searchBarForm.serializeArray(), function (index, obj) {
        formData[obj.name] = obj.value;
      });

      formData.fini = (formData.fini) ? formData.fini : moment().format("DD/MM/YYYY");
      formData.fout = (formData.fout) ? formData.fout : moment().add(1, 'day').format("DD/MM/YYYY");
    
      checkin = moment(formData.fini, location.selected.df);
      checkout = moment(formData.fout, location.selected.df);
  
      if (location.selected.ebp && location.selected.url) {
        ev.preventDefault();
        dataUrl = {
          hotelID: formData.hotelId,
          checkinDate: checkin.format(location.selected.df),
          checkoutDate: checkout.format(location.selected.df),
          get nights() {
            return checkout.diff(checkin, 'days');
          },
          adults: occupancyInfo.pax.adults,
          children: occupancyInfo.pax.children + occupancyInfo.pax.babies,
          roomsNumber: occupancyInfo.rooms,
          childages: (occupancyInfo.ages.length > 1) ? occupancyInfo.ages : ""
        };

        window.location.href = _getRedirectUrl(location.selected.url, dataUrl);
        return;
      } else {
        $searchBarForm.data("validate", true).trigger("submit");
      }
    }
    $searchBarForm.data("validate", true).trigger("submit");
  }

  // parsed url
  function _getRedirectUrl(tpl, data) {
    return tpl.replace(/\[(.*?)\]/gmi, function (match, p1) {
      var prop = p1.trim();
      return data.hasOwnProperty(prop) ? data[prop] : '';
    });
  }
  


  return {
    init: init
  };
})();


$(function () {
  if( $(".p-results-page-city").length ) {
    pResultsPageCity.init($('.p-results-page-city'));
  }
});

var pRewardsMovements = (function() {
  var $pRewardsMovementsView;
  var $movementsFormData;
  var messageModals = null;
  var $claimMovementsModal = null;
  var $paginateElements = null;
  var paginationOptions = {
    itemsPerPage: 10,
    prevLinkText: Labels && Labels.paginatePrevText ? Labels.paginatePrevText : null,
    nextLinkText: Labels && Labels.paginateNextText ? Labels.paginateNextText : null
  };

  function init(view) {
    $pRewardsMovementsView = view;
    $($pRewardsMovementsView).find('.mDestinations').selectDestinations();

    $movementsFormData = {
      $form: $pRewardsMovementsView.find("#form-modal-claim-points"),
      get fields() {
        return this.$form.find("select, input, textarea");
      },
      messages: {
        get errorClaimFields() {
          return $movementsFormData.$form.data("error-claim-fields");
        },
        get errorClaimException() {
          return $movementsFormData.$form.data("error-claim-exception");
        },
        get success() {
          return $movementsFormData.$form.data("success-claim");
        }
      },
      range: {
        get $rangeSelector() {
          return $movementsFormData.$form.find(".range-calendar");
        }, 
        get $initRangeWrapper() {
          return this.$rangeSelector.find(".init-range-calendar .js-input-wrapper");
        },
        get $endRangeWrapper() {
          return this.$rangeSelector.find(".end-range-calendar .js-input-wrapper");
        },
        get $initRangeInput() {
          return this.$initRangeWrapper.find("input.date-select");
        },
        get $endRangeInput() {
          return this.$endRangeWrapper.find("input.date-select");
        },
        get $initRangeErrorBlock() {
          return this.$initRangeWrapper.find(".help-block");
        },
        get $endRangeErrorBlock() {
          return this.$endRangeWrapper.find(".help-block");
        }
      }
    };

    messageModals = {
      error: $pRewardsMovementsView.find("#modal-error"),
      success: $pRewardsMovementsView.find("#modal-success"),
    };

    $claimMovementsModal = $pRewardsMovementsView.find("#modal-movements");
    // EY CAMBIO, NO FUNCIONA ESTO
    //$movementsFormData.$form.validator({
    $("#form-modal-claim-points").validator({    
      disable: false,
    }).on('submit', function(e) {
      var validForm = true;
      var $form = $(this);
      toggleLoadingButton($form, true);
      if (e.isDefaultPrevented()) {
        // Invalid Form
        _isValidRange();
        toggleLoadingButton($form, false);
      } else {
        e.preventDefault();
        validForm = _isValidRange();
        if(validForm) {
          _submitForm();
        }
      }
    });

    if($movementsFormData.range.$rangeSelector.data("range-required")) {
      _initValidateRange();
    }
   
    messageModals.success.on("hidden.bs.modal", function() {
      $claimMovementsModal.modal("hide");
    });

    /*messageModals.error.on("hidden.bs.modal", function() {
      $claimMovementsModal.modal("hide");
    });*/

    $paginateElements = $pRewardsMovementsView.find(".paginateMe");

    if($paginateElements.length) {
      paginationOptions = {
        itemsPerPage: 10,
        prevLinkText: Labels && Labels.paginatePrevText ? Labels.paginatePrevText : null,
        nextLinkText: Labels && Labels.paginateNextText ? Labels.paginateNextText : null
      };

      for (const prop in paginationOptions) {
        if(!paginationOptions[prop]) {
          delete paginationOptions[prop];
        }
      }
    }
    $paginateElements.paginateMe(paginationOptions);
   // $paginateElements.paginateMe({itemsPerPage: 10});
  }

  /**
   * @description - show the success or error message of the from
   * @param {string} - the code of the form message
   */
  function _showFormMessage(errorCode) {
    var errorCodes = {
      "99999": {
        message: "errorClaimFields",
        modal: "error"
      },
      "00010": {
        message: "errorClaimException",
        modal: "error"
      },
      "00000": {
        message: "success",
        modal: "success"
      }
    };
    var message = $movementsFormData.messages[errorCodes[errorCode].message];
    var $modal = messageModals[errorCodes[errorCode].modal];

    $modal.find(".symbol-text p").text(message);
    $modal.modal("show");
  }

    /**
   * @description actions to send the form
   */
  function _submitForm() {
    var data = {};
    var promise;
    $.each($movementsFormData.fields, function(index, element) {
      var $element = $(element);
      if(element.id.indexOf("GDPR_flag") >= 0) {
        data[element.id] = ($element.prop("checked")) ? 'S' : 'N';
      } else {
        data[element.id] = element.value;
      }
    });

    promise = $.ajax({ 
      url : '/rewards/claim',
      type : 'POST',
      data: JSON.stringify(data),
      contentType: 'application/json'
    });

    promise.then(function(response) {
      _showFormMessage("99999");
      if(response.errorCode === "00000") {
        _resetClaimPointsForm();
      }
    }, function() {
      _showFormMessage("99999");
    }).always(function() {
      toggleLoadingButton($movementsFormData.$form, false);
    });
  }

  /**
   * @description reset the fields of the form
   */
  function _resetClaimPointsForm() {
    var selects  = $movementsFormData.fields.filter("select");
    $movementsFormData.$form[0].reset();
    $movementsFormData.range.$initRangeWrapper.removeClass("has-success-datepicker has-invalid-datepicker-error");
    $movementsFormData.range.$endRangeWrapper.removeClass("has-success-datepicker has-invalid-datepicker-error");
    $.each(selects, function(index, select) {
      var $this = $(select);
      if(select.id !== "country") {
        $this.empty();
      }
    });
    selects.selectpicker('refresh');
  }

  /**
   * @description initialize the validation of range fields
   */
  function _initValidateRange() {
    $movementsFormData.range.$initRangeErrorBlock.append(`<ul role="alert"><li>${$movementsFormData.range.$initRangeInput.data("error")}</li></ul>`);
    $movementsFormData.range.$endRangeErrorBlock.append(`<ul role="alert"><li>${$movementsFormData.range.$endRangeInput.data("error")}</li></ul>`);

    $movementsFormData.range.$initRangeInput.add($movementsFormData.range.$endRangeInput).on("focusout", function(ev) {
      var $this = $(this);
      var $wrapper = (this.id === "end-date") ? $movementsFormData.range.$endRangeWrapper : $movementsFormData.range.$initRangeWrapper;
      _validateRangeDate($this, $wrapper);
    });

    $movementsFormData.range.$initRangeInput.on("change", function() {
      $movementsFormData.range.$initRangeInput.trigger("focusout");
      $movementsFormData.range.$endRangeInput.trigger("focusout");
    });

    $movementsFormData.range.$endRangeInput.on("change", function() {
      $movementsFormData.range.$endRangeInput.trigger("focusout");
    });
  }

   /**
   * @description - Validate a range date
   * @param {*} $input -jquery object with the range date iniput
   * @param {object} $wrapper - jquery object with the wrapper of the range date input
   */
  function _validateRangeDate($input, $wrapper) {
    var isError = validateDate($input);
    _toggleInvalidRangeError($wrapper, isError);

    return isError;
  }

  /**
   * @description - validate a date of range input
   * @param {object} $input - jquery object of a range date input
   */
  function _isValidDate($input) {
    var date = $input.val();
    var isValid = true;
    if(!date) {
      isValid = false;
    } else {
      isValid =  moment(date,'DD/MM/YYYY').isValid();
    }
    return isValid;
  }

  /**
   * @description - validate a range dates
   */
  function _isValidRange() {
    var isValidInitialDate = _isValidDate($movementsFormData.range.$initRangeInput);
    var isValidFinalDate = _isValidDate($movementsFormData.range.$endRangeInput);

    _toggleInvalidRangeError($movementsFormData.range.$initRangeWrapper, !isValidInitialDate);
    _toggleInvalidRangeError($movementsFormData.range.$endRangeWrapper, !isValidFinalDate);

    return (isValidInitialDate && isValidFinalDate);
  }

  /**
   * @description show/hide the range dates errors
   * @param {object} $wrapper - jquery object with the wrapper of the range date input
   * @param {boolean} isError - if the date is valid or not
   */
  function _toggleInvalidRangeError($wrapper, isError) {
    var $helpBlock = $wrapper.find(".help-block");
    if (isError) {
      $helpBlock.show();
      $wrapper.addClass('has-invalid-datepicker-error has-error').removeClass("has-success-datepicker");
    } else {
      $helpBlock.hide();
      $wrapper.removeClass('has-invalid-datepicker-error has-error').addClass("has-success-datepicker");
    }
  }

  // Public API
  return {
    init: init,
  };
})();

$(function () {  
  if($(".p-rewards-movements").length) {
    pRewardsMovements.init($(".p-rewards-movements"));
  }
});



var nhReWardsProfile = (function () {

  var nhRewardsProfileForm = $('#personal-information');
  var nhPasswordForm = $('#change-password');
  var nationality = null;
  var datepickerSelector


  function init() {
    nationality = {
      $field: nhRewardsProfileForm.find("#nationality"),
      $label: nhRewardsProfileForm.find("label[for='national-id']"),
      $idField: nhRewardsProfileForm.find('#national-id')
    };
    datepickerSelector = nhRewardsProfileForm.find('#birth-date-selector');    

    /**
     * Validador de la parte de la información personal
     */
    nhRewardsProfileForm.validator({
      //el html de pro incluye un action del post a /rewards/updateprofile en el boton
      disable: false,
      custom: {
        //'email-validator': customEmailValidator.bind(this),
        'birth-date': customBirthDateValidator.bind(this)
      }
    }).on('submit', function (e) {
      var $form = $(this);
      var validForm = true;
      toggleLoadingButton($form, true);
      if (e.isDefaultPrevented()) {
        // Invalid Form
        validForm = false;
        datepickerSelector.selectorDatepicker('validateOnSubmit');
        toggleLoadingButton($form, false);
      } else {
        validForm = datepickerSelector.selectorDatepicker('validateOnSubmit');
        if (!validForm) {
          e.preventDefault();
        }
        toggleLoadingButton($form, false);
      }
    });


    /**
     * Validador de la parte de reset de contraseñA
     */
    nhPasswordForm.validator({
      disable: false
    }).on('submit', function (e) {
      var $form = $(this);
      toggleLoadingButton($form, true);
      if (e.isDefaultPrevented()) {
        // Invalid Form
        toggleLoadingButton($form, false);
      } else {
        e.preventDefault();
        _onSubmitPassForm();
        //EY Quitar los 3 puntos de cargando del botón de submit cuando se ha mostrado el modal de exito o error
        toggleLoadingButton($form, false);
      }
    });

    _checkNationality();


    nationality.$field.on('change', function () {
      _checkNationality();
    });

  }

  /*******************/
  /* PRIVATE METHODS */
  /*******************/


  function _checkNationality() {
    var label = $.trim(nationality.$label.html());
    if (nationality.$field.val() === "ES") {
      label = label + " *";
      nationality.$idField.prop('required', true);
      nationality.$label.html(label);
    } else {
      label = label.replace(/\*/g, '');
      nationality.$idField.prop('required', false);
      nationality.$label.html(label);
    }

    nhRewardsProfileForm.validator('update');
    nationality.$idField.trigger("blur");
  }

  /**
   * @description behaviour when the form is submitted
   */

  /**
   * Llamada Ajax que si todo funciona bien abre una modal
   */
  function _onSubmitPassForm() {
    $.post("/rewards/updatepass",
      {
        currentPass: $('#current-pass').val(),
        newPass: $('#new-pass').val()
      },
      function (data, status) {
        if (data) {
          $('#modal-success').modal('show');
        } else {
          $('#modal-error').modal('show');
        }
      });
  }





  /**
   * Custom validator to check if the birth date is a past date
   * @return {[type]} [description]
   */
  function customBirthDateValidator() {
    if (this.datepickerSelector.selectorDatepicker('checkIsValidDate', true) === true) {
      if (this.datepickerSelector.selectorDatepicker('checkTimelineDate') === 1) {
        return 'error';
      }
    }
  }

  // Public API
  return {
    init: init
  };
})();

$(function () {
  if ($('.p-reward-my-profile').length) {
    nhReWardsProfile.init();
   
    //EY, compruebo errores y muestro el modal
    $( window ).on( "load", function() {     
      let codeError = decodeURIComponent(utils.getUrlParameters().codeError)
      if (codeError != "undefined") {
        (codeError == 0) ? $('#modal-success').modal('show') : $('#modal-error').modal('show')
      }
    });
    
  }
});
let rewardsSignupForm = (() => {

  function init () {

    // Rellenar el input de email si nos lo pasan por parámetro en la url
    let urlEmail = decodeURIComponent(utils.getUrlParameters().e);
    if ( urlEmail !== 'undefined' ) $('#signup-corporate #email').val(urlEmail).focus();
  }

  return {
    init: init
  }
})();


$(function () {
  if ( $('.p-rewards-signup.rewards-signup-form').length ) {
    rewardsSignupForm.init();
  }
});

var nhSignUpBusinessTravel = (function () {

    var nhSignupBusinessTravelForm = $('#form-signup-business-travel');


    var jsonData = JSON.parse('{"emails":[{"email":"bpc@nh-hotels.com","country":"tcm:41-683-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-699-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-654-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-682-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-686-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-696-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-704-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-693-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-695-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-698-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-700-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-701-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-690-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-685-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-703-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-684-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-687-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-707-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-709-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-101425-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-102565-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-102479-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-72875-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-697-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-688-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-688-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-708-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-706-1024"},{"email":"bpc@nh-hotels.com","country":"tcm:41-692-1024"}],"emailDefault":"bpc@nh-hotels.com","subject":"Application for registration in NH Hotel Group Benefit Program for Companies"}');


    function init() {

        nhSignupBusinessTravelForm.validator({
            disable: false,
            custom: {
                //'email-validator': customEmailValidator.bind(this),
            }
        }).on('submit', function (e) {
            var $form = $(this);
            toggleLoadingButton($form, true);
            if (e.isDefaultPrevented()) {
                // Invalid Form
                toggleLoadingButton($form, false);
            } else {
                e.preventDefault();
                _onSubmitForm();
            }
        });

    }
    /*******************/
    /* PRIVATE METHODS */
    /*******************/
    /**
     * @description behaviour when the form is submitted
     */
    function _onSubmitForm() {
        b2bSubmit();
    }

    function b2bSubmit() {



        var emailTo = "";
        for (var i = 0; i < jsonData.emails.length; i++) {
            if (jsonData.emails[i].country == $('#pais').val()) {
                emailTo = jsonData.emails[i].email;
                break;
            }
        }
        if (!emailTo.length) {
            emailTo = jsonData.emailDefault;
        }
        $("#emailTo").val(emailTo);
        $("#subject").val(jsonData.subject);

        $('.m-gdpr-optional').find('.js-gdpr-check').each(function () {
            if ($(this).find('input').is(':checked') == false) {
                $(this).append('<input type="hidden" value="N" name="' + $(this).find('input').attr('name') + '" />')
            };
        });

        //nhSignupBusinessTravelForm.submit();

    }
    // Public API
    return {
        init: init
    };
})();



$(function () {
    nhSignUpBusinessTravel.init();
});

var pCancelReservation = (() => {
  var cancelReservationView = $('.p-eservicing-cancel');
  var additionalComments = cancelReservationView.find('form #additional-comments');
  var reasonSelector = cancelReservationView.find('form #reason');
  var cancelRoomsSet = cancelReservationView.find('fieldset[name="cancel-rooms"]');
  var totalCostWell = cancelReservationView.find('.js-total-cancel-price');

  // Constants
  var CURRENCY = cancelRoomsSet.data('currency');
  const CANCELATION_DECIMALS = 2;

  /**
   * Init Fn
   */
  function init() {
    cancelReservationView.find('form').validator({
      disable: false,
      custom: {
        'mincheckbox': validateMinCheckbox
      }
    }).on('submit', function(e) {
        var $form = $(this);
        toggleLoadingButton($form, true);
      if (e.isDefaultPrevented()) {
        toggleLoadingButton($form, false);
      } else {
        // Invalid Form
      }
    });
    // Listeners
    reasonSelector.on('change', _onReasonChange);
    cancelRoomsSet.find('input[type="checkbox"]').on('change', _handlerCancelRoomChange);
    _checkSelectedReason(reasonSelector);
    _renderRoomCancelPrices();
    _handlerCancelRoomChange();
  }

  /**
   * Handler when the reason selector changes.
   * @param       {[type]} e [description]
   */
  function _onReasonChange(e) {
    var $this = $(this);
    _checkSelectedReason($this);
  }

  /**
   * if the selected reason has the flag data-reason-comment-required, the
   * additional comments must be required
   * @param       {[type]} $selector [description]
   */
  function _checkSelectedReason($selector) {
    var selectedOption = $selector.find(':selected');
    if(selectedOption.data('reason-comment-required')) {
      _toggleRequireAdditionalComment(true);
    } else {
      _toggleRequireAdditionalComment(false);
    }
  }

  /**
   * Set if the additional comment is required for the validation or not
   * @param       {[boolean]} toggle [Required or not flag]
   */
  function _toggleRequireAdditionalComment(toggle) {
    additionalComments.attr('required', toggle);
    // Update the form validation
    cancelReservationView.find('form').validator('update');
    if(!toggle) {
      additionalComments.closest('.form-group').removeClass('has-error', 'has-danger');
    }
  }

  /**
   * Handler when a room checkbox change
   * @param       {[type]} e [description]
   */
  function _handlerCancelRoomChange() {
    let roomPrices = _getRoomCancelPrices();
    let totalPrice = _calcCancellationCost(roomPrices);
    let errorMessage = cancelRoomsSet.find('.room-cancel-alert');

    // Visualizar/ocultar mensaje de error
    if ( cancelRoomsSet.find('input[type="checkbox"]:checked').length > 0 ) errorMessage.hide();
    else errorMessage.show();

    _renderCancellationTotalCost(totalPrice);
  }

  /**
   * Render the prices for the room cancellation
   */
  function _renderRoomCancelPrices() {
    var checkboxes = cancelRoomsSet.find('input[type="checkbox"]');
    checkboxes.each((index, checkbox) => {
      let $checkbox = $(checkbox);
      let associatedPrice = $checkbox.data('associated-price');
      if(!isNaN(associatedPrice)) {
		// EY: Cambiamos el atributo que era incorrecto en maqueta
        let name = $checkbox.attr('id');
        let priceNode = cancelRoomsSet.find(`.price[name="${name}"]`);
		// EY: A�adimso tofixed que nos daba errores       
		let aPrice=parseFloat(associatedPrice).toFixed(CANCELATION_DECIMALS);
        let formattedPrice = `${aPrice} ${CURRENCY}`;
        priceNode.html(formattedPrice);
      }
    });
  }

  /**
   * Get the associated prices from the room checkboxes
   * @return  {[number]} Cancellation prices for the rooms
   */
  function _getRoomCancelPrices() {
    var prices = [];
    var checkedRooms = cancelRoomsSet.find('input[type="checkbox"]:checked');
    checkedRooms.each((index, roomCheckbox) => {
      let $roomCheckbox = $(roomCheckbox);
      var associatedPrice = $roomCheckbox.data('associated-price');
      if(!isNaN(associatedPrice)) {
        prices.push(associatedPrice);
      }
    });
    return prices;
  }

  /**
   * Calculate the cancellation cost
   * @param       {[number]} costArray [Array of selected room prices to cancel]
   */
  function _calcCancellationCost(costArray) {
    var totalPrice = 0;
    costArray.forEach((price) => {
      totalPrice += price;
    });
    return totalPrice;
  }

  /**
   * Set the cancellation total cost on the html
   * @param       {[number]} totalCost [Total cost to render]
   */
  function _renderCancellationTotalCost(totalCost) {
    if (isNaN(totalCost)) {
      return;
    }
    let formattedTotalCost = `${parseFloat(totalCost).toFixed(CANCELATION_DECIMALS)} ${CURRENCY}`;
    totalCostWell.find('.price').html(formattedTotalCost);
    //EY: Añadido para recuperar el coste total de la cancelación para la analítica
    if(typeof searchData !== 'undefined'){searchData.bookingTotalValue = parseFloat(totalCost).toFixed(CANCELATION_DECIMALS);}
  }

  // Public API
  return {
    init: init
  };

})();

$(() => {
  pCancelReservation.init();
});

/**
 * EServicing Access Page
 * @return {[type]} [description]
 */
var eServicing = (function () {
  var eServicingPage = $('.p-eservicing-access');
  var $hotelSelector = $("#hotel-selector");

  /**
    * @description initialize the module. First get the hotel list to fill the select of hotels, when the ajaxCall ends initialize the form validation
   */
  function init() { 
    setMinArrivalDate();
     _getHotels().then(function(response) {
      var options = `<option role="option" value=""></option>`;
      $.each(response, function(index, hotelData) {
        options += `<option role="option" value="${hotelData.code}">${hotelData.name}</option>`;
      });

      $hotelSelector.append(options).selectToAutocomplete();
      _setupForm();
    });

  }  

  /**
   * Sets the arrival min date to today
   * @return {[type]} [description]
   */
  function setMinArrivalDate() {
    var inputDate = eServicingPage.find('#arrival-date');
    var today = moment().format('YYYY-MM-DD');
    inputDate.attr('min', today);
  }

  /**
   * @description - get the hotel lists
   * @returns returns an array with the hotel lists
   */
  function _getHotels() {
    var promise = $.ajax({
      type: "GET",
      dataType: "json",
      url: "/rest/auto/autocompleteEservicing",
      cache: false
    });

    return promise.then(function(response) {
      return response[0];
    }, function(error) {
      return error;
    });
  }

  /**
   * @description - initialize the behaviour of form validation (correct form and incorrect form)
   */
  function _setupForm() {

    eServicingPage.find('form').validator({
      disable: false,
      custom: {
        'entrydate': validateDate
      }
    }).on('submit', function(e) {
        var $form = $(this);
        toggleLoadingButton($form, true);

        //EY: Formateamos la fecha para que tenga la necesaria al enviarse el formulario cuando es mobile
        if(isMobile.any()){
          $dateInput = $('#arrival-date');
          $dateInput.attr('name','');
          var selectedDate = $dateInput.val();
          var selectedYear = selectedDate.split('-')[0];
          var selectedMonth = selectedDate.split('-')[1];
          var selectedDay = selectedDate.split('-')[2];
          var selectedDateFormatted = selectedDay + "/" + selectedMonth + "/" + selectedYear; 

          $dateInput.parent().append('<input type="hidden" name="fecha" value="'+ selectedDateFormatted +'"/>');
        }

      if (e.isDefaultPrevented()) {
        toggleLoadingButton($form, false);       
      } else {
        // Invalid Form
      }
    });
   
  }

  // Public API
  return {
    init: init
  };

})();

$(function() {
  if ($('.p-eservicing-access').length) {
    eServicing.init();
  }
});

/**
 * EY: EServicing Management Page
 * @return {[type]} [description]
 */
var eServicingManagement = (function () {

  function init() {

    //EY: Call function for Download Passbook
    urlPassbook();

    //EY: Envío formularios para acceder al OCI o a cancelación de reserva    
    $(document).on('click', '.js-form-button', function (e) {
      e.preventDefault();
      $(".js-form-button").attr("disabled", true);
      var formId = '#' + $(this).data('form');
      $(formId).submit();
    });
  }

  /**
   * EY: Submit of the given form
   */
  function submitForm(formId) {
    $(formId).submit();
  }

  //EY: Download Passbook
  var urlPassbook = function () {

    //pageData nedded to set in the template (urlPassbook, idReservation, emailTitular)
    if(typeof pageData !== "undefined"){
      if(typeof pageData.urlPassbook != "undefined"){
        var fecha = pageData.urlPassbook.split('/');
        var fullPassbook = pageData.fullDomain+"/getPassBook/"+pageData.idReservation+"/"+pageData.emailTitular+"/" + fecha[2] + "-" + fecha[1] + "-" + fecha[0] +"/index3.html";     
        
        $('.js-passbook').on('click', function(e){
          e.preventDefault();

          location.href = fullPassbook;
        });
      }
    }

  };


  // Public API
  return {
    init: init
  };

})();

$(function () {
  eServicingManagement.init();
});
/**
 * EServicing Access Page
 * @return {[type]} [description]
 */
var eServicingModify = (function () {
  var eServicingPage = $('.p-eservicing-modify');
// EY: Cambiamos el nombre del form que era incorrecto en maqueta
  var $saveBookingForm = eServicingPage.find("#form_modify");
  var $backToBookingForm = eServicingPage.find("#form_back_to_booking");
  var $backToBookingButton = $saveBookingForm.find("#backToBooking");

  /**
   * Init Fn 
   */
  function init() {   
    $saveBookingForm.validator({
      disable: false
    }).on('submit', function (e) {
      var $form = $(this);
      toggleLoadingButton($form, true);
      if (e.isDefaultPrevented()) {
        toggleLoadingButton($form, false);
      } else {
        // Invalid Form
      }
    });
    $backToBookingButton.on("click", _sendBackToBookingForm);
  }

  /**
   *@descrition - Send the form to back to booking page
   *
   */
  function _sendBackToBookingForm() {
    $backToBookingButton.prop("disabled", true);
    $backToBookingForm.submit();
  }

  // Public API
  return {
    init: init
  };

})();

$(function () {
  if ($('.p-eservicing-modify').length) eServicingModify.init();
});
var landings = (() => {
  var $landingCountdowns;

  function init() {
    // Inicializamos contador regresivo de haberlo
    _initCountdowns();
  }

  function _initCountdowns() {
    $landingCountdowns = $('.js-time-counter');
    // Inicializamos contador regresivo de haberlo
    if($landingCountdowns.length) {
      $landingCountdowns.each(function(){
        utils.initializeClock($(this));
      });
    }
  }

  return {
    init: init
  };
})();


$(() => {
  if ( $("body").hasClass("page-landings") || $("body").data("page") === "LandingsPage" || $(".p-landings").length) {
    //page-checkout .logged
    landings.init();
  }
});



var mGallery = (() => {
  var isMobileDevice = isMobile.any(); //si estamos en un movil
  var slidersConfig = {
    dots: false,
    infinite: true,
    fade: true,
    prevArrow: '<span class="slick-arrow slick-prev nh-ic-chevron"></span>',
    nextArrow: '<span class="slick-arrow slick-next nh-ic-chevron"></span>',
    lazyLoad: "ondemand"
  };

  var galleryConfig = {
    loop: true,
    touch: true,
    backFocus: false,
    buttons: [
      "zoom",
      //"share",
      //"slideShow",
      "fullScreen",
      //"download",
      "thumbs",
      "close"
    ],
    thumbs: {
      autoStart: !isMobileDevice, // Display thumbnails on opening
      hideOnClose: true, // Hide thumbnail grid when closing animation starts
      parentEl: ".fancybox-container", // Container is injected into this element
      axis: "x" // Vertical (y) or horizontal (x) scrolling
    },
    btnTpl: {
      arrowLeft:
        '<button data-fancybox-prev class="fancybox-button fancybox-button--arrow_left" title="{{PREV}}">' +
        '<div><span data-fancybox-prev class="fancybox-btn-prev nh-ic-chevron"></span></div>' +
        "</button>",
      arrowRight:
        '<button data-fancybox-next class="fancybox-button fancybox-button--arrow_right" title="{{NEXT}}">' +
        '<div><span data-fancybox-nex class="fancybox-btn-next nh-ic-chevron"></span></div>' +
        "</button>",
    }
  };
  var galleriesData = {
    $galleries: $('.m-gallery'),
    galleriesObj: {},
    get $slidersContent() {
      return this.$galleries.find(".gallery-content");
    },
    get $thumbsContainer() {
      return this.$galleries.find(".gallery-thumbs-container");
    },
    get $thumbsGalleries() {
      return this.$thumbsContainer.find(".gallery-thumbs");
    },
    thumbsVisibles: 8,
    responsive: [
      {
        breakpoint: 468,
        settings: {
          thumbsVisibles: 3
        }
      },
      {
        breakpoint: 768,
        settings: {
          thumbsVisibles: 4
        }
      },
      {
        breakpoint: 813,
        settings: {
          thumbsVisibles: 6
        }
      }
    ]
  };

  function init() {
    //console.log("tamaño ventana", globalConfig.windowWidth)
    /* Por cada galería vamos a guardar una configuración para saber siempre su estado*/
    $.each(galleriesData.$galleries, _setupGalleries);

    $(window).on("resize", _onWindowResize);

  }

  /***********************/
  /*** PRIVATE METHODS ***/
  /***********************/

  /**
   * @description - Behaviour of the gallery when the zoom gallery is closed
   * @param {object} instance - the current instance of the zoom gallery
   * @param {number} current - the current photo index showed in the gallery
   */
  function _beforeCloseZoomGallery(instance, current) {
    var $link = this.$thumbsLinks.eq(current.index);
    this.currentImg = current.index;
    $link.trigger("click");
  }

  /**
   * @description - Behaviour of the gallery when a slider photo has changed
   * @param {object} event - object with the event data
   * @param {object} slick - object with the current slide instance data
   * @param {number} currentSlide - the previous slider image index
   * @param {number} nextSlide - the current slider image index
   */
  function _onBeforeSlideChange(event, slick, currentSlide, nextSlide) {
    var $nextImg = this.$thumbsImg.eq(nextSlide);
    var $nextThumb = this.$thumbsLinks.eq(nextSlide);
    this.$thumbsLinks.eq(currentSlide).removeClass("selected");
    //$nextImg.addClass("selected");
    $nextThumb.addClass("selected");
    this.currentImg = nextSlide;
    //this.$photoLabel.html($nextImg.data("photo-title") + " " + $nextImg.data("photo-description"));
    this.$photoLabel.find(".photo-title").html($nextImg.data("photo-title"));
    this.$photoLabel.find(".photo-description").html($nextImg.data("photo-description"));
  }

  /**
   * @description Get the data of the current gallery
   * @param {number} index - the index of the gallery in the galleries collection existing
   * @param {object} gallery - the gallery jquery object
   * @returns {object} returns a object with the current gallery data
   */
  function _getGalleryData(index, $gallery) {
    var galleryData = {
      $gallery: $gallery,
      $slider: galleriesData.$slidersContent.eq(index),
      $thumbsContainer: galleriesData.$thumbsContainer.eq(index),
      $thumbsContent: galleriesData.$thumbsGalleries.eq(index),
      get $loading() {
        return this.$gallery.find(".spinner");
      },
      get $sliderImg() {
        return this.$slider.find(".gallery-image");
      },
      get $sliderVideos() {
        return this.$slider.find(".video-content");
      },
      get $thumbsLinks() {
        return this.$thumbsContent.find("a");
      },
      get $thumbsImg() {
        return this.$thumbsContent.find("img");
      },
      get $thumbsTriggers() {
        return this.$thumbsContent.find(".gallery-trigger");
      },
      get $zoomBtn() {
        return this.$gallery.find(".zoom-btn");
      },
      get $showMoreBtn() {
        return this.$thumbsContainer.find(".show-more-btn");
      },
      get $photoLabel() {
        return this.$thumbsContainer.find(".photo-label");
      },
      currentImg: 0,
      get totalThumbs() {
        return this.$thumbsImg.length;
      },
      get visibleThumbs() {
        var visibles = galleriesData.thumbsVisibles;
        galleriesData.responsive.some(function(item) {
          if( globalConfig.windowWidth < item.breakpoint) {
            visibles = item.settings.thumbsVisibles;
            return true;
          }
        });

        return visibles;
      },
      get hiddenThumbs() {
        var hiddenThumbs = (this.$thumbsImg.length - this.visibleThumbs);
        return (hiddenThumbs >= 0) ? hiddenThumbs : 0;
      }
    };
    return galleryData;
  }

  /**
   * @description - behaviour of the gallery when the slider is being initialized
   */
  function _initializeSlider() {
    var $initImage = this.$thumbsImg.eq(0);
    this.$gallery.addClass("loaded");
    //this.$photoLabel.html($initImage.data("photo-title") + " " + $initImage.data("photo-description"));
    this.$showMoreBtn.find("i").html(this.$thumbsImg.length);
    this.$photoLabel.find(".photo-title").html($initImage.data("photo-title"));
    this.$photoLabel.find(".photo-description").html($initImage.data("photo-description"));
    _setVideoAspectRadio(this);
  }

  /**
   * @description - config an initialize the zoom gallery
   * @param {object} ev - object with the event data
   */
  function _initZoomGallery(ev) {
    var galleryData = ev.data.galleryData;
    var config = {
      caption : _setGalleryCaption,
      onInit: _onInitZoomGallery.bind(galleryData),
      beforeClose: _beforeCloseZoomGallery.bind(galleryData)
    };

    $.extend(config, galleryConfig );
    $.fancybox.open(galleryData.$thumbsLinks, config);
  }

  /**
   * @description - Handle click event over the "show more images" button
   * @param {object} ev - object with the event data
   */
  function _onClickshowMoreBtn(ev) {
    var hasHiddenThumbs = ev.data.galleryData.$thumbsLinks.length >= ev.data.galleryData.visibleThumbs;

    if(hasHiddenThumbs && !ev.data.galleryData.$thumbsContainer.hasClass("opened")) {
      ev.data.galleryData.$thumbsContainer.addClass("opened");
    } else if(ev.data.galleryData.$thumbsContainer.hasClass("opened")) {
      ev.data.galleryData.$thumbsContainer.removeClass("opened");
    }
  }

  /**
   * @description - Handle click event over the slider thumbsnails
   * @param {object} ev - object with the event data
   */
  function _onClickthumbsLinks(ev) {
    var $this = $(ev.currentTarget);
    var imgSelected = $this.data("index");
    //setear el index de la imagen actual en el boton zoom
    ev.preventDefault();
    ev.data.galleryData.$slider.slick('slickGoTo', imgSelected);
  }

  /**
   * @description - behaviour of the zoom gallery before init it
   * @param {object} instance - the current instance of the zoom gallery
   */
  function _onInitZoomGallery(instance) {
    instance.jumpTo(this.currentImg);
  }

  /**
   * @description - set the caption of photo in the zoom gallery
   * @returns {string} - return the caption of the photo
   */
  function _setGalleryCaption() {
    var $img = $(this).find("img").eq(0);
    var title = '';
    var desc = '';
    var caption;
    if($img.length) {
      title = $img.data("photo-title") || '';
      desc = $img.data("photo-description") || '';
      caption = title + " " + desc;
    }

    return caption;
  }

  /**
   * @description Config the gallery and its behaviours
   * @param {number} index - the index of the gallery in the galleries collection existing
   * @param {object} gallery - the gallery object
   */
  function _setupGalleries(index, gallery) {
    var $gallery = $(gallery);
    var galleryData = galleriesData.galleriesObj[`g${index}`] = _getGalleryData(index, $gallery);

    //inicializamos los sliders de cada galería existente
    galleryData.$slider.on("init", _initializeSlider.bind(galleryData))
    .slick(slidersConfig).on("beforeChange", _onBeforeSlideChange.bind(galleryData));

    //show or hide the show more button
    _toggleShowMoreButton(galleryData);

    //abrimos y configuramos la galería zoom cuando pulsemos sobre el botón de zoom
    galleryData.$zoomBtn.on("click", {galleryData: galleryData}, _initZoomGallery);

    galleryData.$showMoreBtn.on("click", {galleryData: galleryData}, _onClickshowMoreBtn);

    galleryData.$thumbsLinks.on("click", {galleryData: galleryData}, _onClickthumbsLinks);
  }

  /**
   * @description set the aspect radio of videos in the sliders
   * @param {object} galleryData - the object with the data of the current gallery
   */
  function _setVideoAspectRadio(galleryData) {
    var img;
    var videoData = {
      aspectRadio: null,
      $ele: null,
      height: null,
      width: null
    };
    if(galleryData.$sliderVideos.length) {
      img = galleryData.$sliderImg.eq(0).find("img");
      videoData = {
        height: img.data("height"),
        width: img.data("width"),
        get aspectRadio() {
          return (this.height / this.width) * 100;
        }
      };
      $.each(galleryData.$sliderVideos, function(index, video) {
        var $video = $(video);
        var $embed = $video.find(".embed-container");
        $video.css({
          "max-height": videoData.height,
          "max-width": videoData.width
        });
        $embed.css("padding-bottom", `${videoData.aspectRadio}%`);
      });
    }
  }

  function _onWindowResize() {
    galleryConfig.thumbs.autoStart = !isMobile.any();
    $.each(galleriesData.galleriesObj, function(index, galleryData) {
      _toggleShowMoreButton(galleryData);
    });
  }

  /**
   * @description - show or hide the "show more img" button
   * @param {object} galleryData - the object with the data of the current gallery
   */
  function _toggleShowMoreButton(galleryData) {
    if(galleryData.$thumbsLinks.length >= galleryData.visibleThumbs) {
      galleryData.$thumbsContainer.addClass("hiddenItems");
    } else {
      galleryData.$thumbsContainer.removeClass("hiddenItems");
    }
  }

  return {
    init: init
  };
})();

$(() => {
  if ($(".m-gallery").length) {
    mGallery.init();
  }
});
/**
 * Guest Data Module
 * @return {[type]} [description]
 */
var guestData = (function () {
  var guestDataView = $('.p-cio-guest-data');
  var guestDataForm = guestDataView.find("form#guestDataForm");
  var nationalityInput = guestDataView.find('#country');
  var datepickerSelector = guestDataView.find('#birth-date-selector');
  var boxConfirmDate = guestDataView.find('.box-confirm-age');
  var restOfForm = guestDataView.find('.js-hide-confirm-age');
  var childConfirmModal = guestDataView.find('#modal-child-confirm');
  var documentTypeSelect = guestDataView.find("#documentType");
  // auto complete
  var region = guestDataView.find('#region');
  var regionFields = guestDataView.find('select.region-autocomplete');
  var cityFields = guestDataView.find('select.city-autocomplete');
  var cityselect = guestDataView.find('#cityselect');
  var expedition_place = guestDataView.find('#expedition_place');
  var birthplace = guestDataView.find('#birthplace');
  var region = guestDataView.find('#region');
  var isUnderAgeInput = guestDataForm.find("#isUnderAge");
	var MIN_ADULT_AGE = 18;
	var optionTimeAjax = 800;
	var regionInitActive = false;
	var hotelCountry = null;
  //field that have to be fill if the user log in in the web
  var userLoggedFields = {
    name: {
      class: ".js-logged-name",
      dataKey: "name",
      value: null,
      blocked: true
    },
    surname: {
      class: ".js-logged-surname",
      dataKey: "surname",
      value: null,
      blocked: true
    },
    gender: {
      class: ".js-logged-gender",
      dataKey: "gender",
      value: null
    },
    mail: {
      class: ".js-logged-email",
      dataKey: (typeof pageData !== 'undefined') ? (pageData.isRewards === "true") ? "customerEmail" : "email" : "email",
      value: null,
	  blocked: true
    },
    street: {
      class: ".js-logged-street",
      dataKey: "street",
      value: null
    },
    city: {
      class: ".js-logged-city",
      dataKey: "city",
      value: null
    },
    cityinput: {
      class: ".js-logged-cityinput",
      dataKey: "city",
      value: null
    },
    cityselect: {
      class: ".js-logged-cityselect",
      dataKey: "city",
      value: null
    },
    postalCode: {
      class: ".js-logged-zip-code",
      dataKey: "postalCode",
      value: null
    },
    nationality: {
      class: ".js-logged-nationality",
      dataKey: "nationality",
      value: null
    },
    country: {
      class: ".js-logged-country",
      dataKey: "country",
      value: null
    },
    language: {
      class: ".js-logged-language",
      dataKey: "language",
      value: null
    },
    taxNumber: {
      class: ".js-logged-tax-number",
      dataKey: "documentNumber",
      value: null,
	  blocked: true
    },
    documentType: {
      class: ".js-logged-document-type",
      dataKey: "documentType",
      value: null,
	  blocked: true
    },
    birthDate: {
      class: ".js-logged-birth-date",
      dataKey: "birthDate",
      value: null
    },
    get birthYear() {
      if (this.birthDate.value != null)
        return {
          class: ".js-logged-birth-year",
          dataKey: "birthYear",
          value: (typeof this.birthDate.value != null) ? this.birthDate.value.split("/")[2] : ''
        };
    },
    get birthMonth() {
      if (this.birthDate.value != null)
        return {
          class: ".js-logged-birth-month",
          dataKey: "birthMonth",
          value: (typeof this.birthDate.value != null) ? (parseInt(this.birthDate.value.split("/")[1]) - 1) : ''
        };
    },
    get birthDay() {
      if (this.birthDate.value != null)
        return {
          class: ".js-logged-birth-day",
          dataKey: "birthDay",
          value: (typeof this.birthDate.value != null) ? parseInt(this.birthDate.value.split("/")[0]) : ''
        };
    }
  };
  // CONFIGURACIÓN ADHOC POR PAÍS DE RESIDENCIA DEL USUARIO Y POR LA NACIONALIDAD DEL HOTEL
  var NATIONALITIES = {
    0: { // default
      // HOTEL POR DEFECTO
      // ¡¡¡ MUY IMPORTANTE !!! 
      // SOLO TEST PONER PAIS. EL PAIS VIENE DE UNA VARIABLE DE JAVA, ESTO ES SOLO PARA PODER HACER PRUEBAS DE NACIONALIDAD HOTEL
      "hotelNationality": "",
      "debug": false, // para hacer seguimiento de nacionalidades. Desactivar par producción
      // campos por defecto
      "fields": ["region", "region_expedition_place", "region_birthplace", "cityselect", "nationalIdExpeditionDate", "expedition_place", "birth_province", "birthplace"],
      // Campos por defecto si el hotel es italiano == Extranjero en italia se rige por estos campos
      "othterItaly": ["region", "region_expedition_place", "region_birthplace", "cityselect", "nationalIdExpeditionDate", "birth_province"],
      // Validacines por defecto
      "validations": {
        "acceptsnovat": true
      },
      // Validacines por defecto si el hotel es italiano == Extranjero en italia se rige por estas validaciones
      "validationsItaly": {},
      // Activo la logica  de pais en italia, si esta desactivoda usa los campos por defecto y no los que tendria el pais
      "activeItaly": true,
      // Al cambiar de nacionalidad o al iniciar se resetan estos campos
      "resetValidations": function () {
        // zipcode
        $("#postalCode, #nationalIdNumber").removeAttr("pattern");
        // remove data valitation boostrap
        $("#nationalIdNumber").removeData("docNumber");
        $("#nationalIdExpeditionDate").removeData("validateExpeditionDate");
        // maxlenght
        $("#name, #surname").attr({
          "maxlength": "100"
        });
        $("#street").attr("maxlength", "150");
        $("#cityinput, #email, #city").attr("maxlength", "50");
        $("#nationalIdNumber").attr("maxlength", "25");
        $("#postalCode").attr("maxlength", "15");
        // document type
        $("#documentType option[value=passport]").show();
        $("#documentType option:first").prop('selected', true);
        $('#documentType').selectpicker('refresh');
        $("#documentType").attr('data-validate', false);
        $("#nationalIdNumber").attr('data-validate', false);
        // refresh validator
        guestDataForm.validator({
          disable: false,
          custom: NATIONALITIES[0].boostrapValidators
        }).validator('update');
      },
      // funciones custom que se pueden añadir por el boostrap validator
      "boostrapValidators": {
        //'name': customBirthDateValidator.bind(this),
        'docNumber': customDocumentNumberValidator,
        //'docNumber' : function($el) {},
        'validateExpeditionDate': customValidateExpeditionDate.bind(this)
        //'birth-date': customBirthDateValidator.bind(this)
      },
      // Validaciones custom por nacionalidades 
      "addValidations": function (otherValidations) {
        Object.entries(otherValidations).forEach(([key, value]) => {
          if (key == "postalCode") {
            $("#" + key).attr("pattern", value);
          }
          if (key == "nationalIdNumber") {
            $("#" + key).attr("pattern", value);
          }
          if (key == "data") {
            Object.entries(value).forEach(([k, v]) => {
              $("#" + v.field).attr("data-" + v.rule, 'true');
            });
          }
          if (key == "acceptsnovat") {
            $("#documentType").attr('data-validate', value);
            $("#nationalIdNumber").attr('data-validate', value);
          }
          if (key == "passport") {
            if (value == true) {
              $("#documentType option[value=" + key + "]").show();
            } else {
              $("#documentType option:first").prop('selected', true);
              $("#documentType option[value=" + key + "]").hide();
            }
            $('#documentType').selectpicker('refresh');
          }
        });
        guestDataForm.validator({
          disable: false,
          custom: NATIONALITIES[0].boostrapValidators
        }).validator('update');
      }
    },
    // VALIDACIONES POR NACIONALIDAD
    1: {
      "nationalities": ["AD", "AT", "CO", "CZ", "DO", "FR", "GB", "HT", "HU", "LU", "RO", "SK", "UY"],
      "fields": ["region", "region_expedition_place", "region_birthplace", "cityselect", "nationalIdExpeditionDate", "expedition_place", "birth_province", "birthplace"],
      "validations": {
        "acceptsnovat": true
      }
    },
    2: {
      "nationalities": ["AR", "BE", "CH", "CL", "MX", "PL", "VE"],
      "fields": ["region", "region_expedition_place", "region_birthplace", "cityselect", "nationalIdExpeditionDate", "expedition_place", "birth_province", "birthplace"],
      "validations": {
        "acceptsnovat": true
      }
    },
    3: {
      "nationalities": ["CN"],
      "fields": ["region", "region_expedition_place", "region_birthplace", "cityselect", "nationalIdExpeditionDate", "expedition_place", "birth_province", "birthplace"],
      "validations": {
        "postalCode": `^[0-9]{6,6}$`,
        "acceptsnovat": true
      }
    },
    4: {
      "nationalities": ["DE"],
      "fields": ["region", "region_expedition_place", "region_birthplace", "cityselect", "documentType", "nationalIdNumber", "nationalIdExpeditionDate", "expedition_place", "birth_province", "birthplace"],
      "others": ["region", "region_expedition_place", "region_birthplace", "cityselect", "nationalIdExpeditionDate", "expedition_place", "birth_province", "birthplace"],
      "validations": {
        "acceptsnovat": false
      },
      "validationsOthers": {
        "acceptsnovat": true
      }
    },
    5: {
      "nationalities": ["ES"],
      "fields": ["region", "region_expedition_place", "region_birthplace", "cityselect", "expedition_place", "birth_province", "birthplace"],
      "others": ["region", "region_expedition_place", "region_birthplace", "cityselect", "expedition_place", "birth_province", "birthplace"],
      "validations": {
        "postalCode": '((0[1-9]|5[0-2])|[1-4][0-9])[0-9]{3}',
        //"nationalIdNumber": '^[A-Za-z0-9]{9,9}',
        "data": {
          0: {
            "field": "nationalIdNumber",
            "rule": "docNumber"
          },
          1: {
            "field": "nationalIdExpeditionDate",
            "rule": "validateExpeditionDate"
          }
        },
        "passport": true,
        "acceptsnovat": true
      },
      "validationsOthers": {
        "postalCode": '((0[1-9]|5[0-2])|[1-4][0-9])[0-9]{3}',
        //"nationalIdNumber": '^[A-Za-z0-9]{9,9}',
        "data": {
          0: {
            "field": "nationalIdNumber",
            "rule": "docNumber"
          },
          1: {
            "field": "nationalIdExpeditionDate",
            "rule": "validateExpeditionDate"
          }
        },
        "passport": true,
        "acceptsnovat": true
      }
    },
    6: {
      "nationalities": ["IT"],
      "fields": ["cityinput", "nationalIdExpeditionDate"],
      "others": ["region", "region_expedition_place", "region_birthplace", "cityselect", "nationalIdExpeditionDate", "expedition_place", "birth_province", "birthplace"],
      "validations": {
        "acceptsnovat": true
      },
      "validationsOthers": {
        "acceptsnovat": true
      }
    },
    7: {
      "nationalities": ["NL"],
      "fields": ["region", "region_expedition_place", "region_birthplace", "cityselect", "nationalIdExpeditionDate", "expedition_place", "birth_province", "birthplace"],
      "others": ["region", "region_expedition_place", "region_birthplace", "cityselect", "nationalIdExpeditionDate", "expedition_place", "birth_province", "birthplace"],
      "validations": {
        "acceptsnovat": false
      },
      "validationsOthers": {
        "acceptsnovat": true
      }
    },
    8: {
      "nationalities": ["PT"],
      "fields": ["region", "region_expedition_place", "region_birthplace", "cityselect", "nationalIdExpeditionDate", "expedition_place", "birth_province", "birthplace"],
      "others": ["region", "region_expedition_place", "region_birthplace", "cityselect", "nationalIdExpeditionDate", "expedition_place", "birth_province", "birthplace"],
      "validations": {
        "acceptsnovat": true
      },
      "validationsOthers": {
        "acceptsnovat": true
      }
    }
  };
  /**
   * Init Fn
   * @return {[type]} [description]
   */
  function init() {
    if (NATIONALITIES[0].debug) console.clear('')
    createFields(); // creo campo para guardar la fecha de nacimiento en un solo input    
    nationalityInput.on('change', onNationalityInputChange);
    onNationalityInputChange(); // CARGO EL DEFAULT
    documentTypeSelect.on("change", ondocumentTypeSelectChange);
    // Birth datepicker event. Check if the selected age is < 16
    datepickerSelector.on('change', onDateBirthChange);
    // Modal Listeners
    mModals.attachModalEventsBehaviour(childConfirmModal);
    childConfirmModal.on('hide.bs.modal', onChildModalClose);
    childConfirmModal.find("button:submit").on('click', function () {
      guestDataForm.validator('destroy');
      guestDataForm[0].submit();
    })
    guestDataForm.on('blur', 'input[type=text]', function (e) {
      $(this).val($.trim($(this).val()))
    })
    // remove spacer in nacional id number
    guestDataForm.on('blur', '#nationalIdNumber', function (e) {
      $(this).val($(this).val().replace(/ /g, ''))
    })
    // Box confirm date
    boxConfirmDate.hide();
    restOfForm.show();
    // si vuelvo de arrivals, cargo los datos del form que faltan (birthate) y controlo la caja de Rewards
    if (sessionStorage.getItem('prevFormGuest')) {
      if (sessionStorage.getItem('prevFormGuest') == "true") _controlForward();
    } else sessionStorage.setItem('prevFormGuest', false);
    // Bootstrap Validator
    guestDataForm.validator({
      disable: false,
      custom: NATIONALITIES[0].boostrapValidators
    }).on('submit', submitForm.bind(this));
  }
  /* EY */
  /* Funcionalidades region italy*/
  /* REGION INPUT*/
  var regionInit = function () {
    $("#cityselect").on('change', function () {
      $("#postalCode").val($("option:selected", this).attr('data-postalcode')).focus().blur();
    });
    $(".bs-searchbox").css({
      "padding": "1%"
    })
    $(".bs-searchbox").find(".form-control").removeClass('form-control').css("cssText", "border-color: #000000 !important;");
    // API RUTA REGIONES ITALIA
    var urlRegions = apiUrlPath + "/OCI/regions/IT";
    //urlRegions = "/system/nhGroup/v3/html/api/IT.json"
    let promise = $.ajax({
      data: { 
        origin : (isMobile.any()) ? "" : "desktop",
      },
      method: "GET",
      url: urlRegions,
      async: true,
      dataType: 'json',
      contentType: 'application/json'
    });
    return promise.then(function (result) {
      let toAppend = '';
      (result).forEach((val, index) => toAppend += `<option value="${val.regionCode}">${val.regionName}</option>`)
      regionFields.each(function () {
        $(this).append(toAppend).selectpicker('refresh').on('change', onRegionInputChange);
      });
    }, function (err) {
      // control error json
      regionFields.each(function () {
        toggleInputVisibility($(this).attr('id'), false);
      });
      cityFields.each(function () {
        toggleInputVisibility($(this).attr('id'), false);
      });
      console.log("Ruta no encontrada")
    });
  }
  /** on change region */
  var onRegionInputChange = function () {
    // reset       
    cityFields.selectpicker('refresh');
    var selectid = $(this);
    var selectRegion = ($(this).is('select')) ? $(this).val().toUpperCase() : ""; // por defecto es vacío y cargo campos por defecto
    //  API RUTA CIUTADES POR REGION ITALIA
    var dataAutocomplete = selectid.data('autocomplete'); // recupero el select donde se cargan
    var select = $("#" + dataAutocomplete)
    if (selectRegion != '') {
      var urlCities = apiUrlPath + "/OCI/city/" + selectRegion;
      //urlCities = "/system/nhGroup/v3/html/api/"+selectRegion+".json"
      let promise = $.ajax({
        data: { 
          origin : (isMobile.any()) ? "" : "desktop",
        },
        method: "GET",
        url: urlCities,
        async: true,
        dataType: 'json',
        contentType: 'application/json'
      });
      return promise.then(function (result) {
        // creo option con el resultado
        let toAppend = `<option value=""></option>`;
        filterCities = (result).filter(el => el.regionCode === selectRegion);
        filterCities.forEach((val, index) => toAppend += `<option data-postalcode="${val.zipCode}" value="${val.cityCode}">${val.cityDescription}</option>`);
        // Inyecto los options en el select        
        select.empty().append(toAppend);
        // si es el campo city cargo el código postal     
        setTimeout(function () {
          select.selectpicker('refresh');
        }, 160)
      }, function (err) {});
    } else {
      select.empty();
      setTimeout(function () {
        select.selectpicker('refresh');
      }, 160)
      return true;
    }
  }
  var changeComboNationality = function (selectedNationality, hotelNationality) {
    if (hotelNationality == "IT" && selectedNationality != "IT") {
      let toAppend = ``;
      cityFields.empty();
      $("#country > option").each(function () {
        toAppend += "<option value='" + $(this).val() + "'>" + $(this).text() + "</option>\n"
      });
      expedition_place.empty().append(toAppend);
      birthplace.empty().append(toAppend);
      setTimeout(function () {
        expedition_place.selectpicker('refresh');
        birthplace.selectpicker('refresh');
      }, 300)
    }
  }
  /* FIN Funcionalidades region italy*/
  function createFields() {
    // Creo el campo fecha nacimiento para guardar en un solo campo la fecha
    if (!$("#birthdate").length) {
      $('<input>').attr({
        type: 'hidden',
        id: 'birthdate',
        value: '',
        name: 'birthDate'
      }).addClass('js-logged-birth-date').appendTo(guestDataForm);
    }
    // Creo el campo ciudad que tendrá valor del combo ciudad (italia) o input text normal dependiendo nacionalidad
    if (!$("#city").length) {
      $('<input>').attr({
        type: 'hidden',
        id: 'city',
        value: '',
        name: 'city'
      }).appendTo(guestDataForm);
    }
    // login rewards
    if (!$("#loginRewards").length) {
      $('<input>').attr({
        type: 'hidden',
        id: 'loginRewards',
        value: '',
        name: 'loginRewards'
      }).appendTo(guestDataForm);
    }
    // taxExpeditorPlace
    if (!$("#taxExpeditorPlace").length) {
      $('<input>').attr({
        type: 'hidden',
        id: 'taxExpeditorPlace',
        value: '',
        name: 'taxExpeditorPlace'
      }).appendTo(guestDataForm);
    }
    // taxIssueDate
    if (!$("#taxIssueDate").length) {
      $('<input>').attr({
        type: 'hidden',
        id: 'taxIssueDate',
        value: '',
        name: 'taxIssueDate'
      }).appendTo(guestDataForm);
    }
  }
  // Lógica de campos y validaciones dependientes de nacionalidad
  function requestHidden(selectedNationality, hotelNationality) {
    // control de nacionalidades
    if (NATIONALITIES[0].debug) console.log('PAIS RESIDENCIA:', selectedNationality, '\nHOTEL NACIONALIDAD:', hotelNationality)
    // PONGO VALIDACIONES POR DEFECTO
    // SI LAS REGION DE ITALIA NO ESTAN ACTIVAS, PONGO LAS VALIDACIONES POR DEFECTO
    var found = {
      "inputHidden": (hotelNationality == "IT" && !NATIONALITIES[0].activeItaly) ? NATIONALITIES[0].othterItaly : NATIONALITIES[0].fields, // valor por defecto
      "validations": (hotelNationality == "IT" && !NATIONALITIES[0].activeItaly) ? NATIONALITIES[0].validationsItaly : NATIONALITIES[0].validations // valor por defecto
    };
    // RECORRO CONFIGURACION DE NACIONALIDADES Y COMPARO CON LOS VALORES AL CAMBIAR
    Object.entries(NATIONALITIES).forEach(([key, value]) => { // recorro objeto nacionalidades
      if (typeof value.nationalities !== 'undefined') { // si tiene nacionalidade
        (value.nationalities).find(function (element) { // busco dentro del array nacionalidades [es, fr]
          if (element == selectedNationality) { // si hay conincidencia con valor del campo country en la configuración, cambio valores o añado nuevas validations
            if (hotelNationality == selectedNationality) { // SI COINCIDEN HOTEL Y PAIS DE RESIDENCIA
              if (!NATIONALITIES[0].activeItaly && hotelNationality == "IT" && selectedNationality == "IT") {
                if (NATIONALITIES[0].debug) console.log('EXCEPCION ACTIVAR ITALIA.')
                // EXCEPCION PARA NO ACTIVAR REGION ITALIA
                // Pongo los valores por defecto como paises sin logica. OJO, solo italianos en italia. Cuando se active no pasa por aqui
                found.inputHidden = NATIONALITIES[0].fields;
                found.validations = NATIONALITIES[0].validations;
              } else { // SI EL USUARIO ES DEL MISMO PAIS QUE EL HOTEL = Español en ESpaña
                found.inputHidden = value.fields;
                if (typeof value.validations !== 'undefined') found.validations = value.validations;
              }
            } else { // SI NO COINCIDEN HOTEL Y PAIS DE RESIDENCIA 
              if (hotelNationality == "IT") { // solo si es un hotel italiano con nacinalidad estranjera, cambia solo para italia = español en Italia
                found.inputHidden = NATIONALITIES[0].othterItaly;
                found.validations = NATIONALITIES[0].validationsItaly;
              } else { // español en Alemania
                found.inputHidden = (typeof value.others !== 'undefined') ? value.others : value.fields;
                found.validations = (typeof value.validationsOthers !== 'undefined') ? value.validationsOthers : value.validations;
              }
            }
          }
        });
      }
    });
    if (NATIONALITIES[0].debug) console.log('COFIGURACIÓN FINAL.', found)
    return found;
  }
  /**
   * control prev
   */
  const localData = function (create, data) {
    if (create) {
      sessionStorage.setItem('dataFormGuest', JSON.stringify(data));
      sessionStorage.setItem('prevFormGuest', false);
    } else {
      if (sessionStorage.getItem('dataFormGuest')) {
        return sessionStorage.getItem('dataFormGuest');
      } else return '';
    }
  }
  /*FIN EY*/
  /**
   * Handler when changing the input nationality
   * @param  {[type]} e [Javascript event]
   * @return {[type]}   [description]
   */
  function onNationalityInputChange() {
    var hotelNationality = "";
    // Desactivar NATIONALITIES[0].hotelNationality para producción. ¡¡¡¡ MUY IMPORTANTE !!!
    if (NATIONALITIES[0].hotelNationality !== false && NATIONALITIES[0].hotelNationality !== "") {
      hotelNationality = NATIONALITIES[0].hotelNationality
    } else {
      if (typeof pageData.hotelCountryKey !== 'undefined') {
        if (pageData.hotelCountryKey != '') {
					hotelNationality = pageData.hotelCountryKey;
					hotelCountry = pageData.hotelCountryKey;
        } else $("form#guestDataForm")[0].reset();
      } else $("form#guestDataForm")[0].reset();
    }
    var selectedNationality = $(this).is("select") ? $(this).val().toUpperCase() : "";
    if (hotelNationality == "IT") {
			if (!regionInitActive) regionInit(); // funcionalidades de Region -> solo Italia
      $("#postalCode").val('');
      cityFields.empty();
      // reseto los campos autocomplete
      regionFields.each(function () {
        $(this).find('option:eq(0)').prop('selected', true);
      });
      setTimeout(function () {
        regionFields.selectpicker('refresh');
        cityFields.selectpicker('refresh');
      }, 100)
      changeComboNationality(selectedNationality, hotelNationality); // resetar campos por italia
      if(selectedNationality != ''){
        // HAGO SCROLL PARA UX USUARIO 
        let $moveTo = (selectedNationality == "IT") ? $("#region_birthplace") : $("#birthplace")
        setTimeout(function() { 
            if($moveTo.closest(".form-group").is(":visible")){
              $("HTML, BODY").animate({
                scrollTop: $moveTo.closest(".form-group").offset().top  - 50
              }, 1000);
            }            
        }, 1000);
      }
    }
    var requestNacionality = requestHidden(selectedNationality, hotelNationality);
    var inputsToHide = requestNacionality.inputHidden;
    // Enable first every input
    showInputs(); // muestro todos
    if (typeof NATIONALITIES[0].resetValidations !== "undefined") NATIONALITIES[0].resetValidations(); // reseteo validaciones extra, si hay
    hideInputs(requestNacionality.inputHidden); // oculto los no requeridos
    if (typeof requestNacionality.validations !== 'undefined') NATIONALITIES[0].addValidations(requestNacionality.validations); // si hay otra validaciones
  }
  /**
	 * Handler when changing the document type 
	 * @param  {[type]} e [Javascript event]
	 * @return {[type]}   [description]
	 */
	function ondocumentTypeSelectChange() {
		var type = $(this).is("select") ? $(this).val().toUpperCase() : "";
		if (type == "PASSPORT") {
			toggleInputVisibility('nationalIdExpeditionDate', false);
		} else if (type == "ID") {
			if (nationalityInput.val() == "ES") {
				toggleInputVisibility('nationalIdExpeditionDate', true);
			}else{
				toggleInputVisibility('nationalIdExpeditionDate', false);
			}
		};
	}
  /**
   * Hide the selected inputs past as parameneter
   * @param  {[array]} inputIds [array of input IDs]
   * @return {[type]}          [description]
   */
  function hideInputs(inputIds) {
    inputIds.forEach(function (inputId) {
      if (typeof inputId != "undefined") toggleInputVisibility(inputId, false);
    });
  }
  /**
   * Show very input on the guests view
   * @return {[type]} [description]
   */
  function showInputs() {
    var allInputs = guestDataView.find('.form-group');
    allInputs.each(function (index, inputFormGroup) {
      if ($(inputFormGroup).find('select').length) {
        inputId = $(inputFormGroup).find('select').attr('id');
      } else {
        inputId = $(inputFormGroup).find('input, textarea').attr('id');
      }
      if (typeof inputId != "undefined") toggleInputVisibility(inputId, true);
    });
  }
  /**
   * Change an input visibility
   * @param  {[string]} inputId [Id of the input to toggle]
   * @param  {[bool]} visible [visible true/false]
   * @return {[type]}         [description]
   */
  function toggleInputVisibility(inputId, visible) {
    if (typeof inputId == "undefined") return false;
    var input = guestDataView.find('#' + inputId);
    var inputFormGroup = input.closest('.form-group');
    inputFormGroup.each(function () {
      if (visible) {
        inputFormGroup.show();
        // Enable validation
        input.attr('data-validate', "true");
        input.removeAttr("disabled");
        if (inputId == "nationalIdExpeditionDate") inputFormGroup.closest('.row').children("div").show()
      } else {
        inputFormGroup.hide();
        // Disable validation
        input.attr('data-validate', "false");
        input.prop("disabled", true);
        if (inputId == "nationalIdExpeditionDate") inputFormGroup.closest('.row').children("div").hide()
      }
    });
    // Update the form validation
    guestDataForm.validator({
      disable: false,
      custom: NATIONALITIES[0].boostrapValidators
    }).validator('update');
  }
  /**
   * handler when the birth date changes on the three selector datepicker
   */
  function onDateBirthChange() {
    $("#birthdate").val($(this).selectorDatepicker('getDate'));
    if (!$(this).selectorDatepicker('hasValue') || !$(this).selectorDatepicker('checkIsValidDate')) {
      boxConfirmDate.hide();
      restOfForm.show();
      return;
    }
    var selectedDateMoment = $(this).selectorDatepicker('getMomentDate');
    checkMinorGuest(selectedDateMoment);
    /*// Avoid minor check if is a future option
    if ($(this).selectorDatepicker('checkTimelineDate') <= 0) {
      checkMinorGuest(selectedDateMoment);
    } else {
      // Selected Future option
      boxConfirmDate.hide();
      restOfForm.show();
    }*/
  }
  /**
   * Handler to check if the guest is a child
   * @param  {[Object]} birthDateMoment [MomentJS date object with the birth date]
   * @return {[type]}                 [description]
   */
  function checkMinorGuest(birthDateMoment) {
    if (birthDateMoment.isValid() === true) {
      var age = moment().diff(birthDateMoment, 'years');
      var isUnderAge = age < MIN_ADULT_AGE;
      if (isUnderAge) {
        onMinorGuestSelected();
      } else {
        // Adult guest
        boxConfirmDate.hide();
        restOfForm.show();
      }
      isUnderAgeInput.val(isUnderAge);
    }
  }
  /**
   * Handler when the guest is a child
   * @return {[type]} [description]
   */
  function onMinorGuestSelected() {
    // Guest with age < min age for adult
    if (isMobile.any()) {
      // Modal show
      childConfirmModal.modal('show');
    } else {
      // Confirm panel show
      boxConfirmDate.show();
    }
    // Hide the rest of the form
    restOfForm.hide();
  }
  /**
   * Submit Function
   * @param  {[type]} $form [description]
   * @param  {[type]} e     [description]
   * @return {[type]}       [description]
   */
  function submitForm(e) {
    // pongo valor correcto en city
    var isDisabled = $('#cityinput').prop('disabled');
    $("#city").val((isDisabled) ? $('#cityselect').val() : $('#cityinput').val())
    $("#taxExpeditorPlace").val($('#expedition_place').val())
    // fecha de expedición
    let datetaxIssueDate=moment($("#nationalIdExpeditionDate").val(), 'DDMMYY').format('DD/MM/YYYY')    
    //alert(moment(datetaxIssueDate).isValid())
    datetaxIssueDate=(moment(datetaxIssueDate).isValid())? datetaxIssueDate : ""  ;
    $("#taxIssueDate").val(datetaxIssueDate);

    var validForm = true;
    var isUnderAge = (isUnderAgeInput.val() === "true");
    var nacionalidad = document.querySelector('#nationality-clone');
    if (e.isDefaultPrevented()) {
      //force to send the form if the guest is younger than age selected of the country
      if (isUnderAge) {
        trackOCIMinorCheck();
        this.guestDataForm.validator('destroy');
        this.guestDataForm[0].submit();
      } else {
        validForm = false;
      }
      this.datepickerSelector.selectorDatepicker('validateOnSubmit');
    } else {
      // Valid Form: Custom checks
      validForm = this.datepickerSelector.selectorDatepicker('validateOnSubmit');
    }
    // Form result
    if (validForm === true) {
      //EY: Los checks de GDPR no checkeados se han de enviar con el valor "N"
      $('.m-GDPR-group').find(':checkbox').each(function () {
        ($(this).is(':checked') == false && $(this).attr('name')!='GDPR_flag_5') && $(this).parent().append('<input type="hidden" value="N" name="' + $(this).attr('name') + '" />');
      });
      let datosForm = guestDataForm.serializeArray()
      localData(true, datosForm) // guardo datos en localstorage
      if (NATIONALITIES[0].debug) console.log(datosForm); // Debug para controlar que envia el form
      trackOCISuccess(Globals.page_section, nacionalidad.value);
      toggleLoadingButton(this.guestDataForm, true);
      // Submit Form
    } else {
      // Invalid form
      trackOCIError(Globals.page_section, nacionalidad.value);
      e.preventDefault();
    }
  }
  /**
   * Handler when the child modal is closed. Clean the mobile date input
   * @param  {[Object]} e [JS event]
   * @return {[type]}   [description]
   */
  function onChildModalClose() {
    datepickerSelector.selectorDatepicker('setDate', '');
    // Trigger manually the validator
    datepickerSelector.find('select.js-day-selector').trigger('input');
    restOfForm.show();
  }
  /**
   * Custom bootstrap validator function for DNI/NIE inputs
   * @param  {[type]} $el [description]
   * @return {[type]}     [description]
   */
  function customDocumentNumberValidator($el) {
    value = $el.val();
    //console.log($("#country").val());
    if($("#country").val()!="ES"){
      return '';
    }
    if($("#documentType").val()!="id"){
			return '';
		}
    var docTypeInput = this.$element.find('select#tipo-doc');
    if (!value) {
      return;
    }
    /*var isValid = validateNumberDocument(docTypeInput.val(), $el.val());
    if (!isValid) {
      return 'error';
    }*/
    if (value.length == 8) { // control para poner 9 digitos si vienen 8.           
      var newDni = '0' + value;
      $el.val(newDni)
      value = newDni;
    }
    var validChars = 'trwagmyfpdxbnjzsqvhlcket';
    var dniRexp = /^[0-9]{8}[trwagmyfpdxbnjzsqvhlcket]{1}$/i;
    var nieRexp = /^[XY]{1}[0-9]{7}[trwagmyfpdxbnjzsqvhlcket]{1}$/i;
    var string = ((value == null) ? "" : value).toString().toLowerCase();
    if (!dniRexp.test(string) && !nieRexp.test(string)) return 'error';
    var nie = string
      .replace(/^[x]/, '0')
      .replace(/^[y]/, '1')
    var letter = string.substr(-1);
    var charIndex = parseInt(nie.slice(0, -1)) % 23;
    return (validChars.charAt(charIndex) === letter) ? '' : 'error';
  }
  /**
   * Custom validator to check if the birth date is a past date
   * @return {[type]} [description]
   */
  function customBirthDateValidator() {
    if (this.datepickerSelector.selectorDatepicker('checkIsValidDate', true) === true) {
      if (this.datepickerSelector.selectorDatepicker('checkTimelineDate') === 1) {
        return 'error';
      }
    }
  }
  /**
   * Custom validator to check if the expedition date is valid date
   * @return {[type]} [description]
   */
  function customValidateExpeditionDate($el) {
    f = $el.val();
    var dia = f.substr(0, 2),
      mes = f.substr(2, 2),
      year = f.substr(4, 2);
    var dd = parseInt(dia),
      m = parseInt(mes),
      y = parseInt(year);
    j = (m == 1) ? 1 : m - 1;
    if (f.length < 6 || f.length > 6 || dd > 31 || m > 12 || dd == 0 || m == 0 || y == 0) return 'error'; // año acutal
    var t = new Date(),
      yy = t.getFullYear(),
      mesactual = t.getMonth() + 1,
      diaactual = t.getDate();
    ya = yy.toString().substr(-2);
    // si es mayor que el año actual es anterior a 2000    
    y = (y > ya && y > 50) ? y + 1900 : y + 2000;
    // compruebo si es una fecha valida
    var dt = `${y}-${mes}-${dia}`;
    var date = moment(dt);
    let today = moment(new Date());
    if (!date.isValid()) return 'error';
    // que sea una fecha actual
    if (today.diff(date) < 0) return 'error';
  }
  /**
   * @description fill the user logged info into the correct checkout form fields
   */
  function fillLoggedInfo(response) {
		// FUNCION FILL FORM -> REQUEST JSON DATOS USUARIO SIN LOGGED
		var inputId;
		var $inputLabel;
		var $selectedInput;
		var $element;
		var $select;
		// Cargo los campos en el formulario
		var promise = new Promise(function(resolve, reject) {
			let ajaxResponse = response;
			$.each(userLoggedFields, function(key, data) {
				if (typeof data != "undefined") {
					$element = guestDataForm.find(data.class);
					if ($element.length > 0) {
						inputId = $element.attr("id");
						$inputLabel = guestDataForm.find('label[for="' + inputId + '"]');
						if (response[data.dataKey]) {
							data.value = response[data.dataKey];
						}
						if (data.value != null) {
							$select = $element.filter("select");
							if ($select.length) {
								// campos select
								_fillSelectElement($element, data.value);
								if (inputId == "country" && pageData.hotelCountryKey == "IT") {
									_promiseFilledRegions(ajaxResponse, false);
								}
							} else if (
								["radio", "checkbox"].indexOf($element.attr("type")) >= 0) {
								// redio button
								var defaulGender = data.value.toLowerCase();
								var genderValue = defaulGender == "male" || defaulGender == "female" ? defaulGender == "male" ? 1 : 2 : defaulGender;
								$selectedInput = $element.filter("[value=" + genderValue + "]");
								$selectedInput.trigger("click");
							} else {
								// input value
								$element.val(data.value).focus();
								$inputLabel.addClass("focus");
							}
						}
					}
				}
				$element.prop("disabled", data.blocked).toggleClass("disabled", (data.blocked) ? data.blocked : false);
			});
			resolve();
		});
		return promise.then(function(result) {
			// Remove box Rewardards y GDPR checkbox
			_hideRewards();
		}, function(err) {
			if (NATIONALITIES[0].debug) console.log(err);
		}).catch(
			// Registrar la razón del rechazo
			function(reason) {
				if (NATIONALITIES[0].debug) console.log("Manejar promesa rechazada (" + reason + ") aquí.");
			});
	}
  // FUNCION PARA OCULTAR LOGIN REWARDS
  var _hideRewards = function () {
    $("#loginRewards").val('1');
    $(".box.m-rewards").remove();
    $("#GDPR_flag_5").closest(".m-GDPR").remove();
  }
  var _controlForward = function() {
		if ($("#name").val() != "") {
			// controlo que hay datos en el form y no es un refresh
			var datosform = JSON.parse(localData());
			Object.entries(datosform).forEach(([key, field]) => {
				// Cargo los input select
				var $element = $('[name="' + field.name + '"]');
				$select = $element.filter("select");
				if ($select.length) {
					// campos select
					_fillSelectElement($element, field.value);
					if (field.name == "country" && pageData.hotelCountryKey == "IT") {
						_promiseFilledRegions(datosform, true);
					}
				}
				// el cumpleaños
				if (field.name == "birthDate") {
					// si es cumpleaños cargo los select
					let birthDate = field.value;
					if (birthDate != null) {
						_fillSelectElement($("#dia"), parseInt(birthDate.split("/")[0]));
						_fillSelectElement($("#mes"), parseInt(birthDate.split("/")[1]));
						_fillSelectElement($("#year"), birthDate.split("/")[2]);
					}
				}
				if (field.name == "GDPR_flag_5" && field.value == 'S') $("#subscribeRewards").val('true')
				if (field.name == "loginRewards" && field.value == "1") _hideRewards(); // oculto rewards
			});
		}
	};
	function _fillSelectItaly(datosform, request = true) {
		if (request) { // si es volver atras, parseo datos igual que en login
			var result = [];
			$.each(datosform, function(key, data) {
				result[data["name"]] = data["value"]
			})
			datosform = result
		};
		var selectCombo = {
			region_birthplace: {
				name: "region_birthplace",
				dataKey: "region_birthplace",
				depending: "country"
			},
			region: {
				name: "region",
				dataKey: "region",
				depending: "country"
			},
			region_expedition_place: {
				name: "region_expedition_place",
				dataKey: "region_expedition_place",
				depending: "country"
			},
			birthplace: {
				name: "birthplace",
				dataKey: (request) ? "birthplace" : "placeBirth",
				depending: "region_birthplace"
			},
			cityselect: {
				name: "cityselect",
				dataKey: (request) ? "cityselect" : "city",
				depending: "region"
			},
			expedition_place: {
				name: "expedition_place",
				dataKey: (request) ? "expedition_place" : "expeditorPlace",
				depending: "region_expedition_place"
			}
		};
		$.each(selectCombo, function(key, data) {
			$element = $("#" + key);
			$isvisible = $element.closest(".form-group").is(":visible");
			$dependingCount = _checkSelect($('[name="' + data["depending"] + '"]'));
			$itemCount = _checkSelect($('[name="' + data["name"] + '"]'));
			$value = datosform[data["dataKey"]];
			//console.log(data["dataKey"], key, $isvisible, data["depending"], $dependingCount, $value, data["name"], _checkSelect($('[name="' + data["name"] + '"]'), false))
			if ($isvisible && $dependingCount && $value) {
				var $element2 = $('[name="' + data["name"], +'"]');
				if ($itemCount) _fillSelectElement($element2, datosform[data["dataKey"]]);
				else setTimeout(function() {
					//console.log("espero", data["name"], $value, datosform[data["dataKey"]])         
					_fillSelectElement($element2, datosform[data["dataKey"]]);
				}, optionTimeAjax);
			}
		});
	}
	function _promiseFilledRegions(datosform, request) {
		setTimeout(function() {
			_fillSelectItaly(datosform, request);
		}, optionTimeAjax);
	}
	function _checkSelect($element, type = true) {
		var $select = $element.filter("select");
		var selectedOption = $select.find("option");
		return (type) ? selectedOption.length > 0 ? true : false : selectedOption.length;
	}
  function _fillSelectElement($element, value) {
		var $select = $element.filter("select");
    var selectedOption = $select.find("option[value=" + value + "]");
    if(selectedOption.val()==undefined ){
			var testCampos = ['expedition_place', 'cityselect', 'birthplace'];
			var txtId = $select.attr("id");
			if (testCampos.includes(txtId)){
				$("select#"+(txtId)+" > option").each(function() {			
					if(this.text ==value.toUpperCase()  ) {
						selectedOption = $select.find("option[value=" + this.value + "]");
					}
				});
			}
		}
		var $input = $element.filter("input");
		if ($select.hasClass("ui-autocomplete-input")) {
			$input.val(selectedOption.text());
		}
		$select.val(selectedOption.val()).trigger("change");
	}
  // PUBLIC API
  return {
    init: init,
    hideInputs: hideInputs,
    showInputs: showInputs,
    toggleInputVisibility: toggleInputVisibility,
    guestDataView: guestDataView,
    guestDataForm: guestDataForm,
    nationalityInput: nationalityInput,
    datepickerSelector: datepickerSelector,
    fillLoggedInfo: fillLoggedInfo
  };
})();
$(function () {
  if ($('.p-cio-guest-data').length) {
    guestData.init();
  }
  if ($('.p-cio-your-room').length) {
    if (typeof pageData != "undefined") {
      //Show error
      if (typeof pageData.javaError != "undefined" && pageData.javaError == "true") {
        $('#modal-java-error').modal("show");
      }
      //set vars
      hotelIdPage = (typeof pageData.hotelId != "undefined") ? pageData.hotelId : "";
    }
    // desactivo prevFormGuest si refresco
    window.onbeforeunload = function (e) {
      sessionStorage.setItem('prevFormGuest', false);
    }
  }
  // Si estoy en arrivals y vuelvo al form guest
  if ($('.m-arrival').length) {
    window.onbeforeunload = function (e) {
      sessionStorage.setItem('prevFormGuest', true);
    }
  }
  // Si estoy en guest list reseto la variable form vacio
  if ($('.m-guests-view').length) {
    sessionStorage.setItem('prevFormGuest', false);
  }
});

/**
 * Guest page function
 * @return {[type]} [description]
 */
var guestPage = (() => {
  // Public API
  function init(selector){
      var view = $('.guests-view-guests');
      $('.guests-view-guests').on('click', 'button:submit', _clickButton)
  }
  _clickButton = function(){
      $(this).prop("disabled", true);
      $(this).closest("form").submit();
  }
  return {
    init: init
  }
})();
$(() => {
  if($('.guests-view-guests').length){
    guestPage.init('.guests-view-guests');
  }  
});
var pHomeDesktop = (function () {
  let $homeView = null;
  let $searchBar = null;
  let $searchForm = null;
  let occupancy = null;
  let $occupancies = null;
  let location = {
    $field: null,
    selected: null
  };
  let modals = null;
  function init(view) {
    $homeView = view;
    $searchBar = $homeView.find(".m-search-bar");
    $searchForm = $searchBar.find("form");
    $occupancies = $searchForm.find("#m-occupancy-sb");
    modals = {
      $loading: $homeView.find("#loading-modal-results"),
      $matchError: $homeView.find("#modal-search-no-result"),
      $geolocationError: $homeView.find("#modal-geolocation-error")
    };
    occupancy = reservationOccupancyNew.getOccupancy($occupancies.data("occupancy-index"));
    location.$field = $searchForm.find("#location2-sb");

    $searchForm.validator({
      disable: false,
    }).on('submit', function (e) {
      let validForm = true;
      let rangeInvalid = true;
      let locationInvalid = true;
      const $form = $(this);

      toggleLoadingButton($form, true);

      if (e.isDefaultPrevented()) {
        // Invalid Form
        validateBookingRange($form);
        //commonBookingHotel.isValidRange();
        toggleLoadingButton($form, false);
      } else {
        //e.preventDefault();
          rangeInvalid = validateBookingRange($form);
          locationInvalid = validateLocation(location.$field);
          validForm = (!rangeInvalid && !locationInvalid);

          if(validForm) {
          modals.$loading.modal({
            show: true,
            backdrop: "static",
            keyboard: false
          });
          _onFormSubmit(e);
        } else {
          e.preventDefault();
        }
        toggleLoadingButton($form, false);
      }
    });
  }

  function _onFormSubmit(ev) {
    let occupancyInfo = occupancy.generateOccupancyInfo();
    let formData = {};
    let dataUrl = null;
    let checkin;
    let checkout;
    location.selected = location.$field.data("selected");
    $searchForm.append(occupancyInfo.inputs);

    if (location.selected) {
      $.each($searchForm.serializeArray(), function (index, obj) {
        formData[obj.name] = obj.value;
      });

      formData.fini = (formData.fini) ? formData.fini : moment().format("DD/MM/YYYY");
      formData.fout = (formData.fout) ? formData.fout : moment().add(1, 'day').format("DD/MM/YYYY");


      checkin = moment(formData.fini, location.selected.df);
      checkout = moment(formData.fout, location.selected.df);

      if (location.selected.ebp && location.selected.url) {
        ev.preventDefault();
        dataUrl = {
          hotelID: formData.hotelId,
          checkinDate: checkin.format(location.selected.df),
          checkoutDate: checkout.format(location.selected.df),
          get nights() {
            return checkout.diff(checkin, 'days');
          },
          adults: occupancyInfo.pax.adults,
          children: occupancyInfo.pax.children + occupancyInfo.pax.babies,
          roomsNumber: occupancyInfo.rooms,
          childages: (occupancyInfo.ages.length > 1) ? occupancyInfo.ages : ""
        };

        window.location.href = _getRedirectUrl(location.selected.url, dataUrl);
        return;
      }
    }
  }

  // parsed url
  function _getRedirectUrl(tpl, data) {
    return tpl.replace(/\[(.*?)\]/gmi, function (match, p1) {
      var prop = p1.trim();
      return data.hasOwnProperty(prop) ? data[prop] : '';
    });
  }

  /* 
    FUNCION PARA AÑADIR FLAG POR IP Y LANG
  */
  function detectIp(layer) {
    var $layer = $(".p-home");
    var template = [
      '<div class="m-language-edition full-width">',
      '<div class="language-edition alert alert-dismissible" role="alert">',
      '<div class="language-edition-inner"><span>{{text}} {{text2}}<a class="link" href="{{url}}" title="{{textLink}}"><img class="flag" src="{{static}}v3/html/img/banderas/{{country}}.png" alt="{{textLink}}">{{textLink}}</a></span>',
      '<button class="btn-ico" type="button" data-dismiss="alert" aria-label="Close"><span class="nh-ic-close" aria-hidden="true"></span></button>',
      '</div>',
      '</div>',
      '</div>'
    ].join("\n");

    $.ajaxSetup({
      cache: false
    });

    /*var datos = {
        "countryCode": "ES",
        "continent": null,
        "domainLanguage": "en",
        "text": "¿Nos visitas desde",
        "text2": "? Te recordamos que también puedes realizar tu reserva desde nuestra edición española",
        "textLink": "Ir a nh-hoteles.es",
        "languageMetaData": "Español",
        "countryMetaData": "Spain",
        "domainHost": "nhdev.nh-hotels.com"
    };*/
    promise = $.ajax({
      url: "/getUserDataGEOIP",
      type: "GET",
      /*
      traza para ver mock Xavi java 
      data: {
          environment: 'dev'
      },*/
      contentType: "application/json"
    });
    promise.then(function (datos) {
      if (typeof datos != "undefined") {
        if (_check(datos.text) && _check(datos.textLink) && _check(Globals.staticDomain) && _check(datos.domainHost) && _check(datos.countryMetaData)) {
          var data = {
            text: datos.text,
            text2: datos.text2,
            textLink: datos.textLink,
            url: "https://" + datos.domainHost,
            country: (datos.countryMetaData).toLowerCase(),
            static: Globals.staticDomain
          };
          var output = templatesRoom.getTemplate(template, data);
          $(output).prependTo($layer);

          // track
          trackShowDetectIPOrigin(Globals.page_section);
        }
      }
    }, function () { }).always(function () { });
  }
  function _check(value) {
    return (value != "" && value != "null" && value != null && typeof value !== "undefined") ? true : false;
  }
  // Ey, add function modal error
  function _modalOnload() {
    console.log("modalOnload")
    var labelModal = pageData.labelModalError;
    $('#modal-error p').text(labelModal);
    $('#modal-error').modal('show');
  }
  return {
    init: init,
    detectIp: detectIp,
    modalOnload: _modalOnload
  };
})();
/*
$(function () {
  if ($(".p-home.is-desktop").length) {
    pHomeDesktop.init($(".p-home.is-desktop"));
  }
  // Aplica a desktop y mobile 
  if ($(".p-home").length) {
    pHomeDesktop.detectIp();
  }
});
// Ey, add function modal error
$(window).load(function () {
  if (pageData.showModal != "undefined" && ($(".p-home.is-desktop").length || $(".p-home.is-mobile").length)) {
    if (pageData.showModal) pHomeDesktop.modalOnload();
  }
});
*/
var pHomeMobile = (function () {
  let $homeView = null;
  let $searchBar = null;
  let $searchForm = null;
  let occupancy = null;
  let $occupancies = null;
  let modals = null;
  let location = {
    $field: null,
    selected: null
  };
  let geolocation = null;
  function init(view) {
    $homeView = view;
    $searchBar = $homeView.find(".m-search-bar");
    $searchForm = $searchBar.find("form");
    $occupancies = $searchForm.find("#m-occupancy-sb");
    modals = {
      $loading: $homeView.find("#loading-modal-results"),
      $matchError: $homeView.find("#modal-search-no-result"),
      $geolocationError: $homeView.find("#modal-geolocation-error")
    };
    occupancy = reservationOccupancyNew.getOccupancy($occupancies.data("occupancy-index"));
    geolocation = {
      $fields: $searchForm.find(".js-geolocation"),
      get $lat() {
        return this.$fields.filter(".geo-lat");
      },
      get $lon() {
        return this.$fields.filter(".geo-lon");
      },
      get $acc() {
        return this.$fields.filter(".geo-acc");
      }
    };

    location.$field = $searchForm.find("#location2-sb");

    $searchForm.validator({
      disable: false,

    }).on('submit', function (e) {
      let validForm = true;
      let rangeInvalid = true;
      let locationInvalid = true;
      const $form = $(this);

      toggleLoadingButton($form, true);

      if (e.isDefaultPrevented()) {
        // Invalid Form
        validateBookingRange($form);
        //commonBookingHotel.isValidRange();
        toggleLoadingButton($form, false);
      } else {
        rangeInvalid = validateBookingRange($form);
        locationInvalid = validateLocation(location.$field);
        validForm = (!rangeInvalid && !locationInvalid);

        if (!$form.data("validate")) {
          e.preventDefault();
          if (validForm) {
            _handleSubmitForm(e);
          }
        } else {
          if (!location.selected.Type) {
            location.$field.val('');
          }
        }
        toggleLoadingButton($form, false);
      }
    });
  }

  function _handleSubmitForm(ev) {
    location.selected = location.$field.data("selected");
    if (location.selected.Type) _onFormSubmit(ev);
    else _onClickCloseMe(ev);
  }

  function _onClickCloseMe(ev) {
    //ev.preventDefault();

    if (window.location.hostname.indexOf("anantara") < 0 && geolocation) {
      geolocateMe().then(function (response) {
        if (response.coords.latitude && response.coords.longitude) {
          geolocation.$lat.val(response.coords.latitude);
          geolocation.$lon.val(response.coords.longitude);
          geolocation.$acc.val(response.coords.accuracy);
          _onFormSubmit();

        } else {
          modals.$geolocationError.modal("show");
        }

      }, function () {
        modals.$geolocationError.modal("show");
      });

    } else {
      ev.preventDefault();
      modals.$matchError.modal("show");
    }

  }

  function geolocateMe() {
    var deferred = $.Deferred();
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (position) {
        return deferred.resolve(position);
      }, function (error) {
        return deferred.reject(error);
      }, {
        enableHighAccuracy: true,
        maximumAge: 5e3,
        timeout: 1e4
      });
    } else {
      return deferred.reject("error");
    }
    return deferred.promise();
  }

  function _onFormSubmit(ev) {

    let occupancyInfo = occupancy.generateOccupancyInfo();
    let formData = {};
    let dataUrl = null;
    let checkin;
    let checkout;

    modals.$loading.modal({
      show: true,
      backdrop: "static",
      keyboard: false
    });

    $searchForm.append(occupancyInfo.inputs);

    if (location.selected) {
      $.each($searchForm.serializeArray(), function (index, obj) {
        formData[obj.name] = obj.value;
      });

      formData.fini = (formData.fini) ? formData.fini : moment().format("DD/MM/YYYY");
      formData.fout = (formData.fout) ? formData.fout : moment().add(1, 'day').format("DD/MM/YYYY");

      checkin = moment(formData.fini, location.selected.df);
      checkout = moment(formData.fout, location.selected.df);

      if (location.selected.ebp && location.selected.url) {
        ev.preventDefault();
        dataUrl = {
          hotelID: formData.hotelId,
          checkinDate: checkin.format(location.selected.df),
          checkoutDate: checkout.format(location.selected.df),
          get nights() {
            return checkout.diff(checkin, 'days');
          },
          adults: occupancyInfo.pax.adults,
          children: occupancyInfo.pax.children + occupancyInfo.pax.babies,
          roomsNumber: occupancyInfo.rooms,
          childages: (occupancyInfo.ages.length > 1) ? occupancyInfo.ages : ""
        };

        window.location.href = _getRedirectUrl(location.selected.url, dataUrl);
        return;
      } else {
        $searchForm.data("validate", true).trigger("submit");
      }
    }
  }

  /* 
  FUNCION PARA AÑADIR FLAG POR IP Y LANG
*/
  function detectIp(layer) {
    var $layer = $(".p-home");
    var template = [
      '<div class="m-language-edition full-width">',
      '<div class="language-edition alert alert-dismissible" role="alert">',
      '<div class="language-edition-inner"><span>{{text}} {{text2}}<a class="link" href="{{url}}" title="{{textLink}}"><img class="flag" src="{{static}}v3/html/img/banderas/{{country}}.png" alt="{{textLink}}">{{textLink}}</a></span>',
      '<button class="btn-ico" type="button" data-dismiss="alert" aria-label="Close"><span class="nh-ic-close" aria-hidden="true"></span></button>',
      '</div>',
      '</div>',
      '</div>'
    ].join("\n");

    $.ajaxSetup({
      cache: false
    });

    /*var datos = {
        "countryCode": "ES",
        "continent": null,
        "domainLanguage": "en",
        "text": "¿Nos visitas desde",
        "text2": "? Te recordamos que también puedes realizar tu reserva desde nuestra edición española",
        "textLink": "Ir a nh-hoteles.es",
        "languageMetaData": "Español",
        "countryMetaData": "Spain",
        "domainHost": "nhdev.nh-hotels.com"
    };*/
    var urlSec = "/getUserDataGEOIP";
    if(typeof Globals != "undefined"){
      if(typeof Globals.subdomain != "undefined"){
        if(Globals.subdomain != "" ) urlSec = Globals.subdomain + urlSec;
      }
    }
    promise = $.ajax({
      url: urlSec,
      type: "GET",
      /*
      traza para ver mock Xavi java 
      data: {
          environment: 'dev'
      },*/
      contentType: "application/json"
    });
    promise.then(function (datos) {
      if (typeof datos != "undefined") {
        if (_check(datos.text) && _check(datos.textLink) && _check(Globals.staticDomain) && _check(datos.domainHost) && _check(datos.countryMetaData)) {
          var data = {
            text: datos.text,
            text2: datos.text2,
            textLink: datos.textLink,
            url: "https://" + datos.domainHost,
            country: (datos.countryMetaData).toLowerCase(),
            static: Globals.staticDomain
          };
          var output = templatesRoom.getTemplate(template, data);
          $(output).prependTo($layer);

          // track
          trackShowDetectIPOrigin(Globals.page_section);
        }
      }
    }, function () { }).always(function () { });
  }
  function _check(value) {
    return (value != "" && value != "null" && value != null && typeof value !== "undefined") ? true : false;
  }
  // Ey, add function modal error
  function _modalOnload() {
    console.log("modalOnload")
    var labelModal = pageData.labelModalError;
    $('#modal-error p').text(labelModal);
    $('#modal-error').modal('show');
  }

  // parsed url
  function _getRedirectUrl(tpl, data) {
    return tpl.replace(/\[(.*?)\]/gmi, function (match, p1) {
      var prop = p1.trim();
      return data.hasOwnProperty(prop) ? data[prop] : '';
    });
  }

  return {
    init: init,
    detectIp: detectIp,  // Ey, detect ip 
    modalOnload: _modalOnload // Ey, Aplica a desktop y mobile, modal de error
  };
})();

$(function () {
  if ($(".p-home.is-mobile").length) pHomeMobile.init($(".p-home.is-mobile"));
  if ($(".p-home.is-desktop").length) pHomeMobile.init($(".p-home.is-desktop"));
  // Ey, Aplica a desktop y mobile 
  if ($(".p-home").length) {
    pHomeMobile.detectIp();
  }
});

// Ey, add function modal error
$(window).load(function () {
  if (typeof pageData !== 'undefined' &&  pageData.showModal != "undefined" && ($(".p-home.is-desktop").length || $(".p-home.is-mobile").length)) {
    if (pageData.showModal) pHomeMobile.modalOnload();
  }
});

/*  ----------------------------------------------------------------------------------------------------
    JS choose your room
------------------------------------------------------------------------------------------------------ */

var hotelMap = (function(window, undefined) {
    var $mapsContainer;
    var $mapsContent;
    var $mapCanvas;
    var streetsSize = 140;
    var ratio = 8;
    var $floorsButtons;
    var $map;
    var data;

    function init(floorNumber) {
        $mapsContainer = $(".maps-container");
        $mapsContainer.css({
            "width": "700px",
            "height": "800px"
        });
        $mapsContent = $mapsContainer.find(".map-content");
        $map = $mapsContent.find(".map");
        $mapCanvas = $map.find(".maps-canvas");
        $floorsButtons = $(".floor-button");

        $floorsButtons.on("click", function() {
            data = $(this).data("floor");
            getFloor(data);
        });

        getFloor(1);
    }

    /**
     * Metodo para obtener el json de pruebas para los planos. Son json que tenemos guardados ya. Preparado para todos los entornos (local, dev, int)
     * @param {string} floorNumber - numero de planta
     */
    function getFloor(floorNumber) {
        var domain = window.location.host;
        var url;
        var promise = null;
        if(window.location.host.indexOf("localhost") >=0 || window.location.host.indexOf("172.18.65.107") >=0) {
            url = "http://" + domain + "/src/mocks/floor" + floorNumber + ".json";
        } else {
            if(window.location.pathname.indexOf("/dev/nh-v3/") >=0) {
                url = "http://" + domain + "/dev/nh-v3/mocks/floor" + floorNumber + ".json";
            } else {
                url = "http://" + domain + "/html/nh-v3/mocks/floor" + floorNumber + ".json";
            }
        }

        promise = $.getJSON(url);
        $mapCanvas.html("").hide();
        $map.html("").append($mapCanvas);
        $.when(promise).then(function(response) {
            _buildMap(response);
        }, function(error) {
            //console.log("promesa incorrecta", error);
        }).always(function() {
            //console.log("esto se ejecuta falle o no la promesa");
        });
    }

    /**
     * Metodo para obtener el json a traves de una url, haciendo una promesa hacia esa url
     * @param {string} floorUrl - url del json para hacer la petición
     */
    function getFloorByUrl(floorUrl) {
        var promise = $.getJSON(floorUrl);

        $mapCanvas.html("").hide();
        $map.html("").append($mapCanvas);

        $.when(promise).then(function(response) {
            _buildMap(response);
        }, function(error) {
            //console.log("promesa incorrecta", error);
        }).always(function() {
            //console.log("esto se ejecuta falle o no la promesa");
        });
    }

    /**
     * Metodo para obtener el json a de un string pasado
     * @param {string} jsonString - string a convertir en json para pintar el mapa
     */
    function getFloorByString(jsonString) {
        _buildMap(JSON.parse(jsonString));
    }

    function _buildMap(floorData) {
        //1 vamos a construir la estructura del mapa
        var structure = $(document.createElementNS("http://www.w3.org/2000/svg", "polyline")).attr({
            "points": _getStructureCoordinates(floorData.floor.structure),
            "fill": "#fff",
            "stroke": "#fff",
            "stroke-width": 1
        });
        var hiddenMap;
        $mapCanvas.append(structure);
        $map.css({
            height:$mapCanvas.height()
        });
        $mapsContent.css({
            "width": ($mapCanvas.width() + (streetsSize * 2)),
            "height": ($mapCanvas.height() + (streetsSize * 2))
        });
        _drawStreets(floorData.streets);
        _drawRooms(floorData.rooms);

        hiddenMap = getVisibleMapAvailable();

        $mapsContent
        .css(centerMap(hiddenMap))
        .pep({
            constrainTo: [-hiddenMap.hSize, 0, 0, -hiddenMap.wSize],
            useCSSTranslation: false,
            shouldEase: false,
            debug: false
        });
    }

    function getVisibleMapAvailable() {
        var wDiff =  $mapsContent.outerWidth(true) - $mapsContainer.width(),
            hDiff =  $mapsContent.outerHeight(true) - $mapsContainer.height();

        return {hSize: hDiff, wSize: wDiff};
    }

    //coordenadas para centrar el mapa
    function centerMap(data) {
        var centerCoor = {
            left: (data.wSize / 2) * -1, 
            top: (data.hSize / 2) * -1
        };

        return centerCoor;
    }

    function _drawStreets(streetsData) {
        var streetInfo;
        var streetInfoValue;
        var $streets;

        $.each(streetsData, function(key, value) {
            var info = "";
            var $currentStreet;

            streetInfo = $("<div class='street-info'></div>");
            streetInfoValue = $("<span class='street-orientation'></span>");
            $streets = $mapsContent.find("div.street");
            streetInfoValue.addClass(value.type.toLowerCase());
            $currentStreet =$streets.filter(".street-" + key);
            $currentStreet.html("");

            if(value.name && value.name.length > 0) {
                info += "<p class='street-name'><span>" + value.name + "</span></p>";
            }

            if(value.type === "city" && value.name) {
                streetInfo.addClass("info-poi");
                info+= "<span class='street-orientation poi' ></span>";
            } else if(value.type !== "city") {
                streetInfo.addClass("info-" + value.type);
                info+= "<span class='street-orientation " + value.type + "' ></span>";
            }

            streetInfo.html(info);
            $currentStreet.append(streetInfo);
        });
    }

    function _drawRooms(roomsData) {
        var roomData; //json con los datos de la habitación
        var roomContainer; //contenedor de la habitación
        var roomContent; // contenido de la habitación
        var roomClass; //clases a aplicar al contenedor de la habitación
        var selectableRoomsList = ["none", "room", "upselling", "duplex", "duplex-upsell", "duplex-upselling"];//lista de habitaciones seleccionables. No son elementos comunes

        for(let x = 0; x < roomsData.length; x++) {
            roomContainer = $("<div></div>"); 
            roomContent = null;
            roomClass = "room ";
            roomData = roomsData[x];

            _setUpRoomContainer(roomData, roomContainer);

            if(selectableRoomsList.indexOf(roomData.special) >= 0) { //si no es un elemento comun -> habitación estandar o upselling
                //habitacion disponible o no
                roomClass+= (roomData.available) ? "room-available" : "room-noavailable";

                //si es habitacion preferencias
                roomClass += (roomData.preferences) ? "-preferences" : "";

                //si es upselling o no
                roomClass += (roomData.special.indexOf("upselling") >=0) ? "-upselling" : "";

                //si es duplex o no
                roomClass += (roomData.special.indexOf("duplex") >=0) ? " room-duplex" : "";

                //si tiene puertas o no
                roomClass += (roomData.door) ? " door door-" + roomData.door : "";
                
                //generamos el contenido de la habitación
                roomContent = `<div class='room-content'><span>${roomData.id || ""}</span><i></i></div>`;
            } else {//si es un elmemento común
                roomClass += "room-" + roomData.special.toLowerCase();
        
                //generamos el contenido del elemento común
                roomContent = `<div class='room-content'><span>${roomData.description || ""}</span></div>`;
            }

            roomContainer.html(roomContent).addClass(roomClass);
            $map.append(roomContainer);
        }
    }

    /** 
    * @description set the styles to the roomContaint to place it into the map an save some data as data attributes
    * @param {object} - object with the data of a room
    * @param {object} - jquery object with the room container element (html, event,...)
    */
    function _setUpRoomContainer(roomData, roomContainer) {
        roomContainer.css({
            width: (roomData.hsize * ratio),
            height: (roomData.vsize * ratio),
            position:"absolute",
            top: (roomData.y * ratio),
            left: (roomData.x * ratio)
        });
    }

    function _getStructureCoordinates(structureData) {
        var canvasWidth = 0;
        var canvasHeight = 0;
        var coor = "";
        for(var x = 0; x < structureData.length; x++) {
            data = structureData[x];
            canvasWidth = (data.xend * ratio > canvasWidth) ? data.xend * ratio : canvasWidth;
            canvasHeight = (data.yend * ratio > canvasHeight) ? data.yend * ratio : canvasHeight;
            coor += (data.xst * ratio) + "," + (data.yst * ratio) + " " + (data.xend * ratio) + "," + (data.yend * ratio) + " ";
        }

        $mapCanvas.attr({
            "width": canvasWidth,
            "height": canvasHeight
        }).show();

        return coor;
    }

    return {
        init: init,
        getFloor: getFloor
    };

})(window, undefined);

$(function() {
    var hasMap = $("#floor-map-guide").length;
    if(hasMap) {
        hotelMap.init();
    }
});

var styleGuide = (() => {
  var styleGuideView = $('.style-guide');
  var sgHeader = $('.sg-header');
  var navigationLinks = styleGuideView.find('.js-navigation-link');
  var btnMenu = sgHeader.find('.hamburguer');
  var sideBar = styleGuideView.find('.sg-sidebar');

  const DEFAULT_HASH = '#brand';
  const STICKY = styleGuideView.offset() ? styleGuideView.offset().top : '0';

  function init() {
    // Listeners
    navigationLinks.on('click', _handlerClickNavigationLink);
    btnMenu.on('click', _handlerHamburguerButtonClick);
    if(styleGuideView.length > 0) {
      _initNavigation();
      // $(window).on('scroll', _handlerStickySideBar);
    }
    // INIT SCRIPTS
    _initForms();
  }

  function _handlerHamburguerButtonClick(e) {
    $(this).toggleClass('close-hamburguer');
    sideBar.toggleClass('is_active');
  }

  function _initNavigation() {
    // Update URL
    var hashUrl = window.location.hash.length > 0 ? window.location.hash : DEFAULT_HASH;
    navigate(hashUrl);
  }

  function navigate(hashUrl) {
    // Add active class to section title
    $(`.js-navigation-link a[href="${hashUrl}"]`).closest('li').addClass('active');
    // Open up the hidden content panel
    $('.accordion-section' + hashUrl + '-view').removeClass('hide').addClass('open');
    // Update URL hash
    window.location.hash = hashUrl;
    $('html, body').animate({
      scrollTop: 0
    }, 200);
  }

  function _handlerClickNavigationLink(e) {
    // Grab current anchor value
    var currentAttrValue = $(this).find('a').attr('href');

    if($(e.target).is('.active')) {
      _close_accordion_section();
      _close_menu_mobile();
    }else {
      _close_accordion_section();
      _close_menu_mobile();
      navigate(currentAttrValue);
    }
    e.preventDefault();
  }

  function _close_accordion_section() {
    navigationLinks.removeClass('active');
    $('.accordion-section').addClass('hide').removeClass('open');
  }

  function _close_menu_mobile() {
    $(this).removeClass('close-hamburguer');
    sideBar.removeClass('is_active');
  };


  function _handlerStickySideBar() {
    var scrollTop = $(this).scrollTop();

    console.log("window-scrollTop", scrollTop);
    console.log("STICKY", STICKY);
    if (scrollTop >= STICKY) {
      styleGuideView.addClass('sg-sticky');
    } else {
      styleGuideView.removeClass('sg-sticky');
    }

  }

  function _initForms() {
    // Steps
    var form = styleGuideView.find('form.js-form-steps');
    var formStepsView = styleGuideView.find('.form-steps');
    formStepsView.formSteps({
      initStep: 0
    });
    form.validator({
      disable: false
    }).on('submit', function(e) {
        var $form = $(this);
        toggleLoadingButton($form, true);
      if (e.isDefaultPrevented()) {
        toggleLoadingButton($form, false);
      } else {
        // Invalid Form
      }
    });
  }

  // Public API
  return {
    init: init
  }
})();

$(() => {
  styleGuide.init();
});

const travelAgentsSignUp = (() => {
  var travelAgentsSignUpView = $('.p-travel-agents-signup');
  var signupForm = travelAgentsSignUpView.find('.form-travel-agents-signup');
  //EY cambio input name por envio de fornulario
  var intermediaryInput = signupForm.find('[name="consortia"]');
  var affirmativeIntermediaryInput = signupForm.find('#is_agency_associated');
  var intermediaryTextInput = signupForm.find('#which_association');
  let $modalError;
  let formError;
  /**
   * Init Fn
   */
  function init() {

    formError = (typeof pageData != "undefined") ? (typeof pageData.javaError != "undefined") ? pageData.javaError : false : false;
    $modalError = $("#modal-error");
    //mostramos la modal de error si al enviar el formulario se genera un error
    if (formError) {
      $modalError.modal("show");
    }

    signupForm.validator({
      disable: false
    }).on('submit', function (e) {
      var $form = $(this);
      toggleLoadingButton($form, true);
      if (e.isDefaultPrevented()) {
        // Invalid Form
        toggleLoadingButton($form, false);
      } else {
        // EY: Poner valor none en select si consortia es no
        if ($form.find("[name='consortia']").val() == "No") {
          $form.find("[name='consortiaOption']").remove();
          $form.append('<input type="hidden" name="consortiaOption" value="none" />');
        }
        // EY: Añadir emailTo
        var mailtTo= (jsonCountries[$form.find("[name='country']").val()] != "undefined") ? jsonCountries[$form.find("[name='country']").val()] : pageData.mailToDefault
        $form.find("[name='emailTo']").val(mailtTo)
        // EY: añadir campos hidden   
        $form.append('<input type="hidden" name="_frequentDestinations" value="1" />');
        $form.append('<input type="hidden" name="_agencySegment" value="1" />');
        $form.find(':checkbox').each(function () {
          ($(this).is(':checked') == false && $(this).attr('name')=='GDPR_flag_3') && $form.append('<input type="hidden" value="N" name="GDPR_flag_3" />');
          ($(this).is(':checked') == false && $(this).attr('name')=='GDPR_flag_4') && $form.append('<input type="hidden" value="N" name="GDPR_flag_4" />');
        });
      }
    });

    // Listeners
    intermediaryInput.on('change', _onIntermediaryInputChange);
    _onIntermediaryInputChange();
    // Ey error modal
    
  }

  /**
   * Handler when the intermediary input changes. Show/hide the associated
   * input text.
   */
  function _onIntermediaryInputChange(e) {
    var intermediaryInputTextFormGroup = intermediaryTextInput.closest('.form-group');
    if (affirmativeIntermediaryInput.is(':checked')) {
      intermediaryInputTextFormGroup.closest('.form-group').removeClass('hide');
      intermediaryTextInput.attr('data-validate', true);
    } else {
      intermediaryInputTextFormGroup.addClass('hide')
      intermediaryTextInput.attr('data-validate', false);
    }
    signupForm.validator('update');
  }

  return {
    init: init
  };
})();

$(() => {
  travelAgentsSignUp.init();
});

function setCurrentDate(){
    var fecha = new Date();
    var curMonth = fecha.getMonth()+1;
    var curYear = fecha.getFullYear();

    if (curMonth < 10) curMonth = "0" + curMonth;
    curYear = curYear.toString().substr(2,2);

    $("[data-id='mesValidate']").val(curMonth);
    $("[data-id='mesValidate']").selectpicker('refresh');

    $("[data-id='anioValidate']").val(curYear);
    $("[data-id='anioValidate']").selectpicker('refresh');

    $('.custom-card .expired-date-card .month').text(curMonth);
    $('.custom-card .expired-date-card .year').text(curYear);
}

function setMonthsFromToday(){
    var d = new Date();
    var month = d.getMonth()+1;
    var options = "";
    var vi = 0;
    for (var i = month; i<13; i++){
        vi = i;
        if (i < 10) vi = "0" + i;
        options += "<option value='"+vi+"'>"+vi+"</option>";
    }
    $("[data-id='mesValidate']").html(options);
}

function setFullMonths(){
    var options = "";
    for (var i = 1; i<13; i++){
        options += "<option value='"+i+"'>"+i+"</option>";
    }
    $("[data-id='mesValidate']").html(options);
}

function isDateValid(month,year){
    var fecha = new Date();
    var curYear = fecha.getFullYear();
    var curMonth = fecha.getMonth()+1;

    if(year>=curYear){
        if(year==curYear) {
            if(month>=curMonth){
                return true;
            } else {
                return false;
            }
        } else {
            return true;
        }
    } else {
        return false;
    }
}

$(function() {
    //setMonthsFromToday();
    //setCurrentDate();

    $('.inputClear').click(function(){
        $(this).prev('input').val('')
        $(this).nextAll('.icon').removeClass('ok').removeClass('ko');
    });

    $( ".mesValidate, .anioValidate" ).change(function() {
        // //manejador de selects con fecha
        var objYear = $(this).closest(".js-validate-card, .js-validate-card-2").find("select.anioValidate");
        var objMonth = $(this).closest(".js-validate-card, .js-validate-card-2").find("select.mesValidate");
        var selYear = "20"+objYear.val();
        var selMonth = objMonth.val();

        var objHidden = $(this).closest('.form-group').find('.callback_date');

        objHidden.val(selMonth + '-' + selYear);
        objHidden.trigger('change');
    });


    $('input[data-validation-callback-callback="callback_cvv"]').on('focus', function() {
        var maxMin = $(this).attr('data-callback-num');
        $(this).attr('maxlength', maxMin);
    });
});

function callback_date($el, value, callback) {
    var selMonth = parseInt(value.split('-')[0], 10);
    var selYear = parseInt(value.split('-')[1], 10);
    var isValid;

    if ( !isNaN(selMonth) && selYear.toString().length > 2 ) {
        isValid = isDateValid(selMonth,selYear);
    } else {
        isValid = false;
    }

    callback({
        value: value,
        valid: isValid,
        message: ""
    });
}

function callback_card($el, value, callback) {

    var isValid = false;
    var errorMessage = $el.attr('data-validation-callback-message');

    var realValue = value.replace(/ /g,'').replace(/_/g,'');
    var valueLength = realValue.length;

    var checkedCard = checkCard(value);

    if ( $el.attr('maxlength') == '34' ) {

        var lengthValid = (valueLength == 15);

    } else if( $el.attr('maxlength') == '38' ) {

        var lengthValid = (valueLength == 16);
    }
    else if( $el.attr('maxlength') == '32' ) {

        var lengthValid = (valueLength == 14);
    }


    if ( lengthValid || ( globalConfig.windowWidth <= globalConfig.smBreak )) {
        // if ( lengthValid ) {
        if ( checkedCard ) {
            if ( !$el.hasClass('invalidType') ) {
                isValid = true;
            }
            else {
                errorMessage = $el.attr('data-validation-callback-valid-message');
            }
        } else {
            errorMessage = $el.attr('data-validation-callback-valid-message');
        }
    } else {
        errorMessage = $el.attr('data-validation-callback-length-message');
    }

    callback({
        value: value,
        valid: isValid,
        message : errorMessage
    });
}

function callback_cvv($el, value, callback) {

    var maxMin = parseInt($el.attr('data-callback-num'), 10);


    var valueLength = value.length;

    var callbackMessage = $el.attr('data-validation-callback-message');

    var isValid = (valueLength == maxMin);

    var max = 3;
    if ( $el.attr('maxlength') == '34' ) {
        var lengthValid = (valueLength == 15);
        var max = 4;
    } else if( $el.attr('maxlength') == '38' ) {
        var lengthValid = (valueLength == 16);
    } else if( $el.attr('maxlength') == '32' ) {

        var lengthValid = (valueLength == 14);
    }


    if ( lengthValid || ( globalConfig.windowWidth <= globalConfig.smBreak )) {
        // if ( lengthValid ) {

        if ($('.js-cvv').val().length > max) {
            $('.js-cvv').val($('.js-cvv').val().substr(0, max));
        }
    }
    if(($('.js-cvv').val().length == max)){
        isValid = true;
    }

    // if ( windowWidth <= smBreak ) {
    // 	isValid = valueLength <= 4 && valueLength > 2;
    // 	maxMin = 3;
    // }

    callback({
        value: value,
        valid: isValid,
        message : callbackMessage
    });
}

/**
 * Check if is a valid credit card
 * @param  {string} cardValue [numbers of the credit card]
 * @return {bolean}       [result of the validation]
 */
var checkCard = function (cardValue) {

    var c = cardValue;
    c = c.replace(/\s/g, '');
    var cl = parseInt(c.substr(c.length - 1));
    var c = c.slice(0, -1);
    var c = c.split("").reverse().join("");
    var c = c.split("");
    var a = 2;
    var cm = [];
    for (var i = 0; i < c.length; i++) {
        if (a % 2 == 0) {
            var t = c[i] * 2;
            if (t > 9) {
                var t = (t - 9);
            }
            cm.push(t);
        } else {
            cm.push(parseInt(c[i]));
        }
        a++;
    }
    var f = 0;
    for (var i = 0; i < cm.length; i++) {
        f += cm[i];
    }
    f = f + cl;
    if (f % 10 == 0) {
        return true;
    } else {
        return false;
    }

};


/**
 * Get the DYNAMIC PHONES for all the site
 */

var dynamicTelephones = (function () {

	//Vars from jsp
	var _campId = (typeof campId != "undefined" ? campId : "");
	var _country = (typeof country != "undefined" ? country : "");
	var _countryName = (typeof countryName != "undefined" ? countryName : "");
	var _continent = (typeof continent != "undefined" ? continent : "");
	var _webSection = (typeof page_section != "undefined" ? page_section : "");

	//Set Vars
	var channelIndex = "-1";
	var countryFound = false;
	var telephoneJSON = "/resources/telephoneJSON.txt";
	var telephone = "";
	var countryUser = "";
	var lblGlobalAccess = (typeof Labels.globalAccess != "undefined") ? Labels.globalAccess : "Global Access";


	//Result telephones
	var result = {
		countryTel: "", //telephone by channel and country 
		globalTel: "+34 91 398 46 61", //global location telephone
		countryName: "", // ex. 'Spain'
		countryText: "", //label if there is no countryName
		telephoneWebSection: "" // ex. 'ES'
	};

	var init = function () {

		//Set from Agent object if exists (setted in jsp)
		if (typeof Agent != "undefined") {
			_country = Agent.country;
			_campId = Agent.campId;
			_countryName = Agent.countryName;
			_continent = Agent.continent;
		}

		if ($('body').hasClass("page-roomdisplay")) {
			_campId = Utils.getURLParameter('campid'); //get campId from URL if roomDisplay	
		}

		//get values from akamay cookies if exists
		_continent = $.cookie("USER_CT_CONTINENT") != "" && $.cookie("USER_CT_CONTINENT") != null ? $.cookie("USER_CT_CONTINENT") : _continent;
		_country = $.cookie("USER_CT_COUNTRYCODE") != "" && $.cookie("USER_CT_COUNTRYCODE") != null ? $.cookie("USER_CT_COUNTRYCODE") : _country;
		_countryName = $.cookie("USER_CT_COUNTRYCODE") != "" && $.cookie("USER_CT_COUNTRYCODE") != null ? $.cookie("USER_CT_COUNTRYCODE") : _countryName;


		//Set values
		result.countryText = _country;
		result.countryName = _countryName;
		countryUser = _country;

		//Used in RoomDisplayHotelCardHtml.jspx (Still not in V3)
		/*let _campos = {
	        '8431996'   : '<img class="lazyload" src="/system/v2/html/img/logos/trivago_160x40.png" width="100" alt="" >',
	        '8435709'   : '<img class="lazyload" src="/system/v2/html/img/logos/tripadvisor_160x40.png" width="93" alt="" >',
	        '8565112'   : '<img class="lazyload" src="/system/v2/html/img/logos/google_160x40.png" width="93" alt="" >',
	        '20405652'  : '<img class="lazyload" src="/system/v2/html/img/logos/roomkey.png" width="93" alt="" >'
	    }
	    if (_campos[_campId]) {
	        $( ".labelMeta" ).removeClass("hidden"); 
	        $(".imageMetaSearch").html(_campos[_campId])
	    }*/


		//call ajax for Telephones JSON
		$.ajax({
			url: telephoneJSON,
			dataType: "json",
			cache: true,

		}).done(function (data) {

			if (data) {

				//1)Determine the telephones to be used depending on the channel				
				if (_campId) {
					// Find channel index
					for (var i = 0; i < data.channels.length; i++) {
						for (var j = 0; j < data.channels[i].agent.length; j++) {
							if (data.channels[i].agent[j].campId == _campId) {
								channelIndex = i;
							}
						}
					}
					if (channelIndex != "-1") {
						// Find country telephone & country name
						for (var k = 0; k < data.channels[channelIndex].telephones.length; k++) {
							if (data.channels[channelIndex].telephones[k].country == countryUser) {
								result.countryTel = data.channels[channelIndex].telephones[k].telephone;
								result.countryName = data.channels[channelIndex].telephones[k].countryName;
								countryFound = true;
							} else {
								$('.telephoneList').append("<li><a href=\"tel:" + data.channels[channelIndex].telephones[k].telephone + "\">" + data.channels[channelIndex].telephones[k].telephone + " (" + data.channels[channelIndex].telephones[k].country + ")" + "</a></li>");
							}
						}
						// Find global channel
						if (data.channels[channelIndex].globalChannel != "") {
							if (countryFound) {
								$('.telephoneList').html($('.telephoneList').html() + "<li><a href=\"tel:" + data.channels[channelIndex].globalChannel + "\">" + data.channels[channelIndex].globalChannel + " (" + lblGlobalAccess + ")" + "</a></li>");
								result.globalTel = data.channels[channelIndex].globalChannel;
							} else {
								result.countryTel = data.channels[channelIndex].globalChannel;
								result.globalTel = data.channels[channelIndex].globalChannel;
								result.countryText = lblGlobalAccess;
							}
						}
					}
				}

				//Responsive and mobile have their own channel: name="MOBILE TELEPHONES"
				if (Globals.responsive == "responsive") {
					for (var i = 0; i < data.channels.length; i++) {
						if (data.channels[i].name == "MOBILE TELEPHONES") {
							channelIndex = i;

							// Find country telephone & country name
							for (var k = 0; k < data.channels[channelIndex].telephones.length; k++) {
								if (data.channels[channelIndex].telephones[k].country == countryUser) {
									result.countryTel = data.channels[channelIndex].telephones[k].telephone;
									result.countryName = data.channels[channelIndex].telephones[k].countryName;
									countryFound = true;
								} else {
									result.countryText = lblGlobalAccess;
								}
							}

							//Global channel 
							result.globalTel = data.channels[channelIndex].globalChannel;
						}
					}
				}

				if (channelIndex == "-1") {
					for (var i = 0; i < data.channels.length; i++) {
						// Find default telephone
						if (data.channels[i].defaultChannel == "Yes") {
							for (var k = 0; k < data.channels[i].telephones.length; k++) {
								if (data.channels[i].telephones[k].country == _country) {
									result.countryTel = data.channels[i].telephones[k].telephone;
									result.countryName = data.channels[i].telephones[k].countryName;
									countryFound = true;
								} else {
									$('.telephoneList').html($('.telephoneList').html() + "<li><a href=\"tel:" + data.channels[i].telephones[k].telephone + "\">" + data.channels[i].telephones[k].telephone + " (" + data.channels[i].telephones[k].country + ")" + "</a></li>");
								}
							}
							if (data.channels[i].globalChannel != "") {
								if (countryFound) {
									$('.telephoneList').html($('.telephoneList').html() + "<li><a href=\"tel:" + data.channels[i].globalChannel + "\">" + data.channels[i].globalChannel + " (" + lblGlobalAccess + ")" + "</a></li>");
									result.globalTel = data.channels[i].globalChannel;
								} else {
									result.globalTel = data.channels[i].globalChannel;
									result.countryText = lblGlobalAccess;
								}
							}
						}
						// Find web section telephone
						if (data.channels[i].webSection != null && data.channels[i].webSection == _webSection) {
							for (var k = 0; k < data.channels[i].telephones.length; k++) {
								if (data.channels[i].telephones[k].country == _country) {
									result.telephoneWebSection = data.channels[i].telephones[k].telephone;
									break;
								} else {
									result.telephoneWebSection = data.channels[i].globalChannel;
								}
							}
						}
					}
				}

				//2)Insert the telphones in the HTML for desktop
				changeHTML(result);
				//3)Insert the telephones in the HTML for mobile (just mobile particular html, like header)
				changeHTMLMobile(result);
			}


		}).fail(function (data) {

			//Json Fail
			console.log('Error al recuperar los telefonos dynamicos');

			changeHTMLFailAjax(result);
			changeHTMLMobile(result);
		});

	};

	function changeHTML(result) {

		telephone = result.countryTel ? result.countryTel : result.globalTel;

		if (telephone) {
			//Top header selector
			addTelephone('.phoneHeader', telephone, result.countryText, 'header');

			//De momento no lo usamos en V3
			//addTelephone('.phoneHeaderMob',telephone,result.countryText,'header');

		} else {
			//there is no telephone
			$('.phoneHeader,.phoneHeaderMob').parents('li').hide();
		}

		$('.dynamicTelephone').each(function (indice, elemento) {
			($(elemento).is("input:hidden")) ? $(elemento).val(telephone) : $(elemento).text($(elemento).text() + telephone);
		});

	
		addTelephone('a.dynamicTelephone', telephone, '', 'a');
		addTelephone('a.dynamicTelephoneHref', telephone, '', 'a');

		//Used in Contact Home page
		addTelephone('.phoneGlobal',result.globalTel,'','appendParam');
		addTelephone('.phoneCountry',result.countryName,'','appendParam');		
		
		if (telephone != result.globalTel) {
			addTelephone('.phoneContact',telephone,'','appendParam');			
		} else {
			$('.phoneContact').hide();
		}

		//De momento no lo usamos en V3
		/*

		//Used in WidgetHelp.jspx (Hotel Page)
		if (result.telephoneWebSection) {   
			addTelephone('.dynamicTelephoneWidget',result.telephoneWebSection,'','appendParam');					
		} else {
			addTelephone('.dynamicTelephoneWidget',telephone,'','appendParam');
		}
		
		//Construir los href de los telefonos.		
		addTelephone('a.phoneGlobal',result.globalTel,'','a');
		addTelephone('#contactTel .dynamicTelephone',telephone,'result.countryText','mobileContactTel');
		
		//Used in WidgetHelp.jspx (Hotel Page)	
		var sectionTel = $(".dynamicTelephoneWidget").html();
		addTelephone('.dynamicTelephoneWidget',sectionTel,'','a');*/
	};

	function changeHTMLFailAjax(result) {

		$('.phoneHeader').html(result.globalTel + " (" + lblGlobalAccess + ") <b class='caret'></b>");
		$('.phoneHeaderMob').html(result.globalTel + " (" + lblGlobalAccess + ") <b class='caret'></b>");
		$().html("<li><a href='tel:+43 0820 40 11 56 08'>+43 0820 40 11 56 08 (AT)</a></li><li><a href='tel:+32 070 35 47 72'>+32 070 35 47 72 (BE)</a></li><li><a href='tel:+33 (0)821 77 42 96'>+33 (0)821 77 42 96 (FR)</a></li><li><a href='tel:+49 30 22388599'>+49 30 22388599 (DE)</a></li><li><a href='tel:(+39) 848 390 227'>(+39) 848 390 227 (IT)</a></li><li><a href='tel:+351 707 500 302'>+351 707 500 302 (PT)</a></li><li><a href='tel:902 570 368'>902 570 368 (ES)</a></li><li><a href='tel:+41 (0)848 20 74 16'>+41 (0)848 20 74 16 (CH)</a></li><li><a href='tel:+31 (0)20 79 56 088'>+31 (0)20 79 56 088 (NL)</a></li><li><a href='tel:+44 (0)870 80 71 359'>+44 (0)870 80 71 359 (GB)</a></li><li><a href='tel:+1 646 568 4725'>+1 646 568 4725 (US)</a></li><li><a href='tel:+54 (0)11 5776 6464'>+54 (0)11 5776 6464 (AR)</a></li><li><a href='tel:+56 (0)2 341 7575'>+56 (0)2 341 7575 (CL)</a></li><li><a href='tel:+57 1 589 7744'>+57 1 589 7744 (CO)</a></li><li><a href='tel:+52 (0)55 52291500'>+52 (0)55 52291500 (MX)</a></li><li><a href='tel:+598 (0)2 9160001'>+598 (0)2 9160001 (UY)</a></li><li><a href='tel:+58 295 400 7111'>+58 295 400 7111 (VE)</a></li>");
		$('.phoneGlobal').html(result.globalTel + "");
		$(".dynamicTelephone").attr("href", "tel:" + result.globalTel).html(result.globalTel);
		$(".dynamicTelephoneHref").attr("href", "tel:" + result.globalTel)
		$('.phoneCountry').html("Spain");
		$('#telephoneContact').hide();

	};

	function changeHTMLMobile(result) {

		//== Construir los telefonos dinamicos de NH Mobile (ej: Landings Mobile)
		//Get globals if there is no results
		//console.log('countryText', countryText);
		//console.log('telephone', telephone);

		countryName = (result.countryName != '') ? result.countryName : result.countryText;
		telephone = (result.countryTel != '') ? result.countryTel : result.globalTel;


		//== Dynamic telephone
		addTelephone('a.mobileDynamicTelephone', telephone, 'result.countryText', 'aMobile');
		addTelephone('a.mobileDynamicTelephone', telephone, 'result.countryText', 'aHrefMobile');
		addTelephone('.mobileDynamicTelephoneTxt', telephone, '', 'appendParam');

		//Dynamic Global telephone
		addTelephone('a.mobileDynamicPhoneGlobal', result.globalTel, 'result.countryText', 'aMobile');
		addTelephone('a.mobileDynamicPhoneGlobalHref', result.globalTel, 'result.countryText', 'aHrefMobile');
		addTelephone('.mobileDynamicPhoneGlobalTxt', result.globalTel, '', 'appendParam');

		//Sidebar contact dynamic telesphone and country
		addTelephone('#mobileContactTel .mobileDynamicTelephone', telephone, countryName, 'mobileContactTel');
	};

	function addTelephone(selector, telephone, text, type) {
		switch (type) {
			case 'header':
				$(selector).html(telephone + " (" + text + ")" + $(selector).html());
				break;
			case 'appendParam':
				$(selector).html(telephone);
				break;
			case 'a':
				$(selector).attr("href", "tel:" + telephone).css('white-space', 'nowrap');
				break;
			case 'aMobile':
				$(selector).attr("href", "tel:" + telephone.replace(/ /g, '')).html(telephone).css('white-space', 'nowrap');
				break;
			case 'aHrefMobile':
				$(selector).attr("href", "tel:" + telephone.replace(/ /g, '')).css('white-space', 'nowrap');
				break;
			case 'mobileContactTel':
				$(selector).html(text + "</br> " + '<span style="white-space: nowrap;">' + telephone + '</span>');
				break;
			default:
				// code block
		}

	};

	//Public API
	return {
		init: init
	}

})();


$(document).ready(function () {

	//Get dynamic phones
	dynamicTelephones.init();

});
/**
 * TRACK FORMS ANALYTICS ESERVICING
 * 
 */

var TrackEServicing = (function () {
	/**
	 * Lista de eventos EServicing
	 * @param {Object} trackList - Objeto
	 * @param {string} trackList[selector] - Selector para hacer onclick.
	 * @param {string | callback } trackList[selector][param] - Array parametros para definir el utag.link. Puede ser un callback  
	 * Permite multiples eventos por selector
	 */
	let trackList = null;
	trackList = {
		".js-track-cancel-desktop": [{ // Track Cancel Reservation for Desktop
			"eventCategory": Globals.page_section,
			"eventAction": "cancel booking",
			"event": "mybookings"
		}],
		".js-track-eservicing-search-mobile": [{ // Track Search Reservation for Mobile: js-track-eservicing-search-desktop -> SE PUEDE UTLIZAR PERO NO ESTA ACTIVO
			"eventCategory": Globals.page_section,
			"eventAction": "search booking",
			"event": "eservicing | search"
		}],
		".js-track-eservicing-personalize-mobile": [{ // Track Modfiy Reservation for Mobile
			"eventCategory": Globals.page_section,
			"eventAction": "personalize booking",
			"event": "eservicing | personalize"
		}],
		".js-track-eservicing-personalize-desktop": [{ // Track Modfiy Reservation for Desktop
			"eventCategory": Globals.page_section,
			"eventAction": "modify booking",
			"event": "mybookings"
		}],		
		".js-track-cancel-mobile": [{ // Track Cancel Reservation for Mobile
			"eventCategory": Globals.page_section,
			"eventAction": "my_reservation",
			"eventLabel": _searchData('hotelId') + " | " + _reveseDate(_searchData('fini')) + " - " + _reveseDate(_searchData('fout')) + " | " +
			_searchData('roomsNumber') + " | " + _searchData('numberOfAdults') + " | " +
			_searchData('numberOfChildren') + " | " + _searchData('numberOfBabies'),
			"event": "eservicing | cancel"
		}]
	}
	function _reveseDate(date, formatDefault='DD/MM/YYYY', formatNew="YYYY/MM/DD"){ // cambiar el orden de una fecha
		return (moment(date, formatDefault).isValid()) ? moment(date, formatDefault).format(formatNew) : '' 
	}
	function _searchData(key) { // Busca el valor en global searchData si esta definido
		if (typeof searchData !== 'undefined') {
			return (searchData[key]) ? searchData[key] : ''
		}
		return '';
	}
	var events = trackList
	// Public API
	return {
		events: events
	};
})();
/**
 * TRACK HOME PAGE
 * 
 */
var TrackHomePage = (function () {
    /**
     * Lista de eventos Home page
	 * @param {Object} trackList - Objeto
	 * @param {string} trackList[selector] - Selector para hacer onclick.
	 * @param {string | callback } trackList[selector][param] - Array parametros para definir el utag.link. Puede ser un callback  
	 * Permite multiples eventos por selector
     */
    let trackList = null;
    trackList = {
        "#searchBarModifyForm button[type='submit']": [{ // Select Hotel
            "eventCategory": Globals.page_section,
            'eventAction': 'search',
            'eventLabel': function () {
                let name = $('#location2-sb').val();
                let startDate = $('#calendar-checkin-sb').val();
                let endDate = $('#calendar-checkout-sb').val();
                let nrooms = $('.option-list .option:not(".hidden")').length;
                let nadults = $('.adults .ammount').val();
                let nchild = $('.children .ammount').val();
                let nbabies = $('.babies .ammount').val();
                var eventLabelTrack = name + '|' + startDate + "-" + endDate + '|' + nrooms + '|' + nadults + '|' + nchild + '|' + nbabies;
                return eventLabelTrack;
            },
            'event': 'home | search'
        }],
    }
    var events = trackList
    // Public API
    return {
        events: events
    };
})();


// LANZO FUNCIONES INLINE
// HOME FLAG ONLOAD
function trackShowDetectIPOrigin(page) {
    trackAnalitics.tracking({
        'eventCategory': page,
        'eventAction': "impression availability pop up",
        'event': "availability | impression"
    });
}
/**
* TRACK FORMS ANALYTICS MICE
* 
*/
var TrackMICE = (function () {
	/**
	* Lista de eventos MICE
	* @param {Object} trackList - Objeto
	* @param {string} trackList[selector] - Selector para hacer onclick.
	* @param {string | callback } trackList[selector][param] - Array parametros para definir el utag.link. Puede ser un callback  
	* Permite multiples eventos por selector
	*/
	let trackList = null;
	trackList = {

		"#sendRequest": [{ // Personalize event btn
			"eventCategory": Globals.page_section,
			'eventAction': 'send enquiry',
			'eventLabel': function () {
				let name = $("[name = 'hotel']").val();
				let asistants = $("[name = 'asistentes']").val();
				let evento = $("#evento").val();
				var eventLabelTrack = name + "," + asistants + "," + evento ;
				return eventLabelTrack;
			},
			'event': 'Micefunnel | step1'
		}],

		"#personalizeEvent": [{ // Personalize event btn
			"eventCategory": Globals.page_section,
			'eventAction': 'personalize event',
			'eventLabel': function () {
				let name = $("[name = 'hotel']").val();
				let asistants = $("[name = 'asistentes']").val();
				let evento = $("#evento").val();
				var eventLabelTrack = name + "," + asistants + "," + evento ;
				return eventLabelTrack;
			},
			'event': 'Micefunnel | step1'
		}],
		".btn-show-details": [{ // Select Hotel
			"eventCategory": Globals.page_section,
			'eventAction': 'view hotel page',
			'eventLabel': function () {
				let nameHotel = $btn.closest('.m-hotel-box').data('backcode');
				var eventLabelTrack = nameHotel;
				return eventLabelTrack;
			},
			'event': 'mice | search | view hotel'
		}],
		"[name='miceHomeForm'] button[type='submit']": [{ // Select Hotel
			"eventCategory": Globals.page_section,
			'eventAction': 'search a meeting',
			'eventLabel': function () {
				let name = $('#fieldSearch').val();
				let nrooms = $('#nhabitaciones').val();
				let nasistentes = $('#nasistentes').val();
				let nsalones = $('#nsalones').val();
				let eventType = $('#eventType').val();
				var eventLabelTrack = name + '|' + nrooms + '|' + nasistentes + '|' + nsalones + '|' + eventType;
				return eventLabelTrack;
				
			},
			'event': 'mice | search results'
		}],
		"#requestQuoteHotel input[type='submit']": [{ // Click btn header
			"eventCategory": Globals.page_section,
			"eventAction": function () {
				return "request a quote | Hotel";
			},
			"eventLabel": function () {
				let name = $('[name="name"]').val();
				let backCode = $('[name="backCode"]').val();
				var eventLabelTrack = name + " | " + backCode;
				return eventLabelTrack;
			},
			"event": "mice | request a quote Hotel"
		}],
		"#requestQuoteHeader": [{ // Click btn header
			"eventCategory": Globals.page_section,
			"eventAction": function () {
				let where = $("#requestQuoteHeader") ? 'top' : "down";
				return "request a quote | " + where;
			},
			"eventLabel": function () {
				let name = $('.cloned-hotel').data('backcode'), nrooms = $("[name = 'nhabitaciones']").val();
				var eventLabelTrack = name + "|" + nrooms + ",";
				return eventLabelTrack;
			},
			"event": "mice | search results"
		}],
		"#requestQuoteModal": [{ // Click btn modal
			"eventCategory": Globals.page_section,
			"eventAction": 'request a quote | pop up',
			"eventLabel": function () {
				let name = $('.cloned-hotel').data('backcode');
				let nrooms = $("[name = 'nhabitaciones']").val();
				let capacity = $("[name = 'nasistentes']").val();
				let meetingRooms = $("[name = 'nsalones']").val();

				var eventLabelTrack = name + "|" + nrooms + "," + capacity + "," + meetingRooms ;
				return eventLabelTrack;
			},
			"event": "micesearch | quote"
		}],		
		".js-filter-rooms": [{ // Filter rooms

			"eventCategory": Globals.page_section,
			'eventAction': 'filters use | select rooms',
			'eventLabel': function () {
				let minRooms = $('.js-filter-rooms [role="slider"]').attr('aria-valuemin');
				let maxRooms = $('.js-filter-rooms [role="slider"]').attr('aria-valuemax');
				let rooms = minRooms + "-" + maxRooms;
				return rooms;
			},
			'event': 'mice | search | filterRooms'
		}],
		".js-filter-meetingrooms": [{ // Filter meeting rooms

			"eventCategory": Globals.page_section,
			'eventAction': 'filters use | select meeting rooms',
			'eventLabel': function () {
				let minMeetingRooms = $('.js-filter-meetingrooms [role="slider"]').attr('aria-valuemin');
				let maxMeetingRooms = $('.js-filter-meetingrooms [role="slider"]').attr('aria-valuemax');
				let meetingRooms = minMeetingRooms + "-" + maxMeetingRooms;
				return meetingRooms;
			},
			'event': 'mice | search | filterMeetingRooms'
		}],
		".js-filter-capacity": [{ // Filter capacity

			"eventCategory": Globals.page_section,
			'eventAction': 'filters use | select max capacity',
			'eventLabel': function () {
				let minCap = $('.js-filter-capacity [role="slider"]').attr('aria-valuemin');
				let maxCap = $('.js-filter-capacity [role="slider"]').attr('aria-valuemax');
				let cap = minCap + "-" + maxCap;
				return cap;
			},
			'event': 'mice | search | filterCapacity'
		}],
		"[data-service]": [{ // Filter Services
			"eventCategory": Globals.page_section,
			'eventAction': 'filters use | select services',
			'eventLabel': function () {
				let service = $btn.attr('data-service');
				return service;
			},
			'event': 'mice | search | filterServices'
		}],

		".js-filter-location li a": [{ // Filter Location
			"eventCategory": Globals.page_section,
			'eventAction': 'filters use | select near to',
			'eventLabel': function () {
				let near = $btn.find('.text').text();
				return near;
			},
			'event': 'mice | search | filterNext'
		}],
		".js-filter-sort li a": [{ // Filter Order by
			"eventCategory": Globals.page_section,
			'eventAction': 'filters use | order by',
			'eventLabel': function () {
				let orderBy = $btn.find('.text').text();
				return orderBy;
			},
			'event': 'mice | search | order'
		}],
		".js-select-hotel": [{ // Select Hotel
			"eventCategory": Globals.page_section,
			'eventAction': 'select hotel',
			'eventLabel': function () {
				let name = $btn.closest('.m-hotel-box').data('title');
				return name;
			},
			'event': 'mice | search | selecthotel'
		}],
	}

	var events = trackList
	// Public API
	return {
		events: events
	};
})();

// LANZO FUNCIONES INLINE
//MICE




/**
 * TRACK FORMS ANALYTICS OCI
 * 
 */
var TrackOci = (function () {
	/**
	 * Lista de eventos OCI
	 * @param {Object} trackList - Objeto
	 * @param {string} trackList[selector] - Selector para hacer onclick.
	 * @param {string | callback } trackList[selector][param] - Array parametros para definir el utag.link. Puede ser un callback  
	 * Permite multiples eventos por selector
	 */
	let trackList = null;
	if (typeof reservationIdOci !== 'undefined') {
		trackList = {
			".js-track-checking-now": [{ // Start to OCI
				"eventCategory": Globals.page_section,
				"eventAction": "Cheking Now",
				"eventLabel": reservationIdOci,
				"event": "OCI|Checking"
			}],
			".js-trackPreselectedRoom": [{ // Track of button pre selected your room
				"eventCategory": Globals.page_section,
				"eventAction": "Start Checking",
				"eventLabel": reservationIdOci,
				"event": "OCI|YourRoom"
			}],
			".js-trackChooseRoom": [{ // Track of button Choose other room
				"eventCategory": Globals.page_section,
				"eventAction": "Select Another Room",
				"eventLabel": reservationIdOci,
				"event": "OCI|YourRoom"
			}],
			".js-trackCheckInTime": [{ // Track of button Checkin Time
				"eventCategory": Globals.page_section,
				"eventAction": "Arrival Info",
				"eventLabel": function () {
					let $arrivalTime = document.querySelector("#arrival_time");
					return $arrivalTime.value;
				},
				"event": "OCI|Arrival"
			}],
			".js-trackMoreInfPreselectedRoom": [{ // Track of button more info preselected Room
				"eventCategory": Globals.page_section,
				"eventAction": "Arrival Info Preselect",
				"eventLabel": reservationIdOci,
				"event": "OCI|Arrival"
			}],
			"#submitminor": [{ // Track of button more info preselected Room
				'eventCategory': 'Checkingformanalysis',
				'eventAction': 'Minor Check',
				'eventLabel': 'Success',
				'event': 'OCI|Checkingformanalysis'
			}],
			"#cancelminor": [{ // Track of button more info preselected Room
				'eventCategory': 'Checkingformanalysis',
				'eventAction': 'Minor Check',
				'eventLabel': 'Cancel',
				'event': 'OCI|Checkingformanalysis'
			}],
			//Xavi
			"#js-track-select-arrival-hour": [{ // Track of button more info preselected Room
                //recuperado de tridion
                'eventCategory': Globals.page_section,
                'eventAction': 'arrival_info',
                //variable
                'eventLabel': '',
                'event': 'OCI|Arrivals'
            }],
            //Xavi
            "#js-track-checking-formanalysis": [{ // Track of button more info preselected Room
                //recuperado de tridion
                'eventCategory': Globals.page_section,
                'eventAction': 'login_rewards',
                //variable
                'eventLabel': '',
                'event': 'OCI|Checkingformanalysis'
            }],
            //Xavi
            "#js-track-checking-formanalysis1": [{ // Track of button more info preselected Room
                //recuperado de tridion
                'eventCategory': Globals.page_section,
                'eventAction': 'login_rewards',
                //variable
                'eventLabel': '',
                'event': 'OCI|Checkingformanalysis'
            }],
            //Xavi
            "#js-track-checking-formanalysis2": [{ // Track of button more info preselected Room
                //recuperado de tridion
                'eventCategory': Globals.page_section,
                'eventAction': 'fill_out_field',
                //variable
                'eventLabel': '',
                'event': 'OCI|Checkingformanalysis'
            }],
            //Xavi
            "#js-track-checking-formanalysis3": [{ // Track of button more info preselected Room
                //recuperado de tridion
                'eventCategory': Globals.page_section,
                'eventAction': 'error_form',
                //variable
                'eventLabel': '',
                'event': 'OCI|Checkingformanalysis'
            }],
            //Xavi
            "#js-track-checking-formanalysis4": [{ // Track of button more info preselected Room
                //recuperado de tridion
                'eventCategory': Globals.page_section,
                'eventAction': 'success',
                //variable
                'eventLabel': '',
                'event': 'OCI|Checkingformanalysis'
            }],
            //Xavi
            "#js-track-checking-formanalysis5": [{ // Track of button more info preselected Room
                //recuperado de tridion
                'eventCategory': Globals.page_section,
                'eventAction': 'minor_check',
                //variable
                'eventLabel': '',
                'event': 'OCI|Checkingformanalysis'
            }],

		}
	}
	var events = trackList
	// Public API
	return {
		events: events
	};
})();

// LANZO FUNCIONES INLINE
//OCI
function trackOCILogin(page, idreserva) {
    trackAnalitics.tracking({
        'eventCategory': page,
        'eventAction': 'Login Rewards',
        'eventLabel': idreserva,
        'event': 'OCI|Checkingformanalysis'
    });
}
//OCI
function trackOCIError(page, nacionaliti) {
    trackAnalitics.tracking({
        'eventCategory': page,
        'eventAction': 'Error',
        'eventLabel': nacionaliti,
        'event': 'OCI|Checkingformanalysis'
    });
}
//OCI
function trackOCISuccess(page, nacionaliti) {
    trackAnalitics.tracking({
        'eventCategory': page,
        'eventAction': 'Success',
        'eventLabel': nacionaliti,
        'event': 'OCI|Checkingformanalysis'
    });
}
//OCI
function trackOCIMinorCheck() {
    trackAnalitics.tracking({
        'eventCategory': 'Checkingformanalysis',
        'eventAction': 'Minor Check',
        'eventLabel': 'Cancel',
        'event': 'OCI|Checkingformanalysis'
    });
}
//OCI
function trackOCIPreferences(page, idreserva) {
    trackAnalitics.tracking({
        'eventCategory': page,
        'eventAction': 'Save Preferences',
        'eventLabel': idreserva,
        'event': 'OCI|Preferences'
    });
}
//OCI
function trackOCIChangeFloor(page, Hotelid, floor) {
    trackAnalitics.tracking({
        'eventCategory': page,
        'eventAction': 'Change Floor',
        'eventLabel': Hotelid + '|' + floor,
        'event': 'OCI|YourRoom'
    });
}
//OCI
function trackOCIModifyPreferences(page, idreserva) {
    trackAnalitics.tracking({
        'eventCategory': page,
        'eventAction': 'Modify Preferences',
        'eventLabel': idreserva,
        'event': 'OCI|YourRoomp'
    });
}
//OCI
function trackOCIZoomInRoom(page, idreserva) {
    trackAnalitics.tracking({
        'eventCategory': page,
        'eventAction': 'Zoom In Room',
        'eventLabel': idreserva,
        'event': 'OCI|YourRoom'
    });
}
//OCI
function trackOCIZoomOutRoom(page, idreserva) {
    trackAnalitics.tracking({
        'eventCategory': page,
        'eventAction': 'Zoom out Room',
        'eventLabel': idreserva,
        'event': 'OCI|map'
    });
}
//OCI
function trackOCIZoomMoreAbout(page, idreserva) {
    trackAnalitics.tracking({
        'eventCategory': page,
        'eventAction': 'More About',
        'eventLabel': idreserva,
        'event': 'OCI|YourRoom'
    });
}
//OCI
function trackOCIProcessToChecking(page, idreserva) {
    trackAnalitics.tracking({
        'eventCategory': page,
        'eventAction': 'Process to Checking',
        'eventLabel': idreserva,
        'event': 'OCI|YourRoom'
    });
}
//OCI
function trackOCICheckingAnotherGuest(page, idreserva) {
    trackAnalitics.tracking({
        'eventCategory': page,
        'eventAction': 'Checking Another Guest',
        'eventLabel': idreserva,
        'event': 'OCI|Confirmation'
    });
}
//OCI
function trackOCISendCheckingByMail(page, idreserva) {
    trackAnalitics.tracking({
        'eventCategory': page,
        'eventAction': 'Send checking by mail',
        'eventLabel': idreserva,
        'event': 'OCI|Confirmation'
    });
}
/**
 * Analitica para login.
 * 
 * @param eventCategory
 * @param eventLabel
 * @param eventAction
 * @returns
 */
function trackLogin(eventCategory, eventLabel, eventAction) {
    trackAnalitics.tracking({
        'eventCategory': eventCategory,
        'eventAction': eventAction,
        'eventLabel': eventLabel,
        'event': 'event'
    });
}
/**
 * TRACK TRAVEL GUIDES
 * 
 */

var TrackTravelGuides = (function () {
    /**
     * Lista de eventos TravelGuides
	 * @param {Object} trackList - Objeto
	 * @param {string} trackList[selector] - Selector para hacer onclick.
	 * @param {string | callback } trackList[selector][param] - Array parametros para definir el utag.link. Puede ser un callback  
	 * Permite multiples eventos por selector
     */
    let trackList = null;
    if (typeof pageData !== 'undefined' && typeof pageData.destino !== 'undefined') {
        trackList = {
            ".js-track-travel-guide-accede": [{ //Track acceso to travel guide
                'eventCategory': Globals.page_section,
                'eventAction': 'accede to guides',
                'eventLabel': pageData.destino
            }],
        
        }
    }
    var events = trackList
    // Public API
    return {
        events: events
    };
})();

/**
 * LANDINGS PAGE SCRIPTS
 * @type {Module pattern}
 * @include:

 */

var Landings = (function(){

	var pageData;
	var showNoAccessModal = false;
	var showLoginModal = false; 
	var isExpiredLanding = false;

	var init = function(){

		//formData is setted in jsp and contains neded vars
		pageData = (typeof(formData) != 'undefined') ? formData : null;

		if(pageData && typeof pageData.isExpiredLanding != "undefined"){
			showNoAccessModal = pageData.showNoAccessModal;
			showLoginModal = pageData.showLoginModal; 
			isExpiredLanding = (pageData.isExpiredLanding == "true") ? true : false;
		}

		//call page functions
		handleJavaErrors();
		handleLandingAccess();		
		headerLoginMobile();
		// Lanzar store
		launchApptore();
	};

	var headerLoginMobile = function(){

		if(!$('body').hasClass('logged')){

			//User Not logged: show login modal to prevent redirect to /nhrewards/login and loose the flow
			$('#header-mob-holder .btn-ico-user-nav').on('click', function(e){
				e.preventDefault();
				$("#m-modal-login").modal('show');
			});

		}else{
			$('#header-mob-holder .btn-ico-user-nav').attr('href','/rewards/home');
		}

	};

	var handleLandingAccess = function(){

		if(showLoginModal){
			$("#m-modal-login").modal('show');

		}else if(showNoAccessModal && !showLoginModal){
			$("#modal-access-denied").modal({
				backdrop: 'static',
				keyboard: true, 
				show: true
			}); 
		
		}else if(isExpiredLanding && !showLoginModal){
			$("#expired-modal").modal('show');
		}

	};


	var handleJavaErrors = function(){

		var $modal = $('#modal-java-error');

		if(getURLParameter('error')){

			$.ajax({
			   url: '/booking/ajax/landing-promo/getFlowInformation.html',
			   cache: false,
			   async: false,
		   	}).done(function(data){

		        	if(data && data.errorMessage){
				    	console.log('result',data);
				      $modal.find('.modal-title').html(data.errorMessage);
				      $modal.modal('show');
			    	}

	        	}).fail(function(data){
	          	//fail
	          	console.log("fail get landing-promo/getFlowInformation.html" , data);
	          		            
	       	});
		}

	};

	var getURLParameter = function(name, url) {
		var urlT = (url) ? url : window.location.href;
    	name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
    	var regexS = "[\\?&]"+name+"=([^&#]*)";
    	var regex = new RegExp( regexS );
    	var results = regex.exec( urlT );
    	if( results == null ){
    		return null;
    	}else{
			try{
				return decodeURIComponent(results[1].replace(/\+/g, " "));
			}catch(error1) {
				try{
					return unescape(results[1].replace(/\+/g, " "));
				}catch(error2) {
					return null;
				}
			}
    	}
	};

  
  var launchApptore = function(){
		const links = $(".m-group-articles").find("a");
		if (isMobile.Android() || isMobile.iOS()) {
			var selectLink = null, formatLink = "";
			links.each(function(index, link) {
				  let hostName = link.hostname;
				  if (isMobile.Android() != null && hostName.indexOf("google") > 0 ) selectLink = link , formatLink = "market://details?id=", $(this).addClass("activeapp").removeAttr("target");
          if (isMobile.iOS() != null && hostName.indexOf("apple") > 0 ) selectLink = link, formatLink = "itms-apps://"}
        );
        if($(".activeapp").length) $(".activeapp").trigger("click");
        if (selectLink){
				$(".m-signup").hide();
				if(isMobile.Android()){
					var sublink = selectLink.href.substring(
						selectLink.href.lastIndexOf("=") + 1,
						selectLink.href.lastIndexOf("")
					);
          selectLink.href = formatLink + sublink;
          selectLink.target = "";
          selectLink.click();
				}
        if(isMobile.iOS()){
          var sublink = (selectLink.href).replace(/(^\w+:|^)\/\//, '');
          window.location.href = formatLink + sublink;
				}
			}
		}
	};

	// comprobamos que hay link y lanzamos la app store
	// var launchApptore = function(){
	// 	const links = $(".m-group-articles").find("a");
	// 	if (isMobile.Android() || isMobile.iOS()) {
	// 		var selectLink = null, formatLink = "";

	// 		links.each(function(index, link) {
  //       $this = $(this);        
	// 			let hostName = link.hostname;
	// 			if (isMobile.Android() != null && hostName.indexOf("google") > 0 ) selectLink = link , formatLink = "market://details?id=";
  //       if (isMobile.iOS() != null && hostName.indexOf("apple") > 0 ) selectLink = link , formatLink = "itms-apps://";     
  //       if (isMobile.Android()) $(this).addClass("activeapp").removeAttr("target") ;
  //       if (isMobile.iOS()) $(this).addClass("activeapp").removeAttr("target") ;
       
  //     });
      
  //     if($(".activeapp").length) $(".activeapp").trigger("click");
      
      /*console.log (selectLink)
			//ENTRAMOS SI ES ANDROID o IOS
			if (selectLink.href != "" && (isMobile.Android() || isMobile.iOS() )){
				$(".m-signup").hide();

				//SACAMOS LA ID DE LA APP DEL LINK
				// quitamos el https o htpps para formatear
				var sublink = (selectLink.href).replace(/(^\w+:|^)\/\//, '');

        // extraer id de app android
				if(isMobile.Android()){
					 	sublink = sublink.substring(
              sublink.lastIndexOf("=") + 1,
              sublink.lastIndexOf("")
					);
				}
				//EJECUTAMOS CON PREFIJO PARA QUE SE ABRA LA APP DE GOOGLE PLAY market:// o ios itms-apps
				try {          
					selectLink.back = sublink;
					selectLink.href = formatLink + sublink;
					selectLink.click();
				}
					// EN CASO DE NO ABRIRSE GOOGLE APPS
				catch (e) {
					//selectLink.href = selectLink.back; // esto creo que no hace falta por que pilla lo que habia
					selectLink.click();
				}
			}*/
		//}
	//};
	// Public API
	return {
		init:init
	};
})();



$(window).load(function(){
	
	if( $("body").hasClass("page-landings") || $("body").data("page") === "LandingsPage" || $(".p-landings").length ){

		Landings.init();
	}	

});

/*
 * NEW ANALITYCS FUNCTION
 */
var trackAnalitics = (function () {
    const debutTraking = false
    var init = (trackList) => events(trackList)
    var events = (trackList) => { // crea el evento onclick
        if (trackList !== null) {
            if (debutTraking) {
                console.log(trackList)
            }
            Object.entries(trackList).forEach(([key, value]) => { // recorre el listado
                if ($(key).length && value.length) { // si existe en la página y tiene elemntos crea el evento
                    $(document).on('click', key, function () {
                        $btn = $(this)
                        setTimeout(function () {
                            if (_testForm($btn)) parseTrack(key, trackList[key]) // --> parsea valores -> trackea
                        }, 300);
                    });
                }
            });
        }
    }
    function _testForm(btn) { // compruebo si es un submit y si tiene el errores el form
        if (btn.attr("type") == 'submit') {
            let $form = (typeof btn.data('form') !== 'undefined') ? $("#" + btn.data('form')) : btn.closest("form");
            if ($form.length) {
                if ($form.find(".has-error").length) return false
            }
        }
        return true;
    }
    function parseTrack(selector, data) { // parsea los valores por si hay callback para retornar el valor
        return data.forEach(function (element) {
            var elemnTrack = {};
            Object.entries(element).forEach(([key, value]) => {
                elemnTrack[key] = (typeof value === "function") ? value() : value
            })
            track(elemnTrack)
        })
    }
    // track function utag
    function track(data) { // envia los tracking
        try {
            if (debutTraking) {
                console.log("---- TRACKING ----")
                console.log(data)
                console.log("---- FIN TRACK ----")
            }
            utag.link(data)
        } catch (err) {
            utagError = err
        }
    }
    // Public API
    return {
        init: init,
        tracking: track

    }
})()
// LANZO TRAZA EVENTO ONCLICK
$(document).ready(function () {
    if (typeof TrackOci !== 'undefined') trackAnalitics.init(TrackOci.events)
    if (typeof TrackEServicing !== 'undefined') trackAnalitics.init(TrackEServicing.events)
    if (typeof TrackTravelGuides !== 'undefined') trackAnalitics.init(TrackTravelGuides.events)
    // Track HOME
    if (typeof TrackHomePage !== 'undefined' && $("main.p-home").length) trackAnalitics.init(TrackHomePage.events)

    // Track MICE
    if ($("main.me").length || $("main.p-me").length) {
        if (typeof TrackMICE !== 'undefined') trackAnalitics.init(TrackMICE.events)
    }
})
//# sourceMappingURL=async.js.map